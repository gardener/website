<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://gardener.cloud/docs/gardener/shoot-operations/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/gardener/shoot-operations/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Shoot Operations | Gardener</title><meta name=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:url" content="https://gardener.cloud/docs/gardener/shoot-operations/"><meta property="og:site_name" content="Gardener"><meta property="og:title" content="Shoot Operations"><meta property="og:description" content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:locale" content="en_US"><meta property="og:type" content="website"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Shoot Operations"><meta itemprop=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta itemprop=image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Shoot Operations"><meta name=twitter:description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><link rel=preload href=/scss/main.min.64d56283aba037cc3a217d684edadfb4e3c57ca54122947d2f030f74bcd28a27.css as=style integrity="sha256-ZNVig6ugN8w6IX1oTtrftOPFfKVBIpR9LwMPdLzSiic=" crossorigin=anonymous><link href=/scss/main.min.64d56283aba037cc3a217d684edadfb4e3c57ca54122947d2f030f74bcd28a27.css rel=stylesheet integrity="sha256-ZNVig6ugN8w6IX1oTtrftOPFfKVBIpR9LwMPdLzSiic=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg width="90" height="90" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#FFF" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#FFF" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#FFF" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#FFF" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009F76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=navbar-brand__name>Gardener</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://demo.gardener.cloud target=_blank rel=noopener><span>Demo</span></a></li><li class=nav-item><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class=nav-item><a class=nav-link href=/docs><span>Documentation</span></a></li><li class=nav-item><a class=nav-link href=/blog><span>Blogs</span></a></li><li class=nav-item><a class=nav-link href=/community><span>Community</span></a></li><li class=nav-item><a class=nav-link href=https://join.slack.com/t/gardener-cloud/shared_invite/zt-33c9daems-3oOorhnqOSnldZPWqGmIBw target=_blank rel=noopener><span>Join us on</span></a></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.e1b7ceb5b95bfb33b7e3c78fc34431c3.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/gardener/shoot-operations/>Return to the regular view of this page</a>.</p></div><h1 class=title>Shoot Operations</h1><div class=content></div></div><div class=td-content><h1 id=pg-5aa00c2e7d31ef6d9e805a0a57e7316f>1 - Controlling the Kubernetes Versions for Specific Worker Pools</h1><h1 id=controlling-the-kubernetes-versions-for-specific-worker-pools>Controlling the Kubernetes Versions for Specific Worker Pools<a class=td-heading-self-link href=#controlling-the-kubernetes-versions-for-specific-worker-pools aria-label="Heading self-link"></a></h1><p>Since Gardener <code>v1.36</code>, worker pools can have different Kubernetes versions specified than the control plane.</p><p>In earlier Gardener versions, all worker pools inherited the Kubernetes version of the control plane. Once the Kubernetes version of the control plane was modified, all worker pools have been updated as well (either by rolling the nodes in case of a minor version change, or in-place for patch version changes).</p><p>In order to gracefully perform Kubernetes upgrades (triggering a rolling update of the nodes) with workloads sensitive to restarts (e.g., those dealing with lots of data), it might be required to be able to gradually perform the upgrade process.
In such cases, the Kubernetes version for the worker pools can be pinned (<code>.spec.provider.workers[].kubernetes.version</code>) while the control plane Kubernetes version (<code>.spec.kubernetes.version</code>) is updated.
This results in the nodes being untouched while the control plane is upgraded.
Now a new worker pool (with the version equal to the control plane version) can be added.
Administrators can then reschedule their workloads to the new worker pool according to their upgrade requirements and processes.</p><h2 id=example-usage-in-a-shoot>Example Usage in a <code>Shoot</code><a class=td-heading-self-link href=#example-usage-in-a-shoot aria-label="Heading self-link"></a></h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.27.4
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: data1
</span></span><span style=display:flex><span>      kubernetes:
</span></span><span style=display:flex><span>        version: 1.26.8
</span></span><span style=display:flex><span>    - name: data2
</span></span></code></pre></div><ul><li>If <code>.kubernetes.version</code> is not specified in a worker pool, then the Kubernetes version of the kubelet is inherited from the control plane (<code>.spec.kubernetes.version</code>), i.e., in the above example, the <code>data2</code> pool will use <code>1.26.8</code>.</li><li>If <code>.kubernetes.version</code> is specified in a worker pool, then it must meet the following constraints:<ul><li>It must be at most two minor versions lower than the control plane version.</li><li>If it was not specified before, then no downgrade is possible (you cannot set it to <code>1.26.8</code> while <code>.spec.kubernetes.version</code> is already <code>1.27.4</code>). The &ldquo;two minor version skew&rdquo; is only possible if the worker pool version is set to the control plane version and then the control plane was updated gradually by two minor versions.</li><li>If the version is removed from the worker pool, only one minor version difference is allowed to the control plane (you cannot upgrade a pool from version <code>1.25.0</code> to <code>1.27.0</code> in one go).</li></ul></li></ul><p>Automatic updates of Kubernetes versions (see <a href=/docs/gardener/shoot/shoot_maintenance/#automatic-version-updates>Shoot Maintenance</a>) also apply to worker pool Kubernetes versions.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f1fe8ee103e52100493fb680d2521cab>2 - SecretBinding to CredentialsBinding Migration</h1><h1 id=secretbinding-to-credentialsbinding-migration>SecretBinding to CredentialsBinding Migration<a class=td-heading-self-link href=#secretbinding-to-credentialsbinding-migration aria-label="Heading self-link"></a></h1><p>With the introduction of the <a href=/docs/gardener/api-reference/security/#credentialsbinding><code>CredentialsBinding</code></a> resource a new way of referencing credentials through the <code>Shoot</code> was created.
While <code>SecretBinding</code>s can only reference <code>Secret</code>s, <code>CredentialsBinding</code>s can also reference <code>WorkloadIdentity</code>s which provide an alternative authentication method.
<code>WorkloadIdentity</code>s do not directly contain credentials but are rather a representation of the workload that is going to access the user&rsquo;s account.</p><p>As <code>CredentialsBinding</code>s cover the functionality of <code>SecretBinding</code>s, the latter are considered legacy and will be deprecated in the future.
This incurs the need for migration from <code>SecretBinding</code> to <code>CredentialsBinding</code> resources.</p><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>Mind that the migration will be allowed only if the old <code>SecretBinding</code> and the new <code>CredentialsBinding</code> refer to the same exact <code>Secret</code>.
One cannot do a direct migration to a <code>CredentialsBinding</code> that reference a <code>WorkloadIdentity</code>.
For information on how to use <code>WorkloadIdentity</code>, please refer to the following <a href=/docs/gardener/shoot/shoot-workload-identity/>document</a>.</p></blockquote><h2 id=migration-path>Migration Path<a class=td-heading-self-link href=#migration-path aria-label="Heading self-link"></a></h2><p>A standard use of <code>SecretBinding</code> can look like the following example.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: SecretBinding
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: infrastructure-credentials
</span></span><span style=display:flex><span>  namespace: garden-proj
</span></span><span style=display:flex><span>provider:
</span></span><span style=display:flex><span>  type: foo-provider
</span></span><span style=display:flex><span>secretRef:
</span></span><span style=display:flex><span>  name: infrastructure-credentials-secret
</span></span><span style=display:flex><span>  namespace: garden-proj
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: bar
</span></span><span style=display:flex><span>  namespace: garden-proj
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  secretBindingName: infrastructure-credentials
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>In order to migrate to <code>CredentialsBinding</code> one should:</p><ol><li><p>Create a <code>CredentialsBinding</code> resource corresponding to the existing <code>SecretBinding</code>. The main difference is that we set the <code>kind</code> and <code>apiVersion</code> of the credentials that the <code>CredentialsBinding</code> is referencing.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: security.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: CredentialsBinding
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: infrastructure-credentials
</span></span><span style=display:flex><span>  namespace: garden-proj
</span></span><span style=display:flex><span>credentialsRef:
</span></span><span style=display:flex><span>  apiVersion: v1
</span></span><span style=display:flex><span>  kind: Secret
</span></span><span style=display:flex><span>  name: infrastructure-credentials-secret
</span></span><span style=display:flex><span>  namespace: garden-proj
</span></span><span style=display:flex><span>provider:
</span></span><span style=display:flex><span>  type: foo-provider
</span></span></code></pre></div></li><li><p>Replace <code>secretBindingName</code> with <code>credentialsBindingName</code> in the <code>Shoot</code> spec.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: bar
</span></span><span style=display:flex><span>  namespace: garden-proj
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  credentialsBindingName: infrastructure-credentials
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-790281a2e6bedc94afe8be9de667dad3>3 - Shoot Credentials Rotation</h1><h1 id=credentials-rotation-for-shoot-clusters>Credentials Rotation for Shoot Clusters<a class=td-heading-self-link href=#credentials-rotation-for-shoot-clusters aria-label="Heading self-link"></a></h1><p>There are a lot of different credentials for <code>Shoot</code>s to make sure that the various components can communicate with each other and to make sure it is usable and operable.</p><p>This page explains how the varieties of credentials can be rotated so that the cluster can be considered secure.</p><h2 id=user-provided-credentials>User-Provided Credentials<a class=td-heading-self-link href=#user-provided-credentials aria-label="Heading self-link"></a></h2><h3 id=cloud-provider-keys>Cloud Provider Keys<a class=td-heading-self-link href=#cloud-provider-keys aria-label="Heading self-link"></a></h3><p>End-users must provide credentials such that Gardener and Kubernetes controllers can communicate with the respective cloud provider APIs in order to perform infrastructure operations.
For example, Gardener uses them to set up and maintain the networks, security groups, subnets, etc., while the <a href=https://kubernetes.io/docs/concepts/architecture/cloud-controller/>cloud-controller-manager</a> uses them to reconcile load balancers and routes, and the <a href=https://kubernetes-csi.github.io/docs/>CSI controller</a> uses them to reconcile volumes and disks.</p><p>Depending on the cloud provider, the required <a href=https://github.com/gardener/gardener/blob/master/example/70-secret-provider.yaml>data keys of the <code>Secret</code> differ</a>.
Please consult the documentation of the respective provider extension documentation to get to know the concrete data keys (e.g., <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/usage/#provider-secret-data>this document for AWS</a>).</p><p><strong>It is the responsibility of the end-user to regularly rotate those credentials.</strong>
The following steps are required to perform the rotation:</p><ol><li>Update the data in the <code>Secret</code> with new credentials.</li><li>⚠️ Wait until all <code>Shoot</code>s using the <code>Secret</code> are reconciled before you disable the old credentials in your cloud provider account! Otherwise, the <code>Shoot</code>s will no longer work as expected. Check out <a href=/docs/gardener/shoot-operations/shoot_operations/#immediate-reconciliation>this document</a> to learn how to trigger a reconciliation of your <code>Shoot</code>s.<ul><li>(Optional) If you want to verify that the new credentials are valid you can trigger <a href=/docs/gardener/shoot-operations/shoot_operations/#immediate-maintenance>immediate maintenance operation</a> for the corresponding shoot cluster(s) and wait for to subsequent reconciliation(s) to complete successfully. The maintenance operation triggers infrastructure reconciliation during the subsequent shoot reconciliation which makes use of the new cloud provider credentials.</li></ul></li><li>After all <code>Shoot</code>s using the <code>Secret</code> were reconciled, you can go ahead and deactivate the old credentials in your provider account.</li></ol><h2 id=gardener-provided-credentials>Gardener-Provided Credentials<a class=td-heading-self-link href=#gardener-provided-credentials aria-label="Heading self-link"></a></h2><p>The below credentials are generated by Gardener when shoot clusters are being created.
Those include:</p><ul><li>certificate authorities (and related server and client certificates)</li><li>observability passwords for Plutono</li><li>SSH key pair for worker nodes</li><li>ETCD encryption key</li><li><code>ServiceAccount</code> token signing key</li><li>&mldr;</li></ul><p><strong>🚨 There is no auto-rotation of those credentials, and it is the responsibility of the end-user to regularly rotate them.</strong></p><p>While it is possible to rotate them one by one, there is also a convenient method to combine the rotation of all of those credentials.
The rotation happens in two phases since it might be required to update some API clients (e.g., when CAs are rotated).</p><h3 id=prepare-rotation-of-all-credentials>Prepare Rotation of All Credentials<a class=td-heading-self-link href=#prepare-rotation-of-all-credentials aria-label="Heading self-link"></a></h3><p>In order to start the rotation (first phase), you have to annotate the shoot with the <code>rotate-credentials-start</code> operation:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n &lt;shoot-namespace&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=rotate-credentials-start
</span></span></code></pre></div><blockquote class="alert alert-tip"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>lightbulb-on-outline</title><path d="M20 11h3v2H20V11M1 11H4v2H1V11M13 1V4H11V1h2M4.92 3.5 7.05 5.64 5.63 7.05 3.5 4.93 4.92 3.5M16.95 5.63 19.07 3.5 20.5 4.93 18.37 7.05 16.95 5.63M12 6a6 6 0 016 6c0 2.22-1.21 4.16-3 5.2V19a1 1 0 01-1 1H10A1 1 0 019 19V17.2C7.21 16.16 6 14.22 6 12a6 6 0 016-6m2 15v1a1 1 0 01-1 1H11a1 1 0 01-1-1V21h4m-3-3h2V15.87c1.73-.44 3-2.01 3-3.87A4 4 0 0012 8 4 4 0 008 12c0 1.86 1.27 3.43 3 3.87V18z"/></svg><p>Tip</p></div><p>You can check the <code>.status.credentials.rotation</code> field in the <code>Shoot</code> to see when the rotation was last initiated and last completed.</p></blockquote><p>Kindly consider the detailed descriptions below to learn how the rotation is performed and what your responsibilities are.
Please note that all respective individual actions apply for this combined rotation as well (e.g., worker nodes are rolled out in the first phase).</p><blockquote class="alert alert-tip"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>lightbulb-on-outline</title><path d="M20 11h3v2H20V11M1 11H4v2H1V11M13 1V4H11V1h2M4.92 3.5 7.05 5.64 5.63 7.05 3.5 4.93 4.92 3.5M16.95 5.63 19.07 3.5 20.5 4.93 18.37 7.05 16.95 5.63M12 6a6 6 0 016 6c0 2.22-1.21 4.16-3 5.2V19a1 1 0 01-1 1H10A1 1 0 019 19V17.2C7.21 16.16 6 14.22 6 12a6 6 0 016-6m2 15v1a1 1 0 01-1 1H11a1 1 0 01-1-1V21h4m-3-3h2V15.87c1.73-.44 3-2.01 3-3.87A4 4 0 0012 8 4 4 0 008 12c0 1.86 1.27 3.43 3 3.87V18z"/></svg><p>Tip</p></div><p>If you don&rsquo;t want the worker nodes to roll out immediately in this phase (and rather trigger it individually at a later time of your convenience), you can use the <code>rotate-credentials-start-without-workers-rollout</code> and <code>rotate-rollout-workers</code> operations instead.
Read up all about it <a href=/docs/gardener/shoot-operations/shoot_credentials_rotation/#triggering-worker-node-rollout-individually>here</a>.</p></blockquote><h3 id=complete-rotation-of-all-credentials>Complete Rotation of All Credentials<a class=td-heading-self-link href=#complete-rotation-of-all-credentials aria-label="Heading self-link"></a></h3><p>You can complete the rotation (second phase) by annotating the shoot with the <code>rotate-credentials-complete</code> operation:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n &lt;shoot-namespace&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=rotate-credentials-complete
</span></span></code></pre></div><h3 id=certificate-authorities>Certificate Authorities<a class=td-heading-self-link href=#certificate-authorities aria-label="Heading self-link"></a></h3><p>Gardener generates several certificate authorities (CAs) to ensure secured communication between the various components and actors.
Most of those CAs are used for internal communication (e.g., <code>kube-apiserver</code> talks to etcd, <code>vpn-shoot</code> talks to the <code>vpn-seed-server</code>, <code>kubelet</code> talks to <code>kube-apiserver</code>).
However, there is also the &ldquo;cluster CA&rdquo; which is part of all <code>kubeconfig</code>s and used to sign the server certificate exposed by the <code>kube-apiserver</code>.</p><p>Gardener populates a <code>ConfigMap</code> with the name <code>&lt;shoot-name>.ca-cluster</code> in the project namespace in the garden cluster which contains the following data keys:</p><ul><li><code>ca.crt</code>: the CA bundle of the cluster</li></ul><p>This bundle contains one or multiple CAs which are used for signing serving certificates of the <code>Shoot</code>&rsquo;s API server.
Hence, the certificates contained in this <code>ConfigMap</code> can be used to verify the API server&rsquo;s identity when communicating with its public endpoint (e.g., as <code>certificate-authority-data</code> in a <code>kubeconfig</code>).
This is the same certificate that is also contained in the <code>kubeconfig</code>&rsquo;s <code>certificate-authority-data</code> field.</p><blockquote><p><code>Shoot</code>s created with Gardener >= v1.45 have a dedicated client CA which verifies the legitimacy of client certificates. For older <code>Shoot</code>s, the client CA is equal to the cluster CA. With the first CA rotation, such clusters will get a dedicated client CA as well.</p></blockquote><p>All the certificates are valid for 10 years.
Since it requires adaptation for the consumers of the <code>Shoot</code>, there is no automatic rotation, and <strong>it is the responsibility of the end-user to regularly rotate the CA certificates.</strong></p><p>The rotation happens in three stages (see also <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/18-shoot-CA-rotation.md>GEP-18</a> for the full details):</p><ul><li>In stage one, new CAs are created and added to the bundle (together with the old CAs). Client certificates are re-issued immediately.</li><li>In stage two, end-users update all cluster API clients that communicate with the control plane.</li><li>In stage three, the old CAs are dropped from the bundle and server certificate are re-issued.</li></ul><p>Technically, the <code>Preparing</code> phase indicates stage one.
Once it is completed, the <code>Prepared</code> phase indicates readiness for stage two.
The <code>Completing</code> phase indicates stage three, and the <code>Completed</code> phase states that the rotation process has finished.</p><blockquote><p>You can check the <code>.status.credentials.rotation.certificateAuthorities</code> field in the <code>Shoot</code> to see when the rotation was last initiated, last completed, and in which phase it currently is.</p></blockquote><p>In order to start the rotation (stage one), you have to annotate the shoot with the <code>rotate-ca-start</code> operation:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n &lt;shoot-namespace&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=rotate-ca-start
</span></span></code></pre></div><p>This will trigger a <code>Shoot</code> reconciliation and performs stage one.
After it is completed, the <code>.status.credentials.rotation.certificateAuthorities.phase</code> is set to <code>Prepared</code>.</p><p>Now you must update all API clients outside the cluster (such as the <code>kubeconfig</code>s on developer machines) to use the newly issued CA bundle in the <code>&lt;shoot-name>.ca-cluster</code> <code>ConfigMap</code>.
Please also note that client certificates must be re-issued now.</p><p>After updating all API clients, you can complete the rotation by annotating the shoot with the <code>rotate-ca-complete</code> operation:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n &lt;shoot-namespace&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=rotate-ca-complete
</span></span></code></pre></div><p>This will trigger another <code>Shoot</code> reconciliation and performs stage three.
After it is completed, the <code>.status.credentials.rotation.certificateAuthorities.phase</code> is set to <code>Completed</code>.
You could update your API clients again and drop the old CA from their bundle.</p><blockquote><p>Note that the CA rotation also rotates all internal CAs and signed certificates.
Hence, most of the components need to be restarted (including etcd and <code>kube-apiserver</code>).</p><p>⚠️ In stage one, all worker nodes of the <code>Shoot</code> will be rolled out to ensure that the <code>Pod</code>s as well as the <code>kubelet</code>s get the updated credentials as well.</p></blockquote><h4 id=triggering-worker-node-rollout-individually>Triggering Worker Node Rollout Individually<a class=td-heading-self-link href=#triggering-worker-node-rollout-individually aria-label="Heading self-link"></a></h4><p>If you don&rsquo;t want that all worker nodes of the <code>Shoot</code> get rolled out in phase one, you can start the rotation with <code>rotate-ca-start-without-workers-rollout</code> instead of <code>rotate-ca-start</code>.
This allows you to trigger the worker node rollout individually (per worker pool) whenever you are ready for it.</p><p>Using this annotation will trigger a <code>Shoot</code> reconciliation and performs stage one.
While it&rsquo;s running, <code>.status.credentials.rotation.certificateAuthorities.phase</code> is set to <code>PreparingWithoutWorkersRollout</code>.
Once completed, the <code>phase</code> transitions to <code>WaitingForWorkersRollout</code>.</p><p>Now you can update all API clients outside the cluster (see above) and also trigger the rollout of your worker pools like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n &lt;shoot-namespace&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=rotate-rollout-workers=&lt;pool1-name&gt;[,&lt;pool2-name&gt;,...]
</span></span></code></pre></div><p>You can check which worker pools still need to be rolled by reading <code>.status.credentials.rotation.certificateAuthorities.pendingWorkersRollouts[].name</code>.
Once this list is empty, the <code>phase</code> transitions to <code>Prepared</code>.
Now you can just complete the rotation as usual (see above).</p><h4 id=worker-node-with-manualinplaceupdate-update-strategy>Worker Node with ManualInPlaceUpdate Update Strategy<a class=td-heading-self-link href=#worker-node-with-manualinplaceupdate-update-strategy aria-label="Heading self-link"></a></h4><p>In case of manual in-place update, shoot CA rotation phase will be at <code>Preparing</code> until all the worker pools are successfully in-place updated and there are no pending worker pools with strategy ManualInPlaceUpdate.</p><p>You can check which worker pools still need to be updated by reading <code>.status.inPlaceUpdates.pendingWorkerUpdates.manualInPlaceUpdate</code>.
Once this list is empty, the <code>phase</code> transitions to <code>Prepared</code>.
After this rotation will be completed as usual (see above).</p><h3 id=observability-passwords-for-plutono-and-prometheus>Observability Password(s) For Plutono and Prometheus<a class=td-heading-self-link href=#observability-passwords-for-plutono-and-prometheus aria-label="Heading self-link"></a></h3><p>For <code>Shoot</code>s with <code>.spec.purpose!=testing</code>, Gardener deploys an observability stack with Prometheus for monitoring, Alertmanager for alerting (optional), Vali for logging, and Plutono for visualization.
The Plutono instance is exposed via <code>Ingress</code> and accessible for end-users via basic authentication credentials generated and managed by Gardener.</p><p>Those credentials are stored in a <code>Secret</code> with the name <code>&lt;shoot-name>.monitoring</code> in the project namespace in the garden cluster and has multiple data keys:</p><ul><li><code>username</code>: the username</li><li><code>password</code>: the password</li><li><code>auth</code>: the username with SHA-1 representation of the password</li></ul><p><strong>It is the responsibility of the end-user to regularly rotate those credentials.</strong>
In order to rotate the <code>password</code>, annotate the <code>Shoot</code> with <code>gardener.cloud/operation=rotate-observability-credentials</code>.
This operation is not allowed for <code>Shoot</code>s that are already marked for deletion.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n &lt;shoot-namespace&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=rotate-observability-credentials
</span></span></code></pre></div><blockquote><p>You can check the <code>.status.credentials.rotation.observability</code> field in the <code>Shoot</code> to see when the rotation was last initiated and last completed.</p></blockquote><h3 id=ssh-key-pair-for-worker-nodes>SSH Key Pair for Worker Nodes<a class=td-heading-self-link href=#ssh-key-pair-for-worker-nodes aria-label="Heading self-link"></a></h3><p>Gardener generates an SSH key pair whose public key is propagated to all worker nodes of the <code>Shoot</code>.
The private key can be used to establish an SSH connection to the workers for troubleshooting purposes.
It is recommended to use <a href=https://github.com/gardener/gardenctl-v2/><code>gardenctl-v2</code></a> and its <code>gardenctl ssh</code> command since it is required to first open up the security groups and create a bastion VM (no direct SSH access to the worker nodes is possible).</p><p>The private key is stored in a <code>Secret</code> with the name <code>&lt;shoot-name>.ssh-keypair</code> in the project namespace in the garden cluster and has multiple data keys:</p><ul><li><code>id_rsa</code>: the private key</li><li><code>id_rsa.pub</code>: the public key for SSH</li></ul><p>In order to rotate the keys, annotate the <code>Shoot</code> with <code>gardener.cloud/operation=rotate-ssh-keypair</code>.
This will propagate a new key to all worker nodes while keeping the old key active and valid as well (it will only be invalidated/removed with the next rotation).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n &lt;shoot-namespace&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=rotate-ssh-keypair
</span></span></code></pre></div><blockquote><p>You can check the <code>.status.credentials.rotation.sshKeypair</code> field in the <code>Shoot</code> to see when the rotation was last initiated or last completed.</p></blockquote><p>The old key is stored in a <code>Secret</code> with the name <code>&lt;shoot-name>.ssh-keypair.old</code> in the project namespace in the garden cluster and has the same data keys as the regular <code>Secret</code>.</p><h3 id=etcd-encryption-key>ETCD Encryption Key<a class=td-heading-self-link href=#etcd-encryption-key aria-label="Heading self-link"></a></h3><p>This key is used to encrypt the data of <code>Secret</code> resources inside etcd (see <a href=https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/>upstream Kubernetes documentation</a>).</p><p>The encryption key has no expiration date.
There is no automatic rotation, and <strong>it is the responsibility of the end-user to regularly rotate the encryption key.</strong></p><p>The rotation happens in three stages:</p><ul><li>In stage one, a new encryption key is created and added to the bundle (together with the old encryption key).</li><li>In stage two, all <code>Secret</code>s in the cluster and resources configured in the <code>spec.kubernetes.kubeAPIServer.encryptionConfig</code> of the Shoot (see <a href=/docs/gardener/security/etcd_encryption_config/>ETCD Encryption Config</a>) are rewritten by the <code>kube-apiserver</code> so that they become encrypted with the new encryption key.</li><li>In stage three, the old encryption is dropped from the bundle.</li></ul><p>Technically, the <code>Preparing</code> phase indicates the stages one and two.
Once it is completed, the <code>Prepared</code> phase indicates readiness for stage three.
The <code>Completing</code> phase indicates stage three, and the <code>Completed</code> phase states that the rotation process has finished.</p><blockquote><p>You can check the <code>.status.credentials.rotation.etcdEncryptionKey</code> field in the <code>Shoot</code> to see when the rotation was last initiated, last completed, and in which phase it currently is.</p></blockquote><p>In order to start the rotation (stage one), you have to annotate the shoot with the <code>rotate-etcd-encryption-key-start</code> operation:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n &lt;shoot-namespace&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=rotate-etcd-encryption-key-start
</span></span></code></pre></div><p>This will trigger a <code>Shoot</code> reconciliation and performs the stages one and two.
After it is completed, the <code>.status.credentials.rotation.etcdEncryptionKey.phase</code> is set to <code>Prepared</code>.
Now you can complete the rotation by annotating the shoot with the <code>rotate-etcd-encryption-key-complete</code> operation:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n &lt;shoot-namespace&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=rotate-etcd-encryption-key-complete
</span></span></code></pre></div><p>This will trigger another <code>Shoot</code> reconciliation and performs stage three.
After it is completed, the <code>.status.credentials.rotation.etcdEncryptionKey.phase</code> is set to <code>Completed</code>.</p><h3 id=serviceaccount-token-signing-key><code>ServiceAccount</code> Token Signing Key<a class=td-heading-self-link href=#serviceaccount-token-signing-key aria-label="Heading self-link"></a></h3><p>Gardener generates a key which is used to sign the tokens for <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/><code>ServiceAccount</code>s</a>.
Those tokens are typically used by workload <code>Pod</code>s running inside the cluster in order to authenticate themselves with the <code>kube-apiserver</code>.
This also includes system components running in the <code>kube-system</code> namespace.</p><p>The token signing key has no expiration date.
Since it might require adaptation for the consumers of the <code>Shoot</code>, there is no automatic rotation, and <strong>it is the responsibility of the end-user to regularly rotate the signing key.</strong></p><p>The rotation happens in three stages, similar to how the <a href=/docs/gardener/shoot-operations/shoot_credentials_rotation/#certificate-authorities>CA certificates</a> are rotated:</p><ul><li>In stage one, a new signing key is created and added to the bundle (together with the old signing key).</li><li>In stage two, end-users update all out-of-cluster API clients that communicate with the control plane via <code>ServiceAccount</code> tokens.</li><li>In stage three, the old signing key is dropped from the bundle.</li></ul><p>Technically, the <code>Preparing</code> phase indicates stage one.
Once it is completed, the <code>Prepared</code> phase indicates readiness for stage two.
The <code>Completing</code> phase indicates stage three, and the <code>Completed</code> phase states that the rotation process has finished.</p><blockquote><p>You can check the <code>.status.credentials.rotation.serviceAccountKey</code> field in the <code>Shoot</code> to see when the rotation was last initiated, last completed, and in which phase it currently is.</p></blockquote><p>In order to start the rotation (stage one), you have to annotate the shoot with the <code>rotate-serviceaccount-key-start</code> operation:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n &lt;shoot-namespace&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=rotate-serviceaccount-key-start
</span></span></code></pre></div><p>This will trigger a <code>Shoot</code> reconciliation and performs stage one.
After it is completed, the <code>.status.credentials.rotation.serviceAccountKey.phase</code> is set to <code>Prepared</code>.</p><p>Now you must update all API clients outside the cluster using a <code>ServiceAccount</code> token (such as the <code>kubeconfig</code>s on developer machines) to use a token issued by the new signing key.
Gardener already generates new secrets for those <code>ServiceAccount</code>s in the cluster, whose static token was automatically created by Kubernetes (typically before <code>v1.22</code> - <a href="https://github.com/kubernetes/website/blob/ce481bee92c7c1e110eb81207ec3883a975f9587/content/en/docs/reference/access-authn-authz/service-accounts-admin.md?plain=1#L216">ref</a>)
However, if you need to create it manually, you can check out <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#manually-create-a-service-account-api-token>this document</a> for instructions.</p><p>After updating all API clients, you can complete the rotation by annotating the shoot with the <code>rotate-serviceaccount-key-complete</code> operation:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n &lt;shoot-namespace&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=rotate-serviceaccount-key-complete
</span></span></code></pre></div><p>This will trigger another <code>Shoot</code> reconciliation and performs stage three.
After it is completed, the <code>.status.credentials.rotation.serviceAccountKey.phase</code> is set to <code>Completed</code>.</p><blockquote><p>⚠️ In stage one, all worker nodes of the <code>Shoot</code> will be rolled out to ensure that the <code>Pod</code>s use a new token.</p></blockquote><h4 id=triggering-worker-node-rollout-individually-1>Triggering Worker Node Rollout Individually<a class=td-heading-self-link href=#triggering-worker-node-rollout-individually-1 aria-label="Heading self-link"></a></h4><p>Similar to the rotation of the certificate authorities, you can control the worker node rollout individually.
Please read <a href=/docs/gardener/shoot-operations/shoot_credentials_rotation/#triggering-worker-node-rollout-individually>this section</a> to get more information.
It works the same way for the <code>ServiceAccount</code> token signing key (using <code>rotate-serviceaccount-key-start-without-workers-rollout</code>).</p><h4 id=worker-node-with-manualinplaceupdate-update-strategy-1>Worker Node with ManualInPlaceUpdate Update Strategy<a class=td-heading-self-link href=#worker-node-with-manualinplaceupdate-update-strategy-1 aria-label="Heading self-link"></a></h4><p>Similar to the rotation of the certificate authorities, in case of manual in-place update, <code>ServiceAccount</code> token signing key rotation phase will be at <code>Preparing</code> until all the worker pools are successfully in-place updated and there are no pending worker pools with strategy ManualInPlaceUpdate.
Please read <a href=/docs/gardener/shoot-operations/shoot_credentials_rotation/#worker-node-with-manualinplaceupdate-update-strategy>this section</a> for more information.</p><h3 id=openvpn-tls-auth-keys>OpenVPN TLS Auth Keys<a class=td-heading-self-link href=#openvpn-tls-auth-keys aria-label="Heading self-link"></a></h3><p>This key is used to ensure encrypted communication for the VPN connection between the control plane in the seed cluster and the shoot cluster.
It is currently <strong>not</strong> rotated automatically and there is no way to trigger it manually.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b33f8b21c07be8a7dd35e739cb619e7a>4 - Shoot Kubernetes and Operating System Versioning in Gardener</h1><h1 id=shoot-kubernetes-and-operating-system-versioning-in-gardener>Shoot Kubernetes and Operating System Versioning in Gardener<a class=td-heading-self-link href=#shoot-kubernetes-and-operating-system-versioning-in-gardener aria-label="Heading self-link"></a></h1><h2 id=motivation>Motivation<a class=td-heading-self-link href=#motivation aria-label="Heading self-link"></a></h2><p>On the one hand-side, Gardener is responsible for managing the Kubernetes and the Operating System (OS) versions of its Shoot clusters.
On the other hand-side, Gardener needs to be configured and updated based on the availability and support of the Kubernetes and Operating System version it provides.
For instance, the Kubernetes community releases <strong>minor</strong> versions roughly every three months and usually maintains <strong>three minor</strong> versions (the current and the last two) with bug fixes and security updates.
Patch releases are done more frequently.</p><p>When using the term <code>Machine image</code> in the following, we refer to the OS version that comes with the machine image of the node/worker pool of a Gardener Shoot cluster.
As such, we are not referring to the <code>CloudProvider</code> specific machine image like the <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html><code>AMI</code></a> for AWS.
For more information on how Gardener maps machine image versions to <code>CloudProvider</code> specific machine images, take a look at the individual gardener extension providers, such as the <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/operations/>provider for AWS</a>.</p><p>Gardener should be configured accordingly to reflect the &ldquo;logical state&rdquo; of a version.
It should be possible to define the Kubernetes or Machine image versions that still receive bug fixes and security patches, and also vice-versa to define the version that are out-of-maintenance and are potentially vulnerable.
Moreover, this allows Gardener to &ldquo;understand&rdquo; the current state of a version and act upon it (more information in the following sections).</p><h2 id=overview>Overview<a class=td-heading-self-link href=#overview aria-label="Heading self-link"></a></h2><p><strong>As a Gardener operator</strong>:</p><ul><li>I can classify a version based on it&rsquo;s logical state (<code>preview</code>, <code>supported</code>, <code>deprecated</code>, and <code>expired</code>; see <a href=/docs/gardener/shoot-operations/shoot_versions/#version-classifications>Version Classification</a>).</li><li>I can define which Machine image and Kubernetes versions are eligible for the auto update of clusters during the maintenance time.</li><li>I can define a moment in time when Shoot clusters are forcefully migrated off a certain version (through an <code>expirationDate</code>).</li><li>I can define an update path for machine images for auto and force updates; see <a href=/docs/gardener/shoot-operations/shoot_versions/#update-path-for-machine-image-versions>Update path for machine image versions</a>).</li><li>I can disallow the creation of clusters having a certain version (think of severe security issues).</li></ul><p><strong>As an end-user/Shoot owner of Gardener</strong>:</p><ul><li>I can get information about which Kubernetes and Machine image versions exist and their classification.</li><li>I can determine the time when my Shoot clusters Machine image and Kubernetes version will be forcefully updated to the next patch or minor version (in case the cluster is running a deprecated version with an expiration date).</li><li>I can get this information via API from the <code>CloudProfile</code>.</li></ul><h2 id=version-classifications>Version Classifications<a class=td-heading-self-link href=#version-classifications aria-label="Heading self-link"></a></h2><p>Administrators can classify versions into four distinct &ldquo;logical states&rdquo;: <code>preview</code>, <code>supported</code>, <code>deprecated</code>, and <code>expired</code>.
The version classification serves as a &ldquo;point-of-reference&rdquo; for end-users and also has implications during shoot creation and the maintenance time.</p><p>If a version is unclassified, Gardener cannot make those decision based on the &ldquo;logical state&rdquo;.
Nevertheless, Gardener can operate without version classifications and can be added at any time to the Kubernetes and machine image versions in the <code>CloudProfile</code>.</p><p>As a best practice, versions usually start with the classification <code>preview</code>, then are promoted to <code>supported</code>, eventually <code>deprecated</code> and finally <code>expired</code>.
This information is programmatically available in the <code>CloudProfiles</code> of the Garden cluster.</p><ul><li><p><strong>preview:</strong> A <code>preview</code> version is a new version that has not yet undergone thorough testing, possibly a new release, and needs time to be validated.
Due to its short early age, there is a higher probability of undiscovered issues and is therefore not yet recommended for production usage.
A Shoot does not update (neither <code>auto-update</code> or <code>force-update</code>) to a <code>preview</code> version during the maintenance time.
Also, <code>preview</code> versions are not considered for the defaulting to the highest available version when deliberately omitting the patch version during Shoot creation.
Typically, after a fresh release of a new Kubernetes (e.g., v1.25.0) or Machine image version (e.g., suse-chost 15.4.20220818), the operator tags it as <code>preview</code> until they have gained sufficient experience and regards this version to be reliable.
After the operator has gained sufficient trust, the version can be manually promoted to <code>supported</code>.</p></li><li><p><strong>supported:</strong> A <code>supported</code> version is the recommended version for new and existing Shoot clusters. This is the version that new Shoot clusters should use and existing clusters should update to.
Typically for Kubernetes versions, the latest Kubernetes patch versions of the actual (if not still in <code>preview</code>) and the last 3 minor Kubernetes versions are maintained by the community. An operator could define these versions as being <code>supported</code> (e.g., v1.27.6, v1.26.10, and v1.25.12).</p></li><li><p><strong>deprecated:</strong> A <code>deprecated</code> version is a version that approaches the end of its lifecycle and can contain issues which are probably resolved in a supported version.
New Shoots should not use this version anymore.
Existing Shoots will be updated to a newer version if <code>auto-update</code> is enabled (<code>.spec.maintenance.autoUpdate.kubernetesVersion</code> for Kubernetes version <code>auto-update</code>, or <code>.spec.maintenance.autoUpdate.machineImageVersion</code> for machine image version <code>auto-update</code>).
Using automatic upgrades, however, does not guarantee that a Shoot runs a non-deprecated version, as the latest version (overall or of the minor version) can be deprecated as well.
Deprecated versions <strong>should</strong> have an expiration date set for eventual expiration.</p></li><li><p><strong>expired:</strong> An <code>expired</code> versions has an expiration date (based on the <a href=https://golang.org/src/time/time.go>Golang time package</a>) in the past.
New clusters with that version cannot be created and existing clusters are forcefully migrated to a higher version during the maintenance time.</p></li></ul><p>Below is an example how the relevant section of the <code>CloudProfile</code> might look like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: CloudProfile
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: alicloud
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>      - classification: preview
</span></span><span style=display:flex><span>        version: 1.27.0
</span></span><span style=display:flex><span>      - classification: preview
</span></span><span style=display:flex><span>        version: 1.26.3
</span></span><span style=display:flex><span>      - classification: supported
</span></span><span style=display:flex><span>        version: 1.26.2
</span></span><span style=display:flex><span>      - classification: preview
</span></span><span style=display:flex><span>        version: 1.25.5
</span></span><span style=display:flex><span>      - classification: supported
</span></span><span style=display:flex><span>        version: 1.25.4
</span></span><span style=display:flex><span>      - classification: supported
</span></span><span style=display:flex><span>        version: 1.24.6
</span></span><span style=display:flex><span>      - classification: deprecated
</span></span><span style=display:flex><span>        expirationDate: <span style=color:#a31515>&#34;2022-11-30T23:59:59Z&#34;</span>
</span></span><span style=display:flex><span>        version: 1.24.5
</span></span></code></pre></div><h2 id=automatic-version-upgrades>Automatic Version Upgrades<a class=td-heading-self-link href=#automatic-version-upgrades aria-label="Heading self-link"></a></h2><p>There are two ways, the Kubernetes version of the control plane as well as the Kubernetes and machine image version of a worker pool can be upgraded: <code>auto update</code> and <code>forceful</code> update.
See <a href=/docs/gardener/shoot/shoot_maintenance/#automatic-version-updates>Automatic Version Updates</a> for how to enable <code>auto updates</code> for Kubernetes or machine image versions on the Shoot cluster.</p><p>If a Shoot is running a version after its expiration date has passed, it will be forcefully updated during its maintenance time.
This happens <strong>even if the owner has opted out of automatic cluster updates!</strong></p><p><strong>When an auto update is triggered?</strong>:</p><ul><li>The <code>Shoot</code> has auto-update enabled and the version is not the <em>latest eligible version</em> for the auto-update. Please note that this <em>latest version</em> that qualifies for an auto-update is not necessarily the overall latest version in the CloudProfile:<ul><li>For Kubernetes version, the latest eligible version for auto-updates is the latest patch version of the current minor.</li><li>For machine image version, the latest eligible version for auto-updates is controlled by the <code>updateStrategy</code> field of the machine image in the CloudProfile.</li></ul></li><li>The <code>Shoot</code> has auto-update disabled and the version is either expired or does not exist.</li></ul><p>The auto update can fail if the version is already on the <em>latest eligible version</em> for the auto-update. A failed auto update triggers a <strong>force update</strong>.
The force and auto update path for Kubernetes and machine image versions differ slightly and are described in more detail below.</p><p><strong>Update rules for both Kubernetes and machine image versions</strong></p><ul><li>Both auto and force update first try to update to the latest patch version of the same minor.</li><li>An auto update prefers supported versions over deprecated versions. If there is a lower supported version and a higher deprecated version, auto update will pick the supported version. If all qualifying versions are deprecated, update to the latest deprecated version.</li><li>An auto update never updates to an expired version.</li><li>A force update prefers to update to not-expired versions. If all qualifying versions are expired, update to the latest expired version. Please note that therefore <strong>multiple consecutive version upgrades</strong> are possible. In this case, the version is again upgraded in the <strong>next</strong> maintenance time.</li></ul><h3 id=update-path-for-machine-image-versions>Update path for machine image versions<a class=td-heading-self-link href=#update-path-for-machine-image-versions aria-label="Heading self-link"></a></h3><p>Administrators can define three different <strong>update strategies</strong> (field <code>updateStrategy</code>) for machine images in the CloudProfile: <code>patch</code>, <code>minor</code>, <code>major (default)</code>. This is to accommodate the different version schemes of Operating Systems (e.g. Gardenlinux only updates major and minor versions with occasional patches).</p><ul><li><code>patch</code>: update to the latest patch version of the current minor version. When using an expired version: force update to the latest patch of the current minor. If already on the latest patch version, then force update to the next higher (not necessarily +1) minor version.</li><li><code>minor</code>: update to the latest minor and patch version. When using an expired version: force update to the latest minor and patch of the current major. If already on the latest minor and patch of the current major, then update to the next higher (not necessarily +1) major version.</li><li><code>major</code>: always update to the overall latest version. This is the legacy behavior for automatic machine image version upgrades. Force updates are not possible and will fail if the latest version in the CloudProfile for that image is expired (EOL scenario).</li></ul><p>Example configuration in the CloudProfile:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>machineImages:
</span></span><span style=display:flex><span>  - name: gardenlinux
</span></span><span style=display:flex><span>    updateStrategy: minor
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>     - version: 1096.1.0
</span></span><span style=display:flex><span>     - version: 934.8.0
</span></span><span style=display:flex><span>     - version: 934.7.0
</span></span><span style=display:flex><span>  - name: suse-chost
</span></span><span style=display:flex><span>    updateStrategy: patch
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 15.3.20220818 
</span></span><span style=display:flex><span>    - version: 15.3.20221118
</span></span></code></pre></div><p>Please note that force updates for machine images can skip minor versions (strategy: patch) or major versions (strategy: minor) if the next minor/major version has no qualifying versions (only <code>preview</code> versions).</p><h3 id=update-path-for-kubernetes-versions>Update path for Kubernetes versions<a class=td-heading-self-link href=#update-path-for-kubernetes-versions aria-label="Heading self-link"></a></h3><p>For <strong>Kubernetes versions</strong>, the auto update picks the latest <code>non-preview</code> patch version of the current minor version.</p><p>If the cluster is already on the latest patch version and the latest patch version is also expired,
it will continue with the latest patch version of the <strong>next consecutive minor (minor +1) Kubernetes version</strong>,
so <strong>it will result in an update of a minor Kubernetes version!</strong></p><p>Kubernetes &ldquo;minor version jumps&rdquo; are not allowed - meaning to skip the update to the consecutive minor version and directly update to any version after that.
For instance, the version <code>1.24.x</code> can only update to a version <code>1.25.x</code>, not to <code>1.26.x</code> or any other version.
This is because Kubernetes does not guarantee upgradability in this case, leading to possibly broken Shoot clusters.
The administrator has to set up the <code>CloudProfile</code> in such a way that consecutive Kubernetes minor versions are available.
Otherwise, Shoot clusters will fail to upgrade during the maintenance time.</p><p>Consider the <code>CloudProfile</code> below with a Shoot using the Kubernetes version <code>1.24.12</code>.
Even though the version is <code>expired</code>, due to missing <code>1.25.x</code> versions, the Gardener Controller Manager cannot upgrade the Shoot&rsquo;s Kubernetes version.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 1.26.10
</span></span><span style=display:flex><span>    - version: 1.26.9
</span></span><span style=display:flex><span>    - version: 1.24.12
</span></span><span style=display:flex><span>      expirationDate: <span style=color:#a31515>&#34;&lt;expiration date in the past&gt;&#34;</span>
</span></span></code></pre></div><p>The <code>CloudProfile</code> must specify versions <code>1.25.x</code> of the <strong>consecutive</strong> minor version.
Configuring the <code>CloudProfile</code> in such a way, the Shoot&rsquo;s Kubernetes version will be upgraded to version <code>1.25.10</code> in the next maintenance time.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 1.26.9
</span></span><span style=display:flex><span>    - version: 1.25.10
</span></span><span style=display:flex><span>    - version: 1.25.9
</span></span><span style=display:flex><span>    - version: 1.24.12
</span></span><span style=display:flex><span>      expirationDate: <span style=color:#a31515>&#34;&lt;expiration date in the past&gt;&#34;</span>
</span></span></code></pre></div><h2 id=version-requirements-kubernetes-and-machine-image>Version Requirements (Kubernetes and Machine Image)<a class=td-heading-self-link href=#version-requirements-kubernetes-and-machine-image aria-label="Heading self-link"></a></h2><p>The Gardener API server enforces the following requirements for versions:</p><ul><li>A version that is in use by a Shoot cannot be deleted from the <code>CloudProfile</code>.</li><li>Creating a new version with expiration date in the past is not allowed.</li><li>There can be only one <code>supported</code> version per minor version.</li><li>The latest Kubernetes version cannot have an expiration date.<ul><li>NOTE: The latest version for a machine image can have an expiration date. [*]</li></ul></li></ul><p><sub>[*] Useful for cases in which support for a given machine image needs to be deprecated and removed (for example, the machine image reaches end of life).</sub></p><h2 id=related-documentation>Related Documentation<a class=td-heading-self-link href=#related-documentation aria-label="Heading self-link"></a></h2><p>You might want to read about the <a href=/docs/gardener/shoot-operations/shoot_updates/>Shoot Updates and Upgrades</a> procedures to get to know the effects of such operations.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0ef8b5456a24e8bc3b245e5e6e34bb24>5 - Shoot Updates and Upgrades</h1><h1 id=shoot-updates-and-upgrades>Shoot Updates and Upgrades<a class=td-heading-self-link href=#shoot-updates-and-upgrades aria-label="Heading self-link"></a></h1><p>This document describes what happens during shoot updates (changes incorporated in a newly deployed Gardener version) and during shoot upgrades (changes for version controllable by end-users).</p><h2 id=updates>Updates<a class=td-heading-self-link href=#updates aria-label="Heading self-link"></a></h2><p>Updates to all aspects of the shoot cluster happen when the gardenlet reconciles the <code>Shoot</code> resource.</p><h3 id=when-are-reconciliations-triggered>When are Reconciliations Triggered<a class=td-heading-self-link href=#when-are-reconciliations-triggered aria-label="Heading self-link"></a></h3><p>Generally, when you change the specification of your <code>Shoot</code> the reconciliation will start immediately, potentially updating your cluster.
Please note that you can also confine the reconciliation triggered due to your specification updates to the cluster&rsquo;s maintenance time window. Please find more information in <a href=/docs/gardener/shoot/shoot_maintenance/#confine-specification-changesupdates-roll-out>Confine Specification Changes/Updates Roll Out</a>.</p><p>You can also annotate your shoot with special operation annotations (for more information, see <a href=/docs/gardener/shoot-operations/shoot_operations/>Trigger Shoot Operations</a>), which will cause the reconciliation to start due to your actions.</p><p>There is also an automatic reconciliation by Gardener.
The period, i.e., how often it is performed, depends on the configuration of the Gardener administrators/operators.
In some Gardener installations the operators might enable &ldquo;reconciliation in maintenance time window only&rdquo; (for more information, see <a href=/docs/gardener/shoot/shoot_maintenance/#cluster-reconciliation>Cluster Reconciliation</a>), which will result in at least one reconciliation during the time configured in the <code>Shoot</code>&rsquo;s <code>.spec.maintenance.timeWindow</code> field.</p><h3 id=which-updates-are-applied>Which Updates are Applied<a class=td-heading-self-link href=#which-updates-are-applied aria-label="Heading self-link"></a></h3><p>As end-users can only control the <code>Shoot</code> resource&rsquo;s specification but not the used Gardener version, they don&rsquo;t have any influence on which of the updates are rolled out (other than those settings configurable in the <code>Shoot</code>).
A Gardener operator can deploy a new Gardener version at any point in time.
Any subsequent reconciliation of <code>Shoot</code>s will update them by rolling out the changes incorporated in this new Gardener version.</p><p>Some examples for such shoot updates are:</p><ul><li>Add a new/remove an old component to/from the shoot&rsquo;s control plane running in the seed, or to/from the shoot&rsquo;s system components running on the worker nodes.</li><li>Change the configuration of an existing control plane/system component.</li><li>Restart of existing control plane/system components (this might result in a short unavailability of the Kubernetes API server, e.g., when etcd or a kube-apiserver itself is being restarted)</li></ul><h3 id=behavioural-changes>Behavioural Changes<a class=td-heading-self-link href=#behavioural-changes aria-label="Heading self-link"></a></h3><p>Generally, some of such updates (e.g., configuration changes) could theoretically result in different behaviour of controllers.
If such changes would be backwards-incompatible, then we usually follow one of those approaches (depends on the concrete change):</p><ul><li>Only apply the change for new clusters.</li><li>Expose a new field in the <code>Shoot</code> resource that lets users control this changed behaviour to enable it at a convenient point in time.</li><li>Put the change behind an alpha feature gate (disabled by default) in the gardenlet (only controllable by Gardener operators), which will be promoted to beta (enabled by default) in subsequent releases (in this case, end-users have no influence on when the behaviour changes - Gardener operators should inform their end-users and provide clear timelines when they will enable the feature gate).</li></ul><h2 id=upgrades>Upgrades<a class=td-heading-self-link href=#upgrades aria-label="Heading self-link"></a></h2><p>We consider shoot upgrades to change either the:</p><ul><li>Kubernetes version (<code>.spec.kubernetes.version</code>)</li><li>Kubernetes version of the worker pool if specified (<code>.spec.provider.workers[].kubernetes.version</code>)</li><li>Machine image version of at least one worker pool (<code>.spec.provider.workers[].machine.image.version</code>)</li></ul><p>Generally, an upgrade is also performed through a reconciliation of the <code>Shoot</code> resource, i.e., the same concepts as for <a href=/docs/gardener/shoot-operations/shoot_updates/#updates>shoot updates</a> apply.
If an end-user triggers an upgrade (e.g., by changing the Kubernetes version) after a new Gardener version was deployed but before the shoot was reconciled again, then this upgrade might incorporate the changes delivered with this new Gardener version.</p><p>The <code>UpdateStrategy</code> field in the Shoot specification (<code>.spec.provider.workers[].updateStrategy</code>) gives users the flexibility to define how the <code>machine-controller-manager</code> handles worker pool updates during the upgrade process. Currently gardener support three update strategies:</p><ul><li><code>AutoRollingUpdate</code></li><li><code>AutoInPlaceUpdate</code></li><li><code>ManualInPlaceUpdate</code></li></ul><blockquote><p>⚠️ The above strategies generally require draining the node when changes are made to the <code>Shoot</code> specification. The specific changes that trigger this behavior will be discussed in later sections.
For all other spec changes like Kubernetes patch version update, the upgrade is executed without draining the node and the shoot worker nodes remain unchanged. In case of Kubernetes patch version, only the <code>kubelet</code> process is restarted with the updated Kubernetes version binary.</p></blockquote><h3 id=rolling-updates>Rolling Updates<a class=td-heading-self-link href=#rolling-updates aria-label="Heading self-link"></a></h3><p>The upgrade is performed in a &ldquo;rolling update&rdquo; manner, during which nodes in the worker pool are replaced. Similar to how pods in Kubernetes are updated when backed by a <code>Deployment</code>.
Worker nodes are terminated one after another and replaced by new nodes.
The existing workload is gracefully drained and evicted from the old worker nodes to new worker nodes, respecting the configured <code>PodDisruptionBudget</code>s (see <a href=https://kubernetes.io/docs/tasks/run-application/configure-pdb/>Specifying a Disruption Budget for your Application</a>).</p><h4 id=automatic-rolling-updates>Automatic Rolling Updates<a class=td-heading-self-link href=#automatic-rolling-updates aria-label="Heading self-link"></a></h4><p>When the auto rolling update strategy is selected, the update process is fully orchestrated by the Gardener and the <code>machine-controller-manager</code>. The <code>machine-controller-manager</code> sequentially terminates the worker nodes and replaces them with new nodes.</p><blockquote><p>ℹ️ This is the <code>default</code> update strategy.</p></blockquote><p>To create workers with <code>AutoRollingUpdate</code>, either omit the <code>Shoot'</code>s <code>.spec.provider.workers[].updateStrategy</code> field (it will default to <code>AutoRollingUpdate</code>) or explicitly set the field to <code>AutoRollingUpdate</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: cpu-worker
</span></span><span style=display:flex><span>      maxSurge: 0
</span></span><span style=display:flex><span>      maxUnavailable: 2
</span></span><span style=display:flex><span>      updateStrategy: AutoRollingUpdate
</span></span></code></pre></div><h4 id=customize-rolling-update-behaviour-of-shoot-worker-nodes>Customize Rolling Update Behaviour of Shoot Worker Nodes<a class=td-heading-self-link href=#customize-rolling-update-behaviour-of-shoot-worker-nodes aria-label="Heading self-link"></a></h4><p>The <code>.spec.provider.workers[]</code> list exposes two fields that you might configure based on your workload&rsquo;s needs: <code>maxSurge</code> and <code>maxUnavailable</code>.
The same concepts <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#rolling-update-deployment>like in Kubernetes</a> apply.
Additionally, you might customize how the <code>machine-controller-manager</code> is behaving. You can configure the following fields in <code>.spec.provider.worker[].machineControllerManager</code>:</p><ul><li><code>machineDrainTimeout</code>: Timeout (in duration) used while draining of machine before deletion, beyond which <code>machine-controller-manager</code> forcefully deletes the machine (default: <code>2h</code>).</li><li><code>machineHealthTimeout</code>: Timeout (in duration) used while re-joining (in case of temporary health issues) of a machine before it is declared as failed (default: <code>10m</code>).</li><li><code>machineCreationTimeout</code>: Timeout (in duration) used while joining (during creation) of a machine before it is declared as failed (default: <code>10m</code>).</li><li><code>maxEvictRetries</code>: Maximum number of times evicts would be attempted on a pod before it is forcibly deleted during the draining of a machine (default: <code>10</code>).</li><li><code>nodeConditions</code>: List of case-sensitive node-conditions which will change a machine to a <code>Failed</code> state after the <code>machineHealthTimeout</code> duration. It may further be replaced with a new machine if the machine is backed by a machine-set object (defaults: <code>KernelDeadlock</code>, <code>ReadonlyFilesystem</code> , <code>DiskPressure</code>).</li></ul><h4 id=rolling-update-triggers>Rolling Update Triggers<a class=td-heading-self-link href=#rolling-update-triggers aria-label="Heading self-link"></a></h4><p>A rolling update of the shoot worker nodes is triggered for some changes to your worker pool specification (<code>.spec.provider.workers[]</code>, even if you don&rsquo;t change the Kubernetes or machine image version).
The complete list of fields that trigger a rolling update:</p><ul><li><code>.spec.kubernetes.version</code> (except for patch version changes)</li><li><code>.spec.provider.workers[].machine.image.name</code></li><li><code>.spec.provider.workers[].machine.image.version</code></li><li><code>.spec.provider.workers[].machine.type</code></li><li><code>.spec.provider.workers[].volume.type</code></li><li><code>.spec.provider.workers[].volume.size</code></li><li><code>.spec.provider.workers[].providerConfig</code> (provider extension dependent with feature gate <code>NewWorkerPoolHash</code>)</li><li><code>.spec.provider.workers[].cri.name</code></li><li><code>.spec.provider.workers[].kubernetes.version</code> (except for patch version changes)</li><li><code>.spec.systemComponents.nodeLocalDNS.enabled</code></li><li><code>.status.credentials.rotation.certificateAuthorities.lastInitiationTime</code> (changed by Gardener when a shoot CA rotation is initiated) when worker pool is not part of <code>.status.credentials.rotation.certificateAuthorities.pendingWorkersRollouts[]</code></li><li><code>.status.credentials.rotation.serviceAccountKey.lastInitiationTime</code> (changed by Gardener when a shoot service account signing key rotation is initiated) when worker pool is not part of <code>.status.credentials.rotation.serviceAccountKey.pendingWorkersRollouts[]</code></li></ul><p>If feature gate <code>NewWorkerPoolHash</code> is enabled:</p><ul><li><code>.spec.kubernetes.kubelet.kubeReserved</code> (unless a worker pool-specific value is set)</li><li><code>.spec.kubernetes.kubelet.systemReserved</code> (unless a worker pool-specific value is set)</li><li><code>.spec.kubernetes.kubelet.evictionHard</code> (unless a worker pool-specific value is set)</li><li><code>.spec.kubernetes.kubelet.cpuManagerPolicy</code> (unless a worker pool-specific value is set)</li><li><code>.spec.provider.workers[].kubernetes.kubelet.kubeReserved</code></li><li><code>.spec.provider.workers[].kubernetes.kubelet.systemReserved</code></li><li><code>.spec.provider.workers[].kubernetes.kubelet.evictionHard</code></li><li><code>.spec.provider.workers[].kubernetes.kubelet.cpuManagerPolicy</code></li></ul><p>Changes to <code>kubeReserved</code> or <code>systemReserved</code> do not trigger a node roll if their sum does not change.</p><p>Generally, the provider extension controllers might have additional constraints for changes leading to rolling updates, so please consult the respective documentation as well.
In particular, if the feature gate <code>NewWorkerPoolHash</code> is enabled and a worker pool uses the new hash, then the <code>providerConfig</code> as a whole is not included. Instead only fields selected by the provider extension are considered.</p><h3 id=in-place-updates>In-Place Updates<a class=td-heading-self-link href=#in-place-updates aria-label="Heading self-link"></a></h3><p>For scenarios where users want to retain the current nodes and avoid deletion during updates, Gardener provides the option of <code>in-place</code> updates. The upgrade is performed without replacing the underlying machines. Although there is an exception where new nodes are created with the updated configuration and old ones are terminated. One such exception is discussed in <a href=/docs/gardener/shoot-operations/shoot_updates/#automatic-in-place-updates>Automatic inplace update</a> section.</p><p>The existing workload is gracefully drained and evicted from the worker nodes, respecting the configured <code>PodDisruptionBudget</code>s (see <a href=https://kubernetes.io/docs/tasks/run-application/configure-pdb/>Specifying a Disruption Budget for your Application</a>).</p><blockquote><p>ℹ️ Currently, <code>in-place</code> updates are controlled by the <code>InPlaceNodeUpdates</code> feature gate in the <code>gardener-apiserver</code>.</p></blockquote><p>For in-place updates, the first requirement is that the operating system must support them. For a specific machine image version, the configuration for in-place updates must be defined in the <code>CloudProfile</code> under <code>spec.machineImages[].versions[].inPlaceUpdates</code>:</p><ul><li>The <code>inPlaceUpdates.supported</code> field must be set to <code>true</code>.</li><li>The <code>inPlaceUpdates.minVersionForUpdate</code> field specifies the minimum version from which an in-place update to the target machine image version can be performed.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>machineImages:
</span></span><span style=display:flex><span>- name: gardenlinux
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>  - version: 1632.0.0
</span></span><span style=display:flex><span>    inPlaceUpdates:
</span></span><span style=display:flex><span>      supported: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      minVersionForUpdate: 1630.0.0
</span></span></code></pre></div><p>The <code>inPlaceUpdates</code> field in the Shoot status provides details about in-place updates for the Shoot workers. It includes the <code>pendingWorkerUpdates</code> field, which lists the worker pools that are awaiting in-place updates.</p><h4 id=customize-in-place-update-behaviour-of-shoot-worker-nodes>Customize In-Place Update Behaviour of Shoot Worker Nodes<a class=td-heading-self-link href=#customize-in-place-update-behaviour-of-shoot-worker-nodes aria-label="Heading self-link"></a></h4><p>In addition to customisable fields mentioned in <a href=/docs/gardener/shoot-operations/shoot_updates/#customize-rolling-update-behaviour-of-shoot-worker-nodes></a>section, you can configure the following fields in <code>.spec.provider.worker[].machineControllerManager</code>:</p><ul><li><code>MachineInPlaceUpdateTimeout</code>: Timeout (in duration) after which an in-place update is declared as failed.</li><li><code>DisableHealthTimeout</code>: A boolean value that, when set to <code>true</code>, ignores the health timeout. As a result, machines are never marked as failed, and unhealthy machines are not deleted. The default value is <code>true</code> for in-place updates.</li></ul><h4 id=in-place-update-triggers>In-Place Update Triggers<a class=td-heading-self-link href=#in-place-update-triggers aria-label="Heading self-link"></a></h4><p>An in-place update of the shoot worker nodes is triggered for rolling update triggers listed under <a href=/docs/gardener/shoot-operations/shoot_updates/#rolling-update-triggers>Rolling Update Triggers</a> except for the following:</p><ul><li><code>.spec.provider.workers[].machine.image.name</code></li><li><code>.spec.provider.workers[].machine.type</code></li><li><code>.spec.provider.workers[].volume.type</code></li><li><code>.spec.provider.workers[].volume.size</code></li><li><code>.spec.provider.workers[].cri.name</code></li><li><code>.spec.systemComponents.nodeLocalDNS.enabled</code></li></ul><blockquote><p>There are validations which restricts changing the above mentioned exception fields when <code>in-place</code> updates strategy is configured.</p></blockquote><p>When a worker pool is undergoing an in-place update, applying subsequent updates to the same worker pool is restricted.
If an in-place update fails and nodes are left in a problematic state, user intervention is required to manually fix the nodes. In cases where a subsequent update is necessary to resolve the issue, users can update the worker pool after adding the force update annotation <code>gardener.cloud/operation=force-in-place-update</code> on the Shoot. Refer to <a href=/docs/gardener/shoot-operations/shoot_operations/#force-update-a-worker-pool-with-inplace-update-strategy>Force-update a worker pool with InPlace update strategy</a> for more details.</p><blockquote><p>⚠️ Changing the update strategy from <code>AutoRollingUpdate</code> to <code>AutoInPlaceUpdate</code>/<code>ManualInPlaceUpdate</code> (and vice versa) is not allowed. However, switching between <code>AutoInPlaceUpdate</code> and <code>ManualInPlaceUpdate</code> is permitted.</p></blockquote><h4 id=automatic-in-place-updates>Automatic In-Place Updates<a class=td-heading-self-link href=#automatic-in-place-updates aria-label="Heading self-link"></a></h4><p>In case of AutoInPlaceUpdate update strategy, the update process is fully orchestrated by Gardener and the <code>machine-controller-manager</code>. No user intervention is required.
Set <code>.spec.provider.workers[].updateStrategy</code> field in the <code>Shoot</code> spec to <code>AutoInPlaceUpdate</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: cpu-worker
</span></span><span style=display:flex><span>      maxSurge: 0
</span></span><span style=display:flex><span>      maxUnavailable: 2
</span></span><span style=display:flex><span>      updateStrategy: AutoInPlaceUpdate
</span></span></code></pre></div><p>During automatic in-place updates, if the <code>maxSurge</code> value is set to greater than 0, the <code>machine-controller-manager</code> creates new nodes equal to the <code>maxSurge</code> value. All old nodes, except for those equal to the <code>maxSurge</code> value, are updated in place, and the old nodes corresponding to the <code>maxSurge</code> value are terminated. If <code>maxSurge</code> is set to <code>0</code>, no new nodes are created and all old nodes are updated in-place.</p><p>The <code>inPlaceUpdates.pendingWorkerUpdates.autoInPlaceUpdate</code> field in the Shoot status lists the names of worker pools that are pending updates with this strategy.</p><h4 id=manual-in-place-updates>Manual In-Place Updates<a class=td-heading-self-link href=#manual-in-place-updates aria-label="Heading self-link"></a></h4><p>The <code>ManualInPlaceUpdate</code> strategy allows users to control and orchestrate the update process manually.
Set <code>.spec.provider.workers[].updateStrategy</code> field in the <code>Shoot</code> spec to <code>ManualInPlaceUpdate</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: cpu-worker
</span></span><span style=display:flex><span>      maxSurge: 0
</span></span><span style=display:flex><span>      maxUnavailable: 2
</span></span><span style=display:flex><span>      updateStrategy: ManualInPlaceUpdate
</span></span></code></pre></div><p>Once <code>machine-controller-manager</code> labels nodes with <code>node.machine.sapcloud.io/candidate-for-update</code>, user can select the candidate nodes for update by labeling them with <code>node.machine.sapcloud.io/selected-for-update=true</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl label node &lt;node-name&gt; node.machine.sapcloud.io/selected-for-update=true
</span></span></code></pre></div><p>The <code>ManualInPlaceWorkersUpdated</code> <a href=/docs/gardener/shoot/shoot_status/#constraints>constraint</a> in the shoot status indicates that at least one worker pool with the <code>ManualInPlaceUpdate</code> strategy is pending an update. Shoot reconciliation will still succeed even if there are worker pools pending updates.</p><p>The <code>inPlaceUpdates.pendingWorkerUpdates.manualInPlaceUpdate</code> field in the <code>Shoot</code> status lists the names of worker pools that are pending updates with this strategy.</p><h2 id=related-documentation>Related Documentation<a class=td-heading-self-link href=#related-documentation aria-label="Heading self-link"></a></h2><ul><li><a href=/docs/gardener/shoot-operations/shoot_operations/>Shoot Operations</a></li><li><a href=/docs/gardener/shoot/shoot_maintenance/>Shoot Maintenance</a></li><li><a href=/docs/gardener/shoot/shoot_maintenance/#confine-specification-changesupdates-roll-out>Confine Specification Changes/Updates Roll Out To Maintenance Time Window</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-71305631a104bab9879b99ea6c91252b>6 - Supported Kubernetes Versions</h1><h1 id=supported-kubernetes-versions>Supported Kubernetes Versions<a class=td-heading-self-link href=#supported-kubernetes-versions aria-label="Heading self-link"></a></h1><p>Currently, Gardener supports the following Kubernetes versions:</p><h2 id=garden-clusters>Garden Clusters<a class=td-heading-self-link href=#garden-clusters aria-label="Heading self-link"></a></h2><p>The minimum version of a garden cluster that can be used to run Gardener is <strong><code>1.27.x</code></strong>.</p><h2 id=seed-clusters>Seed Clusters<a class=td-heading-self-link href=#seed-clusters aria-label="Heading self-link"></a></h2><p>The minimum version of a seed cluster that can be connected to Gardener is <strong><code>1.27.x</code></strong>.</p><h2 id=shoot-clusters>Shoot Clusters<a class=td-heading-self-link href=#shoot-clusters aria-label="Heading self-link"></a></h2><p>Gardener itself is capable of spinning up clusters with Kubernetes versions <strong><code>1.27</code></strong> up to <strong><code>1.33</code></strong>.
However, the concrete versions that can be used for shoot clusters depend on the installed provider extension.
Consequently, please consult the documentation of your provider extension to see which Kubernetes versions are supported for shoot clusters.</p><blockquote><p>👨🏼‍💻 Developers note: The <a href=/docs/gardener/new-kubernetes-version/>Adding Support For a New Kubernetes Version</a> topic explains what needs to be done in order to add support for a new Kubernetes version.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-24d037aa1e9f3f26c4af034fc7f8280a>7 - Trigger Shoot Operations Through Annotations</h1><h1 id=trigger-shoot-operations-through-annotations>Trigger Shoot Operations Through Annotations<a class=td-heading-self-link href=#trigger-shoot-operations-through-annotations aria-label="Heading self-link"></a></h1><p>You can trigger a few explicit operations by annotating the <code>Shoot</code> with an operation annotation.
This might allow you to induct certain behavior without the need to change the <code>Shoot</code> specification.
Some of the operations can also not be caused by changing something in the shoot specification because they can&rsquo;t properly be reflected here.
Note that once the triggered operation is considered by the controllers, the annotation will be automatically removed and you have to add it each time you want to trigger the operation.</p><p>Please note: If <code>.spec.maintenance.confineSpecUpdateRollout=true</code>, then the only way to trigger a shoot reconciliation is by setting the <code>reconcile</code> operation, see below.</p><h2 id=immediate-reconciliation>Immediate Reconciliation<a class=td-heading-self-link href=#immediate-reconciliation aria-label="Heading self-link"></a></h2><p>Annotate the shoot with <code>gardener.cloud/operation=reconcile</code> to make the <code>gardenlet</code> start a reconciliation operation without changing the shoot spec and possibly without being in its maintenance time window:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n garden-&lt;project-name&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=reconcile
</span></span></code></pre></div><h2 id=immediate-maintenance>Immediate Maintenance<a class=td-heading-self-link href=#immediate-maintenance aria-label="Heading self-link"></a></h2><p>Annotate the shoot with <code>gardener.cloud/operation=maintain</code> to make the <code>gardener-controller-manager</code> start maintaining your shoot immediately (possibly without being in its maintenance time window).
If no reconciliation starts, then nothing needs to be maintained:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n garden-&lt;project-name&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=maintain
</span></span></code></pre></div><h2 id=retry-failed-reconciliation>Retry Failed Reconciliation<a class=td-heading-self-link href=#retry-failed-reconciliation aria-label="Heading self-link"></a></h2><p>Annotate the shoot with <code>gardener.cloud/operation=retry</code> to make the <code>gardenlet</code> start a new reconciliation loop on a failed shoot.
Failed shoots are only reconciled again if a new Gardener version is deployed, the shoot specification is changed or this annotation is set:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n garden-&lt;project-name&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=retry
</span></span></code></pre></div><h2 id=force-update-a-worker-pool-with-inplace-update-strategy>Force-update a worker pool with InPlace update strategy<a class=td-heading-self-link href=#force-update-a-worker-pool-with-inplace-update-strategy aria-label="Heading self-link"></a></h2><p>Annotate the shoot with <code>gardener.cloud/operation=force-in-place-update</code> to force an update for worker pools using the update strategy <code>AutoInPlaceUpdate</code> or <code>ManualInPlaceUpdate</code>. Without this annotation, any subsequent updates to the same worker pool are denied until the <code>Shoot</code> has been successfully reconciled following the current in-place update.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n garden-&lt;project-name&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=force-in-place-update
</span></span></code></pre></div><h2 id=credentials-rotation-operations>Credentials Rotation Operations<a class=td-heading-self-link href=#credentials-rotation-operations aria-label="Heading self-link"></a></h2><p>Please consult <a href=/docs/gardener/shoot-operations/shoot_credentials_rotation/>Credentials Rotation for Shoot Clusters</a> for more information.</p><h2 id=restart-systemd-services-on-particular-worker-nodes>Restart <code>systemd</code> Services on Particular Worker Nodes<a class=td-heading-self-link href=#restart-systemd-services-on-particular-worker-nodes aria-label="Heading self-link"></a></h2><p>It is possible to make Gardener restart particular systemd services on your shoot worker nodes if needed.
The annotation is not set on the <code>Shoot</code> resource but directly on the <code>Node</code> object you want to target.
For example, the following will restart both the <code>kubelet</code> and the <code>containerd</code> services:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl annotate node &lt;node-name&gt; worker.gardener.cloud/restart-systemd-services=kubelet,containerd
</span></span></code></pre></div><p>It may take up to a minute until the service is restarted.
The annotation will be removed from the <code>Node</code> object after all specified systemd services have been restarted.
It will also be removed even if the restart of one or more services failed.</p><blockquote><p>ℹ️ In the example mentioned above, you could additionally verify when/whether the kubelet restarted by using <code>kubectl describe node &lt;node-name></code> and looking for such a <code>Starting kubelet</code> event.</p></blockquote><h2 id=force-deletion>Force Deletion<a class=td-heading-self-link href=#force-deletion aria-label="Heading self-link"></a></h2><p>When a Shoot fails to be deleted normally, users can force-delete the Shoot if it meets the following conditions:</p><ul><li>Shoot has a deletion timestamp.</li><li>Shoot status contains at least one of the following <a href=/docs/gardener/shoot/shoot_status/#error-codes>ErrorCodes</a>:<ul><li><code>ERR_CLEANUP_CLUSTER_RESOURCES</code></li><li><code>ERR_CONFIGURATION_PROBLEM</code></li><li><code>ERR_INFRA_DEPENDENCIES</code></li><li><code>ERR_INFRA_UNAUTHENTICATED</code></li><li><code>ERR_INFRA_UNAUTHORIZED</code></li></ul></li></ul><p>If the above conditions are satisfied, you can annotate the Shoot with <code>confirmation.gardener.cloud/force-deletion=true</code>, and Gardener will cleanup the Shoot controlplane and the Shoot metadata.</p><blockquote><p>&#9888;&#xfe0f; You <strong>MUST</strong> ensure that all the resources created in the IaaS account are cleaned up to prevent orphaned resources. Gardener will <strong>NOT</strong> delete any resources in the underlying infrastructure account. Hence, use this annotation at your own risk and only if you are fully aware of these consequences.</p></blockquote></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://demo.gardener.cloud>Demo</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://gardener-cloud.slack.com/><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://x.com/GardenerProject><img src=/images/branding/x-logo-white.svg class=media-icon><div class=media-text>X</div></a></li></ul><span class=copyright>Copyright 2019-2025 Gardener project authors<div style=margin-top:2%><a href=https://www.sap.com/about/legal/terms-of-use.html>Terms of Use
<i class="fa fa-external-link" aria-hidden=true></i>
</a>|
<a href=https://www.sap.com/about/legal/privacy.html>Privacy Statement
<i class="fa fa-external-link" aria-hidden=true></i>
</a>|
<a href=https://www.sap.com/about/legal/impressum.html>Legal Disclosure
<i class="fa fa-external-link" aria-hidden=true></i></a></div></span></div></footer></div><script src=/js/main.min.403ff095218c662472dab60ed98ecbb19431682de5ac7c6159891241cd366af5.js integrity="sha256-QD/wlSGMZiRy2rYO2Y7LsZQxaC3lrHxhWYkSQc02avU=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script><script src=/js/navbar.js></script><script src=/js/filtering.js></script><script src=/js/page-content.js></script><script src=/js/community-index.js></script></body></html>