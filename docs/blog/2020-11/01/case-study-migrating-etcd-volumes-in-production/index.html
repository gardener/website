<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=icon type=image/x-icon href=https://gardener.cloud/images/favicon.ico><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-16x16.png sizes=16x16><title>Case Study: Migrating ETCD Volumes in Production | Gardener</title><meta name=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:title" content="Case Study: Migrating ETCD Volumes in Production"><meta property="og:description" content="In this case study, our friends from metal-stack lead you through their journey of migrating Gardener ETCD volumes in their production environment."><meta property="og:type" content="article"><meta property="og:url" content="https://gardener.cloud/blog/2020-11/01/case-study-migrating-etcd-volumes-in-production/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-11-20T00:00:00+00:00"><meta property="article:modified_time" content="2020-11-20T00:00:00+00:00"><meta itemprop=name content="Case Study: Migrating ETCD Volumes in Production"><meta itemprop=description content="In this case study, our friends from metal-stack lead you through their journey of migrating Gardener ETCD volumes in their production environment."><meta itemprop=datePublished content="2020-11-20T00:00:00+00:00"><meta itemprop=dateModified content="2020-11-20T00:00:00+00:00"><meta itemprop=wordCount content="1965"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Case Study: Migrating ETCD Volumes in Production"><meta name=twitter:description content="In this case study, our friends from metal-stack lead you through their journey of migrating Gardener ETCD volumes in their production environment."><link rel=preload href=/scss/main.min.ca2e9ddee7809848b536632b41e4e4df665800778ffe11b75edde5bdd6c78963.css as=style><link href=/scss/main.min.ca2e9ddee7809848b536632b41e4e4df665800778ffe11b75edde5bdd6c78963.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.2035d9813dafac83fe2a48b18d50f237.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.2035d9813dafac83fe2a48b18d50f237.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>Blogs</span></a><ul class="pr-md-3 ul-1"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2021-0101happy-anniversary-gardener-li><a href=/blog/2021-01/01/happy-anniversary-gardener/ title="Happy anniversary Gardener! Three years of open source Kubernetes management" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2021-0101happy-anniversary-gardener><span>Happy anniversary Gardener!</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2021-0100machine-controller-manager-li><a href=/blog/2021-01/00/machine-controller-manager/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2021-0100machine-controller-manager><span>Machine Controller Manager</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2020-1200stackit-kubernetes-engine-with-gardener-li><a href=/blog/2020-12/00/stackit-kubernetes-engine-with-gardener/ title="STACKIT Kubernetes Engine with Gardener" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2020-1200stackit-kubernetes-engine-with-gardener><span>STACKIT SKE with Gardener</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2020-1102gardener-v113-released-li><a href=/blog/2020-11/02/gardener-v1.13-released/ title="Gardener v1.13 Released" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2020-1102gardener-v113-released><span>Gardener v1.13</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog2020-1101case-study-migrating-etcd-volumes-in-production-li><a href=/blog/2020-11/01/case-study-migrating-etcd-volumes-in-production/ title="Case Study: Migrating ETCD Volumes in Production" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__page" id=m-blog2020-1101case-study-migrating-etcd-volumes-in-production><span class=td-sidebar-nav-active-item>Gardener ETCD Volumes Migration</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2020-1100gardener-v111-and-v112-released-li><a href=/blog/2020-11/00/gardener-v1.11-and-v1.12-released/ title="Gardener v1.11 and v1.12 Released" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2020-1100gardener-v111-and-v112-released><span>Gardener v1.11 and v1.12</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2020-1000gardener-integrates-with-kubevirt-li><a href=/blog/2020-10/00/gardener-integrates-with-kubevirt/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2020-1000gardener-integrates-with-kubevirt><span>Gardener Integrates with KubeVirt</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2020-1001shoot-reconciliation-details-li><a href=/blog/2020-10/01/shoot-reconciliation-details/ title="Shoot Reconciliation Details" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2020-1001shoot-reconciliation-details><span>Shoot Reconciliation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2020-09gardener-v19-and-v110-released-li><a href=/blog/2020-09/gardener-v1.9-and-v1.10-released/ title="Gardener v1.9 and v1.10 Released" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2020-09gardener-v19-and-v110-released><span>Gardener v1.9 and v1.10</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2020-0800gardener-v180-released-li><a href=/blog/2020-08/00/gardener-v1.8.0-released/ title="Gardener v1.8.0 Released" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2020-0800gardener-v180-released><span>Gardener v1.8.0</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2020-0500pingcaps-experience-li><a href=/blog/2020-05/00/pingcaps-experience/ title="PingCAP’s Experience in Implementing their Managed TiDB Service with Gardener" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2020-0500pingcaps-experience><span>PingCAP's TiDB Cloud</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2020_week_20new-website-same-green-flower-li><a href=/blog/2020_week_20/new-website-same-green-flower/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2020_week_20new-website-same-green-flower><span>New Website, Same Green Flower</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2019_week_21cluster-overprovisioning-li><a href=/blog/2019_week_21/cluster-overprovisioning/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2019_week_21cluster-overprovisioning><span>Cluster Overprovisioning</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2019_week_21feature-flags-in-kubernetes-applications-li><a href=/blog/2019_week_21/feature-flags-in-kubernetes-applications/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2019_week_21feature-flags-in-kubernetes-applications><span>Feature Flags in Kubernetes Applications</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2019_week_06manually-adding-a-node-to-an-existing-cluster-li><a href=/blog/2019_week_06/manually-adding-a-node-to-an-existing-cluster/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2019_week_06manually-adding-a-node-to-an-existing-cluster><span>Manually adding a node to an existing cluster</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2019_week_02organizing-access-using-kubeconfig-files-li><a href=/blog/2019_week_02/organizing-access-using-kubeconfig-files/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2019_week_02organizing-access-using-kubeconfig-files><span>Organizing Access Using kubeconfig Files</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2018_week_52gardener_cookies-li><a href=/blog/2018_week_52/gardener_cookies/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2018_week_52gardener_cookies><span>Gardener Cookies</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2018_week_40hibernate-a-cluster-to-save-money-li><a href=/blog/2018_week_40/hibernate-a-cluster-to-save-money/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2018_week_40hibernate-a-cluster-to-save-money><span>Hibernate a Cluster to save money</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2018_week_22anti-patterns-li><a href=/blog/2018_week_22/anti-patterns/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2018_week_22anti-patterns><span>Anti Patterns</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2018_week_46auditing-kubernetes-for-secure-setup-li><a href=/blog/2018_week_46/auditing-kubernetes-for-secure-setup/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2018_week_46auditing-kubernetes-for-secure-setup><span>Auditing Kubernetes for Secure Setup</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2018_week_07big-things-come-in-small-packages-li><a href=/blog/2018_week_07/big-things-come-in-small-packages/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2018_week_07big-things-come-in-small-packages><span>Big things come in small packages</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2018_week_51cookies-are-dangerous-li><a href=/blog/2018_week_51/cookies-are-dangerous/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2018_week_51cookies-are-dangerous><span>Cookies are dangerous...</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2018_week_17frontend-https-li><a href=/blog/2018_week_17/frontend-https/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2018_week_17frontend-https><span>Frontend HTTPS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2018_week_50hardening-the-gardener-community-setup-li><a href=/blog/2018_week_50/hardening-the-gardener-community-setup/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2018_week_50hardening-the-gardener-community-setup><span>Hardening the Gardener Community Setup</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2018_week_06kubernetes-is-available-in-docker-for-mac-17-12-ce-li><a href=/blog/2018_week_06/kubernetes-is-available-in-docker-for-mac-17-12-ce/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2018_week_06kubernetes-is-available-in-docker-for-mac-17-12-ce><span>Kubernetes is available in Docker for Mac 17.12 CE</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2018_week_09namespace-isolation-li><a href=/blog/2018_week_09/namespace-isolation/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2018_week_09namespace-isolation><span>Namespace Isolation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2018_week_08namespace-scope-li><a href=/blog/2018_week_08/namespace-scope/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2018_week_08namespace-scope><span>Namespace Scope</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2018_week_27readwritemany-dynamically-provisioned-persistent-volumes-using-amazon-efs-li><a href=/blog/2018_week_27/readwritemany-dynamically-provisioned-persistent-volumes-using-amazon-efs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2018_week_27readwritemany-dynamically-provisioned-persistent-volumes-using-amazon-efs><span>ReadWriteMany - Dynamically Provisioned Persistent Volumes Using Amazon EFS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2018_week_10shared-storage-with-s3-backend-li><a href=/blog/2018_week_10/shared-storage-with-s3-backend/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2018_week_10shared-storage-with-s3-backend><span>Shared storage with S3 backend</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2018_week_08watching-logs-of-several-pods-li><a href=/blog/2018_week_08/watching-logs-of-several-pods/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-blog2018_week_08watching-logs-of-several-pods><span>Watching logs of several pods</span></a></li></ul></li></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><div class=git-wr><div class=page-contributors>Contributors to this page<div class=contributors-list><a href=mailto:k.zhelyazkov@sap.com><img class=user-icon src="https://avatars.githubusercontent.com/u/58623197?v=4" title=Zhelyazkov><a href=mailto:nikolay.boshnakov@sap.com><img class=user-icon src="https://avatars.githubusercontent.com/u/25197046?v=4" title="Nikolay Boshnakov"><a href=mailto:n_boshnakov@abv.bg><img class=user-icon src="https://avatars.githubusercontent.com/u/25197046?v=4" title="Nikolay Boshnakov"></div></div></div><a href=https://github.com/gardener/documentation/edit/master/website/blog/2020-11/01/Case-Study-Migrating-ETCD-Volumes-in-Production.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/gardener/documentation/issues/new?title=Case%20Study:%20Migrating%20ETCD%20Volumes%20in%20Production" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/gardener/website-generator/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
<a id=print href=https://gardener.cloud/blog/_print/><i class="fa fa-print fa-fw"></i> Print entire section</a></div><p>Page Content</p><nav id=TableOfContents><ul><li><a href=#how-gardener-manages-etcds>How Gardener Manages ETCDs</a></li><li><a href=#the-mistake-is-in-the-deployment>The Mistake Is in the Deployment</a></li><li><a href=#the-migration>The Migration</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href=https://gardener.cloud/blog/index.xml target=_blank>RSS <i class="fa fa-rss ml-2"></i></a><div class=td-content><h1>Case Study: Migrating ETCD Volumes in Production</h1><div class=lead>In this case study, our friends from metal-stack lead you through their journey of migrating Gardener ETCD volumes in their production environment.</div><div class="td-byline mb-4"><time datetime=2020-11-20 class=text-muted>Friday, November 20, 2020</time></div><p class=reading-time><i class="fa fa-clock" aria-hidden=true></i> 10 minute read</p><blockquote><p>This is a guest commentary from <span style=white-space:nowrap><a href=https://metal-stack.io/>metal-stack</a></span>.<br><br>metal-stack is a software that provides an API for provisioning and managing physical servers in the data center. To categorize this product, the terms &ldquo;Metal-as-a-Service&rdquo; (MaaS) or &ldquo;bare metal cloud&rdquo; are commonly used.</p></blockquote><p>One reason you stumble upon this blog post could be that you saw errors like the following in your ETCD instances:</p><pre><code>etcd-main-0 etcd 2020-09-03 06:00:07.556157 W | etcdserver: read-only range request &quot;key:\&quot;/registry/deployments/shoot--pwhhcd--devcluster2/kube-apiserver\&quot; &quot; with result &quot;range_response_count:1 size:9566&quot; took too long (13.95374909s) to execute
</code></pre><p>As it turns out, 14 seconds are way too slow for running Kubernetes API servers. It makes them go into the crash loop (leader election fails). Even worse, this whole thing is self-amplifying: The longer a response takes, the more requests queue up, leading to response times increasing further and further. The system is very unlikely to recover. 😞</p><p>On Github, you can easily find the reason for this problem. Most probably your disks are too slow (see <a href=https://github.com/etcd-io/etcd/issues/10860>etcd-io/etcd#10860</a>). So, when you are (like in our case) on GKE and run your ETCD on their default persistent volumes, consider moving from standard disks to SSDs and the error messages should disappear. A guide on how to use SSD volumes on GKE can be found <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/ssd-pd>here</a>.</p><p>Case closed? Well. For some people it might. But when you are seeing this in your Gardener infrastructure, likely, there is something going wrong. The entire ETCD management is fully managed by the Gardener, which makes the problem a bit more interesting to look at. This blog post strives topics such as:</p><ul><li>Gardener operating principles</li><li>Gardener architecture and ETCD management</li><li>Pitfalls with multi-cloud environments</li><li>Migrating GCP volumes to a new storage class</li></ul><p>We from metal-stack learned quite a lot about the capabilities of Gardener through this problem. We are happy to share this experience with a broader audience. Gardener adopters and operators read on.</p><h2 id=how-gardener-manages-etcds>How Gardener Manages ETCDs</h2><p>In our infrastructure, we use the Gardener to provision Kubernetes clusters on bare metal machines in our own data centers using <span style=white-space:nowrap><a href=https://metal-stack.io/>metal-stack</a></span>. Even if the entire stack could be running on-premise, our initial <a href=/docs/gardener/concepts/apiserver/#seeds>seed cluster</a> and the <a href=https://docs.metal-stack.io/stable/overview/architecture/#Metal-Control-Plane>metal control plane</a> are hosted on GKE. This way, we do not need to manage a single Kubernetes cluster in our entire landscape manually. As soon as we have Gardener deployed on this initial cluster, we can spin up further Seeds in our own data centers through the concept of <a href=/docs/gardener/usage/shooted_seed/>shooted seeds</a>.</p><p>To make this easier to understand, let us give you a simplified picture of how our Gardener production setup looks like:</p><img title="Production Setup" src=/__resources/01-001_8fcb39.svg style=width:80vw;height:auto><figcaption style=text-align:center;margin-top:-25px;margin-bottom:30px;font-size:90%>Figure 1: Simplified View on Our Production Setup</figcaption><p>For every <a href=/docs/gardener/concepts/apiserver/#shoots>shoot cluster</a>, Gardener deploys an individual, standalone ETCD as a stateful set into a <em>shoot namespace</em>. The deployment of the ETCD stateful set is managed by a controller called <a href=https://github.com/gardener/etcd-druid>etcd-druid</a>, which reconciles a special resource of the kind <code>etcds.druid.gardener.cloud</code>. This <code>Etcd</code> resource is getting deployed during the shoot provisioning flow in the <a href=https://github.com/gardener/gardener/blob/v1.8.2/docs/concepts/gardenlet.md>Gardenlet</a>.</p><p>For failure-safety, the etcd-druid deploys the official ETCD container image along with a sidecar project called <a href=https://github.com/gardener/etcd-backup-restore>etcd-backup-restore</a>. The sidecar automatically takes backups of the ETCD and stores them at a cloud provider, e.g. in S3 Buckets, Google Buckets, or similar. In case the ETCD comes up without or with corrupted data, the sidecar looks into the backup buckets and automatically restores the latest backup before ETCD starts up. This entire approach basically takes away the pain for operators to manually have to restore data in the event of data loss.</p><blockquote><p>We found the etcd-backup-restore project very intriguing. It was the inspiration for us to come up with a similar sidecar for the databases we use with metal-stack. This project is called <a href=https://github.com/metal-stack/backup-restore-sidecar>backup-restore-sidecar</a>. We can cope with postgres and rethinkdb database at the moment and more to come. Feel free to check it out when you are interested.</p></blockquote><p>As it&rsquo;s the nature for multi-cloud applications to act upon a variety of cloud providers, with a single installation of Gardener, it is easily possible to spin up new Kubernetes clusters not only on GCP, but on other supported cloud platforms, too.</p><p>When the Gardenlet deploys a resource like the <code>Etcd</code> resource into a shoot namespace, a provider-specific extension-controller has the chance to manipulate it through a <a href=https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook>mutating webhook</a>. This way, a cloud provider can adjust the generic Gardener resource to fit his provider-specific needs. For every cloud that Gardener supports, there is such an extension-controller. For metal-stack, we also maintain one, it&rsquo;s called <a href=https://github.com/metal-stack/gardener-extension-provider-metal>gardener-extension-provider-metal</a>.</p><blockquote><p>A side note for cloud providers: Meanwhile, new cloud providers can be added <em>fully</em> out-of-tree, i.e. without touching any of the Gardener sources. This works through <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/>API extensions</a> and <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/>CRDs</a>. The Gardener handles generic resources and backpacks provider-specific configuration through raw extensions. When you are a cloud provider on your own, this is really encouraging because you can integrate with Gardener without any burdens. You can find documentation on how to integrate your cloud into the Gardener <a href=https://github.com/gardener/gardener/blob/v1.12.1/docs/development/new-cloud-provider.md>here</a> and <a href=/docs/gardener/extensions/overview/>here</a>.</p></blockquote><h2 id=the-mistake-is-in-the-deployment>The Mistake Is in the Deployment</h2><blockquote><p>This section contains code examples from Gardener v1.8.</p></blockquote><p>Now that we know how the ETCDs are managed by the Gardener, we can come back to the original problem from the beginning of this article. It turned out that the real problem was a misconfiguration in our deployment. The Gardener actually <em>does</em> use SSD-backed storage on GCP for ETCDs by default. During reconciliation, the <a href=https://github.com/gardener/gardener-extension-provider-gcp>gardener-extension-controller-gcp</a> deploys a storage class called <code>gardener.cloud-fast</code> that enables accessing SSDs on GCP.</p><p>But for some reason, in our cluster we did not find such a storage class. And even more interesting, we did not use the <code>gardener-extension-provider-gcp</code> for any shoot reconciliation, only for ETCD backup purposes. And that was the big mistake we made: We reconciled the shoot control plane completely with <code>gardener-extension-provider-metal</code> even though our initial <code>Seed</code> actually runs on GKE and specific parts of the shoot control plane should be reconciled by the GCP extension-controller instead!</p><p>This is how the initial <code>Seed</code> resource looked like:</p><pre><code>apiVersion: core.gardener.cloud/v1beta1
kind: Seed
metadata:
  name: initial-seed
spec:
  ...
  provider:
    region: gke
    type: metal
  ...
...
</code></pre><p>Surprisingly, this configuration was working pretty well for a long time. The initial seed properly produced the Kubernetes control planes of our shooted seeds that looked like this:</p><pre><code>$ kubectl get controlplanes.extensions.gardener.cloud
NAME                 TYPE    PURPOSE    STATUS      AGE
fra-equ01            metal              Succeeded   85d
fra-equ01-exposure   metal   exposure   Succeeded   85d
</code></pre><p>And this is another interesting observation: There are two <code>ControlPlane</code> resources. One regular resource and one with an <code>exposure</code> purpose. Gardener distinguishes between two types for this exact reason: Environments where the shoot control plane runs on a different cloud provider than the Kubernetes worker nodes. The regular <code>ControlPlane</code> resource gets reconciled by the provider configured in the <code>Shoot</code> resource, the <code>exposure</code> type <code>ControlPlane</code> by the provider configured in the <code>Seed</code> resource.</p><p>With the existing configuration the <code>gardener-extension-provider-gcp</code> does not kick in and hence, it neither deploys the <code>gardener.cloud-fast</code> storage class nor does it mutate the <code>Etcd</code> resource to point to it. And in the end, we are left with ETCD volumes using the default storage class (which is what we do for ETCD stateful sets in the metal-stack seeds, because our default storage class uses <a href=https://github.com/metal-stack/csi-lvm>csi-lvm</a> that writes into logical volumes on the SSD disks in our physical servers).</p><p>The correction we had to make was a one-liner: Setting the provider type of the initial <code>Seed</code> resource to <code>gcp</code>.</p><pre><code>$ kubectl get seed initial-seed -o yaml
apiVersion: core.gardener.cloud/v1beta1
kind: Seed
metadata:
  name: initial-seed
spec:
  ...
  provider:
    region: gke
    type: gcp # &lt;-- here
  ...
...
</code></pre><p>This change moved over the control plane exposure reconciliation to the <code>gardener-extension-provider-gcp</code>:</p><pre><code>$ kubectl get -n &lt;shoot-namespace&gt; controlplanes.extensions.gardener.cloud
NAME                 TYPE    PURPOSE    STATUS      AGE
fra-equ01            metal              Succeeded   85d
fra-equ01-exposure   gcp     exposure   Succeeded   85d
</code></pre><p>And boom, after some time of waiting for all sorts of magic reconciliations taking place in the background, the missing storage class suddenly appeared:</p><pre><code>$ kubectl get sc
NAME                  PROVISIONER            
gardener.cloud-fast   kubernetes.io/gce-pd
standard (default)    kubernetes.io/gce-pd
</code></pre><p>Also, the <code>Etcd</code> resource was now configured properly to point to the new storage class:</p><pre><code>$ kubectl get -n &lt;shoot-namespace&gt; etcd etcd-main -o yaml
apiVersion: druid.gardener.cloud/v1alpha1
kind: Etcd
metadata:
  ...
  name: etcd-main
spec:
  ...
  storageClass: gardener.cloud-fast # &lt;-- was pointing to default storage class before!
  volumeClaimTemplate: main-etcd
...
</code></pre><blockquote><p>Only the <code>etcd-main</code> storage class gets changed to <code>gardener.cloud-fast</code>. The <code>etcd-events</code> configuration will still point to standard disk storage because this ETCD is much less occupied as compared to the <code>etcd-main</code> stateful set.</p></blockquote><h2 id=the-migration>The Migration</h2><p>Now that the deployment was in place such that this mistake would not repeat in the future, we still had the ETCDs running on the default storage class. The reconciliation does not delete the existing persistent volumes (PVs) on its own.</p><p>To bring production back up quickly, we temporarily moved the ETCD pods to other nodes in the GKE cluster. These were nodes which were less occupied, such that the disk throughput was a little higher than before. But surely that was not a final solution.</p><p>For a proper solution we had to move the ETCD data out of the standard disk PV into a SSD-based PV.</p><p>Even though we had the etcd-backup-restore sidecar, we did not want to fully rely on the restore mechanism to do the migration. The backup should only be there for emergency situations when something goes wrong. Thus, we came up with another approach to introduce the SSD volume: GCP disk snapshots. This is how we did the migration:</p><ol><li>Scale down etcd-druid to zero in order to prevent it from disturbing your migration</li><li>Scale down the kube-apiservers deployment to zero, then wait for the ETCD stateful to take another clean snapshot</li><li>Scale down the ETCD stateful set to zero as well</li><li>(in order to prevent Gardener from trying to bring up the downscaled resources, we used small shell constructs like <code>while true; do kubectl scale deploy etcd-druid --replicas 0 -n garden; sleep 1; done</code>)</li><li>Take a drive snapshot in GCP from the volume that is referenced by the ETCD PVC</li><li>Create a new disk in GCP from the snapshot on a SSD disk</li><li>Delete the existing PVC and PV of the ETCD (oops, data is now gone!)</li><li>Manually deploy a PV into your Kubernetes cluster that references this new SSD disk</li><li>Manually deploy a PVC with the name of the original PVC and let it reference the PV that you have just created</li><li>Scale up the ETCD stateful set and check that ETCD is running properly</li><li>(if something went terribly wrong, you still have the backup from the etcd-backup-restore sidecar, delete the PVC and PV again and let the sidecar bring up ETCD instead)</li><li>Scale up the kube-apiserver deployment again</li><li>Scale up etcd-druid again</li><li>(stop your shell hacks ;D)</li></ol><p>This approach worked very well for us and we were able to fix our production deployment issue. And what happened: We have never seen any crashing kube-apiservers again. 🎉</p><h2 id=conclusion>Conclusion</h2><p>As bad as problems in production are, they are the best way for learning from your mistakes. For new users of the Gardener it can be pretty overwhelming to understand the rich configuration possibilities that the Gardener brings. However, once you get a hang of how the Gardener works, the application offers an exceptional versatility that makes it very much suitable for production use-cases like ours.</p><p>This example has shown how Gardener:</p><ul><li>Can handle arbitrary layers of infrastructure hosted by different cloud providers.</li><li>Allows provider-specific tweaks to gain ideal performance for every cloud you want to support.</li><li>Leverages Kubernetes core principles across the entire project architecture, making it vastly extensible and resilient.</li><li>Brings useful disaster recovery mechanisms to your infrastructure (e.g. with etcd-backup-restore).</li></ul><p>We hope that you could take away something new through this blog post. With this article we also want to thank the SAP Gardener team for helping us to integrate Gardener with metal-stack. It&rsquo;s been a great experience so far. 😄 😍</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2020-11/00/gardener-v1.11-and-v1.12-released/ aria-label="Previous - Gardener v1.11 and v1.12 Released" class="btn btn-primary"><span class=mr-1>←</span> Previous</a></li><a href=/blog/2020-11/02/gardener-v1.13-released/ aria-label="Next - Gardener v1.13 Released" class="btn btn-primary">Next <span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2022 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity=sha384-uQikAXnCAqsMb3ygtdqBYvcwvHUkzGIpjdGyy9owhURXHUxLC5LgTcSxJQH/RzjK crossorigin=anonymous></script><script src=/js/main.min.ef8e0714aff556fd5a9768ed6ecabd2964dd962cd9f89762a373947bb53bc742.js integrity="sha256-744HFK/1Vv1al2jtbsq9KWTdlizZ+Jdio3OUe7U7x0I=" crossorigin=anonymous></script></body></html>