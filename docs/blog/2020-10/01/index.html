<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta name=copyright content="Copyright 2019 Gardener project authors."><meta name=google-site-verification content="9EoGiMwk2aq0E_tVh16iJgJbp7fbyqkfWH9b5sGybl0"><title>Shoot Reconciliation Details :: Gardener</title><link rel=icon type=image/x-icon href=https://gardener.cloud/images/favicon.ico><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-16x16.png sizes=16x16><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-W2FGNSX');</script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-165447164-1');</script><link href=/css/nucleus.css?1610967076 rel=stylesheet><link href=/css/font-awesome.min.css?1610967076 rel=stylesheet><link href=/css/hybrid.css?1610967076 rel=stylesheet><link href=/css/featherlight.min.css?1610967076 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1610967076 rel=stylesheet><link href=/css/auto-complete.css?1610967076 rel=stylesheet><link href=/css/skeleton.css?1610967076 rel=stylesheet><link href=/css/sheetslider.css?1610967076 rel=stylesheet><link rel=stylesheet href=/css/gardener.e2ca9959244349715932e2bbb82ec914af6743c4148bb41946b0aea714f04a0d.css><script src=/js/moment.js?1610967076></script><script src=/js/vivus.js?1610967076></script><script src=/js/scrollreveal.js?1610967076></script><script src=/js/inlineSVG.js?1610967076></script><script src=/js/jquery.min.js?1610967076></script><script src=/js/fixed.js?1610967076></script><script src=/js/clipboard.min.js?1610967076></script><script src=https://platform.linkedin.com/in.js type=text/javascript>lang:en_US</script></head><body data-url=/blog/2020-10/01/ class=has-sticky-navigation><script>$(document).ready(function(){function initStickyNav(){var stickyPoint;var tln=document.querySelector(".tln");if(!tln){return;}
var stickyPointEl=document.querySelector(".sticky-nav-point");if(stickyPointEl==null){stickyPointEl=document.querySelector("body");stickyPoint=0;}else{stickyPoint=stickyPointEl.clientHeight+stickyPointEl.offsetTop;}
var bodySelector=document.getElementsByTagName("body")[0];var tlnHeight=tln.clientHeight;var stickyNavigation=function(){if(window.pageYOffset+tlnHeight>=stickyPoint){bodySelector.classList.add("has-sticky-navigation");tln.classList.add("sticky-top");}else{bodySelector.classList.remove("has-sticky-navigation");tln.classList.remove("sticky-top");}}
window.onscroll=function(){stickyNavigation();};}
initStickyNav();function closeAllSelect(){document.getElementById("docOptions").classList.remove("show");}
function show(e){e.stopPropagation();document.getElementById("docOptions").classList.add("show");}
document.addEventListener("click",closeAllSelect);document.getElementById("docSelector").addEventListener("click",show);});</script><div class="tln fixedsticky sticky-top"><header class=navigation><div class=container><div class=navigation-wrapper><a href=/ class=logo><img src=/images/logo.svg>
<span class=title>Gardener</span></a>
<a class="nav-button navbar-toggler" href=#><i class="fa fa-bars"></i></a><div class=navbar-collapse><ul class=links><li class="link active"><a href=/blog/>Blogs</a></li><li class=link><a href=/community/>Community</a></li><li class=link><a href=/adopter/>Adopters</a></li><li class="link has-child"><a href=/documentation/home>Documentation</a></li></ul></div></div></div></header></div><script>$(".navigation .navbar-toggler").click(function(evt){$(".navigation .navbar-collapse").toggle();$(".navigation").toggleClass("collapsed");$(".navigation .search-box").toggle();})</script><style>#docSelector{cursor:pointer}.doc-options{position:fixed;background-color:#0b8062;text-align:left;display:none}.doc-options ul li{margin-bottom:0}.doc-options ul li a:hover{background-color:#0c694f}.doc-options ul{list-style:none;padding:0;margin:0;text-align:left}.doc-options ul li a{padding:10px;margin:0}.doc-options .activeVersion{background-color:#ec682a}.show{display:block}</style><div class="main container"><section><div class="highlightable body-inner-wrapper"><div id=body-inner><script src=/js/moment.js></script><div class="blogs page"><a href=/blog class="nav-link back">Back to Blogs</a><article class="post row" data-path><div class=wrapper><div class="two columns"><ul class=authors><li class=author><a href=mailto:daniel.foehr@sap.com><img src="https://avatars3.githubusercontent.com/u/33809186?s=400&u=92ab34a3539c11c498710aed9ddd1749032b36cb&v=4" class="user-icon icons" alt="blog author avatar">
<span class=name>Daniel Foehr</span></a></li></ul><span class=publishdate data-publishdate=2020-10-19>2020-10-19</span></div><div class="ten columns"><h2>Shoot Reconciliation Details<a href=/blog/2020-10/01/ class="title-link clipboard-copy"><i class="fa fa-link"></i></a></h2><div class=share-ribbon><a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class=twitter-share-button data-text="Shoot Reconciliation Details" data-url=https://gardener.cloud/blog/2020-10/01/ data-hashtags=GardenerProject data-dnt=true data-show-count=false>Tweet</a><script async src=https://platform.twitter.com/widgets.js></script>
<script type=in/share data-url=https://gardener.cloud/blog/2020-10/01/></script></div><p><p>Do you want to understand how Gardener creates and updates Kubernetes clusters (Shoots)?
Well, it&rsquo;s complicated, but if you are not afraid of large diagrams and are a visual learner like me, this might be useful to you.</p><h2 id=introduction>Introduction</h2><p>In this blog post I will share a technical diagram which attempts to tie together the
various components involved when Gardener creates a Kubernetes cluster.
I have created and curated the diagram, which visualizes the Shoot reconciliation flow since I started developing on Gardener.
Aside from serving as a memory aid for myself, I created it in hopes that it may potentially help contributors to understand a core piece of the complex Gardener machinery.
Please be advised that the diagram and components involved are large.
Although it can be easily divided into multiple diagrams, I want to show all the components and connections in a single diagram to create an overview of the reconciliation flow.</p><p>The goal is to visualize the interactions of the components involved in the Shoot creation.
It is not intended to serve as a documentation of every component involved.</p><h2 id=background>Background</h2><p>Taking a step back, the Gardener <a href=https://github.com/gardener/gardener/blob/master/README.md>READ.me</a> states</p><blockquote><p>In essence, Gardener is an <a href=https://kubernetes.io/docs/tasks/access-kubernetes-api/setup-extension-api-server/>extension API server</a>
that comes along with a bundle of custom controllers.
It introduces new API objects in an existing Kubernetes cluster (which is called <strong>garden</strong> cluster) in order to use them for the
management of end-user Kubernetes clusters (which are called <strong>shoot</strong> clusters).
These shoot clusters are described via <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml>declarative cluster specifications</a> which are observed by the controllers.
They will bring up the clusters, reconcile their state, perform automated updates and make sure they are always up and running.</p></blockquote><p>This means that Gardener, just like any Kubernetes controller, creates Kubernetes clusters (Shoots) using a reconciliation loop.</p><p>The <a href=https://github.com/gardener/gardener/blob/master/docs/concepts/gardenlet.md>Gardenlet</a> contains the controller and reconciliation loop responsible for the creation, update, deletion and migration of Shoot cluster (there are more, but we spare them in this article).
In addition, the <a href=https://github.com/gardener/gardener/blob/master/docs/concepts/controller-manager.md>Gardener Controller Manager</a> also reconciles Shoot resources, but only for seed-independent functionality such as Shoot hibernation, Shoot maintenance or quota control.</p><p>This blog post is about the reconciliation loop in the Gardenlet responsible for creating and updating Shoot clusters.
The code <a href=https://github.com/gardener/gardener/blob/master/pkg/gardenlet/controller/shoot/shoot_control_reconcile.go>can be found here</a>.
The reconciliation loops of the extension controllers can be found in their individual repositories.</p><h2 id=shoot-reconciliation-flow-diagram>Shoot reconciliation flow diagram</h2><p>When Gardner creates a Shoot cluster, there are three conceptual layers involved: the Garden cluster, the Seed cluster and the Shoot cluster.
Each layer represents a top-level section in the diagram (similar to a lane in a BPMN diagram).</p><p>It might seem confusing, that the Shoot cluster itself is a layer, because the whole flow in the first place is about creating the Shoot cluster.
I decided to introduce this separate layer to make a clear distinction between which resources exist in the Seed API server (managed by Gardener) and which in the Shoot API server (accessible by the Shoot owner).</p><p>Each section contains several components.
Components are mostly Kubernetes resources in a Gardener installation (e.g. the gardenlet deployment in the Seed cluster).</p><p>This is the list of components:</p><p><strong>(Virtual) Garden Cluster</strong></p><ul><li>Gardener Extension API server</li><li>Validating Provider Webhooks</li><li>Project Namespace</li></ul><p><strong>Seed Cluster</strong></p><ul><li>Gardenlet</li><li>Seed API server<ul><li>every Shoot Control Plane has a dedicated namespace in the Seed.</li></ul></li><li>Cloud Provider (owned by Stakeholder).<ul><li>Arguably part of the Shoot cluster but used by components in the Seed cluster to create the infrastructure for the Shoot.</li></ul></li><li><a href=https://github.com/gardener/external-dns-management>Gardener DNS extension</a></li><li>Provider Extension (such as <a href=https://github.com/gardener/gardener-extension-provider-aws>gardener-extension-provider-aws</a>)</li><li><a href=https://github.com/gardener/etcd-druid>Gardener Extension ETCD Druid</a></li><li><a href=https://github.com/gardener/gardener-resource-manager>Gardener Resource Manager</a></li><li>Operating System Extension (such as <a href=https://github.com/gardener/gardener-extension-os-gardenlinux>gardener-extension-os-gardenlinux</a>)</li><li>Networking extension (such as <a href=https://github.com/gardener/gardener-extension-networking-cilium>gardener-extension-networking-cilium</a>)</li><li><a href=https://github.com/gardener/machine-controller-manager>Machine Controller Manager</a></li><li>ContainerRuntime Extension (such as <a href=https://github.com/gardener/gardener-extension-runtime-gvisor>gardener-extension-runtime-gvisor</a>)</li><li>Shoot API server (in the Shoot Namespace in the Seed cluster)</li></ul><p><strong>Shoot Cluster</strong></p><ul><li>Cloud Provider compute API (owned by Stakeholder) - for VM/Node creation.</li><li>VM / Bare metal node hosted by Cloud Provider (in Stakeholder owned account).</li></ul><h3 id=how-to-use-the-diagram>How to use the diagram</h3><p>The diagram</p><ul><li>should be read from top to bottom - starting in the top left corner with the creation of the Shoot resource via the Gardener Extension API server.</li><li>should not require an encompassing documentation / description.
More detailed documentation on the components itself, can usually be found in the respective repository.</li><li>does not show which activities execute in parallel (many) and also does not describe the exact dependencies between the steps.
This can be found out by <a href=https://github.com/gardener/gardener/blob/master/pkg/gardenlet/controller/shoot/shoot_control_reconcile.go>looking at the source code</a>.
It however tries to put the activities in a logical order of executing during the reconciliation flow.</li></ul><p>Occasionally, there is an info box with additional information next to parts in the diagram that in my point of view require further explanation.
Large example resource for the Gardener CRDs (e.g Worker CRD, Infrastructure CRD) are placed on the left side and are referenced by a dotted line (&mdash;&ndash;).</p><p>Be aware, that Gardener is an evolving project, so the diagram will most likely be already outdated by the time you are reading this.
Nevertheless, it should give a solid starting point for further explorations into the details of Gardener.</p><h3 id=flow-diagram>Flow diagram</h3><p>The diagram can be found below and on <a href=https://github.com/danielfoehrKn/diagrams/tree/master/gardener/shoot-reconciliation>Github.com</a>.
There are multiple formats available (svg, vsdx, draw.io, html).</p><p>Please open an issue or open a PR in the repository if information is missing or is incorrect.
Thanks!</p><p><img style=width:300px;height:auto;margin:0;auto src=https://raw.githubusercontent.com/danielfoehrKn/diagrams/master/gardener/shoot-reconciliation/gardener_reconcile_with_grid.png target=_blank></a></p></p></div></div></article><a href=/blog class="nav-link back">Back to Blogs</a></div></div></div></section></div><style></style><footer class=footer><div class="container footer-wrapper"><ul class=nav><li><a href=/blog/>Blogs</a></li><li><a href=/community/>Community</a></li><li><a href=/adopter/>Adopters</a></li><li><a href=/documentation/home>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2020 Gardener project authors. Privacy Statement</span></div></footer><script src=/js/perfect-scrollbar.min.js?1610967076></script><script src=/js/perfect-scrollbar.jquery.min.js?1610967076></script><script src=/js/jquery.sticky.js?1610967076></script><script src=/js/featherlight.min.js?1610967076></script><script src=/js/html5shiv-printshiv.min.js?1610967076></script><script src=/js/modernizr.custom.71422.js?1610967076></script><link href=/mermaid/mermaid.css?1610967076 type=text/css rel=stylesheet><script src=/mermaid/mermaid.js?1610967076></script><script src=/js/code-snippets.js?1610967076></script><script>mermaid.initialize({startOnLoad:true,htmlLables:true});function createIssue(issueUrl,page,url){var uri=issueUrl+"?title=Documentation issue on page \""+page+"\"";uri=uri+"&body=\n\n<- DESCRIBE MISSING OR FAULTY DOCUMENTATION HERE->\n\n---\nPage: ["+page+"]("+
url+")\ndon't remove the link to the page. It's required for the processor"
var res=encodeURI(uri);res+="&labels=area/documentation"
window.open(res,"issue")
return false;}
$(document).ready(function(){inlineSVG.init();$("[data-publishdate]").each(function(){$(this).text(moment($(this,"YYYY-MM-DD","YYYY-MM-DD hh:mm:ss").attr("data-publishdate")).fromNow());});new ClipboardJS('.clipboard-copy');$("body").codeSnippets();});</script><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W2FGNSX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script src=/js/modernizr.custom.min.js></script><script src=/js/jsrender.min.js></script><script src=/js/main.js></script><script>$(document).ready(function(){$('.blogs .clipboard-copy').click(function(e){e.preventDefault();});})</script></body></html>