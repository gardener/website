<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.95.0"><link rel=canonical type=text/html href=https://gardener.cloud/docs/guides/monitoring-and-troubleshooting/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/guides/monitoring-and-troubleshooting/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Monitor and Troubleshoot | Gardener</title><meta name=description content><meta property="og:title" content="Monitor and Troubleshoot"><meta property="og:description" content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:type" content="website"><meta property="og:url" content="https://gardener.cloud/docs/guides/monitoring-and-troubleshooting/"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Monitor and Troubleshoot"><meta itemprop=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Monitor and Troubleshoot"><meta name=twitter:description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><link rel=preload href=/scss/main.min.b5b806bb2cd9fe9ed809539377398aa9df0eb8ca0c983a6eae0b413d528d8f0e.css as=style><link href=/scss/main.min.b5b806bb2cd9fe9ed809539377398aa9df0eb8ca0c983a6eae0b413d528d8f0e.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7N3XF5XLGV"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7N3XF5XLGV",{anonymize_ip:!1})}</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.56ae677245b4ba871ea23ce7c5378268.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/guides/monitoring-and-troubleshooting/>Return to the regular view of this page</a>.</p></div><h1 class=title>Monitor and Troubleshoot</h1><div class=content></div></div><div class=td-content><h1 id=pg-6754a4f00b400f52e32db31333cfd45e>1 - Analyzing Node Removal and Failures</h1><div class=lead>Utilize Gardener&rsquo;s Monitoring and Logging to analyze removal and failures of nodes</div><h2 id=overview>Overview</h2><p>Sometimes operators want to find out why a certain node got removed. This guide helps to identify possible causes.
There are a few potential reasons why nodes can be removed:</p><ul><li><a href=#find-out-whether-the-node-was-unhealthy>broken node</a>: a node becomes unhealthy and machine-controller-manager terminates it in an attempt to replace the unhealthy node with a new one</li><li><a href=#scale-down>scale-down</a>: cluster-autoscaler sees that a node is under-utilized and therefore scales down a worker pool</li><li><a href=#node-rolling>node rolling</a>: configuration changes to a worker pool (or cluster) require all nodes of one or all worker pools to be rolled and thus all nodes to be replaced. Some possible changes are:<ul><li>the K8s/OS version</li><li>changing machine types</li></ul></li></ul><p>Helpful information can be obtained by using the logging stack. See <a href=/docs/gardener/usage/logging/>Logging Stack</a> for how to utilize the logging information in Gardener.</p><h2 id=find-out-whether-the-node-was-unhealthy>Find Out Whether the Node Was <code>unhealthy</code></h2><h3 id=check-the-node-events>Check the Node Events</h3><p>A good first indication on what happened to a node can be obtained from the node&rsquo;s events. Events are scraped and ingested into the logging system, so they can be found in the explore tab of Grafana (make sure to select <code>loki</code> as datasource) with a query like <code>{job="event-logging"} | unpack | object="Node/&lt;node-name>"</code> or find any event mentioning the node in question via a broader query like <code>{job="event-logging"}|="&lt;node-name>"</code>.</p><p>A potential result might reveal</p><pre tabindex=0><code>{&#34;_entry&#34;:&#34;Node ip-10-55-138-185.eu-central-1.compute.internal status is now: NodeNotReady&#34;,&#34;count&#34;:1,&#34;firstTimestamp&#34;:&#34;2023-04-05T12:02:08Z&#34;,&#34;lastTimestamp&#34;:&#34;2023-04-05T12:02:08Z&#34;,&#34;namespace&#34;:&#34;default&#34;,&#34;object&#34;:&#34;Node/ip-10-55-138-185.eu-central-1.compute.internal&#34;,&#34;origin&#34;:&#34;shoot&#34;,&#34;reason&#34;:&#34;NodeNotReady&#34;,&#34;source&#34;:&#34;node-controller&#34;,&#34;type&#34;:&#34;Normal&#34;}
</code></pre><h3 id=check-machine-controller-manager-logs>Check machine-controller-manager Logs</h3><p>If a node was getting unhealthy, the last conditions can be found in the logs of the <code>machine-controller-manager</code> by using a query like <code>{pod_name=~"machine-controller-manager.*"}|="&lt;node-name>"</code>.</p><p><strong>Caveat</strong>: every <code>node</code> resource is backed by a corresponding <code>machine</code> resource managed by machine-controller-manager. Usually two corresponding <code>node</code> and <code>machine</code> resources have the same name with the exception of AWS. Here you first need to find with the above query the corresponding <code>machine</code> name, typically via a log like this</p><pre tabindex=0><code>2023-04-05 12:02:08	{&#34;log&#34;:&#34;Conditions of Machine \&#34;shoot--demo--cluster-pool-z1-6dffc-jh4z4\&#34; with providerID \&#34;aws:///eu-central-1/i-0a6ad1ca4c2e615dc\&#34; and backing node \&#34;ip-10-55-138-185.eu-central-1.compute.internal\&#34; are changing&#34;,&#34;pid&#34;:&#34;1&#34;,&#34;severity&#34;:&#34;INFO&#34;,&#34;source&#34;:&#34;machine_util.go:629&#34;}
</code></pre><p>This reveals that <code>node</code> <code>ip-10-55-138-185.eu-central-1.compute.internal</code> is backed by <code>machine</code> <code>shoot--demo--cluster-pool-z1-6dffc-jh4z4</code>. On infrastructures other than AWS you can omit this step.</p><p>With the machine name at hand, now search for log entries with <code>{pod_name=~"machine-controller-manager.*"}|="&lt;machine-name>"</code>.
In case the node had failing conditions, you&rsquo;d find logs like this:</p><pre tabindex=0><code>2023-04-05 12:02:08	{&#34;log&#34;:&#34;Machine shoot--demo--cluster-pool-z1-6dffc-jh4z4 is unhealthy - changing MachineState to Unknown. Node conditions: [{Type:ClusterNetworkProblem Status:False LastHeartbeatTime:2023-04-05 11:58:39 +0000 UTC LastTransitionTime:2023-03-23 11:59:29 +0000 UTC Reason:NoNetworkProblems Message:no cluster network problems} ... {Type:Ready Status:Unknown LastHeartbeatTime:2023-04-05 11:55:27 +0000 UTC LastTransitionTime:2023-04-05 12:02:07 +0000 UTC Reason:NodeStatusUnknown Message:Kubelet stopped posting node status.}]&#34;,&#34;pid&#34;:&#34;1&#34;,&#34;severity&#34;:&#34;WARN&#34;,&#34;source&#34;:&#34;machine_util.go:637&#34;}
</code></pre><p>In the example above, the reason for an unhealthy node was that <code>kubelet</code> failed to renew its heartbeat. Typical reasons would be either a broken VM (that couldn&rsquo;t execute <code>kubelet</code> anymore) or a broken network. Note that some VM terminations performed by the infrastructure provider are actually expected (e.g., <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/monitoring-instances-status-check_sched.html>scheduled events on AWS</a>)</p><p>In both cases, the infrastructure provider might be able to provide more information on particular VM or network failures.</p><p>Whatever the failure condition might have been, if a node gets unhealthy, it will be terminated by <code>machine-controller-manager</code> after the <code>machineHealthTimeout</code> has elapsed (this parameter can be configured in your <a href=https://github.com/gardener/gardener/blob/v1.68.0/example/90-shoot.yaml#L132>shoot spec</a>).</p><h3 id=check-the-node-logs>Check the Node Logs</h3><p>For each <code>node</code> the kernel and <code>kubelet</code> logs, as well as a few others, are scraped and can be queried with this query <code>{nodename="&lt;node-name>"}</code>
This might reveal OS specific issues or, in the absence of any logs (e.g., after the node went unhealthy), might indicate a network disruption or sudden VM termination. Note that some VM terminations performed by the infrastructure provider are actually expected (e.g., <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/monitoring-instances-status-check_sched.html>scheduled events on AWS</a>).</p><p>Infrastructure providers might be able to provide more information on particular VM failures in such cases.</p><h3 id=check-the-network-problem-detector-dashboard>Check the Network Problem Detector Dashboard</h3><p>If your Gardener installation utilizes <a href=https://github.com/gardener/gardener-extension-shoot-networking-problemdetector>gardener-extension-shoot-networking-problemdetector</a>, you can check the dashboard named &ldquo;Network Problem Detector&rdquo; in Grafana for hints on network issues on the node of interest.</p><h2 id=scale-down>Scale-Down</h2><p>In general, scale-downs are managed by the <a href=https://github.com/gardener/autoscaler>cluster-autoscaler</a>, its logs can be found with the query <code>{container_name="cluster-autoscaler"}</code>.
Attempts to remove a node can be found with the query <code>{container_name="cluster-autoscaler"}|="Scale-down: removing empty node"</code></p><p>If a scale-down has caused disruptions in your workload, consider protecting your workload by adding <code>PodDisruptionBudgets</code> (see the <a href=https://github.com/gardener/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-types-of-pods-can-prevent-ca-from-removing-a-node>autoscaler FAQ</a> for more options).</p><h2 id=node-rolling>Node Rolling</h2><p>Node rolling can be caused by ,e.g.:</p><ul><li>change of the K8s minor version of the cluster or a worker pool</li><li>change of the OS version of the cluster or a worker pool</li><li>change of the disk size/type or machine size/type of a worker pool</li><li>change of node labels</li></ul><p>Changes like the above are done by altering the shoot specification and thus are recorded in the external auditlog system that is configured for the garden cluster.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9ef04269409623a8c7d8d6ccafcfaf80>2 - Get a Shell to a Gardener Shoot Worker Node</h1><div class=lead>Describes the methods for getting shell access to worker nodes</div><h2 id=overview>Overview</h2><p>To troubleshoot certain problems in a Kubernetes cluster, operators need access to the host of the Kubernetes node. This can be required if a node misbehaves or fails to join the cluster in the first place.</p><p>With access to the host, it is for instance possible to check the <code>kubelet</code> logs and interact with common tools such as <code>systemctl</code>and <code>journalctl</code>.</p><p>The first section of this guide explores options to get a shell to the node of a Gardener Kubernetes cluster.
The options described in the second section do not rely on Kubernetes capabilities to get shell access to a node and thus can also be used if an instance failed to join the cluster.</p><p>This guide only covers how to get access to the host, but does not cover troubleshooting methods.</p><ul><li><a href=#overview>Overview</a></li><li><a href=#get-a-shell-to-an-operational-cluster-node>Get a Shell to an Operational Cluster Node</a><ul><li><a href=#gardener-dashboard>Gardener Dashboard</a><ul><li><a href=#result>Result</a></li></ul></li><li><a href=#gardener-ops-toolbelt>Gardener Ops Toolbelt</a></li><li><a href=#custom-root-pod>Custom Root Pod</a></li></ul></li><li><a href=#ssh-access-to-a-node-that-failed-to-join-the-cluster>SSH Access to a Node That Failed to Join the Cluster</a><ul><li><a href=#identifying-the-problematic-instance>Identifying the Problematic Instance</a></li><li><a href=#gardenctl-ssh>gardenctl ssh</a></li><li><a href=#ssh-with-a-manually-created-bastion-on-aws>SSH with a Manually Created Bastion on AWS</a><ul><li><a href=#create-the-bastion-security-group>Create the Bastion Security Group</a></li><li><a href=#create-the-bastion-instance>Create the Bastion Instance</a></li></ul></li><li><a href=#connecting-to-the-target-instance>Connecting to the Target Instance</a></li></ul></li><li><a href=#cleanup>Cleanup</a></li></ul><h2 id=get-a-shell-to-an-operational-cluster-node>Get a Shell to an Operational Cluster Node</h2><p>The following describes four different approaches to get a shell to an operational Shoot worker node.
As a prerequisite to troubleshooting a Kubernetes node, the node must have joined the cluster successfully and be able to run a pod.
All of the described approaches involve scheduling a pod with root permissions and mounting the root filesystem.</p><h3 id=gardener-dashboard>Gardener Dashboard</h3><p><strong>Prerequisite</strong>: the terminal feature is configured for the Gardener dashboard.</p><ol><li>Navigate to the cluster overview page and find the <code>Terminal</code> in the <code>Access</code> tile.</li></ol><img style=margin-left:0;width:80%;height:auto alt="Access Tile" src=/__resources/9fb6ca4ff9b7480f93debba833f48590_cdaf8c.png><br><p>Select the target Cluster (Garden, Seed / Control Plane, Shoot cluster) depending on the requirements and
access rights (only certain users have access to the Seed Control Plane).</p><ol start=2><li>To open the terminal configuration, interact with the top right-hand corner of the screen.</li></ol><img style=margin-left:0 alt="Terminal configuration" src=/__resources/db573582bfc544d294cbde8906a74e07_ba1bf4.png><br><ol start=3><li>Set the Terminal Runtime to &ldquo;Privileged&rdquo;. Also, specify the target node from the drop-down menu.</li></ol><img style=margin-left:0;width:50%;height:auto alt="Dashboard terminal pod configuration" src=/__resources/f7b10d48edf44c17ba838ff5c429e39d_150de1.png><br><h4 id=result>Result</h4><p>The Dashboard then schedules a pod and opens a shell session to the node.</p><p>To get access to the common binaries installed on the host, prefix the command with <code>chroot /hostroot</code>.
Note that the path depends on where the root path is mounted in the container.
In the default image used by the Dashboard, it is under <code>/hostroot</code>.</p><img style=margin-left:0 alt="Dashboard terminal pod configuration" src=/__resources/3da659e9cc4744a2ad3e1c6a50d39c04_bf90b6.png><br><h3 id=gardener-ops-toolbelt>Gardener Ops Toolbelt</h3><p><strong>Prerequisite</strong>: <code>kubectl</code> is available.</p><p>The <a href=https://github.com/gardener/ops-toolbelt>Gardener ops-toolbelt</a> can be used as a convenient way to deploy a root pod to a node.
The pod uses an image that is bundled with a bunch of useful <a href=https://github.com/gardener/ops-toolbelt/tree/master/dockerfile-configs>troubleshooting tools</a>.
This is also the same image that is used by default when using the Gardener Dashboard terminal feature as described in the <a href=#gardener-dashboard>previous section</a>.</p><p>The easiest way to use the <a href=https://github.com/gardener/ops-toolbelt>Gardener ops-toolbelt</a> is to execute
the <a href=https://github.com/gardener/ops-toolbelt/blob/master/hacks/ops-pod><code>ops-pod</code> script</a> in the <code>hacks</code> folder.
To get root shell access to a node, execute the aforementioned script by supplying the target node name as an argument:</p><pre tabindex=0><code>$ &lt;path-to-ops-toolbelt-repo&gt;/hacks/ops-pod &lt;target-node&gt;
</code></pre><h3 id=custom-root-pod>Custom Root Pod</h3><p>Alternatively, a pod can be <a href=https://kubernetes.io/docs/concepts/configuration/assign-pod-node/>assigned</a> to a target node and a shell can
be opened via <a href=https://kubernetes.io/docs/tasks/debug-application-cluster/get-shell-running-container/>standard Kubernetes means</a>.
To enable root access to the node, the pod specification requires proper <code>securityContext</code> and <code>volume</code> properties.</p><p>For instance, you can use the following pod manifest, after changing <target-node-name>with the name of the node you want this pod attached to:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Pod
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: privileged-pod
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  nodeSelector:
</span></span><span style=display:flex><span>    kubernetes.io/hostname: &lt;target-node-name&gt;
</span></span><span style=display:flex><span>  containers:
</span></span><span style=display:flex><span>  - name: busybox
</span></span><span style=display:flex><span>    image: busybox
</span></span><span style=display:flex><span>    stdin: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    securityContext:
</span></span><span style=display:flex><span>      privileged: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    volumeMounts:
</span></span><span style=display:flex><span>    - name: host-root-volume
</span></span><span style=display:flex><span>      mountPath: /host
</span></span><span style=display:flex><span>      readOnly: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  volumes:
</span></span><span style=display:flex><span>  - name: host-root-volume
</span></span><span style=display:flex><span>    hostPath:
</span></span><span style=display:flex><span>      path: /
</span></span><span style=display:flex><span>  hostNetwork: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  hostPID: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  restartPolicy: Never
</span></span></code></pre></div><h2 id=ssh-access-to-a-node-that-failed-to-join-the-cluster>SSH Access to a Node That Failed to Join the Cluster</h2><p>This section explores two options that can be used to get SSH access to a node that failed to join the cluster.
As it is not possible to schedule a pod on the node, the Kubernetes-based methods explored so far cannot be used in this scenario.</p><p>Additionally, Gardener typically provisions worker instances in a private subnet of the VPC, hence - there is no public IP address that could be used for direct SSH access.</p><p>For this scenario, cloud providers typically have extensive documentation (e.g <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstances.html>AWS</a> & <a href=https://cloud.google.com/compute/docs/instances/connecting-to-instance>GCP</a>
and in <a href=https://cloud.google.com/compute/docs/instances/connecting-advanced#vpn>some cases tooling support</a>).
However, these approaches are mostly cloud provider specific, require interaction via their CLI and API or sometimes
the installation of a <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-install-ssm-agent.html>cloud provider specific agent</a> on the node.</p><p>Alternatively, <code>gardenctl</code> can be used providing a cloud provider agnostic and out-of-the-box support to get ssh access to an instance in a private subnet.
Currently <code>gardenctl</code> supports AWS, GCP, Openstack, Azure and Alibaba Cloud.</p><h3 id=identifying-the-problematic-instance>Identifying the Problematic Instance</h3><p>First, the problematic instance has to be identified.
In Gardener, worker pools can be created in different cloud provider regions, zones, and accounts.</p><p>The instance would typically show up as successfully started / running in the cloud provider dashboard or API and it is not immediately obvious which one has a problem.
Instead, we can use the Gardener API / CRDs to obtain the faulty instance identifier in a cloud-agnostic way.</p><p>Gardener uses the <a href=https://github.com/gardener/machine-controller-manager>Machine Controller Manager</a> to create the Shoot worker nodes.
For each worker node, the Machine Controller Manager creates a <code>Machine</code> CRD in the Shoot namespace in the respective <code>Seed</code> cluster.
Usually the problematic instance can be identified, as the respective <code>Machine</code> CRD has status <code>pending</code>.</p><p>The instance / node name can be obtained from the <code>Machine</code> <code>.status</code> field:</p><pre tabindex=0><code>$ kubectl get machine &lt;machine-name&gt; -o json | jq -r .status.node
</code></pre><p>This is all the information needed to go ahead and use <code>gardenctl ssh</code> to get a shell to the node.
In addition, the used cloud provider, the specific identifier of the instance, and the instance region can be identified from the <code>Machine</code> CRD.</p><p>Get the identifier of the instance via:</p><pre tabindex=0><code>$ kubectl get machine &lt;machine-name&gt; -o json | jq -r .spec.providerID // e.g aws:///eu-north-1/i-069733c435bdb4640
</code></pre><p>The identifier shows that the instance belongs to the cloud provider <code>aws</code> with the ec2 instance-id <code>i-069733c435bdb4640</code> in region <code>eu-north-1</code>.</p><p>To get more information about the instance, check out the <code>MachineClass</code> (e.g <code>AWSMachineClass</code>) that is associated with each <code>Machine</code> CRD in the <code>Shoot</code> namespace of the <code>Seed</code> cluster.
The <code>AWSMachineClass</code> contains the machine image (<a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html>ami</a>), machine-type, iam information, network-interfaces, subnets, security groups and attached volumes.</p><p>Of course, the information can also be used to get the instance with the cloud provider CLI / API.</p><h3 id=gardenctl-ssh>gardenctl ssh</h3><p>Using the node name of the problematic instance, we can use the <code>gardenctl ssh</code> command to get SSH access to the cloud provider
instance via an automatically set up <a href=https://en.wikipedia.org/wiki/Bastion_host>bastion host</a>.
<code>gardenctl</code> takes care of spinning up the <code>bastion</code> instance, setting up the SSH keys, ports and security groups and opens a root shell on the target instance.
After the SSH session has ended, <code>gardenctl</code> deletes the created cloud provider resources.</p><p>Use the following commands:</p><ol><li>First, target a Garden cluster containing all the Shoot definitions.</li></ol><pre tabindex=0><code>$ gardenctl target garden &lt;target-garden&gt;
</code></pre><ol start=2><li>Target an available Shoot by name.
This sets up the context, configures the <code>kubeconfig</code> file of the Shoot cluster and downloads the cloud provider credentials.
Subsequent commands will execute in this context.</li></ol><pre tabindex=0><code>$ gardenctl target shoot &lt;target-shoot&gt;
</code></pre><ol start=3><li>This uses the cloud provider credentials to spin up the bastion and to open a shell on the target instance.</li></ol><pre tabindex=0><code>$ gardenctl ssh &lt;target-node&gt;
</code></pre><h3 id=ssh-with-a-manually-created-bastion-on-aws>SSH with a Manually Created Bastion on AWS</h3><p>In case you are not using <code>gardenctl</code> or want to control the bastion instance yourself, you can also manually set it up.
The steps described here are generally the same as <a href=https://github.com/gardener/gardenctl/blob/10a537942b94234914758c0f6d053dc1cf218ecd/pkg/cmd/ssh_aws.go#L53-L52>those used by <code>gardenctl</code> internally</a>.
Despite some cloud provider specifics, they can be generalized to the following list:</p><ul><li>Open port 22 on the target instance.</li><li>Create an instance / VM in a public subnet (the bastion instance needs to have a public IP address).</li><li>Set-up security groups and roles, and open port 22 for the bastion instance.</li></ul><p>The following diagram shows an overview of how the SSH access to the target instance works:</p><img style=margin-left:0 alt="SSH Bastion diagram" src=/__resources/913441003e5641bc90249bdc07d55656_acb171.png><br><p>This guide demonstrates the setup of a bastion on AWS.</p><p><strong>Prerequisites:</strong></p><ul><li>The <code>AWS CLI</code> is set up.</li><li>Obtain target <code>instance-id</code> (see <a href=#identifying-the-problematic-instance>Identifying the Problematic Instance</a>).</li><li>Obtain the VPC ID the Shoot resources are created in. This can be found in the <code>Infrastructure</code> CRD in the <code>Shoot</code> namespace in the <code>Seed</code>.</li><li>Make sure that port 22 on the target instance is open (default for Gardener deployed instances).<ul><li>Extract security group via:</li></ul><pre tabindex=0><code>$ aws ec2 describe-instances --instance-ids &lt;instance-id&gt;
</code></pre><ul><li>Check for rule that allows inbound connections on port 22:</li></ul><pre tabindex=0><code>$ aws ec2 describe-security-groups --group-ids=&lt;security-group-id&gt;
</code></pre><ul><li>If not available, create the rule with the following comamnd:</li></ul><pre tabindex=0><code>$ aws ec2 authorize-security-group-ingress --group-id &lt;security-group-id&gt;  --protocol tcp --port 22 --cidr 0.0.0.0/0
</code></pre></li></ul><h4 id=create-the-bastion-security-group>Create the Bastion Security Group</h4><ol><li>The common name of the security group is <code>&lt;shoot-name>-bsg</code>. Create the security group:</li></ol><pre tabindex=0><code>$ aws ec2 create-security-group --group-name &lt;bastion-security-group-name&gt;  --description ssh-access --vpc-id &lt;VPC-ID&gt;
</code></pre><ol start=2><li>Optionally, create identifying tags for the security group:</li></ol><pre tabindex=0><code>$ aws ec2 create-tags --resources &lt;bastion-security-group-id&gt; --tags Key=component,Value=&lt;tag&gt;
</code></pre><ol start=3><li>Create a permission in the bastion security group that allows ssh access on port 22:</li></ol><pre tabindex=0><code>$ aws ec2 authorize-security-group-ingress --group-id &lt;bastion-security-group-id&gt;  --protocol tcp --port 22 --cidr 0.0.0.0/0
</code></pre><ol start=4><li>Create an IAM role for the bastion instance with the name <code>&lt;shoot-name>-bastions</code>:</li></ol><pre tabindex=0><code>$ aws iam create-role --role-name &lt;shoot-name&gt;-bastions
</code></pre><p>The content should be:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>&#34;Version&#34;: <span style=color:#a31515>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>&#34;Statement&#34;: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>        &#34;Action&#34;: [
</span></span><span style=display:flex><span>            <span style=color:#a31515>&#34;ec2:DescribeRegions&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        &#34;Resource&#34;: [
</span></span><span style=display:flex><span>            <span style=color:#a31515>&#34;*&#34;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=5><li>Create the instance profile and name it <code>&lt;shoot-name>-bastions</code>:</li></ol><pre tabindex=0><code>$ aws iam create-instance-profile --instance-profile-name &lt;name&gt;
</code></pre><ol start=6><li>Add the created role to the instance profile:</li></ol><pre tabindex=0><code>$ aws iam add-role-to-instance-profile --instance-profile-name &lt;instance-profile-name&gt; --role-name &lt;role-name&gt;
</code></pre><h4 id=create-the-bastion-instance>Create the Bastion Instance</h4><p>Next, in order to be able to <code>ssh</code> into the bastion instance, the instance has to be set up with a user with a public ssh key.
Create a user <code>gardener</code> that has the same Gardener-generated public ssh key as the target instance.</p><ol><li>First, we need to get the public part of the <code>Shoot</code> ssh-key.
The ssh-key is stored in a secret in the the project namespace in the Garden cluster.
The name is: <code>&lt;shoot-name>-ssh-publickey</code>.
Get the key via:</li></ol><pre tabindex=0><code>$ kubectl get secret aws-gvisor.ssh-keypair -o json | jq -r .data.\&#34;id_rsa.pub\&#34;
</code></pre><ol start=2><li>A script handed over as <code>user-data</code> to the bastion <code>ec2</code> instance, can be used to create the <code>gardener</code> user and add the ssh-key.
For your convenience, you can use the following script to generate the <code>user-data</code>.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#00f>#!/bin/bash -eu
</span></span></span><span style=display:flex><span><span style=color:#00f></span>saveUserDataFile () {
</span></span><span style=display:flex><span>  ssh_key=$1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat &gt; gardener-bastion-userdata.sh <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>#!/bin/bash -eu
</span></span></span><span style=display:flex><span><span style=color:#a31515>id gardener || useradd gardener -mU
</span></span></span><span style=display:flex><span><span style=color:#a31515>mkdir -p /home/gardener/.ssh
</span></span></span><span style=display:flex><span><span style=color:#a31515>echo &#34;$ssh_key&#34; &gt; /home/gardener/.ssh/authorized_keys
</span></span></span><span style=display:flex><span><span style=color:#a31515>chown gardener:gardener /home/gardener/.ssh/authorized_keys
</span></span></span><span style=display:flex><span><span style=color:#a31515>echo &#34;gardener ALL=(ALL) NOPASSWD:ALL&#34; &gt;/etc/sudoers.d/99-gardener-user
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>if</span> [ -p /dev/stdin ]; <span style=color:#00f>then</span>
</span></span><span style=display:flex><span>    read -r input
</span></span><span style=display:flex><span>    cat | saveUserDataFile <span style=color:#a31515>&#34;</span>$input<span style=color:#a31515>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#00f>else</span>
</span></span><span style=display:flex><span>    pbpaste | saveUserDataFile <span style=color:#a31515>&#34;</span>$input<span style=color:#a31515>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#00f>fi</span>
</span></span></code></pre></div><ol start=3><li>Use the script by handing-over the public ssh-key of the <code>Shoot</code> cluster:</li></ol><pre tabindex=0><code>$ kubectl get secret aws-gvisor.ssh-keypair -o json | jq -r .data.\&#34;id_rsa.pub\&#34; | ./generate-userdata.sh
</code></pre><p>This generates a file called <code>gardener-bastion-userdata.sh</code> in the same directory containing the <code>user-data</code>.</p><ol start=4><li>The following information is needed to create the bastion instance:</li></ol><p><code>bastion-IAM-instance-profile-name</code>
- Use the created instance profile with the name <code>&lt;shoot-name>-bastions</code></p><p><code>image-id</code>
- It is possible to use the same image-id as the one used for the target instance (or any other image). Has cloud provider specific format (AWS: <code>ami</code>).</p><p><code>ssh-public-key-name</code></p><pre tabindex=0><code>- This is the ssh key pair already created in the Shoot&#39;s cloud provider account by Gardener during the `Infrastructure` CRD reconciliation.
- The name is usually: `&lt;shoot-name&gt;-ssh-publickey`
</code></pre><p><code>subnet-id</code>
- Choose a subnet that is attached to an <code>Internet Gateway</code> and <code>NAT Gateway</code> (bastion instance must have a public IP).
- The Gardener created public subnet with the name <code>&lt;shoot-name>-public-utility-&lt;xy></code> can be used.
Please check the created subnets with the cloud provider.</p><p><code>bastion-security-group-id</code>
- Use the id of the created bastion security group.</p><p><code>file-path-to-userdata</code>
- Use the filepath to the <code>user-data</code> file generated in the previous step.</p><ul><li><code>bastion-instance-name</code><ul><li>Optionaly, you can tag the instance.</li><li>Usually <code>&lt;shoot-name>-bastions</code></li></ul></li></ul><ol start=5><li>Create the bastion instance via:</li></ol><pre tabindex=0><code>$ ec2 run-instances --iam-instance-profile Name=&lt;bastion-IAM-instance-profile-name&gt; --image-id &lt;image-id&gt;  --count 1 --instance-type t3.nano --key-name &lt;ssh-public-key-name&gt;  --security-group-ids &lt;bastion-security-group-id&gt; --subnet-id &lt;subnet-id&gt; --associate-public-ip-address --user-data &lt;file-path-to-userdata&gt; --tag-specifications ResourceType=instance,Tags=[{Key=Name,Value=&lt;bastion-instance-name&gt;},{Key=component,Value=&lt;mytag&gt;}] ResourceType=volume,Tags=[{Key=component,Value=&lt;mytag&gt;}]&#34;
</code></pre><p>Capture the <code>instance-id</code> from the response and wait until the <code>ec2</code> instance is running and has a public IP address.</p><h3 id=connecting-to-the-target-instance>Connecting to the Target Instance</h3><ol><li>Save the private key of the ssh-key-pair in a temporary local file for later use:</li></ol><pre tabindex=0><code>$ umask 077

$ kubectl get secret &lt;shoot-name&gt;.ssh-keypair -o json | jq -r .data.\&#34;id_rsa\&#34; | base64 -d &gt; id_rsa.key
</code></pre><ol start=2><li>Use the private ssh key to ssh into the bastion instance:</li></ol><pre tabindex=0><code>$ ssh -i &lt;path-to-private-key&gt; gardener@&lt;public-bastion-instance-ip&gt; 
</code></pre><ol start=3><li>If that works, connect from your local terminal to the target instance via the bastion:</li></ol><pre tabindex=0><code>$ ssh  -i &lt;path-to-private-key&gt; -o ProxyCommand=&#34;ssh -W %h:%p -i &lt;private-key&gt; -o IdentitiesOnly=yes -o StrictHostKeyChecking=no gardener@&lt;public-ip-bastion&gt;&#34; gardener@&lt;private-ip-target-instance&gt; -o IdentitiesOnly=yes -o StrictHostKeyChecking=no
</code></pre><h2 id=cleanup>Cleanup</h2><p>Do not forget to cleanup the created resources. Otherwise Gardener will eventually fail to delete the Shoot.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f8aac904b306d99ba557bd2e49bfe345>3 - How to Debug a Pod</h1><div class=lead>Your pod doesn&rsquo;t run as expected. Are there any log files? Where? How could I debug a pod?</div><h2 id=introduction>Introduction</h2><p>Kubernetes offers powerful options to get more details about startup or runtime failures of pods as e.g. described in
<a href=https://kubernetes.io/docs/tasks/debug-application-cluster/debug-application-introspection/>Application Introspection and Debugging</a>
or <a href=https://kubernetes.io/docs/tasks/debug-application-cluster/debug-pod-replication-controller/>Debug Pods and Replication Controllers</a>.</p><p>In order to identify pods with potential issues, you could e.g. run <code>kubectl get pods --all-namespaces | grep -iv Running</code> to filter
out the pods which are not in the state <code>Running</code>. One of frequent error state is <code>CrashLoopBackOff</code>, which tells that
a pod crashes right after the start. Kubernetes then tries to restart the pod again, but often the pod startup fails again.</p><p>Here is a short list of possible reasons which might lead to a pod crash:</p><ol><li>Error during image pull caused by e.g. wrong/missing secrets or wrong/missing image</li><li>The app runs in an error state caused e.g. by missing environmental variables (ConfigMaps) or secrets</li><li>Liveness probe failed</li><li>Too high resource consumption (memory and/or CPU) or too strict quota settings</li><li>Persistent volumes can&rsquo;t be created/mounted</li><li>The container image is not updated</li></ol><p>Basically, the commands <code>kubectl logs ...</code> and <code>kubectl describe ...</code> with different parameters are used to get more
detailed information. By calling e.g. <code>kubectl logs --help</code> you can get more detailed information about the command and its
parameters.</p><p>In the next sections you&rsquo;ll find some basic approaches to get some ideas what went wrong.</p><p>Remarks:</p><ul><li>Even if the pods seem to be running, as the status <code>Running</code> indicates, a high counter of the <code>Restarts</code> shows potential problems</li><li>You can get a good overview of the troubleshooting process with the interactive tutorial <a href=https://kubernetes.io/docs/tutorials/kubernetes-basics/explore-intro/>Troubleshooting with Kubectl</a> available which explains basic debugging activities</li><li>The examples below are deployed into the namespace <code>default</code>. In case you want to change it, use the optional
parameter <code>--namespace &lt;your-namespace></code> to select the target namespace. The examples require a Kubernetes release ≥ <em>1.8</em>.</li></ul><h2 id=prerequisites>Prerequisites</h2><p>Your deployment was successful (no logical/syntactical errors in the manifest files), but the pod(s) aren&rsquo;t running.</p><h2 id=error-caused-by-wrong-image-name>Error Caused by Wrong Image Name</h2><p>Start by running <code>kubectl describe pod &lt;your-pod> &lt;your-namespace></code> to get detailed information about the pod startup.</p><p>In the <code>Events</code> section, you should get an error message like <code>Failed to pull image ...</code> and <code>Reason: Failed</code>. The pod is
in state <code>ImagePullBackOff</code>.</p><p>The example below is based on a <a href=https://kubernetes.io/docs/tasks/debug-application-cluster/determine-reason-pod-failure/>demo in the Kubernetes documentation</a>. In all examples, the <code>default</code> namespace is used.</p><p>First, perform a cleanup with:</p><p><code>kubectl delete pod termination-demo</code></p><p>Next, create a resource based on the yaml content below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Pod 
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: termination-demo
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  containers:
</span></span><span style=display:flex><span>  - name: termination-demo-container
</span></span><span style=display:flex><span>    image: debiann
</span></span><span style=display:flex><span>    command: [<span style=color:#a31515>&#34;/bin/sh&#34;</span>]
</span></span><span style=display:flex><span>    args: [<span style=color:#a31515>&#34;-c&#34;</span>, <span style=color:#a31515>&#34;sleep 10 &amp;&amp; echo Sleep expired &gt; /dev/termination-log&#34;</span>]
</span></span></code></pre></div><p><code>kubectl describe pod termination-demo</code> lists in the <code>Event</code> section the content</p><pre tabindex=0><code>Events:
  FirstSeen	LastSeen	Count	From							SubObjectPath					Type		Reason			Message
  ---------	--------	-----	----							-------------					--------	------			-------
  2m		2m		1	default-scheduler											Normal		Scheduled		Successfully assigned termination-demo to ip-10-250-17-112.eu-west-1.compute.internal
  2m		2m		1	kubelet, ip-10-250-17-112.eu-west-1.compute.internal							Normal		SuccessfulMountVolume	MountVolume.SetUp succeeded for volume &#34;default-token-sgccm&#34; 
  2m		1m		4	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers{termination-demo-container}	Normal		Pulling			pulling image &#34;debiann&#34;
  2m		1m		4	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers{termination-demo-container}	Warning		Failed			Failed to pull image &#34;debiann&#34;: rpc error: code = Unknown desc = Error: image library/debiann:latest not found
  2m		54s		10	kubelet, ip-10-250-17-112.eu-west-1.compute.internal							Warning		FailedSync		Error syncing pod
  2m		54s		6	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers{termination-demo-container}	Normal		BackOff			Back-off pulling image &#34;debiann&#34;
</code></pre><p>The error message with <code>Reason: Failed</code> tells you that there is an error during pulling the image. A closer look at the
image name indicates a misspelling.</p><h2 id=the-app-runs-in-an-error-state-caused-eg-by-missing-environmental-variables-configmaps-or-secrets>The App Runs in an Error State Caused e.g. by Missing Environmental Variables (ConfigMaps) or Secrets</h2><p>This example illustrates the behavior in the case when the app expects environment variables but the corresponding Kubernetes artifacts are missing.</p><p>First, perform a cleanup with:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kubectl delete deployment termination-demo
</span></span><span style=display:flex><span>kubectl delete configmaps app-env
</span></span></code></pre></div><p>Next, deploy the following manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: apps/v1beta2 
</span></span><span style=display:flex><span>kind: Deployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: termination-demo
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>     app: termination-demo
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  replicas: 1
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      app: termination-demo
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        app: termination-demo
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>      - name: termination-demo-container
</span></span><span style=display:flex><span>        image: debian
</span></span><span style=display:flex><span>        command: [<span style=color:#a31515>&#34;/bin/sh&#34;</span>]
</span></span><span style=display:flex><span>        args: [<span style=color:#a31515>&#34;-c&#34;</span>, <span style=color:#a31515>&#34;sed \&#34;s/foo/bar/\&#34; &lt; $MYFILE&#34;</span>]
</span></span></code></pre></div><p>Now, the command <code>kubectl get pods</code> lists the pod <code>termination-demo-xxx</code> in the state <code>Error</code> or <code>CrashLoopBackOff</code>.
The command <code>kubectl describe pod termination-demo-xxx</code> tells you that there is no error during startup but gives no clue about what caused the crash.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Events:
</span></span><span style=display:flex><span>  FirstSeen	LastSeen	Count	From							SubObjectPath					Type		Reason		Message
</span></span><span style=display:flex><span>  ---------	--------	-----	----							-------------					--------	------		-------
</span></span><span style=display:flex><span>  19m		19m		1	default-scheduler											Normal		Scheduled	Successfully assigned termination-demo-5fb484867d-xz2x9 to ip-10-250-17-112.eu-west-1.compute.internal
</span></span><span style=display:flex><span>  19m		19m		1	kubelet, ip-10-250-17-112.eu-west-1.compute.internal							Normal		SuccessfulMountVolume	MountVolume.SetUp succeeded <span style=color:#00f>for</span> volume <span style=color:#a31515>&#34;default-token-sgccm&#34;</span> 
</span></span><span style=display:flex><span>  19m		19m		4	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers{termination-demo-container}	Normal		Pulling		pulling image <span style=color:#a31515>&#34;debian&#34;</span>
</span></span><span style=display:flex><span>  19m		19m		4	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers{termination-demo-container}	Normal		Pulled		Successfully pulled image <span style=color:#a31515>&#34;debian&#34;</span>
</span></span><span style=display:flex><span>  19m		19m		4	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers{termination-demo-container}	Normal		Created		Created container
</span></span><span style=display:flex><span>  19m		19m		4	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers{termination-demo-container}	Normal		Started		Started container
</span></span><span style=display:flex><span>  19m		14m		24	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers{termination-demo-container}	Warning		BackOff		Back-off restarting failed container
</span></span><span style=display:flex><span>  19m		4m		69	kubelet, ip-10-250-17-112.eu-west-1.compute.internal							Warning		FailedSync	Error syncing pod
</span></span></code></pre></div><p>The command <code>kubectl get logs termination-demo-xxx</code> gives access to the output, the application writes on <code>stderr</code> and
<code>stdout</code>. In this case, you should get an output similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/bin/sh: 1: cannot open : No such file
</span></span></code></pre></div><p>So you need to have a closer look at the application. In this case, the environmental variable <code>MYFILE</code> is missing. To fix this
issue, you could e.g. add a ConfigMap to your deployment as is shown in the manifest listed below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: ConfigMap
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: app-env
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  MYFILE: <span style=color:#a31515>&#34;/etc/profile&#34;</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: apps/v1beta2 
</span></span><span style=display:flex><span>kind: Deployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: termination-demo
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>     app: termination-demo
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  replicas: 1
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      app: termination-demo
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        app: termination-demo
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>      - name: termination-demo-container
</span></span><span style=display:flex><span>        image: debian
</span></span><span style=display:flex><span>        command: [<span style=color:#a31515>&#34;/bin/sh&#34;</span>]
</span></span><span style=display:flex><span>        args: [<span style=color:#a31515>&#34;-c&#34;</span>, <span style=color:#a31515>&#34;sed \&#34;s/foo/bar/\&#34; &lt; $MYFILE&#34;</span>]
</span></span><span style=display:flex><span>        envFrom:
</span></span><span style=display:flex><span>        - configMapRef:
</span></span><span style=display:flex><span>            name: app-env 
</span></span></code></pre></div><p>Note that once you fix the error and re-run the scenario, you might still see the pod in a <code>CrashLoopBackOff</code> status.
It is because the container finishes the command <code>sed ...</code> and runs to completion. In order to keep the container in a <code>Running</code> status,
a long running task is required, e.g.:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: ConfigMap
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: app-env
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  MYFILE: <span style=color:#a31515>&#34;/etc/profile&#34;</span>
</span></span><span style=display:flex><span>  SLEEP: <span style=color:#a31515>&#34;5&#34;</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: apps/v1beta2
</span></span><span style=display:flex><span>kind: Deployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: termination-demo
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>     app: termination-demo
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  replicas: 1
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      app: termination-demo
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        app: termination-demo
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>      - name: termination-demo-container
</span></span><span style=display:flex><span>        image: debian
</span></span><span style=display:flex><span>        command: [<span style=color:#a31515>&#34;/bin/sh&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:green># args: [&#34;-c&#34;, &#34;sed \&#34;s/foo/bar/\&#34; &lt; $MYFILE&#34;]</span>
</span></span><span style=display:flex><span>        args: [<span style=color:#a31515>&#34;-c&#34;</span>, <span style=color:#a31515>&#34;while true; do sleep $SLEEP; echo sleeping; done;&#34;</span>]
</span></span><span style=display:flex><span>        envFrom:
</span></span><span style=display:flex><span>        - configMapRef:
</span></span><span style=display:flex><span>            name: app-env
</span></span></code></pre></div><h2 id=too-high-resource-consumption-memory-andor-cpu-or-too-strict-quota-settings>Too High Resource Consumption (Memory and/or CPU) or Too Strict Quota Settings</h2><p>You can optionally specify the amount of memory and/or CPU your container gets during runtime. In case these settings are missing,
the default requests settings are taken: CPU: 0m (in Milli CPU) and RAM: 0Gi, which indicate no other limits other than the
ones of the node(s) itself. For more details, e.g. about how to configure limits, see <a href=https://kubernetes.io/docs/tasks/administer-cluster/memory-default-namespace/>Configure Default Memory Requests and Limits for a Namespace</a>.</p><p>In case your application needs more resources, Kubernetes distinguishes between <code>requests</code> and <code>limit</code> settings: <code>requests</code>
specify the guaranteed amount of resource, whereas <code>limit</code> tells Kubernetes the maximum amount of resource the container might
need. Mathematically, both settings could be described by the relation <code>0 &lt;= requests &lt;= limit</code>. For both settings you need to
consider the total amount of resources your nodes provide. For a detailed description of the concept, see <a href=https://github.com/kubernetes/design-proposals-archive/blob/main/node/resource-qos.md>Resource Quality of Service in Kubernetes</a>.</p><p>Use <code>kubectl describe nodes</code> to get a first overview of the resource consumption in your cluster. Of special interest are the
figures indicating the amount of CPU and Memory Requests at the bottom of the output.</p><p>The next example demonstrates what happens in case the CPU request is too high in order to be managed by your cluster.</p><p>First, perform a cleanup with:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kubectl delete deployment termination-demo
</span></span><span style=display:flex><span>kubectl delete configmaps app-env
</span></span></code></pre></div><p>Next, adapt the <code>cpu</code> below in the yaml below to be slightly higher than the remaining CPU resources in your cluster and deploy
this manifest. In this example, <code>600m</code> (milli CPUs) are requested in a Kubernetes system with a single 2 core worker
node which results in an error message.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: apps/v1beta2 
</span></span><span style=display:flex><span>kind: Deployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: termination-demo
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>     app: termination-demo
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  replicas: 1
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      app: termination-demo
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        app: termination-demo
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>      - name: termination-demo-container
</span></span><span style=display:flex><span>        image: debian
</span></span><span style=display:flex><span>        command: [<span style=color:#a31515>&#34;/bin/sh&#34;</span>]
</span></span><span style=display:flex><span>        args: [<span style=color:#a31515>&#34;-c&#34;</span>, <span style=color:#a31515>&#34;sleep 10 &amp;&amp; echo Sleep expired &gt; /dev/termination-log&#34;</span>]
</span></span><span style=display:flex><span>        resources:
</span></span><span style=display:flex><span>          requests:
</span></span><span style=display:flex><span>            cpu: <span style=color:#a31515>&#34;600m&#34;</span> 
</span></span></code></pre></div><p>The command <code>kubectl get pods</code> lists the pod <code>termination-demo-xxx</code> in the state <code>Pending</code>. More details on why this happens
could be found by using the command <code>kubectl describe pod termination-demo-xxx</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl describe po termination-demo-fdb7bb7d9-mzvfw
</span></span><span style=display:flex><span>Name:           termination-demo-fdb7bb7d9-mzvfw
</span></span><span style=display:flex><span>Namespace:      default
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Containers:
</span></span><span style=display:flex><span>  termination-demo-container:
</span></span><span style=display:flex><span>    Image:      debian
</span></span><span style=display:flex><span>    Port:       &lt;none&gt;
</span></span><span style=display:flex><span>    Host Port:  &lt;none&gt;
</span></span><span style=display:flex><span>    Command:
</span></span><span style=display:flex><span>      /bin/sh
</span></span><span style=display:flex><span>    Args:
</span></span><span style=display:flex><span>      -c
</span></span><span style=display:flex><span>      sleep 10 &amp;&amp; echo Sleep expired &gt; /dev/termination-log
</span></span><span style=display:flex><span>    Requests:
</span></span><span style=display:flex><span>      cpu:        6
</span></span><span style=display:flex><span>    Environment:  &lt;none&gt;
</span></span><span style=display:flex><span>    Mounts:
</span></span><span style=display:flex><span>      /var/run/secrets/kubernetes.io/serviceaccount from default-token-t549m (ro)
</span></span><span style=display:flex><span>Conditions:
</span></span><span style=display:flex><span>  Type           Status
</span></span><span style=display:flex><span>  PodScheduled   False
</span></span><span style=display:flex><span>Events:
</span></span><span style=display:flex><span>  Type     Reason            Age               From               Message
</span></span><span style=display:flex><span>  ----     ------            ----              ----               -------
</span></span><span style=display:flex><span>  Warning  FailedScheduling  9s (x7 over 40s)  default-scheduler  0/2 nodes are available: 2 Insufficient cpu.
</span></span></code></pre></div><p>You can find more details in:</p><ul><li><a href=https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/>Managing Compute Resources for Containters</a></li><li><a href=https://github.com/kubernetes/design-proposals-archive/blob/main/node/resource-qos.md>Resource Quality of Service in Kubernetes</a></li></ul><p>Remarks:</p><ul><li>This example works similarly when specifying a too high request for memory</li><li>In case you configured an autoscaler range when creating your Kubernetes cluster, another worker node will be spinned up automatically if you didn&rsquo;t reach the maximum number of worker nodes</li><li>In case your app is running out of memory (the memory settings are too small), you will typically find an <code>OOMKilled</code> (Out Of Memory) message in the <code>Events</code> section of the <code>kubectl describe pod ...</code> output</li></ul><h2 id=the-container-image-is-not-updated>The Container Image Is Not Updated</h2><p>You applied a fix in your app, created a new container image and pushed it into your container repository. After redeploying your Kubernetes manifests, you expected to get the updated app, but the same bug is still in the new deployment present.</p><p>This behavior is related to how Kubernetes decides whether to pull a new docker image or to use the cached one.</p><p>In case you didn&rsquo;t change the image tag, the default image policy <em>IfNotPresent</em> tells Kubernetes to use the cached image (see <a href=https://kubernetes.io/docs/concepts/containers/images/>Images</a>).</p><p>As a best practice, you should not use the tag <code>latest</code> and change the image tag in case you changed anything in your image (see <a href=https://kubernetes.io/docs/concepts/configuration/overview/#container-images>Configuration Best Practices</a>).</p><p>Please have a look at this FAQ <a href=https://github.tools.sap/kubernetes/documentation/blob/master/website/documentation/015-tutorials/image-pull-policy/_index.md>Container Image Not Updating</a> for further details.</p><h2 id=related-links>Related Links</h2><ul><li><a href=https://kubernetes.io/docs/tasks/debug-application-cluster/debug-application-introspection/>Application Introspection and Debugging</a></li><li><a href=https://kubernetes.io/docs/tasks/debug-application-cluster/debug-pod-replication-controller/>Debug Pods and Replication Controllers</a></li><li><a href=https://kubernetes.io/docs/concepts/cluster-administration/logging/>Logging Architecture</a></li><li><a href=https://kubernetes.io/docs/tasks/administer-cluster/memory-default-namespace/>Configure Default Memory Requests and Limits for a Namespace</a></li><li><a href=https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/>Managing Compute Resources for Containters</a></li><li><a href=https://github.com/kubernetes/design-proposals-archive/blob/main/node/resource-qos.md>Resource Quality of Service in Kubernetes</a></li><li><a href=https://kubernetes.io/docs/tutorials/kubernetes-basics/explore-intro/>Interactive Tutorial Troubleshooting with Kubectl</a></li><li><a href=https://kubernetes.io/docs/concepts/containers/images/>Images</a></li><li><a href=https://kubernetes.io/docs/concepts/configuration/overview/#container-images>Kubernetes Best Practises</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-cce198c05b67d5037cc341751389bfc6>4 - tail -f /var/log/my-application.log</h1><div class=lead>Aggregate log files from different pods</div><h2 id=problem>Problem</h2><p>One thing that always bothered me was that I couldn&rsquo;t get logs of several pods at once with <code>kubectl</code>. A simple
<code>tail -f &lt;path-to-logfile></code> isn&rsquo;t possible at all. Certainly, you can use <code>kubectl logs -f &lt;pod-id></code>, but it doesn&rsquo;t
help if you want to monitor more than one pod at a time.</p><p>This is something you really need a lot, at least if you run several instances of a pod behind a <code>deployment</code>.
This is even more so if you don&rsquo;t have a Kibana or a similar setup.</p><img src=/__resources/howto-kubetail_7acd68.png width=100%><h2 id=solution>Solution</h2><p>Luckily, there are smart developers out there who always come up with solutions. The <strong>finding of the week</strong> is
a small bash script that allows you to aggregate log files of several pods at the same time in
a simple way. The script is called <code>kubetail</code> and is available at
<a href=https://github.com/johanhaleby/kubetail>GitHub</a>.</p></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2023 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid@8.13.4/dist/mermaid.min.js integrity="sha512-JERecFUBbsm75UpkVheAuDOE8NdHjQBrPACfEQYPwvPG+fjgCpHAz1Jw2ci9EXmd3DdfiWth3O3CQvcfEg8gsA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.7b24c0fb082ffb2de6cb14d6c95e9f8053053709ffcf8c761ef8e9ad2f8021e4.js integrity="sha256-eyTA+wgv+y3myxTWyV6fgFMFNwn/z4x2HvjprS+AIeQ=" crossorigin=anonymous></script></body></html>