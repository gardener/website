<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=https://gardener.cloud/docs/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/index.xml><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=icon type=image/x-icon href=https://gardener.cloud/images/favicon.ico><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-16x16.png sizes=16x16><title>Docs | Gardener</title><meta name=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:title" content="Docs"><meta property="og:description" content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:type" content="website"><meta property="og:url" content="https://gardener.cloud/docs/"><meta itemprop=name content="Docs"><meta itemprop=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta name=twitter:card content="summary"><meta name=twitter:title content="Docs"><meta name=twitter:description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><link rel=preload href=/scss/main.min.122f9effc36493edf1f25030c2ce7965b16b3b0eaeb02528b9a50e0fa9110c15.css as=style><link href=/scss/main.min.122f9effc36493edf1f25030c2ce7965b16b3b0eaeb02528b9a50e0fa9110c15.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.1668e11b7fc7bdcbfd964df4673481e2.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/>Return to the regular view of this page</a>.</p></div><h1 class=title>Docs</h1><div class=content></div></div><div class=td-content><h1 id=pg-dd948255948d6b59b32c471abcb62997>1 - Concepts</h1><div class=lead>Explore the concepts on which Gardener is built</div></div><div class=td-content><h1 id=pg-2bf36ccd6b3dbeafecf87c39761b07c7>1.1 - Architecture</h1><h4 id=official-definition---what-is-kubernetes>Official Definition - What is Kubernetes?</h4><blockquote><p>&ldquo;Kubernetes is an open-source system for automating deployment, scaling, and management of containerized applications.&rdquo;</p></blockquote><h4 id=introduction---basic-principle>Introduction - Basic Principle</h4><p>The foundation of the Gardener (providing <em><strong>Kubernetes Clusters as a Service</strong></em>) is Kubernetes itself, because Kubernetes is the go-to solution to manage software in the Cloud, even when it&rsquo;s Kubernetes itself (see also OpenStack which is provisioned more and more on top of Kubernetes as well).</p><p>While self-hosting, meaning to run Kubernetes components inside Kubernetes, is a popular topic in the community, we apply a special pattern catering to the needs of our cloud platform to provision hundreds or even thousands of clusters. We take a so-called &ldquo;seed&rdquo; cluster and seed the control plane (such as the API server, scheduler, controllers, etcd persistence and others) of an end-user cluster, which we call &ldquo;shoot&rdquo; cluster, as pods into the &ldquo;seed&rdquo; cluster. That means one &ldquo;seed&rdquo; cluster, of which we will have one per IaaS and region, hosts the control planes of multiple &ldquo;shoot&rdquo; clusters. That allows us to avoid dedicated hardware/virtual machines for the &ldquo;shoot&rdquo; cluster control planes. We simply put the control plane into pods/containers and since the &ldquo;seed&rdquo; cluster watches them, they can be deployed with a replica count of 1 and only need to be scaled out when the control plane gets under pressure, but no longer for HA reasons. At the same time, the deployments get simpler (standard Kubernetes deployment) and easier to update (standard Kubernetes rolling update). The actual &ldquo;shoot&rdquo; cluster consists only out of the worker nodes (no control plane) and therefore the users may get full administrative access to their clusters.</p><h4 id=setting-the-scene---components-and-procedure>Setting The Scene - Components and Procedure</h4><p>We provide a central operator UI, which we call the &ldquo;Gardener Dashboard&rdquo;. It talks to a dedicated cluster, which we call the &ldquo;Garden&rdquo; cluster and uses custom resources managed by an <a href=https://kubernetes.io/docs/concepts/api-extension/custom-resources/#api-server-aggregation>aggregated API server</a>, one of the general extension concepts of Kubernetes) to represent &ldquo;shoot&rdquo; clusters. In this &ldquo;Garden&rdquo; cluster runs the &ldquo;Gardener&rdquo;, which is basically a Kubernetes controller that watches the custom resources and acts upon them, i.e. creates, updates/modifies, or deletes &ldquo;shoot&rdquo; clusters. The creation follows basically these steps:</p><ul><li>Create a namespace in the &ldquo;seed&rdquo; cluster for the &ldquo;shoot&rdquo; cluster which will host the &ldquo;shoot&rdquo; cluster control plane</li><li>Generate secrets and credentials which the worker nodes will need to talk to the control plane</li><li>Create the infrastructure (using <a href=https://www.terraform.io/>Terraform</a>), which basically consists out of the network setup)</li><li>Deploy the &ldquo;shoot&rdquo; cluster control plane into the &ldquo;shoot&rdquo; namespace in the &ldquo;seed&rdquo; cluster, containing the &ldquo;machine-controller-manager&rdquo; pod</li><li>Create machine CRDs in the &ldquo;seed&rdquo; cluster, describing the configuration and the number of worker machines for the &ldquo;shoot&rdquo; (the machine-controller-manager watches the CRDs and creates virtual machines out of it)</li><li>Wait for the &ldquo;shoot&rdquo; cluster API server to become responsive (pods will be scheduled, persistent volumes and load balancers are created by Kubernetes via the respective cloud provider)</li><li>Finally we deploy <code>kube-system</code> daemons like <code>kube-proxy</code> and further add-ons like the <code>dashboard</code> into the &ldquo;shoot&rdquo; cluster and the cluster becomes active</li></ul><h4 id=overview-architecture-diagram>Overview Architecture Diagram</h4><p><img src=/__resources/gardener-architecture-overview_353f79.png alt="Gardener Overview Architecture Diagram"></p><h4 id=detailed-architecture-diagram>Detailed Architecture Diagram</h4><p><img src=/__resources/gardener-architecture-detailed_8aedbd.png alt="Gardener Detailed Architecture Diagram"></p><p>Note: The <code>kubelet</code> as well as the pods inside the &ldquo;shoot&rdquo; cluster talk through the front-door (load balancer IP; public Internet) to its &ldquo;shoot&rdquo; cluster API server running in the &ldquo;seed&rdquo; cluster. The reverse communication from the API server to the pod, service, and node networks happens through a VPN connection that we deploy into &ldquo;seed&rdquo; and &ldquo;shoot&rdquo; clusters.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4d57969da4950711f3ac1b51fd0b28de>1.1.1 - Dashboard</h1><h1 id=gardener-dashboard>Gardener Dashboard</h1><p><img src=https://github.com/gardener/dashboard/raw/master/logo/logo_gardener_dashboard.png alt></p><p><a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/dashboard-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/dashboard-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://kubernetes.slack.com/messages/gardener><img src="https://img.shields.io/badge/slack-gardener-brightgreen.svg?logo=slack" alt="Slack channel #gardener"></a></p><h2 id=demo>Demo</h2><p><img src=/__resources/dashboard-demo_f287c1.gif alt="Gardener Demo"></p><h2 id=documentation>Documentation</h2><p><a href=https://github.com/gardener/dashboard/blob/master/docs/README.md>Gardener Dashboard Documentation</a></p><h2 id=people>People</h2><p>The following SAP developers contributed to this project until this
initial contribution was published as open source.</p><table><thead><tr><th>contributor</th><th style=text-align:right>commits (%)</th><th style=text-align:right>+lines</th><th style=text-align:right>-lines</th><th>first commit</th><th>last commit</th></tr></thead><tbody><tr><td>Holger Koser</td><td style=text-align:right>313 (42%)</td><td style=text-align:right>57878</td><td style=text-align:right>18562</td><td>2017-07-13</td><td>2018-01-23</td></tr><tr><td>Andreas Herz</td><td style=text-align:right>307 (41%)</td><td style=text-align:right>13666</td><td style=text-align:right>11099</td><td>2017-07-14</td><td>2017-10-27</td></tr><tr><td>Peter Sutter</td><td style=text-align:right>99 (13%)</td><td style=text-align:right>4838</td><td style=text-align:right>3967</td><td>2017-11-07</td><td>2018-01-23</td></tr><tr><td>Gross, Lukas</td><td style=text-align:right>31 (4%)</td><td style=text-align:right>400</td><td style=text-align:right>267</td><td>2018-01-10</td><td>2018-01-23</td></tr></tbody></table><p>It is derived from the historical, internal <em>gardener-ui</em> repository
at commit eeb623d60c86e6037c0e1dc2bdd9e54663bf41a8.</p><h2 id=license>License</h2><p><a href=https://github.com/gardener/dashboard/blob/master/LICENSES/Apache-2.0.txt>Apache License 2.0</a></p><p>Copyright 2020 The Gardener Authors</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e8a1c9bf46e31cb2cccbc55b4abf22f2>1.1.2 - gardenctl</h1><h1 id=gardenctl>Gardenctl</h1><p><img src=https://github.com/gardener/gardenctl/raw/master/logo/logo_gardener_cli_large.png alt></p><p><a href=https://goreportcard.com/report/github.com/gardener/gardenctl><img src=https://goreportcard.com/badge/github.com/gardener/gardenctl alt="Go Report Card"></a>
<a href=https://badge.fury.io/gh/gardener%2Fgardenctl><img src=https://badge.fury.io/gh/gardener%2Fgardenctl.svg alt=release></a></p><h1 id=what-is-gardenctl>What is gardenctl?</h1><p><code>gardenctl</code> is a command-line client for administrative purposes for the <a href=https://github.com/gardener/gardener>Gardener</a>. It facilitates the administration of one or many garden, seed and shoot clusters, e.g. to check for issues which occured in one of these clusters. Details about the concept behind the Gardener are described in the <a href=https://github.com/gardener/documentation/wiki/Architecture>Gardener wiki</a>.</p><h1 id=installation>Installation</h1><p><code>gardenctl</code> is shipped for mac and linux in a binary format.</p><p>Option 1: Install the latest release with <a href=https://brew.sh/>Homebrew</a> (macOS and Linux) as follows:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>brew install gardener/tap/gardenctl
</code></pre></div><p>Option 2: Manually download and install from <a href=https://github.com/gardener/gardenctl/releases>gardenctl releases</a> as follows:</p><ol><li>Download the latest release:</li></ol><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>curl -LO https://github.com/gardener/gardenctl/releases/download/<span class=k>$(</span>curl -s https://raw.githubusercontent.com/gardener/gardenctl/master/LATEST<span class=k>)</span>/gardenctl-darwin-amd64
</code></pre></div><p>To download a specific version, replace the <code>$(curl -s https://raw.githubusercontent.com/gardener/gardenctl/master/LATEST)</code> portion of the command with the specific version.</p><p>For example, to download version 0.16.0 on macOS, type:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>curl -LO https://github.com/gardener/gardenctl/releases/download/v0.16.0/gardenctl-darwin-amd64
</code></pre></div><ol start=2><li>Make the gardenctl binary executable.</li></ol><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>chmod +x ./gardenctl-darwin-amd64
</code></pre></div><ol start=3><li>Move the binary in to your PATH.</li></ol><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo mv ./gardenctl-darwin-amd64 /usr/local/bin/gardenctl
</code></pre></div><h1 id=how-to-build-it>How to build it</h1><p>If no binary builds are available for your platform or architecture, you can build it from source, <code>go get</code> it or build the docker image from Dockerfile. Please keep in mind to use an up to date version of <a href=https://golang.org/doc/devel/release.html>golang</a>.</p><h2 id=prerequisites>Prerequisites</h2><p>To build <code>gardenctl</code> from sources you need to have a running Golang environment. Moreover, since <code>gardenctl</code> allows to execute <code>kubectl</code> as well as a running <code>kubectl</code> installation is recommended, but not required. Please check this <a href=https://github.com/gardener/gardener/blob/master/docs/development/local_setup.md>description</a> for further details.</p><h2 id=build-gardenctl>Build gardenctl</h2><h3 id=from-source>From source</h3><p>First, you need to clone the repository and build <code>gardenctl</code>.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>git clone https://github.com/gardener/gardenctl.git
<span class=nb>cd</span> gardenctl
make build
</code></pre></div><p>After successfully building <code>gardenctl</code> the executables are in the directory <code>~/go/src/github.com/gardener/gardenctl/bin/</code>. Next, move the executable for your architecture to <code>/usr/local/bin</code>. In this case for darwin-amd64.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo mv bin/darwin-amd64/gardenctl-darwin-amd64 /usr/local/bin/gardenctl
</code></pre></div><p><code>gardenctl</code> supports auto completion. This recommended feature is bound to <code>gardenctl</code> or the alias <code>g</code>. To configure it you can run:</p><p>if you are using <code>bash</code>:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>echo</span> <span class=s2>&#34;source &lt;(gardenctl completion bash)&#34;</span> &gt;&gt; ~/.bashrc
<span class=nb>source</span> ~/.bashrc
</code></pre></div><p>if you are using <code>zsh</code>:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>echo</span> <span class=s2>&#34;source &lt;(gardenctl completion zsh)&#34;</span> &gt;&gt; ~/.zshrc
<span class=nb>source</span> ~/.zshrc
</code></pre></div><h3 id=via-dockerfile>Via Dockerfile</h3><p>First clone the repository as described in the the build step &ldquo;From source&rdquo;. As next step add the garden &ldquo;config&rdquo; file and &ldquo;clusters&rdquo; folder with the corresponding kubeconfig files for the garden cluster. Then build the container image via <code>docker build -t gardener/gardenctl:v1 .</code> in the cloned repository and run a shell in the image with <code>docker run -it gardener/gardenctl:v1 /bin/bash</code>.</p><h1 id=configure-gardenctl>Configure gardenctl</h1><p><code>gardenctl</code> requires a configuration file. The default location is in <code>~/.garden/config</code>, but it can be overwritten with the environment variable <code>GARDENCONFIG</code>.</p><p>Here an example file:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>email</span><span class=p>:</span><span class=w> </span><span class=l>john.doe@example.com</span><span class=w>
</span><span class=w></span><span class=nt>githubURL</span><span class=p>:</span><span class=w> </span><span class=l>https://github.location.company.corp</span><span class=w>
</span><span class=w></span><span class=nt>gardenClusters</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w>  </span><span class=nt>kubeConfig</span><span class=p>:</span><span class=w> </span><span class=l>~/clusters/dev/kubeconfig.yaml</span><span class=w>
</span><span class=w>  </span><span class=nt>dashboardUrl</span><span class=p>:</span><span class=w> </span><span class=l>https://url_to_dashboard</span><span class=w>
</span><span class=w>  </span><span class=nt>accessRestrictions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>seed.gardener.cloud/eu-access</span><span class=w>
</span><span class=w>    </span><span class=nt>notifyIf</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w> 
</span><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=l>warning msg</span><span class=w>
</span><span class=w>    </span><span class=nt>options</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>support.gardener.cloud/eu-access-for-cluster-addons</span><span class=w>
</span><span class=w>      </span><span class=nt>notifyIf</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=l>warning msg</span><span class=w>
</span><span class=w>    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>support.gardener.cloud/eu-access-for-cluster-nodes</span><span class=w>
</span><span class=w>      </span><span class=nt>notifyIf</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=l>warning msg</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prod</span><span class=w>
</span><span class=w>  </span><span class=nt>kubeConfig</span><span class=p>:</span><span class=w> </span><span class=l>~/clusters/prod/kubeconfig.yaml</span><span class=w>
</span></code></pre></div><p>The path to the kubeconfig files of a garden cluster can be relative by using the ~ (tilde) expansion or absolute.</p><p><code>gardenctl</code> caches some information, e.g. the garden project names. The location of this cache is per default <code>$GARDENCTL_HOME/cache</code>. If <code>GARDENCTL_HOME</code> is not set, <code>~/.garden</code> is assumed.</p><p><code>gardenctl</code> supports multiple sessions. The session ID can be set via <code>$GARDEN_SESSION_ID</code> and the sessions are stored under <code>$GARDENCTL_HOME/sessions</code>.</p><p><code>gardenctl</code> makes it easy to get additional information of your IaaS provider by using the secrets stored in the corresponding projects in the Gardener. To use this functionality, the CLIs of the IaaS providers need to be available.</p><p>Please check the IaaS provider documentation for more details about their CLIs.</p><ul><li><a href=https://github.com/aliyun/aliyun-cli>aliyun</a></li><li><a href=https://aws.amazon.com/cli/>aws</a></li><li><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">az</a></li><li><a href=https://cloud.google.com/sdk/downloads>gcloud</a></li><li><a href=https://pypi.python.org/pypi/python-openstackclient>openstack</a></li></ul><p>Moreover, <code>gardenctl</code> offers auto completion. To use it, the command</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>gardenctl completion bash
</code></pre></div><p>print on the standard output a completion script which can be sourced via</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>source</span> &lt;<span class=o>(</span>gardenctl completion bash<span class=o>)</span>
</code></pre></div><p>Please keep in mind that the auto completion is bound to <code>gardenctl</code> or the alias <code>g</code>.</p><h1 id=use-gardenctl>Use gardenctl</h1><p><code>gardenctl</code> requires the definition of a target, e.g. garden, project, seed or shoot. The following commands, e.g. <code>gardenctl ls shoots</code> uses the target definition as a context for getting the information.</p><p>Targets represent a hierarchical structure of resources. On top, there is/are the garden/s. E.g. in case you setup a development and a production garden, you would have two entries in your <code>~/.garden/config</code>. Via <code>gardenctl ls gardens</code> you get a list of the available gardens.</p><ul><li><code>gardenctl get target</code><br>Displays the current target</li><li><code>gardenctl target [garden|project|seed|shoot]</code><br>Set the target e.g. to a garden. It is as well possible to set the target directly to a element deeper in the hierarchy, e.g. to a shoot.</li><li><code>gardenctl drop target</code><br>Drop the deepest target.</li></ul><h2 id=examples-of-basic-usage>Examples of basic usage:</h2><ul><li>List all seed cluster<br><code>gardenctl ls seeds</code></li><li>List all projects with shoot cluster<br><code>gardenctl ls projects</code></li><li>Target a seed cluster<br><code>gardenctl target seed-gce-dev</code></li><li>Target a project<br><code>gardenctl target garden-vora</code></li><li>Open prometheus ui for a targeted shoot-cluster<br><code>gardenctl show prometheus</code></li><li>Execute an aws command on a targeted aws shoot cluster<br><code>gardenctl aws ec2 describe-instances</code> or<br><code>gardenctl aws ec2 describe-instances --no-cache</code> without locally caching credentials</li><li>Target a shoot directly and get all kube-dns pods in kube-system namespace<br><code>gardenctl target myshoot</code><br><code>gardenctl kubectl get pods -- -n kube-system -l k8s-app=kube-dns</code></li><li>List all cluster with an issue<br><code>gardenctl ls issues</code></li><li>Drop an element from target stack<br><code>gardenctl drop</code></li><li>Open a shell to a cluster node<br><code>gardenctl shell nodename</code></li><li>Show logs from elasticsearch<br><code>gardenctl logs etcd-main --elasticsearch</code></li><li>Show last 100 logs from elasticsearch from the last 2 hours<br><code>gardenctl logs etcd-main --elasticsearch --since=2h --tail=100</code></li><li>Show logs from seed nodes<br><code>gardenctl target -g garden-name -s seed-name</code><br><code>gardenctl logs tf infra shoot-name</code></li><li>Show logs from shoot nodes<br><code>gardenctl target -g garden-name -t shoot-name</code><br><code>gardenctl logs api | scheduler | controller-manager | etcd-main -c etcd |etcd-main -c backup-restore | vpn-seed | vpn-shoot | machine-controller-manager | prometheus |grafana | cluster-autoscaler</code></li><li>Show logs from garden nodes<br><code>gardenctl target -g garden-name</code><br><code>gardenctl logs gardener-apiserver | gardener-controller-manager</code></li><li>SSH to shoot nodes (please unset any proxy env vars like <code>HTTPS</code> and <code>HTTP</code> before this command)<br><code>gardenctl k get nodes</code><br><code>gardenctl ssh node_name</code></li></ul><h2 id=advanced-usage-based-on-jsonquery>Advanced usage based on JsonQuery</h2><p>The following examples are based on <a href=https://stedolan.github.io/jq/>jq</a>. The <a href="https://jqplay.org/jq?q=.%5B%5D&j=%5B%5D">Json Query Playground</a> offers a convenient environment to test the queries.</p><p>Below a list of examples:</p><ul><li>List the project name, shoot name and the state for all projects with issues</li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>gardenctl ls issues -o json <span class=p>|</span> jq <span class=s1>&#39;.issues[] | { project: .project, shoot: .shoot, state: .status.lastOperation.state }&#39;</span>
</code></pre></div><ul><li>Print all issues of a single project e.g. <code>garden-myproject</code></li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>gardenctl ls issues -o json <span class=p>|</span> jq <span class=s1>&#39;.issues[] | if (.project==&#34;garden-myproject&#34;) then . else empty end&#39;</span> 
</code></pre></div><ul><li>Print all issues with error state &ldquo;Error&rdquo;</li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>gardenctl ls issues -o json <span class=p>|</span> jq <span class=s1>&#39;.issues[] | if (.status.lastOperation.state==&#34;Error&#34;) then . else empty end&#39;</span>
</code></pre></div><ul><li>Print all issues with error state not equal &ldquo;Succeded&rdquo;</li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>gardenctl ls issues -o json <span class=p>|</span> jq <span class=s1>&#39;.issues[] | if (.status.lastOperation.state!=&#34;Succeeded&#34;) then . else empty end&#39;</span>
</code></pre></div><ul><li>Print <code>createdBy</code> information (typically email addresses) of all shoots</li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>gardenctl k get shoots -- -n garden-core -o json <span class=p>|</span> jq -r <span class=s2>&#34;.items[].metadata | {email: .annotations.\&#34;garden.sapcloud.io/createdBy\&#34;, name: .name, namespace: .namespace}&#34;</span>
</code></pre></div><p>Here a few on cluster analysis:</p><ul><li>Which states are there and how many clusters are in this state?</li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>gardenctl ls issues -o json <span class=p>|</span> jq <span class=s1>&#39;.issues | group_by( .status.lastOperation.state ) | .[] | {state:.[0].status.lastOperation.state, count:length}&#39;</span>
</code></pre></div><ul><li>Get all clusters in state <code>Failed</code></li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>gardenctl ls issues -o json <span class=p>|</span> jq <span class=s1>&#39;.issues[] | if (.status.lastOperation.state==&#34;Failed&#34;) then . else empty end&#39;</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8c6dcf39b2a40a69f6c35ffc04fd8eeb>1.1.3 - Gardener</h1><h1 id=gardenerhttpsgardenercloud><a href=https://gardener.cloud>Gardener</a></h1><p><img src=https://github.com/gardener/gardener/raw/master/logo/gardener-large.png alt="Gardener Logo"></p><p><a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://kubernetes.slack.com/messages/gardener><img src="https://img.shields.io/badge/slack-gardener-brightgreen.svg?logo=slack" alt="Slack channel #gardener"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener><img src=https://goreportcard.com/badge/github.com/gardener/gardener alt="Go Report Card"></a>
<a href=https://godoc.org/github.com/gardener/gardener><img src=https://godoc.org/github.com/gardener/gardener?status.svg alt=GoDoc></a>
<a href=https://bestpractices.coreinfrastructure.org/projects/1822><img src=https://bestpractices.coreinfrastructure.org/projects/1822/badge alt="CII Best Practices"></a></p><p>Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service and provides a fully validated extensibility framework that can be adjusted to any programmatic cloud or infrastructure provider.</p><p>Gardener is 100% Kubernets-native and exposes its own Cluster API to create homogeneous clusters on all supported infrastructures. This API differs from <a href=https://github.com/kubernetes/community/tree/master/sig-cluster-lifecycle>SIG Cluster Lifecycle</a>&rsquo;s <a href=https://github.com/kubernetes-sigs/cluster-api#cluster-api>Cluster API</a> that only harmonizes how to get to clusters, while <a href=https://gardener.cloud/docs/references/core/#core.gardener.cloud/v1beta1.Shoot>Gardener&rsquo;s Cluster API</a> goes one step further and also harmonizes the make-up of the clusters themselves. That means, Gardener gives you homogeneous clusters with exactly the same bill of material, configuration and behavior on all supported infrastructures, which you can see further down below in the section on our K8s Conformance Test Coverage.</p><p>In 2020, SIG Cluster Lifecycle&rsquo;s Cluster API made a huge step forward with <a href=https://kubernetes.io/blog/2020/04/21/cluster-api-v1alpha3-delivers-new-features-and-an-improved-user-experience/><code>v1alpha3</code></a> and the newly added support for declarative control plane management. This made it possible to integrate managed services like GKE or Gardener. We would be more than happy, if the community would be interested, to contribute a Gardener control plane provider. For more information on the relation between Gardener API and SIG Cluster Lifecycle&rsquo;s Cluster API, please see <a href=https://github.com/gardener/gardener/blob/master/docs/concepts/cluster-api.md>here</a>.</p><p>Gardener&rsquo;s main principle is to <strong>leverage Kubernetes concepts for all of its tasks</strong>.</p><p>In essence, Gardener is an <a href=https://kubernetes.io/docs/tasks/access-kubernetes-api/setup-extension-api-server/>extension API server</a> that comes along with a bundle of custom controllers. It introduces new API objects in an existing Kubernetes cluster (which is called <strong>garden</strong> cluster) in order to use them for the management of end-user Kubernetes clusters (which are called <strong>shoot</strong> clusters). These shoot clusters are described via <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml>declarative cluster specifications</a> which are observed by the controllers. They will bring up the clusters, reconcile their state, perform automated updates and make sure they are always up and running.</p><p>To accomplish these tasks reliably and to offer a high quality of service, Gardener controls the main components of a Kubernetes cluster (etcd, API server, controller manager, scheduler). These so-called <em>control plane</em> components are hosted in Kubernetes clusters themselves (which are called <strong>seed</strong> clusters). This is the main difference compared to many other OSS cluster provisioning tools: The shoot clusters do not have dedicated master VMs. Instead, the control plane is deployed as a native Kubernetes workload into the seeds (the architecture is commonly referred to as kubeception or inception design). This does not only effectively reduce the total cost of ownership but also allows easier implementations for &ldquo;day-2 operations&rdquo; (like cluster updates or robustness) by relying on all the mature Kubernetes features and capabilities.</p><p>Gardener reuses the identical Kubernetes design to span a scalable multi-cloud and multi-cluster landscape. Such familiarity with known concepts has proven to quickly ease the initial learning curve and accelerate developer productivity:</p><ul><li>Kubernetes API Server = Gardener API Server</li><li>Kubernetes Controller Manager = Gardener Controller Manager</li><li>Kubernetes Scheduler = Gardener Scheduler</li><li>Kubelet = Gardenlet</li><li>Node = Seed cluster</li><li>Pod = Shoot cluster</li></ul><p>Please find more information regarding the concepts and a detailed description of the architecture in our <a href=https://github.com/gardener/documentation/wiki/Architecture>Gardener Wiki</a> and our blog posts on kubernetes.io: <a href=https://kubernetes.io/blog/2018/05/17/gardener>Gardener - the Kubernetes Botanist (17.5.2018)</a> and <a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update>Gardener Project Update (2.12.2019)</a>.</p><hr><h2 id=k8s-conformance-test-coverage-img-srchttpsrawgithubusercontentcomcncfartworkmasterprojectskubernetescertified-kubernetesversionlesscolorcertified-kubernetes-colorsvg-altcertified-kubernetes-logo-width50-alignright>K8s Conformance Test Coverage <img src=https://raw.githubusercontent.com/cncf/artwork/master/projects/kubernetes/certified-kubernetes/versionless/color/certified-kubernetes-color.svg alt="certified kubernetes logo" width=50 align=right></h2><p>Gardener takes part in the <a href=https://www.cncf.io/certification/software-conformance/>Certified Kubernetes Conformance Program</a> to attest its compatibility with the K8s conformance testsuite. Currently Gardener is certified for K8s versions up to v1.20, see <a href="https://docs.google.com/spreadsheets/d/1LxSqBzjOxfGx3cmtZ4EbB_BGCxT_wlxW_xgHVVa23es/edit#gid=0&range=113:114">the conformance spreadsheet</a>.</p><p>Continuous conformance test results of the latest stable Gardener release are uploaded regularly to the CNCF test grid:</p><table><thead><tr><th>Provider/K8s</th><th>v1.22</th><th>v1.21</th><th>v1.20</th><th>v1.19</th><th>v1.18</th><th>v1.17</th><th>v1.16</th><th>v1.15</th></tr></thead><tbody><tr><td><strong>AWS</strong></td><td>N/A</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.21%20AWS><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.21%20AWS/tests_status?style=svg" alt="Gardener v1.21 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.20%20AWS><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.20%20AWS/tests_status?style=svg" alt="Gardener v1.20 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.19%20AWS><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.19%20AWS/tests_status?style=svg" alt="Gardener v1.19 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.18%20AWS><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.18%20AWS/tests_status?style=svg" alt="Gardener v1.18 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.17%20AWS><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.17%20AWS/tests_status?style=svg" alt="Gardener v1.17 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.16%20AWS><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.16%20AWS/tests_status?style=svg" alt="Gardener v1.16 Conformance Tests"></a></td><td>[1]</td></tr><tr><td><strong>Azure</strong></td><td>N/A</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.21%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.21%20Azure/tests_status?style=svg" alt="Gardener v1.21 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.20%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.20%20Azure/tests_status?style=svg" alt="Gardener v1.20 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.19%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.19%20Azure/tests_status?style=svg" alt="Gardener v1.19 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.18%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.18%20Azure/tests_status?style=svg" alt="Gardener v1.18 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.17%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.17%20Azure/tests_status?style=svg" alt="Gardener v1.17 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.16%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.16%20Azure/tests_status?style=svg" alt="Gardener v1.16 Conformance Tests"></a></td><td>[1]</td></tr><tr><td><strong>GCP</strong></td><td>N/A</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.21%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.21%20GCE/tests_status?style=svg" alt="Gardener v1.21 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.20%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.20%20GCE/tests_status?style=svg" alt="Gardener v1.20 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.19%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.19%20GCE/tests_status?style=svg" alt="Gardener v1.19 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.18%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.18%20GCE/tests_status?style=svg" alt="Gardener v1.18 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.17%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.17%20GCE/tests_status?style=svg" alt="Gardener v1.17 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.16%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.16%20GCE/tests_status?style=svg" alt="Gardener v1.16 Conformance Tests"></a></td><td>[1]</td></tr><tr><td><strong>OpenStack</strong></td><td>N/A</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.21%20OpenStack><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.21%20OpenStack/tests_status?style=svg" alt="Gardener v1.21 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.20%20OpenStack><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.20%20OpenStack/tests_status?style=svg" alt="Gardener v1.20 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.19%20OpenStack><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.19%20OpenStack/tests_status?style=svg" alt="Gardener v1.19 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.18%20OpenStack><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.18%20OpenStack/tests_status?style=svg" alt="Gardener v1.18 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.17%20OpenStack><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.17%20OpenStack/tests_status?style=svg" alt="Gardener v1.17 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.16%20OpenStack><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.16%20OpenStack/tests_status?style=svg" alt="Gardener v1.16 Conformance Tests"></a></td><td>[1]</td></tr><tr><td><strong>Alicloud</strong></td><td>N/A</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.21%20Alibaba%20Cloud><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.21%20Alibaba%20Cloud/tests_status?style=svg" alt="Gardener v1.21 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.20%20Alibaba%20Cloud><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.20%20Alibaba%20Cloud/tests_status?style=svg" alt="Gardener v1.20 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.19%20Alibaba%20Cloud><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.19%20Alibaba%20Cloud/tests_status?style=svg" alt="Gardener v1.19 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.18%20Alibaba%20Cloud><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.18%20Alibaba%20Cloud/tests_status?style=svg" alt="Gardener v1.18 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.17%20Alibaba%20Cloud><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.17%20Alibaba%20Cloud/tests_status?style=svg" alt="Gardener v1.17 Conformance Tests"></a></td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.16%20Alibaba%20Cloud><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.16%20Alibaba%20Cloud/tests_status?style=svg" alt="Gardener v1.16 Conformance Tests"></a></td><td>[1]</td></tr><tr><td><strong>Equinix Metal</strong></td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td></tr><tr><td><strong>vSphere</strong></td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td></tr></tbody></table><p>[1] Conformance tests are still executed and validated, unfortunately <a href=https://github.com/kubernetes/test-infra/pull/18509#issuecomment-668204180>no longer shown in TestGrid</a>.</p><p>Besides the conformance tests, over 400 additional e2e tests are executed on a daily basis. Get an overview of the test results at <a href=https://testgrid.k8s.io/gardener-all>testgrid</a>.</p><h2 id=start-using-or-developing-the-gardener-locally>Start using or developing the Gardener locally</h2><p>See our documentation in the <code>/docs</code> repository, please <a href=https://github.com/gardener/gardener/blob/master/docs/README.md>find the index here</a>.</p><h2 id=setting-up-your-own-gardener-landscape-in-the-cloud>Setting up your own Gardener landscape in the Cloud</h2><p>The quickest way to test drive Gardener is to install it virtually onto an existing Kubernetes cluster, just like you would install any other Kubernetes-ready application. You can do this with our <a href=https://github.com/gardener/gardener/tree/master/charts/gardener>Gardener Helm Chart</a>.</p><p>Alternatively you can use our <a href=https://github.com/gardener/garden-setup>garden setup</a> project to create a fully configured Gardener landscape which also includes our <a href=https://github.com/gardener/dashboard>Gardener Dashboard</a>.</p><h2 id=feedback-and-support>Feedback and Support</h2><p>Feedback and contributions are always welcome!</p><p>All channels for getting in touch or learning about our project are listed under the <a href=https://github.com/gardener/documentation/blob/master/CONTRIBUTING.md#community>community</a> section. We are cordially inviting interested parties to join our <a href=https://github.com/gardener/documentation/blob/master/CONTRIBUTING.md#bi-weekly-meetings>bi-weekly meetings</a>.</p><p>Please report bugs or suggestions about our Kubernetes clusters as such or the Gardener itself as <a href=https://github.com/gardener/gardener/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn More!</h2><p>Please find further resources about our project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a>.</li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://news.sap.com/2018/11/hasso-plattner-founders-award-finalist-profile-project-gardener/>SAP news article about &ldquo;Project Gardener&rdquo;</a></li><li><a href=https://www.sap-tv.com/video/40962/gardener-planting-the-seeds-of-success-in-the-cloud>Introduction movie: &ldquo;Gardener - Planting the Seeds of Success in the Cloud&rdquo;</a></li><li><a href="https://www.youtube.com/watch?v=bfw22WPg99A">&ldquo;Thinking Cloud Native&rdquo; talk at EclipseCon 2018</a></li><li><a href=https://blogs.sap.com/2018/07/26/showcase-of-gardener-at-oscon/>Blog - &ldquo;Showcase of Gardener at OSCON 2018&rdquo;</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1c9ecaac6911168537e32a31b7bd54ed>1.1.4 - kubify</h1><h1 id=kubify>Kubify</h1><p><img src=/__resources/kubify@2x_f21939.png alt="Kubify Logo"></p><p>Kubify is a <a href=https://www.terraform.io/>Terraform</a> based provisioning project for setting up production ready <a href=https://kubernetes.io/>Kubernetes</a> clusters on public and private Cloud infrastructures. Kubify currently supports:</p><ul><li>OpenStack</li><li>AWS</li><li>Azure</li></ul><p>Key features of Kubify are:</p><ul><li>Kubernetes v1.10.12</li><li>Etcd v3.3.10 multi master node setup</li><li>Etcd backup and restore</li><li>Supports rolling updates</li></ul><hr><h2 id=to-start-using-or-developing-kubify-locally>To start using or developing Kubify locally</h2><p>See our documentation in the <code>/docs</code> repository or <a href=https://github.com/gardener/kubify/blob/master/docs/README.md>find the main documentation here</a>.</p><h2 id=feedback-and-support>Feedback and Support</h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions about our Kubernetes clusters as such or the Kubify itself as <a href=https://github.com/gardener/kubify/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (Invite yourself to the Kubernetes Slack workspace <a href=http://slack.k8s.io>here</a>).</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0eecd8abdfac4be5418188f307db6267>1.2 - Core Components</h1></div><div class=td-content><h1 id=pg-b6eb611265b72414cefdeab2d2b1ea17>1.2.1 - Gardener API Server</h1><h1 id=gardener-api-server>Gardener API server</h1><p>The Gardener API server is a Kubernetes-native extension based on its <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/>aggregation layer</a>.
It is registered via an <code>APIService</code> object and designed to run inside a Kubernetes cluster whose API it wants to extend.</p><p>After registration, it exposes the following resources:</p><h2 id=cloudprofiles><code>CloudProfile</code>s</h2><p><code>CloudProfile</code>s are resources that describe a specific environment of an underlying infrastructure provider, e.g. AWS, Azure, etc.
Each shoot has to reference a <code>CloudProfile</code> to declare the environment it should be created in.
In a <code>CloudProfile</code> the gardener operator specifies certain constraints like available machine types, regions, which Kubernetes versions they want to offer, etc.
End-users can read <code>CloudProfile</code>s to see these values, but only operators can change the content or create/delete them.
When a shoot is created or updated then an admission plugin checks that only values are used that are allowed via the referenced <code>CloudProfile</code>.</p><p>Additionally, a <code>CloudProfile</code> may contain a <code>providerConfig</code> which is a special configuration dedicated for the infrastructure provider.
Gardener does not evaluate or understand this config, but extension controllers might need for declaration of provider-specific constraints, or global settings.</p><p>Please see <a href=https://github.com/gardener/gardener/blob/master/example/30-cloudprofile.yaml>this</a> example manifest and consult the documentation of your provider extension controller to get information about its <code>providerConfig</code>.</p><h2 id=seeds><code>Seed</code>s</h2><p><code>Seed</code>s are resources that represent seed clusters.
Gardener does not care about how a seed cluster got created - the only requirement is that it is of at least Kubernetes v1.15 and passes the Kubernetes conformance tests.
The Gardener operator has to either deploy the Gardenlet into the cluster they want to use as seed (recommended, then the Gardenlet will create the <code>Seed</code> object itself after bootstrapping), or they provide the kubeconfig to the cluster inside a secret (that is referenced by the <code>Seed</code> resource) and create the <code>Seed</code> resource themselves.</p><p>Please see <a href=https://github.com/gardener/gardener/blob/master/example/45-secret-seed-backup.yaml>this</a>, <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml>this</a>(, and optionally <a href=https://github.com/gardener/gardener/blob/master/example/40-secret-seed.yaml>this</a>) example manifests.</p><h2 id=quotas><code>Quota</code>s</h2><p>In order to allow end-users not having their own dedicated infrastructure account to try out Gardener the operator can register an account owned by them that they allow to be used for trial clusters.
Trial clusters can be put under quota such that they don&rsquo;t consume too many resources (resulting in costs), and so that one user cannot consume all resources on their own.
These clusters are automatically terminated after a specified time, but end-users may extend the lifetime manually if needed.</p><p>Please see <a href=https://github.com/gardener/gardener/blob/master/example/60-quota.yaml>this</a> example manifest.</p><h2 id=projects><code>Project</code>s</h2><p>The first thing before creating a shoot cluster is to create a <code>Project</code>.
A project is used to group multiple shoot clusters together.
End-users can invite colleagues to the project to enable collaboration, and they can either make them <code>admin</code> or <code>viewer</code>.
After an end-user has created a project they will get a dedicated namespace in the garden cluster for all their shoots.</p><p>Please see <a href=https://github.com/gardener/gardener/blob/master/example/05-project-dev.yaml>this</a> example manifest.</p><h2 id=secretbindings><code>SecretBinding</code>s</h2><p>Now that the end-user has a namespace the next step is registering their infrastructure provider account.</p><p>Please see <a href=https://github.com/gardener/gardener/blob/master/example/70-secret-provider.yaml>this</a> example manifest and consult the documentation of the extension controller for the respective infrastructure provider to get information about which keys are required in this secret.</p><p>After the secret has been created the end-user has to create a special <code>SecretBinding</code> resource that binds this secret.
Later when creating shoot clusters they will reference such a binding.</p><p>Please see <a href=https://github.com/gardener/gardener/blob/master/example/80-secretbinding.yaml>this</a> example manifest.</p><h2 id=shoots><code>Shoot</code>s</h2><p>Shoot cluster contain various settings that influence how end-user Kubernetes clusters will look like in the end.
As Gardener heavily relies on extension controllers for operating system configuration, networking, and infrastructure specifics, the end-user has the possibility (and responsibility) to provide these provider-specific configurations as well.
Such configurations are not evaluated by Gardener (because it doesn&rsquo;t know/understand them), but they are only transported to the respective extension controller.</p><p>:warning: This means that any configuration issues/mistake on the end-user side that relates to a provider-specific flag or setting cannot be caught during the update request itself but only later during the reconciliation (unless a validator webhook has been registered in the garden cluster by an operator).</p><p>Please see <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml>this</a> example manifest and consult the documentation of the provider extension controller to get information about its <code>spec.provider.controlPlaneConfig</code>, <code>.spec.provider.infrastructureConfig</code>, and <code>.spec.provider.workers[].providerConfig</code>.</p><h2 id=clusteropenidconnectpresets><code>(Cluster)OpenIDConnectPreset</code>s</h2><p>Please see <a href=https://github.com/gardener/gardener/blob/master/docs/usage/openidconnect-presets.md>this</a> separate documentation file.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-93acd9e9e29353063a3f1dfd4dae3dd1>1.2.1.1 - In-Tree Admission Plugins</h1><h1 id=admission-plugins>Admission Plugins</h1><p>Similar to the kube-apiserver, the gardener-apiserver comes with a few in-tree managed admission plugins.
If you want to get an overview of the what and why of admission plugins then <a href=https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/>this document</a> might be a good start.</p><p>This document lists all existing admission plugins with a short explanation of what it is responsible for.</p><h2 id=clusteropenidconnectpreset-openidconnectpreset><code>ClusterOpenIDConnectPreset</code>, <code>OpenIDConnectPreset</code></h2><p><em>(both enabled by default)</em></p><p>These admission controllers react on <code>CREATE</code> operations for <code>Shoot</code>s.
If the <code>Shoot</code> does not specify any OIDC configuration (<code>.spec.kubernetes.kubeAPIServer.oidcConfig=nil</code>) then it tries to find a matching <code>ClusterOpenIDConnectPreset</code> or <code>OpenIDConnectPreset</code>, respectively.
If there are multiples that match then the one with the highest weight &ldquo;wins&rdquo;.
In this case, the admission controller will default the OIDC configuration in the <code>Shoot</code>.</p><h2 id=controllerregistrationresources><code>ControllerRegistrationResources</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>CREATE</code> and <code>UPDATE</code> operations for <code>ControllerRegistration</code>s.
It validates that there exists only one <code>ControllerRegistration</code> in the system that is primarily responsible for a given kind/type resource combination.
This prevents misconfiguration by the Gardener administrator/operator.</p><h2 id=customverbauthorizer><code>CustomVerbAuthorizer</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>CREATE</code> and <code>UPDATE</code> operations for <code>Project</code>s.
It validates whether the user is bound to a RBAC role with the <code>modify-spec-tolerations-whitelist</code> verb in case the user tries to change the <code>.spec.tolerations.whitelist</code> field of the respective <code>Project</code> resource.
Usually, regular project members are not bound to this custom verb, allowing the Gardener administrator to manage certain toleration whitelists on <code>Project</code> basis.</p><h2 id=deletionconfirmation><code>DeletionConfirmation</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>DELETE</code> operations for <code>Project</code>s and <code>Shoot</code>s and <code>ShootState</code>s.
It validates that the respective resource is annotated with a deletion confirmation annotation, namely <code>confirmation.gardener.cloud/deletion=true</code>.
Only if this annotation is present it allows the <code>DELETE</code> operation to pass.
This prevents users from accidental/undesired deletions.</p><h2 id=exposureclass><code>ExposureClass</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>Create</code> operations for <code>Shoots</code>s.
It mutates <code>Shoot</code> resources which has an <code>ExposureClass</code> referenced by merging their both <code>shootSelectors</code> and/or <code>tolerations</code> into the <code>Shoot</code> resource.</p><h2 id=extensionvalidator><code>ExtensionValidator</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>CREATE</code> and <code>UPDATE</code> operations for <code>BackupEntry</code>s, <code>BackupBucket</code>s, <code>Seed</code>s, and <code>Shoot</code>s.
For all the various extension types in the specifications of these objects, it validates whether there exists a <code>ControllerRegistration</code> in the system that is primarily responsible for the stated extension type(s).
This prevents misconfigurations that would otherwise allow users to create such resources with extension types that don&rsquo;t exist in the cluster, effectively leading to failing reconciliation loops.</p><h2 id=plantvalidator><code>PlantValidator</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>CREATE</code> and <code>UPDATE</code> operations for <code>Plant</code>s.
It sets the <code>gardener.cloud/created-by</code> annotation for newly created <code>Plant</code> resources.
Also, it prevents creating new <code>Plant</code> resources in <code>Project</code>s that are already have a deletion timestamp.</p><h2 id=projectvalidator><code>ProjectValidator</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>CREATE</code> operations for <code>Project</code>s.
It prevents creating <code>Project</code>s with a non-empty <code>.spec.namespace</code> if the value in <code>.spec.namespace</code> does not start with <code>garden-</code>.</p><p>⚠️ This admission plugin will be removed in a future release and its business logic will be incorporated into the static validation of the <code>gardener-apiserver</code>.</p><h2 id=resourcequota><code>ResourceQuota</code></h2><p><em>(enabled by default)</em></p><p>This admission controller enables <a href=https://kubernetes.io/docs/concepts/policy/resource-quotas/#object-count-quota>object count ResourceQuotas</a> for Gardener resources, e.g. <code>Shoots</code>, <code>SecretBindings</code>, <code>Projects</code>, etc..</p><blockquote><p>:warning: In addition to this admission plugin, the <a href=https://github.com/kubernetes/kubernetes/blob/release-1.2/docs/design/admission_control_resource_quota.md#resource-quota-controller>ResourceQuota controller</a> must be enabled for the Kube-Controller-Manager of your Garden cluster.</p></blockquote><h2 id=resourcereferencemanager><code>ResourceReferenceManager</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>CREATE</code> and <code>UPDATE</code> operations for <code>CloudProfile</code>s, <code>Project</code>s, <code>SecretBinding</code>s, <code>Seed</code>s, and <code>Shoot</code>s.
Generally, it checks whether referred resources stated in the specifications of these objects exist in the system (e.g., if a referenced <code>Secret</code> exists).
However, it also has some special behaviours for certain resources:</p><ul><li><code>CloudProfile</code>s: It rejects removing Kubernetes or machine image versions if there is at least one <code>Shoot</code> that refers to them.</li><li><code>Project</code>s: It sets the <code>.spec.createdBy</code> field for newly created <code>Project</code> resources, and defaults the <code>.spec.owner</code> field in case it is empty (to the same value of <code>.spec.createdBy</code>).</li><li><code>Seed</code>s: It rejects changing the <code>.spec.settings.shootDNS.enabled</code> value if there is at least one <code>Shoot</code> that refers to this seed.</li><li><code>Shoot</code>s: It sets the <code>gardener.cloud/created-by=&lt;username></code> annotation for newly created <code>Shoot</code> resources.</li></ul><h2 id=seedvalidator><code>SeedValidator</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>DELETE</code> operations for <code>Seed</code>s.
Rejects the deletion if <code>Shoot</code>(s) reference the seed cluster.</p><h2 id=shootdns><code>ShootDNS</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>CREATE</code> and <code>UPDATE</code> operations for <code>Shoot</code>s.
It tries to assign a default domain to the <code>Shoot</code> if it gets scheduled to a seed that enables DNS for shoots (<code>.spec.settings.shootDNS.enabled=true</code>).
It also validates that the DNS configuration (<code>.spec.dns</code>) is not set if the seed disables DNS for shoots.</p><h2 id=shootquotavalidator><code>ShootQuotaValidator</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>CREATE</code> and <code>UPDATE</code> operations for <code>Shoot</code>s.
It validates the resource consumption declared in the specification against applicable <code>Quota</code> resources.
Only if the applicable <code>Quota</code> resources admit the configured resources in the <code>Shoot</code> then it allows the request.
Applicable <code>Quota</code>s are referred in the <code>SecretBinding</code> that is used by the <code>Shoot</code>.</p><h2 id=shootvpaenabledbydefault><code>ShootVPAEnabledByDefault</code></h2><p><em>(disabled by default)</em></p><p>This admission controller reacts on <code>CREATE</code> operations for <code>Shoot</code>s.
If enabled, it will enable the managed <code>VerticalPodAutoscaler</code> components (see <a href=https://github.com/gardener/gardener/blob/master/docs/usage/shoot_autoscaling.md#vertical-pod-auto-scaling>this doc</a>)
by setting <code>spec.kubernetes.verticalPodAutoscaler.enabled=true</code> for newly created Shoots.
Already existing Shoots and new Shoots that explicitly disable VPA (<code>spec.kubernetes.verticalPodAutoscaler.enabled=false</code>)
will not be affected by this admission plugin.</p><h2 id=shoottolerationrestriction><code>ShootTolerationRestriction</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>CREATE</code> and <code>UPDATE</code> operations for <code>Shoot</code>s.
It validates the <code>.spec.tolerations</code> used in <code>Shoot</code>s against the whitelist of its <code>Project</code>, or against the whitelist configured in the admission controller&rsquo;s configuration, respectively.
Additionally, it defaults the <code>.spec.tolerations</code> in <code>Shoot</code>s with those configured in its <code>Project</code>, and those configured in the admission controller&rsquo;s configuration, respectively.</p><h2 id=shootvalidator><code>ShootValidator</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>CREATE</code> and <code>UPDATE</code> operations for <code>Shoot</code>s.
It validates certain configurations in the specification against the referred <code>CloudProfile</code> (e.g., machine images, machine types, used Kubernetes version, &mldr;).
Generally, it performs validations that cannot be handled by the static API validation due to their dynamic nature (e.g., when something needs to be checked against referred resources).
Additionally, it takes over certain defaulting tasks (e.g., default machine image for worker pools).</p><h2 id=shootmanagedseed><code>ShootManagedSeed</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>DELETE</code> operations for <code>Shoot</code>s.
It rejects the deletion if the <code>Shoot</code> is referred to by a <code>ManagedSeed</code>.</p><h2 id=managedseedvalidator><code>ManagedSeedValidator</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>CREATE</code> and <code>UPDATE</code> operations for <code>ManagedSeeds</code>s.
It validates certain configuration values in the specification against the referred <code>Shoot</code>, for example Seed provider, network ranges, DNS domain, etc.
Similarly to <code>ShootValidator</code>, it performs validations that cannot be handled by the static API validation due to their dynamic nature.
Additionally, it performs certain defaulting tasks, making sure that configuration values that are not specified are defaulted to the values of the referred <code>Shoot</code>, for example Seed provider, network ranges, DNS domain, etc.</p><h2 id=managedseedshoot><code>ManagedSeedShoot</code></h2><p><em>(enabled by default)</em></p><p>This admission controller reacts on <code>DELETE</code> operations for <code>ManagedSeed</code>s.
It rejects the deletion if there are <code>Shoot</code>s that are scheduled onto the <code>Seed</code> that is registered by the <code>ManagedSeed</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5683c2beab8c039c3a96cc726ba85f7a>1.2.2 - Gardener Scheduler</h1><h1 id=gardener-scheduler>Gardener Scheduler</h1><p>The Gardener Scheduler is in essence a controller that watches newly created shoots and assigns a seed cluster to them.
Conceptually, the task of the Gardener Scheduler is very similar to the task of the Kubernetes Scheduler: finding a seed for a shoot instead of a node for a pod.</p><p>Either the scheduling strategy or the shoot cluster purpose hereby determines how the scheduler is operating.
The following sections explain the configuration and flow in greater detail.</p><h2 id=why-is-the-gardener-scheduler-needed>Why is the Gardener Scheduler needed?</h2><h3 id=1-decoupling>1. Decoupling</h3><p>Previously, an admission plugin in the Gardener API server conducted the scheduling decisions.
This implies changes to the API server whenever adjustments of the scheduling are needed.
Decoupling the API server and the scheduler comes with greater flexibility to develop these components independently from each other.</p><h3 id=2-extensibility>2. Extensibility</h3><p>It should be possible to easily extend and tweak the scheduler in the future.
Possibly, similar to the Kubernetes scheduler, hooks could be provided which influence the scheduling decisions.
It should be also possible to completely replace the standard Gardener Scheduler with a custom implementation.</p><h2 id=algorithm-overview>Algorithm overview</h2><p>The following <strong>sequence</strong> describes the steps involved to determine a seed candidate:</p><ol><li>Determine usable seeds with &ldquo;usable&rdquo; defined as follows:<ul><li>no <code>.metadata.deletionTimestamp</code></li><li><code>.spec.settings.scheduling.visible</code> is <code>true</code></li><li>conditions <code>Bootstrapped</code>, <code>GardenletReady</code>, <code>BackupBucketsReady</code> (if available) are <code>true</code></li></ul></li><li>Filter seeds:<ul><li>matching <code>.spec.seedSelector</code> in <code>CloudProfile</code> used by the <code>Shoot</code></li><li>matching <code>.spec.seedSelector</code> in <code>Shoot</code></li><li>having no network intersection with the <code>Shoot</code>&rsquo;s networks (due to the VPN connectivity between seeds and shoots their networks must be disjoint)</li><li>having <code>.spec.settings.shootDNS.enabled=false</code> (only if the shoot specifies a DNS domain or does not use the <code>unmanaged</code> DNS provider)</li><li>whose taints (<code>.spec.taints</code>) are tolerated by the <code>Shoot</code> (<code>.spec.tolerations</code>)</li><li>whose capacity for shoots would not be exceeded if the shoot is scheduled onto the seed, see <a href=#ensuring-seeds-capacity-for-shoots-is-not-exceeded>Ensuring seeds capacity for shoots is not exceeded</a></li></ul></li><li>Apply active <a href=#strategies>strategy</a> e.g., <em>Minimal Distance strategy</em></li><li>Choose least utilized seed, i.e., the one with the least number of shoot control planes, will be the winner and written to the <code>.spec.seedName</code> field of the <code>Shoot</code>.</li></ol><h2 id=configuration>Configuration</h2><p>The Gardener Scheduler configuration has to be supplied on startup. It is a mandatory and also the only available flag.
<a href=https://github.com/gardener/gardener/blob/master/example/20-componentconfig-gardener-scheduler.yaml>Here</a> is an example scheduler configuration.</p><p>Most of the configuration options are the same as in the Gardener Controller Manager (leader election, client connection, &mldr;).
However, the Gardener Scheduler on the other hand does not need a TLS configuration, because there are currently no webhooks configurable.</p><h2 id=strategies>Strategies</h2><p>The scheduling strategy is defined in the <em><strong>candidateDeterminationStrategy</strong></em> of the scheduler&rsquo;s configuration and can have the possible values <code>SameRegion</code> and <code>MinimalDistance</code>.
The <code>SameRegion</code> strategy is the default strategy.</p><ol><li><p><em>Same Region strategy</em></p><p>The Gardener Scheduler reads the <code>spec.provider.type</code> and <code>.spec.region</code> fields from the <code>Shoot</code> resource.
It tries to find a seed that has the identical <code>.spec.provider.type</code> and <code>.spec.provider.region</code> fields set.
If it cannot find a suitable seed, it adds an event to the shoot stating, that it is unschedulable.</p></li><li><p><em>Minimal Distance strategy</em></p><p>The Gardener Scheduler tries to find a valid seed with minimal distance to the shoot&rsquo;s intended region.
The distance is calculated based on the Levenshtein distance of the region. Therefore the region name
is split into a base name and an orientation. Possible orientations are <code>north</code>, <code>south</code>, <code>east</code>, <code>west</code> and <code>central</code>.
The distance then is twice the Levenshtein distance of the region&rsquo;s base name plus a correction value based on the
orientation and the provider.</p><p>If the orientations of shoot and seed candidate match, the correction value is 0, if they differ it is 2 and if
either the seed&rsquo;s or the shoot&rsquo;s region does not have an orientation it is 1.
If the provider differs the correction value is additionally incremented by 2.</p><p>Because of this a matching region with a matching provider is always prefered.</p></li></ol><p>In order to put the scheduling decision into effect, the scheduler sends an update request for the <code>Shoot</code> resource to
the API server. After validation, the Gardener Aggregated API server updates the shoot to have the <code>spec.seedName</code> field set.
Subsequently, the Gardenlet picks up and starts to create the cluster on the specified seed.</p><ol start=3><li><em>Special handling based on shoot cluster purpose</em></li></ol><p>Every shoot cluster can have a purpose that describes what the cluster is used for, and also influences how the cluster is setup (see <a href=https://github.com/gardener/gardener/blob/master/docs/usage/shoot_purposes.md>this document</a> for more information).</p><p>In case the shoot has the <code>testing</code> purpose then the scheduler only reads the <code>.spec.provider.type</code> from the <code>Shoot</code> resource and tries to find a <code>Seed</code> that has the identical <code>.spec.provider.type</code>.
The region does not matter, i.e., <code>testing</code> shoots may also be scheduled on a seed in a complete different region if it is better for balancing the whole Gardener system.</p><h2 id=seedselector-field-in-the-shoot-specification><code>seedSelector</code> field in the <code>Shoot</code> specification</h2><p>Similar to the <code>.spec.nodeSelector</code> field in <code>Pod</code>s, the <code>Shoot</code> specification has an optional <code>.spec.seedSelector</code> field.
It allows the user to provide a label selector that must match the labels of <code>Seed</code>s in order to be scheduled to one of them.
The labels on <code>Seed</code>s are usually controlled by Gardener administrators/operators - end users cannot add arbitrary labels themselves.
If provided, the Gardener Scheduler will only consider those seeds as &ldquo;suitable&rdquo; whose labels match those provided in the <code>.spec.seedSelector</code> of the <code>Shoot</code>.</p><p>By default only seeds with the same provider than the shoot are selected. By adding a <code>providerTypes</code> field to the <code>seedSelector</code>
a dedicated set of possible providers (<code>*</code> means all provider types) can be selected.</p><h2 id=ensuring-seeds-capacity-for-shoots-is-not-exceeded>Ensuring seeds capacity for shoots is not exceeded</h2><p>Seeds have a practical limit of how many shoots they can accommodate. Exceeding this limit is undesirable as the system performance will be noticeably impacted. Therefore, the scheduler ensures that a seed&rsquo;s capacity for shoots is not exceeded by taking into account a maximum number of shoots that can be scheduled onto a seed.</p><p>This mechanism works as follows:</p><ul><li>The <code>gardenlet</code> is configured with certain <em>resources</em> and their total <em>capacity</em> (and, for certain resources, the amount <em>reserved</em> for Gardener), see <a href=https://github.com/gardener/gardener/blob/master/example/20-componentconfig-gardenlet.yaml>/example/20-componentconfig-gardenlet.yaml</a>. Currently, the only such resource is the maximum number of shoots that can be scheduled onto a seed.</li><li>The <code>gardenlet</code> seed controller updates the <code>capacity</code> and <code>allocatable</code> fields in Seed status with the capacity of each resource and how much of it is actually available to be consumed by shoots. The <code>allocatable</code> value of a resource is equal to <code>capacity</code> minus <code>reserved</code>.</li><li>When scheduling shoots, the scheduler filters out all candidate seeds whose allocatable capacity for shoots would be exceeded if the shoot is scheduled onto the seed.</li></ul><h2 id=failure-to-determine-a-suitable-seed>Failure to determine a suitable seed</h2><p>In case the scheduler fails to find a suitable seed, the operation is being retried with exponential backoff.</p><h2 id=current-limitation--future-plans>Current Limitation / Future Plans</h2><ul><li>Azure has unfortunately a geographically non-hierarchical naming pattern and does not start with the continent. This is the reason why we will exchange the implementation of the <code>MinimalRegion</code> strategy with a more suitable one in the future.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a396e4971751639bc3691ebddf810d8d>1.2.3 - Gardener Seed Admission Controller</h1><h1 id=gardener-seed-admission-controller>Gardener Seed Admission Controller</h1><p>The Gardener Seed admission controller is deployed by the Gardenlet as part of its seed bootstrapping phase and, consequently, running in every seed cluster.
It&rsquo;s main purpose is to serve webhooks (validating or mutating) in order to admit or deny certain requests to the seed&rsquo;s API server.</p><h2 id=what-is-it-doing-concretely>What is it doing concretely?</h2><h3 id=validating-webhooks>Validating Webhooks</h3><h4 id=unconfirmed-deletion-prevention>Unconfirmed Deletion Prevention</h4><p>As part of Gardener&rsquo;s <a href=/docs/concepts/extensions>extensibility concepts</a> a lot of <code>CustomResourceDefinition</code>s are deployed to the seed clusters that serve as extension points for provider-specific controllers.
For example, the <a href=/docs/concepts/extensions/infrastructure><code>Infrastructure</code> CRD</a> triggers the provider extension to prepare the IaaS infrastructure of the underlying cloud provider for a to-be-created shoot cluster.
Consequently, these extension CRDs have a lot of power and control large portions of the end-user&rsquo;s shoot cluster.
Accidental or undesired deletions of those resource can cause tremendous and hard-to-recover-from outages and should be prevented.</p><p>Together with the deployment of the Gardener seed admission controller a <code>ValidatingWebhookConfiguration</code> for <code>CustomResourceDefinitions</code> and most (custom) resources in the <code>extensions.gardener.cloud/v1alpha1</code> API group is registered.
It prevents <code>DELETE</code> requests for those <code>CustomResourceDefinitions</code> labeled with <code>gardener.cloud/deletion-protected=true</code>, and for all mentioned custom resources if they were not previously annotated with the <code>confirmation.gardener.cloud/deletion=true</code>.
This prevents that undesired <code>kubectl delete &lt;...></code> requests are accepted.</p><h3 id=mutating-webhooks>Mutating Webhooks</h3><p>The admission controller endpoint <code>/webhooks/default-pod-scheduler-name/gardener-kube-scheduler</code> mutates <code>pods</code> and adds <code>gardener-kube-scheduler</code> to <code>.spec.scheduleName</code>.</p><p>When <code>SeedKubeScheduler</code> feature gate is enabled, all control plane components are mutated. The scheduler scores <code>Nodes</code> with most resource usage higher than the rest, resulting in greater resource utilization.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4834623b7501725851cab75a7be41b62>1.2.4 - gardenlet</h1><h1 id=gardenlet>Gardenlet</h1><p>Gardener is implemented using the <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/operator/>operator pattern</a>:
It uses custom controllers that act on our own custom resources,
and apply Kubernetes principles to manage clusters instead of containers.
Following this analogy, you can recognize components of the Gardener architecture
as well-known Kubernetes components, for example, shoot clusters can be compared with pods,
and seed clusters can be seen as worker nodes.</p><p>The following Gardener components play a similar role as the corresponding components
in the Kubernetes architecture:</p><table><thead><tr><th style=text-align:left>Gardener Component</th><th style=text-align:left>Kubernetes Component</th></tr></thead><tbody><tr><td style=text-align:left><code>gardener-apiserver</code></td><td style=text-align:left><code>kube-apiserver</code></td></tr><tr><td style=text-align:left><code>gardener-controller-manager</code></td><td style=text-align:left><code>kube-controller-manager</code></td></tr><tr><td style=text-align:left><code>gardener-scheduler</code></td><td style=text-align:left><code>kube-scheduler</code></td></tr><tr><td style=text-align:left><code>gardenlet</code></td><td style=text-align:left><code>kubelet</code></td></tr></tbody></table><p>Similar to how the <code>kube-scheduler</code> of Kubernetes finds an appropriate node
for newly created pods, the <code>gardener-scheduler</code> of Gardener finds an appropriate seed cluster
to host the control plane for newly ordered clusters.
By providing multiple seed clusters for a region or provider, and distributing the workload,
Gardener also reduces the blast radius of potential issues.</p><p>Kubernetes runs a primary &ldquo;agent&rdquo; on every node, the kubelet,
which is responsible for managing pods and containers on its particular node.
Decentralizing the responsibility to the kubelet has the advantage that the overall system
is scalable. Gardener achieves the same for cluster management by using a <strong>gardenlet</strong>
as primary &ldquo;agent&rdquo; on every seed cluster, and is only responsible for shoot clusters
located in its particular seed cluster:</p><p><img src=/__resources/gardenlet-architecture-similarities_23499e.png alt="Counterparts in the Gardener Architecture and the Kubernetes Architecture"></p><p>The <code>gardener-controller-manager</code> has control loops to manage resources of the Gardener API. However, instead of letting the <code>gardener-controller-manager</code> talk directly to seed clusters or shoot clusters, the responsibility isn’t only delegated to the gardenlet, but also managed using a reversed control flow: It&rsquo;s up to the gardenlet to contact the Gardener API server, for example, to share a status for its managed seed clusters.</p><p>Reversing the control flow allows placing seed clusters or shoot clusters behind firewalls without the necessity of direct access via VPN tunnels anymore.</p><p><img src=/__resources/gardenlet-architecture-detailed_9c0931.png alt="Reversed Control Flow Using a Gardenlet"></p><h2 id=tls-bootstrapping>TLS Bootstrapping</h2><p>Kubernetes doesn’t manage worker nodes itself, and it’s also not
responsible for the lifecycle of the kubelet running on the workers.
Similarly, Gardener doesn’t manage seed clusters itself,
so Gardener is also not responsible for the lifecycle of the gardenlet running on the seeds.
As a consequence, both the gardenlet and the kubelet need to prepare
a trusted connection to the Gardener API server
and the Kubernetes API server correspondingly.</p><p>To prepare a trusted connection between the gardenlet
and the Gardener API server, the gardenlet initializes
a bootstrapping process after you deployed it into your seed clusters:</p><ol><li><p>The gardenlet starts up with a bootstrap <code>kubeconfig</code>
having a bootstrap token that allows to create <code>CertificateSigningRequest</code> (CSR) resources.</p></li><li><p>After the CSR is signed, the gardenlet downloads
the created client certificate, creates a new <code>kubeconfig</code> with it,
and stores it inside a <code>Secret</code> in the seed cluster.</p></li><li><p>The gardenlet deletes the bootstrap <code>kubeconfig</code> secret,
and starts up with its new <code>kubeconfig</code>.</p></li><li><p>The gardenlet starts normal operation.</p></li></ol><p>The <code>gardener-controller-manager</code> runs a control loop
that automatically signs CSRs created by gardenlets.</p><blockquote><p>The gardenlet bootstrapping process is based on the
kubelet bootstrapping process. More information:
<a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/>Kubelet&rsquo;s TLS bootstrapping</a>.</p></blockquote><p>If you don&rsquo;t want to run this bootstrap process you can create
a <code>kubeconfig</code> pointing to the garden cluster for the gardenlet yourself,
and use field <code>gardenClientConnection.kubeconfig</code> in the
gardenlet configuration to share it with the gardenlet.</p><h2 id=gardenlet-certificate-rotation>Gardenlet Certificate Rotation</h2><p>The certificate used to authenticate the gardenlet against the API server
is valid for a year.
After about 10 months, the gardenlet tries to automatically replace
the current certificate with a new one (certificate rotation).</p><p>To use certificate rotation, you need to specify the secret to store
the <code>kubeconfig</code> with the rotated certificate in field
<code>.gardenClientConnection.kubeconfigSecret</code> of the
gardenlet <a href=#component-configuration>component configuration</a>.</p><h3 id=rotate-certificates-using-bootstrap-kubeconfig>Rotate certificates using bootstrap <code>kubeconfig</code></h3><p>If the gardenlet created the certificate during the initial TLS Bootstrapping
using the Bootstrap <code>kubeconfig</code>, certificates can be rotated automatically.
The same control loop in the <code>gardener-controller-manager</code> that signs
the CSRs during the initial TLS Bootstrapping also automatically signs
the CSR during a certificate rotation.</p><h3 id=rotate-certificate-using-custom-kubeconfig>Rotate Certificate Using Custom <code>kubeconfig</code></h3><p>When trying to rotate a custom certificate that wasn’t created by gardenlet
as part of the TLS Bootstrap, the x509 certificate&rsquo;s <code>Subject</code> field
needs to conform to the following:</p><ul><li>the Common Name (CN) is prefixed with <code>gardener.cloud:system:seed:</code></li><li>the Organization (O) equals <code>gardener.cloud:system:seeds</code></li></ul><p>Otherwise, the <code>gardener-controller-manager</code> doesn’t automatically
sign the CSR.
In this case, an external component or user needs to approve the CSR manually,
for example, using command <code>kubectl certificate approve seed-csr-&lt;...></code>).
If that doesn’t happen within 15 minutes,
the gardenlet repeats the process and creates another CSR.</p><h2 id=configuring-the-seed-to-work-with>Configuring the Seed to work with</h2><p>The Gardenlet works with a single seed, which must be configured in the
<code>GardenletConfiguration</code> under <code>.seedConfig</code>. This must be a copy of the
<code>Seed</code> resource, for example (see <code>example/20-componentconfig-gardenlet.yaml</code>
for a more complete example):</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet.config.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>GardenletConfiguration</span><span class=w>
</span><span class=w></span><span class=nt>seedConfig</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-seed</span><span class=w>
</span><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>provider</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws</span><span class=w>
</span><span class=w>    </span><span class=c># ...</span><span class=w>
</span><span class=w>    </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-seed-secret</span><span class=w>
</span><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span></code></pre></div><p>When using <code>make start-gardenlet</code>, the corresponding script will automatically
fetch the seed cluster&rsquo;s <code>kubeconfig</code> based on the <code>seedConfig.spec.secretRef</code>
and set the environment accordingly.</p><p>On startup, gardenlet registers a <code>Seed</code> resource using the given template
in <code>seedConfig</code> if it&rsquo;s not present already.</p><h2 id=component-configuration>Component Configuration</h2><p>In the component configuration for the gardenlet, it’s possible to define:</p><ul><li>settings for the Kubernetes clients interacting with the various clusters</li><li>settings for the control loops inside the gardenlet</li><li>settings for leader election and log levels, feature gates, and seed selection or seed configuration.</li></ul><p>More information: <a href=https://github.com/gardener/gardener/blob/master/example/20-componentconfig-gardenlet.yaml>Example Gardenlet Component Configuration</a>.</p><h2 id=heartbeats>Heartbeats</h2><p>Similar to how Kubernetes uses <code>Lease</code> objects for node heart beats
(see <a href=https://github.com/kubernetes/enhancements/blob/master/keps/sig-node/589-efficient-node-heartbeats/README.md>KEP</a>),
the gardenlet is using <code>Lease</code> objects for heart beats of the seed cluster.
Every two seconds, the gardenlet checks that the seed cluster&rsquo;s <code>/healthz</code>
endpoint returns HTTP status code 200.
If that is the case, the gardenlet renews the lease in the Garden cluster in the <code>gardener-system-seed-lease</code> namespace and updates
the <code>GardenletReady</code> condition in the <code>status.conditions</code> field of the <code>Seed</code> resource(s).</p><p>Similarly to the <code>node-lifecycle-controller</code> inside the <code>kube-controller-manager</code>,
the <code>gardener-controller-manager</code> features a <code>seed-lifecycle-controller</code> that sets
the <code>GardenletReady</code> condition to <code>Unknown</code> in case the gardenlet fails to renew the lease.
As a consequence, the <code>gardener-scheduler</code> doesn’t consider this seed cluster for newly created shoot clusters anymore.</p><h3 id=healthz-endpoint><code>/healthz</code> Endpoint</h3><p>The gardenlet includes an HTTPS server that serves a <code>/healthz</code> endpoint.
It’s used as a liveness probe in the <code>Deployment</code> of the gardenlet.
If the gardenlet fails to renew its lease
then the endpoint returns <code>500 Internal Server Error</code>, otherwise it returns <code>200 OK</code>.</p><p>Please note that the <code>/healthz</code> only indicates whether the gardenlet
could successfully probe the Seed&rsquo;s API server and renew the lease with
the Garden cluster.
It does <em>not</em> show that the Gardener extension API server (with the Gardener resource groups)
is available.
However, the Gardenlet is designed to withstand such connection outages and
retries until the connection is reestablished.</p><h2 id=control-loops>Control Loops</h2><p>The gardenlet consists out of several controllers which are now described in more detail.</p><p>⚠️ This section is not necessarily complete and might be under construction.</p><h3 id=backupentry-controller><code>BackupEntry</code> Controller</h3><p>The <code>BackupEntry</code> controller reconciles those <code>core.gardener.cloud/v1beta1.BackupEntry</code> resources whose <code>.spec.seedName</code> value is equal to the name of a <code>Seed</code> the respective gardenlet is responsible for.
Those resources are created by the <code>Shoot</code> controller (only if backup is enabled for the respective <code>Seed</code>) and there is exactly one <code>BackupEntry</code> per <code>Shoot</code>.</p><p>The controller creates an <code>extensions.gardener.cloud/v1alpha1.BackupEntry</code> resource (non-namespaced) in the seed cluster and waits until the responsible extension controller reconciled it (see <a href=/docs/concepts/extensions/backupentry>this</a> for more details).
The status is populated in the <code>.status.lastOperation</code> field.</p><p>The <code>core.gardener.cloud/v1beta1.BackupEntry</code> resource has an owner reference pointing to the corresponding <code>Shoot</code>.
Hence, if the <code>Shoot</code> is deleted, also the <code>BackupEntry</code> resource gets deleted.
In this case, the controller deletes the <code>extensions.gardener.cloud/v1alpha1.BackupEntry</code> resource in the seed cluster and waits until the responsible extension controller has deleted it.
Afterwards, the finalizer of the <code>core.gardener.cloud/v1beta1.BackupEntry</code> resource is released so that it finally disappears from the system.</p><h4 id=keep-backup-for-deleted-shoots>Keep Backup for Deleted Shoots</h4><p>In some scenarios it might be beneficial to not immediately delete the <code>BackupEntry</code>s (and with them, the etcd backup) for deleted <code>Shoot</code>s.</p><p>In this case you can configure the <code>.controllers.backupEntry.deletionGracePeriodHours</code> field in the component configuration of the gardenlet.
For example, if you set it to <code>48</code>, then the <code>BackupEntry</code>s for deleted <code>Shoot</code>s will only be deleted <code>48</code> hours after the <code>Shoot</code> was deleted.</p><p>Additionally, you can limit the <a href=https://github.com/gardener/gardener/blob/master/docs/usage/shoot_purposes.md>shoot purposes</a> for which this applies by setting <code>.controllers.backupEntry.deletionGracePeriodShootPurposes[]</code>.
For example, if you set it to <code>[production]</code> then only the <code>BackupEntry</code>s for <code>Shoot</code>s with <code>.spec.purpose=production</code> will be deleted after the configured grace period. All others will be deleted immediately after the <code>Shoot</code> deletion.</p><h2 id=managed-seeds>Managed Seeds</h2><p>Gardener users can use shoot clusters as seed clusters, so-called &ldquo;managed seeds&rdquo; (aka &ldquo;shooted seeds&rdquo;),
by creating <code>ManagedSeed</code> resources.
By default, the gardenlet that manages this shoot cluster then automatically
creates a clone of itself with the same version and the same configuration
that it currently has.
Then it deploys the gardenlet clone into the managed seed cluster.</p><p>If you want to prevent the automatic gardenlet deployment,
specify the <code>seedTemplate</code> section in the <code>ManagedSeed</code> resource, and don&rsquo;t specify
the <code>gardenlet</code> section.
In this case, you have to deploy the gardenlet on your own into the seed cluster.</p><p>More information: <a href=https://github.com/gardener/gardener/blob/master/docs/usage/managed_seed.md>Register Shoot as Seed</a></p><h2 id=migrating-from-previous-gardener-versions>Migrating from Previous Gardener Versions</h2><p>If your Gardener version doesn’t support gardenlets yet,
no special migration is required, but the following prerequisites must be met:</p><ul><li>Your Gardener version is at least 0.31 before upgrading to v1.</li><li>You have to make sure that your garden cluster is exposed in a way
that it’s reachable from all your seed clusters.</li></ul><p>With previous Gardener versions, you had deployed the Gardener Helm chart
(incorporating the API server, <code>controller-manager</code>, and scheduler).
With v1, this stays the same, but you now have to deploy the gardenlet Helm chart as well
into all of your seeds (if they aren’t managed, as mentioned earlier).</p><p>More information: <a href=/docs/concepts/deployment/deploy_gardenlet>Deploy a Gardenlet</a> for all instructions.</p><h2 id=related-links>Related Links</h2><p><a href=https://github.com/gardener/documentation/wiki/Architecture>Gardener Architecture</a></p><p><a href=https://github.com/gardener/gardener/issues/356>Issue #356: Implement Gardener Scheduler</a></p><p><a href=https://github.com/gardener/gardener/pull/2309>PR #2309: Add /healthz endpoint for Gardenlet</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-be838f715b079b3d8bb0edb9a1124588>1.3 - Backup and Restore</h1><h1 id=backup-and-restore>Backup and restore</h1><p>Kubernetes uses Etcd as the key-value store for its resource definitions. Gardener supports the backup and restore of etcd. It is the responsibility of the shoot owners to backup the workload data.</p><p>Gardener uses <a href=https://github.com/gardener/etcd-backup-restore>etcd-backup-restore</a> component to backup the etcd backing the Shoot cluster regularly and restore in case of disaster. It is deployed as sidecar via <a href=https://github.com/gardener/etcd-druid>etcd-druid</a>. This doc mainly focuses on the backup and restore configuration used by Gardener when deploying these components. For more details on the design and internal implementation details, please refer <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/06-etcd-druid.md>GEP-06</a> and documentation on individual repository.</p><h2 id=bucket-provisioning>Bucket provisioning</h2><p>Refer the <a href=/docs/concepts/extensions/backupbucket>backup bucket extension document</a> to know details about configuring backup bucket.</p><h2 id=backup-policy>Backup Policy</h2><p>etcd-backup-restore supports full snapshot and delta snapshots over full snapshot. In Gardener, this configuration is currently hard-coded to following parameters:</p><ul><li>Full Snapshot Schedule:<ul><li>Daily, <code>24hr</code> interval.</li><li>For each Shoot, the schedule time in a day is randomized based on the configured Shoot maintenance window.</li></ul></li><li>Delta Snapshot schedule:<ul><li>At <code>5min</code> interval.</li><li>If aggregated events size since last snapshot goes beyond <code>100Mib</code>.</li></ul></li><li>Backup History / Garbage backup deletion policy:<ul><li>Gardener configure backup restore to have <code>Exponential</code> garbage collection policy.</li><li>As per policy, following backups are retained.</li><li>All full backups and delta backups for the previous hour.</li><li>Latest full snapshot of each previous hour for the day.</li><li>Latest full snapshot of each previous day for 7 days.</li><li>Latest full snapshot of the previous 4 weeks.</li><li>Garbage Collection is configured at <code>12hr</code> interval.</li></ul></li><li>Listing:<ul><li>Gardener don&rsquo;t have any API to list out the backups.</li><li>To find the backup list, admin can checkout the <code>BackupEntry</code> resource associated with Shoot which holds the bucket and prefix details on object store.</li></ul></li></ul><h2 id=restoration>Restoration</h2><p>Restoration process of etcd is automated through the etcd-backup-restore component from latest snapshot. Gardener dosen&rsquo;t support Point-In-Time-Recovery (PITR) of etcd. In case of etcd disaster, the etcd is recovered from latest backup automatically. For further details, please refer the <a href=https://github.com/gardener/etcd-backup-restore/blob/master/doc/proposals/restoration.md>doc</a>. Post restoration of etcd, the Shoot reconciliation loop brings back the cluster to same state.</p><p>Again, Shoot owner is responsible for maintaining the backup/restore of his workload. Gardener does only take care of the cluster&rsquo;s etcd.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-59cac4075ab5a0597f1716c0650a4135>1.4 - Extensions</h1><h1 id=extensibility-overview>Extensibility overview</h1><p>Initially, everything was developed in-tree in the Gardener project. All cloud providers and the configuration for all the supported operating systems were released together with the Gardener core itself.
But as the project grew, it got more and more difficult to add new providers and maintain the existing code base.
As a consequence and in order to become agile and flexible again, we proposed <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> (Gardener Enhancement Proposal).
The document describes an out-of-tree extension architecture that keeps the Gardener core logic independent of provider-specific knowledge (similar to what Kubernetes has achieved with <a href=https://github.com/kubernetes/enhancements/issues/88>out-of-tree cloud providers</a> or with <a href=https://github.com/kubernetes/community/pull/1258>CSI volume plugins</a>).</p><h2 id=basic-concepts>Basic concepts</h2><p>Gardener keeps running in the &ldquo;garden cluster&rdquo; and implements the core logic of shoot cluster reconciliation/deletion.
Extensions are Kubernetes controllers themselves (like Gardener) and run in the seed clusters.
As usual, we try to use Kubernetes wherever applicable.
We rely on Kubernetes extension concepts in order to enable extensibility for Gardener.
The main ideas of GEP-1 are the following:</p><ol><li><p>During the shoot reconciliation process Gardener will write CRDs into the seed cluster that are watched and managed by the extension controllers. They will reconcile (based on the <code>.spec</code>) and report whether everything went well or errors occurred in the CRD&rsquo;s <code>.status</code> field.</p></li><li><p>Gardener keeps deploying the provider-independent control plane components (etcd, kube-apiserver, etc.). However, some of these components might still need little customization by providers, e.g., additional configuration, flags, etc. In this case, the extension controllers register webhooks in order to manipulate the manifests.</p></li></ol><p><strong>Example 1</strong>:</p><p>Gardener creates a new AWS shoot cluster and requires the preparation of infrastructure in order to proceed (networks, security groups, etc.).
It writes the following CRD into the seed cluster:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Infrastructure</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>infrastructure</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--core--aws-01</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws</span><span class=w>
</span><span class=w>  </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>aws.provider.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InfrastructureConfig</span><span class=w>
</span><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>vpc</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>10.250.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>      </span><span class=nt>internal</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=m>10.250.112.0</span><span class=l>/22</span><span class=w>
</span><span class=w>      </span><span class=nt>public</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=m>10.250.96.0</span><span class=l>/22</span><span class=w>
</span><span class=w>      </span><span class=nt>workers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=m>10.250.0.0</span><span class=l>/19</span><span class=w>
</span><span class=w>    </span><span class=nt>zones</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>eu-west-1a</span><span class=w>
</span><span class=w>  </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiserver</span><span class=p>:</span><span class=w> </span><span class=l>api.aws-01.core.example.com</span><span class=w>
</span><span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-aws-credentials</span><span class=w>
</span><span class=w>  </span><span class=nt>sshPublicKey</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    </span><span class=w>    </span><span class=l>base64(key)</span><span class=w>
</span></code></pre></div><p>Please note that the <code>.spec.providerConfig</code> is a raw blob and not evaluated or known in any way by Gardener.
Instead, it was specified by the user (in the <code>Shoot</code> resource) and just &ldquo;forwarded&rdquo; to the extension controller.
Only the AWS controller understands this configuration and will now start provisioning/reconciling the infrastructure.
It reports in the <code>.status</code> field the result:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>observedGeneration</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>lastError</span><span class=p>:</span><span class=w> </span><span class=l>..</span><span class=w>
</span><span class=w>  </span><span class=nt>lastOperation</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>providerStatus</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>aws.provider.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InfrastructureStatus</span><span class=w>
</span><span class=w>    </span><span class=nt>vpc</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>vpc-1234</span><span class=w>
</span><span class=w>      </span><span class=nt>subnets</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>subnet-acbd1234</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>workers</span><span class=w>
</span><span class=w>        </span><span class=nt>zone</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>      </span><span class=nt>securityGroups</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>sg-xyz12345</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>workers</span><span class=w>
</span><span class=w>    </span><span class=nt>iam</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>nodesRoleARN</span><span class=p>:</span><span class=w> </span><span class=l>&lt;some-arn&gt;</span><span class=w>
</span><span class=w>      </span><span class=nt>instanceProfileName</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span><span class=w>    </span><span class=nt>ec2</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>keyName</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span></code></pre></div><p>Gardener waits until the <code>.status.lastOperation</code>/<code>.status.lastError</code> indicates that the operation reached a final state and either continuous with the next step or stops and reports the potential error.
The extension-specific output in <code>.status.providerStatus</code> is - similar to <code>.spec.providerConfig</code> - not evaluated and simply forwarded to CRDs in subsequent steps.</p><p><strong>Example 2</strong>:</p><p>Gardener deploys the control plane components into the seed cluster, e.g. the <code>kube-controller-manager</code> deployment with the following flags:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>command</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=l>/usr/local/bin/kube-controller-manager</span><span class=w>
</span><span class=w>        </span>- --<span class=l>allocate-node-cidrs=true</span><span class=w>
</span><span class=w>        </span>- --<span class=l>attach-detach-reconcile-sync-period=1m0s</span><span class=w>
</span><span class=w>        </span>- --<span class=l>controllers=*,bootstrapsigner,tokencleaner</span><span class=w>
</span><span class=w>        </span>- --<span class=l>cluster-cidr=100.96.0.0/11</span><span class=w>
</span><span class=w>        </span>- --<span class=l>cluster-name=shoot--core--aws-01</span><span class=w>
</span><span class=w>        </span>- --<span class=l>cluster-signing-cert-file=/srv/kubernetes/ca/ca.crt</span><span class=w>
</span><span class=w>        </span>- --<span class=l>cluster-signing-key-file=/srv/kubernetes/ca/ca.key</span><span class=w>
</span><span class=w>        </span>- --<span class=l>concurrent-deployment-syncs=10</span><span class=w>
</span><span class=w>        </span>- --<span class=l>concurrent-replicaset-syncs=10</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>The AWS controller requires some additional flags in order to make the cluster functional.
It needs to provide a Kubernetes cloud-config and also some cloud-specific flags.
Consequently, it registers a <code>MutatingWebhookConfiguration</code> on <code>Deployment</code>s and adds these flags to the container:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>        </span>- --<span class=l>cloud-provider=external</span><span class=w>
</span><span class=w>        </span>- --<span class=l>external-cloud-volume-plugin=aws</span><span class=w>
</span><span class=w>        </span>- --<span class=l>cloud-config=/etc/kubernetes/cloudprovider/cloudprovider.conf</span><span class=w>
</span></code></pre></div><p>Of course, it would have needed to create a <code>ConfigMap</code> containing the cloud config and to add the proper <code>volume</code> and <code>volumeMounts</code> to the manifest as well.</p><p>(Please note for this special example: The Kubernetes community is also working on making the <code>kube-controller-manager</code> provider-independent.
However, there will most probably be still components other than the <code>kube-controller-manager</code> which need to be adapted by extensions.)</p><p>If you are interested in writing an extension, or generally in digging deeper to find out the nitty-gritty details of the extension concepts please read <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a>.
We are truly looking forward to your feedback!</p><h2 id=current-status>Current status</h2><p>Meanwhile, the out-of-tree extension architecture of Gardener is in place and has been productively validated. We are tracking all internal and external extensions of Gardener in the repo: <a href=https://github.com/gardener/gardener/tree/master/extensions#known-extension-implementations>Gardener Extensions Library</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-290f197e1bf65f50fbe08ea65cd45623>1.4.1 - BackupBucket resource</h1><h1 id=contract-backupbucket-resource>Contract: <code>BackupBucket</code> resource</h1><p>The Gardener project features a sub-project called <a href=https://github.com/gardener/etcd-backup-restore>etcd-backup-restore</a> to take periodic backups of etcd backing Shoot clusters. It demands the bucket (or its equivalent in different object store providers) to be created and configured externally with appropriate credentials. The <code>BackupBucket</code> resource takes this responsibility in Gardener.</p><p>Before introducing the <code>BackupBucket</code> extension resource Gardener was using Terraform in order to create and manage these provider-specific resources (e.g., see <a href=https://github.com/gardener/gardener/tree/0.27.0/charts/seed-terraformer/charts/aws-backup>here</a>).
Now, Gardener commissions an external, provider-specific controller to take over this task. You can also refer to backupInfra proposal documentation to get idea about how the transition was done and understand the resource in broader scope.</p><h2 id=what-is-the-scope-of-bucket>What is the scope of bucket?</h2><p>A bucket will be provisioned per <code>Seed</code>. So, backup of every <code>Shoot</code> created on that <code>Seed</code> will be stored under different shoot specific prefix under the bucket.
For the backup of the <code>Shoot</code> rescheduled on different <code>Seed</code> it will continue to use the same bucket.</p><h2 id=what-is-the-lifespan-of-backupbucket>What is the lifespan of <code>BackupBucket</code>?</h2><p>The bucket associated with <code>BackupBucket</code> will be created at creation of <code>Seed</code>. And as per current implementation, it will be deleted on deletion of <code>Seed</code> and there isn&rsquo;t any <code>BackupEntry</code> resource associated with it.</p><p>In the future, we plan to introduce schedule for <code>BackupBucket</code> the deletion logic for <code>BackupBucket</code> resource, which will reschedule the it on different available <code>Seed</code>, on deletion or failure of health check for current associated <code>seed</code>. In that case, <code>BackupBucket</code> will be deleted only if there isn&rsquo;t any schedulable <code>Seed</code> available and there isn&rsquo;t any associated <code>BackupEntry</code> resource.</p><h2 id=what-needs-to-be-implemented-to-support-a-new-infrastructure-provider>What needs to be implemented to support a new infrastructure provider?</h2><p>As part of the seed flow Gardener will create a special CRD in the seed cluster that needs to be reconciled by an extension controller, for example:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>BackupBucket</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>azure</span><span class=w>
</span><span class=w>  </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=l>&lt;some-optional-provider-specific-backupbucket-configuration&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>backupprovider</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span></code></pre></div><p>The <code>.spec.secretRef</code> contains a reference to the provider secret pointing to the account that shall be used to create the needed resources. This provider secret will be configured
by Gardener operator in the <code>Seed</code> resource and propagated over there by seed controller.</p><p>After your controller has created the required bucket, if required it generates the secret to access the objects in buckets and put reference to it in <code>status</code>. This secret is
supposed to be used by Gardener or eventually <code>BackupEntry</code> resource and etcd-backup-restore component to backup the etcd.</p><p>In order to support a new infrastructure provider you need to write a controller that watches all <code>BackupBucket</code>s with <code>.spec.type=&lt;my-provider-name></code>. You can take a look at the below referenced example implementation for the Azure provider.</p><h2 id=references-and-additional-resources>References and additional resources</h2><ul><li><a href=https://gardener.cloud/api-reference/extensions/#extensions.gardener.cloud/v1alpha1.BackupBucket><code>BackupBucket</code> API Reference</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-azure/tree/master/pkg/controller/backupbucket>Exemplary implementation for the Azure provider</a></li><li><a href=/docs/concepts/extensions/backupentry><code>BackupEntry</code> resource documentation</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/02-backupinfra.md>Shared bucket proposal</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-838b539855db0c74a2075d0a4f0ab5ad>1.4.2 - BackupEntry resource</h1><h1 id=contract-backupentry-resource>Contract: <code>BackupEntry</code> resource</h1><p>The Gardener project features a sub-project called <a href=https://github.com/gardener/etcd-backup-restore>etcd-backup-restore</a> to take periodic backups of etcd backing Shoot clusters. It demands the bucket (or its equivalent in different object store providers) access credentials to be created and configured externally with appropriate credentials. The <code>BackupEntry</code> resource takes this responsibility in Gardener to provide this information by creating a secret specific to the component. Said that, the core motivation for introducing this resource was to support retention of backups post deletion of <code>Shoot</code>. The etcd-backup-restore components takes responsibility of garbage collecting old backups out of the defined period. Once a shoot is deleted, we need to persist the backups for few days. Hence, Gardener uses the <code>BackupEntry</code> resource for this housekeeping work post deletion of a <code>Shoot</code>. The <code>BackupEntry</code> resource is responsible for shoot specific prefix under referred bucket.</p><p>Before introducing the <code>BackupEntry</code> extension resource Gardener was using Terraform in order to create and manage these provider-specific resources (e.g., see <a href=https://github.com/gardener/gardener/tree/0.27.0/charts/seed-terraformer/charts/aws-backup>here</a>).
Now, Gardener commissions an external, provider-specific controller to take over this task. You can also refer to backupInfra proposal documentation to get idea about how the transition was done and understand the resource in broader scope.</p><h2 id=what-is-the-lifespan-of-backupentry>What is the lifespan of <code>BackupEntry</code>?</h2><p>The bucket associated with <code>BackupEntry</code> will be created at using <code>BackupBucket</code> resource. The <code>BackupEntry</code> resource will be created as a part of a <code>Shoot</code> creation. But resource might continue to exist post deletion of a <code>Shoot</code> (see <a href=https://github.com/gardener/gardener/blob/master/docs/concepts/gardenlet.md#backupentry-controller>this</a> for more details).</p><h2 id=what-needs-to-be-implemented-to-support-a-new-infrastructure-provider>What needs to be implemented to support a new infrastructure provider?</h2><p>As part of the shoot flow Gardener will create a special CRD in the seed cluster that needs to be reconciled by an extension controller, for example:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>BackupEntry</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>azure</span><span class=w>
</span><span class=w>  </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=l>&lt;some-optional-provider-specific-backup-bucket-configuration&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>backupBucketProviderStatus</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=l>&lt;some-optional-provider-specific-backup-bucket-status&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>  </span><span class=nt>bucketName</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>backupprovider</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span></code></pre></div><p>The <code>.spec.secretRef</code> contains a reference to the provider secret pointing to the account that shall be used to create the needed resources. This provider secret will be propagated from <code>BackupBucket</code> resource by Shoot controller.</p><p>Your controller is supposed to create the <code>etcd-backup</code> secret in control-plane namespace of a shoot. This secret is supposed to be used by Gardener or eventually the etcd-backup-restore component to backup the etcd. The controller implementation should cleanup the objects created under shoot specific prefix in bucket equivalent to name of <code>BackupEntry</code> resource.</p><p>In order to support a new infrastructure provider you need to write a controller that watches all <code>BackupBucket</code>s with <code>.spec.type=&lt;my-provider-name></code>. You can take a look at the below referenced example implementation for the Azure provider.</p><h2 id=references-and-additional-resources>References and additional resources</h2><ul><li><a href=https://gardener.cloud/api-reference/extensions/#extensions.gardener.cloud/v1alpha1.BackupBucket><code>BackupEntry</code> API Reference</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-azure/tree/master/pkg/controller/backupentry>Exemplary implementation for the Azure provider</a></li><li><a href=/docs/concepts/extensions/backupbucket><code>BackupBucket</code> resource documentation</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/02-backupinfra.md>Shared bucket proposal</a></li><li><a href=https://github.com/gardener/gardener/blob/master/pkg/controllermanager/apis/config/types.go#L101-#L107>Gardener-controller-manager-component-config API specification</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-79aed0f811dd880c123b22728c493fe4>1.4.3 - Cluster resource</h1><h1 id=cluster-resource><code>Cluster</code> resource</h1><p>As part of the extensibility epic a lot of responsibility that was previously taken over by Gardener directly has now been shifted to extension controllers running in the seed clusters.
These extensions often serve a well-defined purpose, e.g. the management of <a href=/docs/concepts/extensions/dns>DNS records</a>, <a href=/docs/concepts/extensions/infrastructure>infrastructure</a>, etc.
We have introduced a couple of extension CRDs in the seeds whose specification is written by Gardener, and which are acted up by the extensions.</p><p>However, the extensions sometimes require more information that is not directly part of the specification.
One example of that is the GCP infrastructure controller which needs to know the shoot&rsquo;s pod and service network.
Another example is the Azure infrastructure controller which requires some information out of the <code>CloudProfile</code> resource.
The problem is that Gardener does not know which extension requires which information so that it can write it into their specific CRDs.</p><p>In order to deal with this problem we have introduced the <code>Cluster</code> extension resource.
This CRD is written into the seeds, however, it does not contain a <code>status</code>, so it is not expected that something acts upon it.
Instead, you can treat it like a <code>ConfigMap</code> which contains data that might be interesting for you.
In the context of Gardener, seeds and shoots, and extensibility the <code>Cluster</code> resource contains the <code>CloudProfile</code>, <code>Seed</code>, and <code>Shoot</code> manifest.
Extension controllers can take whatever information they want out of it that might help completing their individual tasks.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Cluster</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>cloudProfile</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CloudProfile</span><span class=w>
</span><span class=w>    </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>seed</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Seed</span><span class=w>
</span><span class=w>    </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>shoot</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w>    </span><span class=l>...</span><span class=w>
</span></code></pre></div><p>The resource is written by Gardener before it starts the reconciliation flow of the shoot.</p><p>:warning: All Gardener components use the <code>core.gardener.cloud/v1beta1</code> version, i.e., the <code>Cluster</code> resource will contain the objects in this version.</p><h2 id=important-information-that-should-be-taken-into-account>Important information that should be taken into account</h2><p>There are some fields in the <code>Shoot</code> specification that might be interesting to take into account.</p><ul><li><code>.spec.hibernation.enabled={true,false}</code>: Extension controllers might want to behave differently if the shoot is hibernated or not (probably they might want to scale down their control plane components, for example).</li><li><code>.status.lastOperation.state=Failed</code>: If Gardener sets the shoot&rsquo;s last operation state to <code>Failed</code> it means that Gardener won&rsquo;t automatically retry to finish the reconciliation/deletion flow because an error occurred that could not be resolved within the last <code>24h</code> (default). In this case end-users are expected to manually re-trigger the reconciliation flow in case they want Gardener to try again. Extension controllers are expected to follow the same principle. This means they have to read the shoot state out of the <code>Cluster</code> resource.</li></ul><h2 id=extension-resources-not-associated-with-a-shoot>Extension resources not associated with a shoot</h2><p>In some cases, Gardener may create extension resources that are not associated with a shoot, but are needed to support some functionality internal to Gardener. Such resources will be created in the <code>garden</code> namespace of a seed cluster.</p><p>For example, if the <a href=/docs/concepts/deployment/deploy_gardenlet_manually>managed ingress controller</a> is active on the seed, Gardener will create a <a href=/docs/concepts/extensions/dns>DNSProvider / DNSEntry</a> or a <a href=https://github.com/gardener/gardener/blob/master/docs/extensions/dnsrecord.md>DNSRecord</a> resource(s) in the <code>garden</code> namespace of the seed cluster for the ingress DNS record.</p><p>Extension controllers that may be expected to reconcile extension resources in the <code>garden</code> namespace should make sure that they can tolerate the absence of a cluster resource. This means that they should not attempt to read the cluster resource in such cases, or if they do they should ignore the &ldquo;not found&rdquo; error.</p><h2 id=references-and-additional-resources>References and additional resources</h2><ul><li><a href=https://github.com/gardener/gardener/blob/master/pkg/apis/extensions/v1alpha1/types_cluster.go><code>Cluster</code> API (Golang specification)</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-658c589106cbfc69e9d2cfcab10ea7c6>1.4.4 - Contributing to shoot health status conditions</h1><h1 id=contributing-to-shoot-health-status-conditions>Contributing to shoot health status conditions</h1><p>Gardener checks regularly (every minute by default) the health status of all shoot clusters.
It categorizes its checks into four different types:</p><ul><li><code>APIServerAvailable</code>: This type indicates whether the shoot&rsquo;s kube-apiserver is available or not.</li><li><code>ControlPlaneHealthy</code>: This type indicates whether all the control plane components deployed to the shoot&rsquo;s namespace in the seed do exist and are running fine.</li><li><code>EveryNodeReady</code>: This type indicates whether all <code>Node</code>s and all <code>Machine</code> objects report healthiness.</li><li><code>SystemComponentsHealthy</code>: This type indicates whether all system components deployed to the <code>kube-system</code> namespace in the shoot do exist and are running fine.</li></ul><p>Every <code>Shoot</code> resource has a <code>status.conditions[]</code> list that contains the mentioned types, together with a <code>status</code> (<code>True</code>/<code>False</code>) and a descriptive message/explanation of the <code>status</code>.</p><p>Most extension controllers are deploying components and resources as part of their reconciliation flows into the seed or shoot cluster.
A prominent example for this is the <code>ControlPlane</code> controller that usually deploys a cloud-controller-manager or CSI controllers as part of the shoot control plane.
Now that the extensions deploy resources into the cluster, especially resources that are essential for the functionality of the cluster, they might want to contribute to Gardener&rsquo;s checks mentioned above.</p><h2 id=what-can-extensions-do-to-contribute-to-gardeners-health-checks>What can extensions do to contribute to Gardener&rsquo;s health checks?</h2><p>Every extension resource in Gardener&rsquo;s <code>extensions.gardener.cloud/v1alpha1</code> API group also has a <code>status.conditions[]</code> list (like the <code>Shoot</code>).
Extension controllers can write conditions to the resource they are acting on and use a type that also exist in the shoot&rsquo;s conditions.
One exception is that <code>APIServerAvailable</code> can&rsquo;t be used as the Gardener clearly can identify the status of this condition and it doesn&rsquo;t make sense for extensions to try to contribute/modify it.</p><p>As an example for the <code>ControlPlane</code> controller let&rsquo;s take a look at the following resource:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ControlPlane</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>control-plane</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=l>...</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ControlPlaneHealthy</span><span class=w>
</span><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;False&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>DeploymentUnhealthy</span><span class=w>
</span><span class=w>    </span><span class=nt>message: &#39;Deployment cloud-controller-manager is unhealthy</span><span class=p>:</span><span class=w> </span><span class=l>condition &#34;Available&#34; has</span><span class=w>
</span><span class=w>      </span><span class=nt>invalid status False (expected True) due to MinimumReplicasUnavailable</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w>      </span><span class=l>does not have minimum availability.&#39;</span><span class=w>
</span><span class=w>    </span><span class=nt>lastUpdateTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2014-05-25T12:44:27Z&#34;</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ConfigComputedSuccessfully</span><span class=w>
</span><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>ConfigCreated</span><span class=w>
</span><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>The cloud-provider-config has been successfully computed.</span><span class=w>
</span><span class=w>    </span><span class=nt>lastUpdateTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2014-05-25T12:43:27Z&#34;</span><span class=w>
</span></code></pre></div><p>The extension controller has declared in its extension resource that one of the deployments it is responsible for is unhealthy.
Also, it has written a second condition using a type that is unknown by Gardener.</p><p>Gardener will pick the list of conditions and recognize that the there is one with a type <code>ControlPlaneHealthy</code>.
It will merge it with its own <code>ControlPlaneHealthy</code> condition and report it back to the <code>Shoot</code>&rsquo;s status:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>shoot.gardener.cloud/status</span><span class=p>:</span><span class=w> </span><span class=l>unhealthy</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>some-shoot</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden-core</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>APIServerAvailable</span><span class=w>
</span><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>HealthzRequestSucceeded</span><span class=w>
</span><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>API server /healthz endpoint responded with success status code. [response_time:31ms]</span><span class=w>
</span><span class=w>    </span><span class=nt>lastUpdateTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2014-05-23T08:26:52Z&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2014-05-25T12:45:13Z&#34;</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ControlPlaneHealthy</span><span class=w>
</span><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;False&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>ControlPlaneUnhealthyReport</span><span class=w>
</span><span class=w>    </span><span class=nt>message: &#39;Deployment cloud-controller-manager is unhealthy</span><span class=p>:</span><span class=w> </span><span class=l>condition &#34;Available&#34; has</span><span class=w>
</span><span class=w>      </span><span class=nt>invalid status False (expected True) due to MinimumReplicasUnavailable</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w>      </span><span class=l>does not have minimum availability.&#39;</span><span class=w>
</span><span class=w>    </span><span class=nt>lastUpdateTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2014-05-25T12:45:13Z&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2014-05-25T12:45:13Z&#34;</span><span class=w>
</span><span class=w>  </span><span class=l>...</span><span class=w>
</span></code></pre></div><p>Hence, the only duty extensions have is to maintain the health status of their components in the extension resource they are managing.
This can be accomplished using the <a href=/docs/concepts/extensions/healthcheck-library>health check library for extensions</a>.</p><h2 id=error-codes>Error Codes</h2><p>The Gardener API includes some well-defined error codes, e.g., <code>ERR_INFRA_UNAUTHORIZED</code>, <code>ERR_INFRA_DEPENDENCIES</code>, etc.
Extension may set these error codes in the <code>.status.conditions[].codes[]</code> list in case it makes sense.
Gardener will pick them up and will similarly merge them into the <code>.status.conditions[].codes[]</code> list in the <code>Shoot</code>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ControlPlaneHealthy</span><span class=w>
</span><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;False&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>DeploymentUnhealthy</span><span class=w>
</span><span class=w>    </span><span class=nt>message: &#39;Deployment cloud-controller-manager is unhealthy</span><span class=p>:</span><span class=w> </span><span class=l>condition &#34;Available&#34; has</span><span class=w>
</span><span class=w>      </span><span class=nt>invalid status False (expected True) due to MinimumReplicasUnavailable</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w>      </span><span class=l>does not have minimum availability.&#39;</span><span class=w>
</span><span class=w>    </span><span class=nt>lastUpdateTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2014-05-25T12:44:27Z&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>codes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>ERR_INFRA_UNAUTHORIZED </span><span class=w>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4777054e1473c81ff05c71fd99ea6ccc>1.4.5 - Controlplane customization webhooks</h1><h1 id=controlplane-customization-webhooks>Controlplane customization webhooks</h1><p>Gardener creates the Shoot controlplane in several steps of the Shoot flow. At different point of this flow, it:</p><ul><li>deploys standard controlplane components such as kube-apiserver, kube-controller-manager, and kube-scheduler by creating the corresponding deployments, services, and other resources in the Shoot namespace.</li><li>initiates the deployment of custom controlplane components by <a href=/docs/concepts/extensions/controlplane>ControlPlane controllers</a> by creating a <code>ControlPlane</code> resource in the Shoot namespace.</li></ul><p>In order to apply any provider-specific changes to the configuration provided by Gardener for the standard controlplane components, cloud extension providers can install mutating admission webhooks for the resources created by Gardener in the Shoot namespace.</p><h2 id=what-needs-to-be-implemented-to-support-a-new-cloud-provider>What needs to be implemented to support a new cloud provider?</h2><p>In order to support a new cloud provider you should install &ldquo;controlplane&rdquo; mutating webhooks for any of the following resources:</p><ul><li>Deployment with name <code>kube-apiserver</code>, <code>kube-controller-manager</code>, or <code>kube-scheduler</code></li><li>StatefulSet with name <code>etcd-main</code> or <code>etcd-events</code></li><li>Service with name <code>kube-apiserver</code></li><li><code>OperatingSystemConfig</code> with any name and purpose <code>reconcile</code></li></ul><p>See <a href=#contract-specification>Contract Specification</a> for more details on the contract that Gardener and webhooks should adhere to regarding the content of the above resources.</p><p>You can install 3 different kinds of controlplane webhooks:</p><ul><li><code>Shoot</code>, or <code>controlplane</code> webhooks apply changes needed by the Shoot cloud provider, for example the <code>--cloud-provider</code> command line flag of <code>kube-apiserver</code> and <code>kube-controller-manager</code>. Such webhooks should only operate on Shoot namespaces labeled with <code>shoot.gardener.cloud/provider=&lt;provider></code>.</li><li><code>Seed</code>, or <code>controlplaneexposure</code> webhooks apply changes needed by the Seed cloud provider, for example annotations on the <code>kube-apiserver</code> service to ensure cloud-specific load balancers are correctly provisioned for a service of type <code>LoadBalancer</code>. Such webhooks should only operate on Shoot namespaces labeled with <code>seed.gardener.cloud/provider=&lt;provider></code>.</li></ul><p>The labels <code>shoot.gardener.cloud/provider</code> and <code>shoot.gardener.cloud/provider</code> are added by Gardener when it creates the Shoot namespace.</p><h2 id=contract-specification>Contract Specification</h2><p>This section specifies the contract that Gardener and webhooks should adhere to in order to ensure smooth interoperability. Note that this contract can&rsquo;t be specified formally and is therefore easy to violate, especially by Gardener. The Gardener team will nevertheless do its best to adhere to this contract in the future and to ensure via additional measures (tests, validations) that it&rsquo;s not unintentionally broken. If it needs to be changed intentionally, this can only happen after proper communication has taken place to ensure that the affected provider webhooks could be adapted to work with the new version of the contract.</p><p><strong>Note:</strong> The contract described below may not necessarily be what Gardener does currently (as of May 2019). Rather, it reflects the target state after changes for <a href=/docs/concepts/extensions>Gardener extensibility</a> have been introduced.</p><h3 id=kube-apiserver>kube-apiserver</h3><p>To deploy kube-apiserver, Gardener <strong>shall</strong> create a deployment and a service both named <code>kube-apiserver</code> in the Shoot namespace. They can be mutated by webhooks to apply any provider-specific changes to the standard configuration provided by Gardener.</p><p>The pod template of the <code>kube-apiserver</code> deployment <strong>shall</strong> contain a container named <code>kube-apiserver</code>.</p><p>The <code>command</code> field of the <code>kube-apiserver</code> container <strong>shall</strong> contain the <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/>kube-apiserver command line</a>. It <strong>shall</strong> contain a number of provider-independent flags that should be ignored by webhooks, such as:</p><ul><li>admission plugins (<code>--enable-admission-plugins</code>, <code>--disable-admission-plugins</code>)</li><li>secure communications (<code>--etcd-cafile</code>, <code>--etcd-certfile</code>, <code>--etcd-keyfile</code>, &mldr;)</li><li>audit log (<code>--audit-log-*</code>)</li><li>ports (<code>--insecure-port</code>, <code>--secure-port</code>)</li></ul><p>The kube-apiserver command line <strong>shall not</strong> contain any provider-specific flags, such as:</p><ul><li><code>--cloud-provider</code></li><li><code>--cloud-config</code></li></ul><p>These flags can be added by webhooks if needed.</p><p>The <code>kube-apiserver</code> command line <strong>may</strong> contain a number of additional provider-independent flags. In general, webhooks should ignore these unless they are known to interfere with the desired kube-apiserver behavior for the specific provider. Among the flags to be considered are:</p><ul><li><code>--endpoint-reconciler-type</code></li><li><code>--advertise-address</code></li><li><code>--feature-gates</code></li></ul><p>Gardener <strong>may</strong> use <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/08-shoot-apiserver-via-sni.md>SNI</a> to expose the apiserver (<code>APIServerSNI</code> feature gate). In this case, Gardener <strong>shall</strong> label the <code>kube-apiserver</code>&rsquo;s <code>Deployment</code> with <code>core.gardener.cloud/apiserver-exposure: gardener-managed</code> label and expects that the <code>--endpoint-reconciler-type</code> and <code>--advertise-address</code> flags are not modified.</p><p>The <code>--enable-admission-plugins</code> flag <strong>may</strong> contain admission plugins that are not compatible with CSI plugins such as <code>PersistentVolumeLabel</code>. Webhooks should therefore ensure that such admission plugins are either explicitly enabled (if CSI plugins are not used) or disabled (otherwise).</p><p>The <code>env</code> field of the <code>kube-apiserver</code> container <strong>shall not</strong> contain any provider-specific environment variables (so it will be empty). If any provider-specific environment variables are needed, they should be added by webhooks.</p><p>The <code>volumes</code> field of the pod template of the <code>kube-apiserver</code> deployment, and respectively the <code>volumeMounts</code> field of the <code>kube-apiserver</code> container <strong>shall not</strong> contain any provider-specific <code>Secret</code> or <code>ConfigMap</code> resources. If such resources should be mounted as volumes, this should be done by webhooks.</p><p>The <code>kube-apiserver</code> <code>Service</code> <strong>may</strong> be of type <code>LoadBalancer</code>, but <strong>shall not</strong> contain any provider-specific annotations that may be needed to actually provision a load balancer resource in the Seed provider&rsquo;s cloud. If any such annotations are needed, they should be added by webhooks (typically <code>controlplaneexposure</code> webhooks).</p><p>The <code>kube-apiserver</code> <code>Service</code> <strong>shall</strong> be of type <code>ClusterIP</code>, if Gardener is using <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/08-shoot-apiserver-via-sni.md>SNI</a> to expose the apiserver (<code>APIServerSNI</code> feature gate). In this case, Gardener <strong>shall</strong> label this <code>Service</code> with <code>core.gardener.cloud/apiserver-exposure: gardener-managed</code> label and expects that no mutations happen.</p><h3 id=kube-controller-manager>kube-controller-manager</h3><p>To deploy kube-controller-manager, Gardener <strong>shall</strong> create a deployment named <code>kube-controller-manager</code> in the Shoot namespace. It can be mutated by webhooks to apply any provider-specific changes to the standard configuration provided by Gardener.</p><p>The pod template of the <code>kube-controller-manager</code> deployment <strong>shall</strong> contain a container named <code>kube-controller-manager</code>.</p><p>The <code>command</code> field of the <code>kube-controller-manager</code> container <strong>shall</strong> contain the <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/>kube-controller-manager command line</a>. It <strong>shall</strong> contain a number of provider-independent flags that should be ignored by webhooks, such as:</p><ul><li><code>--kubeconfig</code>, <code>--authentication-kubeconfig</code>, <code>--authorization-kubeconfig</code></li><li><code>--leader-elect</code></li><li>secure communications (<code>--tls-cert-file</code>, <code>--tls-private-key-file</code>, &mldr;)</li><li>cluster CIDR and identity (<code>--cluster-cidr</code>, <code>--cluster-name</code>)</li><li>sync settings (<code>--concurrent-deployment-syncs</code>, <code>--concurrent-replicaset-syncs</code>)</li><li>horizontal pod autoscaler (<code>--horizontal-pod-autoscaler-*</code>)</li><li>ports (<code>--port</code>, <code>--secure-port</code>)</li></ul><p>The kube-controller-manager command line <strong>shall not</strong> contain any provider-specific flags, such as:</p><ul><li><code>--cloud-provider</code></li><li><code>--cloud-config</code></li><li><code>--configure-cloud-routes</code></li><li><code>--external-cloud-volume-plugin</code></li></ul><p>These flags can be added by webhooks if needed.</p><p>The kube-controller-manager command line <strong>may</strong> contain a number of additional provider-independent flags. In general, webhooks should ignore these unless they are known to interfere with the desired kube-controller-manager behavior for the specific provider. Among the flags to be considered are:</p><ul><li><code>--feature-gates</code></li></ul><p>The <code>env</code> field of the <code>kube-controller-manager</code> container <strong>shall not</strong> contain any provider-specific environment variables (so it will be empty). If any provider-specific environment variables are needed, they should be added by webhooks.</p><p>The <code>volumes</code> field of the pod template of the <code>kube-controller-manager</code> deployment, and respectively the <code>volumeMounts</code> field of the <code>kube-controller-manager</code> container <strong>shall not</strong> contain any provider-specific <code>Secret</code> or <code>ConfigMap</code> resources. If such resources should be mounted as volumes, this should be done by webhooks.</p><h3 id=kube-scheduler>kube-scheduler</h3><p>To deploy kube-scheduler, Gardener <strong>shall</strong> create a deployment named <code>kube-scheduler</code> in the Shoot namespace. It can be mutated by webhooks to apply any provider-specific changes to the standard configuration provided by Gardener.</p><p>The pod template of the <code>kube-scheduler</code> deployment <strong>shall</strong> contain a container named <code>kube-scheduler</code>.</p><p>The <code>command</code> field of the <code>kube-scheduler</code> container <strong>shall</strong> contain the <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-scheduler/>kube-scheduler command line</a>. It <strong>shall</strong> contain a number of provider-independent flags that should be ignored by webhooks, such as:</p><ul><li><code>--config</code></li><li><code>--authentication-kubeconfig</code>, <code>--authorization-kubeconfig</code></li><li>secure communications (<code>--tls-cert-file</code>, <code>--tls-private-key-file</code>, &mldr;)</li><li>ports (<code>--port</code>, <code>--secure-port</code>)</li></ul><p>The kube-scheduler command line <strong>may</strong> contain additional provider-independent flags. In general, webhooks should ignore these unless they are known to interfere with the desired kube-controller-manager behavior for the specific provider. Among the flags to be considered are:</p><ul><li><code>--feature-gates</code></li></ul><p>The kube-scheduler command line can&rsquo;t contain provider-specific flags, and it makes no sense to specify provider-specific environment variables or mount provider-specific <code>Secret</code> or <code>ConfigMap</code> resources as volumes.</p><h3 id=etcd-main-and-etcd-events>etcd-main and etcd-events</h3><p>To deploy etcd, Gardener <strong>shall</strong> create 2 StatefulSets named <code>etcd-main</code> and <code>etcd-events</code> in the Shoot namespace. They can be mutated by webhooks to apply any provider-specific changes to the standard configuration provided by Gardener.</p><p>The pod template of these 2 deployments <strong>shall</strong> contain a container named <code>etcd</code>. It <strong>shall not</strong> contain a sidecar container for etcd backups. If such a container is needed, it should be added by webhooks, together with any volumes it may need to mount.</p><p>The <code>command</code> field of the <code>etcd</code> container <strong>shall</strong> contain the etcd command line. It <strong>shall</strong> contain only provider-independent flags that should be ignored by webhooks. It can&rsquo;t contain provider-specific flags, and it makes no sense to specify provider-specific environment variables or mount provider-specific <code>Secret</code> or <code>ConfigMap</code> resources as volumes.</p><p>The <code>volumeClaimTemplates</code> section of these 2 StatefulSets <strong>shall</strong> contain a template named <code>etcd-main</code> or <code>etcd-events</code>. This template <strong>shall</strong> use the default storage class. The corresponding claim is mounted into the <code>etcd</code> container at <code>/var/etcd/data</code>. If it is desirable to use a non-default storage class, this should be done by webhooks.</p><h3 id=cloud-controller-manager>cloud-controller-manager</h3><p>Gardener <strong>shall not</strong> deploy a cloud-controller-manager. If it is needed, it should be added by a <a href=/docs/concepts/extensions/controlplane><code>ControlPlane</code> controller</a></p><h3 id=csi-controllers>CSI controllers</h3><p>Gardener <strong>shall not</strong> deploy a CSI controller. If it is needed, it should be added by a <a href=/docs/concepts/extensions/controlplane><code>ControlPlane</code> controller</a></p><h3 id=kubelet>kubelet</h3><p>To specify the kubelet configuration, Gardener <strong>shall</strong> create a <a href=/docs/concepts/extensions/operatingsystemconfig><code>OperatingSystemConfig</code> resource</a> with any name and purpose <code>reconcile</code> in the Shoot namespace. It can therefore also be mutated by webhooks to apply any provider-specific changes to the standard configuration provided by Gardener. Gardener <strong>may</strong> write multiple such resources with different <code>type</code> to the same Shoot namespaces if multiple OSs are used.</p><p>The OSC resource <strong>shall</strong> contain a unit named <code>kubelet.service</code>, containing the corresponding systemd unit configuration file. The <code>[Service]</code> section of this file <strong>shall</strong> contain a single <code>ExecStart</code> option having the <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/>kubelet command line</a> as its value.</p><p>The OSC resource <strong>shall</strong> contain a file with path <code>/var/lib/kubelet/config/kubelet</code>, which contains a <code>KubeletConfiguration</code> resource in YAML format. Most of the flags that can be specified in the kubelet command line can alternatively be specified as options in this configuration as well.</p><p>The kubelet command line <strong>shall</strong> contain a number of provider-independent flags that should be ignored by webhooks, such as:</p><ul><li><code>--config</code></li><li><code>--bootstrap-kubeconfig</code>, <code>--kubeconfig</code></li><li><code>--network-plugin</code> (and, if it equals <code>cni</code>, also <code>--cni-bin-dir</code> and <code>--cni-conf-dir</code>)</li><li><code>--node-labels</code></li></ul><p>The kubelet command line <strong>shall not</strong> contain any provider-specific flags, such as:</p><ul><li><code>--cloud-provider</code></li><li><code>--cloud-config</code></li><li><code>--provider-id</code></li></ul><p>These flags can be added by webhooks if needed.</p><p>The kubelet command line / configuration <strong>may</strong> contain a number of additional provider-independent flags / options. In general, webhooks should ignore these unless they are known to interfere with the desired kubelet behavior for the specific provider. Among the flags / options to be considered are:</p><ul><li><code>--enable-controller-attach-detach</code> (<code>enableControllerAttachDetach</code>) - should be set to <code>true</code> if CSI plugins are used, but in general can also be ignored since its default value is also <code>true</code>, and this should work both with and without CSI plugins.</li><li><code>--feature-gates</code> (<code>featureGates</code>) - should contain a list of specific feature gates if CSI plugins are used. If CSI plugins are not used, the corresponding feature gates can be ignored since enabling them should not harm in any way.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-37672c55c9210dcd6a96cc643631e6a2>1.4.6 - ControlPlane resource</h1><h1 id=contract-controlplane-resource>Contract: <code>ControlPlane</code> resource</h1><p>Most Kubernetes clusters require a <code>cloud-controller-manager</code> or CSI drivers in order to work properly.
Before introducing the <code>ControlPlane</code> extension resource Gardener was having several different Helm charts for the <code>cloud-controller-manager</code> deployments for the various providers.
Now, Gardener commissions an external, provider-specific controller to take over this task.</p><h2 id=which-control-plane-resources-are-required>Which control plane resources are required?</h2><p>As mentioned in the <a href=/docs/concepts/extensions/controlplane-webhooks>controlplane customization webhooks</a> document Gardener shall not deploy any <code>cloud-controller-manager</code> or any other provider-specific component.
Instead, it creates a <code>ControlPlane</code> CRD that should be picked up by provider extensions.
Its purpose is to trigger the deployment of such provider-specific components in the shoot namespace in the seed cluster.</p><h2 id=what-needs-to-be-implemented-to-support-a-new-infrastructure-provider>What needs to be implemented to support a new infrastructure provider?</h2><p>As part of the shoot flow Gardener will create a special CRD in the seed cluster that needs to be reconciled by an extension controller, for example:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ControlPlane</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>control-plane</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>openstack</span><span class=w>
</span><span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>europe-west1</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudprovider</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w>  </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>openstack.provider.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ControlPlaneConfig</span><span class=w>
</span><span class=w>    </span><span class=nt>loadBalancerProvider</span><span class=p>:</span><span class=w> </span><span class=l>provider</span><span class=w>
</span><span class=w>    </span><span class=nt>zone</span><span class=p>:</span><span class=w> </span><span class=l>eu-1a</span><span class=w>
</span><span class=w>    </span><span class=nt>cloudControllerManager</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>featureGates</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>CustomResourceValidation</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>  </span><span class=nt>infrastructureProviderStatus</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>openstack.provider.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InfrastructureStatus</span><span class=w>
</span><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>floatingPool</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>vpc-1234</span><span class=w>
</span><span class=w>      </span><span class=nt>subnets</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>nodes</span><span class=w>
</span><span class=w>        </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>subnetid</span><span class=w>
</span></code></pre></div><p>The <code>.spec.secretRef</code> contains a reference to the provider secret pointing to the account that shall be used for the shoot cluster.
However, the most important section is the <code>.spec.providerConfig</code> and the <code>.spec.infrastructureProviderStatus</code>.
The first one contains an embedded declaration of the provider specific configuration for the control plane (that cannot be known by Gardener itself).
You are responsible for designing how this configuration looks like.
Gardener does not evaluate it but just copies this part from what has been provided by the end-user in the <code>Shoot</code> resource.
The second one contains the output of the <a href=/docs/concepts/extensions/infrastructure><code>Infrastructure</code> resource</a> (that might be relevant for the CCM config).</p><p>In order to support a new control plane provider you need to write a controller that watches all <code>ControlPlane</code>s with <code>.spec.type=&lt;my-provider-name></code>.
You can take a look at the below referenced example implementation for the Alicloud provider.</p><p>The control plane controller as part of the <code>ControlPlane</code> reconciliation, often deploys resources (e.g. pods/deployments) into the Shoot namespace in the <code>Seed</code> as part of its <code>ControlPlane</code> reconciliation loop.
Because the namespace contains <a href=https://kubernetes.io/docs/concepts/services-networking/network-policies/>network policies</a> that per default <a href=https://kubernetes.io/docs/concepts/services-networking/network-policies/#default-deny-all-ingress-and-all-egress-traffic>deny all ingress and egress traffic</a>,
the pods may need to have proper labels matching to the selectors of the network policies in order to allow the required network traffic.
Otherwise, they won&rsquo;t be allowed to talk to certain other components (e.g., the kube-apiserver of the shoot).
Please <a href=https://github.com/gardener/gardener/tree/master/docs/development/seed_network_policies.md>see this document</a> for more information.</p><h2 id=non-provider-specific-information-required-for-infrastructure-creation>Non-provider specific information required for infrastructure creation</h2><p>Most providers might require further information that is not provider specific but already part of the shoot resource.
One example for this is the <a href=https://github.com/gardener/gardener-extension-provider-gcp/tree/master/pkg/controller/controlplane>GCP control plane controller</a> which needs the Kubernetes version of the shoot cluster (because it already uses the in-tree Kubernetes cloud-controller-manager).
As Gardener cannot know which information is required by providers it simply mirrors the <code>Shoot</code>, <code>Seed</code>, and <code>CloudProfile</code> resources into the seed.
They are part of the <a href=/docs/concepts/extensions/cluster><code>Cluster</code> extension resource</a> and can be used to extract information that is not part of the <code>Infrastructure</code> resource itself.</p><h2 id=references-and-additional-resources>References and additional resources</h2><ul><li><a href=https://github.com/gardener/gardener/blob/master/pkg/apis/extensions/v1alpha1/types_controlplane.go><code>ControlPlane</code> API (Golang specification)</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-alicloud/tree/master/pkg/controller/controlplane>Exemplary implementation for the Alicloud provider</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2ed0bb789ca134eb188a70592fa3568d>1.4.7 - ControlPlane resource with purpose exposure</h1><h1 id=contract-controlplane-resource-with-purpose-exposure>Contract: <code>ControlPlane</code> resource with purpose <code>exposure</code></h1><p>Some Kubernetes clusters require an additional deployments required by the seed cloud provider in order to work properly, e.g. AWS Load Balancer Readvertiser.
Before using ControlPlane resources with purpose <code>exposure</code> Gardener was having different Helm charts for the deployments for the various providers.
Now, Gardener commissions an external, provider-specific controller to take over this task.</p><h2 id=which-control-plane-resources-are-required>Which control plane resources are required?</h2><p>As mentioned in the <a href=/docs/concepts/extensions/controlplane>controlplane</a> document Gardener shall not deploy any other provider-specific component.
Instead, it creates a <code>ControlPlane</code> CRD with purpose <code>exposure</code> that should be picked up by provider extensions.
Its purpose is to trigger the deployment of such provider-specific components in the shoot namespace in the seed cluster that are needed to expose the kube-apiserver.</p><p>The shoot cluster&rsquo;s kube-apiserver are exposed via a <code>Service</code> of type <code>LoadBalancer</code> from the shoot provider (you may run the control plane of an Azure shoot in a GCP seed) it&rsquo;s the seed provider extension controller that should act on the <code>ControlPlane</code> resources with purpose <code>exposure</code>.</p><p>If <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/08-shoot-apiserver-via-sni.md>SNI</a> is enabled, then the <code>Service</code> from above is of type <code>ClusterIP</code> and Gardner will not create <code>ControlPlane</code> resources with purpose <code>exposure</code>.</p><h2 id=what-needs-to-be-implemented-to-support-a-new-infrastructure-provider>What needs to be implemented to support a new infrastructure provider?</h2><p>As part of the shoot flow Gardener will create a special CRD in the seed cluster that needs to be reconciled by an extension controller, for example:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ControlPlane</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>control-plane-exposure</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws</span><span class=w>
</span><span class=w>  </span><span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>exposure</span><span class=w>
</span><span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>europe-west1</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudprovider</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span></code></pre></div><p>The <code>.spec.secretRef</code> contains a reference to the provider secret pointing to the account that shall be used for the shoot cluster.
It is most likely not needed, however, still added for some potential corner cases.
If you don&rsquo;t need it then just ignore it.
The <code>.spec.region</code> contains the region of the seed cluster.</p><p>In order to support a control plane provider with purpose <code>exposure</code> you need to write a controller or expand the existing <a href=/docs/concepts/extensions/controlplane>controlplane controller</a> that watches all <code>ControlPlane</code>s with <code>.spec.type=&lt;my-provider-name></code> and purpose <code>exposure</code>.
You can take a look at the below referenced example implementation for the AWS provider.</p><h2 id=non-provider-specific-information-required-for-infrastructure-creation>Non-provider specific information required for infrastructure creation</h2><p>Most providers might require further information that is not provider specific but already part of the shoot resource.
As Gardener cannot know which information is required by providers it simply mirrors the <code>Shoot</code>, <code>Seed</code>, and <code>CloudProfile</code> resources into the seed.
They are part of the <a href=/docs/concepts/extensions/cluster><code>Cluster</code> extension resource</a> and can be used to extract information.</p><h2 id=references-and-additional-resources>References and additional resources</h2><ul><li><a href=https://github.com/gardener/gardener/blob/master/pkg/apis/extensions/v1alpha1/types_controlplane.go><code>ControlPlane</code> API (Golang specification)</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-aws/tree/master/pkg/controller/controlplane>Exemplary implementation for the AWS provider</a></li><li><a href=https://github.com/gardener/aws-lb-readvertiser>AWS Load Balancer Readvertiser</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7e2eb0cbadbb031e3d21c638fcdac1e1>1.4.8 - DNSProvider and DNSEntry resources</h1><h1 id=contract-dnsprovider-and-dnsentry-resources>Contract: <code>DNSProvider</code> and <code>DNSEntry</code> resources</h1><p>Every shoot cluster requires external DNS records that are publicly resolvable.
The management of these DNS records requires provider-specific knowledge which is to be developed outside of the Gardener&rsquo;s core repository.</p><h2 id=what-does-gardener-create-dns-records-for>What does Gardener create DNS records for?</h2><h3 id=internal-domain-name>Internal domain name</h3><p>Every shoot cluster&rsquo;s kube-apiserver running in the seed is exposed via a load balancer that has a public endpoint (IP or hostname).
This endpoint is used by end-users and also by system components (that are running in another network, e.g., the kubelet or kube-proxy) to talk to the cluster.
In order to be robust against changes of this endpoint (e.g., caused due to re-creation of the load balancer or move of the control plane to another seed cluster) Gardener creates a so-called <em>internal domain name</em> for every shoot cluster.
The <em>internal domain name</em> is a publicly resolvable DNS record that points to the load balancer of the kube-apiserver.
Gardener uses this domain name in the kubeconfigs of all system components (instead of writing the load balancer endpoint directly into it.
This way Gardener does not need to recreate all the kubeconfigs if the endpoint changes - it just needs to update the DNS record.</p><h3 id=external-domain-name>External domain name</h3><p>The internal domain name is not configurable by end-users directly but dictated by the Gardener administrator.
However, end-users usually prefer to have another DNS name, maybe even using their own domain sometimes to access their Kubernetes clusters.
Gardener supports that by creating another DNS record, named <em>external domain name</em>, that actually points to the <em>internal domain name</em>.
The kubeconfig handed out to end-users does contain this <em>external domain name</em>, i.e., users can access their clusters with the DNS name they like to.</p><p>As not every end-user has an own domain it is possible for Gardener administrators to configure so-called <em>default domains</em>.
If configured, shoots that do not specify a domain explicitly get an <em>external domain name</em> based on a default domain (unless explicitly stated that this shoot should not get an external domain name (<code>.spec.dns.provider=unmanaged</code>).</p><h3 id=domain-name-for-ingress-deprecated>Domain name for ingress (deprecated)</h3><p>Gardener allows to deploy a <code>nginx-ingress-controller</code> into a shoot cluster (deprecated).
This controller is exposed via a public load balancer (again, either IP or hostname).
Gardener creates a wildcard DNS record pointing to this load balancer.
<code>Ingress</code> resources can later use this wildcard DNS record to expose underlying applications.</p><h2 id=what-needs-to-be-implemented-to-support-a-new-dns-provider>What needs to be implemented to support a new DNS provider?</h2><p>As part of the shoot flow Gardener will create two special resources in the seed cluster that need to be reconciled by an extension controller.
The first resource (<code>DNSProvider</code>) is a declaration of a DNS provider (e.g., <code>aws-route53</code>, <code>google-clouddns</code>, &mldr;) with a reference to a <code>Secret</code> object that contains the provider-specific credentials in order to talk to the provider&rsquo;s API.
It also allows to specify two lists of domains that shall be allowed or disallowed to be used for DNS entries:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>aws-credentials</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># aws-route53 specific credentials here</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>dns.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DNSProvider</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-aws-account</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws-route53</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>aws-credentials</span><span class=w>
</span><span class=w>  </span><span class=nt>domains</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>include</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>dev.my-fancy-domain.com</span><span class=w>
</span><span class=w>    </span><span class=nt>exclude</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>staging.my-fancy-domain.com</span><span class=w>
</span><span class=w>    </span>- <span class=l>prod.my-fancy-domain.com</span><span class=w>
</span></code></pre></div><p>When reconciling this resource the DNS controller has to read information about available DNS zones to figure out which domains can actually be supported by the provided credentials.
Based on the constraints given in the <code>DNSProvider</code> resources <code>.spec.domains.{include|exclude}</code> fields it shall later only allow certain DNS entries.
Gardener waits until the <code>status</code> indicates that the registration went well:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>dns.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DNSProvider</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>Ready</span><span class=w>
</span><span class=w>  </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>everything ok</span><span class=w>
</span></code></pre></div><p>Other possible states are <code>Pending</code>, <code>Error</code>, and <code>Invalid</code>.
The DNS controller may provide an explanation of the <code>.status.state</code> in the <code>.status.message</code> field.</p><p>Now Gardener may create <code>DNSEntry</code> objects that represent the ask to create an actual external DNS record:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>dns.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DNSEntry</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dns</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>dnsName</span><span class=p>:</span><span class=w> </span><span class=l>apiserver.cluster1.dev.my-fancy-domain.com</span><span class=w>
</span><span class=w>  </span><span class=nt>ttl</span><span class=p>:</span><span class=w> </span><span class=m>600</span><span class=w>
</span><span class=w>  </span><span class=nt>targets</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=m>8.8.8.8</span><span class=w>
</span></code></pre></div><p>It has to be automatically determined whether the to-be-created DNS record is of type <code>A</code> or <code>CNAME</code>.
The spec shall also allow the creation of <code>TXT</code> records, e.g.:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>dns.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DNSEntry</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dns</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>dnsName</span><span class=p>:</span><span class=w> </span><span class=l>data.apiserver.cluster1.dev.my-fancy-domain.com</span><span class=w>
</span><span class=w>  </span><span class=nt>ttl</span><span class=p>:</span><span class=w> </span><span class=m>120</span><span class=w>
</span><span class=w>  </span><span class=nt>text</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    </span><span class=w>    </span><span class=l>content for the DNS TXT record</span><span class=w>
</span></code></pre></div><p>The <code>status</code> section of this resource looks similar like the <code>DNSProvider</code>&rsquo;s.
Gardener is (as of today) only evaluating the <code>.status.state</code> and <code>.status.message</code> fields.</p><h2 id=references-and-additional-resources>References and additional resources</h2><ul><li><a href=https://github.com/gardener/external-dns-management/tree/master/pkg/apis/dns/v1alpha1><code>DNSProvider</code> and <code>DNSEntry</code> API (Golang specification)</a></li><li><a href=https://github.com/gardener/external-dns-management>external-dns-management project in Gardener&rsquo;s GitHub organization</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-cde1024e46868b0bb6f504808bfc564e>1.4.9 - Extending project roles</h1><h1 id=extending-project-roles>Extending project roles</h1><p>The <code>Project</code> resource allows to specify a list of roles for every member (<code>.spec.members[*].roles</code>).
There are a few standard roles defined by Gardener itself.
Please consult <a href=https://github.com/gardener/gardener/blob/master/docs/usage/projects.md>this document</a> for further information.</p><p>However, extension controllers running in the garden cluster may also create <code>CustomResourceDefinition</code>s that project members might be able to CRUD.
For this purpose Gardener also allows to specify extension roles.</p><p>An extension role is prefixed with <code>extension:</code>, e.g.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Project</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>members</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>User</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alice.doe@example.com</span><span class=w>
</span><span class=w>    </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span><span class=w>    </span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>owner</span><span class=w>
</span><span class=w>    </span>- <span class=l>extension:foo</span><span class=w>
</span></code></pre></div><p>The project controller will, for every extension role, create a <code>ClusterRole</code> with name <code>name: gardener.cloud:extension:project:&lt;projectName>:&lt;roleName></code>, i.e., for above example: <code>name: gardener.cloud:extension:project:dev:foo</code>.
This <code>ClusterRole</code> aggregates other <code>ClusterRole</code>s that are labeled with <code>rbac.gardener.cloud/aggregate-to-extension-role=foo</code> which might be created by extension controllers.</p><p>Extension that might want to contribute to the core <code>admin</code> or <code>viewer</code> roles can use the labels <code>rbac.gardener.cloud/aggregate-to-project-member=true</code> or <code>rbac.gardener.cloud/aggregate-to-project-viewer=true</code>, respectively.</p><p>Please note that the names of the extension roles are restricted to 20 characters!</p><p>Moreover, the project controller will also create a corresponding <code>RoleBinding</code> with the same name in the project namespace.
It will automatically assign all members that are assigned to this extension role.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f1b6162523f3ac30458d5d66be2950f8>1.4.10 - Extensibility overview</h1><h1 id=extensibility-overview>Extensibility overview</h1><p>Initially, everything was developed in-tree in the Gardener project. All cloud providers and the configuration for all the supported operating systems were released together with the Gardener core itself.
But as the project grew, it got more and more difficult to add new providers and maintain the existing code base.
As a consequence and in order to become agile and flexible again, we proposed <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> (Gardener Enhancement Proposal).
The document describes an out-of-tree extension architecture that keeps the Gardener core logic independent of provider-specific knowledge (similar to what Kubernetes has achieved with <a href=https://github.com/kubernetes/enhancements/issues/88>out-of-tree cloud providers</a> or with <a href=https://github.com/kubernetes/community/pull/1258>CSI volume plugins</a>).</p><h2 id=basic-concepts>Basic concepts</h2><p>Gardener keeps running in the &ldquo;garden cluster&rdquo; and implements the core logic of shoot cluster reconciliation/deletion.
Extensions are Kubernetes controllers themselves (like Gardener) and run in the seed clusters.
As usual, we try to use Kubernetes wherever applicable.
We rely on Kubernetes extension concepts in order to enable extensibility for Gardener.
The main ideas of GEP-1 are the following:</p><ol><li><p>During the shoot reconciliation process Gardener will write CRDs into the seed cluster that are watched and managed by the extension controllers. They will reconcile (based on the <code>.spec</code>) and report whether everything went well or errors occurred in the CRD&rsquo;s <code>.status</code> field.</p></li><li><p>Gardener keeps deploying the provider-independent control plane components (etcd, kube-apiserver, etc.). However, some of these components might still need little customization by providers, e.g., additional configuration, flags, etc. In this case, the extension controllers register webhooks in order to manipulate the manifests.</p></li></ol><p><strong>Example 1</strong>:</p><p>Gardener creates a new AWS shoot cluster and requires the preparation of infrastructure in order to proceed (networks, security groups, etc.).
It writes the following CRD into the seed cluster:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Infrastructure</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>infrastructure</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--core--aws-01</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws</span><span class=w>
</span><span class=w>  </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>aws.provider.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InfrastructureConfig</span><span class=w>
</span><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>vpc</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>10.250.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>      </span><span class=nt>internal</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=m>10.250.112.0</span><span class=l>/22</span><span class=w>
</span><span class=w>      </span><span class=nt>public</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=m>10.250.96.0</span><span class=l>/22</span><span class=w>
</span><span class=w>      </span><span class=nt>workers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=m>10.250.0.0</span><span class=l>/19</span><span class=w>
</span><span class=w>    </span><span class=nt>zones</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>eu-west-1a</span><span class=w>
</span><span class=w>  </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiserver</span><span class=p>:</span><span class=w> </span><span class=l>api.aws-01.core.example.com</span><span class=w>
</span><span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-aws-credentials</span><span class=w>
</span><span class=w>  </span><span class=nt>sshPublicKey</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    </span><span class=w>    </span><span class=l>base64(key)</span><span class=w>
</span></code></pre></div><p>Please note that the <code>.spec.providerConfig</code> is a raw blob and not evaluated or known in any way by Gardener.
Instead, it was specified by the user (in the <code>Shoot</code> resource) and just &ldquo;forwarded&rdquo; to the extension controller.
Only the AWS controller understands this configuration and will now start provisioning/reconciling the infrastructure.
It reports in the <code>.status</code> field the result:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>observedGeneration</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>lastError</span><span class=p>:</span><span class=w> </span><span class=l>..</span><span class=w>
</span><span class=w>  </span><span class=nt>lastOperation</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>providerStatus</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>aws.provider.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InfrastructureStatus</span><span class=w>
</span><span class=w>    </span><span class=nt>vpc</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>vpc-1234</span><span class=w>
</span><span class=w>      </span><span class=nt>subnets</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>subnet-acbd1234</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>workers</span><span class=w>
</span><span class=w>        </span><span class=nt>zone</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>      </span><span class=nt>securityGroups</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>sg-xyz12345</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>workers</span><span class=w>
</span><span class=w>    </span><span class=nt>iam</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>nodesRoleARN</span><span class=p>:</span><span class=w> </span><span class=l>&lt;some-arn&gt;</span><span class=w>
</span><span class=w>      </span><span class=nt>instanceProfileName</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span><span class=w>    </span><span class=nt>ec2</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>keyName</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span></code></pre></div><p>Gardener waits until the <code>.status.lastOperation</code>/<code>.status.lastError</code> indicates that the operation reached a final state and either continuous with the next step or stops and reports the potential error.
The extension-specific output in <code>.status.providerStatus</code> is - similar to <code>.spec.providerConfig</code> - not evaluated and simply forwarded to CRDs in subsequent steps.</p><p><strong>Example 2</strong>:</p><p>Gardener deploys the control plane components into the seed cluster, e.g. the <code>kube-controller-manager</code> deployment with the following flags:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>command</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=l>/usr/local/bin/kube-controller-manager</span><span class=w>
</span><span class=w>        </span>- --<span class=l>allocate-node-cidrs=true</span><span class=w>
</span><span class=w>        </span>- --<span class=l>attach-detach-reconcile-sync-period=1m0s</span><span class=w>
</span><span class=w>        </span>- --<span class=l>controllers=*,bootstrapsigner,tokencleaner</span><span class=w>
</span><span class=w>        </span>- --<span class=l>cluster-cidr=100.96.0.0/11</span><span class=w>
</span><span class=w>        </span>- --<span class=l>cluster-name=shoot--core--aws-01</span><span class=w>
</span><span class=w>        </span>- --<span class=l>cluster-signing-cert-file=/srv/kubernetes/ca/ca.crt</span><span class=w>
</span><span class=w>        </span>- --<span class=l>cluster-signing-key-file=/srv/kubernetes/ca/ca.key</span><span class=w>
</span><span class=w>        </span>- --<span class=l>concurrent-deployment-syncs=10</span><span class=w>
</span><span class=w>        </span>- --<span class=l>concurrent-replicaset-syncs=10</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>The AWS controller requires some additional flags in order to make the cluster functional.
It needs to provide a Kubernetes cloud-config and also some cloud-specific flags.
Consequently, it registers a <code>MutatingWebhookConfiguration</code> on <code>Deployment</code>s and adds these flags to the container:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>        </span>- --<span class=l>cloud-provider=external</span><span class=w>
</span><span class=w>        </span>- --<span class=l>external-cloud-volume-plugin=aws</span><span class=w>
</span><span class=w>        </span>- --<span class=l>cloud-config=/etc/kubernetes/cloudprovider/cloudprovider.conf</span><span class=w>
</span></code></pre></div><p>Of course, it would have needed to create a <code>ConfigMap</code> containing the cloud config and to add the proper <code>volume</code> and <code>volumeMounts</code> to the manifest as well.</p><p>(Please note for this special example: The Kubernetes community is also working on making the <code>kube-controller-manager</code> provider-independent.
However, there will most probably be still components other than the <code>kube-controller-manager</code> which need to be adapted by extensions.)</p><p>If you are interested in writing an extension, or generally in digging deeper to find out the nitty-gritty details of the extension concepts please read <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a>.
We are truly looking forward to your feedback!</p><h2 id=current-status>Current status</h2><p>Meanwhile, the out-of-tree extension architecture of Gardener is in place and has been productively validated. We are tracking all internal and external extensions of Gardener in the repo: <a href=https://github.com/gardener/gardener/tree/master/extensions#known-extension-implementations>Gardener Extensions Library</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0718d66e173c2690bd100ac9006df6e7>1.4.11 - Extension resource</h1><h1 id=contract-extension-resource>Contract: <code>Extension</code> resource</h1><p>Gardener defines common procedures which must be passed to create a functioning shoot cluster. Well known steps are represented by special resources like <code>Infrastructure</code>, <code>OperatingSystemConfig</code> or <code>DNS</code>. These resources are typically reconciled by dedicated controllers setting up the infrastructure on the hyperscaler or managing DNS entries, etc..</p><p>But, some requirements don&rsquo;t match with those special resources or don&rsquo;t depend on being proceeded at a specific step in the creation / deletion flow of the shoot. They require a more generic hook. Therefore, Gardener offers the <code>Extension</code> resource.</p><h2 id=what-is-required-to-register-and-support-an-extension-type>What is required to register and support an Extension type?</h2><p>Gardener creates one <code>Extension</code> resource per registered extension type in <code>ControllerRegistration</code> per shoot.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ControllerRegistration</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>extension-example</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Extension</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span><span class=w>    </span><span class=nt>globallyEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></code></pre></div><p>If <code>spec.resources[].globallyEnabled</code> is <code>true</code> then the <code>Extension</code> resources of the given <code>type</code> is created for every shoot cluster. Set to <code>false</code>, the <code>Extension</code> resource is only created if configured in the <code>Shoot</code> manifest.</p><p>The <code>Extension</code> resources are created in the shoot namespace of the seed cluster.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Extension</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span><span class=w>  </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></code></pre></div><p>Your controller needs to reconcile <code>extensions.extensions.gardener.cloud</code>. Since there can exist multiple <code>Extension</code> resources per shoot, each one holds a <code>spec.type</code> field to let controllers check their responsibility (similar to all other extension resources of Gardener).</p><h2 id=providerconfig>ProviderConfig</h2><p>It is possible to provide data in the <code>Shoot</code> resource which is copied to <code>spec.providerConfig</code> of the <code>Extension</code> resource.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden-foo</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span><span class=w>    </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>foo</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>results in</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Extension</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span><span class=w>  </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>foo</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span></code></pre></div><h2 id=shoot-reconciliation-flow-and-extension-status>Shoot reconciliation flow and Extension status</h2><p>Gardener creates Extension resources as part of the Shoot reconciliation. Moreover, it is guaranteed that the <a href=/docs/concepts/extensions/cluster>Cluster</a> resource exists before the <code>Extension</code> resource is created.</p><p>For an <code>Extension</code> controller it is crucial to maintain the <code>Extension</code>&rsquo;s status correctly. At the end Gardener checks the status of each <code>Extension</code> and only reports a successful shoot reconciliation if the state of the last operation is <code>Succeeded</code>.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Extension</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>generation</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>lastOperation</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>Succeeded</span><span class=w>
</span><span class=w>  </span><span class=nt>observedGeneration</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-adba9a0aaeaafd6b4608f6364741c384>1.4.12 - Gardener Container Runtime Extension</h1><h1 id=gardener-container-runtime-extension>Gardener Container Runtime Extension</h1><p>At the lowest layers of a Kubernetes node is the software that, among other things, starts and stops containers. It is called “Container Runtime”.
The most widely known container runtime is Docker, but it is not alone in this space. In fact, the container runtime space has been rapidly evolving.</p><p>Kubernetes supports different container runtimes using Container Runtime Interface (CRI) – a plugin interface which enables kubelet to use a wide variety of container runtimes.</p><p>Gardener supports creation of Worker machines using CRI, more information can be found here: <a href=https://github.com/gardener/gardener/blob/master/docs/extensions/operatingsystemconfig.md#cri-support>CRI Support</a>.</p><h2 id=motivation>Motivation</h2><p>Prior to the <code>Container Runtime Extensibility</code> concept, Gardener used Docker as the only
container runtime to use in shoot worker machines. Because of the wide variety of different container runtimes
offers multiple important features (for example enhanced security concepts) it is important to enable end users to use other container runtimes as well.</p><h2 id=the-containerruntime-extension-resource>The <code>ContainerRuntime</code> Extension Resource</h2><p>Here is what a typical <code>ContainerRuntime</code> resource would look-like:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ContainerRuntime</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-container-runtime</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>binaryPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/bin/containerruntimes</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>gvisor</span><span class=w>
</span><span class=w>  </span><span class=nt>workerPool</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>worker-ubuntu</span><span class=w>
</span><span class=w>    </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>worker.gardener.cloud/pool</span><span class=p>:</span><span class=w> </span><span class=l>worker-ubuntu</span><span class=w>
</span></code></pre></div><p>Gardener deploys one <code>ContainerRuntime</code> resource per worker pool per CRI.
To exemplify this, consider a Shoot having two worker pools (<code>worker-one</code>, <code>worker-two</code>) using <code>containerd</code> as the CRI as well as <code>gvisor</code> and <code>kata</code> as enabled container runtimes.
Gardener would deploy four <code>ContainerRuntime</code> resources. For <code>worker-one</code>: one <code>ContainerRuntime</code> for type <code>gvisor</code> and one for type <code>kata</code>. The same resource are being deployed for <code>worker-two</code>.</p><h2 id=supporting-a-new-container-runtime-provider>Supporting a new Container Runtime Provider</h2><p>To add support for another container runtime (e.g., gvisor, kata-containers, etc.) a container runtime extension controller needs to be implemented. It should support Gardener&rsquo;s supported CRI plugins.</p><p>The container runtime extension should install the necessary resources into the shoot cluster (e.g., <code>RuntimeClass</code>es), and it should copy the runtime binaries to the relevant worker machines in path: <code>spec.binaryPath</code>.
Gardener labels the shoot nodes according to the CRI configured: <code>worker.gardener.cloud/cri-name=&lt;value></code> (e.g <code>worker.gardener.cloud/cri-name=containerd</code>) and multiple labels for each of the container runtimes configured for the shoot Worker machine:
<code>containerruntime.worker.gardener.cloud/&lt;container-runtime-type-value>=true</code> (e.g <code>containerruntime.worker.gardener.cloud/gvisor=true</code>).
The way to install the binaries is by creating a daemon set which copies the binaries from an image in a docker registry to the relevant labeled Worker&rsquo;s nodes (avoid downloading binaries from internet to also cater with isolated environments).</p><p>For additional reference, please have a look at the <a href=https://github.com/gardener/gardener-extension-runtime-gvisor>runtime-gvsior</a> provider extension, which provides more information on how to configure the necessary charts as well as the actuators required to reconcile container runtime inside the <code>Shoot</code> cluster to the desired state.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3dd7f690dae056600b2c89a14fd0abf2>1.4.13 - Gardener Network Extension</h1><h1 id=gardener-network-extension>Gardener Network Extension</h1><p>Gardener is an open-source project that provides a nested user model. Basically, there are two types of services provided by Gardener to its users:</p><ul><li>Managed: end-users only request a Kubernetes cluster (Clusters-as-a-Service)</li><li>Hosted: operators utilize Gardener to provide their own managed version of Kubernetes (Cluster-Provisioner-as-a-service)</li></ul><p>Whether an operator or an end-user, it makes sense to provide choice. For example, for an end-user it might make sense to
choose a network-plugin that would support enforcing network policies (some plugins does not come with network-policy support by default).
For operators however, choice only matters for delegation purposes i.e., when providing an own managed-service, it becomes important to also provide choice over which network-plugins to use.</p><p>Furthermore, Gardener provisions clusters on different cloud-providers with different networking requirements. For example, Azure does not support Calico Networking [1], this leads to the introduction of manual exceptions in static add-on charts which is error prone and can lead to failures during upgrades.</p><p>Finally, every provider is different, and thus the network always needs to adapt to the infrastructure needs to provide better performance. Consistency does not necessarily lie in the implementation but in the interface.</p><h2 id=motivation>Motivation</h2><p>Prior to the <code>Network Extensibility</code> concept, Gardener followed a mono network-plugin support model (i.e., Calico). Although this seemed to be the easier approach, it did not completely reflect the real use-case.
The goal of the Gardener Network Extensions is to support different network plugins, therefore, the specification for the network resource won&rsquo;t be fixed and will be customized based on the underlying network plugin.</p><p>To do so, a <code>ProviderConfig</code> field in the spec will be provided where each plugin will define. Below is an example for how to deploy Calico as the cluster network plugin.</p><h2 id=the-network-extensions-resource>The Network Extensions Resource</h2><p>Here is what a typical <code>Network</code> resource would look-like:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Network</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-network</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>podCIDR</span><span class=p>:</span><span class=w> </span><span class=m>100.244.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>  </span><span class=nt>serviceCIDR</span><span class=p>:</span><span class=w> </span><span class=m>100.32.0.0</span><span class=l>/13</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>calico</span><span class=w>
</span><span class=w>  </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>calico.networking.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>NetworkConfig</span><span class=w>
</span><span class=w>    </span><span class=nt>backend</span><span class=p>:</span><span class=w> </span><span class=l>bird</span><span class=w>
</span><span class=w>    </span><span class=nt>ipam</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=l>usePodCIDR</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>host-local</span><span class=w>
</span></code></pre></div><p>The above resources is divided into two parts (more information can be found <a href=https://github.com/gardener/gardener-extension-networking-calico/blob/master/docs/usage-as-end-user.md>here</a>):</p><ul><li>global configuration (e.g., podCIDR, serviceCIDR, and type)</li><li>provider specific config (e.g., for calico we can choose to configure a <code>bird</code> backend)</li></ul><blockquote><p><strong>Note</strong>: certain cloud-provider extensions might have webhooks that would modify the network-resource to fit into their network specific context. As previously mentioned, Azure does not support IPIP, as a result, the <a href=https://github.com/gardener/gardener-extension-provider-azure>Azure provider extension</a> implements a <a href=https://github.com/gardener/gardener-extension-provider-azure/blob/master/pkg/webhook/network/mutate.go>webhook</a> to mutate the backend and set it to <code>None</code> instead of <code>bird</code>.</p></blockquote><h2 id=supporting-a-new-network-extension-provider>Supporting a new Network Extension Provider</h2><p>To add support for another networking provider (e.g., weave, Cilium, Flannel, etc.) a network extension controller needs to be implemented which would optionally have its own custom configuration specified in the <code>spec.providerConfig</code> in the <code>Network</code> resource. For example, if support for a network plugin named <code>gardenet</code> is required, the following <code>Network</code> resource would be created:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Network</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-network</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>podCIDR</span><span class=p>:</span><span class=w> </span><span class=m>100.244.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>  </span><span class=nt>serviceCIDR</span><span class=p>:</span><span class=w> </span><span class=m>100.32.0.0</span><span class=l>/13</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>gardenet</span><span class=w>
</span><span class=w>  </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>gardenet.networking.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>NetworkConfig</span><span class=w>
</span><span class=w>    </span><span class=nt>gardenetCustomConfigField</span><span class=p>:</span><span class=w> </span><span class=l>&lt;value&gt;</span><span class=w>
</span><span class=w>    </span><span class=nt>ipam</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=l>usePodCIDR</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>host-local</span><span class=w>
</span></code></pre></div><p>Once applied, the presumably implemented <code>Gardenet</code> extension controller, would pick the configuration up, parse the <code>providerConfig</code> and create the necessary resources in the shoot.</p><p>For additional reference, please have a look at the <a href=https://github.com/gardener/gardener-extension-networking-calico>networking-calico</a> provider extension, which provides more information on how to configure the necessary charts as well as the actuators required to reconcile networking inside the <code>Shoot</code> cluster to the desired state.</p><h2 id=supporting-kube-proxy-less-service-routing>Supporting <code>kube-proxy</code> less Service Routing</h2><p>Some networking extensions support service routing without the <code>kube-proxy</code> component. This is why Gardener supports disabling of <code>kube-proxy</code> for service routing by setting <code>.spec.kubernetes.kubeproxy.enabled</code> to <code>false</code> in the <code>Shoot</code> specification. The implicit contract of the flag is: If <code>kube-proxy</code> is disabled then the networking extension is responsible for the service routing.
The networking extensions need to handle this twofold:</p><ol><li>During the reconciliation of the networking resources, the extension needs to check whether <code>kube-proxy</code> takes care of the service routing or the networking extension itself should handle it. In case the networking extension should be responsible according to <code>.spec.kubernetes.kubeproxy.enabled</code> (but is unable to perform the service routing) it should raise an error during the reconciliation. If the networking extension should handle the service routing it may reconfigure itself accordingly.</li><li>(optional) In case the networking extension does not support taking over the service routing (in some scenarios), it is recommended to also provide a validating admission webhook to reject corresponding changes early on. The validation may take the current operating mode of the networking extension into consideration.</li></ol><h2 id=references>References</h2><p>[1] <a href=https://docs.projectcalico.org/v3.0/reference/public-cloud/azure>Azure support for Calico Networking</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-0e7822bf96a49bcf7b82e63f195202f2>1.4.14 - General conventions</h1><h1 id=general-conventions>General conventions</h1><p>All the extensions that are registered to Gardener are deployed to the seed clusters (at the moment, every extension is installed to every seed cluster, however, in the future Gardener will be more smart to determine which extensions needs to be placed into which seed).</p><p>Some of these extensions might need to create global resources in the seed (e.g., <code>ClusterRole</code>s), i.e., it&rsquo;s important to have a naming scheme to avoid conflicts as it cannot be checked or validated upfront that two extensions don&rsquo;t use the same names.</p><p>Consequently, this page should help answering some general questions that might come up when it comes to developing an extension.</p><h2 id=is-there-a-naming-scheme-for-global-resources>Is there a naming scheme for (global) resources?</h2><p>As there is no formal process to validate non-existence of conflicts between two extensions please follow these naming schemes when creating resources (especially, when creating global resources, but it&rsquo;s in general a good idea for most created resources):</p><p><em>The resource name should be prefixed with <code>extensions.gardener.cloud:&lt;extension-type>-&lt;extension-name>:&lt;resource-name></code></em>, for example:</p><ul><li><code>extensions.gardener.cloud:provider-aws:machine-controller-manager</code></li><li><code>extensions.gardener.cloud:extension-certificate-service:cert-broker</code></li></ul><h2 id=how-to-create-resources-in-the-shoot-cluster>How to create resources in the shoot cluster?</h2><p>Some extensions might not only create resources in the seed cluster itself but also in the shoot cluster. Usually, every extension comes with a <code>ServiceAccount</code> and the required RBAC permissions when it gets installed to the seed.
However, there are no credentials for the shoot for every extension.</p><p>Gardener creates a kubeconfig for itself that it uses to interact with the shoot cluster.
This kubeconfig is stored as a <code>Secret</code> with name <a href=https://github.com/gardener/gardener/blob/master/pkg/apis/core/v1beta1/constants/types_constants.go><code>gardener</code></a> in the shoot namespace.
Extension controllers may use this kubeconfig to interact with the shoot cluster if desired (it has full administrator privileges and no further RBAC rules are required).
Instead, they could also create their own kubeconfig for every shoot (which, of course, is better for auditing reasons, but not yet enforced at this point in time).</p><p>If you need to deploy a non-DaemonSet resource you need to ensure that it only runs on nodes that are allowed to host system components and extensions.
To do that you need to configure a <code>nodeSelector</code> as following:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>
</span><span class=w> </span><span class=nt>worker.gardener.cloud/system-components</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></code></pre></div><h2 id=how-to-create-certificateskubeconfigs-for-the-shoot-cluster>How to create certificates/kubeconfigs for the shoot cluster?</h2><p>Gardener creates several certificate authorities (CA) that are used to create server/client certificates for various components.
For example, the shoot&rsquo;s etcd has its own CA, the kube-aggregator has its own CA as well, and both are different to the actual cluster&rsquo;s CA.</p><p>These CAs are stored as <code>Secret</code>s in the shoot namespace (see <a href=https://github.com/gardener/gardener/blob/master/pkg/apis/core/v1beta1/constants/types_constants.go>this</a> for the actual names).
Extension controllers may use them to create further certificates/kubeconfigs for potential other components they need to deploy to the seed or shoot.
<a href=https://github.com/gardener/gardener/tree/master/pkg/utils/secrets>These utility functions</a> should help with the creation and management.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d74409fa8fad020486051ca12942750e>1.4.15 - Health Check Library</h1><h1 id=health-check-library>Health Check Library</h1><h2 id=goal>Goal</h2><p>Typically an extension reconciles a specific resource (Custom Resource Definitions (CRDs)) and creates/modifies resources in the cluster (via helm, managed resources, kubectl, &mldr;).
We call these API Objects &lsquo;dependent objects&rsquo; - as they are bound to the lifecycle of the extension.</p><p>The goal of this library is to enable extensions to setup health checks for their &lsquo;dependent objects&rsquo; with minimal effort.</p><h2 id=usage>Usage</h2><p>The library provides a generic controller with the ability to register any resource that satisfies the <a href=https://github.com/gardener/gardener/blob/master/pkg/apis/extensions/v1alpha1/types.go>extension object interface</a>.
An example is <a href=https://github.com/gardener/gardener/blob/master/pkg/apis/extensions/v1alpha1/types_worker.go>the <code>Worker</code> CRD</a>.</p><p>Health check functions for commonly used dependent objects can be reused and registered with the controller, such as:</p><ul><li>Deployment</li><li>DaemonSet</li><li>StatefulSet</li><li>ManagedResource (Gardener specific)</li></ul><p>See below example <a href=https://github.com/gardener/gardener-extension-provider-aws/blob/master/pkg/controller/healthcheck/add.go>taken from the provider-aws</a>.</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=nx>health</span><span class=p>.</span><span class=nf>DefaultRegisterExtensionForHealthCheck</span><span class=p>(</span>
               <span class=nx>aws</span><span class=p>.</span><span class=nx>Type</span><span class=p>,</span>
               <span class=nx>extensionsv1alpha1</span><span class=p>.</span><span class=nx>SchemeGroupVersion</span><span class=p>.</span><span class=nf>WithKind</span><span class=p>(</span><span class=nx>extensionsv1alpha1</span><span class=p>.</span><span class=nx>WorkerResource</span><span class=p>),</span>
               <span class=kd>func</span><span class=p>()</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span> <span class=p>{</span> <span class=k>return</span> <span class=o>&amp;</span><span class=nx>extensionsv1alpha1</span><span class=p>.</span><span class=nx>Worker</span><span class=p>{}</span> <span class=p>},</span>
               <span class=nx>mgr</span><span class=p>,</span> <span class=c1>// controller runtime manager
</span><span class=c1></span>               <span class=nx>opts</span><span class=p>,</span> <span class=c1>// options for the health check controller
</span><span class=c1></span>               <span class=kc>nil</span><span class=p>,</span> <span class=c1>// custom predicates
</span><span class=c1></span>               <span class=kd>map</span><span class=p>[</span><span class=nx>extensionshealthcheckcontroller</span><span class=p>.</span><span class=nx>HealthCheck</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
                       <span class=nx>general</span><span class=p>.</span><span class=nf>CheckManagedResource</span><span class=p>(</span><span class=nx>genericactuator</span><span class=p>.</span><span class=nx>McmShootResourceName</span><span class=p>):</span> <span class=nb>string</span><span class=p>(</span><span class=nx>gardencorev1beta1</span><span class=p>.</span><span class=nx>ShootSystemComponentsHealthy</span><span class=p>),</span>
                       <span class=nx>general</span><span class=p>.</span><span class=nf>CheckSeedDeployment</span><span class=p>(</span><span class=nx>aws</span><span class=p>.</span><span class=nx>MachineControllerManagerName</span><span class=p>):</span>      <span class=nb>string</span><span class=p>(</span><span class=nx>gardencorev1beta1</span><span class=p>.</span><span class=nx>ShootEveryNodeReady</span><span class=p>),</span>
                       <span class=nx>worker</span><span class=p>.</span><span class=nf>SufficientNodesAvailable</span><span class=p>():</span>                                  <span class=nb>string</span><span class=p>(</span><span class=nx>gardencorev1beta1</span><span class=p>.</span><span class=nx>ShootEveryNodeReady</span><span class=p>),</span>
               <span class=p>})</span>
</code></pre></div><p>This creates a health check controller that reconciles the <code>extensions.gardener.cloud/v1alpha1.Worker</code> resource with the spec.type &lsquo;aws&rsquo;.
Three health check functions are registered that are executed during reconciliation.
Each health check is mapped to a single <code>HealthConditionType</code> that results in conditions with the same <code>condition.type</code> (see below).
To contribute to the Shoot&rsquo;s health, the following can be used: <code>SystemComponentsHealthy</code>, <code>EveryNodeReady</code>, <code>ControlPlaneHealthy</code>.
The Gardener/Gardenlet checks each extension for conditions matching these types.
However extensions are free to choose any <code>HealthConditionType</code>.
More information <a href=/docs/concepts/extensions/shoot-health-status-conditions>can be found here</a>.</p><p>A health check has to <a href=https://github.com/gardener/gardener/blob/master/extensions/pkg/controller/healthcheck/actuator.go>satisfy below interface</a>.
You can find implementation examples <a href=https://github.com/gardener/gardener/tree/master/extensions/pkg/controller/healthcheck/general>here</a>.</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>HealthCheck</span> <span class=kd>interface</span> <span class=p>{</span>
    <span class=c1>// Check is the function that executes the actual health check
</span><span class=c1></span>    <span class=nf>Check</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>SingleCheckResult</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
    <span class=c1>// InjectSeedClient injects the seed client
</span><span class=c1></span>    <span class=nf>InjectSeedClient</span><span class=p>(</span><span class=nx>client</span><span class=p>.</span><span class=nx>Client</span><span class=p>)</span>
    <span class=c1>// InjectShootClient injects the shoot client
</span><span class=c1></span>    <span class=nf>InjectShootClient</span><span class=p>(</span><span class=nx>client</span><span class=p>.</span><span class=nx>Client</span><span class=p>)</span>
    <span class=c1>// SetLoggerSuffix injects the logger
</span><span class=c1></span>    <span class=nf>SetLoggerSuffix</span><span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>string</span><span class=p>)</span>
    <span class=c1>// DeepCopy clones the healthCheck
</span><span class=c1></span>    <span class=nf>DeepCopy</span><span class=p>()</span> <span class=nx>HealthCheck</span>
<span class=p>}</span>
</code></pre></div><p>The health check controller regularly (default: <code>30s</code>) reconciles the extension resource and executes the registered health checks for the dependent objects.
As a result, the controller writes condition(s) to the status of the extension containing the health check result.
In our example, two checks are mapped to <code>ShootEveryNodeReady</code> and one to <code>ShootSystemComponentsHealthy</code>, leading to conditions with two distinct <code>HealthConditionTypes</code> (condition.type)</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;20XX-10-28T08:17:21Z&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>lastUpdateTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;20XX-11-28T08:17:21Z&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>(1/1) Health checks successful</span><span class=w>
</span><span class=w>      </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>HealthCheckSuccessful</span><span class=w>
</span><span class=w>      </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>SystemComponentsHealthy</span><span class=w>
</span><span class=w>    </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;20XX-10-28T08:17:21Z&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>lastUpdateTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;20XX-11-28T08:17:21Z&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>(2/2) Health checks successful</span><span class=w>
</span><span class=w>      </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>HealthCheckSuccessful</span><span class=w>
</span><span class=w>      </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>EveryNodeReady</span><span class=w>
</span></code></pre></div><p>Please note that there are four statuses: <code>True</code>, <code>False</code>, <code>Unknown</code>, and <code>Progressing</code>.</p><ul><li><code>True</code> should be used for successful health checks.</li><li><code>False</code> should be used for unsuccessful/failing health checks.</li><li><code>Unknown</code> should be used when there was an error trying to determine the health status.</li><li><code>Progressing</code> should be used to indicate that the health status did not succeed but for expected reasons (e.g., a cluster scale up/down could make the standard health check fail because something is wrong with the <code>Machines</code>, however, it&rsquo;s actually an expected situation and known to be completed within a few minutes.)</li></ul><p>Health checks that report <code>Progressing</code> should also provide a timeout after which this &ldquo;progressing situation&rdquo; is expected to be completed.
The health check library will automatically transition the status to <code>False</code> if the timeout was exceeded.</p><h2 id=additional-considerations>Additional Considerations</h2><p>It is up to the extension to decide how to conduct health checks, though it is recommended to make use of the build-in health check functionality of <code>managed-resources</code> for trivial checks.
By <a href=https://github.com/gardener/gardener/blob/master/extensions/pkg/controller/worker/genericactuator/machine_controller_manager.go>deploying the depending resources via managed resources</a>, the <a href=https://github.com/gardener/gardener-resource-manager>gardener resource manager</a> conducts basic checks for different API objects out-of-the-box (e.g <code>Deployments</code>, <code>DaemonSets</code>, &mldr;) - and writes health conditions.
In turn, the library contains a health check function to gather the health information from managed resources.</p><p>More sophisticated health checks should be implemented by the extension controller itself (implementing the <code>HealthCheck</code> interface).</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6623d650cf530ca75b7397904bd9663a>1.4.16 - Infrastructure resource</h1><h1 id=contract-infrastructure-resource>Contract: <code>Infrastructure</code> resource</h1><p>Every Kubernetes cluster requires some low-level infrastructure to be setup in order to work properly.
Examples for that are networks, routing entries, security groups, IAM roles, etc.
Before introducing the <code>Infrastructure</code> extension resource Gardener was using Terraform in order to create and manage these provider-specific resources (e.g., see <a href=https://github.com/gardener/gardener/tree/0.20.0/charts/seed-terraformer/charts/aws-infra>here</a>).
Now, Gardener commissions an external, provider-specific controller to take over this task.</p><h2 id=which-infrastructure-resources-are-required>Which infrastructure resources are required?</h2><p>Unfortunately, there is no general answer to this question as it is highly provider specific.
Consider the above mentioned resources, i.e. VPC, subnets, route tables, security groups, IAM roles, SSH key pairs.
Most of the resources are required in order to create VMs (the shoot cluster worker nodes), load balancers, and volumes.</p><h2 id=what-needs-to-be-implemented-to-support-a-new-infrastructure-provider>What needs to be implemented to support a new infrastructure provider?</h2><p>As part of the shoot flow Gardener will create a special CRD in the seed cluster that needs to be reconciled by an extension controller, for example:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Infrastructure</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>infrastructure</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>azure</span><span class=w>
</span><span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudprovider</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w>  </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>azure.provider.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InfrastructureConfig</span><span class=w>
</span><span class=w>    </span><span class=nt>resourceGroup</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mygroup</span><span class=w>
</span><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>vnet</span><span class=p>:</span><span class=w> </span><span class=c># specify either &#39;name&#39; or &#39;cidr&#39;</span><span class=w>
</span><span class=w>      </span><span class=c># name: my-vnet</span><span class=w>
</span><span class=w>        </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>10.250.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>      </span><span class=nt>workers</span><span class=p>:</span><span class=w> </span><span class=m>10.250.0.0</span><span class=l>/19</span><span class=w>
</span></code></pre></div><p>The <code>.spec.secretRef</code> contains a reference to the provider secret pointing to the account that shall be used to create the needed resources.
However, the most important section is the <code>.spec.providerConfig</code>.
It contains an embedded declaration of the provider specific configuration for the infrastructure (that cannot be known by Gardener itself).
You are responsible for designing how this configuration looks like.
Gardener does not evaluate it but just copies this part from what has been provided by the end-user in the <code>Shoot</code> resource.</p><p>After your controller has created the required resources in your provider&rsquo;s infrastructure it needs to generate an output that can be used by other controllers in subsequent steps.
An example for that is the <code>Worker</code> extension resource controller.
It is responsible for creating virtual machines (shoot worker nodes) in this prepared infrastructure.
Everything that it needs to know in order to do that (e.g., the network IDs, security group names, etc. (again: provider-specific)) needs to be provided as output in the <code>Infrastructure</code> resource:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Infrastructure</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>infrastructure</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=l>...</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>lastOperation</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>providerStatus</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>azure.provider.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InfrastructureStatus</span><span class=w>
</span><span class=w>    </span><span class=nt>resourceGroup</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mygroup</span><span class=w>
</span><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>vnet</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-vnet</span><span class=w>
</span><span class=w>      </span><span class=nt>subnets</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>nodes</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-subnet</span><span class=w>
</span><span class=w>    </span><span class=nt>availabilitySets</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>nodes</span><span class=w>
</span><span class=w>      </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>av-set-id</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>av-set-name</span><span class=w>
</span><span class=w>    </span><span class=nt>routeTables</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>nodes</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>route-table-name</span><span class=w>
</span><span class=w>    </span><span class=nt>securityGroups</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>nodes</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sec-group-name</span><span class=w>
</span></code></pre></div><p>In order to support a new infrastructure provider you need to write a controller that watches all <code>Infrastructure</code>s with <code>.spec.type=&lt;my-provider-name></code>.
You can take a look at the below referenced example implementation for the Azure provider.</p><h2 id=dynamic-nodes-network-for-shoot-clusters>Dynamic nodes network for shoot clusters</h2><p>Some environments do not allow end-users to statically define a CIDR for the network that shall be used for the shoot worker nodes.
In these cases it is possible for the extension controllers to dynamically provision a network for the nodes (as part of their reconciliation loops), and to provide the CIDR in the <code>status</code> of the <code>Infrastructure</code> resource:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Infrastructure</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>infrastructure</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=l>...</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>lastOperation</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>providerStatus</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>nodesCIDR</span><span class=p>:</span><span class=w> </span><span class=m>10.250.0.0</span><span class=l>/16</span><span class=w>
</span></code></pre></div><p>Gardener will pick this <code>nodesCIDR</code> and use it to configure the VPN components to establish network connectivity between the control plane and the worker nodes.
If the <code>Shoot</code> resource already specifies a nodes CIDR in <code>.spec.networking.nodes</code> and the extension controller provides also a value in <code>.status.nodesCIDR</code> in the <code>Infrastructure</code> resource then the latter one will always be considered with higher priority by Gardener.</p><h2 id=non-provider-specific-information-required-for-infrastructure-creation>Non-provider specific information required for infrastructure creation</h2><p>Some providers might require further information that is not provider specific but already part of the shoot resource.
One example for this is the <a href=https://github.com/gardener/gardener-extension-provider-gcp/tree/master/pkg/controller/infrastructure>GCP infrastructure controller</a> which needs the pod and the service network of the cluster in order to prepare and configure the infrastructure correctly.
As Gardener cannot know which information is required by providers it simply mirrors the <code>Shoot</code>, <code>Seed</code>, and <code>CloudProfile</code> resources into the seed.
They are part of the <a href=/docs/concepts/extensions/cluster><code>Cluster</code> extension resource</a> and can be used to extract information that is not part of the <code>Infrastructure</code> resource itself.</p><h2 id=implementation-details>Implementation details</h2><h3 id=actuator-interface><code>Actuator</code> interface</h3><p>Most existing infrastructure controller implementations follow a common pattern where a generic <code>Reconciler</code> delegates to <a href=https://github.com/gardener/gardener/blob/master/extensions/pkg/controller/infrastructure/actuator.go>an <code>Actuator</code> interface</a> that contains the methods <code>Reconcile</code>, <code>Delete</code>, <code>Migrate</code>, and <code>Restore</code>. These methods are called by the generic <code>Reconciler</code> for the respective operations, and should be implemented by the extension according to the contract described here and the <a href=https://github.com/gardener/gardener/blob/master/docs/extensions/migration.md>migration guidelines</a>.</p><h3 id=configvalidator-interface><code>ConfigValidator</code> interface</h3><p>For infrastructure controllers, the generic <code>Reconciler</code> also delegates to <a href=https://github.com/gardener/gardener/blob/master/extensions/pkg/controller/infrastructure/configvalidator.go>a <code>ConfigValidator</code> interface</a> that contains a single <code>Validate</code> method. This method is called by the generic <code>Reconciler</code> at the beginning of every reconciliation, and can be implemented by the extension to validate the <code>.spec.providerConfig</code> part of the <code>Infrastructure</code> resource with the respective cloud provider, typically the existence and validity of cloud provider resources such as AWS VPCs or GCP Cloud NAT IPs.</p><p>The <code>Validate</code> method returns a list of errors. If this list is non-empty, the generic <code>Reconciler</code> will fail with an error. This error will have the error code <code>ERR_CONFIGURATION_PROBLEM</code>, unless there is at least one error in the list that has its <code>ErrorType</code> field set to <code>field.ErrorTypeInternal</code>.</p><h2 id=references-and-additional-resources>References and additional resources</h2><ul><li><a href=https://github.com/gardener/gardener/blob/master/pkg/apis/extensions/v1alpha1/types_infrastructure.go><code>Infrastructure</code> API (Golang specification)</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-azure/tree/master/pkg/controller/infrastructure>Sample implementation for the Azure provider</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-aws/tree/master/pkg/controller/infrastructure/configvalidator.go>Sample ConfigValidator implementation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-78e89152b21f19ac90e208afd6fbd6a3>1.4.17 - Logging and Monitoring for Extensions</h1><h1 id=logging-and-monitoring-for-extensions>Logging and Monitoring for Extensions</h1><p>Gardener provides an integrated logging and monitoring stack for alerting, monitoring and troubleshooting of its managed components by operators or end users. For further information how to make use of it in these roles, refer to the corresponding guides for <a href=https://github.com/gardener/logging/tree/master/docs/usage/README.md>exploring logs</a> and for <a href=https://grafana.com/docs/grafana/latest/getting-started/getting-started/#all-users>monitoring with Grafana</a>.</p><p>The components that constitute the logging and monitoring stack are managed by Gardener. By default, it deploys <a href=https://prometheus.io/>Prometheus</a>, <a href=https://prometheus.io/docs/alerting/latest/alertmanager/>Alertmanager</a> and <a href=https://grafana.com/>Grafana</a> into the <code>garden</code> namespace of all seed clusters. If the <code>Logging</code> <a href=/docs/concepts/deployment/feature_gates>feature gate</a> in the <code>gardenlet</code> configuration is enabled, it will deploy <a href=https://fluentbit.io/>fluent-bit</a> and <a href=https://grafana.com/oss/loki/>Loki</a> in the <code>garden</code> namespace too.</p><p>Each shoot namespace hosts managed logging and monitoring components. As part of the shoot reconciliation flow, Gardener deploys a shoot-specific Prometheus, Grafana and, if configured, an Alertmanager into the shoot namespace, next to the other control plane components. If the <code>Logging</code> feature gate is enabled and the <a href=https://github.com/gardener/gardener/blob/master/docs/usage/shoot_purposes.md#behavioral-differences>shoot purpose</a> is not <code>testing</code>, it deploys a shoot-specific Loki in the shoot namespace too.</p><p>The logging and monitoring stack is extensible by configuration. Gardener extensions can take advantage of that and contribute configurations encoded in <code>ConfigMap</code>s for their own, specific dashboards, alerts, log parsers and other supported assets and integrate with it. As with other Gardener resources, they will be continuously reconciled.</p><p>This guide is about the roles and extensibility options of the logging and monitoring stack components, and how to integrate extensions with:</p><ul><li><a href=#monitoring>Monitoring</a></li><li><a href=#logging>Logging</a></li></ul><h2 id=monitoring>Monitoring</h2><p>The central Prometheus instance in the <code>garden</code> namespace fetches metrics and data from all seed cluster nodes and all seed cluster pods.
It uses the <a href=https://prometheus.io/docs/prometheus/latest/federation/>federation</a> concept to allow the shoot-specific instances to scrape only the metrics for the pods of the control plane they are responsible for.
This mechanism allows to scrape the metrics for the nodes/pods once for the whole cluster, and to have them distributed afterwards.</p><p>The shoot-specific metrics are then made available to operators and users in the shoot Grafana, using the shoot Prometheus as data source.</p><p>Extension controllers might deploy components as part of their reconciliation next to the shoot&rsquo;s control plane.
Examples for this would be a cloud-controller-manager or CSI controller deployments. Extensions that want to have their managed control plane components integrated with monitoring can contribute their per-shoot configuration for scraping Prometheus metrics, Alertmanager alerts or Grafana dashboards.</p><h3 id=extensions-monitoring-integration>Extensions monitoring integration</h3><p>Before deploying the shoot-specific Prometheus instance, Gardener will read all <code>ConfigMap</code>s in the shoot namespace, which are labeled with <code>extensions.gardener.cloud/configuration=monitoring</code>.
Such <code>ConfigMap</code>s may contain four fields in their <code>data</code>:</p><ul><li><code>scrape_config</code>: This field contains Prometheus scrape configuration for the component(s) and metrics that shall be scraped.</li><li><code>alerting_rules</code>: This field contains Alertmanager rules for alerts that shall be raised.</li><li>(deprecated)<code>dashboard_operators</code>: This field contains a Grafana dashboard in JSON that is only relevant for Gardener operators.</li><li>(deprecated)<code>dashboard_users</code>: This field contains a Grafana dashboard in JSON that is only relevant for Gardener users (shoot owners).</li></ul><p><strong>Example:</strong> A <code>ControlPlane</code> controller deploying a <code>cloud-controller-manager</code> into the shoot namespace wants to integrate monitoring configuration for scraping metrics, alerting rules, dashboards and logging configuration for exposing logs to the end users.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>extension-controlplane-monitoring-ccm</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--project--name</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>extensions.gardener.cloud/configuration</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>scrape_config</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    - job_name: cloud-controller-manager
</span><span class=sd>      scheme: https
</span><span class=sd>      tls_config:
</span><span class=sd>        insecure_skip_verify: true
</span><span class=sd>        cert_file: /etc/prometheus/seed/prometheus.crt
</span><span class=sd>        key_file: /etc/prometheus/seed/prometheus.key
</span><span class=sd>      honor_labels: false
</span><span class=sd>      kubernetes_sd_configs:
</span><span class=sd>      - role: endpoints
</span><span class=sd>        namespaces:
</span><span class=sd>          names: [shoot--project--name]
</span><span class=sd>      relabel_configs:
</span><span class=sd>      - source_labels:
</span><span class=sd>        - __meta_kubernetes_service_name
</span><span class=sd>        - __meta_kubernetes_endpoint_port_name
</span><span class=sd>        action: keep
</span><span class=sd>        regex: cloud-controller-manager;metrics
</span><span class=sd>      # common metrics
</span><span class=sd>      - action: labelmap
</span><span class=sd>        regex: __meta_kubernetes_service_label_(.+)
</span><span class=sd>      - source_labels: [ __meta_kubernetes_pod_name ]
</span><span class=sd>        target_label: pod
</span><span class=sd>      metric_relabel_configs:
</span><span class=sd>      - process_max_fds
</span><span class=sd>      - process_open_fds</span><span class=w>    
</span><span class=w>
</span><span class=w>  </span><span class=nt>alerting_rules</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    cloud-controller-manager.rules.yaml: |
</span><span class=sd>      groups:
</span><span class=sd>      - name: cloud-controller-manager.rules
</span><span class=sd>        rules:
</span><span class=sd>        - alert: CloudControllerManagerDown
</span><span class=sd>          expr: absent(up{job=&#34;cloud-controller-manager&#34;} == 1)
</span><span class=sd>          for: 15m
</span><span class=sd>          labels:
</span><span class=sd>            service: cloud-controller-manager
</span><span class=sd>            severity: critical
</span><span class=sd>            type: seed
</span><span class=sd>            visibility: all
</span><span class=sd>          annotations:
</span><span class=sd>            description: All infrastructure specific operations cannot be completed (e.g. creating load balancers or persistent volumes).
</span><span class=sd>            summary: Cloud controller manager is down.</span><span class=w>    
</span></code></pre></div><h2 id=logging>Logging</h2><p>In Kubernetes clusters, container logs are non-persistent and do not survive stopped and destroyed containers. Gardener addresses this problem for the components hosted in a seed cluster, by introducing its own managed logging solution. It is integrated with the Gardener monitoring stack to have all troubleshooting context in one place.</p><p><img src=/__resources/logging-architecture_c8dc32.png alt="&ldquo;Cluster Logging Topology&rdquo;" title="Cluster Logging Topology"></p><p>Gardener logging consists of components in three roles - log collectors and forwarders, log persistency and exploration/consumption interfaces. All of them live in the seed clusters in multiple instances:</p><ul><li>Logs are persisted by Loki instances deployed as StatefulSets - one per shoot namespace, if the <code>Logging</code> feature gate is enabled and the <a href=https://github.com/gardener/gardener/blob/master/docs/usage/shoot_purposes.md#behavioral-differences>shoot purpose</a> is not <code>testing</code>, and one in the <code>garden</code> namespace. The shoot instances store logs from the control plane components hosted there. The <code>garden</code> Loki instance is responsible for logs from the rest of the seed namespaces - <code>kube-system</code>, <code>garden</code> <code>extension-*</code> and others.</li><li>Fluent-bit DaemonSets deployed on each seed node collect logs from it. A custom plugin takes care to distribute the collected log messages to the Loki instances that they are intended for. This allows to fetch the logs once for the whole cluster, and to distribute them afterwards.</li><li>Grafana is the UI component used to explore monitoring and log data together for easier troubleshooting and in context. Grafana instances are configured to use the coresponding Loki instances, sharing the same namespace, as data providers. There is one Grafana Deployment in the <code>garden</code> namespace and two Deployments per shoot namespace (one exposed to the end users and one for the operators).</li></ul><p>Logs can be produced from various sources, such as containers or systemd, and in different formats. The fluent-bit design supports configurable <a href=https://docs.fluentbit.io/manual/concepts/data-pipeline>data pipeline</a> to address that problem. Gardener provides such <a href=https://github.com/gardener/gardener/blob/master/charts/seed-bootstrap/charts/fluent-bit/templates/fluent-bit-configmap.yaml>configuration</a> for logs produced by all its core managed components as a <code>ConfigMap</code>. Extensions can contribute their own, specific configurations as <code>ConfigMap</code>s too. See for example the <a href=https://github.com/gardener/gardener-extension-provider-aws/blob/master/charts/gardener-extension-provider-aws/templates/configmap-logging.yaml>logging configuration</a> for the Gardener AWS provider extension. The Gardener reconciliation loop watches such resources and updates the fluent-bit agents dynamically.</p><h4 id=fluent-bit-log-parsers-and-filters>Fluent-bit log parsers and filters</h4><p>To integrate with Gardener logging, extensions can and <em>should</em> specify how fluent-bit will handle the logs produced by the managed components that they contribute to Gardener. Normally, that would require to configure a <em>parser</em> for the specific logging format, if none of the available is applicable, and a <em>filter</em> defining how to apply it. For a complete reference for the configuration options, refer to fluent-bit&rsquo;s <a href=https://docs.fluentbit.io/manual/>documentation</a>.</p><p><strong>Note:</strong> At the moment only <em>parser</em> and <em>filter</em> configurations are supported.</p><p>To contribute its own configuration to the fluent-bit agents data pipelines, an extension must provide it as a <code>ConfigMap</code> labeled <code>extensions.gardener.cloud/configuration=logging</code> and deployed in the seed&rsquo;s <code>garden</code> namespace. Unlike the monitoring stack, where configurations are deployed per shoot, here a <em>single</em> configuration <code>ConfigMap</code> is sufficient and it applies to all fluent-bit agents in the seed. Its <code>data</code> field can have the following properties:</p><ul><li><code>filter-kubernetes.conf</code> - configuration for data pipeline <a href=https://docs.fluentbit.io/manual/concepts/data-pipeline/filter>filters</a></li><li><code>parser.conf</code> - configuration for data pipeline <a href=https://docs.fluentbit.io/manual/concepts/data-pipeline/parser>parsers</a></li></ul><p><strong>Note:</strong> Take care to provide the correct data pipeline elements in the coresponding data field and not to mix them.</p><p><strong>Example:</strong> Logging configuration for provider-specific (OpenStack) worker controller deploying a <code>machine-controller-manager</code> component into a shoot namespace that reuses the <code>kubeapiserverParser</code> defined in <a href=https://github.com/gardener/gardener/blob/master/charts/seed-bootstrap/charts/fluent-bit/templates/fluent-bit-configmap.yaml#L304-L309>fluent-bit-configmap.yaml</a> to parse the component logs</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener-extension-provider-openstack-logging-config</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>extensions.gardener.cloud/configuration</span><span class=p>:</span><span class=w> </span><span class=l>logging</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>filter-kubernetes.conf</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    [FILTER]
</span><span class=sd>        Name                parser
</span><span class=sd>        Match               kubernetes.machine-controller-manager*openstack-machine-controller-manager*
</span><span class=sd>        Key_Name            log
</span><span class=sd>        Parser              kubeapiserverParser
</span><span class=sd>        Reserve_Data        True</span><span class=w>    
</span></code></pre></div><h5 id=how-to-expose-logs-to-the-users>How to expose logs to the users</h5><p>To expose logs from extension components to the users, the extension owners have to specify a <code>rewrite_tag</code> filter which will prefix the tag with <code>user-exposed</code>, thus telling the fluent-bit to send those logs to Loki under user tenant.
Logs can be found in <code>Controlplane Logs Dashboard</code> Grafana dashboard.</p><p><strong>Example:</strong> In this example we configure fluent-bit when it finds a log with field <code>tag</code>, which match the <code>Rule</code>, to prefix the log&rsquo;s tag with <code>user-exposed</code> and to re-emit the new record by setting the last argument to <code>true</code>.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener-extension-provider-aws-logging-config</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>extensions.gardener.cloud/configuration</span><span class=p>:</span><span class=w> </span><span class=l>logging</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>filter-kubernetes.conf</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    [FILTER]
</span><span class=sd>        Name                rewrite_tag
</span><span class=sd>        Match               kubernetes.*
</span><span class=sd>        Rule                $tag ^kubernetes\.var\.log\.containers\.(cloud-controller-manager-.+?_.+?_aws-cloud-controller-manager|csi-driver-controller-.+?_.+?_aws-csi) user-exposed.$TAG true
</span><span class=sd>        Emitter_Name        re_emitted-provider-aws</span><span class=w>    
</span></code></pre></div><p>In this case we have predefined filter which copies the log&rsquo;s tag into the log record under the <code>tag</code> field. The tag consists of the container logs directories path, plus <code>&lt;pod_name>_&lt;shoot_controlplane_namespace>_&lt;container_name>_&lt;container_id></code>, so here we say:</p><blockquote><p>When you see a record from pod <code>cloud-controller-manager</code> and some of the <code>aws-cloud-controller-manager</code>, <code>csi-driver-controller</code> or <code>aws-csi</code> containers change the tag to <code>user-exposed.&lt;old_tag></code> and instead of replacing the tag inline, copy the record and re-emit it as new one, keeping the old record unchanged."</p></blockquote><p><strong>Note:</strong> If you don&rsquo;t re-emit the record the operators will not see the logs from those components.</p><p>Further details how to define parsers and use them with examples can be found in the following <a href=https://github.com/gardener/gardener/blob/master/docs/development/log_parsers.md>guide</a>.</p><h4 id=grafana>Grafana</h4><p>The three types of Grafana instances found in a seed cluster are configured to expose logs of different origin in their dashboards:</p><ul><li>Garden Grafana dashboards expose logs from non-shoot namespaces of the seed clusters<ul><li><a href=https://github.com/gardener/gardener/blob/master/charts/seed-bootstrap/dashboards/pod-logs.json>Pod Logs</a></li><li><a href=https://github.com/gardener/gardener/blob/master/charts/seed-bootstrap/dashboards/extensions-dashboard.json>Extensions</a></li><li><a href=https://github.com/gardener/gardener/blob/master/charts/seed-bootstrap/dashboards/systemd-logs.json>Systemd Logs</a></li></ul></li><li>Shoot User Grafana dashboards expose a subset of the logs shown to operators<ul><li>Kube Apiserver</li><li>Kube Controller Manager</li><li>Kube Scheduler</li><li>Cluster Autoscaler</li><li>VPA components</li></ul></li><li>Shoot Operator Grafana dashboards expose logs from the shoot cluster namespace where they belong<ul><li>All user&rsquo;s dashboards</li><li><a href=https://github.com/gardener/gardener/blob/master/charts/seed-monitoring/charts/grafana/dashboards/operators/kubernetes-pods-dashboard.json>Kubernetes Pods</a></li></ul></li></ul><p>If the type of logs exposed in the Grafana instances needs to be changed, it is necessary to update the coresponding instance dashboard configurations.</p><h2 id=tips>Tips</h2><ul><li>Be careful to match exactly the log names that you need for a particular parser in your filters configuration. The regular expression you will supply will match names in the form <code>kubernetes.pod_name.&lt;metadata>.container_name</code>. If there are extensions with the same container and pod names, they will all match the same parser in a filter. That may be a desired effect, if they all share the same log format. But it will be a problem if they don&rsquo;t. To solve it, either the pod or container names must be unique, and the regular expression in the filter has to match that unique pattern. A recommended approach is to prefix containers with the extension name and tune the regular expression to match it. For example, using <code>myextension-container</code> as container name, and a regular expression <code>kubernetes.mypod.*myextension-container</code> will guarantee match of the right log name. Make sure that the regular expression does not match more than you expect. For example, <code>kubernetes.systemd.*systemd.*</code> will match both <code>systemd-service</code> and <code>systemd-monitor-service</code>. You will want to be as specific as possible.</li><li>It&rsquo;s a good idea to put the logging configuration into the Helm chart that also deploys the extension <em>controller</em>, while the monitoring configuration can be part of the Helm chart/deployment routine that deploys the <em>component</em> managed by the controller.</li></ul><h2 id=references-and-additional-resources>References and additional resources</h2><ul><li><a href=https://github.com/gardener/gardener/issues/1351>GitHub issue describing the concept</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-gcp/blob/master/charts/internal/seed-controlplane/charts/cloud-controller-manager/templates/configmap-monitoring.yaml>Exemplary implementation (monitoring) for the GCP provider</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-openstack/blob/master/charts/gardener-extension-provider-openstack/templates/configmap-logging.yaml>Exemplary implementation (logging) for the OpenStack provider</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-da96f150c9939d219de708c58a89cd04>1.4.18 - OperatingSystemConfig resource</h1><h1 id=contract-operatingsystemconfig-resource>Contract: <code>OperatingSystemConfig</code> resource</h1><p>Gardener uses the machine API and leverages the functionalities of the <a href=https://github.com/gardener/machine-controller-manager>machine-controller-manager</a> (MCM) in order to manage the worker nodes of a shoot cluster.
The machine-controller-manager itself simply takes a reference to an OS-image and (optionally) some user-data (a script or configuration that is executed when a VM is bootstrapped), and forwards both to the provider&rsquo;s API when creating VMs.
MCM does not have any restrictions regarding supported operating systems as it does not modify or influence the machine&rsquo;s configuration in any way - it just creates/deletes machines with the provided metadata.</p><p>Consequently, Gardener needs to provide this information when interacting with the machine-controller-manager.
This means that basically every operating system is possible to be used as long as there is some implementation that generates the OS-specific configuration in order to provision/bootstrap the machines.</p><p>:warning: Currently, there are a few requirements:</p><ol><li>The operating system must have built-in <a href=https://www.docker.com/>Docker</a> support.</li><li>The operating system must have <a href=https://www.freedesktop.org/wiki/Software/systemd/>systemd</a> support.</li><li>The operating system must have <a href=https://www.gnu.org/software/wget/><code>wget</code></a> pre-installed.</li><li>The operating system must have <a href=https://stedolan.github.io/jq/><code>jq</code></a> pre-installed.</li></ol><p>The reasons for that will become evident later.</p><h2 id=what-does-the-user-data-bootstrapping-the-machines-contain>What does the user-data bootstrapping the machines contain?</h2><p>Gardener installs a few components onto every worker machine in order to allow it to join the shoot cluster.
There is the <code>kubelet</code> process, some scripts for continuously checking the health of <code>kubelet</code> and <code>docker</code>, but also configuration for log rotation, CA certificates, etc.
The complete configuration you can find <a href=https://github.com/gardener/gardener/tree/master/pkg/operation/botanist/component/extensions/operatingsystemconfig/original/components>here</a>. We are calling this the &ldquo;original&rdquo; user-data.</p><h2 id=how-does-gardener-bootstrap-the-machines>How does Gardener bootstrap the machines?</h2><p>Usually, you would submit all the components you want to install onto the machine as part of the user-data during creation time.
However, some providers do have a size limitation (like ~16KB) for that user-data.
That&rsquo;s why we do not send the &ldquo;original&rdquo; user-data to the machine-controller-manager (who forwards it then to the provider&rsquo;s API).
Instead, we only send a small script that downloads the &ldquo;original&rdquo; data and applies it on the machine directly.
This way we can extend the &ldquo;original&rdquo; user-data without any size restrictions - plus we can modify it without the necessity of re-creating the machine (because we run a script that downloads and updates it continuously).</p><p>The high-level flow is as follows:</p><ol><li><p>For every worker pool <code>X</code> in the <code>Shoot</code> specification, Gardener creates a <code>Secret</code> named <code>cloud-config-&lt;X></code> in the <code>kube-system</code> namespace of the shoot cluster. The secret contains the &ldquo;original&rdquo; user-data.</p></li><li><p>Gardener generates a kubeconfig with minimal permissions just allowing reading these secrets. It is used by the <code>downloader</code> script later.</p></li><li><p>Gardener provides the <code>downloader</code> script, the kubeconfig, and the machine image stated in the <code>Shoot</code> specification to the machine-controller-manager.</p></li><li><p>Based on this information the machine-controller-manager creates the VM.</p></li><li><p>After the VM has been provisioned the <code>downloader</code> script starts and fetches the appropriate <code>Secret</code> for its worker pool (containing the &ldquo;original&rdquo; user-data) and applies it.</p></li></ol><h3 id=detailed-bootstrap-flow-with-a-worker-generated-bootstrap-token>Detailed bootstrap flow with a worker generated bootstrap-token</h3><p>With gardener v1.23 a file with the content <code>&lt;&lt;BOOTSTRAP_TOKEN>></code> is added to the <code>cloud-config-&lt;worker-group>-downloader</code> <code>OperatingSystemConfig</code> (part of step 2 in the graphic below).
Via the OS extension the new file (with its content in clear-text) gets passed to the corresponding <code>Worker</code> resource.</p><p>The <code>Worker</code> controller has to guarantee that:</p><ul><li>a bootstrap token is created.</li><li>the <code>&lt;&lt;BOOTSTRAP_TOKEN>></code> in the user data is replaced by the generated token.
One implementation of that is depicted in the picture where the machine-controller-manager creates a temporary token and replaces the placeholder.</li></ul><p>As part of the user-data the bootstrap-token is placed on the newly created VM under a defined path.
The cloud-config-script will then refer to the file path of the added bootstrap token in the kubelet-bootstrap script.</p><p>If either the <code>Worker</code> controller does not replace the <code>&lt;&lt;BOOTSTRAP_TOKEN>></code> or the OS extension does not support the <code>transmitUnencoded</code> flag then the bootstrap flow will fall back to the old flow of using a shared bootstrap token between the worker nodes of a shoot cluster.</p><p><img src=/__resources/bootstrap_token_c9a050.png alt="Bootstrap flow with shortlived bootstrapTokens"></p><h2 id=how-does-gardener-update-the-user-data-on-already-existing-machines>How does Gardener update the user-data on already existing machines?</h2><p>With ongoing development and new releases of Gardener some new components could be required to get installed onto every shoot worker VM, or existing components need to be changed.
Gardener achieves that by simply updating the user-data inside the <code>Secret</code>s mentioned above (step 1).
The <code>downloader</code> script is continuously (every 30s) reading the secret&rsquo;s content (which might include an updated user-data) and storing it onto the disk.
In order to re-apply the (new) downloaded data the secrets do not only contain the &ldquo;original&rdquo; user-data but also another short script (called &ldquo;execution&rdquo; script).
This script checks whether the downloaded user-data differs from the one previously applied - and if required - re-applies it.
After that it uses <code>systemctl</code> to restart the installed <code>systemd</code> units.</p><p>With the help of the execution script Gardener can centrally control how machines are updated without the need of OS providers to (re-)implement that logic.
However, as stated in the mentioned requirements above, the execution script assumes existence of Docker and <code>systemd</code>.</p><h2 id=what-needs-to-be-implemented-to-support-a-new-operating-system>What needs to be implemented to support a new operating system?</h2><p>As part of the shoot flow Gardener will create a special CRD in the seed cluster that needs to be reconciled by an extension controller, for example:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>OperatingSystemConfig</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pool-01-original</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>&lt;my-operating-system&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>reconcile</span><span class=w>
</span><span class=w>  </span><span class=nt>reloadConfigFilePath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/cloud-config-downloader/cloud-config</span><span class=w>
</span><span class=w>  </span><span class=nt>units</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>docker.service</span><span class=w>
</span><span class=w>    </span><span class=nt>dropIns</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=m>10</span>-<span class=l>docker-opts.conf</span><span class=w>
</span><span class=w>      </span><span class=nt>content</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>        [Service]
</span><span class=sd>        Environment=&#34;DOCKER_OPTS=--log-opt max-size=60m --log-opt max-file=3&#34;</span><span class=w>        
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>docker-monitor.service</span><span class=w>
</span><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>start</span><span class=w>
</span><span class=w>    </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>content</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>      [Unit]
</span><span class=sd>      Description=Docker-monitor daemon
</span><span class=sd>      After=kubelet.service
</span><span class=sd>      [Install]
</span><span class=sd>      WantedBy=multi-user.target
</span><span class=sd>      [Service]
</span><span class=sd>      Restart=always
</span><span class=sd>      EnvironmentFile=/etc/environment
</span><span class=sd>      ExecStart=/opt/bin/health-monitor docker</span><span class=w>      
</span><span class=w>  </span><span class=nt>files</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/kubelet/ca.crt</span><span class=w>
</span><span class=w>    </span><span class=nt>permissions</span><span class=p>:</span><span class=w> </span><span class=m>0644</span><span class=w>
</span><span class=w>    </span><span class=nt>encoding</span><span class=p>:</span><span class=w> </span><span class=l>b64</span><span class=w>
</span><span class=w>    </span><span class=nt>content</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default-token-5dtjz</span><span class=w>
</span><span class=w>        </span><span class=nt>dataKey</span><span class=p>:</span><span class=w> </span><span class=l>token</span><span class=w>
</span><span class=w>  </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/sysctl.d/99-k8s-general.conf</span><span class=w>
</span><span class=w>    </span><span class=nt>permissions</span><span class=p>:</span><span class=w> </span><span class=m>0644</span><span class=w>
</span><span class=w>    </span><span class=nt>content</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>inline</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>          # A higher vm.max_map_count is great for elasticsearch, mongo, or other mmap users
</span><span class=sd>          # See https://github.com/kubernetes/kops/issues/1340
</span><span class=sd>          vm.max_map_count = 135217728</span><span class=w>          
</span></code></pre></div><p>In order to support a new operating system you need to write a controller that watches all <code>OperatingSystemConfig</code>s with <code>.spec.type=&lt;my-operating-system></code>.
For those it shall generate a configuration blob that fits to your operating system.
For example, a CoreOS controller might generate a <a href=https://coreos.com/os/docs/latest/cloud-config.html>CoreOS cloud-config</a> or <a href=https://coreos.com/ignition/docs/latest/what-is-ignition.html>Ignition</a>, SLES might generate <a href=https://cloudinit.readthedocs.io/en/latest/>cloud-init</a>, and others might simply generate a bash script translating the <code>.spec.units</code> into <code>systemd</code> units, and <code>.spec.files</code> into real files on the disk.</p><p><code>OperatingSystemConfig</code>s can have two purposes which can be used (or ignored) by the extension controllers: either <code>provision</code> or <code>reconcile</code>.</p><ul><li>The <code>provision</code> purpose is used by Gardener for the user-data that it later passes to the machine-controller-manager (and then to the provider&rsquo;s API) when creating new VMs. It contains the <code>downloader</code> unit.</li><li>The <code>reconcile</code> purpose contains the &ldquo;original&rdquo; user-data (that is then stored in <code>Secret</code>s in the shoot&rsquo;s <code>kube-system</code> namespace (see step 1). This is downloaded and applies late (see step 5).</li></ul><p>As described above, the &ldquo;original&rdquo; user-data must be re-applicable to allow in-place updates.
The way how this is done is specific to the generated operating system config (e.g., for CoreOS cloud-init the command is <code>/usr/bin/coreos-cloudinit --from-file=&lt;path></code>, whereas SLES would run <code>cloud-init --file &lt;path> single -n write_files --frequency=once</code>).
Consequently, besides the generated OS config, the extension controller must also provide a command for re-application an updated version of the user-data.
As visible in the mentioned examples the command requires a path to the user-data file.
Gardener will provide the path to the file in the <code>OperatingSystemConfig</code>s <code>.spec.reloadConfigFilePath</code> field (only if <code>.spec.purpose=reconcile</code>).
As soon as Gardener detects that the user data has changed it will reload the systemd daemon and restart all the units provided in the <code>.status.units[]</code> list (see below example). The same logic applies during the very first application of the whole configuration.</p><p>After generation extension controllers are asked to store their OS config inside a <code>Secret</code> (as it might contain confidential data) in the same namespace.
The secret&rsquo;s <code>.data</code> could look like this:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>osc-result-pool-01-original</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>ownerReferences</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>    </span><span class=nt>blockOwnerDeletion</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>controller</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>OperatingSystemConfig</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pool-01-original</span><span class=w>
</span><span class=w>    </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>99c0c5ca-19b9-11e9-9ebd-d67077b40f82</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>cloud_config</span><span class=p>:</span><span class=w> </span><span class=l>base64(generated-user-data)</span><span class=w>
</span></code></pre></div><p>Finally, the secret&rsquo;s metadata, the OS-specific command to re-apply the configuration, and the list of <code>systemd</code> units that shall be considered to be restarted if an updated version of the user-data is re-applied must be provided in the <code>OperatingSystemConfig</code>&rsquo;s <code>.status</code> field:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>cloudConfig</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>osc-result-pool-01-original</span><span class=w>
</span><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>/usr/bin/coreos-cloudinit --from-file=/var/lib/cloud-config-downloader/cloud-config</span><span class=w>
</span><span class=w>  </span><span class=nt>lastOperation</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>Successfully generated cloud config</span><span class=w>
</span><span class=w>    </span><span class=nt>lastUpdateTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2019-01-23T07:45:23Z&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>progress</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>Succeeded</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Reconcile</span><span class=w>
</span><span class=w>  </span><span class=nt>observedGeneration</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span><span class=w>  </span><span class=nt>units</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=l>docker-monitor.service</span><span class=w>
</span></code></pre></div><p>(The <code>.status.command</code> field is optional and must only be provided if <code>.spec.reloadConfigFilePath</code> exists).</p><p>Once the <code>.status</code> indicates that the extension controller finished reconciling Gardener will continue with the next step of the shoot reconciliation flow.</p><h2 id=cri-support>CRI Support</h2><p>Gardener supports specifying Container Runtime Interface (CRI) configuration in the <code>OperatingSystemConfig</code> resource. If the <code>.spec.cri</code> section exists then the <code>name</code> property is mandatory. The only supported values for <code>cri.name</code> at the moment are: <code>containerd</code> and <code>docker</code>, which uses the in-tree dockershim.
For example:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>OperatingSystemConfig</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pool-01-original</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>&lt;my-operating-system&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>reconcile</span><span class=w>
</span><span class=w>  </span><span class=nt>reloadConfigFilePath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/cloud-config-downloader/cloud-config</span><span class=w>
</span><span class=w>  </span><span class=nt>cri</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>containerd</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>To support ContainerD, an OS extension must :</p><ol><li>The operating system must have built-in <a href=https://containerd.io/>ContainerD</a> and the <a href=https://github.com/projectatomic/containerd/blob/master/docs/cli.md/>Client CLI</a></li><li>ContainerD must listen on its default socket path: <code>unix:///run/containerd/containerd.sock</code></li><li>ContainerD must be configured to work with the default configuration file in: <code>/etc/containerd/config.toml</code> (Created by Gardener).</li></ol><p>If CRI configurations are not supported it is recommended create a validating webhook running in the garden cluster that prevents specifying the <code>.spec.providers.workers[].cri</code> section in the <code>Shoot</code> objects.</p><h2 id=references-and-additional-resources>References and additional resources</h2><ul><li><a href=https://github.com/gardener/gardener/blob/master/pkg/apis/extensions/v1alpha1/types_operatingsystemconfig.go><code>OperatingSystemConfig</code> API (Golang specification)</a></li><li><a href=https://github.com/gardener/gardener/blob/master/pkg/operation/botanist/component/extensions/operatingsystemconfig/downloader/templates/scripts/download-cloud-config.tpl.sh><code>downloader</code> script</a> (fetching the &ldquo;original&rdquo; user-data and the execution script)</li><li><a href=https://github.com/gardener/gardener/blob/master/charts/seed-operatingsystemconfig/original/templates>Original user-data templates</a></li><li><a href=https://github.com/gardener/gardener/blob/master/pkg/operation/botanist/component/extensions/operatingsystemconfig/executor/templates/scripts/execute-cloud-config.tpl.sh>Execution script</a> (applying the &ldquo;original&rdquo; user-data)</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-cf56625a2a1f9dc171ac07c59a3541e1>1.4.19 - Referenced Resources</h1><h1 id=referenced-resources>Referenced Resources</h1><p>The Shoot resource can include a list of resources (usually secrets) that can be referenced by name in extension <code>providerConfig</code> and other Shoot sections, for example:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>crazy-botany</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden-dev</span><span class=w>
</span><span class=w>  </span><span class=l>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>foobar</span><span class=w>
</span><span class=w>    </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>foobar.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>FooBarConfig</span><span class=w>
</span><span class=w>      </span><span class=nt>foo</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span><span class=w>      </span><span class=nt>secretRef</span><span class=p>:</span><span class=w> </span><span class=l>foobar-secret</span><span class=w>
</span><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>foobar-secret</span><span class=w>
</span><span class=w>    </span><span class=nt>resourceRef</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-foobar-secret</span><span class=w>
</span></code></pre></div><p>Gardener expects to find these referenced resources in the project namespace (e.g. <code>garden-dev</code>) and will copy them to the Shoot namespace in the Seed cluster when reconciling a Shoot, adding a prefix to their names to avoid naming collisions with Gardener&rsquo;s own resources.</p><p>Extension controllers can resolve the references to these resources by accessing the Shoot via the <code>Cluster</code> resource. To properly read a referenced resources, extension controllers should use the utility function <code>GetObjectByReference</code> from the <code>extensions/pkg/controller</code> package, for example:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go>    <span class=o>...</span>
    <span class=nx>ref</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>autoscalingv1</span><span class=p>.</span><span class=nx>CrossVersionObjectReference</span><span class=p>{</span>
        <span class=nx>APIVersion</span><span class=p>:</span> <span class=s>&#34;v1&#34;</span><span class=p>,</span>
        <span class=nx>Kind</span><span class=p>:</span>       <span class=s>&#34;Secret&#34;</span><span class=p>,</span>
        <span class=nx>Name</span><span class=p>:</span>       <span class=s>&#34;foo&#34;</span><span class=p>,</span>
    <span class=p>}</span>
    <span class=nx>secret</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Secret</span><span class=p>{}</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>controller</span><span class=p>.</span><span class=nf>GetObjectByReference</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>client</span><span class=p>,</span> <span class=nx>ref</span><span class=p>,</span> <span class=s>&#34;shoot--test--foo&#34;</span><span class=p>,</span> <span class=nx>secret</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>err</span>
    <span class=p>}</span>
    <span class=c1>// Use secret
</span><span class=c1></span>    <span class=o>...</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8ec3e8fc9554b8c14686e23c6f65ba47>1.4.20 - Registering Extension Controllers</h1><h1 id=registering-extension-controllers>Registering Extension Controllers</h1><p>Extensions are registered in the garden cluster via <a href=https://github.com/gardener/gardener/blob/master/example/25-controllerregistration.yaml><code>ControllerRegistration</code></a> resources.
Gardener is evaluating the registrations and creates <a href=https://github.com/gardener/gardener/blob/master/example/25-controllerinstallation.yaml><code>ControllerInstallation</code></a> resources which describe the request &ldquo;please install this controller <code>X</code> to this seed <code>Y</code>&rdquo;.</p><p>Similar to how <code>CloudProfile</code> or <code>Seed</code> resources get into the system, the Gardener administrator must deploy the <code>ControllerRegistration</code> resources (this does not happen automatically in any way - the administrator decides which extensions shall be enabled).</p><p>The specification mainly describes which of Gardener&rsquo;s extension CRDs are managed, for example:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ControllerDeployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>os-gardenlinux</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>helm</span><span class=w>
</span><span class=w></span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class=l>H4sIFAAAAAAA/yk...</span><span class=w> </span><span class=c># &lt;base64-gzip-chart&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>foo</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ControllerRegistration</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>os-gardenlinux</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>deployment</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>deploymentRefs</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>os-gardenlinux</span><span class=w>
</span><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>OperatingSystemConfig</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>gardenlinux</span><span class=w>
</span><span class=w>    </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></code></pre></div><p>This information tells Gardener that there is an extension controller that can handle <code>OperatingSystemConfig</code> resources of type <code>gardenlinux</code>.
A reference to the shown <code>ControllerDeployment</code> specifies how the deployment of the extension controller is accomplished.</p><p>Also, it specifies that this controller is the primary one responsible for the lifecycle of the <code>OperatingSystemConfig</code> resource.
Setting <code>primary</code> to <code>false</code> would allow to register additional, secondary controllers that may also watch/react on the <code>OperatingSystemConfig/coreos</code> resources, however, only the primary controller may change/update the main <code>status</code> of the extension object (that are used to &ldquo;communicate&rdquo; with the Gardenlet).
Particularly, only the primary controller may set <code>.status.lastOperation</code>, <code>.status.lastError</code>, <code>.status.observedGeneration</code>, and <code>.status.state</code>.
Secondary controllers may contribute to the <code>.status.conditions[]</code> if they like, of course.</p><p>Secondary controllers might be helpful in scenarios where additional tasks need to be completed which are not part of the reconciliation logic of the primary controller but separated out into a dedicated extension.</p><p>⚠️ There must be exactly one primary controller for every registered kind/type combination.
Also, please note that the <code>primary</code> field cannot be changed after creation of the <code>ControllerRegistration</code>.</p><h2 id=deploying-extension-controllers>Deploying Extension Controllers</h2><p>Submitting above <code>ControllerDeployment</code> and <code>ControllerRegistration</code> will create a <code>ControllerInstallation</code> resource:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ControllerInstallation</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>os-gardenlinux</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>deploymentRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>networking-calico</span><span class=w>
</span><span class=w>  </span><span class=nt>registrationRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>os-gardenlinux</span><span class=w>
</span><span class=w>  </span><span class=nt>seedRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>aws-eu1</span><span class=w>
</span></code></pre></div><p>This resource expresses that Gardener requires the <code>os-gardenlinux</code> extension controller to run on the <code>aws-eu1</code> seed cluster.</p><p>The Gardener Controller Manager does automatically determine which extension is required on which seed cluster and will only create <code>ControllerInstallation</code> objects for those.
Also, it will automatically delete <code>ControllerInstallation</code>s referencing extension controllers that are no longer required on a seed (e.g., because all shoots on it have been deleted).
There are additional configuration options, please see <a href=#deployment-configuration-options>this section</a>.</p><h2 id=how-do-extension-controllers-get-deployed-to-seeds>How do extension controllers get deployed to seeds?</h2><p>After Gardener has written the <code>ControllerInstallation</code> resource some component must satisfy this request and start deploying the extension controller to the seed.
Depending on the complexity of the controller&rsquo;s lifecycle management, configuration, etc. there are two possible scenarios:</p><h3 id=scenario-1-deployed-by-gardener>Scenario 1: Deployed by Gardener</h3><p>In many cases the extension controllers are easy to deploy and configure.
It is sufficient to simply create a Helm chart (standardized way of packaging software in the Kubernetes context) and deploy it together with some static configuration values.
Gardener supports this scenario and allows to provide arbitrary deployment information in the <code>ControllerDeployment</code> resource&rsquo;s <code>.providerConfig</code> section:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>helm</span><span class=w>
</span><span class=w></span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class=l>H4sIFAAAAAAA/yk...</span><span class=w>
</span><span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>foo</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span></code></pre></div><p>If <code>.type=helm</code> then Gardener itself will take over the responsibility the deployment.
It base64-decodes the provided Helm chart (<code>.providerConfig.chart</code>) and deploys it with the provided static configuration (<code>.providerConfig.values</code>).
The chart and the values can be updated at any time - Gardener will recognize and re-trigger the deployment process.</p><p>In order to allow extensions to get information about the garden and the seed cluster Gardener does mix-in certain properties into the values (root level) of every deployed Helm chart:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>gardener</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>garden</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>identifier</span><span class=p>:</span><span class=w> </span><span class=l>&lt;uuid-of-gardener-installation&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>seed</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>identifier</span><span class=p>:</span><span class=w> </span><span class=l>&lt;seed-name&gt;</span><span class=w>
</span><span class=w>    </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>europe</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w> </span><span class=l>&lt;complete-seed-spec&gt;</span><span class=w>
</span></code></pre></div><p>Extensions can use this information in their Helm chart in case they require knowledge about the garden and the seed environment.
The list might be extended in the future.</p><p>:information_source: Gardener uses the UUID of the <code>garden</code> <code>Namespace</code> object in the <code>.gardener.garden.identifier</code> property.</p><h3 id=scenario-2-deployed-by-a-non-human-kubernetes-operator>Scenario 2: Deployed by a (non-human) Kubernetes operator</h3><p>Some extension controllers might be more complex and require additional domain-specific knowledge wrt. lifecycle or configuration.
In this case, we encourage to follow the Kubernetes operator pattern and deploy a dedicated operator for this extension into the garden cluster.
The <code>ControllerDeployments</code>&rsquo;s <code>.type</code> field would then not be <code>helm</code>, and no Helm chart or values need to be provided there.
Instead, the operator itself knows how to deploy the extension into the seed.
It must watch <code>ControllerInstallation</code> resources and act one those referencing a <code>ControllerRegistration</code> the operator is responsible for.</p><p>In order to let Gardener know that the extension controller is ready and running in the seed the <code>ControllerInstallation</code>&rsquo;s <code>.status</code> field supports two conditions: <code>RegistrationValid</code> and <code>InstallationSuccessful</code> - both must be provided by the responsible operator:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2019-01-22T11:51:11Z&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>lastUpdateTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2019-01-22T11:51:11Z&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>Chart could be rendered successfully.</span><span class=w>
</span><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>RegistrationValid</span><span class=w>
</span><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Valid</span><span class=w>
</span><span class=w>  </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2019-01-22T11:51:12Z&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>lastUpdateTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2019-01-22T11:51:12Z&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>Installation of new resources succeeded.</span><span class=w>
</span><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>InstallationSuccessful</span><span class=w>
</span><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Installed</span><span class=w>
</span></code></pre></div><p>Additionally, the <code>.status</code> field has a <code>providerStatus</code> section into which the operator can (optionally) put any arbitrary data associated with this installation.</p><h2 id=extensions-in-the-garden-cluster-itself>Extensions in the garden cluster itself</h2><p>The <code>Shoot</code> resource itself will contain some provider-specific data blobs.
As a result, some extensions might also want to run in the garden cluster, e.g., to provide <code>ValidatingWebhookConfiguration</code>s for validating the correctness of their provider-specific blobs:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>johndoe-aws</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden-dev</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>cloud</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws</span><span class=w>
</span><span class=w>    </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>    </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>aws.cloud.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InfrastructureConfig</span><span class=w>
</span><span class=w>      </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>vpc</span><span class=p>:</span><span class=w> </span><span class=c># specify either &#39;id&#39; or &#39;cidr&#39;</span><span class=w>
</span><span class=w>        </span><span class=c># id: vpc-123456</span><span class=w>
</span><span class=w>          </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>10.250.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>        </span><span class=nt>internal</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=m>10.250.112.0</span><span class=l>/22</span><span class=w>
</span><span class=w>        </span><span class=nt>public</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=m>10.250.96.0</span><span class=l>/22</span><span class=w>
</span><span class=w>        </span><span class=nt>workers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=m>10.250.0.0</span><span class=l>/19</span><span class=w>
</span><span class=w>      </span><span class=nt>zones</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>eu-west-1a</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>In the above example, Gardener itself does not understand the AWS-specific provider configuration for the infrastructure.
However, if this part of the <code>Shoot</code> resource should be validated then you should run an AWS-specific component in the garden cluster that registers a webhook. You can do it similarly if you want to default some fields of a resource (by using a <code>MutatingWebhookConfiguration</code>).</p><p>Again, similar to how Gardener is deployed to the garden cluster, these components must be deployed and managed by the Gardener administrator.</p><h3 id=extension-resource-configurations><code>Extension</code> resource configurations</h3><p>The <code>Extension</code> resource allows injecting arbitrary steps into the shoot reconciliation flow that are unknown to Gardener.
Hence, it is slightly special and allows further configuration when registering it:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ControllerRegistration</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>extension-foo</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Extension</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span><span class=w>    </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>globallyEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>reconcileTimeout</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></code></pre></div><p>The <code>globallyEnabled=true</code> option specifies that the <code>Extension/foo</code> object shall be created by default for all shoots (unless they opted out by setting <code>.spec.extensions[].enabled=false</code> in the <code>Shoot</code> spec).</p><p>The <code>reconcileTimeout</code> tells Gardener how long it should wait during its shoot reconciliation flow for the <code>Extension/foo</code>&rsquo;s reconciliation to finish.</p><h3 id=deployment-configuration-options>Deployment configuration options</h3><p>The <code>.spec.deployment</code> resource allows to configure a deployment <code>policy</code>.
There are the following policies:</p><ul><li><code>OnDemand</code> (default): Gardener will demand the deployment and deletion of the extension controller to/from seed clusters dynamically. It will automatically determine (based on other resources like <code>Shoot</code>s) whether it is required and decide accordingly.</li><li><code>Always</code>: Gardener will demand the deployment of the extension controller to seed clusters independent of whether it is actually required or not. This might be helpful if you want to add a new component/controller to all seed clusters by default. Another use-case is to minimize the durations until extension controllers get deployed and ready in case you have highly fluctuating seed clusters.</li><li><code>AlwaysExceptNoShoots</code>: Similar to <code>Always</code>, but if the seed does not have any shoots then the extension is not being deployed. It will be deleted from a seed after the last shoot has been removed from it.</li></ul><p>Also, the <code>.spec.deployment.seedSelector</code> allows to specify a label selector for seed clusters.
Only if it matches the labels of a seed then it will be deployed to it.
Please note that a seed selector can only be specified for secondary controllers (<code>primary=false</code> for all <code>.spec.resources[]</code>).</p></div><div class=td-content style=page-break-before:always><h1 id=pg-44b2a66ac251c8de59c37b8d3dc96d3f>1.4.21 - Shoot maintenance</h1><h1 id=shoot-maintenance>Shoot maintenance</h1><p>There is a general <a href=https://github.com/gardener/gardener/blob/master/docs/usage/shoot_maintenance.md>document about shoot maintenance</a> that you might want to read.
Here, we describe how you can influence certain operations that happen during a shoot maintenance.</p><h2 id=restart-control-plane-controllers>Restart Control Plane Controllers</h2><p>As outlined in above linked document, Gardener offers to restart certain control plane controllers running in the seed during a shoot maintenance.</p><p>Extension controllers can extend the amount of pods being affected by these restarts.
If your Gardener extension manages pods of a shoot&rsquo;s control plane (shoot namespace in seed) and it could potentially profit from a regular restart please consider labeling it with <code>maintenance.gardener.cloud/restart=true</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ae156a46bba075b16621c377b231eaaf>1.4.22 - Shoot resource customization webhooks</h1><h1 id=shoot-resource-customization-webhooks>Shoot resource customization webhooks</h1><p>Gardener deploys several components/resources into the shoot cluster.
Some of these resources are essential (like the <code>kube-proxy</code>), others are optional addons (like the <code>kubernetes-dashboard</code> or the <code>nginx-ingress-controller</code>).
In either case, some provider extensions might need to mutate these resources and inject provider-specific bits into it.</p><h2 id=whats-the-approach-to-implement-such-mutations>What&rsquo;s the approach to implement such mutations?</h2><p>Similar to how <a href=/docs/concepts/extensions/controlplane-webhooks>control plane components in the seed</a> are modified we are using <code>MutatingWebhookConfiguration</code>s to achieve the same for resources in the shoot.
Both, the provider extension and the kube-apiserver of the shoot cluster are running in the same seed.
Consequently, the kube-apiserver can talk cluster-internally to the provider extension webhook which makes such operations even faster.</p><h2 id=how-is-the-mutatingwebhookconfiguration-object-created-in-the-shoot>How is the <code>MutatingWebhookConfiguration</code> object created in the shoot?</h2><p>The preferred approach is to use a <code>ManagedResource</code> (see also <a href=https://github.com/gardener/gardener/blob/master/docs/extensions/managedresources.md>this document</a>) in the seed cluster.
This way the <code>gardener-resource-manager</code> ensures that end-users cannot delete/modify the webhook configuration.
The provider extension doesn&rsquo;t need to care about the same.</p><h2 id=what-else-is-needed>What else is needed?</h2><p>The shoot&rsquo;s kube-apiserver must be allowed to talk to the provider extension.
To achieve this you need to create a <code>NetworkPolicy</code> in the shoot namespace.
Our <a href=https://github.com/gardener/gardener/blob/master/extensions>extension controller library</a> provides easy-to-use utilities and hooks to implement such a webhook.
Please find an exemplary implementation <a href=https://github.com/gardener/gardener-extension-provider-aws/tree/master/pkg/webhook/shoot>here</a> and <a href=https://github.com/gardener/gardener-extension-provider-aws/blob/566fe4dd588c93821bc9d22c452203867457c930/cmd/gardener-extension-provider-aws/app/app.go#L170-L174>here</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-117b200c67f49abee66735d26c3ade1c>1.4.23 - Worker resource</h1><h1 id=contract-worker-resource>Contract: <code>Worker</code> resource</h1><p>While the control plane of a shoot cluster is living in the seed and deployed as native Kubernetes workload, the worker nodes of the shoot clusters are normal virtual machines (VMs) in the end-users infrastructure account.
The Gardener project features a sub-project called <a href=https://github.com/gardener/machine-controller-manager>machine-controller-manager</a>.
This controller is extending the Kubernetes API using custom resource definitions to represent actual VMs as <code>Machine</code> objects inside a Kubernetes system.
This approach unlocks the possibility to manage virtual machines in the Kubernetes style and benefit from all its design principles.</p><h2 id=what-is-the-machine-controller-manager-exactly-doing>What is the machine-controller-manager exactly doing?</h2><p>Generally, there are provider-specific <code>MachineClass</code> objects (<code>AWSMachineClass</code>, <code>AzureMachineClass</code>, etc.; similar to <code>StorageClass</code>), and <code>MachineDeployment</code>, <code>MachineSet</code>, and <code>Machine</code> objects (similar to <code>Deployment</code>, <code>ReplicaSet</code>, and <code>Pod</code>).
A machine class describes <strong>where</strong> and <strong>how</strong> to create virtual machines (in which networks, region, availability zone, SSH key, user-data for bootstrapping, etc.) while a <code>Machine</code> results in an actual virtual machine.
You can read up <a href=https://github.com/gardener/machine-controller-manager>more information</a> in the machine-controller-manager&rsquo;s <a href=https://github.com/gardener/machine-controller-manager>repository</a>.</p><p>Before the introduction of the <code>Worker</code> extension resource Gardener was deploying the machine-controller-manager, the machine classes, and the machine deployments itself.
Now, Gardener commissions an external, provider-specific controller to take over these tasks.</p><h2 id=what-needs-to-be-implemented-to-support-a-new-worker-provider>What needs to be implemented to support a new worker provider?</h2><p>As part of the shoot flow Gardener will create a special CRD in the seed cluster that needs to be reconciled by an extension controller, for example:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Worker</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>azure</span><span class=w>
</span><span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudprovider</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w>  </span><span class=nt>infrastructureProviderStatus</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>aws.provider.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InfrastructureStatus</span><span class=w>
</span><span class=w>    </span><span class=nt>ec2</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>keyName</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-ssh-publickey</span><span class=w>
</span><span class=w>    </span><span class=nt>iam</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>instanceProfiles</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-nodes</span><span class=w>
</span><span class=w>        </span><span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>nodes</span><span class=w>
</span><span class=w>      </span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>arn</span><span class=p>:</span><span class=w> </span><span class=l>arn:aws:iam::0123456789:role/shoot--foo--bar-nodes</span><span class=w>
</span><span class=w>        </span><span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>nodes</span><span class=w>
</span><span class=w>    </span><span class=nt>vpc</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>vpc-0123456789</span><span class=w>
</span><span class=w>      </span><span class=nt>securityGroups</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>sg-1234567890</span><span class=w>
</span><span class=w>        </span><span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>nodes</span><span class=w>
</span><span class=w>      </span><span class=nt>subnets</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>subnet-01234</span><span class=w>
</span><span class=w>        </span><span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>nodes</span><span class=w>
</span><span class=w>        </span><span class=nt>zone</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1b</span><span class=w>
</span><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>subnet-56789</span><span class=w>
</span><span class=w>        </span><span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>public</span><span class=w>
</span><span class=w>        </span><span class=nt>zone</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1b</span><span class=w>
</span><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>subnet-0123a</span><span class=w>
</span><span class=w>        </span><span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>nodes</span><span class=w>
</span><span class=w>        </span><span class=nt>zone</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1c</span><span class=w>
</span><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>subnet-5678a</span><span class=w>
</span><span class=w>        </span><span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>public</span><span class=w>
</span><span class=w>        </span><span class=nt>zone</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1c</span><span class=w>
</span><span class=w>  </span><span class=nt>pools</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu-worker</span><span class=w>
</span><span class=w>    </span><span class=nt>minimum</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span><span class=w>    </span><span class=nt>maximum</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span><span class=w>    </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>    </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span><span class=w>    </span><span class=nt>machineType</span><span class=p>:</span><span class=w> </span><span class=l>m4.large</span><span class=w>
</span><span class=w>    </span><span class=nt>machineImage</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coreos</span><span class=w>
</span><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1967.5.0</span><span class=w>
</span><span class=w>    </span><span class=nt>userData</span><span class=p>:</span><span class=w> </span><span class=l>c29tZSBkYXRhIHRvIGJvb3RzdHJhcCB0aGUgVk0K</span><span class=w>
</span><span class=w>    </span><span class=nt>volume</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=l>20Gi</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>gp2</span><span class=w>
</span><span class=w>    </span><span class=nt>zones</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>eu-west-1b</span><span class=w>
</span><span class=w>    </span>- <span class=l>eu-west-1c</span><span class=w>
</span><span class=w>    </span><span class=nt>machineControllerManager</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>drainTimeout</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span><span class=w>      </span><span class=nt>healthTimeout</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span><span class=w>      </span><span class=nt>creationTimeout</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span><span class=w>      </span><span class=nt>maxEvictRetries</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span><span class=w>      </span><span class=nt>nodeConditions</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>ReadonlyFilesystem</span><span class=w>
</span><span class=w>      </span>- <span class=l>DiskPressure</span><span class=w>
</span><span class=w>      </span>- <span class=l>KernelDeadlock</span><span class=w>
</span></code></pre></div><p>The <code>.spec.secretRef</code> contains a reference to the provider secret pointing to the account that shall be used to create the needed virtual machines.
Also, as you can see, Gardener copies the output of the infrastructure creation (<code>.spec.infrastructureProviderStatus</code>), see <a href=/docs/concepts/extensions/infrastructure><code>Infrastructure</code> resource</a>, into the <code>.spec</code>.</p><p>In the <code>.spec.pools[]</code> field the desired worker pools are listed.
In the above example, one pool with machine type <code>m4.large</code> and <code>min=3</code>, <code>max=5</code> machines shall be spread over two availability zones (<code>eu-west-1b</code>, <code>eu-west-1c</code>).
This information together with the infrastructure status must be used to determine the proper configuration for the machine classes.</p><p>The <code>spec.pools[].machineControllerManager</code> field allows to configure the settings for machine-controller-manager component. Providers must populate these settings on worker-pool to the related <a href=https://github.com/gardener/machine-controller-manager/blob/master/kubernetes/machine_objects/machine-deployment.yaml#L30-L34>fields</a> in MachineDeployment.</p><p>When seeing such a resource your controller must make sure that it deploys the machine-controller-manager next to the control plane in the seed cluster.
After that, it must compute the desired machine classes and the desired machine deployments.
Typically, one class maps to one deployment, and one class/deployment is created per availability zone.
Following this convention, the created resource would look like this:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z1-3db65</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>gardener.cloud/purpose</span><span class=p>:</span><span class=w> </span><span class=l>machineclass</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>providerAccessKeyId</span><span class=p>:</span><span class=w> </span><span class=l>eW91ci1hd3MtYWNjZXNzLWtleS1pZAo=</span><span class=w>
</span><span class=w>  </span><span class=nt>providerSecretAccessKey</span><span class=p>:</span><span class=w> </span><span class=l>eW91ci1hd3Mtc2VjcmV0LWFjY2Vzcy1rZXkK</span><span class=w>
</span><span class=w>  </span><span class=nt>userData</span><span class=p>:</span><span class=w> </span><span class=l>c29tZSBkYXRhIHRvIGJvb3RzdHJhcCB0aGUgVk0K</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>machine.sapcloud.io/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>AWSMachineClass</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z1-3db65</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ami</span><span class=p>:</span><span class=w> </span><span class=l>ami-0123456789</span><span class=w> </span><span class=c># Your controller must map the stated version to the provider specific machine image information, in the AWS case the AMI.</span><span class=w>
</span><span class=w>  </span><span class=nt>blockDevices</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>ebs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>volumeSize</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span><span class=w>      </span><span class=nt>volumeType</span><span class=p>:</span><span class=w> </span><span class=l>gp2</span><span class=w>
</span><span class=w>  </span><span class=nt>iam</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-nodes</span><span class=w>
</span><span class=w>  </span><span class=nt>keyName</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-ssh-publickey</span><span class=w>
</span><span class=w>  </span><span class=nt>machineType</span><span class=p>:</span><span class=w> </span><span class=l>m4.large</span><span class=w>
</span><span class=w>  </span><span class=nt>networkInterfaces</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>securityGroupIDs</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>sg-1234567890</span><span class=w>
</span><span class=w>    </span><span class=nt>subnetID</span><span class=p>:</span><span class=w> </span><span class=l>subnet-01234</span><span class=w>
</span><span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z1-3db65</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>kubernetes.io/cluster/shoot--foo--bar</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>kubernetes.io/role/node</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>machine.sapcloud.io/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>MachineDeployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z1</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z1</span><span class=w>
</span><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w>
</span><span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z1</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>class</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>AWSMachineClass</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z1-3db65</span><span class=w>
</span></code></pre></div><p>for the first availability zone <code>eu-west-1b</code>, and</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z2-5z6as</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>gardener.cloud/purpose</span><span class=p>:</span><span class=w> </span><span class=l>machineclass</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>providerAccessKeyId</span><span class=p>:</span><span class=w> </span><span class=l>eW91ci1hd3MtYWNjZXNzLWtleS1pZAo=</span><span class=w>
</span><span class=w>  </span><span class=nt>providerSecretAccessKey</span><span class=p>:</span><span class=w> </span><span class=l>eW91ci1hd3Mtc2VjcmV0LWFjY2Vzcy1rZXkK</span><span class=w>
</span><span class=w>  </span><span class=nt>userData</span><span class=p>:</span><span class=w> </span><span class=l>c29tZSBkYXRhIHRvIGJvb3RzdHJhcCB0aGUgVk0K</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>machine.sapcloud.io/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>AWSMachineClass</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z2-5z6as</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ami</span><span class=p>:</span><span class=w> </span><span class=l>ami-0123456789</span><span class=w> </span><span class=c># Your controller must map the stated version to the provider specific machine image information, in the AWS case the AMI.</span><span class=w>
</span><span class=w>  </span><span class=nt>blockDevices</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>ebs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>volumeSize</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span><span class=w>      </span><span class=nt>volumeType</span><span class=p>:</span><span class=w> </span><span class=l>gp2</span><span class=w>
</span><span class=w>  </span><span class=nt>iam</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-nodes</span><span class=w>
</span><span class=w>  </span><span class=nt>keyName</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-ssh-publickey</span><span class=w>
</span><span class=w>  </span><span class=nt>machineType</span><span class=p>:</span><span class=w> </span><span class=l>m4.large</span><span class=w>
</span><span class=w>  </span><span class=nt>networkInterfaces</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>securityGroupIDs</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>sg-1234567890</span><span class=w>
</span><span class=w>    </span><span class=nt>subnetID</span><span class=p>:</span><span class=w> </span><span class=l>subnet-0123a</span><span class=w>
</span><span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z2-5z6as</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>kubernetes.io/cluster/shoot--foo--bar</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>kubernetes.io/role/node</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>machine.sapcloud.io/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>MachineDeployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z1</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z1</span><span class=w>
</span><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w>
</span><span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z1</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>class</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>AWSMachineClass</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z2-5z6as</span><span class=w>
</span></code></pre></div><p>for the second availability zone <code>eu-west-1c</code>.</p><p>Another convention is the 5-letter hash at the end of the machine class names.
Most controllers compute a checksum out of the specification of the machine class.
This helps to trigger a rolling update of the worker nodes if, for example, the machine image version changes.
In this case, a new checksum will be generated which results in the creation of a new machine class.
The <code>MachineDeployment</code>&rsquo;s machine class reference (<code>.spec.template.spec.class.name</code>) is updated which triggers the rolling update process in the machine-controller-manager.
However, all of this is only a convention that eases writing the controller, but you can do it completely differently if you desire - as long as you make sure that the described behaviours are implemented correctly.</p><p>After the machine classes and machine deployments have been created the machine-controller-manager will start talking to the provider&rsquo;s IaaS API and create the virtual machines.
Gardener makes sure that the content of the <code>userData</code> field that is used to bootstrap the machines contain the required configuration for installation of the kubelet and registering the VM as worker node in the shoot cluster.
The <code>Worker</code> extension controller shall wait until all the created <code>MachineDeployment</code>s indicate healthiness/readiness before it ends the control loop.</p><h2 id=does-gardener-need-some-information-that-must-be-returned-back>Does Gardener need some information that must be returned back?</h2><p>Another important benefit of the machine-controller-manager&rsquo;s design principles (extending the Kubernetes API using CRDs) is that the <a href=https://github.com/gardener/autoscaler>cluster-autoscaler</a> can be used <strong>without</strong> any provider-specific implementation.
We have forked the <a href=https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler>upstream Kubernetes community&rsquo;s cluster-autoscaler</a> and extended it so that it understands the machine API.
Definitely, we will merge it back into the community&rsquo;s versions once it has been adapted properly.</p><p>Our cluster-autoscaler only needs to know the minimum and maximum number of replicas <strong>per</strong> <code>MachineDeployment</code> and is ready to act without that it needs to talk to the provider APIs (it just modifies the <code>.spec.replicas</code> field in the <code>MachineDeployment</code> object).
Gardener deploys this autoscaler if there is at least one worker pool that specifies <code>max>min</code>.
In order to know how it needs to configure it, the provider-specific <code>Worker</code> extension controller must expose which <code>MachineDeployment</code>s it had created and how the <code>min</code>/<code>max</code> numbers should look like.</p><p>Consequently, your controller should write this information into the <code>Worker</code> resource&rsquo;s <code>.status.machineDeployments</code> field:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Worker</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>worker</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=l>...</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>lastOperation</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>machineDeployments</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z1</span><span class=w>
</span><span class=w>    </span><span class=nt>minimum</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span><span class=w>    </span><span class=nt>maximum</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar-cpu-worker-z2</span><span class=w>
</span><span class=w>    </span><span class=nt>minimum</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>    </span><span class=nt>maximum</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></code></pre></div><p>In order to support a new worker provider you need to write a controller that watches all <code>Worker</code>s with <code>.spec.type=&lt;my-provider-name></code>.
You can take a look at the below referenced example implementation for the AWS provider.</p><h2 id=that-sounds-like-a-lot-that-needs-to-be-done-can-you-help-me>That sounds like a lot that needs to be done, can you help me?</h2><p>All of the described behaviour is mostly the same for every provider.
The only difference is maybe the version/configuration of the machine-controller-manager, and the machine class specification itself.
You can take a look at our <a href=https://github.com/gardener/gardener/blob/master/extensions>extension library</a>, especially the <a href=https://github.com/gardener/gardener/tree/master/extensions/pkg/controller/worker>worker controller</a> part where you will find a lot of utilities that you can use.
Also, using the library you only need to implement your provider specifics - all the things that can be handled generically can be taken for free and do not need to be re-implemented.
Take a look at the <a href=https://github.com/gardener/gardener-extension-provider-aws/tree/master/pkg/controller/worker>AWS worker controller</a> for finding an example.</p><h2 id=non-provider-specific-information-required-for-worker-creation>Non-provider specific information required for worker creation</h2><p>All the providers require further information that is not provider specific but already part of the shoot resource.
One example for such information is whether the shoot is hibernated or not.
In this case all the virtual machines should be deleted/terminated, and after that the machine controller-manager should be scaled down.
You can take a look at the <a href=https://github.com/gardener/gardener-extension-provider-aws/tree/master/pkg/controller/worker>AWS worker controller</a> to see how it reads this information and how it is used.
As Gardener cannot know which information is required by providers it simply mirrors the <code>Shoot</code>, <code>Seed</code>, and <code>CloudProfile</code> resources into the seed.
They are part of the <a href=/docs/concepts/extensions/cluster><code>Cluster</code> extension resource</a> and can be used to extract information that is not part of the <code>Worker</code> resource itself.</p><h2 id=references-and-additional-resources>References and additional resources</h2><ul><li><a href=https://github.com/gardener/gardener/blob/master/pkg/apis/extensions/v1alpha1/types_worker.go><code>Worker</code> API (Golang specification)</a></li><li><a href=https://github.com/gardener/gardener/blob/master/extensions>Extension controller library</a></li><li><a href=https://github.com/gardener/gardener/tree/master/extensions/pkg/controller/worker>Generic worker controller</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-aws/tree/master/pkg/controller/worker>Exemplary implementation for the AWS provider</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b83662125f90777ebc7486280894ea19>1.5 - Networking</h1></div><div class=td-content><h1 id=pg-7e615789abb58d1abc071ab003dbdf4d>1.5.1 - DNS Management</h1><h1 id=external-dns-management>External DNS Management</h1><p>The main artefact of this project is the <b>DNS controller manager</b> for managing DNS records, also
nicknamed as the Gardener &ldquo;DNS Controller&rdquo;.</p><p>It contains provisioning controllers for creating DNS records in one of the DNS cloud services</p><ul><li><a href=https://github.com/gardener/external-dns-management/blob/master/docs/aws-route53/README.md><em>Amazon Route53</em></a>,</li><li><a href=https://github.com/gardener/external-dns-management/blob/master/docs/google-cloud-dns/README.md><em>Google CloudDNS</em></a>,</li><li><a href=https://github.com/gardener/external-dns-management/blob/master/docs/alicloud-dns/README.md><em>AliCloud DNS</em></a>,</li><li><a href=https://github.com/gardener/external-dns-management/blob/master/docs/azure-dns/README.md><em>Azure DNS</em></a>,</li><li><a href=https://github.com/gardener/external-dns-management/blob/master/docs/openstack-designate/README.md><em>OpenStack Designate</em></a>,</li><li><a href=https://github.com/gardener/external-dns-management/blob/master/docs/cloudflare/README.md><em>Cloudflare DNS</em></a>,</li><li><a href=https://github.com/gardener/external-dns-management/blob/master/docs/infoblox/README.md><em>Infoblox</em></a>,</li><li><a href=https://github.com/gardener/external-dns-management/blob/master/docs/netlify/README.md><em>Netlify DNS</em></a>,</li></ul><p>and source controllers for services and ingresses to create DNS entries by annotations.</p><p>The configuration for the external DNS service is specified in a custom resource <code>DNSProvider</code>.
Multiple <code>DNSProvider</code> can be used simultaneously and changed without restarting the DNS controller.</p><p>DNS records are either created directly for a corresponding custom resource <code>DNSEntry</code> or by
annotating a service or ingress.</p><p>For a detailed explanation of the model, see section <a href=#the-model>The Model</a>.</p><p>For extending or adapting this project with your own source or provisioning controllers, see section
<a href=#extensions>Extensions</a></p><h2 id=quick-start>Quick start</h2><p>To install the <b>DNS controller manager</b> in your Kubernetes cluster, follow these steps.</p><ol><li><p>Prerequisites</p><ul><li><p>Check out or download the project to get a copy of the Helm charts.
It is recommended to check out the tag of the
<a href=https://github.com/gardener/external-dns-management/releases>last release</a>, so that Helm
values reference the newest released container image for the deployment.</p></li><li><p>Make sure, that you have installed Helm client (<code>helm</code>) locally and Helm server (<code>tiller</code>) on
the Kubernetes cluster. See e.g. <a href=https://helm.sh/docs/install/>Helm installation</a> for more details.</p></li></ul></li><li><p>Install the DNS controller manager</p><p>As multiple Gardener DNS controllers can act on the same DNS Hosted Zone concurrently, each instance needs
an <a href=#owner-identifiers>owner identifier</a>. Therefore choose an identifier sufficiently unique across these instances.</p><p>Then install the DNS controller manager with</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>helm install charts/external-dns-management --name dns-controller --namespace<span class=o>=</span>&lt;my-namespace&gt; --set configuration.identifier<span class=o>=</span>&lt;my-identifier&gt;
</code></pre></div><p>This will use the default configuration with all source and provisioning controllers enabled.
The complete set of configuration variables can be found in <code>charts/external-dns-management/values.yaml</code>.
Their meaning is explained by their corresponding command line options in section
<a href=#using-the-dns-controller-manager>Using the DNS controller manager</a></p><p>By default, the DNS controller looks for custom resources in all namespaces. The choosen namespace is
only relevant for the deployment itself.</p></li><li><p>Create a <code>DNSProvider</code></p><p>To specify a DNS provider, you need to create a custom resource <code>DNSProvider</code> and a secret containing the
credentials for your account at the provider. E.g. if you want to use AWS Route53, create a secret and
provider with</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>cat <span class=s>&lt;&lt; EOF | kubectl apply -f -
</span><span class=s>apiVersion: v1
</span><span class=s>kind: Secret
</span><span class=s>metadata:
</span><span class=s>  name: aws-credentials
</span><span class=s>  namespace: default
</span><span class=s>type: Opaque
</span><span class=s>data:
</span><span class=s>  # replace &#39;...&#39; with values encoded as base64
</span><span class=s>  # see https://docs.aws.amazon.com/general/latest/gr/managing-aws-access-keys.html
</span><span class=s>  AWS_ACCESS_KEY_ID: ...
</span><span class=s>  AWS_SECRET_ACCESS_KEY: ...
</span><span class=s>  # or if the chain of credential providers should be used:
</span><span class=s>  #AWS_USE_CREDENTIALS_CHAIN: dHJ1ZQ==
</span><span class=s>EOF</span>
</code></pre></div><p>and</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>cat <span class=s>&lt;&lt; EOF | kubectl apply -f -
</span><span class=s>apiVersion: dns.gardener.cloud/v1alpha1
</span><span class=s>kind: DNSProvider
</span><span class=s>metadata:
</span><span class=s>  name: aws
</span><span class=s>  namespace: default
</span><span class=s>spec:
</span><span class=s>  type: aws-route53
</span><span class=s>  secretRef:
</span><span class=s>    name: aws-credentials
</span><span class=s>  domains:
</span><span class=s>    include:
</span><span class=s>    # this must be replaced with a (sub)domain of the hosted zone
</span><span class=s>    - my.own.domain.com
</span><span class=s>EOF</span>
</code></pre></div><p>Check the successful creation with</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl get dnspr
</code></pre></div><p>You should see something like</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>NAME   TYPE          STATUS   AGE
aws    aws-route53   Ready    12s
</code></pre></div></li><li><p>Create a <code>DNSEntry</code></p><p>Create an DNS entry with</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>cat <span class=s>&lt;&lt; EOF | kubectl apply -f -
</span><span class=s>apiVersion: dns.gardener.cloud/v1alpha1
</span><span class=s>kind: DNSEntry
</span><span class=s>metadata:
</span><span class=s>  name: mydnsentry
</span><span class=s>  namespace: default
</span><span class=s>spec:
</span><span class=s>  dnsName: &#34;myentry.my-own-domain.com&#34;
</span><span class=s>  ttl: 600
</span><span class=s>  targets:
</span><span class=s>  - 1.2.3.4
</span><span class=s>EOF</span>
</code></pre></div><p>Check the status of the DNS entry with</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl get dnsentry
</code></pre></div><p>You should see something like</p><div class=highlight><pre class=chroma><code class=language-txt data-lang=txt>NAME          DNS                           TYPE          PROVIDER      STATUS    AGE
mydnsentry    myentry.my-own-domain.com     aws-route53   default/aws   Ready     24s
</code></pre></div><p>As soon as the status of the entry is <code>Ready</code>, the provider has accepted the new DNS record.
Depending on the provider and your DNS settings and cache, it may take up to a few minutes before
the domain name can be resolved.</p></li><li><p>Wait for/check DNS record</p><p>To check the DNS resolution, use <code>nslookup</code> or <code>dig</code>.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>nslookup myentry.my-own-domain.com
</code></pre></div><p>or with dig</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># or with dig</span>
dig +short myentry.my-own-domain.com
</code></pre></div><p>Depending on your network settings, you may get a successful response faster using a public DNS server
(e.g. 8.8.8.8, 8.8.4.4, or 1.1.1.1)</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>dig @8.8.8.8 +short myentry.my-own-domain.com
</code></pre></div></li></ol><p>For more examples about the custom resources and the annotations for services and ingresses
see the <code>examples</code> directory.</p><h3 id=automatic-creation-of-dns-entries-for-services-and-ingresses>Automatic creation of DNS entries for services and ingresses</h3><p>Using the source controllers, it is also possible to create DNS entries for services (of type <code>LoadBalancer</code>)
and ingresses automatically. The resources only need to be annotated with some special values.
In this case ensure that the source controllers are enabled on startup of the DNS controller manager, i.e. the
value of the command line option <code>--controllers</code> must contain <code>dnscontrollers</code> or equal to <code>all</code>.
The DNS source controllers watch resources on the default cluster and create DNS entries on
the target cluster. As there can be multiple controllers active on the same cluster, you may
need to set the correct <code>DNSClass</code> both for the controller and for the source resource by
setting the annotation <code>dns.gardener.cloud/class</code>. The default value for the <code>DNSClass</code> is <code>gardendns</code>.</p><p>Note that if you delegate the DNS management for shoot resources to Gardener via the
<a href=https://github.com/gardener/gardener-extension-shoot-dns-service>shoot-dns-service extension</a>,
the correct annotation is <code>dns.gardener.cloud/class=garden</code>.</p><p>Here is an example for annotating a service (same as <code>examples/50-service-with-dns.yaml</code>)]:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/dnsnames</span><span class=p>:</span><span class=w> </span><span class=l>echo.my-dns-domain.com</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/ttl</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500&#34;</span><span class=w>
</span><span class=w>    </span><span class=c># If you are delegating the DNS Management to Gardener, uncomment the following line (see https://gardener.cloud/documentation/guides/administer_shoots/dns_names/)</span><span class=w>
</span><span class=w>    </span><span class=c>#`dns.gardener.cloud/class`: garden</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-service</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span><span class=w>  </span><span class=nt>sessionAffinity</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></code></pre></div><h2 id=the-model>The Model</h2><p>This project provides a flexible model allowing to
add DNS source objects and DNS provisioning environments by adding
new independent controllers.</p><p>There is no single DNS controller anymore. The decoupling between the
handling of DNS source objects, like ingresses or services, and the
provisioning of DNS entries in an external DNS provider like
<em>Route53</em> or <em>CloudDNS</em> is achieved by introducing a new custom resource
<code>DNSEntry</code>.</p><p>These objects can either be explicitly created to request dedicated DNS
entries, or they are managed based on other resources like ingresses or
services. For the latter dedicated <em>DNS Source Controllers</em> are used.
There might be any number of such source controllers. They do not need to know
anything about the various DNS environments. Their task is to figure out which
DNS entries are required in their realm and manage appropriate <code>DNSEntry</code>
objects. From these objects they can also read the provisioning status and
report it back to the original source.</p><p><img src=/__resources/model_942b49.png alt="Model Overview"></p><p>Provisioning of DNS entries in external DNS providers is done by
<em>DNS Provisioning Controllers</em>. They don&rsquo;t need to know anything about the
various DNS source objects. They watch <code>DNSEntry</code> objects and check whether
they are responsible for such an object. If a provisioning controller feels
responsible for an entry it manages the corresponding settings in the
external DNS environment and reports the provisioning status back to the
corresponding <code>DNSEntry</code> object.</p><p>To do this a provisioning controller is responsible for a dedicated
environment (for example Route53). For every such environment the controller
uses a dedicated <em>type</em> key. This key is used to look for <code>DNSProvider</code> objects.
There might be multiple such objects per environment, specifying the
credentials needed to access different external accounts. These accounts are then
scanned for DNS zones and domain names they support.
This information is then used to dynamically assign <code>DNSEntry</code> objects to
dedicated <code>DNSProvider</code> objects. If such an assignment can be done by
a provisioning controller then it is <em>responsible</em> for this entry and manages
the corresponding entries in the external environment.
<code>DNSProvider</code> objects can specify explicit inclusion and exclusion sets of domain names
and/or DNS zone identifiers to override the scanning results of the account.</p><h3 id=owner-identifiers>Owner Identifiers</h3><p>Every DNS Provisioning Controller is responsible for a set of <em>Owner Identifiers</em>.
DNS records in an external DNS environment are attached to such an identifier.
This is used to identify the records in the DNS environment managed by a dedicated
controller (manager). Every controller manager hosting DNS Provisioning Controllers
offers an option to specify a default identifier. Additionally there might
be dedicated <code>DNSOwner</code> objects that enable or disable additional owner ids.</p><p>Every <code>DNSEntry</code> object may specify a dedicated owner that is used to tag
the records in the DNS environment. A DNS provisioning controller only acts
of DNS entries it is responsible for. Other resources in the external DNS
environment are not touched at all.</p><p>This way it is possbible to</p><ul><li>identify records in the external DNS management environment that are managed
by the actual controller instance</li><li>distinguish different DNS source environments sharing the same hosted zones
in the external management environment</li><li>cleanup unused entries, even if the whole resource set is already
gone</li><li>move the responsibility for dedicated sets of DNS entries among different
kubernetes clusters or DNS source environments running different
DNS Provisioning Controller without loosing the entries during the
migration process.</li></ul><p><strong>If multiple DNS controller instances have access to the same DNS zones, it is very important, that every instance uses a unique owner identifier! Otherwise the cleanup of stale DNS record will delete entries created by another instance if they use the same identifier.</strong></p><h3 id=dns-classes>DNS Classes</h3><p>Multiple sets of controllers of the DNS ecosystem can run in parallel in
a kubernetes cluster working on different object set. They are separated by
using different <em>DNS Classes</em>. Adding a DNS class annotation to an object of the
DNS ecosytems assigns this object to such a dedicated set of DNS controllers.
This way it is possible to maintain clearly separated set of DNS objects in a
single kubernetes cluster.</p><h3 id=dnsannotation-objects>DNSAnnotation objects</h3><p>DNS source controllers support the creation of DNS entries for potentiialy
any kind of resource originally not equipped to describe the generation of
DNS entries. This is done by additionally annotations. Nevertheless it
might be the case, that those objects are again the result of a generation
process, ether by predefined helm starts or by other higher level controllers.
It is not necessarily possible to influence those generation steps to
additionally generate the deired DNS annotations.</p><p>The typical mechanis in Kubernetes to handle this is to provide mutating
webhooks that enrich the generated objects accordingly. But this mechanism
is basically not intended to support dedicated settings for dedicated instances.
At least it is very strenous to provide web hooks for every such usecase.</p><p>Therefore the DNS ecosystem provided by this project supports an additional
extension mechanism to annotate any kind of object with additional annotations
by supported a dedicated resource, the <code>DNSAnnotation</code>.</p><p>The handling of this resource is done by a dedicated controller, the <code>annotation</code>
controller. It caches the annotation settings declared by those objects and
makes them accessible for the DNS source controllers.</p><p>The DNS source controller responsible for a dedicated kind of resource
(for example Service reads the object analyses the annotations and then decides
what to do with it. Most of the flow is handled by a central library, only
some dedicated resource dependent steps are implemented separately by a
dedicated source controller. The <code>DNSAnnotation</code>resource slightly extends this
flow: After reading the object the library additionally checks for the existence
of a <code>DNSAnnotation</code> setting for this object by querying the <code>annotation</code>
controller&rsquo;s cache. If found, it adds annotations declared there to the original
object prior to the next processing steps.
This way, for example whenver a <code>Service</code> without
any DNS related annotation is handled by the controller and it finds a matching
<code>DNSAnnotation</code> setting, the set of actual annotations is enriched accordingly
before the actual processing of the service object is done by the controller.</p><p>This <code>DNSAnnotation</code> object can be created before or even after the object to
be annotated and will implicity cause a reprocessing of the original object by
its DNS source controller.</p><p>For example, the following object enforces a DNS related annotation for the
processing of the service object <code>testapp/default</code> by the service DNS source
controller:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>dns.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DNSAnnotation</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>testapp</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>resourceRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>testapp</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/dnsnames</span><span class=p>:</span><span class=w> </span><span class=l>testapp.dns.gardener.cloud</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/ttl</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500&#34;</span><span class=w>
</span></code></pre></div><h2 id=using-the-dns-controller-manager>Using the DNS controller manager</h2><p>The controllers to run can be selected with the <code>--controllers</code> option.
Here the following controller groups can be used:</p><ul><li><p><code>dnssources</code>: all DNS Source Controllers. It includes the conrollers</p><ul><li><code>ingress-dns</code>: handle DNS annotations for the standard kubernetes ingress resource</li><li><code>service-dns</code>: handle DNS annotations for the standard kubernetes service resource</li></ul></li><li><p><code>dnscontrollers</code>: all DNS Provisioning Controllers. It includes the controllers</p><ul><li><code>compound</code>: common DNS provisioning controller</li></ul></li><li><p><code>all</code>: (default) all controllers</p></li></ul><p>It is also possible to list dedicated controllers by their name.</p><p>To restrict the compound DNS provisioning controller to specific provider types,
use the <code>--provider-types</code> option.</p><p>The following provider types can be selected (comma separated):</p><ul><li><code>alicloud-dns</code>: Alicloud DNS provider</li><li><code>aws-route53</code>: AWS Route 53 provider</li><li><code>azure-dns</code>: Azure DNS provider</li><li><code>google-clouddns</code>: Google CloudDNS provider</li><li><code>openstack-designate</code>: Openstack Designate provider</li><li><code>cloudflare-dns</code>: Cloudflare DNS provider</li><li><code>infoblox-dns</code>: Infoblox DNS provider</li><li><code>netlify-dns</code>: Netlify DNS provider</li></ul><p>If the compound DNS Provisioning Controller is enabled it is important to specify a
unique controller identity using the <code>--identifier</code> option.
This identifier is stored in the DNS system to identify the DNS entries
managed by a dedicated controller. There should never be two
DNS controllers with the same identifier running at the same time for the
same DNS domains/accounts.</p><p>Here is the complete list of options provided:</p><div class=highlight><pre class=chroma><code class=language-txt data-lang=txt>Usage:
  dns-controller-manager [flags]

Flags:
      --accepted-maintainers string                                   accepted maintainer key(s) for crds
      --advanced.batch-size int                                       batch size for change requests (currently only used for aws-route53)
      --advanced.max-retries int                                      maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53)
      --alicloud-dns.advanced.batch-size int                          batch size for change requests (currently only used for aws-route53)
      --alicloud-dns.advanced.max-retries int                         maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53)
      --alicloud-dns.ratelimiter.burst int                            number of burst requests for rate limiter
      --alicloud-dns.ratelimiter.enabled                              enables rate limiter for DNS provider requests
      --alicloud-dns.ratelimiter.qps int                              maximum requests/queries per second
      --annotation.default.pool.size int                              Worker pool size for pool default of controller annotation
      --annotation.pool.size int                                      Worker pool size of controller annotation
      --annotation.setup int                                          number of processors for controller setup of controller annotation
      --aws-route53.advanced.batch-size int                           batch size for change requests (currently only used for aws-route53)
      --aws-route53.advanced.max-retries int                          maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53)
      --aws-route53.ratelimiter.burst int                             number of burst requests for rate limiter
      --aws-route53.ratelimiter.enabled                               enables rate limiter for DNS provider requests
      --aws-route53.ratelimiter.qps int                               maximum requests/queries per second
      --azure-dns.advanced.batch-size int                             batch size for change requests (currently only used for aws-route53)
      --azure-dns.advanced.max-retries int                            maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53)
      --azure-dns.ratelimiter.burst int                               number of burst requests for rate limiter
      --azure-dns.ratelimiter.enabled                                 enables rate limiter for DNS provider requests
      --azure-dns.ratelimiter.qps int                                 maximum requests/queries per second
      --bind-address-http string                                      HTTP server bind address
      --cache-dir string                                              Directory to store zone caches (for reload after restart)
      --cache-ttl int                                                 Time-to-live for provider hosted zone cache
      --cloudflare-dns.advanced.batch-size int                        batch size for change requests (currently only used for aws-route53)
      --cloudflare-dns.advanced.max-retries int                       maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53)
      --cloudflare-dns.ratelimiter.burst int                          number of burst requests for rate limiter
      --cloudflare-dns.ratelimiter.enabled                            enables rate limiter for DNS provider requests
      --cloudflare-dns.ratelimiter.qps int                            maximum requests/queries per second
      --compound.advanced.batch-size int                              batch size for change requests (currently only used for aws-route53) of controller compound
      --compound.advanced.max-retries int                             maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53) of controller compound
      --compound.alicloud-dns.advanced.batch-size int                 batch size for change requests (currently only used for aws-route53) of controller compound
      --compound.alicloud-dns.advanced.max-retries int                maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53) of controller compound
      --compound.alicloud-dns.ratelimiter.burst int                   number of burst requests for rate limiter of controller compound
      --compound.alicloud-dns.ratelimiter.enabled                     enables rate limiter for DNS provider requests of controller compound
      --compound.alicloud-dns.ratelimiter.qps int                     maximum requests/queries per second of controller compound
      --compound.aws-route53.advanced.batch-size int                  batch size for change requests (currently only used for aws-route53) of controller compound
      --compound.aws-route53.advanced.max-retries int                 maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53) of controller compound
      --compound.aws-route53.ratelimiter.burst int                    number of burst requests for rate limiter of controller compound
      --compound.aws-route53.ratelimiter.enabled                      enables rate limiter for DNS provider requests of controller compound
      --compound.aws-route53.ratelimiter.qps int                      maximum requests/queries per second of controller compound
      --compound.azure-dns.advanced.batch-size int                    batch size for change requests (currently only used for aws-route53) of controller compound
      --compound.azure-dns.advanced.max-retries int                   maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53) of controller compound
      --compound.azure-dns.ratelimiter.burst int                      number of burst requests for rate limiter of controller compound
      --compound.azure-dns.ratelimiter.enabled                        enables rate limiter for DNS provider requests of controller compound
      --compound.azure-dns.ratelimiter.qps int                        maximum requests/queries per second of controller compound
      --compound.cache-dir string                                     Directory to store zone caches (for reload after restart) of controller compound
      --compound.cache-ttl int                                        Time-to-live for provider hosted zone cache of controller compound
      --compound.cloudflare-dns.advanced.batch-size int               batch size for change requests (currently only used for aws-route53) of controller compound
      --compound.cloudflare-dns.advanced.max-retries int              maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53) of controller compound
      --compound.cloudflare-dns.ratelimiter.burst int                 number of burst requests for rate limiter of controller compound
      --compound.cloudflare-dns.ratelimiter.enabled                   enables rate limiter for DNS provider requests of controller compound
      --compound.cloudflare-dns.ratelimiter.qps int                   maximum requests/queries per second of controller compound
      --compound.default.pool.size int                                Worker pool size for pool default of controller compound
      --compound.disable-zone-state-caching                           disable use of cached dns zone state on changes of controller compound
      --compound.dns-class string                                     Class identifier used to differentiate responsible controllers for entry resources of controller compound
      --compound.dns-delay duration                                   delay between two dns reconciliations of controller compound
      --compound.dns.pool.resync-period duration                      Period for resynchronization for pool dns of controller compound
      --compound.dns.pool.size int                                    Worker pool size for pool dns of controller compound
      --compound.dry-run                                              just check, don&#39;t modify of controller compound
      --compound.google-clouddns.advanced.batch-size int              batch size for change requests (currently only used for aws-route53) of controller compound
      --compound.google-clouddns.advanced.max-retries int             maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53) of controller compound
      --compound.google-clouddns.ratelimiter.burst int                number of burst requests for rate limiter of controller compound
      --compound.google-clouddns.ratelimiter.enabled                  enables rate limiter for DNS provider requests of controller compound
      --compound.google-clouddns.ratelimiter.qps int                  maximum requests/queries per second of controller compound
      --compound.identifier string                                    Identifier used to mark DNS entries in DNS system of controller compound
      --compound.infoblox-dns.advanced.batch-size int                 batch size for change requests (currently only used for aws-route53) of controller compound
      --compound.infoblox-dns.advanced.max-retries int                maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53) of controller compound
      --compound.infoblox-dns.ratelimiter.burst int                   number of burst requests for rate limiter of controller compound
      --compound.infoblox-dns.ratelimiter.enabled                     enables rate limiter for DNS provider requests of controller compound
      --compound.infoblox-dns.ratelimiter.qps int                     maximum requests/queries per second of controller compound
      --compound.netlify-dns.advanced.batch-size int                  batch size for change requests (currently only used for aws-route53) of controller compound
      --compound.netlify-dns.advanced.max-retries int                 maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53) of controller compound
      --compound.netlify-dns.ratelimiter.burst int                    number of burst requests for rate limiter of controller compound
      --compound.netlify-dns.ratelimiter.enabled                      enables rate limiter for DNS provider requests of controller compound
      --compound.netlify-dns.ratelimiter.qps int                      maximum requests/queries per second of controller compound
      --compound.openstack-designate.advanced.batch-size int          batch size for change requests (currently only used for aws-route53) of controller compound
      --compound.openstack-designate.advanced.max-retries int         maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53) of controller compound
      --compound.openstack-designate.ratelimiter.burst int            number of burst requests for rate limiter of controller compound
      --compound.openstack-designate.ratelimiter.enabled              enables rate limiter for DNS provider requests of controller compound
      --compound.openstack-designate.ratelimiter.qps int              maximum requests/queries per second of controller compound
      --compound.ownerids.pool.size int                               Worker pool size for pool ownerids of controller compound
      --compound.pool.resync-period duration                          Period for resynchronization of controller compound
      --compound.pool.size int                                        Worker pool size of controller compound
      --compound.provider-types string                                comma separated list of provider types to enable of controller compound
      --compound.providers.pool.resync-period duration                Period for resynchronization for pool providers of controller compound
      --compound.providers.pool.size int                              Worker pool size for pool providers of controller compound
      --compound.ratelimiter.burst int                                number of burst requests for rate limiter of controller compound
      --compound.ratelimiter.enabled                                  enables rate limiter for DNS provider requests of controller compound
      --compound.ratelimiter.qps int                                  maximum requests/queries per second of controller compound
      --compound.reschedule-delay duration                            reschedule delay after losing provider of controller compound
      --compound.secrets.pool.size int                                Worker pool size for pool secrets of controller compound
      --compound.setup int                                            number of processors for controller setup of controller compound
      --compound.statistic.pool.size int                              Worker pool size for pool statistic of controller compound
      --compound.ttl int                                              Default time-to-live for DNS entries. Defines how long the record is kept in cache by DNS servers or resolvers. of controller compound
      --compound.zonepolicies.pool.size int                           Worker pool size for pool zonepolicies of controller compound
      --config string                                                 config file
  -c, --controllers string                                            comma separated list of controllers to start (&lt;name&gt;,&lt;group&gt;,all)
      --cpuprofile string                                             set file for cpu profiling
      --default.pool.resync-period duration                           Period for resynchronization for pool default
      --default.pool.size int                                         Worker pool size for pool default
      --disable-namespace-restriction                                 disable access restriction for namespace local access only
      --disable-zone-state-caching                                    disable use of cached dns zone state on changes
      --dns-class string                                              identifier used to differentiate responsible controllers for entries, Class identifier used to differentiate responsible controllers for entry resources, identifier used to differentiate responsible controllers for providers
      --dns-delay duration                                            delay between two dns reconciliations
      --dns-target-class string                                       identifier used to differentiate responsible dns controllers for target entries, identifier used to differentiate responsible dns controllers for target providers
      --dns.pool.resync-period duration                               Period for resynchronization for pool dns
      --dns.pool.size int                                             Worker pool size for pool dns
      --dnsentry-source.default.pool.resync-period duration           Period for resynchronization for pool default of controller dnsentry-source
      --dnsentry-source.default.pool.size int                         Worker pool size for pool default of controller dnsentry-source
      --dnsentry-source.dns-class string                              identifier used to differentiate responsible controllers for entries of controller dnsentry-source
      --dnsentry-source.dns-target-class string                       identifier used to differentiate responsible dns controllers for target entries of controller dnsentry-source
      --dnsentry-source.exclude-domains stringArray                   excluded domains of controller dnsentry-source
      --dnsentry-source.key string                                    selecting key for annotation of controller dnsentry-source
      --dnsentry-source.pool.resync-period duration                   Period for resynchronization of controller dnsentry-source
      --dnsentry-source.pool.size int                                 Worker pool size of controller dnsentry-source
      --dnsentry-source.target-creator-label-name string              label name to store the creator for generated DNS entries of controller dnsentry-source
      --dnsentry-source.target-creator-label-value string             label value for creator label of controller dnsentry-source
      --dnsentry-source.target-name-prefix string                     name prefix in target namespace for cross cluster generation of controller dnsentry-source
      --dnsentry-source.target-namespace string                       target namespace for cross cluster generation of controller dnsentry-source
      --dnsentry-source.target-owner-id string                        owner id to use for generated DNS entries of controller dnsentry-source
      --dnsentry-source.target-realms string                          realm(s) to use for generated DNS entries of controller dnsentry-source
      --dnsentry-source.target-set-ignore-owners                      mark generated DNS entries to omit owner based access control of controller dnsentry-source
      --dnsentry-source.targets.pool.size int                         Worker pool size for pool targets of controller dnsentry-source
      --dnsprovider-replication.default.pool.resync-period duration   Period for resynchronization for pool default of controller dnsprovider-replication
      --dnsprovider-replication.default.pool.size int                 Worker pool size for pool default of controller dnsprovider-replication
      --dnsprovider-replication.dns-class string                      identifier used to differentiate responsible controllers for providers of controller dnsprovider-replication
      --dnsprovider-replication.dns-target-class string               identifier used to differentiate responsible dns controllers for target providers of controller dnsprovider-replication
      --dnsprovider-replication.pool.resync-period duration           Period for resynchronization of controller dnsprovider-replication
      --dnsprovider-replication.pool.size int                         Worker pool size of controller dnsprovider-replication
      --dnsprovider-replication.target-creator-label-name string      label name to store the creator for replicated DNS providers of controller dnsprovider-replication
      --dnsprovider-replication.target-creator-label-value string     label value for creator label of controller dnsprovider-replication
      --dnsprovider-replication.target-name-prefix string             name prefix in target namespace for cross cluster replication of controller dnsprovider-replication
      --dnsprovider-replication.target-namespace string               target namespace for cross cluster generation of controller dnsprovider-replication
      --dnsprovider-replication.target-realms string                  realm(s) to use for replicated DNS provider of controller dnsprovider-replication
      --dnsprovider-replication.targets.pool.size int                 Worker pool size for pool targets of controller dnsprovider-replication
      --dry-run                                                       just check, don&#39;t modify
      --exclude-domains stringArray                                   excluded domains
      --force-crd-update                                              enforce update of crds even they are unmanaged
      --google-clouddns.advanced.batch-size int                       batch size for change requests (currently only used for aws-route53)
      --google-clouddns.advanced.max-retries int                      maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53)
      --google-clouddns.ratelimiter.burst int                         number of burst requests for rate limiter
      --google-clouddns.ratelimiter.enabled                           enables rate limiter for DNS provider requests
      --google-clouddns.ratelimiter.qps int                           maximum requests/queries per second
      --grace-period duration                                         inactivity grace period for detecting end of cleanup for shutdown
  -h, --help                                                          help for dns-controller-manager
      --identifier string                                             Identifier used to mark DNS entries in DNS system
      --infoblox-dns.advanced.batch-size int                          batch size for change requests (currently only used for aws-route53)
      --infoblox-dns.advanced.max-retries int                         maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53)
      --infoblox-dns.ratelimiter.burst int                            number of burst requests for rate limiter
      --infoblox-dns.ratelimiter.enabled                              enables rate limiter for DNS provider requests
      --infoblox-dns.ratelimiter.qps int                              maximum requests/queries per second
      --ingress-dns.default.pool.resync-period duration               Period for resynchronization for pool default of controller ingress-dns
      --ingress-dns.default.pool.size int                             Worker pool size for pool default of controller ingress-dns
      --ingress-dns.dns-class string                                  identifier used to differentiate responsible controllers for entries of controller ingress-dns
      --ingress-dns.dns-target-class string                           identifier used to differentiate responsible dns controllers for target entries of controller ingress-dns
      --ingress-dns.exclude-domains stringArray                       excluded domains of controller ingress-dns
      --ingress-dns.key string                                        selecting key for annotation of controller ingress-dns
      --ingress-dns.pool.resync-period duration                       Period for resynchronization of controller ingress-dns
      --ingress-dns.pool.size int                                     Worker pool size of controller ingress-dns
      --ingress-dns.target-creator-label-name string                  label name to store the creator for generated DNS entries of controller ingress-dns
      --ingress-dns.target-creator-label-value string                 label value for creator label of controller ingress-dns
      --ingress-dns.target-name-prefix string                         name prefix in target namespace for cross cluster generation of controller ingress-dns
      --ingress-dns.target-namespace string                           target namespace for cross cluster generation of controller ingress-dns
      --ingress-dns.target-owner-id string                            owner id to use for generated DNS entries of controller ingress-dns
      --ingress-dns.target-realms string                              realm(s) to use for generated DNS entries of controller ingress-dns
      --ingress-dns.target-set-ignore-owners                          mark generated DNS entries to omit owner based access control of controller ingress-dns
      --ingress-dns.targets.pool.size int                             Worker pool size for pool targets of controller ingress-dns
      --key string                                                    selecting key for annotation
      --kubeconfig string                                             default cluster access
      --kubeconfig.disable-deploy-crds                                disable deployment of required crds for cluster default
      --kubeconfig.id string                                          id for cluster default
      --kubeconfig.migration-ids string                               migration id for cluster default
      --lease-duration duration                                       lease duration
      --lease-name string                                             name for lease object
      --lease-renew-deadline duration                                 lease renew deadline
      --lease-resource-lock string                                    determines which resource lock to use for leader election, defaults to &#39;configmapsleases&#39;
      --lease-retry-period duration                                   lease retry period
  -D, --log-level string                                              logrus log level
      --maintainer string                                             maintainer key for crds (default &#34;dns-controller-manager&#34;)
      --name string                                                   name used for controller manager (default &#34;dns-controller-manager&#34;)
      --namespace string                                              namespace for lease (default &#34;kube-system&#34;)
  -n, --namespace-local-access-only                                   enable access restriction for namespace local access only (deprecated)
      --netlify-dns.advanced.batch-size int                           batch size for change requests (currently only used for aws-route53)
      --netlify-dns.advanced.max-retries int                          maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53)
      --netlify-dns.ratelimiter.burst int                             number of burst requests for rate limiter
      --netlify-dns.ratelimiter.enabled                               enables rate limiter for DNS provider requests
      --netlify-dns.ratelimiter.qps int                               maximum requests/queries per second
      --omit-lease                                                    omit lease for development
      --openstack-designate.advanced.batch-size int                   batch size for change requests (currently only used for aws-route53)
      --openstack-designate.advanced.max-retries int                  maximum number of retries to avoid paging stops on throttling (currently only used for aws-route53)
      --openstack-designate.ratelimiter.burst int                     number of burst requests for rate limiter
      --openstack-designate.ratelimiter.enabled                       enables rate limiter for DNS provider requests
      --openstack-designate.ratelimiter.qps int                       maximum requests/queries per second
      --ownerids.pool.size int                                        Worker pool size for pool ownerids
      --plugin-file string                                            directory containing go plugins
      --pool.resync-period duration                                   Period for resynchronization
      --pool.size int                                                 Worker pool size
      --provider-types string                                         comma separated list of provider types to enable
      --providers string                                              cluster to look for provider objects
      --providers.disable-deploy-crds                                 disable deployment of required crds for cluster provider
      --providers.id string                                           id for cluster provider
      --providers.migration-ids string                                migration id for cluster provider
      --providers.pool.resync-period duration                         Period for resynchronization for pool providers
      --providers.pool.size int                                       Worker pool size for pool providers
      --ratelimiter.burst int                                         number of burst requests for rate limiter
      --ratelimiter.enabled                                           enables rate limiter for DNS provider requests
      --ratelimiter.qps int                                           maximum requests/queries per second
      --reschedule-delay duration                                     reschedule delay after losing provider
      --secrets.pool.size int                                         Worker pool size for pool secrets
      --server-port-http int                                          HTTP server port (serving /healthz, /metrics, ...)
      --service-dns.default.pool.resync-period duration               Period for resynchronization for pool default of controller service-dns
      --service-dns.default.pool.size int                             Worker pool size for pool default of controller service-dns
      --service-dns.dns-class string                                  identifier used to differentiate responsible controllers for entries of controller service-dns
      --service-dns.dns-target-class string                           identifier used to differentiate responsible dns controllers for target entries of controller service-dns
      --service-dns.exclude-domains stringArray                       excluded domains of controller service-dns
      --service-dns.key string                                        selecting key for annotation of controller service-dns
      --service-dns.pool.resync-period duration                       Period for resynchronization of controller service-dns
      --service-dns.pool.size int                                     Worker pool size of controller service-dns
      --service-dns.target-creator-label-name string                  label name to store the creator for generated DNS entries of controller service-dns
      --service-dns.target-creator-label-value string                 label value for creator label of controller service-dns
      --service-dns.target-name-prefix string                         name prefix in target namespace for cross cluster generation of controller service-dns
      --service-dns.target-namespace string                           target namespace for cross cluster generation of controller service-dns
      --service-dns.target-owner-id string                            owner id to use for generated DNS entries of controller service-dns
      --service-dns.target-realms string                              realm(s) to use for generated DNS entries of controller service-dns
      --service-dns.target-set-ignore-owners                          mark generated DNS entries to omit owner based access control of controller service-dns
      --service-dns.targets.pool.size int                             Worker pool size for pool targets of controller service-dns
      --setup int                                                     number of processors for controller setup
      --statistic.pool.size int                                       Worker pool size for pool statistic
      --target string                                                 target cluster for dns requests
      --target-creator-label-name string                              label name to store the creator for generated DNS entries, label name to store the creator for replicated DNS providers
      --target-creator-label-value string                             label value for creator label
      --target-name-prefix string                                     name prefix in target namespace for cross cluster generation, name prefix in target namespace for cross cluster replication
      --target-namespace string                                       target namespace for cross cluster generation
      --target-owner-id string                                        owner id to use for generated DNS entries
      --target-realms string                                          realm(s) to use for generated DNS entries, realm(s) to use for replicated DNS provider
      --target-set-ignore-owners                                      mark generated DNS entries to omit owner based access control
      --target.disable-deploy-crds                                    disable deployment of required crds for cluster target
      --target.id string                                              id for cluster target
      --target.migration-ids string                                   migration id for cluster target
      --targets.pool.size int                                         Worker pool size for pool targets
      --ttl int                                                       Default time-to-live for DNS entries. Defines how long the record is kept in cache by DNS servers or resolvers.
  -v, --version                                                       version for dns-controller-manager
      --zonepolicies.pool.size int                                    Worker pool size for pool zonepolicies
</code></pre></div><h2 id=extensions>Extensions</h2><p>This project can also be used as library to implement own source and provisioning controllers.</p><h3 id=how-to-implement-source-controllers>How to implement Source Controllers</h3><p>Based on the provided source controller library a source controller must
implement the <a href=https://github.com/gardener/external-dns-management/blob/master/pkg/dns/source/interface.go><code>source.DNSSource</code> interface</a> and
provide an appropriate creator function.</p><p>A source controller can be implemented following this example:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>service</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;github.com/gardener/controller-manager-library/pkg/resources&#34;</span>
    <span class=s>&#34;github.com/gardener/external-dns-management/pkg/dns/source&#34;</span>
<span class=p>)</span>

<span class=kd>var</span> <span class=nx>_MAIN_RESOURCE</span> <span class=p>=</span> <span class=nx>resources</span><span class=p>.</span><span class=nf>NewGroupKind</span><span class=p>(</span><span class=s>&#34;core&#34;</span><span class=p>,</span> <span class=s>&#34;Service&#34;</span><span class=p>)</span>

<span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>source</span><span class=p>.</span><span class=nf>DNSSourceController</span><span class=p>(</span><span class=nx>source</span><span class=p>.</span><span class=nf>NewDNSSouceTypeForExtractor</span><span class=p>(</span><span class=s>&#34;service-dns&#34;</span><span class=p>,</span> <span class=nx>_MAIN_RESOURCE</span><span class=p>,</span> <span class=nx>GetTargets</span><span class=p>),</span><span class=kc>nil</span><span class=p>).</span>
        <span class=nf>FinalizerDomain</span><span class=p>(</span><span class=s>&#34;dns.gardener.cloud&#34;</span><span class=p>).</span>
        <span class=nf>MustRegister</span><span class=p>(</span><span class=nx>source</span><span class=p>.</span><span class=nx>CONTROLLER_GROUP_DNS_SOURCES</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>Complete examples can be found in the sub packages of <code>pkg/controller/source</code>.</p><h3 id=how-to-implement-provisioning-controllers>How to implement Provisioning Controllers</h3><p>Provisioning controllers can be implemented based on the provisioning controller library
in this repository and must implement the
<a href=https://github.com/gardener/external-dns-management/blob/master/pkg/dns/provider/interface.go><code>provider.DNSHandlerFactory</code> interface</a>.
This factory returns implementations of the <a href=https://github.com/gardener/external-dns-management/blob/master/pkg/dns/provider/interface.go><code>provider.DNSHandler</code> interface</a>
that does the effective work for a dedicated set of hosted zones.</p><p>These factories can be embedded into a final controller manager (the runnable
instance) in several ways:</p><ul><li>The factory can be used to create a dedicated controller.
This controller can then be embedded into a controller manager, either in
its own controller manger or together with other controllers.</li><li>The factory can be added to a compound factory, able to handle multiple
infrastructures. This one can then be used to create a dedicated controller,
again.</li></ul><h4 id=embedding-a-factory-into-a-controller>Embedding a Factory into a Controller</h4><p>A provisioning controller can be implemented following this
<a href=https://github.com/gardener/external-dns-management/blob/master/pkg/controller/provider/aws/controller/controller.go>example</a>:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>controller</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;github.com/gardener/external-dns-management/pkg/dns/provider&#34;</span>
<span class=p>)</span>

<span class=kd>const</span> <span class=nx>CONTROLLER_NAME</span> <span class=p>=</span> <span class=s>&#34;route53-dns-controller&#34;</span>

<span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>provider</span><span class=p>.</span><span class=nf>DNSController</span><span class=p>(</span><span class=nx>CONTROLLER_NAME</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>Factory</span><span class=p>{}).</span>
        <span class=nf>FinalizerDomain</span><span class=p>(</span><span class=s>&#34;dns.gardener.cloud&#34;</span><span class=p>).</span>
        <span class=nf>MustRegister</span><span class=p>(</span><span class=nx>provider</span><span class=p>.</span><span class=nx>CONTROLLER_GROUP_DNS_CONTROLLERS</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>This controller can be embedded into a controller manager just by using
an <a href=https://github.com/gardener/external-dns-management/blob/master/cmd/compound/main.go>anonymous import</a> of the controller package in the main package
of a dedicated controller manager.</p><p>Complete examples are available in the sub packages of <code>pkg/controller/provider</code>.
They also show a typical set of implementation structures that help
to structure the implementation of such controllers.</p><p>The provider implemented in this project always follow the same structure:</p><ul><li>the provider package contains the provider code</li><li>the factory source file registers the factory at a default compound factory</li><li>it contains a sub package <code>controller</code>, which contains the embedding of
the factory into a dedicated controller</li></ul><h4 id=embedding-a-factory-into-a-compound-factory>Embedding a Factory into a Compound Factory</h4><p>A provisioning controller based on a <em>Compound Factory</em> can be extended by
a new provider factory by registering this factory at the compound factory.
This could be done, for example, by using the default compound factory provided
in package <a href=https://github.com/gardener/external-dns-management/blob/master/pkg/controller/provider/compound/factory.go><code>pkg/controller/provider/compound</code></a> as shown
<a href=https://github.com/gardener/external-dns-management/blob/master/pkg/controller/provider/aws/factory.go>here</a>, where <code>NewHandler</code> is a function creating
a dedicated handler for a dedicated provider type:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go>
<span class=kn>package</span> <span class=nx>aws</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;github.com/gardener/external-dns-management/pkg/controller/provider/compound&#34;</span>
    <span class=s>&#34;github.com/gardener/external-dns-management/pkg/dns/provider&#34;</span>
<span class=p>)</span>

<span class=kd>const</span> <span class=nx>TYPE_CODE</span> <span class=p>=</span> <span class=s>&#34;aws-route53&#34;</span>

<span class=kd>var</span> <span class=nx>Factory</span> <span class=p>=</span> <span class=nx>provider</span><span class=p>.</span><span class=nf>NewDNSHandlerFactory</span><span class=p>(</span><span class=nx>TYPE_CODE</span><span class=p>,</span> <span class=nx>NewHandler</span><span class=p>)</span>

<span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>compound</span><span class=p>.</span><span class=nf>MustRegister</span><span class=p>(</span><span class=nx>Factory</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>The compound factory is then again embedded into a provisioning controller as shown
in the previous section (see the <a href=https://github.com/gardener/external-dns-management/blob/master/pkg/controller/provider/compound/controller/controller.go><code>controller</code>sub package</a>).</p><h3 id=setting-up-a-controller-manager>Setting Up a Controller Manager</h3><p>One or multiple controller packages can be bundled into a controller manager,
by implementing a main package like <a href=https://github.com/gardener/external-dns-management/blob/master/cmd/compound/main.go>this</a>:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;github.com/gardener/controller-manager-library/pkg/controllermanager&#34;</span>

    <span class=nx>_</span> <span class=s>&#34;github.com/&lt;your controller package&gt;&#34;</span>
    <span class=o>...</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>controllermanager</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=s>&#34;my-dns-controller-manager&#34;</span><span class=p>,</span> <span class=s>&#34;dns controller manager&#34;</span><span class=p>,</span> <span class=s>&#34;some description&#34;</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><h3 id=using-the-standard-compound-provisioning-controller>Using the standard Compound Provisioning Controller</h3><p>If the standard <em>Compound Provisioning Controller</em> should be used it is required
to additionally add the anonymous imports for the providers intended to be
embedded into the compound factory like <a href=https://github.com/gardener/external-dns-management/blob/master/cmd/compound/main.go>this</a>:</p><details><summary><b>Example Coding</b></summary><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;fmt&#34;</span>
    <span class=s>&#34;os&#34;</span>

    <span class=s>&#34;github.com/gardener/controller-manager-library/pkg/controllermanager&#34;</span>


    <span class=nx>_</span> <span class=s>&#34;github.com/gardener/external-dns-management/pkg/controller/provider/compound/controller&#34;</span>
    <span class=nx>_</span> <span class=s>&#34;github.com/gardener/external-dns-management/pkg/controller/provider/&lt;your provider&gt;&#34;</span>
    <span class=o>...</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>controllermanager</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=s>&#34;dns-controller-manager&#34;</span><span class=p>,</span> <span class=s>&#34;dns controller manager&#34;</span><span class=p>,</span> <span class=s>&#34;nothing&#34;</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div></details><h3 id=multiple-cluster-support>Multiple Cluster Support</h3><p>The controller implementations provided in this project are prepared to work
with multiple clusters by using the features of the used controller manager
library.</p><p>The <em>DNS Source Controllers</em> support two clusters:</p><ul><li>the default cluster is used to scan for source objects</li><li>the logical cluster <code>target</code> is used to maintain the <code>DNSEnry</code> objects.</li></ul><p>The <em>DNS Provisioning Controllers</em> also support two clusters:</p><ul><li>the default cluster is used to scan for <code>DNSEntry</code> objects. It is mapped
to the logical cluster <code>target</code></li><li>the logical cluster <code>provider</code> is used to look to the <code>DNSProvider</code> objects
and their related secrets.</li></ul><p>If those controller types should be combined in a single controller manager,
it can be configured to support three potential clusters with the
source objects, the one for the entry objects and the one with provider
objects using cluster mappings.</p><p>This is shown in a complete <a href=https://github.com/gardener/external-dns-management/blob/master/cmd/compound/main.go>example</a> using the dns
source controllers, the compound provisioning controller configured to
support all the included DNS provider type factories:</p><details><summary><b>Example Coding</b></summary><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;fmt&#34;</span>
    <span class=s>&#34;os&#34;</span>

    <span class=s>&#34;github.com/gardener/controller-manager-library/pkg/controllermanager&#34;</span>
    <span class=s>&#34;github.com/gardener/controller-manager-library/pkg/controllermanager/cluster&#34;</span>
    <span class=s>&#34;github.com/gardener/controller-manager-library/pkg/controllermanager/controller&#34;</span>
    <span class=s>&#34;github.com/gardener/controller-manager-library/pkg/controllermanager/controller/mappings&#34;</span>

    <span class=nx>dnsprovider</span> <span class=s>&#34;github.com/gardener/external-dns-management/pkg/dns/provider&#34;</span>
    <span class=nx>dnssource</span> <span class=s>&#34;github.com/gardener/external-dns-management/pkg/dns/source&#34;</span>

    <span class=nx>_</span> <span class=s>&#34;github.com/gardener/external-dns-management/pkg/controller/provider/compound/controller&#34;</span>
    <span class=nx>_</span> <span class=s>&#34;github.com/gardener/external-dns-management/pkg/controller/provider/alicloud&#34;</span>
    <span class=nx>_</span> <span class=s>&#34;github.com/gardener/external-dns-management/pkg/controller/provider/aws&#34;</span>
    <span class=nx>_</span> <span class=s>&#34;github.com/gardener/external-dns-management/pkg/controller/provider/azure&#34;</span>
    <span class=nx>_</span> <span class=s>&#34;github.com/gardener/external-dns-management/pkg/controller/provider/google&#34;</span>
    <span class=nx>_</span> <span class=s>&#34;github.com/gardener/external-dns-management/pkg/controller/provider/openstack&#34;</span>
    <span class=nx>_</span> <span class=s>&#34;github.com/gardener/external-dns-management/pkg/controller/provider/cloudflare&#34;</span>
    <span class=nx>_</span> <span class=s>&#34;github.com/gardener/external-dns-management/pkg/controller/provider/netlify&#34;</span>

    <span class=nx>_</span> <span class=s>&#34;github.com/gardener/external-dns-management/pkg/controller/source/ingress&#34;</span>
    <span class=nx>_</span> <span class=s>&#34;github.com/gardener/external-dns-management/pkg/controller/source/service&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
    <span class=c1>// target cluster already defined in dns source controller package
</span><span class=c1></span>    <span class=nx>cluster</span><span class=p>.</span><span class=nf>Configure</span><span class=p>(</span>
        <span class=nx>dnsprovider</span><span class=p>.</span><span class=nx>PROVIDER_CLUSTER</span><span class=p>,</span>
        <span class=s>&#34;providers&#34;</span><span class=p>,</span>
        <span class=s>&#34;cluster to look for provider objects&#34;</span><span class=p>,</span>
    <span class=p>).</span><span class=nf>Fallback</span><span class=p>(</span><span class=nx>dnssource</span><span class=p>.</span><span class=nx>TARGET_CLUSTER</span><span class=p>)</span>

    <span class=nx>mappings</span><span class=p>.</span><span class=nf>ForControllerGroup</span><span class=p>(</span><span class=nx>dnsprovider</span><span class=p>.</span><span class=nx>CONTROLLER_GROUP_DNS_CONTROLLERS</span><span class=p>).</span>
        <span class=nf>Map</span><span class=p>(</span><span class=nx>controller</span><span class=p>.</span><span class=nx>CLUSTER_MAIN</span><span class=p>,</span> <span class=nx>dnssource</span><span class=p>.</span><span class=nx>TARGET_CLUSTER</span><span class=p>).</span><span class=nf>MustRegister</span><span class=p>()</span>

<span class=p>}</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>controllermanager</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=s>&#34;dns-controller-manager&#34;</span><span class=p>,</span> <span class=s>&#34;dns controller manager&#34;</span><span class=p>,</span> <span class=s>&#34;nothing&#34;</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div></details><p>Those clusters can the be separated by registering their names together with
command line option names. These can be used to specify different kubeconfig
files for those clusters.</p><p>By default all logical clusters are mapped to the default physical cluster
specified via <code>--kubeconfig</code> or default cluster access.</p><p>If multiple physical clusters are defined they can be specified by a
corresponding cluster option defining the kubeconfig file used to access
this cluster. If no such option is specified the default is used.</p><p>Therefore, even if the configuration is prepared for multiple clusters,
such a controller manager can easily work on a single cluster if no special
options are given on the command line.</p><h2 id=why-not-using-the-community-external-dns-solution>Why not using the community external-dns solution?</h2><p>Some of the reasons are context-specific, i.e. relate to Gardener&rsquo;s highly dynamic requirements.</p><ol><li>Custom resource for DNS entries</li></ol><p>DNS entries are explicitly specified as custom resources. As an important side effect, each DNS entry provides an own status. Simply by querying the Kubernetes API, a client can check if a requested DNS entry has been successfully added to the DNS backend, or if an update has already been deployed, or if not to reason about the cause. It also opens for easy extensibility, as DNS entries can be created directly via the Kubernetes API. And it simplifies Day 2 operations, e.g. automatic cleanup of unused entries if a DNS provider is deleted.</p><ol start=2><li>Management of multiple DNS providers</li></ol><p>The Gardener DNS controller uses a custom resource DNSProvider to dynamically manage the backend DNS services. While with external-dns you have to specify the single provider during startup, in the Gardener DNS controller you can add/update/delete providers during runtime with different credentials and/or backends. This is important for a multi-tenant environment as in Gardener, where users can bring their own accounts.</p><p>A DNS provider can also restrict its actions on subset of the DNS domains (includes and excludes) for which the credentials are capable to edit.</p><p>Each provider can define a separate “owner” identifier, to differentiate DNS entries in the same DNS zone from different providers.</p><ol start=3><li>Multi cluster support</li></ol><p>The Gardener DNS controller distinguish three different logical Kubernetes clusters: Source cluster, target cluster and runtime cluster. The source cluster is monitored by the DNS source controllers for annotations on ingress and service resources. These controllers then create DNS entries in the target cluster. DNS entries in the target cluster are then reconciliated/synchronized with the corresponding DNS backend service by the provider controller. The runtime cluster is the cluster the DNS controller runs on. For example, this enables needed flexibility in the Gardener deployment. The DNS controller runs on the seed cluster. This is also the target cluster. DNS providers and entries resources are created in the corresponding namespace of the shoot control plane, while the source cluster is the shoot cluster itself.</p><ol start=4><li>Optimizations for handling hundreds of DNS entries</li></ol><p>Some DNS backend services are restricted on the API calls per second (e.g. the AWS Route 53 API). To manage hundreds of DNS entries it is important to minimize the number of API calls. The Gardener DNS controller heavily makes usage of caches and batch processing for this reason.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0fb73486b1ed75b4d156684e699d4e70>1.5.2 - Certificates Management</h1><h1 id=certificate-management>Certificate Management</h1><p><a href=https://reuse.software/><img src=https://reuse.software/badge/reuse-compliant.svg alt="reuse compliant"></a></p><p>The cert-manager manages TLS certificates in Kubernetes clusters using custom resources.</p><p>In a multi-cluster environment like Gardener, using existing open source projects
for certificate management like <a href=https://github.com/jetstack/cert-manager>cert-manager</a> becomes cumbersome.
With this project the separation of concerns between multiple clusters is realized more easily.
The cert-controller-manager runs in a <strong>secured cluster</strong> where the issuer secrets are stored.
At the same time it watches an untrusted <strong>source cluster</strong> and can provide certificates for it.
The cert-controller-manager relies on DNS challenges (ACME only) for validating the domain names of the certificates.
For this purpose it creates DNSEntry custom resources (in a possible separate <strong>dns cluster</strong>) to be
handled by the compagnion dns-controller-manager from <a href=https://github.com/gardener/external-dns-management>external-dns-management</a>.</p><p>Currently, the <code>cert-controller-manager</code> supports certificate authorities via:</p><ul><li><a href=https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment>Automatic Certificate Management Environment (ACME)</a> protocol like <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a>.</li><li>Certificate Authority (CA): an existing certificate and a private key provided as a TLS Secret.</li></ul><p><strong>Index</strong></p><ul><li><a href=#quick-start-using-certificates-in-a-gardener-shoot-cluster>Quick start using certificates in a Gardener shoot cluster</a></li><li><a href=#setting-up-issuers>Setting up Issuers</a><ul><li><a href=#automatic-certificate-management-environment-acme>Automatic Certificate Management Environment (ACME)</a><ul><li><a href=#auto-registration>Auto registration</a></li><li><a href=#using-existing-account>Using existing account</a></li></ul></li><li><a href=#certificate-authority-ca>Certificate Authority (CA)</a></li></ul></li><li><a href=#requesting-a-certificate>Requesting a Certificate</a><ul><li><a href=#using-commonname-and-optional-dnsnames>Using <code>commonName</code> and optional <code>dnsNames</code></a></li><li><a href=#using-a-certificate-signing-request-csr>Using a certificate signing request (CSR)</a></li></ul></li><li><a href=#requesting-a-certificate-for-ingress>Requesting a Certificate for Ingress</a><ul><li><a href=#process>Process</a></li></ul></li><li><a href=#requesting-a-certificate-for-service>Requesting a Certificate for Service</a></li><li><a href=#demo-quick-start>Demo quick start</a></li><li><a href=#using-the-cert-controller-manager>Using the cert-controller-manager</a><ul><li><a href=#usage>Usage</a></li></ul></li><li><a href=#renewal-of-certificates>Renewal of Certificates</a></li><li><a href=#revoking-certificates>Revoking Certificates</a><ul><li><a href=#revoking-certificates-with-renewal>Revoking certificates with renewal</a></li><li><a href=#checking-ocsp-revocation-using-openssl>Checking OCSP revocation using OpenSSL</a></li></ul></li><li><a href=#metrics>Metrics</a></li><li><a href=#development>Development</a></li></ul><h2 id=quick-start-using-certificates-in-a-gardener-shoot-cluster>Quick start using certificates in a Gardener shoot cluster</h2><p>This component is typically deployed by the <a href=/docs/guides/install_gardener/certificate_management>Gardener Extension for certificate services</a>
to simplify requesting certificates for Gardener shoot clusters.</p><p>For a quick start please see <a href=https://gardener.cloud/docs/guides/administer_shoots/request_cert/>Request X.509 Certificates</a></p><h2 id=setting-up-issuers>Setting up Issuers</h2><p>Before you can obtain certificates from a certificate authority (CA), you need to set up an issuer.
The issuer is specified in the <code>default</code> cluster, while the certificates are specified in the <code>source</code> cluster.</p><p>The issuer custom resource contains the configuration and registration data for your account at the CA.</p><h3 id=automatic-certificate-management-environment-acme>Automatic Certificate Management Environment (ACME)</h3><p>Two modes are supported:</p><ul><li>auto registration</li><li>using an existing account</li></ul><h4 id=auto-registration>Auto registration</h4><p>Auto registration is mainly used for development and test environments. You only need to provide
the server URL and an email address. The registration process is done automatically for you
by creating a private key and performing the registration at the CA. Optionally you can provide
the target secret with the privateKeySecretRef section.</p><p>For example see <a href=https://github.com/gardener/cert-management/blob/master/examples/20-issuer-staging.yaml>examples/20-issuer-staging.yaml</a>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Issuer</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>issuer-staging</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>acme</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://acme-staging-v02.api.letsencrypt.org/directory</span><span class=w>
</span><span class=w>    </span><span class=nt>email</span><span class=p>:</span><span class=w> </span><span class=l>some.user@mydomain.com</span><span class=w>
</span><span class=w>    </span><span class=nt>autoRegistration</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=c># with &#39;autoRegistration: true&#39; a new account will be created if the secretRef is not existing</span><span class=w>
</span><span class=w>    </span><span class=nt>privateKeySecretRef</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>issuer-staging-secret</span><span class=w>
</span><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></code></pre></div><h4 id=using-existing-account>Using existing account</h4><p>If you already have an existing account at the certificate authority, you need to
specify email address and reference the private key from a secret.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-issuer-secret</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>privateKey</span><span class=p>:</span><span class=w> </span><span class=l>LS0tLS1...</span><span class=w>
</span></code></pre></div><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Issuer</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-issuer</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>acme</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://acme-v02.api.letsencrypt.org/directory</span><span class=w>
</span><span class=w>    </span><span class=nt>email</span><span class=p>:</span><span class=w> </span><span class=l>my.account@mydomain.com</span><span class=w>
</span><span class=w>    </span><span class=nt>privateKeySecretRef</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-issuer-secret</span><span class=w>
</span><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></code></pre></div><p>In both cases, the state of an issuer resource can be checked on the <code>default</code> cluster with</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>▶ kubectl get issuer
NAME             SERVER                                                   EMAIL                    STATUS   TYPE   AGE
issuer-staging   https://acme-staging-v02.api.letsencrypt.org/directory   some.user@mydomain.com   Ready    acme   8s
</code></pre></div><h3 id=certificate-authority-ca>Certificate Authority (CA)</h3><p>This issuer is meant to be used where a central Certificate Authority
is already in place. The operator must request/provide by its own means a CA
or an intermediate CA. This is mainly used for <strong>on-premises</strong> and
<strong>airgapped</strong> environements.</p><p>It can also be used for <strong>developement</strong> or <strong>testing</strong> purproses. In this case
a Self-signed Certificate Authority can be created by following the section below.</p><p><em>Create a Self-signed Certificate Authority (optional)</em></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>▶ openssl genrsa -out CA-key.pem <span class=m>4096</span>
▶ <span class=nb>export</span> <span class=nv>CONFIG</span><span class=o>=</span><span class=s2>&#34;
</span><span class=s2>[req]
</span><span class=s2>distinguished_name=dn
</span><span class=s2>[ dn ]
</span><span class=s2>[ ext ]
</span><span class=s2>basicConstraints=CA:TRUE,pathlen:0
</span><span class=s2>&#34;</span>
▶ openssl req <span class=se>\
</span><span class=se></span>    -new -nodes -x509 -config &lt;<span class=o>(</span><span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$CONFIG</span><span class=s2>&#34;</span><span class=o>)</span> -key CA-key.pem <span class=se>\
</span><span class=se></span>    -subj <span class=s2>&#34;/CN=Hello&#34;</span> -extensions ext -days <span class=m>1000</span> -out CA-cert.pem
</code></pre></div><p>Create a TLS secret from the certificate <code>CA-cert.pem</code> and the private key <code>CA-key.pem</code></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>▶ kubectl -n default create secret tls issuer-ca-secret <span class=se>\
</span><span class=se></span>    --cert<span class=o>=</span>CA-cert.pem --key<span class=o>=</span>CA-key.pem -oyaml <span class=se>\
</span><span class=se></span>    --dry-run<span class=o>=</span>client &gt; secret.yaml
</code></pre></div><p>The content of the <code>secret.yaml</code> should look like the following, for a full example see <a href=https://github.com/gardener/cert-management/blob/master/examples/20-issuer-ca.yaml>examples/20-issuer-ca.yaml</a></p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>tls.crt</span><span class=p>:</span><span class=w> </span>{<span class=l>base64 certificate}</span><span class=w>
</span><span class=w>  </span><span class=nt>tls.key</span><span class=p>:</span><span class=w> </span>{<span class=l>base64 private key}</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>issuer-ca-secret</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/tls</span><span class=w>
</span></code></pre></div><p>Apply the secrets in the cluster and create the issuer,
for example see <a href=https://github.com/gardener/cert-management/blob/master/examples/20-issuer-ca.yaml>examples/20-issuer-ca.yaml</a></p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Issuer</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>issuer-ca</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ca</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>privateKeySecretRef</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>issuer-ca-secret</span><span class=w>
</span><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></code></pre></div><p>The state of the issuer resource can be checked on the <code>default</code> cluster with</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>▶ kubectl get issuer
NAME        SERVER   EMAIL   STATUS   TYPE   AGE
issuer-ca                    Ready    ca     6s
</code></pre></div><p>Some details about the CA can be found in the status of the issuer.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>▶ kubectl get issuer issuer-ca -ojsonpath<span class=o>=</span><span class=s1>&#39;{.status}&#39;</span> <span class=p>|</span> jq <span class=s1>&#39;.&#39;</span>
<span class=o>{</span>
  <span class=s2>&#34;ca&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;NotAfter&#34;</span>: <span class=s2>&#34;2023-05-31T14:55:55Z&#34;</span>,
    <span class=s2>&#34;NotBefore&#34;</span>: <span class=s2>&#34;2020-09-03T14:55:55Z&#34;</span>,
    <span class=s2>&#34;Subject&#34;</span>: <span class=o>{</span>
      <span class=s2>&#34;CommonName&#34;</span>: <span class=s2>&#34;my-domain.com&#34;</span>,
      <span class=s2>&#34;Country&#34;</span>: <span class=o>[</span>
        <span class=s2>&#34;DE&#34;</span>
      <span class=o>]</span>,
      <span class=s2>&#34;Locality&#34;</span>: <span class=o>[</span>
        <span class=s2>&#34;Walldorf&#34;</span>
      <span class=o>]</span>,
      <span class=s2>&#34;Organization&#34;</span>: <span class=o>[</span>
        <span class=s2>&#34;Gardener&#34;</span>
      <span class=o>]</span>,
      <span class=s2>&#34;OrganizationalUnit&#34;</span>: <span class=o>[</span>
        <span class=s2>&#34;Gardener&#34;</span>
      <span class=o>]</span>,
      <span class=s2>&#34;PostalCode&#34;</span>: null,
      <span class=s2>&#34;Province&#34;</span>: <span class=o>[</span>
        <span class=s2>&#34;BW&#34;</span>
      <span class=o>]</span>,
      <span class=s2>&#34;SerialNumber&#34;</span>: <span class=s2>&#34;1E04A2C8F057AC890F45FEC5446AE4DDA73EA1D5&#34;</span>,
      <span class=s2>&#34;StreetAddress&#34;</span>: null
    <span class=o>}</span>
  <span class=o>}</span>,
  <span class=s2>&#34;observedGeneration&#34;</span>: 1,
  <span class=s2>&#34;requestsPerDayQuota&#34;</span>: 10000,
  <span class=s2>&#34;state&#34;</span>: <span class=s2>&#34;Ready&#34;</span>,
  <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;ca&#34;</span>
<span class=o>}</span>
</code></pre></div><h2 id=requesting-a-certificate>Requesting a Certificate</h2><p>To obtain a certificate for a domain, you specify a certificate custom resource on the <code>source</code> cluster.
You can specify the issuer explicitly by reference. If there is no issuer reference, the default issuer is
used (provided as command line option). You must either specify the <code>commonName</code> and further optional <code>dnsNames</code> or
you can also start with a certificate signing request (CSR).</p><p>For domain validation, the <code>cert-controller-manager</code> only supports DNS challenges. For this purpose it relies
on the <code>dns-controller-manager</code> from the <a href=https://github.com/gardener/external-dns-management>external-dns-management</a>
project.
If any domain name (<code>commonName</code> or any item from <code>dnsNames</code>) needs to be validated, it creates a custom resource
<code>DNSEntry</code> in the <code>dns</code> cluster.
When the certificate authority sees the temporary DNS record, the certificate is stored in a secret finally.
The name of the secret can be specified explicitly with <code>secretName</code> and will be stored in the same namespace as the
certificate on the <code>source</code> cluster.</p><p>The certificate is checked for renewal periodically. The renewal is performed automatically and the secret is updated.
Default values for periodical check is daily, the certificate is renewed if its validity expires within 60 days.</p><h3 id=using-commonname-and-optional-dnsnames>Using <code>commonName</code> and optional <code>dnsNames</code></h3><p>For example see <a href=https://github.com/gardener/cert-management/blob/master/examples/30-cert-simple.yaml>examples/30-cert-simple.yaml</a>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Certificate</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cert-simple</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>commonName</span><span class=p>:</span><span class=w> </span><span class=l>cert1.mydomain.com</span><span class=w>
</span><span class=w>  </span><span class=nt>dnsNames</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=l>cert1-foo.mydomain.com</span><span class=w>
</span><span class=w>  </span>- <span class=l>cert1-bar.mydomain.com</span><span class=w>
</span><span class=w>  </span><span class=c># if issuer is not specified, the default issuer is used</span><span class=w>
</span><span class=w>  </span><span class=nt>issuerRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>issuer-staging</span><span class=w>
</span></code></pre></div><h3 id=using-a-certificate-signing-request-csr>Using a certificate signing request (CSR)</h3><p>You can provide a complete CSR in PEM format (and encoded as Base64).</p><p>For example see <a href=https://github.com/gardener/cert-management/blob/master/examples/30-cert-csr.yaml>examples/30-cert-csr.yaml</a>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Certificate</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cert-csr</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>csr</span><span class=p>:</span><span class=w> </span><span class=l>LS0tLS1CRUd...</span><span class=w>
</span><span class=w>  </span><span class=nt>issuerRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>issuer-staging</span><span class=w>
</span></code></pre></div><p>:warning: Using a CSR is only available for ACME Issuer</p><h2 id=requesting-a-certificate-for-ingress>Requesting a Certificate for Ingress</h2><p>Add the annotation <code>cert.gardener.cloud/purpose: managed</code> to the Ingress resource.
The <code>cert-controller-manager</code> will then automatically request a certificate for all domains given by the hosts in the
<code>tls</code> section of the Ingress spec.</p><p>For compatibility with the <a href=https://github.com/gardener/cert-broker>Gardener Cert-Broker</a>, you can
alternatively use the deprecated label <code>garden.sapcloud.io/purpose: managed-cert</code> for the same outcome.</p><p>See also <a href=https://github.com/gardener/cert-management/blob/master/examples/40-ingress-echoheaders.yaml>examples/40-ingress-echoheaders.yaml</a>:</p><h3 id=process>Process</h3><ol><li><p>Create the Ingress Resource (optional)</p><p>In order to request a certificate for a domain managed by <code>cert-controller-manager</code> an Ingress is required.
In case you don’t already have one, take the following as an example:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>vuejs-ingress</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># Gardener managed default domain.</span><span class=w>
</span><span class=w>  </span><span class=c># The first host is used as common name and must not exceed 64 characters</span><span class=w>
</span><span class=w>  </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>test.ingress.&lt;GARDENER-CLUSTER&gt;.&lt;GARDENER-PROJECT&gt;.shoot.example.com</span><span class=w>
</span><span class=w>    </span><span class=c># Certificate and private key reside in this secret.</span><span class=w>
</span><span class=w>    </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>testsecret-tls</span><span class=w>
</span><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>test.ingress.&lt;GARDENER-CLUSTER&gt;.&lt;GARDENER-PROJECT&gt;.shoot.example.com</span><span class=w>
</span><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>vuejs-svc</span><span class=w>
</span><span class=w>          </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></code></pre></div></li><li><p>Annotate the Ingress Resource</p><p>The annotation <code>cert.gardener.cloud/purpose: managed</code> instructs <code>cert-controller-manager</code> to handle certificate issuance for the domains found in labeled Ingress.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tls-example-ingress</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c># Let Gardener manage certificates for this Ingress.</span><span class=w>
</span><span class=w>    </span><span class=nt>cert.gardener.cloud/purpose</span><span class=p>:</span><span class=w> </span><span class=l>managed</span><span class=w>
</span><span class=w>    </span><span class=c>#dns.gardener.cloud/class: garden # needed on Gardener shoot clusters for managed DNS record creation (if not covered by `*.ingress.&lt;GARDENER-CLUSTER&gt;.&lt;GARDENER-PROJECT&gt;.shoot.example.com)</span><span class=w>
</span><span class=w>    </span><span class=c>#cert.gardener.cloud/commonname: &#34;*.demo.mydomain.com&#34; # optional, if not specified the first name from spec.tls[].hosts is used as common name</span><span class=w>
</span><span class=w>    </span><span class=c>#cert.gardener.cloud/dnsnames: &#34;&#34; # optional, if not specified the names from spec.tls[].hosts are used</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=l>echoheaders.demo.mydomain.com</span><span class=w>
</span><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>cert-echoheaders</span><span class=w>
</span><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>echoheaders.demo.mydomain.com</span><span class=w>
</span><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>echoheaders</span><span class=w>
</span><span class=w>              </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></code></pre></div><p>The annotation <code>cert.gardener.cloud/commonname</code> can be set to explicitly specify the common name.
If no set, the first name of <code>spec.tls.hosts</code> is used as common name.
The annotation <code>cert.gardener.cloud/dnsnames</code> can be used to explicitly specify the alternative DNS names.
If no set, the names of <code>spec.tls.hosts</code> are used.</p></li><li><p>Check status</p><p>A <code>certificate</code> custom resource is created in the same namespace of the <code>source</code> cluster.
You can either check the status of this certificate resource with <code>kubectl get cert</code> or you can check
the events for the ingress with <code>kubectl get events</code></p><p>The certificate is stored in the secret as specified in the Ingress resource.</p></li></ol><h2 id=requesting-a-certificate-for-service>Requesting a Certificate for Service</h2><p>If you have a service of type <code>LoadBalancer</code>, you can use the annotation <code>cert.gardener.cloud/secretname</code> together
with the annotation <code>dns.gardener.cloud/dnsnames</code> from the <code>dns-controller-manager</code> to trigger automatic creation of
a certificate. If you wan to share a certificate between multiple services and ingresses, using the annotations
<code>cert.gardener.cloud/commonname</code> and <code>cert.gardener.cloud/dnsnames</code> may be helpful.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cert.gardener.cloud/secretname</span><span class=p>:</span><span class=w> </span><span class=l>test-service-secret</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/dnsnames</span><span class=p>:</span><span class=w> </span><span class=l>test-service.demo.mydomain.com</span><span class=w>
</span><span class=w>    </span><span class=c>#dns.gardener.cloud/class: garden # needed on Gardener shoot clusters for managed DNS record creation</span><span class=w>
</span><span class=w>    </span><span class=c>#cert.gardener.cloud/commonname: &#34;*.demo.mydomain.com&#34; # optional, if not specified the first name from dns.gardener.cloud/dnsnames is used as common name</span><span class=w>
</span><span class=w>    </span><span class=c>#cert.gardener.cloud/dnsnames: &#34;&#34; # optional, if specified overrides dns.gardener.cloud/dnsnames annotation for certificate names</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/ttl</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;600&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-service</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></code></pre></div><p>The annotation <code>cert.gardener.cloud/commonname</code> is optional. If not specified, the first name of the annotation
<code>dns.gardener.cloud/dnsnames</code> is used as common name. It is useful to specify it explicitly, if no <code>DNSEntry</code>
should be created for the common name by the dns-controller-manager.
A typical use case is if the common name (limited to 64 characters) is set only to
deal with real domain names specified with <code>dns.gardener.cloud/dnsnames</code> which are longer than 64 characters.
The annotation <code>cert.gardener.cloud/dnsnames</code> can be used to explicitly specify the alternative DNS names.
If set, it overrides the values from the annotation <code>dns.gardener.cloud/dnsnames</code> for the certificate (but not for
creating DNS records by the dns-controller-manager).</p><p>If you want to share a certificate between multiple services and ingresses, using the annotations <code>cert.gardener.cloud/commonname</code> and
<code>cert.gardener.cloud/dnsnames</code> may be helpful. For example, to share a wildcard certificate, you should add these two annotations</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>    </span><span class=nt>cert.gardener.cloud/commonname</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*.demo.mydomain.com&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>cert.gardener.cloud/dnsnames</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></code></pre></div><p>This will create or reuse a certificate for <code>*.demo.mydomain.com</code>. An existing certificate is automatically reused,
if it has exactly the same common name and DNS names.</p><h2 id=demo-quick-start>Demo quick start</h2><ol><li><p>Run dns-controller-manager with:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>./dns-controller-manager --controllers<span class=o>=</span>azure-dns --identifier<span class=o>=</span>myOwnerId --disable-namespace-restriction
</code></pre></div></li><li><p>Ensure provider and its secret, e.g.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f azure-secret.yaml
kubectl apply -f azure-provider.yaml
</code></pre></div><ul><li><p>check with</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>▶ kubectl get dnspr
NAME               TYPE        STATUS   AGE
azure-playground   azure-dns   Ready    28m
</code></pre></div></li></ul></li><li><p>Create test namespace</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl create ns <span class=nb>test</span>
</code></pre></div></li><li><p>Run cert-controller-manager</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>./cert-controller-manager
</code></pre></div></li><li><p>Register user <code>some.user@mydomain.com</code> at let&rsquo;s encrypt</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f examples/20-issuer-staging.yaml
</code></pre></div><ul><li><p>check with</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>▶ kubectl get issuer
NAME             SERVER                                                   EMAIL                    STATUS   TYPE   AGE
issuer-staging   https://acme-staging-v02.api.letsencrypt.org/directory   some.user@mydomain.com   Ready    acme   8s
</code></pre></div></li></ul></li><li><p>Request a certificate for <code>cert1.martin.test6227.ml</code></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f examples/30-cert-simple.yaml
</code></pre></div><p>If this certificate has been already registered for the same issuer before,
it will be returned immediately from the ACME server.
Otherwise a DNS challenge is started using a temporary DNSEntry to be set by <code>dns-controller-manager</code></p><ul><li><p>check with</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>▶ kubectl get cert -o wide
NAME          COMMON NAME           ISSUER           STATUS   EXPIRATION_DATE        DNS_NAMES                 AGE
cert-simple   cert1.mydomain.com    issuer-staging   Ready    2019-11-10T09:48:17Z   <span class=o>[</span>cert1.my-domain.com<span class=o>]</span>     34s
</code></pre></div></li></ul></li></ol><h2 id=using-the-cert-controller-manager>Using the cert-controller-manager</h2><p>The cert-controller-manager communicated with up to four different clusters:</p><ul><li><strong>default</strong>
used for managing issuers and lease management.
The path to the kubeconfig is specified with command line option <code>--kubeconfig</code>.</li><li><strong>source</strong>
used for watching resources ingresses, services and certificates
The path to the kubeconfig is specified with command line option <code>--source</code>.
If option is omitted, the default cluster is used for source.</li><li><strong>dns</strong>
used to write temporary DNSEntries for DNS challenges
The path to the kubeconfig is specified with command line option <code>--dns</code>.
If option is omitted, the default cluster is used for dns.</li><li><strong>target</strong>
used for storing generated certificates (and issuers if <code>--allow-target-issuers</code>
option is set)
The path to the kubeconfig is specified with command line option <code>--target</code>.
If option is omitted, the source cluster is also used for target.</li></ul><h3 id=usage>Usage</h3><p>The complete list of options is:</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>Usage:
  cert-controller-manager [flags]

Flags:
      --accepted-maintainers string                        accepted maintainer key(s) for crds
      --acme-deactivate-authorizations                     if true authorizations are always deactivated after each ACME certificate request
      --allow-target-issuers                               If true, issuers are also watched on the target cluster
      --bind-address-http string                           HTTP server bind address
      --cascade-delete                                     If true, certificate secrets are deleted if dependent resources (certificate, ingress) are deleted
      --cert-class string                                  Identifier used to differentiate responsible controllers for entries
      --cert-target-class string                           Identifier used to differentiate responsible dns controllers for target entries
      --config string                                      config file
  -c, --controllers string                                 comma separated list of controllers to start (&lt;name&gt;,&lt;group&gt;,all)
      --cpuprofile string                                  set file for cpu profiling
      --default-issuer string                              name of default issuer (from default cluster)
      --default-issuer-domain-ranges string                domain range restrictions when using default issuer separated by comma
      --default-requests-per-day-quota int                 Default value for requestsPerDayQuota if not set explicitly in the issuer spec.
      --default.pool.resync-period duration                Period for resynchronization for pool default
      --default.pool.size int                              Worker pool size for pool default
      --disable-namespace-restriction                      disable access restriction for namespace local access only
      --dns string                                         cluster for writing challenge DNS entries
      --dns-class string                                   class for creating challenge DNSEntries (in DNS cluster)
      --dns-namespace string                               namespace for creating challenge DNSEntries (in DNS cluster)
      --dns-owner-id string                                ownerId for creating challenge DNSEntries
      --dns.disable-deploy-crds                            disable deployment of required crds for cluster dns
      --dns.id string                                      id for cluster dns
      --dns.migration-ids string                           migration id for cluster dns
      --force-crd-update                                   enforce update of crds even they are unmanaged
      --grace-period duration                              inactivity grace period for detecting end of cleanup for shutdown
  -h, --help                                               help for cert-controller-manager
      --ingress-cert.cert-class string                     Identifier used to differentiate responsible controllers for entries of controller ingress-cert
      --ingress-cert.cert-target-class string              Identifier used to differentiate responsible dns controllers for target entries of controller ingress-cert
      --ingress-cert.default.pool.resync-period duration   Period for resynchronization for pool default of controller ingress-cert
      --ingress-cert.default.pool.size int                 Worker pool size for pool default of controller ingress-cert
      --ingress-cert.pool.resync-period duration           Period for resynchronization of controller ingress-cert
      --ingress-cert.pool.size int                         Worker pool size of controller ingress-cert
      --ingress-cert.target-name-prefix string             name prefix in target namespace for cross cluster generation of controller ingress-cert
      --ingress-cert.target-namespace string               target namespace for cross cluster generation of controller ingress-cert
      --ingress-cert.targets.pool.size int                 Worker pool size for pool targets of controller ingress-cert
      --issuer-namespace string                            namespace to lookup issuers on default cluster
      --issuer.acme-deactivate-authorizations              if true authorizations are always deactivated after each ACME certificate request of controller issuer
      --issuer.allow-target-issuers                        If true, issuers are also watched on the target cluster of controller issuer
      --issuer.cascade-delete                              If true, certificate secrets are deleted if dependent resources (certificate, ingress) are deleted of controller issuer
      --issuer.cert-class string                           Identifier used to differentiate responsible controllers for entries of controller issuer
      --issuer.default-issuer string                       name of default issuer (from default cluster) of controller issuer
      --issuer.default-issuer-domain-ranges string         domain range restrictions when using default issuer separated by comma of controller issuer
      --issuer.default-requests-per-day-quota int          Default value for requestsPerDayQuota if not set explicitly in the issuer spec. of controller issuer
      --issuer.default.pool.resync-period duration         Period for resynchronization for pool default of controller issuer
      --issuer.default.pool.size int                       Worker pool size for pool default of controller issuer
      --issuer.dns-class string                            class for creating challenge DNSEntries (in DNS cluster) of controller issuer
      --issuer.dns-namespace string                        namespace for creating challenge DNSEntries (in DNS cluster) of controller issuer
      --issuer.dns-owner-id string                         ownerId for creating challenge DNSEntries of controller issuer
      --issuer.issuer-namespace string                     namespace to lookup issuers on default cluster of controller issuer
      --issuer.issuers.pool.size int                       Worker pool size for pool issuers of controller issuer
      --issuer.pool.resync-period duration                 Period for resynchronization of controller issuer
      --issuer.pool.size int                               Worker pool size of controller issuer
      --issuer.precheck-additional-wait duration           additional wait time after DNS propagation check of controller issuer
      --issuer.precheck-nameservers string                 DNS nameservers used for checking DNS propagation. If explicity set empty, it is tried to read them from /etc/resolv.conf of controller issuer
      --issuer.propagation-timeout duration                propagation timeout for DNS challenge of controller issuer
      --issuer.renewal-overdue-window duration             certificate is counted as &#39;renewal overdue&#39; if its validity period is shorter (metrics cert_management_overdue_renewal_certificates) of controller issuer
      --issuer.renewal-window duration                     certificate is renewed if its validity period is shorter of controller issuer
      --issuer.revocations.pool.size int                   Worker pool size for pool revocations of controller issuer
      --issuer.secrets.pool.size int                       Worker pool size for pool secrets of controller issuer
      --issuers.pool.size int                              Worker pool size for pool issuers
      --kubeconfig string                                  default cluster access
      --kubeconfig.disable-deploy-crds                     disable deployment of required crds for cluster default
      --kubeconfig.id string                               id for cluster default
      --kubeconfig.migration-ids string                    migration id for cluster default
      --lease-duration duration                            lease duration
      --lease-name string                                  name for lease object
      --lease-renew-deadline duration                      lease renew deadline
      --lease-resource-lock string                         determines which resource lock to use for leader election, defaults to &#39;configmapsleases&#39;
      --lease-retry-period duration                        lease retry period
  -D, --log-level string                                   logrus log level
      --maintainer string                                  maintainer key for crds (default &#34;cert-controller-manager&#34;)
      --name string                                        name used for controller manager (default &#34;cert-controller-manager&#34;)
      --namespace string                                   namespace for lease (default &#34;kube-system&#34;)
  -n, --namespace-local-access-only                        enable access restriction for namespace local access only (deprecated)
      --omit-lease                                         omit lease for development
      --plugin-file string                                 directory containing go plugins
      --pool.resync-period duration                        Period for resynchronization
      --pool.size int                                      Worker pool size
      --precheck-additional-wait duration                  additional wait time after DNS propagation check
      --precheck-nameservers string                        DNS nameservers used for checking DNS propagation. If explicity set empty, it is tried to read them from /etc/resolv.conf
      --propagation-timeout duration                       propagation timeout for DNS challenge
      --renewal-overdue-window duration                    certificate is counted as &#39;renewal overdue&#39; if its validity period is shorter (metrics cert_management_overdue_renewal_certificates)
      --renewal-window duration                            certificate is renewed if its validity period is shorter
      --revocations.pool.size int                          Worker pool size for pool revocations
      --secrets.pool.size int                              Worker pool size for pool secrets
      --server-port-http int                               HTTP server port (serving /healthz, /metrics, ...)
      --service-cert.cert-class string                     Identifier used to differentiate responsible controllers for entries of controller service-cert
      --service-cert.cert-target-class string              Identifier used to differentiate responsible dns controllers for target entries of controller service-cert
      --service-cert.default.pool.resync-period duration   Period for resynchronization for pool default of controller service-cert
      --service-cert.default.pool.size int                 Worker pool size for pool default of controller service-cert
      --service-cert.pool.resync-period duration           Period for resynchronization of controller service-cert
      --service-cert.pool.size int                         Worker pool size of controller service-cert
      --service-cert.target-name-prefix string             name prefix in target namespace for cross cluster generation of controller service-cert
      --service-cert.target-namespace string               target namespace for cross cluster generation of controller service-cert
      --service-cert.targets.pool.size int                 Worker pool size for pool targets of controller service-cert
      --source string                                      source cluster to watch for ingresses and services
      --source.disable-deploy-crds                         disable deployment of required crds for cluster source
      --source.id string                                   id for cluster source
      --source.migration-ids string                        migration id for cluster source
      --target string                                      target cluster for certificates
      --target-name-prefix string                          name prefix in target namespace for cross cluster generation
      --target-namespace string                            target namespace for cross cluster generation
      --target.disable-deploy-crds                         disable deployment of required crds for cluster target
      --target.id string                                   id for cluster target
      --target.migration-ids string                        migration id for cluster target
      --targets.pool.size int                              Worker pool size for pool targets
  -v, --version                                            version for cert-controller-manager
</code></pre></div><h2 id=renewal-of-certificates>Renewal of Certificates</h2><p>Certificates created with an <code>ACME</code> issuer are automatically renewed. With the standard configuration,
the certificate is renewed 30 days before it validity expires.
For example, if <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a> is used as certificate authority, a certificate
is always valid for 90 days and will be rolled 30 days before it expires by updating the referenced <code>Secret</code>
in the <code>Certificate</code> object.<br>The configuration can be changed with the command line parameter <code>--issuer.renewal-window</code>.</p><h2 id=revoking-certificates>Revoking Certificates</h2><p>Certificates created with an <code>ACME</code> issuer can also be revoked if private key of the certificate
is not longer safe. This page about <a href=https://letsencrypt.org/docs/revoking/>Revoking certificates on Let&rsquo;s Encrypt</a>
list various reasons:</p><blockquote><p>For instance, you might accidentally share the private key on a public website; hackers might copy the private key off
of your servers; or hackers might take temporary control over your servers or your DNS configuration, and use that to
validate and issue a certificate for which they hold the private key.</p></blockquote><p>Revoking a certificate is quite simple. You create a <code>CertificateRevocation</code> object on the source cluster with a reference
to the <code>Certificate</code> object to be revoked.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CertificateRevocation</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>revoke-sample</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>certificateRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mycert</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>    
</span><span class=w>  </span><span class=c># Uncomment the following line if certificate should be renewed before revoking the old one(s)</span><span class=w>
</span><span class=w>  </span><span class=c>#renew: true</span><span class=w>
</span><span class=w>  
</span><span class=w>  </span><span class=c># Optionally specify a qualifying date. All certificates requested before this date will be revoked.</span><span class=w>
</span><span class=w>  </span><span class=c># If not specified, the current time is used by default.</span><span class=w>
</span><span class=w>  </span><span class=c>#qualifyingDate: &#34;2020-12-22T17:00:35Z&#34;</span><span class=w>
</span></code></pre></div><p>The <code>cert-controller-manager</code> will then perform several steps.</p><ol><li><p>Using the certificate secret it looks for other <code>Certificate</code> objects using the same certificate. The &ldquo;same&rdquo;
certificate means same issuer, <em>Common Name</em>, and <em>DNS Names</em>. All found objects will be reconciled too.</p></li><li><p>It will look for other valid certificate secrets older than the qualifying date. Concretely this will
deal with unused certificates, which are still valid. As a certificate is renewed 30 days before the end of validity,
the old certificate is still valid, but not used anymore.</p></li><li><p>All found certificate secrets are revoked and marked with an annotation <code>cert.gardener.cloud/revoked: "true"</code></p></li><li><p>The state of all found <code>Certificate</code> objects is set to <code>Revoked</code></p></li><li><p>The state of the <code>CertificateRevocation</code> object is set to <code>Applied</code>.
Additionally, the status of the <code>CertificateRevocation</code> object contains more details about revoked
objects and secrets:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CertificateRevocation</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>revoke-sample</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>certificateRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mycert</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>qualifyingDate</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2020-12-22T17:00:35Z&#34;</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>certificate(s) revoked</span><span class=w>
</span><span class=w>  </span><span class=nt>objects</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>revoked</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mycert</span><span class=w>
</span><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>revocationApplied</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2020-12-22T17:09:32Z&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>secrets</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>revoked</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cert-backup-default-issuer-8a7e93f7-sks7p</span><span class=w>
</span><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span><span class=w>      </span><span class=nt>serialNumber</span><span class=p>:</span><span class=w> </span><span class=l>fa:3f:9a:5e:ac:47:ee:d1:91:a6:31:a7:43:6f:8a:7e:93:f7</span><span class=w>
</span><span class=w>  </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>Applied</span><span class=w>
</span></code></pre></div><p>The secrets listed in the status are only the internal backups maintained by the <code>cert-controller-manager</code>.
The actual secrets used by the <code>Certificate</code> objects are not listed, but nonetheless marked as revoked.</p></li></ol><h3 id=revoking-certificates-with-renewal>Revoking certificates with renewal</h3><p>With this variant the certificate is renewed, before the old one(s) are revoked. This means the
certificate secrets of the <code>Certificate</code> objects will contain newly requested certificates and
the old certificate(s) will be revoked afterwards.</p><p>For this purpose, set <code>renew: true</code> in the spec of the <code>CertificateRevocation</code> object:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CertificateRevocation</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>revoke-sample</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>certificateRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mycert</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>renew</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></code></pre></div><p>In this case, the status will list the <strong>renewed</strong> <code>Certificate</code> objects:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CertificateRevocation</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>revoke-sample</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>certificateRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mycert</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>renew</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>  </span><span class=nt>qualifyingDate</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2020-12-22T17:00:35Z&#34;</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>certificate renewed and old certificate(s) revoked</span><span class=w>
</span><span class=w>  </span><span class=nt>objects</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>renewed</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mycert</span><span class=w>
</span><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>revocationApplied</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2020-12-22T17:09:32Z&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>secrets</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>revoked</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cert-backup-default-issuer-8a7e93f7-sks7p</span><span class=w>
</span><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span><span class=w>      </span><span class=nt>serialNumber</span><span class=p>:</span><span class=w> </span><span class=l>fa:3f:9a:5e:ac:47:ee:d1:91:a6:31:a7:43:6f:8a:7e:93:f7</span><span class=w>
</span><span class=w>  </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>Applied</span><span class=w>
</span></code></pre></div><h3 id=checking-ocsp-revocation-using-openssl>Checking OCSP revocation using OpenSSL</h3><p>To verify the OCSP revocation of the X509 certificate of a <code>Certificate</code> object,
you can use the tool <code>hack/check-cert-secret.sh</code> in this repository.</p><p>Usage:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>hack/check-cert-secret.sh check-revoke mynamespace mycertname
</code></pre></div><p>Here <em>mynamespace</em> and <em>mycertname</em> are the namespace and the name of the certificate object.</p><h2 id=metrics>Metrics</h2><p>Metrics are exposed for Prometheus if the command line option <code>--server-port-http &lt;port></code> is specified.
The endpoint URL is <code>http://&lt;pod-ip>:&lt;port>/metrics</code>.
Besides the default Go metrics, the following cert-management specific metrics are provided:</p><table><thead><tr><th>Name</th><th>Labels</th><th>Description</th></tr></thead><tbody><tr><td>cert_management_acme_account_registrations</td><td>uri, email, issuer</td><td>ACME account registrations</td></tr><tr><td>cert_management_acme_orders</td><td>issuer, success, dns_challenges, renew</td><td>Number of ACME orders</td></tr><tr><td>cert_management_cert_entries</td><td>issuer, issuertype</td><td>Total number of certificate objects per issuer</td></tr><tr><td>cert_management_acme_active_dns_challenges</td><td>issuer</td><td>Currently active number of ACME DNS challenges</td></tr><tr><td>cert_management_overdue_renewal_certificates</td><td>-</td><td>Number of certificate objects with certificate&rsquo;s renewal overdue</td></tr><tr><td>cert_management_revoked_certificates</td><td>-</td><td>Number of certificate objects with revoked certificate</td></tr><tr><td>cert_management_secrets</td><td>classification</td><td>Number of certificate secrets per classification (only updated on startup and every 24h on GC of secrets). Currently there are three classifications: <code>total</code> = total number of certificate secrets on the source cluster, <code>revoked</code> = number of revoked certificate secrets, <code>backup</code>= number of backups of certificate secrets (every certificate has a backup secret in the <code>kube-system</code> namespace to allow revocation even if it is not used anymore)</td></tr></tbody></table><h2 id=development>Development</h2><p>For development it is recommended to use the issuer-staging</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a75c0886177a0c196a466456fce29eb6>1.5.3 - Network Policies</h1><h1 id=network-policies-in-gardener>Network Policies in Gardener</h1><p>As <code>Seed</code> clusters can host the <a href=https://kubernetes.io/docs/concepts/#kubernetes-control-plane>Kubernetes control planes</a> of many <code>Shoot</code> clusters, it is necessary to isolate the control planes from each other for security reasons.
Besides deploying each control plane in its own namespace, Gardener creates <a href=https://kubernetes.io/docs/concepts/services-networking/network-policies/>network policies</a> to also isolate the networks.
Essentially, network policies make sure that pods can only talk to other pods over the network they are supposed to.
As such, network policies are an important part of Gardener&rsquo;s tenant isolation.</p><p>Gardener deploys network policies into</p><ul><li>each namespace hosting the Kubernetes control plane of the Shoot cluster.</li><li>the namespace dedicated to Gardener seed-wide global controllers. This namespace is often called <code>garden</code> and contains e.g. the <a href=https://github.com/gardener/gardener/blob/15cae57db802cbe460ff4cb3f80c26b2fc15e26f/docs/concepts/gardenlet.md>Gardenlet</a>.</li><li>the <code>kube-system</code> namespace in the Shoot.</li></ul><p>The aforementioned namespaces in the Seed contain a <code>deny-all</code> network policy that <a href=https://kubernetes.io/docs/concepts/services-networking/network-policies/#default-deny-all-ingress-and-all-egress-traffic>denies all ingress and egress traffic</a>.
This <a href=https://en.wikipedia.org/wiki/Secure_by_default>secure by default</a> setting requires pods to allow network traffic.
This is done by pods having <a href=https://kubernetes.io/docs/concepts/services-networking/network-policies/#networkpolicy-resource>labels matching to the selectors of the network policies</a> deployed by Gardener.</p><p>More details on the deployed network policies can be found in the <a href=https://github.com/gardener/gardener/tree/master/docs/development/seed_network_policies.md>development</a> and <a href=https://github.com/gardener/gardener/tree/master/docs/usage/shoot_network_policies.md>usage</a> sections.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b6f565530e8766e44ba34b741790bee1>1.6 - Monitoring</h1></div><div class=td-content><h1 id=pg-0c6e77069792398b7fd6423c2bd460fa>1.6.1 - Alerting</h1><h1 id=alerting>Alerting</h1><p>Gardener uses <a href=https://prometheus.io/>Prometheus</a> to gather metrics from each component. A Prometheus is deployed in each shoot control plane (on the seed) which is responsible for gathering control plane and cluster metrics. Prometheus can be configured to fire alerts based on these metrics and send them to an <a href=https://prometheus.io/docs/alerting/alertmanager/>alertmanager</a>. The alertmanager is responsible for sending the alerts to users and operators. This document describes how to setup alerting for:</p><ul><li><a href=#Alerting-for-Users>end-users/stakeholders/customers</a></li><li><a href=#Alerting-for-Operators>operators/administrators</a></li></ul><h1 id=alerting-for-users>Alerting for Users</h1><p>To receive email alerts as a user set the following values in the shoot spec:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>monitoring</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>alerting</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>emailReceivers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>john.doe@example.com</span><span class=w>
</span></code></pre></div><p><code>emailReceivers</code> is a list of emails that will receive alerts if something is wrong with the shoot cluster. A list of alerts for users can be found <a href=/docs/concepts/monitoring/user_alerts>here</a>.</p><h1 id=alerting-for-operators>Alerting for Operators</h1><p>Currently, Gardener supports two options for alerting:</p><ul><li><a href=#Email-Alerting>Email Alerting</a></li><li><a href=#External-Alertmanager>Sending Alerts to an external alertmanager</a></li></ul><p>A list of operator alerts can be found <a href=/docs/concepts/monitoring/operator_alerts>here</a>.</p><h2 id=email-alerting>Email Alerting</h2><p>Gardener provides the option to deploy an alertmanager into each seed. This alertmanager is responsible for sending out alerts to operators for each shoot cluster in the seed. Only email alerts are supported by the alertmanager managed by Gardener. This is configurable by setting the Gardener controller manager configuration values <code>alerting</code>. See <a href=https://github.com/gardener/gardener/blob/master/docs/usage/configuration.md>this</a> on how to configure the Gardener&rsquo;s SMTP secret. If the values are set, a secret with the label <code>gardener.cloud/role: alerting</code> will be created in the garden namespace of the garden cluster. This secret will be used by each alertmanager in each seed.</p><h2 id=external-alertmanager>External Alertmanager</h2><p>The alertmanager supports different kinds of <a href=https://prometheus.io/docs/alerting/configuration/>alerting configurations</a>. The alertmanager provided by Gardener only supports email alerts. If email is not sufficient, then alerts can be sent to an external alertmanager. Prometheus will send alerts to a URL and then alerts will be handled by the external alertmanager. This external alertmanager is operated and configured by the operator (i.e. Gardener does not configure or deploy this alertmanager). To configure sending alerts to an external alertmanager, create a secret in the virtual garden cluster in the garden namespace with the label: <code>gardener.cloud/role: alerting</code>. This secret needs to contain a URL to the external alertmanager and information regarding authentication. Supported authentication types are:</p><ul><li>No Authentication (none)</li><li>Basic Authentication (basic)</li><li>Mutual TLS (certificate)</li></ul><h3 id=remote-alertmanager-examples>Remote Alertmanager Examples</h3><p>Note: the <code>url</code> value cannot be prepended with <code>http</code> or <code>https</code>.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=c># No Authentication</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>gardener.cloud/role</span><span class=p>:</span><span class=w> </span><span class=l>alerting</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alerting-auth</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># No Authentication</span><span class=w>
</span><span class=w>  </span><span class=nt>auth_type</span><span class=p>:</span><span class=w> </span><span class=l>base64(none)</span><span class=w>
</span><span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>base64(external.alertmanager.foo)</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># Basic Auth</span><span class=w>
</span><span class=w>  </span><span class=nt>auth_type</span><span class=p>:</span><span class=w> </span><span class=l>base64(basic)</span><span class=w>
</span><span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>base64(extenal.alertmanager.foo)</span><span class=w>
</span><span class=w>  </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>base64(admin)</span><span class=w>
</span><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>base64(password)</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># Mutual TLS</span><span class=w>
</span><span class=w>  </span><span class=nt>auth_type</span><span class=p>:</span><span class=w> </span><span class=l>base64(certificate)</span><span class=w>
</span><span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>base64(external.alertmanager.foo)</span><span class=w>
</span><span class=w>  </span><span class=nt>ca.crt</span><span class=p>:</span><span class=w> </span><span class=l>base64(ca)</span><span class=w>
</span><span class=w>  </span><span class=nt>tls.crt</span><span class=p>:</span><span class=w> </span><span class=l>base64(certificate)</span><span class=w>
</span><span class=w>  </span><span class=nt>tls.key</span><span class=p>:</span><span class=w> </span><span class=l>base64(key)</span><span class=w>
</span><span class=w>  </span><span class=nt>insecure_skip_verify</span><span class=p>:</span><span class=w> </span><span class=l>base64(false)</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># Email Alerts (internal alertmanager)</span><span class=w>
</span><span class=w>  </span><span class=nt>auth_type</span><span class=p>:</span><span class=w> </span><span class=l>base64(smtp)</span><span class=w>
</span><span class=w>  </span><span class=nt>auth_identity</span><span class=p>:</span><span class=w> </span><span class=l>base64(internal.alertmanager.auth_identity)</span><span class=w>
</span><span class=w>  </span><span class=nt>auth_password</span><span class=p>:</span><span class=w> </span><span class=l>base64(internal.alertmanager.auth_password)</span><span class=w>
</span><span class=w>  </span><span class=nt>auth_username</span><span class=p>:</span><span class=w> </span><span class=l>base64(internal.alertmanager.auth_username)</span><span class=w>
</span><span class=w>  </span><span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=l>base64(internal.alertmanager.from)</span><span class=w>
</span><span class=w>  </span><span class=nt>smarthost</span><span class=p>:</span><span class=w> </span><span class=l>base64(internal.alertmanager.smarthost)</span><span class=w>
</span><span class=w>  </span><span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=l>base64(internal.alertmanager.to)</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></code></pre></div><h3 id=configuring-your-external-alertmanager>Configuring your External Alertmanager</h3><p>Please refer to the <a href=https://prometheus.io/docs/alerting/alertmanager/>alertmanager</a> documentation on how to configure an alertmanager.</p><p>We recommend you use at least the following inhibition rules in your alertmanager configuration to prevent excessive alerts:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>inhibit_rules</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=c># Apply inhibition if the alert name is the same.</span><span class=w>
</span><span class=w></span>- <span class=nt>source_match</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>critical</span><span class=w>
</span><span class=w>  </span><span class=nt>target_match</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>warning</span><span class=w>
</span><span class=w>  </span><span class=nt>equal</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;alertname&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;service&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;cluster&#39;</span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># Stop all alerts for type=shoot if there are VPN problems.</span><span class=w>
</span><span class=w></span>- <span class=nt>source_match</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>vpn</span><span class=w>
</span><span class=w>  </span><span class=nt>target_match_re</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot</span><span class=w>
</span><span class=w>  </span><span class=nt>equal</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;cluster&#39;</span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># Stop warning and critical alerts if there is a blocker</span><span class=w>
</span><span class=w></span>- <span class=nt>source_match</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>blocker</span><span class=w>
</span><span class=w>  </span><span class=nt>target_match_re</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>^(critical|warning)$</span><span class=w>
</span><span class=w>  </span><span class=nt>equal</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;cluster&#39;</span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># If the API server is down inhibit no worker nodes alert. No worker nodes depends on kube-state-metrics which depends on the API server.</span><span class=w>
</span><span class=w></span>- <span class=nt>source_match</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>kube-apiserver</span><span class=w>
</span><span class=w>  </span><span class=nt>target_match_re</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>nodes</span><span class=w>
</span><span class=w>  </span><span class=nt>equal</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;cluster&#39;</span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># If API server is down inhibit kube-state-metrics alerts.</span><span class=w>
</span><span class=w></span>- <span class=nt>source_match</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>kube-apiserver</span><span class=w>
</span><span class=w>  </span><span class=nt>target_match_re</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>info</span><span class=w>
</span><span class=w>  </span><span class=nt>equal</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;cluster&#39;</span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># No Worker nodes depends on kube-state-metrics. Inhibit no worker nodes if kube-state-metrics is down.</span><span class=w>
</span><span class=w></span>- <span class=nt>source_match</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>kube-state-metrics-shoot</span><span class=w>
</span><span class=w>  </span><span class=nt>target_match_re</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>nodes</span><span class=w>
</span><span class=w>  </span><span class=nt>equal</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;cluster&#39;</span><span class=p>]</span><span class=w>
</span></code></pre></div><p>Below is a graph visualizing the inhibition rules:</p><p><img src=/__resources/alertInhibitionGraph_ceaef0.png alt=inhibitionGraph></p></div><div class=td-content style=page-break-before:always><h1 id=pg-1406dfb428177ab5bbfe86f9bd0ba930>1.6.2 - Extending the Monitoring Stack</h1><h1 id=extending-the-monitoring-stack>Extending the Monitoring Stack</h1><p>This document provides instructions to extend the Shoot cluster monitoring stack by integrating new scrape targets, alerts and dashboards.</p><p>Please ensure that you have understood the basic principles of <a href=https://prometheus.io/docs/introduction/overview/>Prometheus</a> and its ecosystem before you continue.</p><p>:bangbang: <strong>The purpose of the monitoring stack is to observe the behaviour of the control plane and the system components deployed by Gardener onto the worker nodes. Monitoring of custom workloads running in the cluster is out of scope.</strong></p><h2 id=overview>Overview</h2><p><img src=/__resources/monitoring-architecture_cd945d.png alt="Monitoring Architecture"></p><p>Each Shoot cluster comes with its own monitoring stack. The following components are deployed into the seed and shoot:</p><ul><li>Seed<ul><li><a href=https://github.com/prometheus/prometheus>Prometheus</a></li><li><a href=https://github.com/grafana/grafana>Grafana</a></li><li><a href=https://github.com/prometheus/blackbox_exporter>blackbox-exporter</a></li><li><a href=https://github.com/kubernetes/kube-state-metrics>kube-state-metrics</a> (Seed metrics)</li><li><a href=https://github.com/kubernetes/kube-state-metrics>kube-state-metrics</a> (Shoot metrics)</li><li><a href=https://github.com/prometheus/alertmanager>Alertmanager</a> (Optional)</li></ul></li><li>Shoot<ul><li><a href=https://github.com/prometheus/node_exporter>node-exporter(s)</a></li><li><a href=https://github.com/kubernetes/kube-state-metrics>kube-state-metrics</a></li><li><a href=https://github.com/prometheus/blackbox_exporter>blackbox-exporter</a></li></ul></li></ul><p>In each Seed cluster there is a Prometheus in the <code>garden</code> namespace responsible for collecting metrics from the Seed kubelets and cAdvisors. These metrics are provided to each Shoot Prometheus via federation.</p><p>The alerts for all Shoot clusters hosted on a Seed are routed to a central Alertmanger running in the <code>garden</code> namespace of the Seed. The purpose of this central alertmanager is to forward all important alerts to the operators of the Gardener setup.</p><p>The Alertmanager in the Shoot namespace on the Seed is only responsible for forwarding alerts from its Shoot cluster to a cluster owner/cluster alert receiver via email. The Alertmanager is optional and the conditions for a deployment are already described <a href=/docs/concepts/monitoring/alerting>here</a>.</p><h2 id=adding-new-monitoring-targets>Adding New Monitoring Targets</h2><p>After exploring the metrics which your component provides or adding new metrics, you should be aware which metrics are required to write the needed alerts and dashboards.</p><p>Prometheus prefers a pull based metrics collection approach and therefore the targets to observe need to be defined upfront. The targets are defined in <code>charts/seed-monitoring/charts/prometheus/templates/config.yaml</code>.
New scrape jobs can be added in the section <code>scrape_configs</code>. Detailed information how to configure scrape jobs and how to use the kubernetes service discovery are available in the <a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config>Prometheus documentation</a>.</p><p>The <code>job_name</code> of a scrape job should be the name of the component e.g. <code>kube-apiserver</code> or <code>vpn</code>. The collection interval should be the default of <code>30s</code>. You do not need to specify this in the configuration.</p><p>Please do not ingest all metrics which are provided by a component. Rather collect only those metrics which are needed to define the alerts and dashboards (i.e. whitelist). This can be achieved by adding the following <code>metric_relabel_configs</code> statement to your scrape jobs (replace <code>exampleComponent</code> with component name).</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>    </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=l>example-component</span><span class=w>
</span><span class=w>      </span><span class=l>...</span><span class=w>
</span><span class=w>      </span><span class=nt>metric_relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w></span>{{<span class=w> </span><span class=l>include &#34;prometheus.keep-metrics.metric-relabel-config&#34; .Values.allowedMetrics.exampleComponent | indent 6 }}</span><span class=w>
</span></code></pre></div><p>The whitelist for the metrics of your job can be maintained in <code>charts/seed-monitoring/charts/prometheus/values.yaml</code> in section <code>allowedMetrics.exampleComponent</code> (replace <code>exampleComponent</code> with component name). Check the following example:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>allowedMetrics</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>exampleComponent</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>*<span class=w> </span><span class=l>metrics_name_1</span><span class=w>
</span><span class=w>  </span>*<span class=w> </span><span class=l>metrics_name_2</span><span class=w>
</span><span class=w>  </span><span class=l>...</span><span class=w>
</span></code></pre></div><h2 id=adding-alerts>Adding Alerts</h2><p>The alert definitons are located in <code>charts/seed-monitoring/charts/prometheus/rules</code>. There are two approaches for adding new alerts.</p><ol><li>Adding additional alerts for a component which already has a set of alerts. In this case you have to extend the existing rule file for the component.</li><li>Adding alerts for a new component. In this case a new rule file with name scheme <code>example-component.rules.yaml</code> needs to be added.</li><li>Add the new alert to <code>alertInhibitionGraph.dot</code>, add any required inhibition flows and render the new graph. To render the graph run:</li></ol><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>dot -Tpng ./content/alertInhibitionGraph.dot -o ./content/alertInhibitionGraph.png
</code></pre></div><ol><li>Create a test for the new alert. See <code>Alert Tests</code>.</li></ol><p>Example alert:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>groups</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=nt>* name</span><span class=p>:</span><span class=w> </span><span class=l>example.rules</span><span class=w>
</span><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>* alert</span><span class=p>:</span><span class=w> </span><span class=l>ExampleAlert</span><span class=w>
</span><span class=w>    </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>absent(up{job=&#34;exampleJob&#34;} == 1)</span><span class=w>
</span><span class=w>    </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>20m</span><span class=w>
</span><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span><span class=w>      </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>critical</span><span class=w> </span><span class=c># How severe is the alert? (blocker|critical|info|warning)</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot</span><span class=w> </span><span class=c># For which topology is the alert relevant? (seed|shoot)</span><span class=w>
</span><span class=w>      </span><span class=nt>visibility</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w> </span><span class=c># Who should receive the alerts? (all|operator|owner)</span><span class=w>
</span><span class=w>    </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>A longer description of the example alert that should also explain the impact of the alert.</span><span class=w>
</span><span class=w>      </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=l>Short summary of an example alert.</span><span class=w>
</span></code></pre></div><p>If the deployment of component is optional then the alert definitions needs to be added to <code>charts/seed-monitoring/charts/prometheus/optional-rules</code> instead. Furthermore the alerts for component need to be activatable in <code>charts/seed-monitoring/charts/prometheus/values.yaml</code> via <code>rules.optional.example-component.enabled</code>. The default should be <code>true</code>.</p><p>Basic instruction how to define alert rules can be found in the <a href=https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules>Prometheus documentation</a>.</p><h3 id=routing-tree>Routing tree</h3><p>The Alertmanager is grouping incoming alerts based on labels into buckets. Each bucket has its own configuration like alert receivers, initial delaying duration or resending frequency etc. You can find more information about Alertmanager routing in the <a href=https://prometheus.io/docs/alerting/configuration/#route>Prometheus/Alertmanager documentation</a>. The routing trees for the Alertmanagers deployed by Gardener are depicted below.</p><p>Central Seed Alertmanager</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>∟ main route (all alerts for all shoots on the seed will enter)
  ∟ group by project and shoot name
    ∟ group by visibility &#34;all&#34; and &#34;operator&#34;
      ∟ group by severity &#34;blocker&#34;, &#34;critical&#34;, and &#34;info&#34; → route to Garden operators
      ∟ group by severity &#34;warning&#34; (dropped)
    ∟ group by visibility &#34;owner&#34; (dropped)
</code></pre></div><p>Shoot Alertmanager</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>∟ main route (only alerts for one Shoot will enter)
  ∟ group by visibility &#34;all&#34; and &#34;owner&#34;
    ∟ group by severity &#34;blocker&#34;, &#34;critical&#34;, and &#34;info&#34; → route to cluster alert receiver
    ∟ group by severity &#34;warning&#34; (dropped, will change soon → route to cluster alert receiver)
  ∟ group by visibility &#34;operator&#34; (dropped)
</code></pre></div><h3 id=alert-inhibition>Alert Inhibition</h3><p>All alerts related to components running on the Shoot workers are inhibited in case of an issue with the vpn connection, because those components can&rsquo;t be scraped anymore and Prometheus will fire alerts in consequence. The components running on the workers are probably healthy and the alerts are presumably false positives. The inhibition flow is shown in the figure below. If you add a new alert make sure to add it to the diagram.</p><p><img src=/__resources/alertInhibitionGraph_ceaef0.png alt=alertDiagram></p><h3 id=alert-attributes>Alert Attributes</h3><p>Each alert rule definition has to contain the following annotations:</p><ul><li><strong>summary</strong>: A short description of the issue.</li><li><strong>description</strong>: A detailed explanation of the issue with hints to the possible root causes and the impact assessment of the issue.</li></ul><p>In addtion each alert must contain the following labels:</p><ul><li><strong>type</strong><ul><li><code>shoot</code>: Components running on the Shoot worker nodes in the <code>kube-system</code> namespace.</li><li><code>seed</code>: Components running on the Seed in the Shoot namespace as part of/next to the control plane.</li></ul></li><li><strong>service</strong><ul><li>Name of the component (in lowercase) e.g. <code>kube-apiserver</code>, <code>alertmanager</code> or <code>vpn</code>.</li></ul></li><li><strong>severity</strong><ul><li><code>blocker</code>: All issues which make the cluster entirely unusable e.g. <code>KubeAPIServerDown</code> or <code>KubeSchedulerDown</code></li><li><code>critical</code>: All issues which affect single functionalities/components but not affect the cluster in its core functionality e.g. <code>VPNDown</code> or <code>KubeletDown</code>.</li><li><code>info</code>: All issues that do not affect the cluster or its core functionality, but if this component is down we cannot determine if a blocker alert is firing. (i.e. A component with an info level severity is a dependency for a component with a blocker severity)</li><li><code>warning</code>: No current existing issue, rather a hint for situations which could lead to real issue in the close future e.g. <code>HighLatencyApiServerToWorkers</code> or <code>ApiServerResponseSlow</code>.</li></ul></li></ul><h3 id=alert-tests>Alert Tests</h3><p>Execute the tests in <code>$GARDENERHOME/.ci/test</code> or if you want to only test the Prometheus alerts:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># Install promtool</span>
go get -u github.com/prometheus/prometheus/cmd/promtool

<span class=c1># Move to seed-monitoring/prometheus chart</span>
<span class=nb>cd</span> <span class=nv>$GARDENERHOME</span>/charts/seed-monitoring/charts/prometheus/

<span class=c1># Execute tests</span>
promtool <span class=nb>test</span> rules rules-tests/*test.yaml
</code></pre></div><p>If you want to add alert tests:</p><ol><li><p>Create a new file in <code>rules-tests</code> in the form <code>&lt;alert-group-name>.rules.test.yaml</code> or if the alerts are for an existing component with existing tests, simply add the tests to the appropriate files.</p></li><li><p>Make sure that newly added tests succeed. See above.</p></li></ol><h2 id=adding-grafana-dashboards>Adding Grafana Dashboards</h2><p>The dashboard definition files are located in <code>charts/seed-monitoring/charts/grafana/dashboards</code>. Every dashboard needs its own file.</p><p>If you are adding a new component dashboard please also update the overview dashboard by adding a chart for its current up/down status and with a drill down option to the component dashboard.</p><h3 id=dashboard-structure>Dashboard Structure</h3><p>The dashboards should be structured in the following way. The assignment of the component dashboards to the categories should be handled via dashboard tags.</p><ul><li>Kubernetes control plane components (Tag: <code>control-plane</code>)<ul><li>All components which are part of the Kubernetes control plane e. g. Kube API Server, Kube Controller Manager, Kube Scheduler and Cloud Controller Manager</li><li>ETCD + Backup/Restore</li><li>Kubernetes Addon Manager</li></ul></li><li>Node/Machine components (Tag: <code>node/machine</code>)<ul><li>All metrics which are related to the behaviour/control of the Kubernetes nodes and kubelets</li><li>Machine-Controller-Manager + Cluster Autoscaler</li></ul></li><li>Networking components (Tag: <code>network</code>)<ul><li>CoreDNS, KubeProxy, Calico, VPN, Nginx Ingress</li></ul></li><li>Addon components (Tag: <code>addon</code>)<ul><li>Cert Broker</li></ul></li><li>Monitoring components (Tag: <code>monitoring</code>)</li><li>Logging components (Tag: <code>logging</code>)</li></ul><h4 id=mandatory-charts-for-component-dashboards>Mandatory Charts for Component Dashboards</h4><p>For each new component, its corresponding dashboard should contain the following charts in the first row, before adding custom charts for the component in the subsequent rows.</p><ol><li>Pod up/down status <code>up{job="example-component"}</code></li><li>Pod/containers cpu utilization</li><li>Pod/containers memorty consumption</li><li>Pod/containers network i/o</li></ol><p>These information is provided by the cAdvisor metrics. These metrics are already integrated. Please check the other dashboards for detailed information on how to query.</p><h5 id=chart-requirements>Chart Requirements</h5><p>Each chart needs to contain:</p><ul><li>a meaningful name</li><li>a detailed description (for non trivial charts)</li><li>appropriate x/y axis descriptions</li><li>appropriate scaling levels for the x/y axis</li><li>proper units for the x/y axis</li></ul><h5 id=dashboard-parameters>Dashboard Parameters</h5><p>The following parameters should be added to all dashboards to ensure a homogeneous experience across all dashboards.</p><p>Dashboards have to &mldr;</p><ul><li>contain a title which refers to the component name(s)</li><li>contain a timezone statement which should be the browser time</li><li>contain tags which express where the component is running (<code>seed</code> or <code>shoot</code>) and to which category the component belong (see dashboard structure)</li><li>contain a version statement with a value of 1</li><li>be immutable</li></ul><p>Example dashboard configuration</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;example-component&#34;</span><span class=p>,</span>
  <span class=nt>&#34;timezone&#34;</span><span class=p>:</span> <span class=s2>&#34;utc&#34;</span><span class=p>,</span>
  <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=s2>&#34;seed&#34;</span><span class=p>,</span>
    <span class=s2>&#34;control-plane&#34;</span>
  <span class=p>],</span>
  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
  <span class=nt>&#34;editable&#34;</span><span class=p>:</span> <span class=s2>&#34;false&#34;</span>
<span class=p>}</span>
</code></pre></div><p>Furthermore all dashboards should contain the following time options:</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;time&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;from&#34;</span><span class=p>:</span> <span class=s2>&#34;now-1h&#34;</span><span class=p>,</span>
    <span class=nt>&#34;to&#34;</span><span class=p>:</span> <span class=s2>&#34;now&#34;</span>
  <span class=p>},</span>
  <span class=nt>&#34;timepicker&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;refresh_intervals&#34;</span><span class=p>:</span> <span class=p>[</span>
      <span class=s2>&#34;30s&#34;</span><span class=p>,</span>
      <span class=s2>&#34;1m&#34;</span><span class=p>,</span>
      <span class=s2>&#34;5m&#34;</span>
    <span class=p>],</span>
    <span class=nt>&#34;time_options&#34;</span><span class=p>:</span> <span class=p>[</span>
      <span class=s2>&#34;5m&#34;</span><span class=p>,</span>
      <span class=s2>&#34;15m&#34;</span><span class=p>,</span>
      <span class=s2>&#34;1h&#34;</span><span class=p>,</span>
      <span class=s2>&#34;6h&#34;</span><span class=p>,</span>
      <span class=s2>&#34;12h&#34;</span><span class=p>,</span>
      <span class=s2>&#34;24h&#34;</span><span class=p>,</span>
      <span class=s2>&#34;2d&#34;</span><span class=p>,</span>
      <span class=s2>&#34;10d&#34;</span>
    <span class=p>]</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-b04ae662aecbf6573fd2ed9736c0838c>1.6.3 - Operator Alerts</h1><h1 id=operator-alerts>Operator Alerts</h1><table><thead><tr><th>Alertname</th><th>Severity</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>ApiServerUnreachableViaKubernetesService</td><td>critical</td><td>shoot</td><td><code>The Api server has been unreachable for 3 minutes via the kubernetes service in the shoot.</code></td></tr><tr><td>CoreDNSDown</td><td>critical</td><td>shoot</td><td><code>CoreDNS could not be found. Cluster DNS resolution will not work.</code></td></tr><tr><td>ApiServerNotReachable</td><td>blocker</td><td>seed</td><td><code>API server not reachable via external endpoint: {{ $labels.instance }}.</code></td></tr><tr><td>KubeApiserverDown</td><td>blocker</td><td>seed</td><td><code>All API server replicas are down/unreachable, or all API server could not be found.</code></td></tr><tr><td>KubeApiServerTooManyAuditlogFailures</td><td>warning</td><td>seed</td><td><code>The API servers cumulative failure rate in logging audit events is greater than 2%.</code></td></tr><tr><td>KubeletTooManyOpenFileDescriptorsSeed</td><td>critical</td><td>seed</td><td><code>Seed-kubelet ({{ $labels.kubernetes_io_hostname }}) is using {{ $value }}% of the available file/socket descriptors. Kubelet could be under heavy load.</code></td></tr><tr><td>KubePersistentVolumeUsageCritical</td><td>critical</td><td>seed</td><td><code>The PersistentVolume claimed by {{ $labels.persistentvolumeclaim }} is only {{ printf "%0.2f" $value }}% free.</code></td></tr><tr><td>KubePersistentVolumeFullInFourDays</td><td>warning</td><td>seed</td><td><code>Based on recent sampling, the PersistentVolume claimed by {{ $labels.persistentvolumeclaim }} is expected to fill up within four days. Currently {{ printf "%0.2f" $value }}% is available.</code></td></tr><tr><td>KubePodPendingControlPlane</td><td>warning</td><td>seed</td><td><code>Pod {{ $labels.pod }} is stuck in "Pending" state for more than 30 minutes.</code></td></tr><tr><td>KubePodNotReadyControlPlane</td><td>warning</td><td></td><td><code>Pod {{ $labels.pod }} is not ready for more than 30 minutes.</code></td></tr><tr><td>KubeStateMetricsShootDown</td><td>info</td><td>seed</td><td><code>There are no running kube-state-metric pods for the shoot cluster. No kubernetes resource metrics can be scraped.</code></td></tr><tr><td>KubeStateMetricsSeedDown</td><td>critical</td><td>seed</td><td><code>There are no running kube-state-metric pods for the seed cluster. No kubernetes resource metrics can be scraped.</code></td></tr><tr><td>NoWorkerNodes</td><td>blocker</td><td></td><td><code>There are no worker nodes in the cluster or all of the worker nodes in the cluster are not schedulable.</code></td></tr><tr><td>PrometheusCantScrape</td><td>warning</td><td>seed</td><td><code>Prometheus failed to scrape metrics. Instance {{ $labels.instance }}, job {{ $labels.job }}.</code></td></tr><tr><td>PrometheusConfigurationFailure</td><td>warning</td><td>seed</td><td><code>Latest Prometheus configuration is broken and Prometheus is using the previous one.</code></td></tr><tr><td>VPNShootNoPods</td><td>critical</td><td>shoot</td><td><code>vpn-shoot deployment in Shoot cluster has 0 available pods. VPN won't work.</code></td></tr><tr><td>VPNProbeAPIServerProxyFailed</td><td>critical</td><td>shoot</td><td><code>The API Server proxy functionality is not working. Probably the vpn connection from an API Server pod to the vpn-shoot endpoint on the Shoot workers does not work.</code></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-4051cb1a57bd16135b400230dbdcd725>1.6.4 - User Alerts</h1><h1 id=user-alerts>User Alerts</h1><table><thead><tr><th>Alertname</th><th>Severity</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>ApiServerUnreachableViaKubernetesService</td><td>critical</td><td>shoot</td><td><code>The Api server has been unreachable for 3 minutes via the kubernetes service in the shoot.</code></td></tr><tr><td>CoreDNSDown</td><td>critical</td><td>shoot</td><td><code>CoreDNS could not be found. Cluster DNS resolution will not work.</code></td></tr><tr><td>ApiServerNotReachable</td><td>blocker</td><td>seed</td><td><code>API server not reachable via external endpoint: {{ $labels.instance }}.</code></td></tr><tr><td>KubeApiServerTooManyOpenFileDescriptors</td><td>warning</td><td>seed</td><td><code>The API server ({{ $labels.instance }}) is using {{ $value }}% of the available file/socket descriptors.</code></td></tr><tr><td>KubeApiServerTooManyOpenFileDescriptors</td><td>critical</td><td>seed</td><td><code>The API server ({{ $labels.instance }}) is using {{ $value }}% of the available file/socket descriptors.</code></td></tr><tr><td>KubeApiServerLatency</td><td>warning</td><td>seed</td><td><code>Kube API server latency for verb {{ $labels.verb }} is high. This could be because the shoot workers and the control plane are in different regions. 99th percentile of request latency is greater than 3 seconds.</code></td></tr><tr><td>KubeKubeletNodeDown</td><td>warning</td><td>shoot</td><td><code>The kubelet {{ $labels.instance }} has been unavailable/unreachable for more than 1 hour. Workloads on the affected node may not be schedulable.</code></td></tr><tr><td>KubeletTooManyOpenFileDescriptorsShoot</td><td>warning</td><td>shoot</td><td><code>Shoot-kubelet ({{ $labels.kubernetes_io_hostname }}) is using {{ $value }}% of the available file/socket descriptors. Kubelet could be under heavy load.</code></td></tr><tr><td>KubeletTooManyOpenFileDescriptorsShoot</td><td>critical</td><td>shoot</td><td><code>Shoot-kubelet ({{ $labels.kubernetes_io_hostname }}) is using {{ $value }}% of the available file/socket descriptors. Kubelet could be under heavy load.</code></td></tr><tr><td>KubePodPendingShoot</td><td>warning</td><td>shoot</td><td><code>Pod {{ $labels.pod }} is stuck in "Pending" state for more than 1 hour.</code></td></tr><tr><td>KubePodNotReadyShoot</td><td>warning</td><td>shoot</td><td><code>Pod {{ $labels.pod }} is not ready for more than 1 hour.</code></td></tr><tr><td>NoWorkerNodes</td><td>blocker</td><td></td><td><code>There are no worker nodes in the cluster or all of the worker nodes in the cluster are not schedulable.</code></td></tr><tr><td>NodeExporterDown</td><td>warning</td><td>shoot</td><td><code>The NodeExporter has been down or unreachable from Prometheus for more than 1 hour.</code></td></tr><tr><td>K8SNodeOutOfDisk</td><td>critical</td><td>shoot</td><td><code>Node {{ $labels.node }} has run out of disk space.</code></td></tr><tr><td>K8SNodeMemoryPressure</td><td>warning</td><td>shoot</td><td><code>Node {{ $labels.node }} is under memory pressure.</code></td></tr><tr><td>K8SNodeDiskPressure</td><td>warning</td><td>shoot</td><td><code>Node {{ $labels.node }} is under disk pressure</code></td></tr><tr><td>VMRootfsFull</td><td>critical</td><td>shoot</td><td><code>Root filesystem device on instance {{ $labels.instance }} is almost full.</code></td></tr><tr><td>VMConntrackTableFull</td><td>critical</td><td>shoot</td><td><code>The nf_conntrack table is {{ $value }}% full.</code></td></tr><tr><td>VPNProbeAPIServerProxyFailed</td><td>critical</td><td>shoot</td><td><code>The API Server proxy functionality is not working. Probably the vpn connection from an API Server pod to the vpn-shoot endpoint on the Shoot workers does not work.</code></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-26deb2ca59c11b2932b3fdb5483b284b>1.7 - Automatic Deployment of Gardenlets</h1><h1 id=automatic-deployment-of-gardenlets>Automatic Deployment of Gardenlets</h1><p>The gardenlet can automatically deploy itself into shoot clusters, and register this cluster as a seed cluster.
These clusters are called &ldquo;managed seeds&rdquo; (aka &ldquo;shooted seeds&rdquo;).
This procedure is the preferred way to add additional seed clusters, because shoot clusters already come with production-grade qualities that are also demanded for seed clusters.</p><h2 id=prerequisites>Prerequisites</h2><p>The only prerequisite is to register an initial cluster as a seed cluster that has already a gardenlet deployed:</p><ul><li>This gardenlet was either deployed as part of a Gardener installation using a setup tool (for example, <code>gardener/garden-setup</code>) or</li><li>the gardenlet was deployed manually<ul><li>for a step-by-step manual installation Guide see: <a href=/docs/concepts/deployment/deploy_gardenlet_manually>Deploy a Gardenlet Manually</a>)</li><li>for a Gardenlet deployment using an installation tool see: <a href=https://github.com/gardener/gardener/blob/master/landscaper/pkg/gardenlet/README.md>Gardenlet landscaper component</a>.</li></ul></li></ul><blockquote><p>The initial cluster can be the garden cluster itself.</p></blockquote><h2 id=self-deployment-of-gardenlets-in-additional-managed-seed-clusters>Self-Deployment of Gardenlets in Additional Managed Seed Clusters</h2><p>For a better scalability, you usually need more seed clusters that you can create as follows:</p><ol><li>Use the initial cluster as the seed cluster for other managed seed clusters. It hosts the control planes of the other seed clusters.</li><li>The gardenlet deployed in the initial cluster deploys itself automatically into the managed seed clusters.</li></ol><p>The advantage of this approach is that there’s only one initial gardenlet installation required. Every other managed seed cluster has a gardenlet deployed automatically.</p><h2 id=related-links>Related Links</h2><p><a href=https://github.com/gardener/gardener/blob/master/docs/usage/managed_seed.md>Register Shoot as Seed</a></p><p><a href=http://github.com/gardener/garden-setup>garden-setup</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-566780220a281acc818a995637105c5f>1.8 - Deploy a Gardenlet Manually</h1><h1 id=deploy-a-gardenlet-manually>Deploy a Gardenlet Manually</h1><p>Manually deploying a gardenlet is required in the following cases:</p><ul><li><p>The Kubernetes cluster to be registered as a seed cluster has no public endpoint,
because it is behind a firewall.
The gardenlet must then be deployed into the cluster itself.</p></li><li><p>The Kubernetes cluster to be registered as a seed cluster is managed externally
(the Kubernetes cluster is not a shoot cluster, so <a href=/docs/concepts/deployment/deploy_gardenlet_automatically>Automatic Deployment of Gardenlets</a> cannot be used).</p></li><li><p>The gardenlet runs outside of the Kubernetes cluster
that should be registered as a seed cluster.
(The gardenlet is not restricted to run in the seed cluster or
to be deployed into a Kubernetes cluster at all).</p></li></ul><blockquote><p>Once you’ve deployed a gardenlet manually, for example, behind a firewall, you can deploy new gardenlets automatically. The manually deployed gardenlet is then used as a template for the new gardenlets. More information: <a href=/docs/concepts/deployment/deploy_gardenlet_automatically>Automatic Deployment of Gardenlets</a>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><h3 id=kubernetes-cluster-that-should-be-registered-as-a-seed-cluster>Kubernetes cluster that should be registered as a seed cluster</h3><ul><li><p>Verify that the cluster has a <a href=https://github.com/gardener/gardener/blob/master/docs/usage/supported_k8s_versions.md>supported Kubernetes version</a>.</p></li><li><p>Determine the nodes, pods, and services CIDR of the cluster.
You need to configure this information in the <code>Seed</code> configuration.
Gardener uses this information to check that the shoot cluster isn’t created with overlapping CIDR ranges.</p></li><li><p>Every Seed cluster needs an Ingress controller which distributes external requests to internal components like grafana and prometheus. Gardener supports two approaches to achieve this:</p></li></ul><p>a. Gardener managed Ingress controller and DNS records. For this configure the following lines in your <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml>Seed resource</a>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>provider</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws-route53</span><span class=w>
</span><span class=w>      </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ingress-secret</span><span class=w>
</span><span class=w>        </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>domain</span><span class=p>:</span><span class=w> </span><span class=l>ingress.my-seed.example.com</span><span class=w>
</span><span class=w>    </span><span class=nt>controller</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>      </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=l>&lt;some-optional-provider-specific-config-for-the-ingressController&gt;</span><span class=w>
</span></code></pre></div><p>⚠ Please note that if you set <code>.spec.ingress</code> then <code>.spec.dns.ingressDomain</code> must be <code>nil</code>.</p><p>b. Self-managed DNS record and Ingress controller:</p><p>:warning:
There should exist a DNS record <code>*.ingress.&lt;SEED-CLUSTER-DOMAIN></code> where <code>&lt;SEED-CLUSTER-DOMAIN></code> is the value of the <code>.dns.ingressDomain</code> field of <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml>a Seed cluster resource</a> (or the <a href=https://github.com/gardener/gardener/blob/master/example/20-componentconfig-gardenlet.yaml#L84-L85>respective Gardenlet configuration</a>).</p><p><em>This is how it could be done for the Nginx ingress controller</em></p><p>Deploy nginx into the <code>kube-system</code> namespace in the Kubernetes cluster that should be registered as a <code>Seed</code>.</p><p>Nginx will on most cloud providers create the service with type <code>LoadBalancer</code> with an external ip.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>NAME                        TYPE           CLUSTER-IP    EXTERNAL-IP
nginx-ingress-controller    LoadBalancer   10.0.15.46    34.200.30.30
</code></pre></div><p>Create a wildcard <code>A</code> record (e.g *.ingress.sweet-seed.<my-domain>. IN A 34.200.30.30) with your DNS provider and point it to the external ip of the ingress service. This ingress domain is later required to register the <code>Seed</code> cluster.</p><p>Please configure the ingress domain in the <code>Seed</code> specification as follows:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>ingressDomain</span><span class=p>:</span><span class=w> </span><span class=l>ingress.sweet-seed.&lt;my-domain&gt;</span><span class=w>
</span></code></pre></div><p>⚠ Please note that if you set <code>.spec.dns.ingressDomain</code> then <code>.spec.ingress</code> must be <code>nil</code>.</p><h3 id=kubeconfig-for-the-seed-cluster><code>kubeconfig</code> for the Seed Cluster</h3><p>The <code>kubeconfig</code> is required to deploy the gardenlet Helm chart to the seed cluster.
The gardenlet requires certain privileges to be able to operate.
These privileges are described in RBAC resources in the gardenlet Helm chart (see <a href=https://github.com/gardener/gardener/tree/master/charts/gardener/gardenlet/charts/runtime/templates>charts/gardener/gardenlet/charts/runtime/templates</a>).
The Helm chart contains a service account <code>gardenlet</code>
that the gardenlet deployment uses by default to talk to the Seed API server.</p><blockquote><p>If the gardenlet isn’t deployed in the seed cluster,
the gardenlet can be configured to use a <code>kubeconfig</code>,
which also requires the above-mentioned privileges, from a mounted directory.
The <code>kubeconfig</code> is specified in section <code>seedClientConnection.kubeconfig</code>
of the <a href=https://github.com/gardener/gardener/blob/master/example/20-componentconfig-gardenlet.yaml>Gardenlet configuration</a>.
This configuration option isn’t used in the following,
as this procedure only describes the recommended setup option
where the gardenlet is running in the seed cluster itself.</p></blockquote><h2 id=procedure-overview>Procedure Overview</h2><ol><li><p>Prepare the garden cluster:</p><ol><li><a href=#create-a-bootstrap-token-secret-in-the-kube-system-namespace-of-the-garden-cluster>Create a bootstrap token secret in the <code>kube-system</code> namespace of the garden cluster</a></li><li><a href=#create-rbac-roles-for-the-gardenlet-to-allow-bootstrapping-in-the-garden-cluster>Create RBAC roles for the gardenlet to allow bootstrapping in the garden cluster</a></li></ol></li><li><p><a href=#prepare-the-gardenlet-helm-chart>Prepare the gardenlet Helm chart</a>.</p></li><li><p><a href=#automatically-register-shoot-cluster-as-a-seed-cluster>Automatically register shoot cluster as a seed cluster</a>.</p></li><li><p><a href=#deploy-the-gardenlet>Deploy the gardenlet</a></p></li><li><p><a href=#check-that-the-gardenlet-is-successfully-deployed>Check that the gardenlet is successfully deployed</a></p></li></ol><h2 id=create-a-bootstrap-token-secret-in-the-kube-system-namespace-of-the-garden-cluster>Create a bootstrap token secret in the <code>kube-system</code> namespace of the garden cluster</h2><p>The gardenlet needs to talk to the <a href=/docs/concepts/core-components/api-server>Gardener API server</a> residing in the garden cluster.</p><p>The gardenlet can be configured with an already existing garden cluster <code>kubeconfig</code> in one of the following ways:</p><ul><li><p>Either by specifying <code>gardenClientConnection.kubeconfig</code>
in the <a href=https://github.com/gardener/gardener/blob/master/example/20-componentconfig-gardenlet.yaml>Gardenlet configuration</a> or</p></li><li><p>by supplying the environment variable <code>GARDEN_KUBECONFIG</code> pointing to
a mounted <code>kubeconfig</code> file).</p></li></ul><p>The preferred way however, is to use the gardenlets ability to request
a signed certificate for the garden cluster by leveraging
<a href=https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/>Kubernetes Certificate Signing Requests</a>.
The gardenlet performs a TLS bootstrapping process that is similar to the
<a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/>Kubelet TLS Bootstrapping</a>.
Make sure that the API server of the garden cluster has
<a href=https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/#enabling-bootstrap-token-authentication>bootstrap token authentication</a>
enabled.</p><p>The client credentials required for the gardenlets TLS bootstrapping process,
need to be either <code>token</code> or <code>certificate</code> (OIDC isn’t supported) and have permissions
to create a Certificate Signing Request (<a href=https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/>CSR</a>).
It’s recommended to use <a href=https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/>bootstrap tokens</a>
due to their desirable security properties (such as a limited token lifetime).</p><p>Therefore, first create a bootstrap token secret for the garden cluster:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># Name MUST be of form &#34;bootstrap-token-&lt;token id&gt;&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>bootstrap-token-07401b</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># Type MUST be &#39;bootstrap.kubernetes.io/token&#39;</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>bootstrap.kubernetes.io/token</span><span class=w>
</span><span class=w></span><span class=nt>stringData</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># Human readable description. Optional.</span><span class=w>
</span><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Token to be used by the gardenlet for Seed `sweet-seed`.&#34;</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># Token ID and secret. Required.</span><span class=w>
</span><span class=w>  </span><span class=nt>token-id</span><span class=p>:</span><span class=w> </span><span class=l>07401b</span><span class=w> </span><span class=c># 6 characters</span><span class=w>
</span><span class=w>  </span><span class=nt>token-secret</span><span class=p>:</span><span class=w> </span><span class=l>f395accd246ae52d</span><span class=w> </span><span class=c># 16 characters</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># Expiration. Optional.</span><span class=w>
</span><span class=w>  </span><span class=c># expiration: 2017-03-10T03:22:11Z</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># Allowed usages.</span><span class=w>
</span><span class=w>  </span><span class=nt>usage-bootstrap-authentication</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>usage-bootstrap-signing</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></code></pre></div><p>When you later prepare the gardenlet Helm chart,
a <code>kubeconfig</code> based on this token is shared with the gardenlet upon deployment.</p><h2 id=create-rbac-roles-for-the-gardenlet-to-allow-bootstrapping-in-the-garden-cluster>Create RBAC roles for the gardenlet to allow bootstrapping in the garden cluster</h2><p>This step is only required if the gardenlet you deploy is the first gardenlet
in the Gardener installation.
Additionally, when using the <a href=https://github.com/gardener/gardener/tree/master/charts/gardener/controlplane>control plane chart</a>,
the following resources are already contained in the Helm chart,
that is, if you use it you can skip these steps as the needed RBAC roles already exist.</p><p>The gardenlet uses the configured bootstrap <code>kubeconfig</code> in <code>gardenClientConnection.bootstrapKubeconfig</code> to request a signed certificate for the user <code>gardener.cloud:system:seed:&lt;seed-name></code> in the group <code>gardener.cloud:system:seeds</code>.</p><p>Create a <code>ClusterRole</code> and <code>ClusterRoleBinding</code> that grant full admin permissions to authenticated gardenlets.</p><p>Create the following resources in the garden cluster:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener.cloud:system:seeds</span><span class=w>
</span><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener.cloud:system:seeds</span><span class=w>
</span><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener.cloud:system:seeds</span><span class=w>
</span><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener.cloud:system:seeds</span><span class=w>
</span><span class=w>    </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener.cloud:system:seed-bootstrapper</span><span class=w>
</span><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>certificates.k8s.io</span><span class=w>
</span><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>certificatesigningrequests</span><span class=w>
</span><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>create</span><span class=w>
</span><span class=w>      </span>- <span class=l>get</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>certificates.k8s.io</span><span class=w>
</span><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>certificatesigningrequests/seedclient</span><span class=w>
</span><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>create</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=c># A kubelet/gardenlet authenticating using bootstrap tokens is authenticated as a user in the group system:bootstrappers</span><span class=w>
</span><span class=w></span><span class=c># Allows the Gardenlet to create a CSR</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener.cloud:system:seed-bootstrapper</span><span class=w>
</span><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener.cloud:system:seed-bootstrapper</span><span class=w>
</span><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrappers</span><span class=w>
</span><span class=w>    </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></code></pre></div><p>ℹ️ After bootstrapping, the gardenlet has full administrative access to the garden cluster.
You might be interested to harden this and limit its permissions to only resources related to the seed cluster it is responsible for.
Please take a look into <a href=https://github.com/gardener/gardener/blob/master/docs/deployment/gardenlet_api_access.md>this document</a>.</p><h2 id=prepare-the-gardenlet-helm-chart>Prepare the gardenlet Helm chart</h2><p>This section only describes the minimal configuration,
using the global configuration values of the gardenlet Helm chart.
For an overview over all values, see the <a href=https://github.com/gardener/gardener/blob/master/charts/gardener/gardenlet/values.yaml>configuration values</a>.
We refer to the global configuration values as <em>gardenlet configuration</em> in the remaining procedure.</p><ol><li><p>Create a gardenlet configuration <code>gardenlet-values.yaml</code> based on <a href=https://github.com/gardener/gardener/blob/master/charts/gardener/gardenlet/values.yaml>this template</a>.</p></li><li><p>Create a bootstrap <code>kubeconfig</code> based on the bootstrap token created in the garden cluster.</p><p>Replace the <code>&lt;bootstrap-token></code> with <code>token-id.token-secret</code> (from our previous example: <code>07401b.f395accd246ae52d</code>) from the bootstrap token secret.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-bootstrap@default</span><span class=w>
</span><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>certificate-authority-data</span><span class=p>:</span><span class=w> </span><span class=l>&lt;ca-of-garden-cluster&gt;</span><span class=w>
</span><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://&lt;endpoint-of-garden-cluster&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-bootstrap</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-bootstrap@default</span><span class=w>
</span><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-bootstrap</span><span class=w>
</span><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>&lt;bootstrap-token&gt;</span><span class=w>
</span></code></pre></div></li><li><p>In section <code>gardenClientConnection.bootstrapKubeconfig</code> of your gardenlet configuration, provide the bootstrap <code>kubeconfig</code> together with a name and namespace to the gardenlet Helm chart.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>gardenClientConnection</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>bootstrapKubeconfig</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-kubeconfig-bootstrap</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>    </span><span class=nt>kubeconfig</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>      </span><span class=w>      </span><span class=l>&lt;bootstrap-kubeconfig&gt; </span><span class=w> </span><span class=c># will be base64 encoded by helm</span><span class=w>
</span></code></pre></div><p>The bootstrap <code>kubeconfig</code> is stored in the specified secret.</p></li><li><p>In section <code>gardenClientConnection.kubeconfigSecret</code> of your gardenlet configuration,
define a name and a namespace where the gardenlet stores
the real <code>kubeconfig</code> that it creates during the bootstrap process. If the secret doesn&rsquo;t exist,
the gardenlet creates it for you.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>gardenClientConnection</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>kubeconfigSecret</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-kubeconfig</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span></code></pre></div></li></ol><h2 id=automatically-register-shoot-cluster-as-a-seed-cluster>Automatically register shoot cluster as a seed cluster</h2><p>A seed cluster can either be registered by manually creating
the <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml><code>Seed</code> resource</a>
or automatically by the gardenlet.
This functionality is useful for managed seed clusters,
as the gardenlet in the garden cluster deploys a copy of itself
into the cluster with automatic registration of the <code>Seed</code> configured.
However, it can also be used to have a streamlined seed cluster registration process when manually deploying the gardenlet.</p><blockquote><p>This procedure doesn’t describe all the possible configurations
for the <code>Seed</code> resource. For more information, see:</p><ul><li><a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml>Example Seed resource</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/usage/seed_settings.md>Configurable Seed settings</a>.</li></ul></blockquote><h3 id=adjust-the-gardenlet-component-configuration>Adjust the gardenlet component configuration</h3><ol><li><p>Supply the <code>Seed</code> resource in section <code>seedConfig</code> of your gardenlet configuration <code>gardenlet-values.yaml</code>.</p></li><li><p>Add the <code>seedConfig</code> to your gardenlet configuration <code>gardenlet-values.yaml</code>.
The field <code>seedConfig.spec.provider.type</code> specifies the infrastructure provider type (for example, <code>aws</code>) of the seed cluster.
For all supported infrastructure providers, see <a href=https://github.com/gardener/gardener/blob/master/extensions/README.md#known-extension-implementations>Known Extension Implementations</a>.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>...</span><span class=l>.</span><span class=w>
</span><span class=w></span><span class=nt>seedConfig</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sweet-seed</span><span class=w>
</span><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>ingressDomain</span><span class=p>:</span><span class=w> </span><span class=l>ingress.sweet-seed.&lt;my-domain&gt;</span><span class=w> </span><span class=c># see prerequisites</span><span class=w>
</span><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w> </span><span class=c># see prerequisites</span><span class=w>
</span><span class=w>      </span><span class=nt>nodes</span><span class=p>:</span><span class=w> </span><span class=m>10.240.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>      </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=m>100.244.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>      </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=m>100.32.0.0</span><span class=l>/13</span><span class=w>
</span><span class=w>      </span><span class=nt>shootDefaults: # optional</span><span class=p>:</span><span class=w> </span><span class=l>non-overlapping default CIDRs for shoot clusters of that Seed</span><span class=w>
</span><span class=w>        </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=m>100.96.0.0</span><span class=l>/11</span><span class=w>
</span><span class=w>        </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=m>100.64.0.0</span><span class=l>/13</span><span class=w>
</span><span class=w>    </span><span class=nt>provider</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>&lt;provider&gt;</span><span class=w>
</span></code></pre></div></li></ol><h3 id=optional-enable-backup-and-restore>Optional: Enable backup and restore</h3><p>The seed cluster can be set up with backup and restore
for the main <code>etcds</code> of shoot clusters.</p><p>Gardener uses <a href=https://github.com/gardener/etcd-backup-restore>etcd-backup-restore</a>
that <a href=https://github.com/gardener/etcd-backup-restore/blob/master/doc/usage/getting_started.md#usage>integrates with different storage providers</a>
to store the shoot cluster&rsquo;s main <code>etcd</code> backups.
Make sure to obtain client credentials that have sufficient permissions with the chosen storage provider.</p><p>Create a secret in the garden cluster with client credentials for the storage provider.
The format of the secret is cloud provider specific and can be found
in the repository of the respective Gardener extension.
For example, the secret for AWS S3 can be found in the AWS provider extension
(<a href=https://github.com/gardener/gardener-extension-provider-aws/blob/master/example/30-etcd-backup-secret.yaml>30-etcd-backup-secret.yaml</a>).</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sweet-seed-backup</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># client credentials format is provider specific</span><span class=w>
</span></code></pre></div><p>Configure the <code>Seed</code> resource in section <code>seedConfig</code> of your gardenlet configuration to use backup and restore:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>seedConfig</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sweet-seed</span><span class=w>
</span><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>backup</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>provider</span><span class=p>:</span><span class=w> </span><span class=l>&lt;provider&gt;</span><span class=w>
</span><span class=w>      </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sweet-seed-backup</span><span class=w>
</span><span class=w>        </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span></code></pre></div><h2 id=deploy-the-gardenlet>Deploy the gardenlet</h2><blockquote><p>The gardenlet doesn’t have to run in the same Kubernetes cluster as the seed cluster
it’s registering and reconciling, but it is in most cases advantageous
to use in-cluster communication to talk to the Seed API server.
Running a gardenlet outside of the cluster is mostly used for local development.</p></blockquote><p>The <code>gardenlet-values.yaml</code> looks something like this
(with automatic Seed registration and backup for shoot clusters enabled):</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>global</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># Gardenlet configuration values</span><span class=w>
</span><span class=w>  </span><span class=nt>gardenlet</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=l>...</span><span class=w>
</span><span class=w>    </span><span class=l>&lt;default config&gt;</span><span class=w>
</span><span class=w>    </span><span class=l>...</span><span class=w>
</span><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>gardenClientConnection</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=l>...</span><span class=w>
</span><span class=w>        </span><span class=nt>bootstrapKubeconfig</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-bootstrap-kubeconfig</span><span class=w>
</span><span class=w>          </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>          </span><span class=nt>kubeconfig</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>            apiVersion: v1
</span><span class=sd>            clusters:
</span><span class=sd>            - cluster:
</span><span class=sd>                certificate-authority-data: &lt;dummy&gt;
</span><span class=sd>                server: &lt;my-garden-cluster-endpoint&gt;
</span><span class=sd>              name: my-kubernetes-cluster
</span><span class=sd>            ....</span><span class=w>            
</span><span class=w>
</span><span class=w>        </span><span class=nt>kubeconfigSecret</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-kubeconfig</span><span class=w>
</span><span class=w>          </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>      </span><span class=l>...</span><span class=w>
</span><span class=w>      </span><span class=l>&lt;default config&gt;</span><span class=w>
</span><span class=w>      </span><span class=l>...</span><span class=w>
</span><span class=w>      </span><span class=nt>seedConfig</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sweet-seed</span><span class=w>
</span><span class=w>        </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>ingressDomain</span><span class=p>:</span><span class=w> </span><span class=l>ingress.sweet-seed.&lt;my-domain&gt;</span><span class=w>
</span><span class=w>          </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>nodes</span><span class=p>:</span><span class=w> </span><span class=m>10.240.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>            </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=m>100.244.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>            </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=m>100.32.0.0</span><span class=l>/13</span><span class=w>
</span><span class=w>            </span><span class=nt>shootDefaults</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=m>100.96.0.0</span><span class=l>/11</span><span class=w>
</span><span class=w>              </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=m>100.64.0.0</span><span class=l>/13</span><span class=w>
</span><span class=w>          </span><span class=nt>provider</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>&lt;provider&gt;</span><span class=w>
</span><span class=w>          </span><span class=nt>backup</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>provider</span><span class=p>:</span><span class=w> </span><span class=l>&lt;provider&gt;</span><span class=w>
</span><span class=w>            </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sweet-seed-backup</span><span class=w>
</span><span class=w>              </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span></code></pre></div><p>Deploy the gardenlet Helm chart to the Kubernetes cluster.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>helm install gardenlet charts/gardener/gardenlet <span class=se>\
</span><span class=se></span>  --namespace garden <span class=se>\
</span><span class=se></span>  -f gardenlet-values.yaml <span class=se>\
</span><span class=se></span>  --wait
</code></pre></div><p>This helm chart creates:</p><ul><li>A service account <code>gardenlet</code> that the gardenlet can use to talk to the Seed API server.</li><li>RBAC roles for the service account (full admin rights at the moment).</li><li>The secret (<code>garden</code>/<code>gardenlet-bootstrap-kubeconfig</code>) containing the bootstrap <code>kubeconfig</code>.</li><li>The gardenlet deployment in the <code>garden</code> namespace.</li></ul><h2 id=check-that-the-gardenlet-is-successfully-deployed>Check that the gardenlet is successfully deployed</h2><ol><li><p>Check that the gardenlets certificate bootstrap was successful.</p><p>Check if the secret <code>gardenlet-kubeconfig</code> in the namespace <code>garden</code> in the seed cluster
is created and contains a <code>kubeconfig</code> with a valid certificate.</p><ol><li><p>Get the <code>kubeconfig</code> from the created secret.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl -n garden get secret gardenlet-kubeconfig -o json | jq -r .data.kubeconfig | base64 -d
</code></pre></div></li><li><p>Test against the garden cluster and verify it’s working.</p></li><li><p>Extract the <code>client-certificate-data</code> from the user <code>gardenlet</code>.</p></li><li><p>View the certificate:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ openssl x509 -in ./gardenlet-cert -noout -text
</code></pre></div><p>Check that the certificate is valid for a year (that is the lifetime of new certificates).</p></li></ol></li><li><p>Check that the bootstrap secret <code>gardenlet-bootstrap-kubeconfig</code> has been deleted from the seed cluster in namespace <code>garden</code>.</p></li><li><p>Check that the seed cluster is registered and <code>READY</code> in the garden cluster.</p><p>Check that the seed cluster <code>sweet-seed</code> exists and all conditions indicate that it’s available.
If so, the <a href=https://github.com/gardener/gardener/blob/master/docs/concepts/gardenlet.md#heartbeats>Gardenlet is sending regular heartbeats</a> and the <a href=https://github.com/gardener/gardener/blob/master/docs/usage/seed_bootstrapping.md>seed bootstrapping</a> was successful.</p><p>Check that the conditions on the <code>Seed</code> resource look similar to the following:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl get seed sweet-seed -o json <span class=p>|</span> jq .status.conditions
<span class=o>[</span>
  <span class=o>{</span>
    <span class=s2>&#34;lastTransitionTime&#34;</span>: <span class=s2>&#34;2020-07-17T09:17:29Z&#34;</span>,
    <span class=s2>&#34;lastUpdateTime&#34;</span>: <span class=s2>&#34;2020-07-17T09:17:29Z&#34;</span>,
    <span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Gardenlet is posting ready status.&#34;</span>,
    <span class=s2>&#34;reason&#34;</span>: <span class=s2>&#34;GardenletReady&#34;</span>,
    <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;True&#34;</span>,
    <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;GardenletReady&#34;</span>
  <span class=o>}</span>,
  <span class=o>{</span>
    <span class=s2>&#34;lastTransitionTime&#34;</span>: <span class=s2>&#34;2020-07-17T09:17:49Z&#34;</span>,
    <span class=s2>&#34;lastUpdateTime&#34;</span>: <span class=s2>&#34;2020-07-17T09:53:17Z&#34;</span>,
    <span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Seed cluster has been bootstrapped successfully.&#34;</span>,
    <span class=s2>&#34;reason&#34;</span>: <span class=s2>&#34;BootstrappingSucceeded&#34;</span>,
    <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;True&#34;</span>,
    <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;Bootstrapped&#34;</span>
  <span class=o>}</span>,
  <span class=o>{</span>
    <span class=s2>&#34;lastTransitionTime&#34;</span>: <span class=s2>&#34;2020-07-17T09:17:49Z&#34;</span>,
    <span class=s2>&#34;lastUpdateTime&#34;</span>: <span class=s2>&#34;2020-07-17T09:53:17Z&#34;</span>,
    <span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Backup Buckets are available.&#34;</span>,
    <span class=s2>&#34;reason&#34;</span>: <span class=s2>&#34;BackupBucketsAvailable&#34;</span>,
    <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;True&#34;</span>,
    <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;BackupBucketsReady&#34;</span>
  <span class=o>}</span>
<span class=o>]</span>
</code></pre></div></li></ol><h2 id=related-links>Related Links</h2><p><a href=https://github.com/gardener/gardener/issues/1724>Issue #1724: Harden Gardenlet RBAC privileges</a>.</p><p><a href=/docs/concepts/backup-restore/backup-restore>Backup and Restore</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9d30c33ec08641043d73ce34a3bc94b2>1.9 - Deploying Gardenlets</h1><h1 id=deploying-gardenlets>Deploying Gardenlets</h1><p>Gardenlets act as decentral &ldquo;agents&rdquo; to manage shoot clusters of a seed cluster.</p><p>To support scaleability in an automated way, gardenlets are deployed automatically. However, you can still deploy gardenlets manually to be more flexible, for example, when shoot clusters that need to be managed by Gardener are behind a firewall. The gardenlet only requires network connectivity from the gardenlet to the Garden cluster (not the other way round), so it can be used to register Kubernetes clusters with no public endpoint.</p><h2 id=procedure>Procedure</h2><ol><li><p>First, an initial gardenlet needs to be deployed:</p><ul><li>Deploy it manually if you have special requirements. More information: <a href=/docs/concepts/deployment/deploy_gardenlet_manually>Deploy a Gardenlet Manually</a></li><li>Let the Gardener installer deploy it automatically otherwise. More information: <a href=/docs/concepts/deployment/deploy_gardenlet_automatically>Automatic Deployment of Gardenlets</a></li></ul></li><li><p>To add additional seed clusters, it is recommended to use regular shoot clusters. You can do this by creating a <code>ManagedSeed</code> resource with a <code>gardenlet</code> section as described in <a href=https://github.com/gardener/gardener/blob/master/docs/usage/managed_seed.md>Register Shoot as Seed</a>.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-3a92a2153bb9d34c18d69a4d9aea5e04>1.10 - Deploying the Gardener into a Kubernetes cluster</h1><h1 id=deploying-the-gardener-into-a-kubernetes-cluster>Deploying the Gardener into a Kubernetes cluster</h1><p>Similar to Kubernetes, Gardener consists out of control plane components (Gardener API server, Gardener controller manager, Gardener scheduler), and an agent component (Gardenlet).
The control plane is deployed in the so-called garden cluster while the agent is installed into every seed cluster.
Please note that it is possible to use the garden cluster as seed cluster by simply deploying the Gardenlet into it.</p><p>We are providing <a href=https://github.com/gardener/gardener/tree/master/charts/gardener>Helm charts</a> in order to manage the various resources of the components.
Please always make sure that you use the Helm chart version that matches the Gardener version you want to deploy.</p><h2 id=deploying-the-gardener-control-plane-api-server-admission-controller-controller-manager-scheduler>Deploying the Gardener control plane (API server, admission controller, controller manager, scheduler)</h2><p>The <a href=https://github.com/gardener/gardener/blob/master/charts/gardener/controlplane/values.yaml>configuration values</a> depict the various options to configure the different components.
Please consult <a href=https://github.com/gardener/gardener/blob/master/docs/usage/configuration.md>this document</a> to get a detailed explanation of what can be configured for which component.</p><p>Also note that all resources and deployments need to be created in the <code>garden</code> namespace (not overrideable).
If you enable the Gardener admission controller as part of you setup, please make sure the <code>garden</code> namespace is labelled with <code>app: gardener</code>.
Otherwise, the backing service account for the admission controller Pod might not be created successfully.
No action is necessary, if you deploy the <code>garden</code> namespace with the Gardener control plane Helm chart.</p><p>After preparing your values in a separate <code>controlplane-values.yaml</code> file (<a href=https://github.com/gardener/gardener/blob/master/charts/gardener/controlplane/values.yaml>values.yaml</a> can be used as starting point), you can run the following command against your garden cluster:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>helm install charts/gardener/controlplane <span class=se>\
</span><span class=se></span>  --namespace garden <span class=se>\
</span><span class=se></span>  --name gardener-controlplane <span class=se>\
</span><span class=se></span>  -f controlplane-values.yaml <span class=se>\
</span><span class=se></span>  --wait
</code></pre></div><h2 id=deploying-gardener-extensions>Deploying Gardener extensions</h2><p>Gardener is an extensible system that does not contain the logic for provider-specific things like DNS management, cloud infrastructures, network plugins, operating system configs, and many more.</p><p>You have to install extension controllers for these parts.
Please consult <a href=/docs/concepts/extensions>the documentation regarding extensions</a> to get more information.</p><h2 id=deploying-the-gardener-agent-gardenlet>Deploying the Gardener agent (Gardenlet)</h2><p>Please refer to <a href=/docs/concepts/deployment/deploy_gardenlet>this document</a> on how to deploy a Gardenlet.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-56b4566b060b100a9689692a4f0472b0>1.11 - Feature Gates</h1><h1 id=feature-gates-in-gardener>Feature Gates in Gardener</h1><p>This page contains an overview of the various feature gates an administrator can specify on different Gardener components.</p><h2 id=overview>Overview</h2><p>Feature gates are a set of key=value pairs that describe Gardener features. You can turn these features on or off using the a component configuration file for a specific component.</p><p>Each Gardener component lets you enable or disable a set of feature gates that are relevant to that component. For example this is the configuration of the <a href=https://github.com/gardener/gardener/blob/master/example/20-componentconfig-gardenlet.yaml>gardenlet</a> component.</p><p>The following tables are a summary of the feature gates that you can set on different Gardener components.</p><ul><li>The “Since” column contains the Gardener release when a feature is introduced or its release stage is changed.</li><li>The “Until” column, if not empty, contains the last Gardener release in which you can still use a feature gate.</li><li>If a feature is in the Alpha or Beta state, you can find the feature listed in the Alpha/Beta feature gate table.</li><li>If a feature is stable you can find all stages for that feature listed in the Graduated/Deprecated feature gate table.</li><li>The Graduated/Deprecated feature gate table also lists deprecated and withdrawn features.</li></ul><h2 id=feature-gates-for-alpha-or-beta-features>Feature gates for Alpha or Beta features</h2><table><thead><tr><th>Feature</th><th>Default</th><th>Stage</th><th>Since</th><th>Until</th></tr></thead><tbody><tr><td>Logging</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>0.13</code></td><td></td></tr><tr><td>HVPA</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>0.31</code></td><td></td></tr><tr><td>HVPAForShootedSeed</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>0.32</code></td><td></td></tr><tr><td>ManagedIstio</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.5</code></td><td><code>1.18</code></td></tr><tr><td>ManagedIstio</td><td><code>true</code></td><td><code>Beta</code></td><td><code>1.19</code></td><td></td></tr><tr><td>APIServerSNI</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.7</code></td><td><code>1.18</code></td></tr><tr><td>APIServerSNI</td><td><code>true</code></td><td><code>Beta</code></td><td><code>1.19</code></td><td></td></tr><tr><td>SeedChange</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.12</code></td><td></td></tr><tr><td>SeedKubeScheduler</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.15</code></td><td></td></tr><tr><td>ReversedVPN</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.22</code></td><td></td></tr><tr><td>UseDNSRecords</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.27</code></td><td></td></tr><tr><td>DisallowKubeconfigRotationForShootInDeletion</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.28</code></td><td></td></tr><tr><td>RotateSSHKeypairOnMaintenance</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.28</code></td><td></td></tr><tr><td>DenyInvalidExtensionResources</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.31</code></td><td></td></tr></tbody></table><h2 id=feature-gates-for-graduated-or-deprecated-features>Feature gates for graduated or deprecated features</h2><table><thead><tr><th>Feature</th><th>Default</th><th>Stage</th><th>Since</th><th>Until</th></tr></thead><tbody><tr><td>NodeLocalDNS</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.7</code></td><td></td></tr><tr><td>NodeLocalDNS</td><td></td><td><code>Removed</code></td><td><code>1.26</code></td><td></td></tr><tr><td>KonnectivityTunnel</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.6</code></td><td></td></tr><tr><td>KonnectivityTunnel</td><td></td><td><code>Removed</code></td><td><code>1.27</code></td><td></td></tr><tr><td>MountHostCADirectories</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.11</code></td><td><code>1.25</code></td></tr><tr><td>MountHostCADirectories</td><td><code>true</code></td><td><code>Beta</code></td><td><code>1.26</code></td><td><code>1.27</code></td></tr><tr><td>MountHostCADirectories</td><td><code>true</code></td><td><code>GA</code></td><td><code>1.27</code></td><td></td></tr><tr><td>MountHostCADirectories</td><td></td><td><code>Removed</code></td><td><code>1.30</code></td><td></td></tr></tbody></table><h2 id=using-a-feature>Using a feature</h2><p>A feature can be in <em>Alpha</em>, <em>Beta</em> or <em>GA</em> stage.
An <em>Alpha</em> feature means:</p><ul><li>Disabled by default.</li><li>Might be buggy. Enabling the feature may expose bugs.</li><li>Support for feature may be dropped at any time without notice.</li><li>The API may change in incompatible ways in a later software release without notice.</li><li>Recommended for use only in short-lived testing clusters, due to increased
risk of bugs and lack of long-term support.</li></ul><p>A <em>Beta</em> feature means:</p><ul><li>Enabled by default.</li><li>The feature is well tested. Enabling the feature is considered safe.</li><li>Support for the overall feature will not be dropped, though details may change.</li><li>The schema and/or semantics of objects may change in incompatible ways in a
subsequent beta or stable release. When this happens, we will provide instructions
for migrating to the next version. This may require deleting, editing, and
re-creating API objects. The editing process may require some thought.
This may require downtime for applications that rely on the feature.</li><li>Recommended for only non-critical uses because of potential for
incompatible changes in subsequent releases.</li></ul><blockquote><p>Please do try <em>Beta</em> features and give feedback on them!
After they exit beta, it may not be practical for us to make more changes.</p></blockquote><p>A <em>General Availability</em> (GA) feature is also referred to as a <em>stable</em> feature. It means:</p><ul><li>The feature is always enabled; you cannot disable it.</li><li>The corresponding feature gate is no longer needed.</li><li>Stable versions of features will appear in released software for many subsequent versions.</li></ul><h2 id=list-of-feature-gates>List of feature gates</h2><ul><li><code>Logging</code> enables logging stack for Seed clusters.</li><li><code>HVPA</code> enables simultaneous horizontal and vertical scaling in Seed Clusters.</li><li><code>HVPAForShootedSeed</code> enables simultaneous horizontal and vertical scaling in managed seed (aka &ldquo;shooted seed&rdquo;) clusters.</li><li><code>ManagedIstio</code> enables a Gardener-tailored <a href=https://istio.io>Istio</a> in each Seed cluster. Disable this feature if Istio is already installed in the cluster. Istio is not automatically removed if this feature is disabled. See the <a href=https://github.com/gardener/gardener/blob/master/docs/usage/istio.md>detailed documentation</a> for more information.</li><li><code>APIServerSNI</code> enables only one LoadBalancer to be used for every Shoot cluster API server in a Seed. Enable this feature when <code>ManagedIstio</code> is enabled or Istio is manually deployed in Seed cluster. See <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/08-shoot-apiserver-via-sni.md>GEP-8</a> for more details.</li><li><code>MountHostCADirectories</code> enables mounting common CA certificate directories in the Shoot API server pod that might be required for webhooks or OIDC.</li><li><code>SeedChange</code> enables updating the <code>spec.seedName</code> field during shoot validation from a non-empty value in order to trigger shoot control plane migration.</li><li><code>SeedKubeScheduler</code> adds custom <code>kube-scheduler</code> in <code>gardener-kube-scheduler</code> namespace. It schedules <a href=https://github.com/gardener/gardener/blob/master/docs/concepts/seed-admission-controller.md#mutating-webhooks>pods with scheduler name</a> <code>gardener-kube-scheduler</code> on Nodes with higher resource utilization. It requires Seed cluster with kubernetes version <code>1.18</code> or higher.</li><li><code>ReversedVPN</code> reverses the connection setup of the vpn tunnel between the Seed and the Shoot cluster(s). It allows Seed and Shoot clusters to be in different networks with only direct access in one direction (Shoot -> Seed). In addition to that, it reduces the amount of load balancers required, i.e. no load balancers are required for the vpn tunnel anymore. It requires <code>APIServerSNI</code> and kubernetes version <code>1.18</code> or higher to work. Details can be found in <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/14-reversed-cluster-vpn.md>GEP-14</a>.</li><li><code>AdminKubeconfigRequest</code> enables the <code>AdminKubeconfigRequest</code> endpoint on Shoot resources. See <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/16-adminkubeconfig-subresource.md>GEP-16</a> for more details.</li><li><code>UseDNSRecords</code> enables using <code>DNSRecord</code> resources for Gardener DNS records instead of <code>DNSProvider</code>, <code>DNSEntry</code>, and <code>DNSOwner</code> resources. See <a href=https://github.com/gardener/gardener/blob/master/docs/extensions/dnsrecord.md>Contract: <code>DNSRecord</code> resources</a> for more details.</li><li><code>DisallowKubeconfigRotationForShootInDeletion</code> when enabled, does not allow kubeconfig rotation to be requested for shoot cluster that is already in deletion phase, i.e. <code>metadata.deletionTimestamp</code> is set.</li><li><code>RotateSSHKeypairOnMaintenance</code> enables SSH keypair rotation in the maintenance controller of the gardener-controller-manager. Details can be found in <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/15-manage-bastions-and-ssh-key-pair-rotation.md>GEP-15</a>.</li><li><code>DenyInvalidExtensionResources</code> causes the <code>seed-admission-controller</code> to deny invalid extension resources, instead of just logging validation errors.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-33786ab36425079cb67b056b8cd4df34>1.12 - Image Vector</h1><h1 id=image-vector>Image Vector</h1><p>The Gardenlet is deploying several different container images into the seed and the shoot clusters.
The image repositories and tags are defined in a <a href=https://github.com/gardener/gardener/blob/master/charts/images.yaml>central image vector file</a>.
Obviously, the image versions defined there must fit together with the deployment manifests (e.g., some command-line flags do only exist in certain versions).</p><h2 id=example>Example</h2><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>images</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pause-container</span><span class=w>
</span><span class=w>  </span><span class=nt>sourceRepository</span><span class=p>:</span><span class=w> </span><span class=l>github.com/kubernetes/kubernetes/blob/master/build/pause/Dockerfile</span><span class=w>
</span><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/google_containers/pause-amd64</span><span class=w>
</span><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.0&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.15</span><span class=l>.x</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pause-container</span><span class=w>
</span><span class=w>  </span><span class=nt>sourceRepository</span><span class=p>:</span><span class=w> </span><span class=l>github.com/kubernetes/kubernetes/blob/master/build/pause/Dockerfile</span><span class=w>
</span><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/google_containers/pause-amd64</span><span class=w>
</span><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.1&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&gt;= 1.16&#34;</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>That means that the Gardenlet will use the <code>pause-container</code> in with tag <code>3.0</code> for all seed/shoot clusters with Kubernetes version <code>1.15.x</code>, and tag <code>3.1</code> for all clusters with Kubernetes <code>>= 1.16</code>.</p><h2 id=overwrite-image-vector>Overwrite image vector</h2><p>In some environment it is not possible to use these &ldquo;pre-defined&rdquo; images that come with a Gardener release.
A prominent example for that is Alicloud in China which does not allow access to Google&rsquo;s GCR.
In these cases you might want to overwrite certain images, e.g., point the <code>pause-container</code> to a different registry.</p><p>:warning: If you specify an image that does not fit to the resource manifest then the seed/shoot reconciliation might fail.</p><p>In order to overwrite the images you must provide a similar file to Gardenlet:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>images</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pause-container</span><span class=w>
</span><span class=w>  </span><span class=nt>sourceRepository</span><span class=p>:</span><span class=w> </span><span class=l>github.com/kubernetes/kubernetes/blob/master/build/pause/Dockerfile</span><span class=w>
</span><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>my-custom-image-registry/pause-amd64</span><span class=w>
</span><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.0&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.15</span><span class=l>.x</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pause-container</span><span class=w>
</span><span class=w>  </span><span class=nt>sourceRepository</span><span class=p>:</span><span class=w> </span><span class=l>github.com/kubernetes/kubernetes/blob/master/build/pause/Dockerfile</span><span class=w>
</span><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>my-custom-image-registry/pause-amd64</span><span class=w>
</span><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.1&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&gt;= 1.16&#34;</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>During deployment of the gardenlet create a <code>ConfigMap</code> containing the above content and mount it as a volume into the gardenlet pod.
Next, specify the environment variable <code>IMAGEVECTOR_OVERWRITE</code> whose value must be the path to the file you just mounted:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-images-overwrite</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>images_overwrite.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    images:
</span><span class=sd>    - ...</span><span class=w>    
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=l>...</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet</span><span class=w>
</span><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>IMAGEVECTOR_OVERWRITE</span><span class=w>
</span><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>/charts-overwrite/images_overwrite.yaml</span><span class=w>
</span><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-images-overwrite</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/charts-overwrite</span><span class=w>
</span><span class=w>        </span><span class=l>...</span><span class=w>
</span><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-images-overwrite</span><span class=w>
</span><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-images-overwrite</span><span class=w>
</span><span class=w>  </span><span class=l>...</span><span class=w>
</span></code></pre></div><h2 id=image-vectors-for-dependent-components>Image vectors for dependent components</h2><p>The gardenlet is deploying a lot of different components that might deploy other images themselves.
These components might use an image vector as well.
Operators might want to customize the image locations for these transitive images as well, hence, they might need to specify an image vector overwrite for the components directly deployed by Gardener.</p><p>It is possible to specify the <code>IMAGEVECTOR_OVERWRITE_COMPONENTS</code> environment variable to the gardenlet that points to a file with the following content:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>components</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>etcd-druid</span><span class=w>
</span><span class=w>  </span><span class=nt>imageVectorOverwrite</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    images:
</span><span class=sd>    - name: etcd
</span><span class=sd>      tag: v1.2.3
</span><span class=sd>      repository: etcd/etcd</span><span class=w>    
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>The gardenlet will, if supported by the directly deployed component (<code>etcd-druid</code> in this example), inject the given <code>imageVectorOverwrite</code> into the <code>Deployment</code> manifest.
The respective component is responsible for using the overwritten images instead of its defaults.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cf7992643a6773a8be4f5a3e8164ca25>1.13 - Machine Controller Manager</h1><h1 id=machine-controller-manager>machine-controller-manager</h1><p><a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/machine-controller-manager-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/machine-controller-manager-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/machine-controller-manager><img src=https://goreportcard.com/badge/github.com/gardener/machine-controller-manager alt="Go Report Card"></a></p><p>:warning: We are in the progress of migrating and deprecating all the in-tree providers to OOT. Please avoid making any new feature enhancements to the intree providers. Kindly make it on the <a href="https://github.com/gardener/?q=machine-controller-manager-provider&type=&language=">OOT providers available here</a>. More details on adding <a href=https://github.com/gardener/machine-controller-manager/blob/master/docs/development/cp_support_new.md>new OOT providers can be found here</a>.</p><p>Machine Controller Manager (MCM) manages VMs as another kubernetes custom resource. It provides a declarative way to manage VMs.</p><p>MCM supports following providers. These provider code is maintained externally (out-of-tree), and the links for the same are linked below:</p><ul><li><a href=https://github.com/gardener/machine-controller-manager-provider-alicloud>Alicloud</a></li><li><a href=https://github.com/gardener/machine-controller-manager-provider-aws>AWS</a></li><li><a href=https://github.com/gardener/machine-controller-manager-provider-azure>Azure</a></li><li><a href=https://github.com/gardener/machine-controller-manager-provider-equinix-metal>Equinix Metal</a></li><li><a href=https://github.com/gardener/machine-controller-manager-provider-gcp>GCP</a></li><li><a href=https://github.com/gardener/machine-controller-manager-provider-kubevirt>KubeVirt</a></li><li><a href=https://github.com/metal-stack/machine-controller-manager-provider-metal>Metal Stack</a></li><li><a href=https://github.com/gardener/machine-controller-manager-provider-openstack>Openstack</a></li><li><a href=https://github.com/gardener/machine-controller-manager-provider-vsphere>V Sphere</a></li><li><a href=https://github.com/gardener/machine-controller-manager-provider-yandex>Yandex</a></li></ul><p>It can easily be extended to support other cloud providers as well.</p><p>Example of managing machine:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl create/get/delete machine vm1
</code></pre></div><h3 id=key-terminologies>Key terminologies</h3><p>Nodes/Machines/VMs are different terminologies used to represent similar things. We use these terms in the following way</p><ol><li>VM: A virtual machine running on any cloud provider. It could also refer to a physical machine (PM) in case of a bare metal setup.</li><li>Node: Native kubernetes node objects. The objects you get to see when you do a <em>&ldquo;kubectl get nodes&rdquo;</em>. Although nodes can be either physical/virtual machines, for the purposes of our discussions it refers to a VM.</li><li>Machine: A VM that is provisioned/managed by the Machine Controller Manager.</li></ol><h2 id=design-of-machine-controller-manager>Design of Machine Controller Manager</h2><p>See the design documentation in the <code>/docs/design</code> repository, please <a href=https://github.com/gardener/machine-controller-manager/blob/master/docs/design/README.md>find the design doc here</a>.</p><h2 id=to-start-using-or-developing-the-machine-controller-manager>To start using or developing the Machine Controller Manager</h2><p>See the documentation in the <code>/docs</code> repository, please <a href=https://github.com/gardener/machine-controller-manager/blob/master/docs/README.md>find the index here</a>.</p><h2 id=faq>FAQ</h2><p>An FAQ is available <a href=https://github.com/gardener/machine-controller-manager/blob/master/docs/FAQ.md>here</a></p><h2 id=cluster-api-implementation>Cluster-api Implementation</h2><ul><li><code>cluster-api</code> branch of machine-controller-manager implements the machine-api aspect of the <a href=https://github.com/kubernetes-sigs/cluster-api>cluster-api project</a>.</li><li>Link: <a href=https://github.com/gardener/machine-controller-manager/tree/cluster-api>https://github.com/gardener/machine-controller-manager/tree/cluster-api</a></li><li>Once cluster-api project gets stable, we may make <code>master</code> branch of MCM as well cluster-api compliant, with well-defined migration notes.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d2c6535126cca927d2a9c893abde92a0>2 - How-To Guides</h1><div class=lead>Learn how to execute concrete tasks</div></div><div class=td-content><h1 id=pg-ed30d4942f1afb26454fab9f11a445e1>2.1 - Set Up Client Tools</h1></div><div class=td-content><h1 id=pg-33170d28a5e3a076ed0ed50fed19149e>2.1.1 - Automated deployment</h1><div class=lead>Automated deployment with kubectl</div><h2 id=introduction>Introduction</h2><p>With kubectl you can easily deploy an image from your local environment.</p><p>However, what if you want to use a automated deployment script on a CI server (e.g. Jenkins), but don&rsquo;t want to store
the KUBECONFIG on that server?</p><p>You can use kubectl and connect to the API-server of your cluster.</p><h2 id=prerequisites>Prerequisites</h2><ol><li><p>Create a service account user</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl create serviceaccount deploy-user -n default
</code></pre></div></li><li><p>Bind a role to the newly created serviceuser</p><blockquote><p><strong>!!! Warning !!!</strong> In this example the preconfigured role <code>edit</code> and the namespace <code>default</code> is being used, please adjust the role to a more strict scope! see <a href=https://kubernetes.io/docs/admin/authorization/rbac/>https://kubernetes.io/docs/admin/authorization/rbac/</a></p></blockquote><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl create rolebinding deploy-default-role --clusterrole=edit --serviceaccount=default:deploy-user --namespace=default
</code></pre></div></li><li><p>Get the URL of your API-server</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>APISERVER=$(kubectl config view | grep server | cut -f 2- -d &#34;:&#34; | tr -d &#34; &#34;)
</code></pre></div></li><li><p>Get the service account</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>SERVICEACCOUNT=$(kubectl get serviceaccount deploy-user -n default -o=jsonpath={.secrets[0].name})
</code></pre></div></li><li><p>Generate a token for the serviceaccount</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>TOKEN=$(kubectl get secret -n default $SERVICEACCOUNT -o=jsonpath={.data.token} | base64 -D)
</code></pre></div></li></ol><h2 id=usage>Usage</h2><p>You can deploy your app without setting the kubeconfig locally, you just need to pass the environment variables (e.g. store them in the Jenkins credentials store)</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl --server=${APIServer} --token=${TOKEN} --insecure-skip-tls-verify=true apply --filename myapp.yaml
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6cfaa64f7452ed600c92ebe35f6920a7>2.1.2 - Kubeconfig context as bash prompt</h1><div class=lead>Expose the active kubeconfig into bash</div><p>Use the Kubernetes command-line tool, <em>kubectl</em>, to deploy and manage applications on Kubernetes.
Using kubectl, you can inspect cluster resources; create, delete, and update components</p><p><img src=/__resources/howto-kubeconfig-bash_526f23.gif alt=port-forward></p><p>By default, the kubectl configuration is located at <code>~/.kube/config</code>.</p><p>Suppose you have two clusters, one for development work and one for scratch work.</p><p>How to handle this easily without copying the used configuration always to the right place?</p><h2 id=export-the-kubeconfig-enviroment-variable>Export the KUBECONFIG enviroment variable</h2><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>bash$ <span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span>&lt;PATH-TO-M&gt;-CONFIG&gt;/kubeconfig-dev.yaml
</code></pre></div><p>How to determine which cluster is used by the kubectl command?</p><h2 id=determine-active-cluster>Determine active cluster</h2><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>bash$ kubectl cluster-info
Kubernetes master is running at https://api.dev.garden.shoot.canary.k8s-hana.ondemand.com
KubeDNS is running at https://api.dev.garden.shoot.canary.k8s-hana.ondemand.com/api/v1/proxy/namespaces/kube-system/services/kube-dns

To further debug and diagnose cluster problems, use <span class=s1>&#39;kubectl cluster-info dump&#39;</span>.
bash$ 
</code></pre></div><h2 id=display-cluster-in-the-bash---linux-and-alike>Display cluster in the bash - Linux and alike</h2><p>I found this tip on Stackoverflow and find it worth to be added here.
Edit your <code>~/.bash_profile</code> and add the following code snippet to show the current k8s
context in the shell&rsquo;s prompt.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>prompt_k8s<span class=o>(){</span>
  <span class=nv>k8s_current_context</span><span class=o>=</span><span class=k>$(</span>kubectl config current-context 2&gt; /dev/null<span class=k>)</span>
  <span class=k>if</span> <span class=o>[[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]]</span> <span class=p>;</span> <span class=k>then</span> <span class=nb>echo</span> -e <span class=s2>&#34;(</span><span class=si>${</span><span class=nv>k8s_current_context</span><span class=si>}</span><span class=s2>) &#34;</span><span class=p>;</span> <span class=k>fi</span>
<span class=o>}</span>
 
 
<span class=nv>PS1</span><span class=o>+=</span><span class=s1>&#39;$(prompt_k8s)&#39;</span>

</code></pre></div><p>After this your bash command prompt contains the active KUBECONFIG context and you always know
which cluster is active - <em>develop</em> or <em>production</em>.</p><p>e.g.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>bash$ <span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span>/Users/d023280/Documents/workspace/gardener-ui/kubeconfig_gardendev.yaml 
bash <span class=o>(</span>garden_dev<span class=o>)</span>$ 
</code></pre></div><p>Note the <strong>(garden_dev)</strong> prefix in the bash command prompt.</p><p><strong>This helps immensely to avoid thoughtless mistakes.</strong></p><h2 id=display-cluster-in-the-powershell---windows>Display cluster in the PowerShell - Windows</h2><p>Display current k8s cluster in the title of PowerShell window.</p><p>Create a <a href=https://superuser.com/a/1045659>profile</a> file for your shell under <code>%UserProfile%\Documents\Windows­PowerShell\Microsoft.PowerShell_profile.ps1</code></p><p>Copy following code to <code>Microsoft.PowerShell_profile.ps1</code></p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh> <span class=k>function</span> prompt_k8s <span class=o>{</span>
     <span class=nv>$k8s_current_context</span> <span class=o>=</span> <span class=o>(</span>kubectl config current-context<span class=o>)</span> <span class=p>|</span> Out-String
     <span class=k>if</span><span class=o>(</span><span class=nv>$?</span><span class=o>)</span> <span class=o>{</span>
         <span class=k>return</span> <span class=nv>$k8s_current_context</span>
     <span class=o>}</span><span class=k>else</span> <span class=o>{</span>
         <span class=k>return</span> <span class=s2>&#34;No K8S contenxt found&#34;</span>
     <span class=o>}</span>
 <span class=o>}</span>

 <span class=nv>$host</span>.ui.rawui.WindowTitle <span class=o>=</span> prompt_k8s
</code></pre></div><p><img src=/__resources/howto-bash_kubeconfig_powershell_bccbee.png alt=port-forward></p><p>If you want to switch to different cluster, you can set <code>KUBECONFIG</code> to new value, and re-run the file <code>Microsoft.PowerShell_profile.ps1</code></p></div><div class=td-content style=page-break-before:always><h1 id=pg-4811effaf016a84906632f2b2585ac68>2.1.3 - Organizing Access Using kubeconfig Files</h1><h1 id=organizing-access-using-kubeconfig-files>Organizing Access Using kubeconfig Files</h1><p>The kubectl command-line tool uses <code>kubeconfig</code> files to find the information it needs to choose a cluster and
communicate with the API server of a cluster.</p><h2 id=problem>Problem</h2><p>If you&rsquo;ve become aware of a security breach that affects you, you may want to revoke or cycle credentials
in case anything was leaked. However, this is not possible with the initial or master <code>kubeconfig</code> from your
cluster.</p><p><img src=/__resources/teaser_52b532.svg alt=teaser></p><h2 id=pitfall>Pitfall</h2><p>Never distribute the <code>kubeconfig</code>, which you can download directly within the Gardener dashboard, for a productive cluster.</p><p><img src=/__resources/kubeconfig-initial_bd3079.png alt=kubeconfig-dont></p><h2 id=create-custom-kubeconfig-file-for-each-user>Create custom kubeconfig file for each user</h2><p>Create a separate <code>kubeconfig</code> for each user. One of the big advantages is, that you can revoke them and control
the permissions better. A limitation to single namespaces is also possible here.</p><p>The script creates a new <code>ServiceAccount</code> with read privileges in the whole cluster (Secretes are excluded).
To run the script <a href=https://stedolan.github.io/jq/>jq</a>, a lightweight and flexible command-line JSON processor, must
be installed.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span>
<span class=k>if</span> <span class=o>[[</span> -z <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>]]</span> <span class=p>;</span><span class=k>then</span>
  <span class=nb>echo</span> <span class=s2>&#34;usage: </span><span class=nv>$0</span><span class=s2> &lt;username&gt;&#34;</span>
  <span class=nb>exit</span> <span class=m>1</span>
<span class=k>fi</span>

<span class=nv>user</span><span class=o>=</span><span class=nv>$1</span>
kubectl create sa <span class=si>${</span><span class=nv>user</span><span class=si>}</span>
<span class=nv>secret</span><span class=o>=</span><span class=k>$(</span>kubectl get sa <span class=si>${</span><span class=nv>user</span><span class=si>}</span> -o json <span class=p>|</span> jq -r .secrets<span class=o>[]</span>.name<span class=k>)</span>
kubectl get secret <span class=si>${</span><span class=nv>secret</span><span class=si>}</span> -o json <span class=p>|</span> jq -r <span class=s1>&#39;.data[&#34;ca.crt&#34;]&#39;</span> <span class=p>|</span> base64 -D &gt; ca.crt

<span class=nv>user_token</span><span class=o>=</span><span class=k>$(</span>kubectl get secret <span class=si>${</span><span class=nv>secret</span><span class=si>}</span> -o json <span class=p>|</span> jq -r <span class=s1>&#39;.data[&#34;token&#34;]&#39;</span> <span class=p>|</span> base64 -D<span class=k>)</span>
<span class=nv>c</span><span class=o>=</span><span class=sb>`</span>kubectl config current-context<span class=sb>`</span>
<span class=nv>cluster_name</span><span class=o>=</span><span class=sb>`</span>kubectl config get-contexts <span class=nv>$c</span> <span class=p>|</span> awk <span class=s1>&#39;{print $3}&#39;</span> <span class=p>|</span> tail -n 1<span class=sb>`</span>
<span class=nv>endpoint</span><span class=o>=</span><span class=sb>`</span>kubectl config view -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.clusters[?(@.name == \&#34;</span><span class=si>${</span><span class=nv>cluster_name</span><span class=si>}</span><span class=s2>\&#34;)].cluster.server}&#34;</span><span class=sb>`</span>

<span class=c1># Set up the config</span>
<span class=nv>KUBECONFIG</span><span class=o>=</span>k8s-<span class=si>${</span><span class=nv>user</span><span class=si>}</span>-conf kubectl config set-cluster <span class=si>${</span><span class=nv>cluster_name</span><span class=si>}</span> <span class=se>\
</span><span class=se></span>    --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>    --server<span class=o>=</span><span class=si>${</span><span class=nv>endpoint</span><span class=si>}</span> <span class=se>\
</span><span class=se></span>    --certificate-authority<span class=o>=</span>./ca.crt

<span class=nv>KUBECONFIG</span><span class=o>=</span>k8s-<span class=si>${</span><span class=nv>user</span><span class=si>}</span>-conf kubectl config set-credentials <span class=si>${</span><span class=nv>user</span><span class=si>}</span>-<span class=si>${</span><span class=nv>cluster_name</span><span class=p>#cluster-</span><span class=si>}</span> --token<span class=o>=</span><span class=si>${</span><span class=nv>user_token</span><span class=si>}</span>
<span class=nv>KUBECONFIG</span><span class=o>=</span>k8s-<span class=si>${</span><span class=nv>user</span><span class=si>}</span>-conf kubectl config set-context <span class=si>${</span><span class=nv>user</span><span class=si>}</span>-<span class=si>${</span><span class=nv>cluster_name</span><span class=p>#cluster-</span><span class=si>}</span> <span class=se>\
</span><span class=se></span>    --cluster<span class=o>=</span><span class=si>${</span><span class=nv>cluster_name</span><span class=si>}</span> <span class=se>\
</span><span class=se></span>    --user<span class=o>=</span><span class=si>${</span><span class=nv>user</span><span class=si>}</span>-<span class=si>${</span><span class=nv>cluster_name</span><span class=p>#cluster-</span><span class=si>}</span>
<span class=nv>KUBECONFIG</span><span class=o>=</span>k8s-<span class=si>${</span><span class=nv>user</span><span class=si>}</span>-conf kubectl config use-context <span class=si>${</span><span class=nv>user</span><span class=si>}</span>-<span class=si>${</span><span class=nv>cluster_name</span><span class=p>#cluster-</span><span class=si>}</span>

cat <span class=s>&lt;&lt;EOF | kubectl create -f -
</span><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span><span class=s>kind: ClusterRoleBinding
</span><span class=s>metadata:
</span><span class=s>  name: view-${user}-global
</span><span class=s>subjects:
</span><span class=s>- kind: ServiceAccount
</span><span class=s>  name: ${user}
</span><span class=s>  namespace: default
</span><span class=s>roleRef:
</span><span class=s>  kind: ClusterRole
</span><span class=s>  name: view
</span><span class=s>  apiGroup: rbac.authorization.k8s.io
</span><span class=s>
</span><span class=s>EOF</span>


<span class=nb>echo</span> <span class=s2>&#34;done! Test with: &#34;</span>
<span class=nb>echo</span> <span class=s2>&#34;export KUBECONFIG=k8s-</span><span class=si>${</span><span class=nv>user</span><span class=si>}</span><span class=s2>-conf&#34;</span>
<span class=nb>echo</span> <span class=s2>&#34;kubectl get pods&#34;</span>
</code></pre></div><p>If <strong>edit</strong> or <strong>admin</strong> rights are to be assigned, the <code>ClusterRoleBinding</code> must be adapted in the <code>roleRef</code> section
with the roles listed below.</p><p>Furthermore, you can restrict this to a single namespace by not creating a <code>ClusterRoleBinding</code> but only a <code>RoleBinding</code>
within the desired namespace.</p><table><thead><tr><th>Default ClusterRole</th><th>Default ClusterRoleBinding</th><th>Description</th></tr></thead><tbody><tr><td>cluster-admin</td><td>system:masters group</td><td>Allows super-user access to perform any action on any resource. When used in a ClusterRoleBinding, it gives full control over every resource in the cluster and in all namespaces. When used in a RoleBinding, it gives full control over every resource in the rolebinding&rsquo;s namespace, including the namespace itself.</td></tr><tr><td>admin</td><td>None</td><td>Allows admin access, intended to be granted within a namespace using a RoleBinding. If used in a RoleBinding, allows read/write access to most resources in a namespace, including the ability to create roles and rolebindings within the namespace. It does not allow write access to resource quota or to the namespace itself.</td></tr><tr><td>edit</td><td>None</td><td>Allows read/write access to most objects in a namespace. It does not allow viewing or modifying roles or rolebindings.</td></tr><tr><td>view</td><td>None</td><td>Allows read-only access to see most objects in a namespace. It does not allow viewing roles or rolebindings. It does not allow viewing secrets, since those are escalating.</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-acb3d3deb29a8ddc337a39814f4ddbcb>2.1.4 - Use a Helm chart to deploy some application or service</h1><p>Basically, <a href=https://helm.sh/docs/topics/charts/>Helm Charts</a> can be installed as described e.g. in the Helm
<a href=https://helm.sh/docs/intro/quickstart/>QuickStart Guide</a>. However, our clusters come with
<a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>RBAC</a> enabled by default hence Helm must be installed as follows:</p><h2 id=create-a-service-account>Create a Service Account</h2><p>Create a service account via the following command:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>cat <span class=s>&lt;&lt;EOF | kubectl create -f -
</span><span class=s>apiVersion: v1
</span><span class=s>kind: ServiceAccount
</span><span class=s>metadata:
</span><span class=s> name: helm
</span><span class=s> namespace: kube-system
</span><span class=s>---
</span><span class=s>apiVersion: rbac.authorization.k8s.io/v1beta1
</span><span class=s>kind: ClusterRoleBinding
</span><span class=s>metadata:
</span><span class=s> name: helm
</span><span class=s>roleRef:
</span><span class=s> apiGroup: rbac.authorization.k8s.io
</span><span class=s> kind: ClusterRole
</span><span class=s> name: cluster-admin
</span><span class=s>subjects:
</span><span class=s> - kind: ServiceAccount
</span><span class=s>   name: helm
</span><span class=s>   namespace: kube-system
</span><span class=s>EOF</span>
</code></pre></div><h2 id=initialize-helm>Initialize Helm</h2><p>Initialise Helm via <code>helm init --service-account helm</code>. You can now use <code>helm</code>.</p><h2 id=in-case-of-failure>In case of failure</h2><p>In case you have already executed <code>helm init</code>, but without the above service account, you will get the following error:
<code>Error: User "system:serviceaccount:kube-system:default" cannot list configmaps in the namespace "kube-system". (get configmaps)</code> (e.g. when you run <code>helm list</code>). You will now need to delete the Tiller deployment (Helm backend
implicitly deployed to the Kubernetes cluster when you call <code>helm init</code>) as well as the local Helm files (usually
<code>$HELM_HOME</code> is set to <code>~/.helm</code>):</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>kubectl delete deployment tiller-deploy --namespace<span class=o>=</span>kube-system
kubectl delete service tiller-deploy --namespace<span class=o>=</span>kube-system 
rm -rf ~/.helm/
</code></pre></div><p>Now follow the instructions above. For more details see this
<a href=https://github.com/kubernetes/helm/issues/2687>Kubernetes Helm issue #2687</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f7165d236b09de8503d3a17a03402a0e>2.2 - Install Gardener</h1></div><div class=td-content><h1 id=pg-8f3887d5e8aba7697aef426ea1bf6e5b>2.2.1 - Gardener Certificate Management</h1><div class=lead>Configure Certificate Management For Shoot Clusters</div><h1 id=gardener-certificate-management>Gardener Certificate Management</h1><h2 id=introduction>Introduction</h2><p>Gardener comes with an extension that enables shoot owners to request X.509 compliant certificates for shoot domains.</p><h2 id=extension-installation>Extension Installation</h2><p>The <code>Shoot-Cert-Service</code> extension can be deployed and configured via Gardener&rsquo;s native resource <a href=/docs/concepts/extensions/controllerregistration>ControllerRegistration</a>.</p><h3 id=prerequisites>Prerequisites</h3><p>To let the <code>Shoot-Cert-Service</code> operate properly, you need to have:</p><ul><li>a <a href=https://github.com/gardener/external-dns-management>DNS service</a> in your seed</li><li>contact details and optionally a private key for a pre-existing <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a> account</li></ul><h3 id=controllerregistration>ControllerRegistration</h3><p>An example of a <code>ControllerRegistration</code> for the <code>Shoot-Cert-Service</code> can be found here: <a href=https://github.com/gardener/gardener-extension-shoot-cert-service/blob/master/example/controller-registration.yaml>https://github.com/gardener/gardener-extension-shoot-cert-service/blob/master/example/controller-registration.yaml</a></p><p>The <code>ControllerRegistration</code> contains a Helm chart which eventually deploy the <code>Shoot-Cert-Service</code> to seed clusters. It offers some configuration options, mainly to set up a default issuer for shoot clusters. With a default issuer, pre-existing Let&rsquo;s Encrypt accounts can be used and shared with shoot clusters (See &ldquo;One Account or Many?&rdquo; of the <a href=https://letsencrypt.org/docs/integration-guide/>Integration Guide</a>).</p><blockquote><p>Please keep the Let&rsquo;s Encrypt <a href=https://letsencrypt.org/docs/rate-limits/>Rate Limits</a> in mind when using this shared account model. Depending on the amount of shoots and domains it is recommended to use an account with increased rate limits.</p></blockquote><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ControllerRegistration</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>certificateConfig</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>defaultIssuer</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>acme</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>email</span><span class=p>:</span><span class=w> </span><span class=l>foo@example.com</span><span class=w>
</span><span class=w>            </span><span class=nt>privateKey</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span><span class=sd>            -----BEGIN RSA PRIVATE KEY-----
</span><span class=sd>            ...
</span><span class=sd>            -----END RSA PRIVATE KEY-----
</span><span class=sd>            server: https://acme-v02.api.letsencrypt.org/directory</span><span class=w>            
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default-issuer</span><span class=w>
</span><span class=w></span><span class=c>#       restricted: true # restrict default issuer to any sub-domain of shoot.spec.dns.domain</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c>#     defaultRequestsPerDayQuota: 50</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c>#     precheckNameservers: 8.8.8.8,8.8.4.4</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c>#     caCertificates: | # optional custom CA certificates when using private ACME provider</span><span class=w>
</span><span class=w></span><span class=c>#     -----BEGIN CERTIFICATE-----</span><span class=w>
</span><span class=w></span><span class=c>#     ...</span><span class=w>
</span><span class=w></span><span class=c>#     -----END CERTIFICATE-----</span><span class=w>
</span><span class=w></span><span class=c>#</span><span class=w>
</span><span class=w></span><span class=c>#     -----BEGIN CERTIFICATE-----</span><span class=w>
</span><span class=w></span><span class=c>#     ...</span><span class=w>
</span><span class=w></span><span class=c>#     -----END CERTIFICATE-----</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>shootIssuers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># if true, allows to specify issuers in the shoot clusters</span><span class=w>
</span><span class=w>
</span></code></pre></div><h4 id=enablement>Enablement</h4><p>If the <code>Shoot-Cert-Service</code> should be enabled for every shoot cluster in your Gardener managed environment, you need to globally enable it in the <code>ControllerRegistration</code>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ControllerRegistration</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>globallyEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Extension</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-cert-service</span><span class=w>
</span></code></pre></div><p>Alternatively, you&rsquo;re given the option to only enable the service for certain shoots:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-cert-service</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c9046c7017ce6bf2d170fafb306feca9>2.2.2 - Gardener DNS Management for Shoots</h1><div class=lead>Configure DNS Management For Shoot Clusters</div><h1 id=gardener-dns-management-for-shoots>Gardener DNS Management for Shoots</h1><h2 id=introduction>Introduction</h2><p>Gardener allows Shoot clusters to request DNS names for Ingresses and Services out of the box.
To support this the gardener must be installed with the <code>shoot-dns-service</code>
extension.
This extension uses the seed&rsquo;s dns management infrastructure to maintain DNS
names for shoot clusters. So, far only the external DNS domain of a shoot
(already used for the kubernetes api server and ingress DNS names) can be used
for managed DNS names.</p><h2 id=configuration>Configuration</h2><p>A general description for configuring the DNS management of the
gardener can be found <a href=/docs/concepts/extensions/dns>here</a>.</p><p>To generally enable the DNS management for shoot objects the
<code>shoot-dns-service</code> extension must be registered by providing an
appropriate <a href=https://github.com/gardener/gardener-extension-shoot-dns-service/blob/master/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available
for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots the registration must set the <em>globallyEnabled</em> flag to <code>true</code>.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Extension</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-dns-service</span><span class=w>
</span><span class=w>      </span><span class=nt>globallyEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></code></pre></div><h3 id=providing-base-domains-usable-for-a-shoot>Providing Base Domains usable for a Shoot</h3><p>So, far only the external DNS domain of a shoot already used
for the kubernetes api server and ingress DNS names can be used for managed
DNS names. This is either the shoot domain as subdomain of the default domain
configured for the gardener installation, or a dedicated domain with dedicated
access credentials configured for a dedicated shoot via the shoot manifest.</p><p>Alternatively, you can specify <code>DNSProviders</code> and its credentials
<code>Secret</code> directly in the shoot, if this feature is enabled.
By default, <code>DNSProvider</code> replication is disabled, but it can be enabled globally in the <code>ControllerDeployment</code>
or for a shoot cluster in the shoot manifest (details see further below).</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ControllerDeployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>extension-shoot-dns-service</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>helm</span><span class=w>
</span><span class=w></span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=l>...</span><span class=w>
</span><span class=w>    </span><span class=nt>dnsProviderReplication</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></code></pre></div><p>See <a href=https://github.com/gardener/external-dns-management/tree/master/examples>example files (20-* and 30-*)</a>
for details for the various provider types.</p><h3 id=shoot-feature-gate>Shoot Feature Gate</h3><p>If the shoot DNS feature is not globally enabled by default (depends on the
extension registration on the garden cluster), it must be enabled per shoot.</p><p>To enable the feature for a shoot, the shoot manifest must explicitly add the
<code>shoot-dns-service</code> extension.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-dns-service</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><h4 id=enabledisable-dns-provider-replication-for-a-shoot>Enable/disable DNS provider replication for a shoot</h4><p>The DNSProvider` replication feature enablement can be overwritten in the
shoot manifest, e.g.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>Kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-dns-service</span><span class=w>
</span><span class=w>      </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>service.dns.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>        </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DNSConfig</span><span class=w>
</span><span class=w>        </span><span class=nt>dnsProviderReplication</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-009818d3feade374ae615681087e6434>2.2.3 - Hardening the Gardener Community Setup</h1><h1 id=hardening-the-gardener-community-setup>Hardening the Gardener Community Setup</h1><h2 id=context>Context</h2><p>Gardener stakeholders in the Open Source community usually use the <a href=https://github.com/gardener/landscape-setup>Gardener Setup Scripts</a>, to create a Garden cluster based on Kubernetes v1.9 which then can be used to create Shoot clusters based on Kubernetes v1.10, v1.11 and v1.12. Shoot clusters can play the following roles in a Gardener landscape:</p><ul><li>Seed cluster</li><li>Shoot cluster</li></ul><p>As Alban Crequy from Kinvolk has recommended in his recent Gardener blog <a href=/docs/guides/applications/insecure-configuration>Auditing Kubernetes for Secure Setup</a> the Gardener Team at SAP has applied several means to harden the Gardener landscapes at SAP.</p><h2 id=recommendations>Recommendations</h2><h3 id=mitigation-for-gardener-cve-2018-2475>Mitigation for Gardener CVE-2018-2475</h3><p>The following recommendations describe how you can harden your Gardener Community Setup by adding a Seed cluster hardened with network policies.</p><ul><li>Use the Gardener Setup Scripts to create a Garden cluster in a dedicated IaaS account</li><li>Create a Shoot cluster in a different IaaS account</li><li>As a precaution you should not deploy the Kubernetes dashboard on this Shoot cluster</li><li>Register this newly created Shoot cluster as a Seed cluster in the Gardener</li><li>End user Shoot clusters can then be created using this newly created Seed cluster (which in turn is a Shoot cluster).</li></ul><p>A tutorial on how to create a shooted seed cluster can be found <a href=/docs/guides/install_gardener/setup-seed>here</a>.</p><p>The rational behind this activity is, that Calico network policies harden this Seed cluster but the community installer uses Flannel which does not offer these features for the Garden cluster.</p><p>When you have added a hardened Seed cluster you are expected not be vulnerable to the Gardener <a href=https://groups.google.com/forum/#!topic/gardener/Pom2Y70cDpw>CVE-2018-2475</a> anymore.</p><h3 id=mitigation-for-kubernetes-cve-2018-1002105>Mitigation for Kubernetes CVE-2018-1002105</h3><p>In addition when you follow the recommendations in the <a href=https://groups.google.com/forum/#!topic/gardener/2icxEz0RAK4>recent Gardener Security Announcement</a> you are expected not be vulnerable to the Kubernetes CVE-2018-1002105 with your hardened Gardener Community Setup.</p><h2 id=alternative-approach>Alternative Approach</h2><p>For this alternative approach there is no Gardener blog available, it is not part of the Gardener Setup Scripts, but it was tested by the Gardener Team at SAP. Use GKE to host a Garden cluster based on Kubernetes v1.10, v1.11 and v1.12 (without the Kubernetes dashboard) in a dedicated GCP account. If you do this by your own, please ensure that the network policies are turned on, which might not be the case by default. Then you can apply the security configuration which Alban Crequy from Kinvolk has recommended in his <a href=/docs/guides/applications/insecure-configuration>blog</a> directly in the Garden cluster and create Shoot clusters from there in a different IaaS account.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d7002605ea6dad33b86146a592a09963>2.2.4 - Manually adding a node to an existing cluster</h1><div class=lead>How to add a node to an existing cluster without the support of Gardener</div><h1 id=manually-adding-a-node-to-an-existing-cluster>Manually adding a node to an existing cluster</h1><p>Gardener has an excellent ability to <a href=/blog/2021-01/00/machine-controller-manager>automatically scale machines</a> for the cluster. From the point of view
of scalability, there is no need for manual intervention.</p><p>This tutorial is useful for those end-users who need specifically configured nodes, which are not yet supported
by Gardener. For example: an end-user who wants some workload that requires <code>runnc</code> instead of <code>runc</code> as container
runtime.</p><p><img src=/__resources/teaser_bdea32.svg alt=teaser></p><h2 id=disclaimer>Disclaimer</h2><blockquote><p>Here we will look at the steps on how to add a node to an existing cluster without the support of Gardener.
Such a node will not be managed by Gardener, and if it goes down for any reason, Gardener will not be
responsible to replace it.</p></blockquote><h2 id=how>How</h2><ol><li><p>Create a new instance in the same VPC/network as other machines in the cluster. You should be able to ssh into the machine. So save its private key, and assign a public IP to it. If adding a public IP is not preferred, then ssh into any other machine in the cluster, and then ssh from there into the new machine using its private key.</p><p>To ssh into a machine which is already in the cluster, use the steps defined <a href=/docs/guides/monitoring_and_troubleshooting/shell-to-node title=ssh-into-node>here</a>.</p><p>Attach the same IAM role to the new machine which is attached to the existing machines in the cluster. This is required by kubelet in the new machine so that it can contact the cloud provider to query the node&rsquo;s name.</p></li><li><p>On the new machine, create file <code>/var/lib/kubelet/kubeconfig-bootstrap</code> with the following content:</p></li></ol><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>kubelet-bootstrap@default</span><span class=w>
</span><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>certificate-authority-data</span><span class=p>:</span><span class=w> </span><span class=l>&lt;CA Certificate&gt;</span><span class=w>
</span><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Server&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>kubelet-bootstrap</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubelet-bootstrap@default</span><span class=w>
</span><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubelet-bootstrap</span><span class=w>
</span><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>as-user-extra</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span><span class=w>    </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Token&gt;</span><span class=w>
</span></code></pre></div><ol start=3><li>ssh into an existing node, and run these commands to get the values of <ca certificate>and <server>to be replaced in above file:</li></ol><ul><li>&lt;Servr></li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash> /opt/bin/hyperkube kubectl <span class=se>\
</span><span class=se></span>   --kubeconfig /var/lib/kubelet/kubeconfig-real <span class=se>\
</span><span class=se></span>   config view <span class=se>\
</span><span class=se></span>   -o go-template<span class=o>=</span><span class=s1>&#39;{{index .clusters 0 &#34;cluster&#34; &#34;server&#34;}}&#39;</span> <span class=se>\
</span><span class=se></span>   --raw
</code></pre></div><ul><li>&lt;CA Certificate></li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>/opt/bin/hyperkube kubectl <span class=se>\
</span><span class=se></span>   --kubeconfig /var/lib/kubelet/kubeconfig-real <span class=se>\
</span><span class=se></span>   config view <span class=se>\
</span><span class=se></span>   -o go-template<span class=o>=</span><span class=s1>&#39;{{index .clusters 0 &#34;cluster&#34; &#34;certificate-authority-data&#34;}}&#39;</span> <span class=se>\
</span><span class=se></span>   --raw
</code></pre></div><ol start=4><li><p>&lt;Token><br>The kubelet on the new machine needs a bootstrap token to authenticate with the kube-apiserver when adding itself to the cluster. Kube-apiserver uses a secret in the <code>kube-system</code> namespace to authenticate this token. This token is valid for 90 minutes from the time of creation, and the corresponding secret captures this detail in its <code>.data.expiration</code> field. The name of this secret is of the format <code>bootstrap-token-*</code>. Gardener takes care of creating new bootstrap tokens, and the corresponding secrets.
To get an unexpired token, find the secrets with the name format <code>bootstrap-token-*</code> in the <code>kube-system</code> namespace in the cluster, and pick the one with minimum age. Eg. <code>bootstrap-token-abcdef</code>.<br>Run these commands to get the token:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash> <span class=nv>tokenid</span><span class=o>=</span><span class=k>$(</span>kubectl get secret bootstrap-token-abcdef -n kube-system -o go-template<span class=o>=</span><span class=s1>&#39;{{index .data &#34;token-id&#34;}}&#39;</span> <span class=p>|</span> base64 --decode<span class=k>)</span>

 <span class=nv>tokensecret</span><span class=o>=</span><span class=k>$(</span>kubectl get secret bootstrap-token-abcdef -n kube-system -o go-template<span class=o>=</span><span class=s1>&#39;{{index .data &#34;token-secret&#34;}}&#39;</span> <span class=p>|</span> base64 --decode<span class=k>)</span>

 <span class=nb>echo</span> <span class=nv>$tokenid</span>.<span class=nv>$tokensecret</span>
</code></pre></div><p>The value of $TOKEN will be <code>tokenid.tokensecret</code>. Replace $TOKEN in above file with this value</p></li><li><p>Copy contents of the files - <code>/var/lib/kubelet/config/kubelet</code>, <code>/var/lib/kubelet/ca.crt</code> and <code>/etc/systemd/system/kubelet.service</code> - from an existing node to the new node</p></li><li><p>Run the following command in the new node to start the kubelet:</p></li></ol><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>systemctl <span class=nb>enable</span> kubelet <span class=o>&amp;&amp;</span> systemctl start kubelet
</code></pre></div><p>The new node should be added to the existing cluster within a couple of minutes.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b226b144fd3cd9bed81a4429318310db>2.2.5 - Setting up a Seed Cluster</h1><div class=lead>How to configure a Kubernetes cluster as a Gardener seed</div><h1 id=the-seed-cluster>The Seed Cluster</h1><p>The <a href=https://github.com/gardener/landscape-setup-template>landscape-setup-template</a> is meant to provide an as-simple-as-possible Gardener installation. Therefore it just registers the cluster where the Gardener is deployed on as a seed cluster. While this is easy, it might be insecure. Clusters created with Kubify don&rsquo;t have network policies, for example. See <a href=/docs/guides/install_gardener/secure-setup>Hardening the Gardener Community Setup</a> for more information.</p><p>To have network policies on the seed cluster and avoid having the seed on the same cluster as the Gardener, the easiest option is probably to simply create a shoot and then register that shoot as seed. This way you can also leverage other advantages of shooted clusters for your seed, e.g. autoscaling.</p><h2 id=setting-up-the-shoot>Setting up the Shoot</h2><p>The first step is to create a shoot cluster. Unfortunately, the Gardener dashboard currently does not allow to change the CIDRs for the created shoot clusters, and your shoots won&rsquo;t work if they have overlapping CIDR ranges with their corresponding seed cluster. So either your seed cluster is deployed with different CIDRs - not using the dashboard, but <code>kubectl apply</code> and a yaml file - or all of your shoots on that seed need to be created this way. In order to be able to use the dashboard for the shoots, it makes sense to create the seed with different CIDRs.</p><p>So, create yourself a shoot with modified CIDRs. You can find templates for the shoot manifest <a href=https://github.com/gardener/gardener/tree/master/example>here</a>. You could, for example, change the CIDRs to this:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>      </span><span class=l>...</span><span class=w>
</span><span class=w>      </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>internal</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=m>10.254.112.0</span><span class=l>/22</span><span class=w>
</span><span class=w>        </span><span class=nt>nodes</span><span class=p>:</span><span class=w> </span><span class=m>10.254.0.0</span><span class=l>/19</span><span class=w>
</span><span class=w>        </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=m>10.255.0.0</span><span class=l>/17</span><span class=w>
</span><span class=w>        </span><span class=nt>public</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=m>10.254.96.0</span><span class=l>/22</span><span class=w>
</span><span class=w>        </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=m>10.255.128.0</span><span class=l>/17</span><span class=w>
</span><span class=w>        </span><span class=nt>vpc</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>10.254.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>        </span><span class=nt>workers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=m>10.254.0.0</span><span class=l>/19</span><span class=w>
</span><span class=w>      </span><span class=l>...</span><span class=w>
</span></code></pre></div><p>Also make sure that your new seed cluster has enough resources for the expected number of shoots.</p><h2 id=registering-the-shoot-as-seed>Registering the Shoot as Seed</h2><p>The seed itself is a Kubernetes resource that can be deployed via a yaml file, but it has some dependencies. You can find templated versions of these files in the <a href=https://github.com/gardener/landscape-setup/tree/0.5.0/components/seed-config>seed-config component</a> of the landscape-setup-template project. If you have set up your Gardener using this project, there should also be rendered versions of these files in the <code>state/seed-config/</code> directory of your landscape folder (they are probably easier to work with). Examples for all these files can also be found in the aforementioned example folder in the Gardener repo.</p><h3 id=1-seed-namespace>1. Seed Namespace</h3><p>First, you should create a namespace for your new seed and everything that belongs to it. This is not necessary, but it will keep your cluster organized. For this example, the namespace will be called <code>seed-test</code>.</p><h3 id=2-cloud-provider-secret>2. Cloud Provider Secret</h3><p>The Gardener needs to create resources on the seed and thus needs a kubeconfig for it. It is provided with the cloud provider secret (below is an example for AWS).</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-seed-secret</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>seed-test</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cloudprofile.garden.sapcloud.io/name</span><span class=p>:</span><span class=w> </span><span class=l>aws </span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>accessKeyID</span><span class=p>:</span><span class=w> </span><span class=l>&lt;base64-encoded AWS access key&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>secretAccessKey</span><span class=p>:</span><span class=w> </span><span class=l>&lt;base64-encoded AWS secret key&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>kubeconfig</span><span class=p>:</span><span class=w> </span><span class=l>&lt;base64-encoded kubeconfig&gt;</span><span class=w>
</span></code></pre></div><p>Deploy the secret into your seed namespace. Apart from the kubeconfig, also infrastructure credentials are required. They will only be used for the etcd backup, so in case for AWS, S3 privileges should be sufficient.</p><h3 id=3-secretbinding-for-cloud-provider-secret>3. Secretbinding for Cloud Provider Secret</h3><p>Create a secretbinding for your cloud provider secret:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>SecretBinding</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-seed-secret</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>seed-test</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cloudprofile.garden.sapcloud.io/name</span><span class=p>:</span><span class=w> </span><span class=l>aws</span><span class=w>
</span><span class=w></span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-seed-secret</span><span class=w>
</span><span class=w></span><span class=c># namespace: only required if in different namespace than referenced secret</span><span class=w>
</span><span class=w></span><span class=nt>quotas</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></code></pre></div><p>You can give it the same name as the referenced secret.</p><h3 id=4-cloudprofile>4. Cloudprofile</h3><p>The cloudprofile contains the information which shoots can be created with this seed. You could create a new cloudprofile, but you can also just reference the existing cloudprofile if you don&rsquo;t want to change anything.</p><h3 id=5-seed>5. Seed</h3><p>Now the seed resource can be created. Choose a name, reference cloudprofile and secretbinding, fill in your ingress domain, and set the CIDRs to the same values as in the underlying shoot cluster.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Seed</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>aws-secure</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>provider</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws</span><span class=w>
</span><span class=w>    </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-seed-secret</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>seed-test</span><span class=w>
</span><span class=w>  </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>ingressDomain</span><span class=p>:</span><span class=w> </span><span class=l>ingress.&lt;your cluster domain&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>nodes</span><span class=p>:</span><span class=w> </span><span class=m>10.254.0.0</span><span class=l>/19</span><span class=w>
</span><span class=w>    </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=m>10.255.0.0</span><span class=l>/17</span><span class=w>
</span><span class=w>    </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=m>10.255.128.0</span><span class=l>/17</span><span class=w>
</span></code></pre></div><h3 id=6-hide-original-seed>6. Hide Original Seed</h3><p>In the dashboard, it is not possible to select the seed for a shoot (it is possible when deploying the shoot using a yaml file, however). Since both seeds probably reference the same cloudprofile, the Gardener will try to distribute the shoots equally among both seeds.</p><p>To solve this problem, edit the original seed and set its <code>spec.visible</code> field to <code>false</code>. This will prevent the Gardener from choosing this seed, so now all shoots created via the dashboard should have their control plane on the new, more secure seed.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-db9e41f7ef6a1a47f4ca49bdf49d64db>2.3 - Administer Client (Shoot) Clusters</h1></div><div class=td-content><h1 id=pg-20b7481bda85a0ae6f7a88f4e470d6fc>2.3.1 - Hibernate a Cluster</h1><p>Clusters are only needed 24 hours a day if they run productive workload. So whenever you do development in a cluster, or just use it for tests or demo purposes, you can save much money if you scale-down your Kubernetes resources whenever you don&rsquo;t need them. However, scaling them down manually can become time-consuming the more resources you have.</p><p>Gardener offers a clever way to automatically scale-down all resources to zero: cluster hibernation. You can either hibernate a cluster by pushing a button or by defining a hibernation schedule.</p><blockquote><p>To save costs, it&rsquo;s recommended to define a hibernation schedule before the creation of a cluster. You can hibernate your cluster or wake up your cluster manually even if there&rsquo;s a schedule for its hibernation.</p></blockquote><ul><li><a href=#what-is-hibernated>What is hibernated?</a></li><li><a href=#what-isnt-affected-by-the-hibernation>What isn’t affected by the hibernation?</a></li><li><a href=#hibernate-your-cluster-manually>Hibernate your cluster manually</a></li><li><a href=#wake-up-your-cluster-manually>Wake up your cluster manually</a></li><li><a href=#create-a-schedule-to-hibernate-your-cluster>Create a schedule to hibernate your cluster</a></li></ul><h2 id=what-is-hibernated>What is hibernated?</h2><p>When a cluster is hibernated, Gardener scales down worker nodes and deletes the cluster&rsquo;s control plane to free resources at the IaaS provider. This affects:</p><ul><li>Your workload, for example, pods, deployments, custom resources.</li><li>The virtual machines running your workload.</li><li>The resources of the control plane of your cluster.</li></ul><h2 id=what-isnt-affected-by-the-hibernation>What isn’t affected by the hibernation?</h2><p>To scale up everything where it was before hibernation, Gardener doesn’t delete state-related information, that is, information stored in persistent volumes. The cluster state as persistent in <code>etcd</code> is also preserved.</p><h2 id=hibernate-your-cluster-manually>Hibernate your cluster manually</h2><ol><li><p>On the Gardener dashboard, choose <em>CLUSTERS</em> > <em>[YOUR-CLUSTER]</em> > <em>OVERVIEW</em> > <em>Lifecycle</em> > <em>Hibernation</em> > <em>Hibernate Cluster</em>.</p><p><img src=/__resources/Hibernate-Cluster_817c08.png alt="Hibernate Cluster"></p></li><li><p>To confirm the hibernation, enter the name of your cluster and choose <em>HIBERNATE</em>.</p></li></ol><blockquote><p>You can also hibernate your cluster by setting <code>spec.hibernation.enabled</code> to <code>true</code> in the cluster&rsquo;s YAML file. To change it on the dashboard, choose <em>CLUSTERS</em> > <em>[YOUR-CLUSTER]</em> > <em>YAML</em>.</p></blockquote><p>As soon as the cluster was hibernated successfully, its status is shown as <code>ZZZ</code> in the list of clusters:</p><p><img src=/__resources/Hibernation-Status_44c3ff.png alt="Hibernation Status"></p><h2 id=wake-up-your-cluster-manually>Wake up your cluster manually</h2><ol><li><p>On the Gardener dashboard, choose <em>CLUSTERS</em> > <em>[YOUR-CLUSTER]</em> > <em>OVERVIEW</em> > <em>Lifecycle</em> > <em>Hibernation</em> > <em>Wake up Cluster</em>.</p><p><img src=/__resources/Wake-up-Cluster_e04b9c.png alt="Wake up Cluster"></p></li><li><p>To confirm waking up the cluster, choose <em>Wake Up</em>.</p></li></ol><blockquote><p>You can also wake up your cluster by setting <code>spec.hibernation.enabled</code> to <code>false</code> in the cluster&rsquo;s YAML file. To change it on the dashboard, choose <em>CLUSTERS</em> > <em>[YOUR-CLUSTER]</em> > <em>YAML</em>.</p></blockquote><h2 id=create-a-schedule-to-hibernate-your-cluster>Create a schedule to hibernate your cluster</h2><ol><li><p>You can create a hibernation schedule for a cluster in the creation dialog of the Gardener dashboard. To create it later or to change it, choose <em>CLUSTERS</em> > <em>[YOUR-CLUSTER]</em> > <em>OVERVIEW</em> > <em>Lifecycle</em> > <em>Hibernation</em> > <em>Configure Hibernation Schedule</em>.</p><p><img src=/__resources/Hibernation-Schedule_6c5794.png alt="Hibernation Schedule"></p></li><li><p>Changes made on the Gardener dashboard for your cluster are immediately written to the cluster&rsquo;s YAML file on tab <em>CLUSTERS</em> > <em>[YOUR-CLUSTER]</em> > <em>YAML</em>. You can find the hibernation schedule in field <code>spec.hibernation.schedules</code>. The schedule is defined like a cron job in Linux. More information: <a href=https://gardener.cloud/api-reference/core/#core.gardener.cloud/v1beta1.HibernationSchedule>HibernationSchedule</a>.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-2341371c4780b4857a5d435af93bb356>2.3.2 - Create / Delete a Shoot cluster</h1><h1 id=create-a-shoot-cluster>Create a Shoot Cluster</h1><p>As you have already prepared an <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml>example Shoot manifest</a> in the steps described in the development documentation, please
open another Terminal pane/window with the <code>KUBECONFIG</code> environment variable pointing to the Garden development cluster and send the manifest to the Kubernetes API server:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl apply -f your-shoot-aws.yaml
</code></pre></div><p>You should see that the Gardener has immediately picked up your manifest and started to deploy the Shoot cluster.</p><p>In order to investigate what is happening in the Seed cluster, please download its proper Kubeconfig yourself (see next paragraph). The namespace of the Shoot cluster in the Seed cluster will look like that: <code>shoot-johndoe-johndoe-1</code>, whereas the first <code>johndoe</code> is your namespace in the Garden cluster (also called &ldquo;project&rdquo;) and the <code>johndoe-1</code> suffix is the actual name of the Shoot cluster.</p><p>To connect to the newly created Shoot cluster, you must download its Kubeconfig as well. Please connect to the proper Seed cluster, navigate to the Shoot namespace, and download the Kubeconfig from the <code>kubecfg</code> secret in that namespace.</p><h1 id=delete-a-shoot-cluster>Delete a Shoot Cluster</h1><p>In order to delete your cluster, you have to set an annotation confirming the deletion first, and trigger the deletion after that. You can use the prepared <code>delete shoot</code> script which takes the Shoot name as first parameter. The namespace can be specified by the second parameter, but it is optional. If you don&rsquo;t state it, it defaults to your namespace (the username you are logged in with to your machine).</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ ./hack/usage/delete shoot johndoe-1 johndoe
</code></pre></div><p>( <code>hack</code> bash script can be found here <a href=https://github.com/gardener/gardener/blob/master/hack/usage/delete>https://github.com/gardener/gardener/blob/master/hack/usage/delete</a>)</p><h1 id=configure-a-shoot-cluster-alert-receiver>Configure a Shoot cluster alert receiver</h1><p>The receiver of the Shoot alerts can be configured from the <code>.spec.monitoring.alerting.emailReceivers</code> section in the Shoot specification. The value of the field has to be a list of valid mail addresses.</p><p>The alerting for the Shoot clusters is handled by the Prometheus Alertmanager. The Alertmanager will be deployed next to the control plane when the <code>Shoot</code> resource specifies <code>.spec.monitoring.alerting.emailReceivers</code> and if a <a href=https://github.com/gardener/gardener/blob/master/example/10-secret-alerting.yaml>SMTP secret</a> exists.</p><p>If the field gets removed then the Alertmanager will be also removed during the next reconcilation of the cluster. The opposite is also valid if the field is added to an existing cluster.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-89160b6c49ea807fa2f877159a87c52e>2.3.3 - Create a kubernetes cluster in AWS with Gardener</h1><h3 id=prerequisites>Prerequisites</h3><ul><li>You need an AWS account.</li><li>You have access to the Gardener dashboard and have permissions to create projects.</li></ul><ol><li><p>Go to the Gardener dashboard and create a <em>Project</em>.</p><img src=/__resources/new_gardener_project_7fad98.jpg></li><li><p>To copy the policy for AWS from the Gardener dashboard, choose <em>Secrets</em>, click on the help icon <img src=https://github.com/gardener/documentation/raw/master/website/documentation/guides/administer_shoots/gardener_aws/images/help_icon.jpg> for AWS secrets, and choose copy <img src=/__resources/copy_icon_de5735.png>.</p><img src=/__resources/gardener_copy_policy_f15862.jpg></li><li><p>To <a href=https://console.aws.amazon.com/iam/home?#/policies>create a new policy</a> in AWS, paste the policy that you copied from the Gardener dashboard to this custom policy.</p><img src=/__resources/create_policy_e1a9eb.jpg>
<img src=/__resources/review_policy_8fef03.jpg></li><li><p><a href="https://console.aws.amazon.com/iam/home?#/users$new?step=details">Create a new technical user</a>.</p><img src=/__resources/adduser_2275d8.jpg>
<img src=/__resources/attachpolicy_1949de.jpg>
<img src=/__resources/finishuser_8d9cdb.jpg><blockquote><p>Note: After the user is created, <code>Access key ID</code> and <code>Secret access key</code> are generated and displayed. Remember to save them. The <code>Access key ID</code> is used later to create secrets for Gardener.</p></blockquote><img src=/__resources/savekeys_71cc3a.jpg></li><li><p>On the Gardener dashboard, choose <em>Secrets</em> and then the plus sign <img src=https://github.com/gardener/documentation/raw/master/website/documentation/guides/administer_shoots/gardener_aws/images/plus_icon.jpg> in the AWS frame to add a new AWS secret.</p></li><li><p>Copy the <code>Access Key ID</code> and <code>Secret Access Key</code> you saved when you created the technical user on AWS.</p><img src=/__resources/add_AWS_Secret_f9bae6.jpg>
<img src=/__resources/secret_stored_c892d2.jpg></li><li><p>To create a new cluster, choose <em>Clusters</em> and then the plus sign in the lower right corner.</p><img src=/__resources/new_cluster_912a2a.jpg></li><li><p>On tab <em>INFRASTRUCTURE</em>, choose the secret you created before. The technical user related to the chosen Secret is used to create infrastructure resources.</p><img src=/__resources/create_cluster2_bb2856.jpg>
<img src=/__resources/create_cluster3_999a44.jpg>
<img src=/__resources/create_cluster4_6687f6.jpg>
<img src=/__resources/create_cluster5_1e9c7d.jpg></li><li><p>Copy kubeconfig.</p><img src=/__resources/copy_kubeconfig_b54c68.jpg></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-a6bc1ee3493ef535ad63d0a033804a7b>2.3.4 - Create a kubernetes cluster on GCP with Gardener</h1><h3 id=prerequisites>Prerequisites</h3><ul><li>You need a GCP account.</li><li>You have access to the Gardener dashboard and have permissions to create projects.</li></ul><ol><li><p>Go to the Gardener dashboard and create a <em>Project</em>.</p><img src=/__resources/new_gardener_project_999b96.jpg></li><li><p>To check which roles are required by Gardener, choose <em>Secrets</em>, and click on the help button <img src=https://github.com/gardener/documentation/raw/master/website/documentation/guides/administer_shoots/gardener_gcp/images/help_icon.jpg> for GCP.
<img src=/__resources/gardenergcpsecret1_e23a0d.jpg></p><img src=/__resources/gardenergcpsecret2_57b46b.jpg></li><li><p><a href=https://console.cloud.google.com/iam-admin/serviceaccounts>Create a new service account in GCP</a> and assign the roles required by Gardener.</p><img src=/__resources/gcpcreateserviceaccount0_f15ed5.jpg>
<img src=/__resources/gcpcreateserviceaccount1_3d835d.jpg></li><li><p>To create a key for the service account, choose <em>Actions</em> and then <em>Create key</em>.</p><img src=/__resources/gcpcreatekey_995d2b.jpg></li><li><p>Save the private key of the service account in JSON format.
<img src=/__resources/gcpdownloadkey_49f630.jpg></p><blockquote><p>Note: Save the key of the user, it’s used later to create secrets for Gardener.</p></blockquote></li><li><p><a href=https://console.developers.google.com/apis/library/compute.googleapis.com>Enable the Google compute API</a>.</p><img src=/__resources/gcpcomputeengineapi_adc0f5.jpg></li><li><p><a href=https://console.developers.google.com/apis/api/iam.googleapis.com/overview>Enable the Google IAM API</a>.
<img src=/__resources/gcpiamapi_586344.jpg></p></li><li><p>On the Gardener dashboard, choose <em>Secrets</em> and then the plus sign <img src=https://github.com/gardener/documentation/raw/master/website/documentation/guides/administer_shoots/gardener_gcp/images/plus_icon.jpg> in the GCP frame to add a new GCP secret.</p><img src=/__resources/gardenergcpsecret01_84d788.jpg>
<img src=/__resources/gardeneraddgcpsecret_c01910.jpg></li><li><p>To create a new cluster, choose <em>Clusters</em> and then the plus sign in the lower right corner.</p><img src=/__resources/new_cluster_26eb5a.jpg></li><li><p>On tab <em>INFRASTRUCTURE</em>, choose the secret you created before.</p><img src=/__resources/gcpcreatecluster1_ec5273.jpg>
<img src=/__resources/gcpcreatecluster2_f48def.jpg>
<img src=/__resources/create_cluster4_82c018.jpg>
<img src=/__resources/gcpcreatecluster2_f48def.jpg></li><li><p>Copy kubeconfig.</p><img src=/__resources/copy_kubeconfig_3b7b54.jpg></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-c4bf829bf283322bf7b7a67cb455fb03>2.3.5 - Create a Shoot cluster into existing AWS VPC</h1><h1 id=create-a-shoot-cluster-into-existing-aws-vpc>Create a Shoot cluster into existing AWS VPC</h1><p>Gardener can create a new VPC, or use an existing one for your Shoot cluster. Depending on your needs you may want to create Shoot(s) into already created VPC.
The tutorial describes how to create a Shoot cluster into existing AWS VPC. The steps are identical for Alicloud, Azure, and GCP. Please note that the existing VPC must be in the same region like the shoot cluster that you want to deploy into the VPC.</p><h2 id=tldr>TL;DR</h2><p>If <code>.spec.provider.infrastructureConfig.networks.vpc.cidr</code> is specified, Gardener will create a new VPC with the given CIDR block and respectively will delete it on Shoot deletion.<br>If <code>.spec.provider.infrastructureConfig.networks.vpc.id</code> is specified, Gardener will use the existing VPC and respectively won&rsquo;t delete it on Shoot deletion.</p><blockquote><p>It&rsquo;s not recommended to create a Shoot cluster into VPC that is managed by Gardener (that is created for another Shoot cluster). In this case the deletion of the initial Shoot cluster will fail to delete the VPC because there will be resources attached to it.<br>Gardener won&rsquo;t delete any manually created (unmanaged) resources in your cloud provider account.</p></blockquote><h2 id=1-configure-aws-cli>1. Configure AWS CLI</h2><p>The <code>aws configure</code> command is a convenient way to setup your AWS CLI. It will prompt you for your credentials and settings which will be used in the following AWS CLI invocations.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ aws configure
AWS Access Key ID <span class=o>[</span>None<span class=o>]</span>: &lt;ACCESS_KEY_ID&gt;
AWS Secret Access Key <span class=o>[</span>None<span class=o>]</span>: &lt;SECRET_ACCESS_KEY&gt;
Default region name <span class=o>[</span>None<span class=o>]</span>: &lt;DEFAULT_REGION&gt;
Default output format <span class=o>[</span>None<span class=o>]</span>: &lt;DEFAULT_OUTPUT_FORMAT&gt;
</code></pre></div><h2 id=2-create-vpc>2. Create VPC</h2><p>Create the VPC by running the following command:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ aws ec2 create-vpc --cidr-block &lt;cidr-block&gt;
<span class=o>{</span>
  <span class=s2>&#34;Vpc&#34;</span>: <span class=o>{</span>
      <span class=s2>&#34;VpcId&#34;</span>: <span class=s2>&#34;vpc-ff7bbf86&#34;</span>,
      <span class=s2>&#34;InstanceTenancy&#34;</span>: <span class=s2>&#34;default&#34;</span>,
      <span class=s2>&#34;Tags&#34;</span>: <span class=o>[]</span>,
      <span class=s2>&#34;CidrBlockAssociations&#34;</span>: <span class=o>[</span>
          <span class=o>{</span>
              <span class=s2>&#34;AssociationId&#34;</span>: <span class=s2>&#34;vpc-cidr-assoc-6e42b505&#34;</span>,
              <span class=s2>&#34;CidrBlock&#34;</span>: <span class=s2>&#34;10.0.0.0/16&#34;</span>,
              <span class=s2>&#34;CidrBlockState&#34;</span>: <span class=o>{</span>
                  <span class=s2>&#34;State&#34;</span>: <span class=s2>&#34;associated&#34;</span>
              <span class=o>}</span>
          <span class=o>}</span>
      <span class=o>]</span>,
      <span class=s2>&#34;Ipv6CidrBlockAssociationSet&#34;</span>: <span class=o>[]</span>,
      <span class=s2>&#34;State&#34;</span>: <span class=s2>&#34;pending&#34;</span>,
      <span class=s2>&#34;DhcpOptionsId&#34;</span>: <span class=s2>&#34;dopt-38f7a057&#34;</span>,
      <span class=s2>&#34;CidrBlock&#34;</span>: <span class=s2>&#34;10.0.0.0/16&#34;</span>,
      <span class=s2>&#34;IsDefault&#34;</span>: <span class=nb>false</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>Gardener requires the VPC to have enabled <a href=https://docs.aws.amazon.com/vpc/latest/userguide/vpc-dns.html>DNS support</a>, i.e the attributes <code>enableDnsSupport</code> and <code>enableDnsHostnames</code> must be set to true. <code>enableDnsSupport</code> attribute is enabled by default, <code>enableDnsHostnames</code> - not. Set the <code>enableDnsHostnames</code> attribute to true:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ aws ec2 modify-vpc-attribute --vpc-id vpc-ff7bbf86 --enable-dns-hostnames
</code></pre></div><h2 id=3-create-internet-gateway>3. Create Internet Gateway</h2><p>Gardener also requires that an internet gateway is attached to the VPC. You can create one using:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ aws ec2 create-internet-gateway
<span class=o>{</span>
    <span class=s2>&#34;InternetGateway&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;Tags&#34;</span>: <span class=o>[]</span>,
        <span class=s2>&#34;InternetGatewayId&#34;</span>: <span class=s2>&#34;igw-c0a643a9&#34;</span>,
        <span class=s2>&#34;Attachments&#34;</span>: <span class=o>[]</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>and attach it to the VPC using:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ aws ec2 attach-internet-gateway --internet-gateway-id igw-c0a643a9 --vpc-id vpc-ff7bbf86
</code></pre></div><h2 id=4-create-the-shoot>4. Create the Shoot</h2><p>Prepare your Shoot manifest (you could check the <a href=https://github.com/gardener/gardener/tree/master/example>example manifests</a>). Please make sure that you choose the
region in which you had created the VPC earlier (step 2). Also, put your VPC ID in the <code>.spec.provider.infrastructureConfig.networks.vpc.id</code> field:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>&lt;aws-region-of-vpc&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>provider</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws</span><span class=w>
</span><span class=w>    </span><span class=nt>infrastructureConfig</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>aws.provider.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InfrastructureConfig</span><span class=w>
</span><span class=w>      </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>vpc</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>vpc-ff7bbf86</span><span class=w>
</span><span class=w>    </span><span class=c># ...</span><span class=w>
</span></code></pre></div><p>Apply your Shoot manifest.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl apply -f your-shoot-aws.yaml
</code></pre></div><p>Ensure that the Shoot cluster is properly created.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl get shoot <span class=nv>$SHOOT_NAME</span> -n <span class=nv>$SHOOT_NAMESPACE</span>
NAME           CLOUDPROFILE   VERSION   SEED   DOMAIN           OPERATION   PROGRESS   APISERVER   CONTROL   NODES   SYSTEM   AGE
&lt;SHOOT_NAME&gt;   aws            1.15.0    aws    &lt;SHOOT_DOMAIN&gt;   Succeeded   <span class=m>100</span>        True        True      True    True     20m
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8347c81da1563e74d1ecc9dc9652dce3>2.3.6 - Create Shoot Clusters in Alibaba Cloud</h1><h1 id=create-shoot-clusters-in-alibaba-cloud>Create Shoot Clusters in Alibaba Cloud</h1><h2 id=prerequisites>Prerequisites</h2><ul><li>You need an Alibaba Cloud account.</li><li>You have access to the Gardener dashboard and have permissions to create projects.</li></ul><h2 id=procedure>Procedure</h2><ol><li><p>Go to the Gardener dashboard and create a project.</p><p><img src=/__resources/Create-new-project-in-Gardener_75be9e.png alt="Create new project in Gardener"></p><blockquote><p>To be able to add shoot clusters to this project, you must first create a technical user on Alibaba cloud with sufficient permissions.</p></blockquote></li><li><p>To copy the policy for Alibaba Cloud from the Gardener dashboard, choose <em>Secrets</em>, click on the help button ( <img src=/__resources/Help-icon_698de6.png alt="Help icon"> ) for Alibaba Cloud secrets, and choose copy ( <img src=/__resources/Copy-icon_ed02ce.png alt="Copy icon"> ).</p><p><img src=/__resources/Alibaba-Cloud---copy-required-policies-from-Gardener-dashboard_3f407f.png alt="Alibaba Cloud - copy required policies from Gardener dashboard"></p></li><li><p>To create a custom policy in Alibaba cloud, log on to your Alibaba account and choose <em>RAM</em> > <em>Permissions</em> > <em>Policies</em>. Paste policy that you copied from the Gardener dashboard to this custom policy.</p><p><img src=/__resources/Alibaba---Create-Custom-Policy_077b8d.png alt="Alibaba - Create Custom Policy"></p></li><li><p>In the Alibaba cloud console, choose <em>RAM</em> > <em>Users</em> and create a new technical user.</p><blockquote><p>After the user is created, <code>AccessKeyId</code> and <code>AccessKeySecret</code> are generated and displayed. Remember to save them. The <code>AccessKey</code> is used later to create secrets for Gardener.</p></blockquote><p><img src=/__resources/Alibaba---Create-Technical-User_24ce9b.png alt="Alibaba - Create Technical User"></p></li><li><p>Choose <em>RAM</em> > <em>Permissions</em> > <em>Grants</em> and assign the policy you’ve created before to the technical user.</p><p><img src=/__resources/Alibaba---Grant-Permissions_843ef6.png alt="Alibaba - Grant Permissions"></p></li><li><p>On the Gardener dashboard, choose <em>Secrets</em> and then the plus sign in the Alibaba Cloud frame to add a new Alibaba Cloud secret.</p></li><li><p>Copy the <code>AccessKeyId</code> and <code>AccessKeySecret</code> you saved when you created the technical user on Alibaba Cloud Console.</p><p><img src=/__resources/Gardener---Add-Alibaba-Cloud-Secret_9b8786.png alt="Gardener - Add Alibaba Cloud Secret"></p><blockquote><p>After successfully creating secrets for Alibaba Cloud, you can see them in the corresponding dropdown list whenever you create a shoot cluster on Alibaba cloud.</p></blockquote></li><li><p>Choose <em>Clusters</em> and then the plus sign in the lower right.</p></li><li><p>On tab <em>INFRASTRUCTURE</em>, choose the secret you created before. The technical user related to the chosen Secret is used to create infrastructure resources on Alibaba Cloud.</p><p><img src=/__resources/Gardener---Assign-Alibaba-Cloud-Secret_0fef77.png alt="Gardener - Assign Alibaba Cloud Secret"></p></li></ol><h2 id=result>Result</h2><p>You can now create shoot clusters on Alibaba cloud.</p><blockquote><p>The size of persistent volumes in your shoot cluster must at least be 20 GiB large. If you choose smaller sizes in your Kubernetes PV definition, the allocation of cloud disk space on Alibaba cloud fails.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-968bb710e1dfc6a63a927387741229e2>2.3.7 - Create shoot clusters in Azure</h1><h1 id=create-shoot-clusters-in-azure>Create shoot clusters in Azure</h1><h3 id=prerequisites>Prerequisites</h3><ul><li>You need an Azure account.</li><li>You have access to the Gardener dashboard and have permissions to create projects.</li></ul><p>Before you can provision and access a Kubernetes cluster on Azure, you need to add the account credentials in Gardener.
Gardener needs the credentials to provision and operate the Azure infrastructure for your Kubernetes cluster.</p><blockquote><p>Ensure that the account has the <strong>contributor</strong> role.</p></blockquote><ol><li><p>Request a new service account on Azure.</p><p>You must <a href=https://jira.multicloud.int.sap/plugins/servlet/desk/portal/2>request a new service account</a> first, if you don&rsquo;t have one.</p><img src=/__resources/request_spn_7fb44f.jpg><p>Naming Convention for the Service UserID: <code>azrspn_&lt;PartOfSubName>_usecase</code></p><img src=/__resources/request_spn1_548907.jpg></li><li><p>Get properties of your Azure account/Service Principal.</p><ul><li><p>Tenant ID</p><p>The TenantID is also called DirectoryID - <a href=https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Properties>https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Properties</a>.
<img src=/__resources/azuregettenantid_6606e1.jpg></p></li><li><p>ClientID
Select the subscription.
<img src=/__resources/azureselectsubscription_050a9a.jpg></p></li><li><p>Select the SPN.
<img src=/__resources/azureselectspn_556ee7.jpg></p></li></ul><p><em>Note:</em> The ClientID is also called ApplicationID.
<img src=/__resources/azuregetclientid_3e957d.jpg></p><ul><li>Client Secret
Secrets for the Azure Account/Service Principal can be genereted/rotated via the Azure Portal.
Access the <a href=https://portal.azure.com>Azure Portal</a> and navigate to the <code>Active Directory</code> service.
Within the service navigate to <code>App registrations</code> and select your service principal.
In the detail view navigate to <code>Certificates & secrets</code>. In the section, you can generate a new secret for the Service Principal.</li></ul></li><li><p>On the Gardener dashboard, choose <em>Secrets</em> and then the plus sign <img src=https://github.com/gardener/documentation/raw/master/website/documentation/guides/administer_shoots/gardener_azure/images/plus_icon.jpg> in the Azure frame to add a new Azure secret.</p><img src=/__resources/gardenernewazuresecret_7f1e76.jpg></li><li><p>Provide the details for the Azure service account.<br>After processing the ticket, you’ll receive the Service Principle credentials via email.
Copy &ldquo;Key Value&rdquo; from the email into &ldquo;Client Secret&rdquo;.</p><img src=/__resources/gardeneraddazuresecret_71956d.jpg></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-d0b7dd8dea7acc30bf970486784ab447>2.3.8 - Manage DNS Providers</h1><div class=lead>Manage DNS providers for DNS records in your shoot cluster</div><h1 id=dns-providers>DNS Providers</h1><h2 id=introduction>Introduction</h2><p>Gardener can manage DNS records on your behalf, so that you can request them via different resource types (see <a href=/docs/guides/administer_shoots/dns_names>here</a>) within the shoot cluster. The domains for which you are permitted to request records, are however restricted and depend on the DNS provider configuration.</p><h2 id=shoot-provider>Shoot provider</h2><p>By default, every shoot cluster is equipped with a default provider. It is the very same provider that manages the shoot cluster&rsquo;s <code>kube-apiserver</code> public DNS record (DNS address in your Kubeconfig).</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kind: Shoot
...
dns:
  domain: shoot.project.default-domain.gardener.cloud
</code></pre></div><p>You are permitted to request any sub-domain of <code>.dns.domain</code> that is not already taken (e.g. <code>api.shoot.project.default-domain.gardener.cloud</code>, <code>*.ingress.shoot.project.default-domain.gardener.cloud</code>) with this provider.</p><h2 id=additional-providers>Additional providers</h2><p>If you need to request DNS records for domains not managed by the <a href=#Shoot-provider>default provider</a>, additional providers can
be configured in the shoot specification.
Alternatively, if it is enabled, it can be added as <code>DNSProvider</code> resources to the shoot cluster.</p><h3 id=additional-providers-in-the-shoot-specification>Additional providers in the shoot specification</h3><p>To add a providers in the shoot spec, you need set them in the <code>spec.dns.providers</code> list.</p><p>For example:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>domain</span><span class=p>:</span><span class=w> </span><span class=l>shoot.project.default-domain.gardener.cloud</span><span class=w>
</span><span class=w>    </span><span class=nt>providers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>my-aws-account</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws-route53</span><span class=w>
</span><span class=w>    </span>- <span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>my-gcp-account</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>google-clouddns</span><span class=w>
</span></code></pre></div><blockquote><p>Please consult the <a href=https://gardener.cloud/docs/references/core/#core.gardener.cloud/v1beta1.DNSProvider>API-Reference</a> to get a complete list of supported fields and configuration options.</p></blockquote><p>Referenced secrets should exist in the project namespace in the Garden cluster and must comply with the provider specific credentials format. The <strong>External-DNS-Management</strong> project provides corresponding examples (<a href=https://github.com/gardener/external-dns-management/tree/master/examples>20-secret-&lt;provider-name>-credentials.yaml</a>) for known providers.</p><h3 id=additional-providers-as-resources-in-the-shoot-cluster>Additional providers as resources in the shoot cluster</h3><p>If it is not enabled globally, you have to enable the feature in the shoot manifest:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>Kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-dns-service</span><span class=w>
</span><span class=w>      </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>service.dns.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>        </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DNSConfig</span><span class=w>
</span><span class=w>        </span><span class=nt>dnsProviderReplication</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>To add a provider directly in the shoot cluster, provide a <code>DNSProvider</code> in any namespace together
with <code>Secret</code> containing the credentials.</p><p>For example if the domain is hosted with AWS Route 53 (provider type <code>aws-route53</code>):</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>dns.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DNSProvider</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/class</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-own-domain</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>my-namespace</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws-route53</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-own-domain-credentials</span><span class=w>
</span><span class=w>  </span><span class=nt>domains</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>include</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>my.own.domain.com</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-own-domain-credentials</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>my-namespace</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># replace &#39;...&#39; with values encoded as base64</span><span class=w>
</span><span class=w>  </span><span class=nt>AWS_ACCESS_KEY_ID</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>AWS_SECRET_ACCESS_KEY</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span></code></pre></div><p>The <strong>External-DNS-Management</strong> project provides examples with more details for <code>DNSProviders</code> (30-provider-&lt;provider-name>.yaml)
and credential <code>Secrets</code> (20-secret-&lt;provider-name>.yaml) at <a href=https://github.com/gardener/external-dns-management/tree/master/examples>https://github.com/gardener/external-dns-management//examples</a>
for all supported provider types.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3b636667756f7ecb306629285f7d8177>2.3.9 - Request DNS Names</h1><div class=lead>Requesting DNS Names for Ingresses and Services in Shoot Clusters</div><h1 id=request-dns-names-in-shoot-clusters>Request DNS Names in Shoot Clusters</h1><h2 id=introduction>Introduction</h2><p>Within a shoot cluster, it is possible to request DNS records via the following resource types:</p><ul><li><a href=https://kubernetes.io/docs/concepts/services-networking/ingress/>Ingress</a></li><li><a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a></li><li><a href=https://github.com/gardener/external-dns-management/blob/master/examples/40-entry-dns.yaml>DNSEntry</a></li></ul><p>It is necessary that the Gardener installation your shoot cluster runs in is equipped with a <code>shoot-dns-service</code> extension. This extension uses the seed&rsquo;s dns management infrastructure to maintain DNS names for shoot clusters. Please ask your Gardener operator if the extension is available in your environment.</p><h2 id=shoot-feature-gate>Shoot Feature Gate</h2><p>In some Gardener setups the <code>shoot-dns-service</code> extension is not enabled globally and thus must be configured per shoot cluster. Please adapt the shoot specification by the configuration shown below to activate the extension individually.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-dns-service</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><h2 id=dns-providers-domain-scope>DNS providers, domain scope</h2><p>Gardener can only manage DNS records on your behalf if you have proper DNS providers in place. Please consult <a href=/docs/guides/administer_shoots/dns_providers>this page</a> for more information.</p><h2 id=request-dns-records-via-serviceingress-resources>Request DNS records via Service/Ingress resources</h2><p>To request a DNS name for an Ingress or Service object in the shoot cluster
it must be annotated with the DNS class <code>garden</code> and an annotation denoting
the desired DNS names.</p><p>For a Service (it must have the type <code>LoadBalancer</code>) this looks like this:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/class</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/dnsnames</span><span class=p>:</span><span class=w> </span><span class=l>my.subdomain.for.shootsomain.cloud</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-service</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></code></pre></div><p>The <em>dnsnames</em> annotation accepts a comma-separated list of DNS names, if
multiple names are required.</p><p>For an Ingress, the dns names are already declared in the specification.
Nevertheless the <em>dnsnames</em> annotation must be present. Here a subset of the
dns names of the ingress can be specified. If DNS names for all names are
desired, the value <code>all</code> can be used.</p><p>If one of the accepted dns names is a direct subname of the shoot&rsquo;s ingress
domain, this is already handled by the standard wildcard entry for the ingress
domain. Therefore this name should be excluded from the <em>dnsnames</em> list in the
annotation. If only this dns name is configured in the ingress, no explicit
dns entry is required, and the dns annotations should be omitted at all.</p><h2 id=request-dns-records-via-dnsentry-resources>Request DNS records via DNSEntry resources</h2><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>dns.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DNSEntry</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/class</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dns</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>dnsName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;my.subdomain.for.shootsomain.cloud&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>ttl</span><span class=p>:</span><span class=w> </span><span class=m>600</span><span class=w>
</span><span class=w>  </span><span class=c># txt records, either text or targets must be specified</span><span class=w>
</span><span class=w></span><span class=c># text:</span><span class=w>
</span><span class=w></span><span class=c># - foo-bar</span><span class=w>
</span><span class=w>  </span><span class=nt>targets</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># target records (CNAME or A records)</span><span class=w>
</span><span class=w>  </span>- <span class=m>8.8.8.8</span><span class=w>
</span></code></pre></div><h2 id=dns-record-events>DNS record events</h2><p>The DNS controller publishes Kubernetes events for the resource which requested the DNS record (Ingress, Service, DNSEntry). These events reveal more information about the DNS requests being processed and are especially useful to check any kind of misconfiguration, e.g. requests for a domain you don&rsquo;t own.</p><p>Events for a successfully created DNS record:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl -n default describe service my-service

Events:
  Type    Reason          Age                From                    Message
  ----    ------          ----               ----                    -------
  Normal  dns-annotation  19s                dns-controller-manager  my.subdomain.for.shootsomain.cloud: dns entry is pending
  Normal  dns-annotation  19s (x3 over 19s)  dns-controller-manager  my.subdomain.for.shootsomain.cloud: dns entry pending: waiting for dns reconciliation
  Normal  dns-annotation  9s (x3 over 10s)   dns-controller-manager  my.subdomain.for.shootsomain.cloud: dns entry active
</code></pre></div><p>Please note, events vanish after their retention period (usually <code>1h</code>).</p><h2 id=dnsentry-status>DNSEntry status</h2><p><code>DNSEntry</code> resources offer a <code>.status</code> sub-resource which can be used to check the current state of the object.</p><p>Status of a erroneous <code>DNSEntry</code>.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>  status:
    message: No responsible provider found
    observedGeneration: 3
    provider: remote
    state: Error
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-7ca3e283b0aefb6725b7adf88b74c963>2.3.10 - Request X.509 Certificates</h1><div class=lead>X.509 Certificates For TLS Communication</div><h1 id=request-x509-certificates>Request X.509 Certificates</h1><h2 id=introduction>Introduction</h2><p>Dealing with applications on Kubernetes which offer service endpoints (e.g. HTTP) may also require you to enable a
secured communication via SSL/TLS. Gardener let&rsquo;s you request a commonly trusted X.509 certificate for your application
endpoint. Furthermore, Gardener takes care about the renewal process for your requested certificate.</p><p>Let&rsquo;s get the basics straight first. If this is too long for you, you can read below how to get certificates by</p><ul><li><a href=#request-a-certificate-via-certificate>Certificate Resources</a></li><li><a href=#request-a-certificate-via-ingress>Ingress</a></li><li><a href=#request-a-certificate-via-service>Service</a></li></ul><h2 id=restrictions>Restrictions</h2><h3 id=service-scope>Service Scope</h3><p>This service enables users to request managed X.509 certificates with the help of <a href=https://tools.ietf.org/html/rfc8555>ACME</a> and <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a>.
It <strong>does not</strong> equip or manage DNS records for cluster assets like <code>Services</code> or <code>Ingresses</code>. Thus, you can obtain a valid certificate but your service might still not be resolvable or reachable due to missing DNS configuration. Please consult <a href=https://github.com/gardener/gardener-extension-shoot-dns-service/tree/master/docs/usage/dns_names.md>this page</a> if your services require managed DNS records.</p><h3 id=supported-domains>Supported Domains</h3><p>Certificates may be obtained for any subdomain of your shoot&rsquo;s domain (see <code>.spec.dns.domain</code> of your shoot resource) with the default <code>issuer</code>. For custom domains, please consult <a href=#Custom-Domains>custom domains</a>.</p><h3 id=character-restrictions>Character Restrictions</h3><p>Due to the ACME protocol specification, at least one domain of the domains you request a certificate for must not exceed a character limit of 64 (CN - Common Name).</p><p>For example, the following request is invalid:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Certificate</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cert-invalid</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>commonName</span><span class=p>:</span><span class=w> </span><span class=l>morethan64characters.ingress.shoot.project.default-domain.gardener.cloud</span><span class=w>
</span></code></pre></div><p>But it is valid to request a certificate for this domain if you have at least one domain which does not exceed the mentioned limit:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Certificate</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cert-example</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>commonName</span><span class=p>:</span><span class=w> </span><span class=l>short.ingress.shoot.project.default-domain.gardener.cloud</span><span class=w>
</span><span class=w>  </span><span class=nt>dnsNames</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=l>morethan64characters.ingress.shoot.project.default-domain.gardener.cloud</span><span class=w>
</span></code></pre></div><h2 id=certificate-resources>Certificate Resources</h2><p>Every X.509 certificate is represented by a Kubernetes custom resource <code>certificate.cert.gardener.cloud</code> in your cluster. A <code>Certificate</code> resource may be used to initiate a new certificate request as well as to manage its lifecycle. Gardener&rsquo;s certificate service regularly checks the expiration timestamp of Certificates, triggers a renewal process if necessary and replaces the existing X.509 certificate with a new one.</p><blockquote><p>Your application should be able to reload replaced certificates in a timely manner to avoid service disruptions.</p></blockquote><p>Certificates can either be requested by creating <code>Certificate</code> resources in the Kubernetes cluster or by configuring <code>Ingress</code> or <code>Service</code> (type <code>LoadBalancer</code>) resources. If the latter is used, a <code>Certificate</code> resource will automatically be created by Gardener&rsquo;s certificate service.</p><p>If you&rsquo;re interested in the current progress of your request, you&rsquo;re advised to consult the <code>Certificate</code>&rsquo;s <code>status</code> subresource. You&rsquo;ll also find error descriptions in the <code>status</code> in case the issuance failed.</p><p>Certificate status example:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Certificate</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>commonName</span><span class=p>:</span><span class=w> </span><span class=l>short.ingress.shoot.project.default-domain.gardener.cloud</span><span class=w>
</span><span class=w>  </span><span class=nt>expirationDate</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2020-02-27T15:39:10Z&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>issuerRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>shoot--foo--bar</span><span class=w>
</span><span class=w>  </span><span class=nt>lastPendingTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2019-11-29T16:38:40Z&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>observedGeneration</span><span class=p>:</span><span class=w> </span><span class=m>11</span><span class=w>
</span><span class=w>  </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>Ready</span><span class=w>
</span></code></pre></div><h2 id=custom-domains>Custom Domains</h2><p>If you want to request certificates for domains other then any subdomain of <code>shoot.spec.dns.domain</code>, the following configuration is required:</p><h3 id=dns-provider>DNS provider</h3><p>In order to issue certificates for a custom domain you need to specify a DNS provider which is permitted to create DNS records for subdomains of your requested domain in the certificate. For example, if you request a certificate for <code>host.example.com</code> your DNS provider must be capable of managing subdomains of <code>host.example.com</code>.</p><p>DNS providers are normally specified in the shoot manifest.</p><p>If the <code>DNSProvider</code> replication feature is enabled, an provider can alternatively defined in
the shoot cluster.</p><h4 id=provider-in-the-shoot-manifest>Provider in the shoot manifest</h4><p>Example for a provider in the shoot manifest:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>providers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws-route53</span><span class=w> </span><span class=c># consult the DNS provisioning controllers group (dnscontrollers) in https://github.com/gardener/external-dns-management#using-the-dns-controller-manager for possible values</span><span class=w>
</span><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>provider-example-com</span><span class=w> </span><span class=c># contains credentials for service account, see any 20-secret-&lt;provider&gt;-credentials.yaml in https://github.com/gardener/external-dns-management/tree/master/examples</span><span class=w>
</span></code></pre></div><p>The secret referenced by <code>secretName</code> can also be conveniently created via the Gardener dashboard.</p><h4 id=provider-resouce-in-the-shoot-cluster>Provider resouce in the shoot cluster</h4><p><em>Prerequiste</em>: The <code>DNSProvider</code> replication feature has to be enabled.
It is either enabled globally in the <code>ControllerDeployment</code> or in the shoot manifest
with:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-dns-service</span><span class=w>
</span><span class=w>      </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>service.dns.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>        </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DNSConfig</span><span class=w>
</span><span class=w>        </span><span class=nt>dnsProviderReplication</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>Example for specifying a <code>DNSProvider</code> resource and its <code>Secret</code> in any namespace of the shoot cluster:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>dns.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DNSProvider</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/class</span><span class=p>:</span><span class=w> </span><span class=l>garden  </span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-own-domain</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>my-namespace</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws-route53</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-own-domain-credentials</span><span class=w>
</span><span class=w>  </span><span class=nt>domains</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>include</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>my.own.domain.com</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-own-domain-credentials</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>my-namespace</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># replace &#39;...&#39; with values encoded as base64</span><span class=w>
</span><span class=w>  </span><span class=nt>AWS_ACCESS_KEY_ID</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>AWS_SECRET_ACCESS_KEY</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span></code></pre></div><h3 id=issuer>Issuer</h3><p>Another prerequisite to request certificates for custom domains is a dedicated issuer.</p><p>The custom issuers are specified normally in the shoot manifest.</p><p>If the <code>shootIssuers</code> feature is enabled, it can alternatively be defined in the shoot cluster.</p><h4 id=issuer-in-the-shoot-manifest>Issuer in the shoot manifest</h4><p>Example for an issuer in the shoot manifest:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-cert-service</span><span class=w>
</span><span class=w>    </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>service.cert.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CertConfig</span><span class=w>
</span><span class=w>      </span><span class=nt>issuers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>email</span><span class=p>:</span><span class=w> </span><span class=l>your-email@example.com</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>custom-issuer</span><span class=w> </span><span class=c># issuer name must be specified in every custom issuer request, must not be &#34;garden&#34;</span><span class=w>
</span><span class=w>          </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span><span class=w>
</span><span class=w>          </span><span class=nt>privateKeySecretName</span><span class=p>:</span><span class=w> </span><span class=l>my-privatekey</span><span class=w> </span><span class=c># referenced resource, the private key must be stored in the secret at `data.privateKey`</span><span class=w>
</span><span class=w>      </span><span class=c>#shootIssuers:</span><span class=w>
</span><span class=w>      </span><span class=c>#  enabled: true # if true, allows to specify issuers in the shoot cluster</span><span class=w>
</span><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-privatekey</span><span class=w>
</span><span class=w>    </span><span class=nt>resourceRef</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>custom-issuer-privatekey</span><span class=w> </span><span class=c># name of secret in Gardener project</span><span class=w>
</span></code></pre></div><h4 id=heading></h4><p><em>Prerequiste</em>: The <code>shootIssuers</code> feature has to be enabled.
It is either enabled globally in the <code>ControllerDeployment</code> or in the shoot manifest
with:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-cert-service</span><span class=w>
</span><span class=w>    </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>service.cert.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CertConfig</span><span class=w>
</span><span class=w>      </span><span class=nt>shootIssuers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=c># if true, allows to specify issuers in the shoot cluster</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>Example for specifying an <code>Issuer</code> resource and its <code>Secret</code> directly in any
namespace of the shoot cluster:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Issuer</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-own-issuer</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>my-namespace</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>acme</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>domains</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>include</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>my.own.domain.com</span><span class=w>
</span><span class=w>    </span><span class=nt>email</span><span class=p>:</span><span class=w> </span><span class=l>some.user@my.own.domain.com</span><span class=w>
</span><span class=w>    </span><span class=nt>privateKeySecretRef</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-own-issuer-secret</span><span class=w>
</span><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>my-namespace</span><span class=w>
</span><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://acme-v02.api.letsencrypt.org/directory</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-own-issuer-secret</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>my-namespace</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>privateKey</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w> </span><span class=c># replace &#39;...&#39; with valus encoded as base64</span><span class=w>
</span></code></pre></div><h2 id=examples>Examples</h2><h3 id=request-a-certificate-via-certificate>Request a certificate via Certificate</h3><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Certificate</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cert-example</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>commonName</span><span class=p>:</span><span class=w> </span><span class=l>short.ingress.shoot.project.default-domain.gardener.cloud</span><span class=w>
</span><span class=w>  </span><span class=nt>dnsNames</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=l>morethan64characters.ingress.shoot.project.default-domain.gardener.cloud</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cert-example</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=c># issuerRef:</span><span class=w>
</span><span class=w></span><span class=c>#   name: custom-issuer</span><span class=w>
</span></code></pre></div><table><thead><tr><th style=text-align:left>Path</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>spec.commonName</code> (required)</td><td style=text-align:left>Specifies for which domain the certificate request will be created. This entry must comply with the <a href=#Character-Restrictions>64 character</a> limit.</td></tr><tr><td style=text-align:left><code>spec.dnsName</code></td><td style=text-align:left>Additional domains the certificate should be valid for. Entries in this list can be longer than 64 characters.</td></tr><tr><td style=text-align:left><code>spec.secretRef</code></td><td style=text-align:left>Specifies the secret which contains the certificate/key pair. If the secret is not available yet, it&rsquo;ll be created automatically as soon as the X.509 certificate has been issued.</td></tr><tr><td style=text-align:left><code>spec.issuerRef</code></td><td style=text-align:left>Specifies the issuer you want to use. Only necessary if you request certificates for <a href=#Custom-Domains>custom domains</a>.</td></tr></tbody></table><h3 id=request-a-wildcard-certificate-via-certificate>Request a wildcard certificate via Certificate</h3><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cert.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Certificate</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cert-wildcard</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>commonName</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;*.ingress.shoot.project.default-domain.gardener.cloud&#39;</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cert-wildcard</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=c># issuerRef:</span><span class=w>
</span><span class=w></span><span class=c>#   name: custom-issuer</span><span class=w>
</span></code></pre></div><table><thead><tr><th style=text-align:left>Path</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>spec.commonName</code> (required)</td><td style=text-align:left>Specifies for which domain the certificate request will be created. This entry must comply with the <a href=#Character-Restrictions>64 character</a> limit.</td></tr><tr><td style=text-align:left><code>spec.secretRef</code></td><td style=text-align:left>Specifies the secret which contains the certificate/key pair. If the secret is not available yet, it&rsquo;ll be created automatically as soon as the X.509 certificate has been issued.</td></tr><tr><td style=text-align:left><code>spec.issuerRef</code></td><td style=text-align:left>Specifies the issuer you want to use. Only necessary if you request certificates for <a href=#Custom-Domains>custom domains</a>.</td></tr></tbody></table><h3 id=request-a-certificate-via-ingress>Request a certificate via Ingress</h3><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>vuejs-ingress</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cert.gardener.cloud/purpose</span><span class=p>:</span><span class=w> </span><span class=l>managed</span><span class=w>
</span><span class=w>  </span><span class=c># cert.gardener.cloud/issuer: custom-issuer</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># Must not exceed 64 characters.</span><span class=w>
</span><span class=w>  </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>short.ingress.shoot.project.default-domain.gardener.cloud</span><span class=w>
</span><span class=w>    </span>- <span class=l>morethan64characters.ingress.shoot.project.default-domain.gardener.cloud</span><span class=w>
</span><span class=w>    </span><span class=c># Certificate and private key reside in this secret.</span><span class=w>
</span><span class=w>    </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>testsecret-tls</span><span class=w>
</span><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>morethan64characters.ingress.shoot.project.default-domain.gardener.cloud</span><span class=w>
</span><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>vuejs-svc</span><span class=w>
</span><span class=w>          </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></code></pre></div><table><thead><tr><th style=text-align:left>Path</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>metadata.annotations</code></td><td style=text-align:left>Annotations should have <code>cert.gardener.cloud/purpose: managed</code> to activate the certificate service on this resource. <code>cert.gardener.cloud/issuer: &lt;name></code> is optional and may be specified if the certificate is request for a <a href=#Custom-Domains>custom domains</a>.</td></tr><tr><td style=text-align:left><code>spec.tls[].hosts</code></td><td style=text-align:left>Specifies for which domains the certificate request will be created. The first entry is always taken to fill the <code>Common Name</code> field and must therefore comply with the <a href=#Character-Restrictions>64 character</a> limit.</td></tr><tr><td style=text-align:left><code>spec.tls[].secretName</code></td><td style=text-align:left>Specifies the secret which contains the certificate/key pair to be used by this Ingress. If the secret is not available yet, it&rsquo;ll be created automatically as soon as the certificate has been issued. Once configured, you&rsquo;re not advised to change the name while the Ingress is still managed by the certificate service.</td></tr></tbody></table><h3 id=request-a-wildcard-certificate-via-ingress>Request a wildcard certificate via Ingress</h3><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>vuejs-ingress</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cert.gardener.cloud/purpose</span><span class=p>:</span><span class=w> </span><span class=l>managed</span><span class=w>
</span><span class=w>  </span><span class=c># cert.gardener.cloud/issuer: custom-issuer</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># Must not exceed 64 characters.</span><span class=w>
</span><span class=w>  </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=s2>&#34;*.ingress.shoot.project.default-domain.gardener.cloud&#34;</span><span class=w>
</span><span class=w>    </span><span class=c># Certificate and private key reside in this secret.</span><span class=w>
</span><span class=w>    </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>testsecret-tls</span><span class=w>
</span><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>morethan64characters.ingress.shoot.project.default-domain.gardener.cloud</span><span class=w>
</span><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>vuejs-svc</span><span class=w>
</span><span class=w>          </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></code></pre></div><blockquote><p>Domains must not overlap when requesting a wildcard certificate. For example, requests for <code>*.example.com</code> must not contain <code>foo.example.com</code> at the same time.</p></blockquote><table><thead><tr><th style=text-align:left>Path</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>metadata.annotations</code></td><td style=text-align:left>Annotations should have <code>cert.gardener.cloud/purpose: managed</code> to activate the certificate service on this resource. <code>cert.gardener.cloud/issuer: &lt;name></code> is optional and may be specified if the certificate is request for a <a href=#Custom-Domains>custom domains</a>.</td></tr><tr><td style=text-align:left><code>spec.tls[].hosts</code></td><td style=text-align:left>Specifies for which domains the certificate request will be created. The first entry is always taken to fill the <code>Common Name</code> field and must therefore comply with the <a href=#Character-Restrictions>64 character</a> limit.</td></tr><tr><td style=text-align:left><code>spec.tls[].secretName</code></td><td style=text-align:left>Specifies the secret which contains the certificate/key pair to be used by this Ingress. If the secret is not available yet, it&rsquo;ll be created automatically as soon as the certificate has been issued. Once configured, you&rsquo;re not advised to change the name while the Ingress is still managed by the certificate service.</td></tr></tbody></table><h3 id=request-a-certificate-via-service>Request a certificate via Service</h3><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cert.gardener.cloud/secretname</span><span class=p>:</span><span class=w> </span><span class=l>test-service-secret</span><span class=w>
</span><span class=w>  </span><span class=c># cert.gardener.cloud/issuer: custom-issuer</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/dnsnames</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;service.shoot.project.default-domain.gardener.cloud, morethan64characters.svc.shoot.project.default-domain.gardener.cloud&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/ttl</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;600&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-service</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></code></pre></div><table><thead><tr><th style=text-align:left>Path</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>metadata.annotations[cert.gardener.cloud/secretname]</code></td><td style=text-align:left>Specifies the secret which contains the certificate/key pair. If the secret is not available yet, it&rsquo;ll be created automatically as soon as the certificate has been issued.</td></tr><tr><td style=text-align:left><code>metadata.annotations[cert.gardener.cloud/issuer]</code></td><td style=text-align:left>Optional and may be specified if the certificate is request for a <a href=#Custom-Domains>custom domains</a>.</td></tr><tr><td style=text-align:left><code>metadata.annotations[dns.gardener.cloud/dnsnames]</code></td><td style=text-align:left>Specifies for which domains the certificate request will be created. The first entry is always taken to fill the <code>Common Name</code> field and must therefore comply with the <a href=#Character-Restrictions>64 character</a> limit.</td></tr></tbody></table><h3 id=request-a-wildcard-certificate-via-service>Request a wildcard certificate via Service</h3><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cert.gardener.cloud/secretname</span><span class=p>:</span><span class=w> </span><span class=l>test-service-secret</span><span class=w>
</span><span class=w>  </span><span class=c># cert.gardener.cloud/issuer: custom-issuer</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/dnsnames</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*.service.shoot.project.default-domain.gardener.cloud&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/ttl</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;600&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-service</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></code></pre></div><blockquote><p>Domains must not overlap when requesting a wildcard certificate. For example, requests for <code>*.example.com</code> must not contain <code>foo.example.com</code> at the same time.</p></blockquote><table><thead><tr><th style=text-align:left>Path</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>metadata.annotations[cert.gardener.cloud/secretname]</code></td><td style=text-align:left>Specifies the secret which contains the certificate/key pair. If the secret is not available yet, it&rsquo;ll be created automatically as soon as the certificate has been issued.</td></tr><tr><td style=text-align:left><code>metadata.annotations[cert.gardener.cloud/issuer]</code></td><td style=text-align:left>Optional and may be specified if the certificate is request for a <a href=#Custom-Domains>custom domains</a>.</td></tr><tr><td style=text-align:left><code>metadata.annotations[dns.gardener.cloud/dnsnames]</code></td><td style=text-align:left>Specifies for which domains the certificate request will be created. The first entry is always taken to fill the <code>Common Name</code> field and must therefore comply with the <a href=#Character-Restrictions>64 character</a> limit.</td></tr></tbody></table><h2 id=quotas>Quotas</h2><p>For security reasons there may be a default quota on the certificate requests per day set globally in the controller
registration of the shoot-cert-service.</p><p>The default quota only applies if there is no explicit quota defined for the issuer itself with the field
<code>requestsPerDayQuota</code>, e.g.:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-cert-service</span><span class=w>
</span><span class=w>    </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>service.cert.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CertConfig</span><span class=w>
</span><span class=w>      </span><span class=nt>issuers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>email</span><span class=p>:</span><span class=w> </span><span class=l>your-email@example.com</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>custom-issuer</span><span class=w> </span><span class=c># issuer name must be specified in every custom issuer request, must not be &#34;garden&#34;</span><span class=w>
</span><span class=w>          </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span><span class=w>
</span><span class=w>          </span><span class=nt>requestsPerDayQuota</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c59fbc42a6186b5b6f2f75de63a4efc7>2.3.11 - Shoot Cluster Maintenance</h1><div class=lead>Understanding and configuring Gardener&rsquo;s Day-2 operations for Shoot clusters.</div><h1 id=shoot-cluster-maintenance>Shoot Cluster Maintenance</h1><p>Day two operations for shoot clusters are related to:</p><ul><li>The Kubernetes version of the control plane and the worker nodes</li><li>the operating system version of the worker nodes</li></ul><div class="alert alert-info" role=alert>When referring to an update of the "operating system version" in this document, the update of the machine image of the shoot cluster's worker nodes is meant. For example, Amazon Machine Images (AMI) for AWS.</div><p>The following table summarizes what options Gardener offers to maintain these versions:</p><table><thead><tr><th style=text-align:left></th><th style=text-align:left>Auto-Update</th><th style=text-align:left>Forceful Updates</th><th style=text-align:left>Manual updates</th></tr></thead><tbody><tr><td style=text-align:left>Kubernetes version</td><td style=text-align:left>Patches only</td><td style=text-align:left>Patches and consecutive minor updates only</td><td style=text-align:left>yes</td></tr><tr><td style=text-align:left>Operating system version</td><td style=text-align:left>yes</td><td style=text-align:left>yes</td><td style=text-align:left>yes</td></tr></tbody></table><h2 id=allowed-target-versions-in-the-cloudprofile>Allowed Target Versions in the <code>CloudProfile</code></h2><p>Administrators maintain the allowed target versions that you can update to in the <code>CloudProfile</code> for each IaaS-Provider. Users with access to a Gardener project can check supported target versions with:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl get cloudprofile [IAAS-SPECIFIC-PROFILE] -o yaml
</code></pre></div><table><thead><tr><th style=text-align:left>Path</th><th style=text-align:left>Description</th><th style=text-align:left>More information</th></tr></thead><tbody><tr><td style=text-align:left><code>spec.kubernetes.versions</code></td><td style=text-align:left>The supported Kubernetes version <code>major.minor.patch</code>.</td><td style=text-align:left><a href=https://github.com/kubernetes/community/blob/master/contributors/design-proposals/release/versioning.md#patch-releases>Patch releases</a></td></tr><tr><td style=text-align:left><code>spec.machineImages</code></td><td style=text-align:left>The supported operating system versions for worker nodes.</td><td></td></tr></tbody></table><p>Both the Kubernetes version, and the operating system version follow semantic versioning that allows Gardener to handle updates automatically.</p><p>More information: <a href=http://semver.org/>Semantic Versioning</a>.</p><h3 id=impact-of-version-classifications-on-updates>Impact of Version Classifications on Updates</h3><p>Gardener allows to classify versions in the <code>CloudProfile</code> as <code>preview</code>, <code>supported</code>, <code>deprecated</code>, or <code>expired</code>. During maintenance operations, <code>preview</code> versions are excluded from updates, because they’re often recently released versions that haven’t yet undergone thorough testing and may contain bugs or security issues.</p><p>More information: <a href=https://github.com/gardener/gardener/blob/master/docs/usage/shoot_versions.md#version-classifications>Version Classifications</a>.</p><h2 id=let-gardener-manage-your-updates>Let Gardener manage your updates</h2><h3 id=the-maintenance-window>The Maintenance Window</h3><p>Gardener can manage updates for you automatically. It offers users to specify a <em>maintenance window</em> during which updates are scheduled:</p><ul><li>The time interval of the maintenance window can’t be less than 30 minutes or more than 6 hours.</li><li>If there’s no maintenance window specified during the creation of a shoot cluster, Gardener chooses a maintenance window randomly to spread the load.</li></ul><p>You can either specify the maintenance window in the shoot cluster specification (<code>.spec.maintenance.timeWindow</code>) or the start time of the maintenance window using the Gardener dashboard (<strong>CLUSTERS</strong> > <strong>[YOUR-CLUSTER]</strong> > <strong>OVERVIEW</strong> > <strong>Lifecycle</strong> > <strong>Maintenance</strong>).</p><h3 id=auto-update-and-forceful-updates>Auto-Update and Forceful Updates</h3><p>To trigger updates during the maintenance window automatically, Gardener offers the following methods:</p><ul><li><p><em>Auto-update</em>:<br>Gardener starts an update during the next maintenance window whenever there’s a version available in the <code>CloudProfile</code> that is higher than the one of your shoot cluster specification, and that isn’t classified as <code>preview</code> version. For Kubernetes versions, auto-update only updates to higher patch levels.</p><p>You can either activate auto-update on the Gardener dashboard (<strong>CLUSTERS</strong> > <strong>[YOUR-CLUSTER]</strong> > <strong>OVERVIEW</strong> > <strong>Lifecycle</strong> > <strong>Maintenance</strong>) or in the shoot cluster specification:</p><ul><li><code>.spec.maintenance.autoUpdate.kubernetesVersion: true</code></li><li><code>.spec.maintenance.autoUpdate.machineImageVersion: true</code></li></ul></li><li><p><em>Forceful updates</em>:<br>In the maintenance window, Gardener compares the current version given in the shoot cluster specification with the version list in the <code>CloudProfile</code>. If the version has an expiration date and if the date is before the start of the maintenance window, Gardener starts an update to the highest version available in the <code>CloudProfile</code> that isn’t classified as <code>preview</code> version. The highest version in <code>CloudProfile</code> can’t have an expiration date. For Kubernetes versions, Gardener only updates to higher patch levels or consecutive minor versions.</p></li></ul><p>If you don’t want to wait for the next maintenance window, you can annotate the shoot cluster specification with <code>shoot.gardener.cloud/operation: maintain</code>. Gardener then checks immediately if there’s an auto-update or a forceful update needed.</p><div class="alert alert-info" role=alert>Forceful version updates are even executed if the auto-update for the Kubernetes version, or the auto-update for the machine image version is deactivated (set to `false`).</div><p>With expiration dates, administrators can give shoot cluster owners more time for testing before the actual version update happens, which allows smoother transitions to new versions.</p><h3 id=kubernetes-update-paths>Kubernetes Update Paths</h3><p>The bigger the delta of the Kubernetes source version and the Kubernetes target version, the better it must be planned and executed by operators. Gardener only provides automatic support for updates that can be applied safely to the cluster workload:</p><table><thead><tr><th style=text-align:left>Update Type</th><th style=text-align:left>Example</th><th style=text-align:left>Update method</th></tr></thead><tbody><tr><td style=text-align:left>Patches</td><td style=text-align:left><code>1.10.12</code> to <code>1.10.13</code></td><td style=text-align:left>auto-update or Forceful update</td></tr><tr><td style=text-align:left>Update to consecutive minor version</td><td style=text-align:left><code>1.10.12</code> to <code>1.11.10</code></td><td style=text-align:left>Forceful update</td></tr><tr><td style=text-align:left>Other</td><td style=text-align:left><code>1.10.12</code> to <code>1.12.0</code></td><td style=text-align:left>manual update</td></tr></tbody></table><p>Gardener doesn’t support automatic updates of nonconsecutive minor versions, because Kubernetes doesn’t guarantee updateability in this case. However, multiple minor version updates are possible if not only the minor source version is expired, but also the minor target version is expired. Gardener then updates the Kubernetes version first to the expired target version, and waits for the next maintenance window to update this version to the next minor target version.</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>Warning</h4>The administrator who maintains the `CloudProfile` has to ensure that the list of Kubernetes versions consists of consecutive minor versions, for example, from `1.10.x` to `1.11.y`. If the minor version increases in bigger steps, for example, from `1.10.x` to `1.12.y`, shoot cluster updates fail during the maintenance window.</div><h2 id=manual-updates>Manual Updates</h2><p>To update the Kubernetes version or the node operating system manually, change the <code>.spec.kubernetes.version</code> field or the <code>.spec.provider.workers.machine.image.version</code> field correspondingly.</p><p>Manual updates are required if you would like to do a minor update of the Kubernetes version. Gardener doesn’t do such updates automatically as they can have breaking changes that could impact the cluster workload.</p><p>Manual updates are either executed immediately (default) or can be confined to the maintenance time window.<br>Choosing the latter option, causes changes to the cluster (for example, node pool rolling-updates) and the subsequent reconciliation, to only predictably happen during a defined time window (available since <a href=https://github.com/gardener/gardener/releases/tag/v1.4.0>Gardener version 1.4</a>).</p><p>More information: <a href=https://github.com/gardener/gardener/blob/master/docs/usage/shoot_maintenance.md#confine-specification-changesupdates-roll-out>Confine Specification Changes/Update Roll Out</a>.</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>Warning</h4>Before applying such update on minor or major releases, operators should check for all the breaking changes introduced in the target Kubernetes release changelog.</div><h2 id=examples>Examples</h2><p>In the examples for the <code>CloudProfile</code> and the shoot cluster specification, only the fields relevant for the example are shown.</p><h3 id=auto-update-of-kubernetes-version>Auto-Update of Kubernetes Version</h3><p>Let&rsquo;s assume Kubernetes version <code>1.10.5</code> and <code>1.11.0</code> were added in the following <code>CloudProfile</code>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>kubernetes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>versions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.11.0</span><span class=w>
</span><span class=w>    </span>- <span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.10.5</span><span class=w>
</span><span class=w>    </span>- <span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.10.0</span><span class=w>
</span></code></pre></div><p>Before this change, the shoot cluster specification looked like this:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>kubernetes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.10.0</span><span class=w>
</span><span class=w>  </span><span class=nt>maintenance</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>timeWindow</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>begin</span><span class=p>:</span><span class=w> </span><span class=m>220000+0000</span><span class=w>
</span><span class=w>      </span><span class=nt>end</span><span class=p>:</span><span class=w> </span><span class=m>230000+0000</span><span class=w>
</span><span class=w>    </span><span class=nt>autoUpdate</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>kubernetesVersion</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></code></pre></div><p>As a consequence, the shoot cluster is updated to Kubernetes version <code>1.10.5</code> between 22:00-23:00 UTC. Your shoot cluster isn&rsquo;t updated automatically to <code>1.11.0</code> even though it&rsquo;s the highest Kubernetes version in the <code>CloudProfile</code>, because Gardener does only do automatic updates of the Kubernetes patch level.</p><h3 id=forceful-update-due-to-expired-kubernetes-version>Forceful Update Due to Expired Kubernetes Version</h3><p>Let&rsquo;s assume the following <code>CloudProfile</code>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>kubernetes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>versions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.12.8</span><span class=w>
</span><span class=w>    </span>- <span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.11.10</span><span class=w>
</span><span class=w>    </span>- <span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.10.13</span><span class=w>
</span><span class=w>    </span>- <span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.10.12</span><span class=w>
</span><span class=w>      </span><span class=nt>expirationDate</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2019-04-13T08:00:00Z&#34;</span><span class=w>
</span></code></pre></div><p>Let&rsquo;s assume the shoot cluster has the following specification:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>kubernetes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.10.12</span><span class=w>
</span><span class=w>  </span><span class=nt>maintenance</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>timeWindow</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>begin</span><span class=p>:</span><span class=w> </span><span class=m>220000+0100</span><span class=w>
</span><span class=w>      </span><span class=nt>end</span><span class=p>:</span><span class=w> </span><span class=m>230000+0100</span><span class=w>
</span><span class=w>    </span><span class=nt>autoUpdate</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>kubernetesVersion</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></code></pre></div><p>The shoot cluster specification refers a Kubernetes version that has an <code>expirationDate</code>. In the maintenance window on <code>2019-04-12</code>, the Kubernetes version stays the same as it’s still not expired. But in the maintenance window on <code>2019-04-14</code> the Kubernetes version of the shoot cluster is updated to <code>1.10.13</code> (independently of the value of <code>.spec.maintenance.autoUpdate.kubernetesVersion</code>).</p><h3 id=forceful-update-to-new-minor-kubernetes-version>Forceful Update to New Minor Kubernetes Version</h3><p>Let&rsquo;s assume the following <code>CloudProfile</code>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>kubernetes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>versions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.12.8</span><span class=w>
</span><span class=w>    </span>- <span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.11.10</span><span class=w>
</span><span class=w>    </span>- <span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.11.09</span><span class=w>
</span><span class=w>    </span>- <span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.10.12</span><span class=w>
</span><span class=w>      </span><span class=nt>expirationDate</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2019-04-13T08:00:00Z&#34;</span><span class=w>
</span></code></pre></div><p>Let&rsquo;s assume the shoot cluster has the following specification:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>kubernetes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.10.12</span><span class=w>
</span><span class=w>  </span><span class=nt>maintenance</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>timeWindow</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>begin</span><span class=p>:</span><span class=w> </span><span class=m>220000+0100</span><span class=w>
</span><span class=w>      </span><span class=nt>end</span><span class=p>:</span><span class=w> </span><span class=m>230000+0100</span><span class=w>
</span><span class=w>    </span><span class=nt>autoUpdate</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>kubernetesVersion</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></code></pre></div><p>The shoot cluster specification refers a Kubernetes version that has an <code>expirationDate</code>. In the maintenance window on <code>2019-04-14</code>, the Kubernetes version of the shoot cluster is updated to <code>1.11.10</code>, which is the highest patch version of minor target version <code>1.11</code> that follows source version <code>1.10</code>.</p><h3 id=automatic-update-from-expired-machine-image-version>Automatic Update from Expired Machine Image Version</h3><p>Let&rsquo;s assume the following <code>CloudProfile</code>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>machineImages</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coreos</span><span class=w>
</span><span class=w>    </span><span class=nt>versions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>2191.5.0</span><span class=w>
</span><span class=w>    </span>- <span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>2191.4.1</span><span class=w>
</span><span class=w>    </span>- <span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>2135.6.0</span><span class=w>
</span><span class=w>      </span><span class=nt>expirationDate</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2019-04-13T08:00:00Z&#34;</span><span class=w>
</span></code></pre></div><p>Let&rsquo;s assume the shoot cluster has the following specification:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>provider</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws</span><span class=w>
</span><span class=w>    </span><span class=nt>workers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>name</span><span class=w>
</span><span class=w>      </span><span class=nt>maximum</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>minimum</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coreos</span><span class=w>
</span><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>2135.6.0</span><span class=w>
</span><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>m5.large</span><span class=w>
</span><span class=w>      </span><span class=nt>volume</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>gp2</span><span class=w>
</span><span class=w>        </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=l>20Gi</span><span class=w>
</span><span class=w>  </span><span class=nt>maintenance</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>timeWindow</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>begin</span><span class=p>:</span><span class=w> </span><span class=m>220000+0100</span><span class=w>
</span><span class=w>      </span><span class=nt>end</span><span class=p>:</span><span class=w> </span><span class=m>230000+0100</span><span class=w>
</span><span class=w>    </span><span class=nt>autoUpdate</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>machineImageVersion</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></code></pre></div><p>The shoot cluster specification refers a machine image version that has an <code>expirationDate</code>. In the maintenance window on <code>2019-04-12</code>, the machine image version stays the same as it’s still not expired. But in the maintenance window on <code>2019-04-14</code> the machine image version of the shoot cluster is updated to <code>2191.5.0</code> (independently of the value of <code>.spec.maintenance.autoUpdate.machineImageVersion</code>) as version <code>2135.6.0</code> is expired.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d33d61beb996b59f7a315dad30ff50b3>2.3.12 - Trigger Shoot operations</h1><h1 id=trigger-shoot-operations>Trigger shoot operations</h1><p>You can trigger a few explicit operations by annotating the <code>Shoot</code> with an operation annotation.
This might allow you to induct certain behavior without the need to change the <code>Shoot</code> specification.
Some of the operations can also not be caused by changing something in the shoot specification because they can&rsquo;t properly be reflected here.
Note, once the triggered operation is considered by the controllers, the annotation will be automatically removed and you have to add it each time you want to trigger the operation.</p><p>Please note: If <code>.spec.maintenance.confineSpecUpdateRollout=true</code> then the only way to trigger a shoot reconciliation is by setting the <code>reconcile</code> operation, see below.</p><h2 id=immediate-reconciliation>Immediate reconciliation</h2><p>Annotate the shoot with <code>gardener.cloud/operation=reconcile</code> to make the <code>gardenlet</code> start a reconciliation operation without changing the shoot spec and possibly without being in its maintenance time window:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl -n garden-&lt;project-name&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation<span class=o>=</span>reconcile
</code></pre></div><h2 id=immediate-maintenance>Immediate maintenance</h2><p>Annotate the shoot with <code>gardener.cloud/operation=maintain</code> to make the <code>gardener-controller-manager</code> start maintaining your shoot immediately (possibly without being in its maintenance time window).
If no reconciliation starts then nothing needed to be maintained:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl -n garden-&lt;project-name&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation<span class=o>=</span>maintain
</code></pre></div><h2 id=retry-failed-operation>Retry failed operation</h2><p>Annotate the shoot with <code>gardener.cloud/operation=retry</code> to make the <code>gardenlet</code> start a new reconciliation loop on a failed shoot.
Failed shoots are only reconciled again if a new Gardener version is deployed, the shoot specification is changed or this annotation is set</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl -n garden-&lt;project-name&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation<span class=o>=</span>retry
</code></pre></div><h2 id=rotate-kubeconfig-credentials>Rotate kubeconfig credentials</h2><p>Annotate the shoot with <code>gardener.cloud/operation=rotate-kubeconfig-credentials</code> to make the <code>gardenlet</code> exchange the credentials in your shoot cluster&rsquo;s kubeconfig.
This operation is now allowed for shoot clusters that are already in deletion.
Please note that only the token (and basic auth password, if enabled) are exchanged. The cluster CAs remain the same.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl -n garden-&lt;project-name&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation<span class=o>=</span>rotate-kubeconfig-credentials
</code></pre></div><h2 id=restart-systemd-services-on-particular-worker-nodes>Restart systemd services on particular worker nodes</h2><p>It is possible to make Gardener restart particular systemd services on your shoot worker nodes if needed.
The annotation is not set on the <code>Shoot</code> resource but directly on the <code>Node</code> object you want to target.
For example, the following will restart both the <code>kubelet</code> and the <code>docker</code> services:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl annotate node &lt;node-name&gt; worker.gardener.cloud/restart-systemd-services<span class=o>=</span>kubelet,docker
</code></pre></div><p>It may take up to a minute until the service is restarted.
The annotation will be removed from the <code>Node</code> object after all specified systemd services have been restarted.
It will also be removed even if the restart of one or more services failed.</p><blockquote><p>ℹ️ In the example mentioned above, you could additionally verify when/whether the kubelet restarted by using <code>kubectl describe node &lt;node-name></code> and looking for such a <code>Starting kubelet</code> event.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-87218383e3eaa4076a198b81967714ae>2.4 - Monitor and Troubleshoot</h1></div><div class=td-content><h1 id=pg-e97e6a2625fdc17259ec0a4ae54ea0db>2.4.1 - Get a Shell to a Gardener Shoot Worker Node</h1><div class=lead>Describes the methods for getting shell access to worker nodes.</div><h1 id=get-a-shell-to-a-kubernetes-node>Get a Shell to a Kubernetes Node</h1><p>To troubleshoot certain problems in a Kubernetes cluster, operators need access to the host of the Kubernetes node to troubleshoot
problems. This can be required if a node misbehaves or fails to join the cluster in the first place.</p><p>With access to the host, it is for instance possible to check the <code>kubelet</code> logs and interact with common tools such as <code>systemctl</code>and <code>journalctl</code>.</p><p>The first section of this guide explores options to get a shell to the node of a Gardener Kubernetes cluster.
The options described in the second section do not rely on Kubernetes capabilities to get shell access to a node and thus can also be used if an instance failed to join the cluster.</p><p>This guide only covers how to get access to the host, but does not cover troubleshooting methods.</p><ul><li><a href=#get-a-shell-to-a-kubernetes-node>Get a Shell to a Kubernetes Node</a></li><li><a href=#get-a-shell-to-an-operational-cluster-node>Get a Shell to an operational cluster node</a><ul><li><a href=#gardener-dashboard>Gardener Dashboard</a></li><li><a href=#gardenctl-shell>gardenctl shell</a></li><li><a href=#gardener-ops-toolbelt>Gardener Ops Toolbelt</a></li><li><a href=#custom-root-pod>Custom root pod</a></li></ul></li><li><a href=#ssh-access-to-a-node-that-failed-to-join-the-cluster>SSH access to a node that failed to join the cluster</a><ul><li><a href=#identifying-the-problematic-instance>Identifying the problematic instance</a></li><li><a href=#gardenctl-ssh>gardenctl ssh</a></li><li><a href=#ssh-with-manually-created-bastion-on-aws>SSH with manually created Bastion on AWS</a><ul><li><a href=#create-the-bastion-security-group>Create the Bastion Security Group</a></li><li><a href=#create-the-bastion-instance>Create the bastion instance</a></li></ul></li><li><a href=#connecting-to-the-target-instance>Connecting to the target instance</a></li><li><a href=#cleanup>Cleanup</a></li></ul></li></ul><h1 id=get-a-shell-to-an-operational-cluster-node>Get a Shell to an operational cluster node</h1><p>The following describes four different approaches to get a shell to an operational Shoot worker node.
As a prerequisite to troubleshooting a Kubernetes node, the node must have joined the cluster successfully and be able to run a pod.
All of the described approaches involve scheduling a pod with root permissions and mounting the root filesystem.</p><h2 id=gardener-dashboard>Gardener Dashboard</h2><p><strong>Prerequisite</strong>: the terminal feature is configured for the Gardener dashboard.</p><p>Navigate to the cluster overview page and find the <code>Terminal</code> in the <code>Access</code> tile.</p><img style=margin-left:0;width:80%;height:auto alt="Access Tile" src=/__resources/9fb6ca4ff9b7480f93debba833f48590_9d3149.png><br><p>Select the target Cluster (Garden, Seed / Control Plane, Shoot cluster) depending on the requirements and
access rights (only certain users have access to the Seed Control Plane).</p><p>To open the terminal configuration, click on the top right-hand corner of the screen.</p><img style=margin-left:0 alt="Terminal configuration" src=/__resources/db573582bfc544d294cbde8906a74e07_671e84.png><br><p>Set the Terminal Runtime to &ldquo;Privileged.
Also specify the target node from the drop-down menu.</p><img style=margin-left:0;width:50%;height:auto alt="Dashboard terminal pod configuration" src=/__resources/f7b10d48edf44c17ba838ff5c429e39d_595683.png><br><p>The dashboard then schedules a pod and opens a shell session to the node.</p><p>To get access to common binaries installed on the host, prefix the command with <code>chroot /hostroot</code>.
Note that the path depends on where the root path is mounted in the container.
In the default image used by the Dashboard, it is under <code>/hostroot</code>.</p><img style=margin-left:0 alt="Dashboard terminal pod configuration" src=/__resources/3da659e9cc4744a2ad3e1c6a50d39c04_1a182a.png><br><h2 id=gardenctl-shell>gardenctl shell</h2><p><strong>Prerequisite</strong>: <code>kubectl</code> and <a href=https://github.com/gardener/gardenctl>gardenctl are available and configured</a>.</p><p>First, target a Garden cluster containing all the Shoot definitions.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ gardenctl target garden &lt;target-garden&gt;
</code></pre></div><p>Target an available Shoot by name.
This sets up the context and configures the <code>kubeconfig</code> file of the Shoot cluster.
Subsequent commands will execute in this context.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ gardenctl target shoot &lt;target-shoot&gt;
</code></pre></div><p>Get the nodes of the Shoot cluster.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ gardenctl kubectl get nodes 
</code></pre></div><p>Pick a node name from the list above and get a root shell access to it.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ gardenctl shell &lt;target-node&gt;
</code></pre></div><h2 id=gardener-ops-toolbelt>Gardener Ops Toolbelt</h2><p><strong>Prerequisite</strong>: <code>kubectl</code> is available.</p><p>The <a href=https://github.com/gardener/ops-toolbelt>Gardener ops-toolbelt</a> can be used as a convenient way to deploy a root pod to a node.
The pod uses an image that is bundled with a bunch of useful <a href=https://github.com/gardener/ops-toolbelt/tree/master/dockerfile-configs>troubleshooting tools</a>.
This is also the same image that is used by default when using the Gardener Dashboard terminal feature as described in the <a href=#gardener-dashboard>previous section</a>.</p><p>The easiest way to use the <a href=https://github.com/gardener/ops-toolbelt>Gardener ops-toolbelt</a> is to execute
the <a href=https://github.com/gardener/ops-toolbelt/blob/master/hacks/ops-pod><code>ops-pod</code> script</a> in the <code>hacks</code> folder.
To get root shell access to a node, execute the aforementioned script by supplying the target node name as an argument:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ &lt;path-to-ops-toolbelt-repo&gt;/hacks/ops-pod &lt;target-node&gt;
</code></pre></div><h2 id=custom-root-pod>Custom root pod</h2><p>Alternatively, a pod can be <a href=https://kubernetes.io/docs/concepts/configuration/assign-pod-node/>assigned</a> to a target node and a shell can
be opened via <a href=https://kubernetes.io/docs/tasks/debug-application-cluster/get-shell-running-container/>standard Kubernetes means</a>.
To enable root access to the node, the pod specification requires proper <code>securityContext</code> and <code>volume</code> properties.</p><p>For instance you can use the following pod manifest, after changing <target-node-name>with the name of the node you want this pod attached to:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>privileged-pod</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>kubernetes.io/hostname</span><span class=p>:</span><span class=w> </span><span class=l>&lt;target-node-name&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span><span class=w>    </span><span class=nt>stdin</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>host-root-volume</span><span class=w>
</span><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/host</span><span class=w>
</span><span class=w>      </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>host-root-volume</span><span class=w>
</span><span class=w>    </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span><span class=w>  </span><span class=nt>hostNetwork</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>  </span><span class=nt>hostPID</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></code></pre></div><h1 id=ssh-access-to-a-node-that-failed-to-join-the-cluster>SSH access to a node that failed to join the cluster</h1><p>This section explores two options that can be used to get SSH access to a node that failed to join the cluster.
As it is not possible to schedule a pod on the node, the Kubernetes-based methods explored so far cannot be used in this scenario.</p><p>Additionally, Gardener typically provisions worker instances in a private subnet of the VPC, hence - there is no public IP address that could be used for direct SSH access.</p><p>For this scenario, cloud providers typically have extensive documentation (e.g <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstances.html>AWS</a> & <a href=https://cloud.google.com/compute/docs/instances/connecting-to-instance>GCP</a>
and in <a href=https://cloud.google.com/compute/docs/instances/connecting-advanced#vpn>some cases tooling support</a>).
However, these approaches are mostly cloud provider specific, require interaction via their CLI and API or sometimes
the installation of a <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-install-ssm-agent.html>cloud provider specific agent</a> one the node.</p><p>Alternatively, <code>gardenctl</code> can be used providing a cloud provider agnostic and out-of-the-box support to get ssh access to an instance in a private subnet.
Currently <code>gardenctl</code> supports AWS, GCP, Openstack, Azure and Alibaba Cloud.</p><h2 id=identifying-the-problematic-instance>Identifying the problematic instance</h2><p>First, the problematic instance has to be identified.
In Gardener, worker pools can be created in different cloud provider regions, zones and accounts.</p><p>The instance would typically show up as successfully started / running in the cloud provider dashboard or API and it is not immediately obvious which one has a problem.
Instead, we can use the Gardener API / CRDs to obtain the faulty instance identifier in a cloud-agnostic way.</p><p>Gardener uses the <a href=https://github.com/gardener/machine-controller-manager>Machine Controller Manager</a> to create the Shoot worker nodes.
For each worker node, the Machine Controller Manager creates a <code>Machine</code> CRD in the Shoot namespace in the respective <code>Seed</code> cluster.
Usually the problematic instance can be identified as the respective <code>Machine</code> CRD has status <code>pending</code>.</p><p>The instance / node name can be obtained from the <code>Machine</code> <code>.status</code> field:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl get machine &lt;machine-name&gt; -o json | jq -r .status.node
</code></pre></div><p>This is all the information needed to go ahead and use <code>gardenctl ssh</code> to get a shell to the node.
In addition, the used cloud provider, the specific identifier of the instance and the instance region can be identified from the <code>Machine</code> CRD.</p><p>Get the identifier of the instance via:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl get machine &lt;machine-name&gt; -o json | jq -r .spec.providerID // e.g aws:///eu-north-1/i-069733c435bdb4640
</code></pre></div><p>The identifier shows that the instance belongs to the cloud provider <code>aws</code> with the ec2 instance-id <code>i-069733c435bdb4640</code> in region <code>eu-north-1</code>.</p><p>To get more information about the instance, check out the <code>MachineClass</code> (e.g <code>AWSMachineClass</code>) that is associated with each <code>Machine</code> CRD in the <code>Shoot</code> namespace of the <code>Seed</code> cluster.
The <code>AWSMachineClass</code> contains the machine image (<a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html>ami</a>), machine-type, iam information, network-interfaces, subnets, security groups and attached volumes.</p><p>Of course, the information can also be used to get the instance with the cloud provider CLI / API.</p><h2 id=gardenctl-ssh>gardenctl ssh</h2><p>Using the node name of the problematic instance, we can use the <code>gardenctl ssh</code> command to get SSH access to the cloud provider
instance via an automatically set up <a href=https://en.wikipedia.org/wiki/Bastion_host>bastion host</a>.
<code>gardenctl</code> takes care of spinning up the <code>bastion</code> instance, setting up the SSH keys, ports and security groups and opens a root shell on the target instance.
After the SSH session has ended, <code>gardenctl</code> deletes the created cloud provider resources.</p><p>Use the following commands:</p><p>First, target a Garden cluster containing all the Shoot definitions.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ gardenctl target garden &lt;target-garden&gt;
</code></pre></div><p>Target an available Shoot by name.
This sets up the context, configures the <code>kubeconfig</code> file of the Shoot cluster and downloads the cloud provider credentials.
Subsequent commands will execute in this context.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ gardenctl target shoot &lt;target-shoot&gt;
</code></pre></div><p>This uses the cloud provider credentials to spin up the bastion and to open a shell on the target instance.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ gardenctl ssh &lt;target-node&gt;
</code></pre></div><h2 id=ssh-with-manually-created-bastion-on-aws>SSH with manually created Bastion on AWS</h2><p>In case you are not using <code>gardenctl</code> or want to control the bastion instance yourself, you can also manually set it up.
The steps described here are generally the same as <a href=https://github.com/gardener/gardenctl/blob/10a537942b94234914758c0f6d053dc1cf218ecd/pkg/cmd/ssh_aws.go#L53-L52>those used by <code>gardenctl</code> internally</a>.
Despite some cloud provider specifics they can be generalized to the following list:</p><ul><li>Open port 22 on the target instance.</li><li>Create an instance / VM in a public subnet (bastion instance needs to have public ip address).</li><li>Set-up security groups, roles and open port 22 for the bastion instance.</li></ul><p>The following diagram shows an overview how the SSH access to the target instance works:</p><img style=margin-left:0 alt="SSH Bastion diagram" src=/__resources/913441003e5641bc90249bdc07d55656_a35abd.png><br><p>This guide demonstrates the setup of a bastion on AWS.</p><p><strong>Prerequisites:</strong></p><ul><li>The <code>AWS CLI</code> is set up.</li><li>Obtain target instance-id (see <a href=#identifying-the-problematic-instance>here</a>).</li><li>Obtain the VPC ID the Shoot resources are created in. This can be found in the <code>Infrastructure</code> CRD in the <code>Shoot</code> namespace in the <code>Seed</code>.</li><li>Make sure that port 22 on the target instance is open (default for Gardener deployed instances).<ul><li>Extract security group via</li></ul><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ aws ec2 describe-instances --instance-ids &lt;instance-id&gt;
</code></pre></div><ul><li>Check for rule that allows inbound connections on port 22:</li></ul><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ aws ec2 describe-security-groups --group-ids=&lt;security-group-id&gt;
</code></pre></div><ul><li>If not available, create the rule with the following comamnd:</li></ul><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ aws ec2 authorize-security-group-ingress --group-id &lt;security-group-id&gt;  --protocol tcp --port 22 --cidr 0.0.0.0/0
</code></pre></div></li></ul><h3 id=create-the-bastion-security-group>Create the Bastion Security Group</h3><ul><li><p>The common name of the security group is <code>&lt;shoot-name>-bsg</code>. Create the security group:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ aws ec2 create-security-group --group-name &lt;bastion-security-group-name&gt;  --description ssh-access --vpc-id &lt;VPC-ID&gt;
</code></pre></div></li><li><p>Optionally, create identifying tags for the security group:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ aws ec2 create-tags --resources &lt;bastion-security-group-id&gt; --tags Key=component,Value=&lt;tag&gt;
</code></pre></div></li><li><p>Create permission in the bastion security group that allows ssh access on port 22.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ aws ec2 authorize-security-group-ingress --group-id &lt;bastion-security-group-id&gt;  --protocol tcp --port 22 --cidr 0.0.0.0/0
</code></pre></div></li><li><p>Create an IAM role for the bastion instance with the name <code>&lt;shoot-name>-bastions</code>:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ aws iam create-role --role-name &lt;shoot-name&gt;-bastions
</code></pre></div><p>The content should be:</p></li></ul><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
<span class=nt>&#34;Version&#34;</span><span class=p>:</span> <span class=s2>&#34;2012-10-17&#34;</span><span class=p>,</span>
<span class=nt>&#34;Statement&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
        <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
        <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=p>[</span>
            <span class=s2>&#34;ec2:DescribeRegions&#34;</span>
        <span class=p>],</span>
        <span class=nt>&#34;Resource&#34;</span><span class=p>:</span> <span class=p>[</span>
            <span class=s2>&#34;*&#34;</span>
        <span class=p>]</span>
    <span class=p>}</span>
<span class=p>]</span>
<span class=p>}</span>
</code></pre></div><ul><li><p>Create the instance profile with name <code>&lt;shoot-name>-bastions</code>:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ aws iam create-instance-profile --instance-profile-name &lt;name&gt;
</code></pre></div></li><li><p>Add the created role to the instance profile:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ aws iam add-role-to-instance-profile --instance-profile-name &lt;instance-profile-name&gt; --role-name &lt;role-name&gt;
</code></pre></div></li></ul><h3 id=create-the-bastion-instance>Create the bastion instance</h3><p>Next, in order to be able to <code>ssh</code> into the bastion instance, the instance has to be set up with a user with a public ssh key.
Create a user <code>gardener</code> that has the same Gardener-generated public ssh key as the target instance.</p><ul><li><p>First, we need to get the public part of the <code>Shoot</code> ssh-key.
The ssh-key is stored in a secret in the the project namespace in the Garden cluster.
The name is: <code>&lt;shoot-name>-ssh-publickey</code>.
Get the key via:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl get secret aws-gvisor.ssh-keypair -o json | jq -r .data.\&#34;id_rsa.pub\&#34;
</code></pre></div></li><li><p>A script handed over as <code>user-data</code> to the bastion <code>ec2</code> instance, can be used to create the <code>gardener</code> user and add the ssh-key.
For your convenience, you can use the following script to generate the <code>user-data</code>.</p></li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash -eu
</span><span class=cp></span>saveUserDataFile <span class=o>()</span> <span class=o>{</span>
  <span class=nv>ssh_key</span><span class=o>=</span><span class=nv>$1</span>

cat &gt; gardener-bastion-userdata.sh <span class=s>&lt;&lt;EOF
</span><span class=s>#!/bin/bash -eu
</span><span class=s>id gardener || useradd gardener -mU
</span><span class=s>mkdir -p /home/gardener/.ssh
</span><span class=s>echo &#34;$ssh_key&#34; &gt; /home/gardener/.ssh/authorized_keys
</span><span class=s>chown gardener:gardener /home/gardener/.ssh/authorized_keys
</span><span class=s>echo &#34;gardener ALL=(ALL) NOPASSWD:ALL&#34; &gt;/etc/sudoers.d/99-gardener-user
</span><span class=s>EOF</span>
<span class=o>}</span>


<span class=k>if</span> <span class=o>[</span> -p /dev/stdin <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
    <span class=nb>read</span> -r input
    cat <span class=p>|</span> saveUserDataFile <span class=s2>&#34;</span><span class=nv>$input</span><span class=s2>&#34;</span>
<span class=k>else</span>
    pbpaste <span class=p>|</span> saveUserDataFile <span class=s2>&#34;</span><span class=nv>$input</span><span class=s2>&#34;</span>
<span class=k>fi</span>
</code></pre></div><ul><li><p>Use the script by handing-over the public ssh-key of the <code>Shoot</code> cluster:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl get secret aws-gvisor.ssh-keypair -o json | jq -r .data.\&#34;id_rsa.pub\&#34; | ./generate-userdata.sh
</code></pre></div><p>This generates a file called <code>gardener-bastion-userdata.sh</code> in the same directory containing the <code>user-data</code>.</p></li><li><p>The following information is needed to create the bastion instance:</p><p><code>bastion-IAM-instance-profile-name</code></p><ul><li>Use the created instance profile with name <code>&lt;shoot-name>-bastions</code></li></ul><p><code>image-id</code></p><ul><li>Possible use the same image-id as for the target instance (or any other image). Has cloud provider specific format (AWS: <code>ami</code>).</li></ul><p><code>ssh-public-key-name</code></p><ul><li>This is the ssh key pair already created in the Shoot&rsquo;s cloud provider account by Gardener during the <code>Infrastructure</code> CRD reconciliation.</li><li>The name is usually: <code>&lt;shoot-name>-ssh-publickey</code></li></ul><p><code>subnet-id</code></p><ul><li>Choose a subnet that is attached to an <code>Internet Gateway</code> and <code>NAT Gateway</code> (bastion instance must have a public IP).</li><li>The Gardener created public subnet with the name <code>&lt;shoot-name>-public-utility-&lt;xy></code> can be used.
Please check the created subnets with the cloud provider.</li></ul><p><code>bastion-security-group-id</code></p><ul><li>Use the id of the created bastion security group.</li></ul><p><code>file-path-to-userdata</code></p><ul><li><p>Use the filepath to <code>user-data</code> file generated in the previous step.</p></li><li><p><code>bastion-instance-name</code></p><ul><li>Optional to tag the instance.</li><li>Usually <code>&lt;shoot-name>-bastions</code></li></ul></li></ul></li><li><p>Create the bastion instance via:</p></li></ul><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ ec2 run-instances --iam-instance-profile Name=&lt;bastion-IAM-instance-profile-name&gt; --image-id &lt;image-id&gt;  --count 1 --instance-type t3.nano --key-name &lt;ssh-public-key-name&gt;  --security-group-ids &lt;bastion-security-group-id&gt; --subnet-id &lt;subnet-id&gt; --associate-public-ip-address --user-data &lt;file-path-to-userdata&gt; --tag-specifications ResourceType=instance,Tags=[{Key=Name,Value=&lt;bastion-instance-name&gt;},{Key=component,Value=&lt;mytag&gt;}] ResourceType=volume,Tags=[{Key=component,Value=&lt;mytag&gt;}]&#34;
</code></pre></div><p>Capture the <code>instance-id</code> from the reponse and wait until the <code>ec2</code> instance is running and has a public ip address.</p><h2 id=connecting-to-the-target-instance>Connecting to the target instance</h2><p>Save the private key of the ssh-key-pair in a temporary local file for later use.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ umask 077

$ kubectl get secret &lt;shoot-name&gt;.ssh-keypair -o json | jq -r .data.\&#34;id_rsa\&#34; | base64 -d &gt; id_rsa.key
</code></pre></div><p>Use the private ssh key to ssh into the bastion instance.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ ssh -i &lt;path-to-private-key&gt; gardener@&lt;public-bastion-instance-ip&gt; 
</code></pre></div><p>If that works, connect from your local terminal to the target instance via the bastion.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ ssh  -i &lt;path-to-private-key&gt; -o ProxyCommand=&#34;ssh -W %h:%p -i &lt;private-key&gt; -o IdentitiesOnly=yes -o StrictHostKeyChecking=no gardener@&lt;public-ip-bastion&gt;&#34; gardener@&lt;private-ip-target-instance&gt; -o IdentitiesOnly=yes -o StrictHostKeyChecking=no
</code></pre></div><h2 id=cleanup>Cleanup</h2><p>Do not forget to cleanup the created resources. Otherwise Gardener will eventually fail to delete the Shoot.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9722c3efab308a9aee16ce3e552f405f>2.4.2 - How to debug a pod</h1><div class=lead>Your pod doesn&rsquo;t run as expected. Are there any log files? Where? How could I debug a pod?</div><h2 id=introduction>Introduction</h2><p>Kubernetes offers powerful options to get more details about startup or runtime failures of pods as e.g. described in
<a href=https://kubernetes.io/docs/tasks/debug-application-cluster/debug-application-introspection/>Application Introspection and Debugging</a>
or <a href=https://kubernetes.io/docs/tasks/debug-application-cluster/debug-pod-replication-controller/>Debug Pods and Replication Controllers</a>.</p><p>In order to identify pods with potential issus you could e.g. run <code>kubectl get pods --all-namespaces | grep -iv Running</code> to filter
out the pods which are not in the state <code>Running</code>. One of frequent error state is <code>CrashLoopBackOff</code>, which tells that
a pod crashes right after the start. Kubernetes then tries to restart the pod, but often the pod startup fails again.</p><p><strong>Here is a short list of possible reasons which might lead to a pod crash:</strong></p><ol><li>error during image pull caused by e.g. wrong/missing secrets or wrong/missing image</li><li>the app runs in an error state caused e.g. by missing environmental variables (ConfigMaps) or secrets</li><li>liveness probe failed</li><li>too high resource consumption (memory and/or CPU) or too strict quota settings</li><li>persistent volumes can&rsquo;t be created/mounted</li><li>the container image is not updated</li></ol><p>Basically, the commands <code>kubectl logs ...</code> and <code>kubectl describe ...</code> with additional parameters are used to get more
detailed information. By calling e.g. <code>kubectl logs --help</code> you get more detailed information about the command and its
parameters.</p><p>In the next sections you&rsquo;ll find some basic approaches to get some ideas what went wrong.</p><p>Remarks:</p><ul><li>Even if the pods seem to be running as the status <code>Running</code> indicates, a high counter of the <code>Restarts</code> shows potential problems</li><li>There is as well an <a href=https://kubernetes.io/docs/tutorials/kubernetes-basics/explore-intro/>interactive Tutorial Troubleshooting with Kubectl</a>
available which explains basic debugging activities</li><li>The examples below are deployed into the namespace <code>default</code>. In case you want to change it use the optional
parameter <code>--namespace &lt;your-namespace></code> to select the target namespace. They require Kubernetes release ≥ <em>1.8</em>.</li></ul><h2 id=prerequisites>Prerequisites</h2><p>Your deployment was successful (no logical/syntactical errors in the manifest files), but the pod(s) aren&rsquo;t running.</p><h2 id=error-caused-by-wrong-image-name>Error caused by wrong image name</h2><p>You run <code>kubectl describe pod &lt;your-pod> &lt;your-namespace></code> to get detailed information about the pod startup.</p><p>In the <code>Events</code> section, you get an error message like <code>Failed to pull image ...</code> and <code>Reason: Failed</code>. The pod is
in state <code>ImagePullBackOff</code>.</p><p>The example below is based on <a href=https://kubernetes.io/docs/tasks/debug-application-cluster/determine-reason-pod-failure/>demo in Kubernetes documentation</a>. In all examples the <code>default</code> namespace is used.</p><p>First, cleanup with</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl delete pod termination-demo
</code></pre></div><p>Next, create a resource based on the yaml content below</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod </span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo-container</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>debiann</span><span class=w>
</span><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;sleep 10 &amp;&amp; echo Sleep expired &gt; /dev/termination-log&#34;</span><span class=p>]</span><span class=w>
</span></code></pre></div><p><code>kubectl describe pod termination-demo</code> lists the following content in the <code>Event</code> section</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>Events:
  FirstSeen	LastSeen	Count	From							SubObjectPath					Type		Reason			Message
  ---------	--------	-----	----							-------------					--------	------			-------
  2m		2m		1	default-scheduler											Normal		Scheduled		Successfully assigned termination-demo to ip-10-250-17-112.eu-west-1.compute.internal
  2m		2m		1	kubelet, ip-10-250-17-112.eu-west-1.compute.internal							Normal		SuccessfulMountVolume	MountVolume.SetUp succeeded <span class=k>for</span> volume <span class=s2>&#34;default-token-sgccm&#34;</span> 
  2m		1m		4	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers<span class=o>{</span>termination-demo-container<span class=o>}</span>	Normal		Pulling			pulling image <span class=s2>&#34;debiann&#34;</span>
  2m		1m		4	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers<span class=o>{</span>termination-demo-container<span class=o>}</span>	Warning		Failed			Failed to pull image <span class=s2>&#34;debiann&#34;</span>: rpc error: <span class=nv>code</span> <span class=o>=</span> Unknown <span class=nv>desc</span> <span class=o>=</span> Error: image library/debiann:latest not found
  2m		54s		10	kubelet, ip-10-250-17-112.eu-west-1.compute.internal							Warning		FailedSync		Error syncing pod
  2m		54s		6	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers<span class=o>{</span>termination-demo-container<span class=o>}</span>	Normal		BackOff			Back-off pulling image <span class=s2>&#34;debiann&#34;</span>
</code></pre></div><p>The error message with <code>Reason: Failed</code> tells that there is an error during pulling the image. A closer look at the
image name indicates a misspelling.</p><h2 id=app-runs-in-an-error-state-caused-by-missing-configmaps-or-secrets>App runs in an error state caused by missing ConfigMaps or Secrets</h2><p>This example illustrates the behavior in case of the app expecting environment variables but the corresponding
Kubernetes artifacts are missing.</p><p>First, cleanup with</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=l>kubectl delete deployment termination-demo</span><span class=w>
</span><span class=w></span><span class=l>kubectl delete configmaps app-env</span><span class=w>
</span></code></pre></div><p>Next, deploy this manifest</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>     </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo-container</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>debian</span><span class=w>
</span><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;sed \&#34;s/foo/bar/\&#34; &lt; $MYFILE&#34;</span><span class=p>]</span><span class=w>
</span></code></pre></div><p>Now, the command <code>kubectl get pods</code> lists the pod <code>termination-demo-xxx</code> in the state <code>Error</code> or <code>CrashLoopBackOff</code>.
The command <code>kubectl describe pod termination-demo-xxx</code> tells that there is no error during startup but gives no clue
about what caused the crash.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>Events:
  FirstSeen	LastSeen	Count	From							SubObjectPath					Type		Reason		Message
  ---------	--------	-----	----							-------------					--------	------		-------
  19m		19m		1	default-scheduler											Normal		Scheduled	Successfully assigned termination-demo-5fb484867d-xz2x9 to ip-10-250-17-112.eu-west-1.compute.internal
  19m		19m		1	kubelet, ip-10-250-17-112.eu-west-1.compute.internal							Normal		SuccessfulMountVolume	MountVolume.SetUp succeeded <span class=k>for</span> volume <span class=s2>&#34;default-token-sgccm&#34;</span> 
  19m		19m		4	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers<span class=o>{</span>termination-demo-container<span class=o>}</span>	Normal		Pulling		pulling image <span class=s2>&#34;debian&#34;</span>
  19m		19m		4	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers<span class=o>{</span>termination-demo-container<span class=o>}</span>	Normal		Pulled		Successfully pulled image <span class=s2>&#34;debian&#34;</span>
  19m		19m		4	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers<span class=o>{</span>termination-demo-container<span class=o>}</span>	Normal		Created		Created container
  19m		19m		4	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers<span class=o>{</span>termination-demo-container<span class=o>}</span>	Normal		Started		Started container
  19m		14m		24	kubelet, ip-10-250-17-112.eu-west-1.compute.internal	spec.containers<span class=o>{</span>termination-demo-container<span class=o>}</span>	Warning		BackOff		Back-off restarting failed container
  19m		4m		69	kubelet, ip-10-250-17-112.eu-west-1.compute.internal							Warning		FailedSync	Error syncing pod
</code></pre></div><p>The command <code>kubectl get logs termination-demo-xxx</code> gives access to the output, the application writes on stderr and
stdout. In this case, you get an output like</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>/bin/sh: 1: cannot open : No such file
</code></pre></div><p>So you need to have a closer look at the application. In this case the environmental variable <code>MYFILE</code>is missing. To fix this
issue you could e.g. add a ConfigMap to your deployment as it is shown in the manifest listed below.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app-env</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>MYFILE</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/etc/profile&#34;</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>     </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo-container</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>debian</span><span class=w>
</span><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;sed \&#34;s/foo/bar/\&#34; &lt; $MYFILE&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>        </span><span class=nt>envFrom</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>configMapRef</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app-env </span><span class=w>
</span></code></pre></div><p>Note that once you fix the error and re-run the scenario, you might still see the pod in <code>CrashLoopBackOff</code> status.
It is because the container finishes the command <code>sed ...</code> and runs to completion. In order to keep the container in <code>Running</code> status,
a long running task is required, e.g.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app-env</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>MYFILE</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/etc/profile&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>SLEEP</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;5&#34;</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>     </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo-container</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>debian</span><span class=w>
</span><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>        </span><span class=c># args: [&#34;-c&#34;, &#34;sed \&#34;s/foo/bar/\&#34; &lt; $MYFILE&#34;]</span><span class=w>
</span><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;while true; do sleep $SLEEP; echo sleeping; done;&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>        </span><span class=nt>envFrom</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>configMapRef</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app-env</span><span class=w>
</span></code></pre></div><h2 id=too-high-resource-consumption-or-too-strict-quota-settings>Too high resource consumption or too strict quota settings</h2><p>You can optionally specify the amount of memory and/or CPU your container gets during runtime. In case these settings are missing,
the default requests settings are taken: CPU: 0m (in Milli CPU) and RAM: 0Gi which indicate no other limits than the
ones of the node(s) itself. Find more details in <a href=https://kubernetes.io/docs/tasks/administer-cluster/memory-default-namespace/>Configure Default Memory Requests and
Limits for a Namespace</a>,</p><p>In case your application needs more resources, Kubernetes distinguishes between <code>requests</code> and <code>limit</code> settings: <code>requests</code>
specify the guaranteed amount of resource, whereas <code>limit</code> tells Kubernetes the maximum amount of resource the container might
need. Mathematically both settings could be described by the relation <code>0 &lt;= requests &lt;= limit</code>. For both settings you need to
consider the total amount of resources the available nodes provide. For a detailed description of the concept see <a href=https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/resource-qos.md>Resource Quality of
Service in Kubernetes</a>.</p><p>Use <code>kubectl describe nodes</code> to get a first overview of the resource consumption of your cluster. Of special interest are the
figures indicating the amount of CPU and Memory Requests at the bottom of the output.</p><p>The next example demonstrates what happens in case the CPU request is too high in order to be managed by your cluster.</p><p>First, cleanup with</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=l>kubectl delete deployment termination-demo</span><span class=w>
</span><span class=w></span><span class=l>kubectl delete configmaps app-env</span><span class=w>
</span></code></pre></div><p>Next, adapt the <code>cpu</code> in the yaml below to be slightly higher than the remaining cpu resources in your cluster and deploy
this manifest. In this example <code>600m</code> (milli CPUs) are requested in a Kubernetes system with a single 2 Core worker
node which results in an error message.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>     </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>termination-demo-container</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>debian</span><span class=w>
</span><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;sleep 10 &amp;&amp; echo Sleep expired &gt; /dev/termination-log&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;600m&#34;</span><span class=w> 
</span></code></pre></div><p>The command <code>kubectl get pods</code> lists the pod <code>termination-demo-xxx</code> in the state <code>Pending</code>. More details on why this happens
could be found by using the command <code>kubectl describe pod termination-demo-xxx</code>:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl describe po termination-demo-fdb7bb7d9-mzvfw
Name:           termination-demo-fdb7bb7d9-mzvfw
Namespace:      default
...
Containers:
  termination-demo-container:
    Image:      debian
    Port:       &lt;none&gt;
    Host Port:  &lt;none&gt;
    Command:
      /bin/sh
    Args:
      -c
      sleep <span class=m>10</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span> Sleep expired &gt; /dev/termination-log
    Requests:
      cpu:        <span class=m>6</span>
    Environment:  &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-t549m <span class=o>(</span>ro<span class=o>)</span>
Conditions:
  Type           Status
  PodScheduled   False
Events:
  Type     Reason            Age               From               Message
  ----     ------            ----              ----               -------
  Warning  FailedScheduling  9s <span class=o>(</span>x7 over 40s<span class=o>)</span>  default-scheduler  0/2 nodes are available: <span class=m>2</span> Insufficient cpu.
</code></pre></div><p>More details in</p><ul><li><a href=https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/>Managing Compute Resources for Containters</a></li><li><a href=https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/resource-qos.md>Resource Quality of Service in Kubernetes</a></li></ul><p>Remark:</p><ul><li>This example works similarly when specifying a too high request for memory</li><li>In case you configured an autoscaler range when creating your Kubernetes cluster another worker node will be started automatically if you didn&rsquo;t reach the maximum number of worker nodes</li><li>If your app is running out of memory (the memory settings are too small), you typically find <code>OOMKilled</code> (Out Of Memory) message in the <code>Events</code> section fo the <code>kubectl describe pod ...</code> output</li></ul><h2 id=why-was-the-container-image-not-updated>Why was the container image not updated?</h2><p>You applied a fix in your app, created a new container image and pushed it into your container repository. After
redeploying your Kubernetes manifests you expected to get the updated app, but still the same bug is in the new
deployment present.</p><p>This behavior is related to how Kubernetes decides whether to pull a new docker image or to use the cached one.</p><p>In case you didn&rsquo;t change the image tag, the default image policy <em>IfNotPresent</em> tells Kubernetes to use the cached
image (see <a href=https://kubernetes.io/docs/concepts/containers/images/>Images</a>).</p><p>As a best practice you should not use the tag <code>latest</code> and change the image tag whenever you changed anything in your
image (see <a href=https://kubernetes.io/docs/concepts/configuration/overview/#container-images>Configuration Best Practices</a>).</p><p>Find more details in <a href=https://github.com/gardener/documentation/blob/master/website/documentation/guides/applications/imagePullPolicy>FAQ Container Image not updating</a></p><h2 id=links>Links</h2><ul><li><a href=https://kubernetes.io/docs/tasks/debug-application-cluster/debug-application-introspection/>Application Introspection and Debugging</a></li><li><a href=https://kubernetes.io/docs/tasks/debug-application-cluster/debug-pod-replication-controller/>Debug Pods and Replication Controllers</a></li><li><a href=https://kubernetes.io/docs/concepts/cluster-administration/logging/>Logging Architecture</a></li><li><a href=https://kubernetes.io/docs/tasks/administer-cluster/memory-default-namespace/>Configure Default Memory Requests and Limits for a Namespace</a></li><li><a href=https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/>Managing Compute Resources for Containters</a></li><li><a href=https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/resource-qos.md>Resource Quality of Service in Kubernetes</a></li><li><a href=https://kubernetes.io/docs/tutorials/kubernetes-basics/explore-intro/>Interactive Tutorial Troubleshooting with Kubectl</a></li><li><a href=https://kubernetes.io/docs/concepts/containers/images/>Images</a></li><li><a href=https://kubernetes.io/docs/concepts/configuration/overview/#container-images>Kubernetes Best Practises</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b5575668e5d9ec9a137723e26819e36b>2.4.3 - tail -f /var/log/my-application.log</h1><div class=lead>Aggregate log files from different pods</div><h2 id=problem>Problem</h2><p>One thing that always bothered me was that I couldn&rsquo;t get logs of several pods at once with <code>kubectl</code>. A simple
<code>tail -f &lt;path-to-logfile></code> isn&rsquo;t possible at all. Certainly you can use <code>kubectl logs -f &lt;pod-id></code>, but it doesn&rsquo;t
help if you want to monitor more than one pod at a time.</p><p>This is something you really need a lot, at least if you run several instances of a pod behind a <code>deployment</code>.
This is even more so if you don&rsquo;t have a Kibana setup or similar.</p><img src=/__resources/howto-kubetail_dd56d4.png width=100%><h2 id=solution>Solution</h2><p>Luckily, there are smart developers out there who always come up with solutions. The <strong>finding of the week</strong> is
a small bash script that allows you to aggregate log files of several pods at the same time in
a simple way. The script is called <code>kubetail</code> and is available at
<a href=https://github.com/johanhaleby/kubetail>GitHub</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-54886e62cc8767ab592a5259b6e86b39>2.5 - Applications</h1></div><div class=td-content><h1 id=pg-cdf7f44ffe002ba4c8c2fba6647dcc99>2.5.1 - Access a port of a pod locally</h1><h2 id=question>Question</h2><p>You deployed an application with a web UI or an internal endpoint in your Kubernetes (K8s) cluster. How can I access
this endpoint <strong>without an external load balancer</strong> (e.g. Ingress)?
This tutorial presents two options:</p><ul><li>Using Kubernetes port forward</li><li>Using Kubernetes apiserver proxy</li></ul><p>Please note that the options described here are mostly for quick testing or troubleshooting your application. For enabling access to your application for productive environment, please refer to <a href=/docs/guides/applications/service-access>Access my service</a></p><h2 id=solution-1-using-kubernetes-port-forward>Solution 1: Using Kubernetes port forward</h2><p>You could use the port forwarding functionality of <code>kubectl</code> to access the pods from your
local host <strong>without involving a service</strong>.</p><p>To access any pod follow these steps:</p><ul><li>Run <code>kubectl get pods</code></li><li>Note down the name of the pod in question as <code>&lt;your-pod-name></code></li><li>Run <code>kubectl port-forward &lt;your-pod-name> &lt;local-port>:&lt;your-app-port></code></li><li>Run a web browser or curl locally and enter the URL <code>http(s)://localhost:&lt;local-port></code></li></ul><p>In addition, <code>kubectl port-forward</code> allows to use a resource name. such as a deployment or service name, to select a matching pod to port forward.
Find more details in the <a href=https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/>Kubernetes documentation</a>.</p><p>The main drawback of this approach is that the pod&rsquo;s name will change as soon as it is restarted. Moreover, you need
to have a web browser on your client and you need to make sure that the local port is not already used by an
application running on your system. Finally, sometimes port forwarding is canceled due to non obvious reasons.
This leads to a kind of shaky approach. A more robust approach is to access the application using kube-proxy.</p><p><img src=/__resources/howto-port-forward_521e20.svg alt=port-forward></p><h2 id=solution-2-using-apiserver-proxy>Solution 2: Using apiserver proxy</h2><p>There are several different proxies used with Kubernetes, <a href=https://kubernetes.io/docs/concepts/cluster-administration/proxies/>the official documentation</a> provides a good overview.</p><p>In this tutorial we are using apiserver proxy to enable access to services running in Kubernetes without using an Ingress. <strong>Different from the first solution, a service is required for this solution</strong> .</p><p>Use the following URL to access a service via apiserver proxy. For details about apiserver proxy URLs read
<a href=https://kubernetes.io/docs/tasks/access-application-cluster/access-cluster/#discovering-builtin-services>Discovering builtin services</a></p><p><code>https://&lt;cluster-master>/api/v1/namespace/&lt;namespace>/services/&lt;service>:&lt;service-port>/proxy/&lt;service-endpoint></code></p><p><strong>Example:</strong></p><table><thead><tr><th>cluster-master</th><th style=text-align:center>namespace</th><th style=text-align:right>service</th><th style=text-align:right>service-port</th><th style=text-align:right>service-endpoint</th><th style=text-align:right>url to access service</th></tr></thead><tbody><tr><td>api.testclstr.cpet.k8s.sapcloud.io</td><td style=text-align:center>default</td><td style=text-align:right>nginx-svc</td><td style=text-align:right>80</td><td style=text-align:right>/</td><td style=text-align:right><code>http://api.testclstr.cpet.k8s.sapcloud.io/api/v1/namespaces/default/services/nginx-svc:80/proxy/</code></td></tr><tr><td>api.testclstr.cpet.k8s.sapcloud.io</td><td style=text-align:center>default</td><td style=text-align:right>docker-nodejs-svc</td><td style=text-align:right>4500</td><td style=text-align:right>/cpu?baseNumber=4</td><td style=text-align:right><code>https://api.testclstr.cpet.k8s.sapcloud.io/api/v1/namespaces/default/services/docker-nodejs-svc:4500/proxy/cpu?baseNumber=4</code></td></tr></tbody></table><p>There are applications, which do <strong>not</strong> yet support relative URLs like <a href=https://github.com/prometheus/prometheus/issues/1583>Prometheus</a> (as of end of November, 2017).
This typically leads to missing JavaScript objects when trying to open the URL in a browser. In this case use the
<code>port-forward</code> approach described above.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a7ec86eaf7d4bebd0f35775f37c982c6>2.5.2 - Access service from outside Kubernetes cluster</h1><div class=lead>Is there an ingress deployed and how is it configured</div><h2 id=tldr>TL;DR</h2><p>To expose your application / service for access from outside the cluster, following options exist:</p><ul><li>Kubernetes Service of type <code>LoadBalancer</code></li><li>Kubernetes Service of type &lsquo;NodePort&rsquo; + Ingress</li></ul><p>This tutorial discusses how to enable access to your application from outside the Kubernetes cluster (sometimes called
North-South traffic). For internal communication amongst pods and services (sometimes called East-West traffic) there
are many examples, <a href=https://cloudnativelabs.github.io/post/2017-04-18-kubernetes-networking/>here</a> is one brief example.</p><h2 id=service-types>Service Types</h2><p>A Service in Kubernetes is an abstraction defining a logical set of Pods and an access policy.<br>Services can be exposed in different ways by specifying a <strong>type</strong> in the service spec,
and different types determine accessibility from inside and outside of cluster.</p><ul><li>ClusterIP</li><li>NodePort</li><li>LoadBalancer</li></ul><p>Type <code>ExternalName</code> is a special case of service and not discussed here.</p><h3 id=type-clusterip>Type ClusterIP</h3><p>A service of type <code>ClusterIP</code> exposes a service on an internal IP in the cluster, which makes the service <strong>only reachable</strong>
from within the cluster. This is the default value if no type is specified.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-app</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-app</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.13.12</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-app</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-svc</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP </span><span class=w> </span><span class=c># use ClusterIP as type here</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-app</span><span class=w>
</span></code></pre></div><p>Execute following commands to create deployment and service</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl create -f &lt;Your yaml file name&gt;
</code></pre></div><p>Checking the service status</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl get svc nginx-svc
NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>   AGE
nginx-svc   ClusterIP   100.66.125.61   &lt;none&gt;        80/TCP    45m
</code></pre></div><p>As shown above, the service is assigned with a cluster ip address and port 80 as defined in configuration file.<br>You can test the service like this:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># list all existing pods in cluster</span>
$ kubectl get pods
NAME                                           READY     STATUS        RESTARTS   AGE
docker-nodejs-app-76b77494-vwv4d               1/1       Running       <span class=m>0</span>          11d
nginx-deployment-74d949bf69-nvdzs              1/1       Running       <span class=m>0</span>          1h
privileged-pod                                 1/1       Running       <span class=m>0</span>          11d

<span class=c1># test service from within the cluster on the same pod</span>
$ kubectl <span class=nb>exec</span> -it nginx-deployment-74d949bf69-nvdzs  curl 100.66.125.61:80
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span class=m>100</span>   <span class=m>612</span>  <span class=m>100</span>   <span class=m>612</span>    <span class=m>0</span>     <span class=m>0</span>  1006k      <span class=m>0</span> --:--:-- --:--:-- --:--:--  597k
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body <span class=o>{</span>
        width: 35em<span class=p>;</span>
        margin: <span class=m>0</span> auto<span class=p>;</span>
        font-family: Tahoma, Verdana, Arial, sans-serif<span class=p>;</span>
    <span class=o>}</span>
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;
...
</code></pre></div><blockquote><p><i class="fa fa-gittip" aria-hidden=true></i> Tip</p><ul><li>The service is also accessible from any other container (even from different pods) within the same cluster, e.g. <code>kubectl -it exec &lt;another POD_NAME> curl &lt;YourServiceClusterIP:YourPort></code>.
You need to make sure command <code>curl</code> is installed in the container.</li><li>You can also find out the dns name of the ClusterIP by command <code>kubectl exec -it &lt;POD_NAME> nslookup &lt;ClusterIP></code>,
replace the IP address with the resolved name in your test.
The resolved name typically looks like <code>nginx-svc.default.svc.cluster.local</code> where <code>nginx-svc</code> is the name of your
service defined in the configuration file.</li></ul></blockquote><h3 id=type-nodeport>Type NodePort</h3><p>Follow the previous example, just replace the type with <code>NodePort</code></p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>...</span><span class=w>
</span><span class=w> </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>   </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span><span class=w>   </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>     </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>A service of type <code>NodePort</code> is a ClusterIP service with an additional capability: it is reachable at the IP address
of the node as well as at the assigned cluster IP on the services network.
The way this is accomplished is pretty straightforward: when Kubernetes creates a NodePort service kube-proxy allocates
a port in the range 30000–32767 and opens this port on every node (thus the name “NodePort”).
Connections to this port are forwarded to the service’s cluster IP. If we create the service above and run
<code>kubectl get svc &lt;your-service></code>, we can see the NodePort that has been allocated for it.</p><p>Note that in the in following example, in addition to port 80, port <strong>32521</strong> has been opened as well on the node, in contrast to
the output of &ldquo;ClusterIP&rdquo; case where only port 80 is opened.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl get svc nginx-svc
NAME        TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>        AGE
nginx-svc   NodePort   100.70.105.182   &lt;none&gt;        80:32521/TCP   16m
</code></pre></div><p>Therefore you can access the service <em>from within the cluster</em> in two ways:</p><ul><li>Access via ClusterIP:port</li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1>#via ClusterIP</span>
kubectl <span class=nb>exec</span> -it nginx-deployment-74d949bf69-7n6bs curl 100.70.105.182:80

<span class=c1>#via internal name of ClusterIP</span>
kubectl <span class=nb>exec</span> -it nginx-deployment-74d949bf69-7n6bs curl nginx-svc.default.svc.cluster.local:80
</code></pre></div><ul><li>Access via NodeIP:NodePort</li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>
<span class=c1># First find out the Node IP address</span>
$ kubectl describe node
Name:               ip-10-250-20-203.eu-central-1.compute.internal
Roles:              node
Addresses:
  InternalIP:   10.250.20.203
  InternalDNS:  ip-10-250-20-203.eu-central-1.compute.internal
  Hostname:     ip-10-250-20-203.eu-central-1.compute.internal
...


<span class=c1>#via NodeIP:NodePort</span>
kubectl <span class=nb>exec</span> -it nginx-deployment-74d949bf69-7n6bs curl 10.250.20.203:32521

<span class=c1>#via internal name of NodeIP</span>
kubectl <span class=nb>exec</span> -it nginx-deployment-74d949bf69-7n6bs curl ip-10-250-20-203.eu-central-1.compute.internal:32521
</code></pre></div><h3 id=type-loadbalancer>Type LoadBalancer</h3><p>The <code>LoadBalancer</code> type is the simplest approach, which is created by specifying type as <code>LoadBalancer</code>.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-app</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-app</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.13.12</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-app</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-svc</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer </span><span class=w> </span><span class=c># use LoadBalancer as type here</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-app</span><span class=w>
</span></code></pre></div><p>Once the service is created, it has an external IP address as shown here:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl get services -l <span class=nv>app</span><span class=o>=</span>nginx-app -o wide
NAME        TYPE           CLUSTER-IP       EXTERNAL-IP                                                                  PORT<span class=o>(</span>S<span class=o>)</span>        AGE       SELECTOR
nginx-svc   LoadBalancer   100.67.182.148   a54a62300696611e88ba00af02406931-1787163476.eu-central-1.elb.amazonaws.com   80:31196/TCP   9m        <span class=nv>app</span><span class=o>=</span>nginx-app
</code></pre></div><p>A service of type LoadBalancer <strong>combines the capabilities of a NodePort with the ability to setup a complete ingress path</strong>.<br>Hence the service can be accessible from outside the cluster without the need for additional components like an Ingress.</p><p>To test the external IP run this curl command from your local machine:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>
$ curl http://a54a62300696611e88ba00af02406931-1787163476.eu-central-1.elb.amazonaws.com

StatusCode        : <span class=m>200</span>
StatusDescription : OK
Content           : &lt;!DOCTYPE html&gt;
                    &lt;html&gt;
                    &lt;head&gt;
                    &lt;title&gt;Welcome to nginx!&lt;/title&gt;
                    &lt;style&gt;
                        body <span class=o>{</span>
                            width: 35em<span class=p>;</span>
                            margin: <span class=m>0</span> auto<span class=p>;</span>
                            font-family: Tahoma, Verdana, Arial, sans-serif<span class=p>;</span>
                        <span class=o>}</span>
                    &lt;/style&gt;
                    &lt;...
RawContent        : HTTP/1.1 <span class=m>200</span> OK
...
</code></pre></div><p>Obviously the service can also is accessed from within the cluster. You can test this in the same way as described in section <code>NodePort</code>.</p><h2 id=loadbalancer-vs-ingress>LoadBalancer vs. Ingress</h2><p>As presented in the previous section, only the service type LoadBalancer enables access from outside the cluster.
However this approach has its own limitation.
You cannot configure a LoadBalancer to terminate HTTPS traffic, virtual hosts or path-based routing. In Kubernetes 1.2
a separate resource called <a href=https://kubernetes.io/docs/concepts/services-networking/ingress/#alternatives>Ingress</a> is
introduced for this purpose.</p><p>You might need to enable the <code>Nginx Ingress</code> add-ons in your gardener dashboard to use some of those functionnality.</p><h3 id=why-an-ingress>Why an Ingress</h3><p>LoadBalancer services are all about extending a service to support external clients. By contrast an Ingress is a
a separate resource that configures a LoadBalancer in a more flexible way.
The Ingress API supports TLS termination, virtual hosts, and path-based routing. It can easily set up a load balancer to
handle multiple backend services. In addition routing traffic is realised in a different way. In the case of the LoadBalancer service, the traffic entering through the
external load balancer is forwarded to the kube-proxy that in turn forwards
the traffic to the selected pods. In contrast, the Ingress LoadBalancer forwards the traffic straight to the selected
pods which is more efficient.</p><p>Typically a service of type LoadBalancer costs at least 40$ per month. This means if your applications needs 10 of them
you already pay 400$ per month just for load balancing.</p><h3 id=how-to-use-the-ingress>How to use the ingress?</h3><p>In the cluster, a nginx-ingress controller has been deployed for you as an LoadBalancer and also registered the DNS
record. Depending on how your cluster is defined, the DNS registration is performed under following conventions:</p><ul><li><strong>k8s-hana.ondemand.com</strong></li></ul><p><code>&lt;gardener_cluster_name>.&lt;gardener_project_name>.shoot.canary.k8s-hana.ondemand.com</code>.</p><p>Both <code>&lt;gardener_cluster_name></code> and <code>&lt;gardener_project_name></code> are defined in Gardener which can be determined on Gardener dashboard.</p><p>This results in the following default DNS endpoints:</p><ul><li><code>api.&lt;cluster_domain></code> Kubernetes API</li><li><code>*.ingress.&lt;cluster_domain></code> Internal nginx ingress</li></ul><h3 id=example-configure-an-ingress-resource-with-service-type-nodeport>Example: Configure an Ingress resource with Service type: NodePort</h3><p>With the configuration below you can reach your service <strong>nginx-svc</strong> with:</p><p><code>http://test.ingress.&amp;lt;GARDENER-CLUSTER-NAME&amp;gt;.&amp;lt;GARDENER-PROJECT-NAME&amp;gt;.shoot.canary.k8s-hana.ondemand.com</code></p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-app</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-app</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.13.12</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-app</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-svc</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-app</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginxsvc-ingress</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>nginxsvc.ingress.eecluster.cpet.shoot.canary.k8s-hana.ondemand.com</span><span class=w>
</span><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>nginx-svc</span><span class=w>
</span><span class=w>          </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></code></pre></div><p>Show the newly created ingress and test it :</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl get ingress
NAME                    HOSTS                                                               ADDRESS         PORTS     AGE
nginxsvc-ingress        nginxsvc.ingress.eecluster.cpet.shoot.canary.k8s-hana.ondemand.com  10.250.20.203   <span class=m>80</span>        29s

$ curl nginxsvc.ingress.eecluster.cpet.shoot.canary.k8s-hana.ondemand.com

StatusCode        : <span class=m>200</span>
StatusDescription : OK
Content           : &lt;!DOCTYPE html&gt;
                    &lt;html&gt;
                    &lt;head&gt;
                    &lt;title&gt;Welcome to nginx!&lt;/title&gt;
                    &lt;style&gt;
                        body <span class=o>{</span>
                            width: 35em<span class=p>;</span>
                            margin: <span class=m>0</span> auto<span class=p>;</span>
                            font-family: Tahoma, Verdana, Arial, sans-serif<span class=p>;</span>
...
</code></pre></div><h2 id=reference>Reference:</h2><ul><li><a href=https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types>Concepts: Kubernetes Service</a></li><li><a href=https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/#exposing-the-service>Concepts: Connecting Applications with Services</a></li><li><a href=https://kubernetes.io/docs/tutorials/kubernetes-basics/expose/expose-intro/>Tutorial: Using a Service to Expose Your App</a></li><li><a href=https://kubernetes.io/docs/tutorials/services/source-ip>Tutorial: Using Source IP</a></li><li><a href=https://medium.com/google-cloud/understanding-kubernetes-networking-pods-7117dd28727>Kubernetes Networking</a></li><li><a href=http://alesnosek.com/blog/2017/02/14/accessing-kubernetes-pods-from-outside-of-the-cluster/>Accessing Kubernetes Pods from Outside of the Cluster</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a9c93d6cbc648f7853fd4d0aae5fd5f3>2.5.3 - Auditing Kubernetes for Secure Setup</h1><div class=lead>A few insecure configurations in Kubernetes</div><h1 id=auditing-kubernetes-for-secure-setup>Auditing Kubernetes for Secure Setup</h1><p><img src=/__resources/teaser_2d8cc0.svg alt=teaser></p><h2 id=increasing-the-security-of-all-gardener-stakeholders>Increasing the Security of all Gardener Stakeholders</h2><p>In summer 2018, the <a href=https://github.com/gardener/gardener>Gardener project team</a> asked <a href=https://kinvolk.io/>Kinvolk</a> to execute several penetration tests in its role as third-party contractor. The goal of this ongoing work is to increase the security of
all Gardener stakeholders in the open source community. Following the Gardener architecture, the control plane of a
Gardener managed shoot cluster resides in the corresponding seed cluster. This is a
<a href=https://kubernetes.io/blog/2018/05/17/gardener/#kubernetes-control-plane>Control-Plane-as-a-Service</a> with
a <a href=https://kubernetes.io/blog/2018/05/17/gardener/#network-air-gap>network air gap</a>.</p><p>Along the way we found various kinds of security issues, for example, due to misconfiguration or missing isolation,
as well as two special problems with upstream Kubernetes and its Control-Plane-as-a-Service
architecture.</p><h2 id=major-findings>Major Findings</h2><p>From this experience, we’d like to share a few examples of security issues that could happen on a Kubernetes
installation and how to fix them.</p><p>Alban Crequy (<a href=https://kinvolk.io/>Kinvolk</a>) and Dirk Marwinski (<a href=https://www.sap.com>SAP SE</a>) gave a presentation entitled <a href=https://kccncchina2018english.sched.com/event/H2Hd/hardening-multi-cloud-kubernetes-clusters-as-a-service-dirk-marwinski-sap-se-alban-crequy-kinvolk-gmbh>Hardening Multi-Cloud Kubernetes Clusters as a Service</a> at KubeCon 2018 in Shanghai presenting some of the findings.</p><p>Here is a summary of the findings:</p><ul><li><p>Privilege escalation due to insecure configuration of the Kubernetes
API server</p><ul><li>Root cause: Same certificate authority (CA) is used for both the
API server and the proxy that allows accessing the API server.</li><li>Risk: Users can get access to the API server.</li><li>Recommendation: Always use different CAs.</li></ul></li><li><p>Exploration of the control plane network with malicious
HTTP-redirects</p><ul><li><p>Root cause: See detailed description below.</p></li><li><p>Risk: Provoked error message contains full HTTP payload from an
existing endpoint which can be exploited. The contents of the
payload depends on your setup, but can potentially be user data,
configuration data, and credentials.</p></li><li><p>Recommendation:</p><ul><li>Use the latest version of Gardener</li><li>Ensure the seed cluster&rsquo;s container network supports
network policies. Clusters that have been created with
<a href=https://github.com/gardener/kubify>Kubify</a> are not
protected as Flannel is used there which doesn&rsquo;t support
network policies.</li></ul></li></ul></li><li><p>Reading private AWS metadata via Grafana</p><ul><li>Root cause: It is possible to configuring a new custom data
source in Grafana, we could send HTTP requests to target the
control</li><li>Risk: Users can get the &ldquo;user-data&rdquo; for the seed cluster from
the metadata service and retrieve a kubeconfig for that
Kubernetes cluster</li><li>Recommendation: Lockdown Grafana features to only what&rsquo;s
necessary in this setup, block all unnecessary outgoing traffic,
move Grafana to a different network, lockdown unauthenticated
endpoints</li></ul></li></ul><h2 id=scenario-1-privilege-escalation-with-insecure-api-server>Scenario 1: Privilege Escalation with Insecure API Server</h2><p>In most configurations, different components connect directly to the Kubernetes API server, often using a <code>kubeconfig</code> with a client
certificate. The API server is started with the flag:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>/hyperkube apiserver --client-ca-file<span class=o>=</span>/srv/kubernetes/ca/ca.crt ...
</code></pre></div><p>The API server will check whether the client certificate presented by kubectl, kubelet, scheduler or another component
is really signed by the configured certificate authority for clients.</p><p><img src=/__resources/image3_9bc94e.png alt><em>The API server can have many clients of various kinds</em><br><br><br></p><p>However, it is possible to configure the API server differently for use with an intermediate authenticating proxy. The
proxy will authenticate the client with its own custom method and then issue HTTP requests to the API server with
additional HTTP headers specifying the user name and group name. The API server should only accept HTTP requests with HTTP headers from a legitimate proxy. To allow the API server to check incoming requests, you need pass on a list of certificate authorities (CAs) to it. Requests coming from a proxy are only accepted if they use a client certificate that is signed by one of the CAs of that list.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>--requestheader-client-ca-file<span class=o>=</span>/srv/kubernetes/ca/ca-proxy.crt
--requestheader-username-headers<span class=o>=</span>X-Remote-User
--requestheader-group-headers<span class=o>=</span>X-Remote-Group
</code></pre></div><p><img src=/__resources/image2_e15f3f.png alt><em>API server clients can reach the API server through an authenticating proxy</em><br><br><br></p><p>So far, so good. But what happens if malicious user “Mallory” tries to connect directly to the API server and reuses
the HTTP headers to pretend to be someone else?</p><p><img src=/__resources/image8_edf260.png alt><em>What happens when a client bypasses the proxy, connecting directly to the API server?</em><br><br><br></p><p>With a correct configuration, Mallory’s kubeconfig will have a certificate signed by the API server certificate authority
but not signed by the proxy certificate authority. So the API server will not accept the extra HTTP header
“X-Remote-Group: system:masters”.</p><p>You only run into an issue when the same certificate authority is used for both the API server and the proxy. Then, any Kubernetes
client certificate can be used to take the role of different user or group as the API server will accept the user header and
group header.</p><p>The <code>kubectl</code> tool does not normally add those HTTP headers but it’s pretty easy to generate the corresponding HTTP
requests manually.</p><p>We worked on <a href=https://github.com/kubernetes/website/pull/10093>improving the Kubernetes documentation</a> to make clearer
that this configuration should be avoided.</p><h2 id=scenario-2-exploration-of-the-control-plane-network-with-malicious-http-redirects>Scenario 2: Exploration of the Control Plane Network with Malicious HTTP-Redirects</h2><p>The API server is a central component of Kubernetes and many components initiate connections to it, including the Kubelet
running on worker nodes. Most of the requests from those clients will end up updating Kubernetes objects (pods, services,
deployments, and so on) in the etcd database but the API server usually does not need to initiate TCP connections itself.</p><p><img src=/__resources/image7_038441.png alt><em>The API server is mostly a component that receives requests</em><br><br><br></p><p>However, there are exceptions. Some <code>kubectl</code> commands will trigger the API server to open a new
connection to the Kubelet. <code>Kubectl exec</code> is one of those commands. In order to get the standard I/Os from the pod,
the API server will start an HTTP connection to the Kubelet on the worker node where the pod is running. Depending on
the container runtime used, it can be done in different ways, but one way to do it is for the Kubelet to reply with a
HTTP-302 redirection to the <a href=https://github.com/kubernetes/community/blob/master/contributors/devel/container-runtime-interface.md>Container Runtime Interface (CRI)</a>.
Basically, the Kubelet is telling the API server to get the streams from CRI itself directly instead of forwarding. The
redirection from the Kubelet will only change the port and path from the URL; the IP address will not be changed because
the Kubelet and the CRI component run on the same worker node.</p><p><img src=/__resources/image1_892eee.png alt><em>But the API server also initiates some connections, for example, to worker nodes</em><br><br><br></p><p>It’s often quite easy for users of a Kubernetes cluster to get access to worker nodes and tamper with the Kubelet. They
could be given explicit SSH access or they could be given a kubeconfig with enough privileges to create privileged pods
or even just pods with “host” volumes.</p><p>In contrast, users — even those with “system:masters” permissions or “root” rights — are often not given access to the control plane.
On setups like for example GKE or Gardener, the control plane is running on separate nodes, with a different administrative
access. It could be hosted on a different cloud provider account. So users are not free to explore the internal network
in the control plane.</p><p>What would happen if a user was tampering with the Kubelet to make it maliciously redirect <code>kubectl exec</code> requests to
a different random endpoint? Most likely the given endpoint would not speak the streaming server protocol, so there would
be an error. However, the full HTTP payload from the endpoint is included in the error message printed by kubectl exec.</p><p><img src=/__resources/image6_240221.png alt><em>The API server is tricked to connect to other components</em><br><br><br></p><p>The impact of this issue depends on the specific setup. But in many configurations, we could find a metadata service
(such as the <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html>AWS metadata service</a>)
containing user data, configurations and credentials. The setup we explored had a different AWS account and a different
<a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html>EC2 instance profile</a>
for the worker nodes and the control plane. This issue allowed users to get access to the AWS metadata service in the
context of the control plane, which they should not have access to.</p><p>We have reported this issue to the <a href=https://kubernetes.io/docs/reference/issues-security/security/>Kubernetes Security mailing list</a>
and the public pull request that addresses the issue has been merged <a href=https://github.com/kubernetes/kubernetes/pull/66516>PR#66516</a>.
It provides a way to enforce HTTP redirect validation (disabled by default).</p><p>But there are several other ways that users could trigger the API server to generate HTTP requests and get the reply
payload back, so it is advised to isolate the API server and other components from the network as additional precautious measures.
Depending on where the API server runs, it could be with <a href=https://kubernetes.io/docs/concepts/services-networking/network-policies/>Kubernetes Network Policies</a>,
<a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-network-security.html>EC2 Security Groups</a> or just
iptables directly. Following the <a href=https://en.wikipedia.org/wiki/Defense_in_depth_(computing)>defense in depth principle</a>,
it is a good idea to apply the API server HTTP redirect validation when it is available as well as firewall rules.</p><p>In Gardener, this has been fixed with Kubernetes network policies along with changes to ensure the API server does
not need to contact the metadata service. You can see more details in the <a href=https://groups.google.com/forum/#!forum/gardener>announcements on the Gardener mailing list</a>.
This is tracked in <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-2475">CVE-2018-2475</a>.</p><p><em>To be protected from this issue, stakeholders should:</em></p><ul><li><em>Use the latest version of Gardener</em></li><li><em>Ensure the seed cluster’s container network supports network policies. Clusters that have been created with
<a href=https://github.com/gardener/kubify>Kubify</a> are not protected as Flannel is used there which doesn’t support network
policies.</em></li></ul><h2 id=scenario-3-reading-private-aws-metadata-via-grafana>Scenario 3: Reading Private AWS Metadata via Grafana</h2><p>For our tests, we had access to a Kubernetes setup where users are not only given access to the API server in the control
plane, but also to a Grafana instance that is used to gather data from their Kubernetes clusters via Prometheus. The control
plane is managed and users don’t have access to the nodes that it runs. They can only access the API server and Grafana
via a load balancer. The internal network of the control plane is therefore hidden to users.</p><p><img src=/__resources/image5_f50567.png alt><em>Prometheus and Grafana can be used to monitor worker nodes</em><br><br><br></p><p>Unfortunately, that setup was not protecting the control plane network from nosy users. By configuring a new custom
data source in Grafana, we could send HTTP requests to target the control plane network, for example the AWS metadata
service. The reply payload is not displayed on the Grafana Web UI but it is possible to access it from the debugging
console of the Chrome browser.</p><p><img src=/__resources/image9_d39dc7.png alt><em>Credentials can be retrieved from the debugging console of Chrome</em><br><br><br></p><p><img src=/__resources/image4_a248a3.png alt><em>Adding a Grafana data source is a way to issue HTTP requests to arbitrary targets</em><br><br><br></p><p>In that installation, users could get the “user-data” for the seed cluster from the metadata service and retrieve a
kubeconfig for that Kubernetes cluster.</p><p>There are many possible measures to avoid this situation: lockdown Grafana features to only what’s necessary in this setup, block all
unnecessary outgoing traffic, move Grafana to a different network, lockdown unauthenticated endpoints.</p><h2 id=conclusion>Conclusion</h2><p>The three scenarios above show pitfalls with a Kubernetes setup. A lot of them were specific to the Kubernetes
installation: different cloud providers or different configurations will show different weakness. Users should no longer be given access to Grafana.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2e8efeb071c3d7a7cfbd4334db1fb8b8>2.5.4 - Container image not pulled</h1><div class=lead>Wrong Container Image or Invalid Registry Permissions</div><h2 id=problem>Problem</h2><p>Two of the most common problems are specifying the wrong container image or trying to use
private images without providing registry credentials.</p><p><strong>Note:</strong> There is no observable difference in Pod status between a missing image and incorrect registry permissions.
In either case, Kubernetes will report an ErrImagePull status for the Pods. For this reason, this article deals with
both scenarios.</p><h2 id=example>Example</h2><p>Let&rsquo;s see an example. We&rsquo;ll create a pod named <em>fail</em> referencing a non-existent Docker image:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>kubectl run -i --tty fail --image<span class=o>=</span>tutum/curl:1.123456
</code></pre></div><p>the command prompt doesn&rsquo;t return and you can press <code>ctrl+c</code></p><h2 id=error-analysis>Error analysis</h2><p>We can then inspect our Pods and see that we have one Pod with a status of <strong>ErrImagePull</strong> or <strong>ImagePullBackOff</strong>.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>$ <span class=o>(</span>minikube<span class=o>)</span> kubectl get pods
NAME                      READY     STATUS         RESTARTS   AGE
client-5b65b6c866-cs4ch   1/1       Running        <span class=m>1</span>          1m
fail-6667d7685d-7v6w8     0/1       ErrImagePull   <span class=m>0</span>          &lt;invalid&gt;
vuejs-578574b75f-5x98z    1/1       Running        <span class=m>0</span>          1d
$ <span class=o>(</span>minikube<span class=o>)</span> 

</code></pre></div><p>For some additional information, we can <code>describe</code> the failing Pod.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>kubectl describe pod fail-6667d7685d-7v6w8
</code></pre></div><p>As you can see in the events section, your image can&rsquo;t be pulled</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>Name:		fail-6667d7685d-7v6w8
Namespace:	default
Node:		minikube/192.168.64.10
Start Time:	Wed, 22 Nov 2017 10:01:59 +0100
Labels:		pod-template-hash=2223832418
		run=fail
Annotations:	kubernetes.io/created-by={&#34;kind&#34;:&#34;SerializedReference&#34;,&#34;apiVersion&#34;:&#34;v1&#34;,&#34;reference&#34;:{&#34;kind&#34;:&#34;ReplicaSet&#34;,&#34;namespace&#34;:&#34;default&#34;,&#34;name&#34;:&#34;fail-6667d7685d&#34;,&#34;uid&#34;:&#34;cc4ccb3f-cf63-11e7-afca-4a7a1fa05b3f&#34;,&#34;a...
.
.
.
.
Events:
  FirstSeen	LastSeen	Count	From			SubObjectPath		Type		Reason			Message
  ---------	--------	-----	----			-------------		--------	------			-------
  1m		1m		1	default-scheduler				Normal		Scheduled		Successfully assigned fail-6667d7685d-7v6w8 to minikube
  1m		1m		1	kubelet, minikube				Normal		SuccessfulMountVolume	MountVolume.SetUp succeeded for volume &#34;default-token-9fr6r&#34; 
  1m		6s		4	kubelet, minikube	spec.containers{fail}	Normal		Pulling			pulling image &#34;tutum/curl:1.123456&#34;
  1m		5s		4	kubelet, minikube	spec.containers{fail}	Warning		Failed			Failed to pull image &#34;tutum/curl:1.123456&#34;: rpc error: code = Unknown desc = Error response from daemon: manifest for tutum/curl:1.123456 not found
  1m		&lt;invalid&gt;	10	kubelet, minikube				Warning		FailedSync		Error syncing pod
  1m		&lt;invalid&gt;	6	kubelet, minikube	spec.containers{fail}	Normal		BackOff			Back-off pulling image &#34;tutum/curl:1.123456&#34;
</code></pre></div><p><strong>Why couldn&rsquo;t Kubernetes pull the image?</strong>
There are three primary candidates besides network connectivity issues:</p><ul><li>The image tag is incorrect</li><li>The image doesn&rsquo;t exist</li><li>Kubernetes doesn&rsquo;t have permissions to pull that image</li></ul><p>If you don&rsquo;t notice a typo in your image tag, then it&rsquo;s time to test using your local machine. I usually start by
running <strong>docker pull on my local development machine</strong> with the exact same image tag. In this case, I would
run <code>docker pull tutum/curl:1.123456</code></p><p>If this succeeds, then it probably means that Kubernetes doesn&rsquo;t have correct permissions to pull that image.</p><p>Add the docker registry user/pwd to your cluster</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>kubectl create secret docker-registry dockersecret --docker-server<span class=o>=</span>https://index.docker.io/v1/ --docker-username<span class=o>=</span>&lt;username&gt; --docker-password<span class=o>=</span>&lt;password&gt; --docker-email<span class=o>=</span>&lt;email&gt;
</code></pre></div><p>If the exact image tag fails, then I will test without an explicit image tag - <code>docker pull tutum/curl</code> - which will attempt to pull the latest tag. If this succeeds, then that means
the originally specified tag doesn&rsquo;t exist. Go to the Docker registry and check which tags are available for this image.</p><p>If <code>docker pull tutum/curl</code> (without an exact tag) fails, then we have a bigger problem -
that image does not exist at all in our image registry.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e7486173c78c00fc1dfc4e45f04c5c7f>2.5.5 - Container image not updating</h1><div class=lead>Updating Images in your cluster during development</div><h2 id=preface>Preface</h2><p>A container image should use a fixed tag or the content hash of the image. It should not use the tags <strong>latest</strong>,
<strong>head</strong>, <strong>canary</strong>, or other tags that are designed to be <em>floating</em>.</p><h2 id=problem>Problem</h2><p>Many Kubernetes users have run into this problem.
The story goes something like this:</p><ul><li>Deploy any image using an image tag (e.g. cp-enablement/awesomeapp:1.0)</li><li>Fix a bug in awesomeapp</li><li>Build a new image and push it with the <strong>same tag</strong> (cp-enablement/awesomeapp:1.0)</li><li>Update your deployment</li><li>Realize that the bug is still present</li><li>Rinse and repeat steps 3 to 5 until you recognize this doesn&rsquo;t work</li></ul><p>The problem relates to how Kubernetes decides whether to do a <em>docker pull</em> when starting a container.
Since we tagged our image as <em>:1.0</em>, the default pull policy is <strong>IfNotPresent</strong>. The Kubelet already has a local
copy of cp-enablement/awesomeapp:1.0, hence it doesn&rsquo;t attempt to do a docker pull. When the new Pods come up,
they still use the old broken Docker image.</p><p>There are three ways to resolve this:</p><ul><li><del>Switch to using the tag :latest</del> (DO NOT DO THIS!)</li><li>Specify ImagePullPolicy: always (not recomended).</li><li><strong>Use unique tags (best practice)</strong></li></ul><h2 id=solution>Solution</h2><p>In the quest to automate myself out of a job, I created a bash script that runs anytime to create a new tag
and push the build result to the registry.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#!/usr/bin/env bash
</span><span class=cp></span>
<span class=c1># Set the docker image name and the corresponding repository</span>
<span class=c1># Ensure that you change them in the deployment.yml as well.</span>
<span class=c1># You must be logged in with docker login…</span>
<span class=c1>#</span>
<span class=c1># CHANGE THIS TO YOUR Docker.io SETTINGS</span>
<span class=c1>#</span>
<span class=nv>PROJECT</span><span class=o>=</span>awesomeapp
<span class=nv>REPOSITORY</span><span class=o>=</span>cp-enablement

<span class=c1># exit if any subcommand or pipeline returns a non-zero status.</span>
<span class=nb>set</span> -e

<span class=c1># set debug mode</span>
<span class=c1>#set -x</span>

<span class=c1># build my nodeJS app</span>
<span class=c1>#</span>
npm run build

<span class=c1># get latest version IDs from the Docker.io registry and increment them</span>
<span class=c1>#</span>
<span class=nv>VERSION</span><span class=o>=</span><span class=k>$(</span>curl https://registry.hub.docker.com/v1/repositories/<span class=nv>$REPOSITORY</span>/<span class=nv>$PROJECT</span>/tags  <span class=p>|</span> sed -e <span class=s1>&#39;s/[][]//g&#39;</span> -e <span class=s1>&#39;s/&#34;//g&#39;</span> -e <span class=s1>&#39;s/ //g&#39;</span> <span class=p>|</span> tr <span class=s1>&#39;}&#39;</span> <span class=s1>&#39;\n&#39;</span>  <span class=p>|</span> awk -F: <span class=s1>&#39;{print $3}&#39;</span> <span class=p>|</span> grep v<span class=p>|</span> tail -n 1<span class=k>)</span>
<span class=nv>VERSION</span><span class=o>=</span><span class=si>${</span><span class=nv>VERSION</span><span class=p>:</span><span class=nv>1</span><span class=si>}</span>
<span class=o>((</span>VERSION++<span class=o>))</span>
<span class=nv>VERSION</span><span class=o>=</span><span class=s2>&#34;v</span><span class=nv>$VERSION</span><span class=s2>&#34;</span>


<span class=c1># build a new docker image</span>
<span class=c1>#</span>
<span class=nb>echo</span> <span class=s1>&#39;&gt;&gt;&gt; Building new image&#39;</span>
<span class=c1># Due to a bug in Docker we need to analyse the log to find out if build passed (see https://github.com/dotcloud/docker/issues/1875)</span>
docker build --no-cache<span class=o>=</span><span class=nb>true</span> -t <span class=nv>$REPOSITORY</span>/<span class=nv>$PROJECT</span>:<span class=nv>$VERSION</span> . <span class=p>|</span> tee /tmp/docker_build_result.log
<span class=nv>RESULT</span><span class=o>=</span><span class=k>$(</span>cat /tmp/docker_build_result.log <span class=p>|</span> tail -n 1<span class=k>)</span>
<span class=k>if</span> <span class=o>[[</span> <span class=s2>&#34;</span><span class=nv>$RESULT</span><span class=s2>&#34;</span> !<span class=o>=</span> *Successfully* <span class=o>]]</span><span class=p>;</span>
<span class=k>then</span>
  <span class=nb>exit</span> -1
<span class=k>fi</span>


<span class=nb>echo</span> <span class=s1>&#39;&gt;&gt;&gt; Push new image&#39;</span>
docker push <span class=nv>$REPOSITORY</span>/<span class=nv>$PROJECT</span>:<span class=nv>$VERSION</span>


</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-a7727382924a6be0bac7859384e0cf01>2.5.6 - Custom Seccomp profile</h1><h1 id=custom-seccomp-profile>Custom Seccomp profile</h1><h2 id=context>Context</h2><p><a href=https://en.wikipedia.org/wiki/Seccomp>Seccomp</a> (secure computing mode) is a security facility in the Linux kernel for restricting the set of system calls applications can make.</p><p>Starting from Kubernetes v1.3.0 the Seccomp feature is in <code>Alpha</code>. To configure it on a <code>Pod</code>, the following annotations can be used:</p><ul><li><code>seccomp.security.alpha.kubernetes.io/pod: &lt;seccomp-profile></code> where <code>&lt;seccomp-profile></code> is the seccomp profile to apply to all containers in a <code>Pod</code>.</li><li><code>container.seccomp.security.alpha.kubernetes.io/&lt;container-name>: &lt;seccomp-profile></code> where <code>&lt;seccomp-profile></code> is the seccomp profile to apply to <code>&lt;container-name></code> in a <code>Pod</code>.</li></ul><p>More details can be found in the <code>PodSecurityPolicy</code> <a href=https://kubernetes.io/docs/concepts/policy/pod-security-policy/#seccomp>documentation</a>.</p><h2 id=installation-of-custom-profile>Installation of custom profile</h2><p>By default, kubelet loads custom Seccomp profiles from <code>/var/lib/kubelet/seccomp/</code>. There are two ways in which Seccomp profiles can be added to a <code>Node</code>:</p><ul><li>to be baked in the machine image</li><li>to be added at runtime.</li></ul><p>This guide focuses on creating those profiles via a <code>DaemonSet</code>.</p><p>Create a file called <code>seccomp-profile.yaml</code> with the following content:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>seccomp-profile</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>my-profile.json</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    {
</span><span class=sd>      &#34;defaultAction&#34;: &#34;SCMP_ACT_ALLOW&#34;,
</span><span class=sd>      &#34;syscalls&#34;: [
</span><span class=sd>        {
</span><span class=sd>          &#34;name&#34;: &#34;chmod&#34;,
</span><span class=sd>          &#34;action&#34;: &#34;SCMP_ACT_ERRNO&#34;
</span><span class=sd>        }
</span><span class=sd>      ]
</span><span class=sd>    }</span><span class=w>    
</span></code></pre></div><blockquote><p>The policy above is a very simple one and not siutable for complex applications. The <a href=https://github.com/moby/moby/blob/v17.05.0-ce/profiles/seccomp/default.json>default docker profile</a> can be used a reference. Feel free to modify it to your needs.</p></blockquote><p>Apply the <code>ConfigMap</code> in your cluster:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl apply -f seccomp-profile.yaml
configmap/seccomp-profile created
</code></pre></div><p>The next steps is to create the <code>DaemonSet</code> seccomp installer. It&rsquo;s going to copy the policy from above in <code>/var/lib/kubelet/seccomp/my-profile.json</code>.</p><p>Create a file called <code>seccomp-installer.yaml</code> with the following content:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>seccomp</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>security</span><span class=p>:</span><span class=w> </span><span class=l>seccomp</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>security</span><span class=p>:</span><span class=w> </span><span class=l>seccomp</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>security</span><span class=p>:</span><span class=w> </span><span class=l>seccomp</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>installer</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>alpine:3.10.0</span><span class=w>
</span><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;cp -r -L /seccomp/*.json /host/seccomp/&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>profiles</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/seccomp</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hostseccomp</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/host/seccomp</span><span class=w>
</span><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pause</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/pause:3.1</span><span class=w>
</span><span class=w>      </span><span class=nt>terminationGracePeriodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>hostseccomp</span><span class=w>
</span><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/kubelet/seccomp</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>profiles</span><span class=w>
</span><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>seccomp-profile</span><span class=w>
</span></code></pre></div><p>Create the installer and wait until it&rsquo;s ready on all <code>Nodes</code>:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl apply -f seccomp-installer.yaml
daemonset.apps/seccomp-installer created

$ kubectl -n kube-system get pods -l security=seccomp
NAME                      READY   STATUS    RESTARTS   AGE
seccomp-installer-wjbxq   1/1     Running   0          21s
</code></pre></div><h2 id=create-a-pod-using-custom-seccomp-profile>Create a Pod using custom Seccomp profile</h2><p>Finally we want to create a profile which uses our new Seccomp profile <code>my-profile.json</code>.</p><p>Create a file called <code>my-seccomp-pod.yaml</code> with the following content:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>seccomp-app</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>seccomp.security.alpha.kubernetes.io/pod</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;localhost/my-profile.json&#34;</span><span class=w>
</span><span class=w>    </span><span class=c># you can specify seccomp profile per container. If you add another profile you can configure</span><span class=w>
</span><span class=w>    </span><span class=c># it for a specific container - &#39;pause&#39; in this case.</span><span class=w>
</span><span class=w>    </span><span class=c># container.seccomp.security.alpha.kubernetes.io/pause: &#34;localhost/some-other-profile.json&#34;</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pause</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/pause:3.1</span><span class=w>
</span></code></pre></div><p>Create the <code>Pod</code> and see that&rsquo;s running:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl apply -f my-seccomp-pod.yaml
pod/seccomp-app created

$ kubectl get pod seccomp-app
NAME         READY   STATUS    RESTARTS   AGE
seccomp-app  1/1     Running   0          42s
</code></pre></div><h2 id=throubleshooting>Throubleshooting</h2><p>If an invalid or not existing profile is used then the <code>Pod</code> will be stuck in <code>ContainerCreating</code> phase:</p><p><code>broken-seccomp-pod.yaml</code>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>broken-seccomp</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>seccomp.security.alpha.kubernetes.io/pod</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;localhost/not-existing-profile.json&#34;</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pause</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/pause:3.1</span><span class=w>
</span></code></pre></div><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl apply -f broken-seccomp-pod.yaml
pod/broken-seccomp created

$ kubectl get pod broken-seccomp
NAME            READY   STATUS              RESTARTS   AGE
broken-seccomp  1/1     ContainerCreating   0          2m

$ kubectl describe pod broken-seccomp
Name:               broken-seccomp
Namespace:          default
....
Events:
  Type     Reason                  Age               From                     Message
  ----     ------                  ----              ----                     -------
  Normal   Scheduled               18s               default-scheduler        Successfully assigned kube-system/broken-seccomp to docker-desktop
  Warning  FailedCreatePodSandBox  4s (x2 over 18s)  kubelet, docker-desktop  Failed create pod sandbox: rpc error: code = Unknown desc = failed to make sandbox docker config for pod &#34;broken-seccomp&#34;: failed to generate sandbox security options
for sandbox &#34;broken-seccomp&#34;: failed to generate seccomp security options for container: cannot load seccomp profile &#34;/var/lib/kubelet/seccomp/not-existing-profile.json&#34;: open /var/lib/kubelet/seccomp/not-existing-profile.json: no such file or directory
</code></pre></div><h2 id=further-reading>Further reading</h2><ul><li><a href=https://en.wikipedia.org/wiki/Seccomp>https://en.wikipedia.org/wiki/Seccomp</a></li><li><a href=https://docs.docker.com/engine/security/seccomp>https://docs.docker.com/engine/security/seccomp</a></li><li><a href=https://lwn.net/Articles/656307/>https://lwn.net/Articles/656307/</a></li><li><a href=http://man7.org/conf/lpc2015/limiting_kernel_attack_surface_with_seccomp-LPC_2015-Kerrisk.pdf>http://man7.org/conf/lpc2015/limiting_kernel_attack_surface_with_seccomp-LPC_2015-Kerrisk.pdf</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8de2e5545164d701b7df8e8a18ef00b2>2.5.7 - Dockerfile pitfalls</h1><div class=lead>Common Dockerfile pitfalls</div><h2 id=using-latest-tag-for-an-image>Using latest tag for an image</h2><p>Many Dockerfiles use the FROM package:latest pattern at the top of their Dockerfiles to pull the latest
image from a Docker registry.</p><h3 id=bad-dockerfile>Bad Dockerfile</h3><div class=highlight><pre class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=k>FROM</span><span class=s> alpine</span><span class=err>
</span></code></pre></div><p>While simple, using the latest tag for an image means that your build
can suddenly break if that image gets updated. This can lead to problems where everything builds fine
locally (because your local cache thinks it is the latest) while a build server may fail, because some
Pipelines makes a clean pull on every build. Additionally, troubleshooting can prove to be
difficult, since the maintainer of the Dockerfile didn&rsquo;t actually make any changes.</p><h3 id=good-dockerfile>Good Dockerfile</h3><p>A digest takes the place of the tag when pulling an image. This will ensure your Dockerfile remains immutable.</p><div class=highlight><pre class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=k>FROM</span><span class=s> alpine@sha256:7043076348bf5040220df6ad703798fd8593a0918d06d3ce30c6c93be117e430</span><span class=err>
</span></code></pre></div><h2 id=running-aptapkyum-update>Running apt/apk/yum update</h2><p>Running apt-get install is one of those things virtually every Debian-based Dockerfile will have to
satiate some external package requirements your code needs to run. But, using apt-get as an example, comes with
its own problems.</p><p><strong>apt-get upgrade</strong></p><p>This will update all your packages to their latests versions, which can be bad because it prevents your Dockerfile
from creating consistent, immutable builds.</p><p><strong>apt-get update in a different line than running your apt-get install command.</strong></p><p>Running apt-get update as a single line entry will get cached by the build and won&rsquo;t actually run every
time you need to run apt-get install. Instead, make sure you run apt-get update in the same line with all
the packages to ensure all are updated correctly.</p><h2 id=avoid-big-container-images>Avoid big container images</h2><p>Building small container image will reduce the time needed to start or restart pods. An image based on the popular
<a href=http://alpinelinux.org/>Alpine Linux project</a> is much smaller
than most distribution based images (~5MB). For most popular languages
and products, there are usually an official Alpine Linux image, e.g. <a href=https://hub.docker.com/_/golang/>golang</a>,
<a href=https://hub.docker.com/_/node/>nodejs</a> and <a href=https://hub.docker.com/_/postgres/>postgres</a>.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$  docker images
REPOSITORY                                                      TAG                     IMAGE ID            CREATED             SIZE
postgres                                                        9.6.9-alpine            6583932564f8        <span class=m>13</span> days ago         39.26 MB
postgres                                                        9.6                     d92dad241eff        <span class=m>13</span> days ago         235.4 MB
postgres                                                        10.4-alpine             93797b0f31f4        <span class=m>13</span> days ago         39.56 MB
</code></pre></div><p>In addition, for compiled languages such as Go or C++ which does not requires build time tooling during runtime, it
is recommended to avoid build time tooling in the final images. With Docker&rsquo;s support for
<a href=https://docs.docker.com/engine/userguide/eng-image/multistage-build/>multi-stages builds</a>
this can be easily achieved with minimal effort. Such an example can be found <a href=https://docs.docker.com/develop/develop-images/multistage-build/#name-your-build-stages>here</a>.<br>Google&rsquo;s <a href=https://github.com/GoogleContainerTools/distroless>distroless</a> image is also a good base image.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d65e7a77c3c4bf464f24d76782f40592>2.5.8 - HTTPS with self Signed Certificate</h1><h2 id=configuring-ingress-with-front-end-tls>Configuring ingress with front-end TLS</h2><p>It is alyways recommended to enable encryption for services to prevent traffic interception and
man-in-the-middle attacks - even in DEV environments.</p><p><img src="https://github.com/freegroup/kube-https/raw/master/images/ingress-https.png?raw=true" alt=Screen title=Screenshot></p><p>You should configure front-end Transport Layer Security (TLS) so that the ingress controller can secure
access to a service from the client to the load balancer by using HTTPS.</p><p>We will use basic procedure here. If your configuration requires advanced security options, please refer
to official CloudFlare&rsquo;s <a href=https://github.com/cloudflare/cfssl>cfssl</a> documentation.</p><h2 id=before-you-begin>Before you begin</h2><p>At first, you need to have a Kubernetes cluster, and the kubectl command-line tool must be configured to communicate
with your cluster. If you do not already have a cluster, you can create one by using Gardener</p><h3 id=install-cfssl>Install CFSSL</h3><p>The first step in securing Docker and Kubernetes is to set up a PKI infrastructure for managing TLS certificates.</p><h3 id=initialize-a-ca>Initialize a CA</h3><p>Before we can generate any certs we need to initialize a CA.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir cfssl
<span class=nb>cd</span> cfssl
cfssl print-defaults config &gt; ca-config.json
cfssl print-defaults csr &gt; ca-csr.json
</code></pre></div><h3 id=configure-ca-options>Configure CA options</h3><p>Now we can configure signing options inside ca-config.json config file. Default options
contain following preconfigured fields:</p><ul><li>profiles: www with server auth (TLS Web Server Authentication) X509 V3 extension and client with client auth (TLS Web Client Authentication) X509 V3 extension.</li><li>expiry: with 8760h default value (or 365 days)</li></ul><p>For compliance let&rsquo;s edit the <code>ca-config.json</code> file and rename <em><strong>www</strong></em> profile into <strong>server</strong></p><p>Edit the <code>ca-csr.json</code> to your needs. See example below. Keep in mind that the <strong>hosts</strong> entries must match
all your ingress entries.</p><p>example <code>ca-csr.json</code></p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
    <span class=nt>&#34;CN&#34;</span><span class=p>:</span> <span class=s2>&#34;Gardener Self Signed CA&#34;</span><span class=p>,</span>
    <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span>
        <span class=s2>&#34;ui.ingress.https-test.cpet.shoot.canary.k8s-hana.ondemand.com&#34;</span><span class=p>,</span>
        <span class=s2>&#34;api.ingress.https-test.cpet.shoot.canary.k8s-hana.ondemand.com&#34;</span>
    <span class=p>],</span>
    <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;algo&#34;</span><span class=p>:</span> <span class=s2>&#34;rsa&#34;</span><span class=p>,</span>
        <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>2048</span>
    <span class=p>},</span>
    <span class=nt>&#34;names&#34;</span><span class=p>:</span> <span class=p>[</span>
        <span class=p>{</span>
            <span class=nt>&#34;C&#34;</span><span class=p>:</span> <span class=s2>&#34;US&#34;</span><span class=p>,</span>
            <span class=nt>&#34;ST&#34;</span><span class=p>:</span> <span class=s2>&#34;CA&#34;</span><span class=p>,</span>
            <span class=nt>&#34;L&#34;</span><span class=p>:</span> <span class=s2>&#34;San Francisco&#34;</span>
        <span class=p>}</span>
    <span class=p>]</span>
<span class=p>}</span>
</code></pre></div><p>And generate CA with defined options:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>cfssl gencert -initca ca-csr.json <span class=p>|</span> cfssljson -bare ca -
</code></pre></div><p>You&rsquo;ll get following files:</p><ul><li>ca-key.pem</li><li>ca.csr</li><li>ca.pem</li></ul><p><strong>Note: Please keep ca-key.pem file in safe. This key allows to create any kind of certificates within your CA.</strong></p><h2 id=generate-server-certificate>Generate server certificate</h2><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>cfssl print-defaults csr &gt; server.json
</code></pre></div><p>Most important values for server certificate are Common Name (CN) and hosts. We have to substitute them, for example:</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
    <span class=nt>&#34;CN&#34;</span><span class=p>:</span> <span class=s2>&#34;Gardener Self Signed CA&#34;</span><span class=p>,</span>
    <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span>
        <span class=s2>&#34;ui.ingress.https-test.cpet.shoot.canary.k8s-hana.ondemand.com&#34;</span><span class=p>,</span>
        <span class=s2>&#34;api.ingress.https-test.cpet.shoot.canary.k8s-hana.ondemand.com&#34;</span>
    <span class=p>],</span>
    <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;algo&#34;</span><span class=p>:</span> <span class=s2>&#34;rsa&#34;</span><span class=p>,</span>
        <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>2048</span>
    <span class=p>},</span>
    <span class=nt>&#34;names&#34;</span><span class=p>:</span> <span class=p>[</span>
        <span class=p>{</span>
            <span class=nt>&#34;C&#34;</span><span class=p>:</span> <span class=s2>&#34;US&#34;</span><span class=p>,</span>
            <span class=nt>&#34;ST&#34;</span><span class=p>:</span> <span class=s2>&#34;CA&#34;</span><span class=p>,</span>
            <span class=nt>&#34;L&#34;</span><span class=p>:</span> <span class=s2>&#34;San Francisco&#34;</span>
        <span class=p>}</span>
    <span class=p>]</span>
<span class=p>}</span>

</code></pre></div><p>Now we are ready to generate server certificate and private key:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>cfssl gencert -ca<span class=o>=</span>ca.pem -ca-key<span class=o>=</span>ca-key.pem -config<span class=o>=</span>ca-config.json -profile<span class=o>=</span>server server.json <span class=p>|</span> cfssljson -bare server
</code></pre></div><p>You&rsquo;ll get following files:</p><ul><li>server-key.pem</li><li>server.csr</li><li>server.pem</li></ul><h2 id=configure-kubernetes-ingress-with-tls>Configure Kubernetes ingress with TLS</h2><p>To configure front-end TLS, you need to create a TLS certificate (already done above), create a Kubernetes secret, update
applicable .yaml files, apply your .yaml file changes, regenerate ingress controllers, and visit the application.</p><h2 id=create-kubernetes-secret>Create Kubernetes secret</h2><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>kubectl create secret tls tls-secret --key ./server-key.pem --cert server.pem
</code></pre></div><h2 id=create-service--ingress>Create Service / Ingress</h2><p>now you can referenc ethe TLS secret within your ingress definition</p><p>example ingress definition</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>node-server</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node-svc</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>node-server</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node-ingress</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>ui.ingress.https-test.cpet.shoot.canary.k8s-hana.ondemand.com</span><span class=w>
</span><span class=w>    </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>tls-secret</span><span class=w>
</span><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>ui.ingress.https-test.cpet.shoot.canary.k8s-hana.ondemand.com</span><span class=w>
</span><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>node-svc</span><span class=w>
</span><span class=w>          </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span><span class=w>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-f45e1e3bb19a23ceeebe6d769078b409>2.5.9 - Integrity and Immutability</h1><div class=lead>Ensure that you get always the right image</div><h2 id=introduction>Introduction</h2><p>When transferring data among networked systems, <strong>trust is a central concern</strong>. In particular, when communicating over an
untrusted medium such as the internet, it is critical to ensure the <strong>integrity and immutability</strong> of all the data a
system operates on. Especially if you use Docker Engine to push and pull images (data) to a <strong>public registry</strong>.</p><p>This immutability offers me a guarantee that any and all containers that I instantiate will be absolutely identical
at inception. Surprise surprise, deterministic operations.</p><h2 id=a-lesson-in-deterministic-ops>A Lesson in Deterministic Ops</h2><p>Docker Tags are about as reliable and disposable as this guy down here.</p><p><img src=/__resources/howto-content-trust_866756.svg alt=docker-labels></p><p>Seems simple enough. You have probably already deployed hundreds of YAML&rsquo;s or started endless count of Docker container.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker run --name mynginx1 -P -d nginx:1.13.9
</code></pre></div><p>or</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rss-site</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>front-end</span><span class=w>
</span><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.13.9</span><span class=w>
</span><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></code></pre></div><p><strong>But Tags are mutable and humans are prone to error. Not a good combination.</strong> Here we’ll dig into why the use of tags can
be dangerous and how to deploy your containers across a pipeline and across environments, you guessed it, with
<strong>determinism in mind</strong>.</p><p>I want to ensure that whether it’s today or 5 years from now, that specific deployment uses the very same image that
I defined. Any updates or newer versions of an image should be executed as a new deployment. <strong>The solution: digest</strong></p><p>A digest takes the place of the tag when pulling an image, for example, to pull the above image by digest, run the
following command:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker run --name mynginx1 -P -d nginx@sha256:4771d09578c7c6a65299e110b3ee1c0a2592f5ea2618d23e4ffe7a4cab1ce5de
</code></pre></div><p>You can now make sure that the same image is always loaded at every deployment. It doesn&rsquo;t matter if the TAG of the
image has been changed or not. <strong>This solves the problem of repeatability.</strong></p><h2 id=content-trust>Content Trust</h2><p>However, there’s an additionally hidden danger. It is possible for an attacker to replace a server image with another
one infected with malware.</p><p><img src=/__resources/howto-content-trust-replace_615330.svg alt=docker-content-trust></p><p><a href=https://docs.docker.com/engine/security/trust/content_trust/>Docker Content trust</a> gives
you the ability to verify both the integrity and the publisher of all the data received from a registry over any channel.</p><p>Prior to version 1.8, Docker didn’t have a way to verify the authenticity of a server image. But in v1.8, a new feature
called <strong>Docker Content Trust</strong> was introduced to automatically sign and verify the signature of a publisher.</p><p>So, as soon as a server image is downloaded, it is cross-checked with the signature of the publisher to see
if someone tampered with it in any way. <strong>This solves the problem of trust.</strong></p><p>In addition you should scan all images for known vulnerabilities, this can fill another book</p></div><div class=td-content style=page-break-before:always><h1 id=pg-7d122ee5ae2c428bfe3d1293dd385721>2.5.10 - Kubernetes Antipatterns</h1><div class=lead>Common Antipatterns for Kubernetes and Docker</div><p><img src=/__resources/howto-antipattern_faca4e.png alt=antipattern></p><p>This HowTo covers common kubernetes antipatterns that we have seen over the past months.</p><h2 id=running-as-root-user>Running as root user.</h2><p>Whenever possible, do not run containers as root user. One could be
tempted to say that Kubernetes Pods and Node are well separated. Host and containers running on it
share the same kernel. If a container is compromised, the root user in the container has full control over the
underlying node.</p><p>Watch the very good presentation by Liz Rice at the KubeCon 2018</p><iframe width=560 height=315 src=https://www.youtube.com/embed/ltrV-Qmh3oY frameborder=0 allow="autoplay; encrypted-media" allowfullscreen></iframe><p>Use <code>RUN groupadd -r anygroup && useradd -r -g anygroup myuser</code> to create a group
and add a user to it. Use the <code>USER</code> command to switch to this user. Note that you may also consider to provide
<a href=https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#user>an explicit UID/GID</a> if required.</p><p>For Example:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>ARG GF_UID=&#34;500&#34;
ARG GF_GID=&#34;500&#34;

# add group &amp; user
RUN groupadd -r -g $GF_GID appgroup &amp;&amp; \
   useradd appuser -r -u $GF_UID -g appgroup

USER appuser

</code></pre></div><h2 id=store-data-or-logs-in-containers>Store data or logs in containers</h2><p>Containers are ideal for stateless applications
and should be transient. This means that no data or logs should be stored in the
container, as they are lost when the container is closed. Use persistence volumes instead to persist data outside
of containers. Using an <a href=https://www.elastic.co/de/elk-stack>ELK stack</a> is another good option for storing and processing logs.</p><h2 id=using-pod-ip-addresses>Using pod IP addresses</h2><p>Each pod is assigned an IP address. It is necessary
for pods to communicate with each other to build an application, e.g. an application
must communicate with a database. Existing pods are terminated and new pods are
constantly started. If you would rely on the IP address of a pod or container, you would need to update the application
configuration constantly. This makes the application fragile. Create
services instead. They provide a logical name that can be assigned independently of the
varying number and IP addresses of containers. Services are the basic concept for load
balancing within Kubernetes.</p><h2 id=more-than-one-process-in-a-container>More than one process in a container</h2><p>A docker file provides a <code>CMD</code> and <code>ENTRYPOINT</code> to
start the image. <code>CMD</code> is often used around a script that makes a configuration and then
starts the container. Do not try to start multiple processes with this script. It is
important to consider the separation of concerns when creating docker images. Running multiple processes in a single pod makes
managing your containers, collecting logs and updating each process more difficult.
You can split the image into multiple containers and manage them independently - even in one pod.
Bear in mind that Kubernetes only monitors the process with PID=1. If more than
one process is started within a container, then these no longer fall under the control of Kubernetes.</p><h2 id=creating-images-in-a-running-container>Creating images in a running container</h2><p>A new image can be created with the <code>docker commit</code>
command. This is useful if changes have been made to the container and you want to persist
them for later error analysis. However, images created like this are not reproducible and
completely worthless for a CI/CD environment. Furthermore, another developer cannot recognize
which components the image contains. Instead, always make changes to the docker file, close
existing containers and start a new container with the updated image.</p><h2 id=saving-passwords-in-docker-image-->Saving passwords in docker image 💀</h2><p>Do not save passwords in a Docker file. They are in plain
text and are checked into a repository. That makes them completely vulnerable even if you are using
a private repository like the Artifactory.
Always use <a href=https://kubernetes.io/docs/tasks/inject-data-application/distribute-credentials-secure>Secrets or ConfigMaps</a>
to provision passwords or inject them by mounting a persistent volume.</p><h2 id=using-the-latest-tag>Using the &lsquo;latest&rsquo; tag</h2><p>Starting an image with <em>tomcat</em> is tempting. If no tags are specified, a container is
started with the tomcat:latest image. This image may no longer be up to date and refers to an
older version instead. Running a production application requires complete control of the environment
with exact versions of the image. Make sure you always use a tag or even better the <strong>sha256 hash</strong>
of the image e.g. <code>tomcat@sha256:c34ce3c1fcc0c7431e1392cc3abd0dfe2192ffea1898d5250f199d3ac8d8720f</code>.
Why use the sha256 hash? Tags are not immutable and can be overwritten by a developer at any time. In this case
you don&rsquo;t have complete control over your image - which is bad.</p><h2 id=different-images-per-environment>Different images per environment</h2><p>Don&rsquo;t create different images for development, testing, staging
and production environments. The image should be the <strong>source of truth</strong> and should only be created once
and pushed to the repository. This image:tag should be used for different environments in the future.</p><h2 id=depend-on-start-order-of-pods>Depend on start order of pods</h2><p>Applications often depend on containers being started in a certain order.
For example, a database container must be up and running before an application can connect to it. The application
should be resilient to such changes, as the db pod can be unreachable or restarted at any time. The
application container should be able to handle such situations without terminating or crashing.</p><h2 id=additional-anti-patterns-and-patterns>Additional anti-patterns and patterns&mldr;</h2><p>In the community vast experience have been collected to improve stability and usability of Docker and Kubernetes.
Refer to the following link for more information</p><ul><li><a href=https://github.com/gravitational/workshop/blob/master/k8sprod.md>Kubernetes Production Patterns</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ffdcb3c3c73c058191fdf52cbca5e94c>2.5.11 - Namespace Isolation</h1><p>&mldr;or <strong>DENY all traffic from other namespaces</strong></p><p>You can configure a <strong>NetworkPolicy</strong> to deny all the traffic from other namespaces while allowing all the traffic
coming from the same namespace the pod was deployed into.</p><img src=/__resources/howto-namespaceisolation_00dff7.png width=100%><p><strong>There are many reasons why you may chose to employ Kubernetes network policies:</strong></p><ul><li>Isolate multi-tenant deployments</li><li>Regulatory compliance</li><li>Ensure containers assigned to different environments (e.g. dev/staging/prod) cannot interfere with each other</li></ul><p>Kubernetes <strong>network policies</strong> are application centric compared to infrastructure/network centric standard firewalls.
<strong>There are no explicit CIDRs or IP addresses used</strong> for matching source or destination IP’s. <strong>Network policies build up on labels
and selectors</strong> which are key concepts of Kubernetes that are used to organize (for e.g all DB tier pods of an app) and
select subsets of objects.</p><h2 id=example>Example</h2><p>We create two nginx HTTP-Servers in two namespaces and block all traffic between the two namespaces. E.g. you are
unable to get content from <em>namespace1</em> if you are sitting in <em>namespace2</em>.</p><h2 id=setup-the-namespaces>Setup the namespaces</h2><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># create two namespaces for test purpose</span>
kubectl create ns customer1
kubectl create ns customer2

<span class=c1># create a standard HTTP web server</span>
kubectl run nginx --image<span class=o>=</span>nginx --replicas<span class=o>=</span><span class=m>1</span> --port<span class=o>=</span><span class=m>80</span> -n<span class=o>=</span>customer1
kubectl run nginx --image<span class=o>=</span>nginx --replicas<span class=o>=</span><span class=m>1</span> --port<span class=o>=</span><span class=m>80</span> -n<span class=o>=</span>customer2

<span class=c1># expose the port 80 for external access</span>
kubectl expose deployment nginx --port<span class=o>=</span><span class=m>80</span> --type<span class=o>=</span>NodePort -n<span class=o>=</span>customer1
kubectl expose deployment nginx --port<span class=o>=</span><span class=m>80</span> --type<span class=o>=</span>NodePort -n<span class=o>=</span>customer2

</code></pre></div><hr><h2 id=test-without-np>Test without NP</h2><img src=/__resources/howto-namespaceisolation-without_8a0a23.png width=80%><p>Create a pod with <em>curl</em> preinstalled inside the namespace <em>customer1</em></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># create a &#34;bash&#34; pod in one namespace</span>
kubectl run -i --tty client --image<span class=o>=</span>tutum/curl -n<span class=o>=</span>customer1
</code></pre></div><p>try to <em>curl</em> the exposed nginx server to get the default index.html page. <strong>Execute this in the bash prompt of the
pod created above.</strong></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># get the index.html from the nginx of the namespace &#34;customer1&#34; =&gt; success</span>
curl http://nginx.customer1
<span class=c1># get the index.html from the nginx of the namespace &#34;customer2&#34; =&gt; success</span>
curl http://nginx.customer2
</code></pre></div><p>Both calls are done in a pod within namespace customer1 and both nginx servers are always reachable, no matter in what namespace.</p><hr><h2 id=test-with-np>Test with NP</h2><img src=/__resources/howto-namespaceisolation-with_3a6dd1.png width=80%><p>Install the <strong>NetworkPolicy</strong> from your shell</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>NetworkPolicy</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>deny-from-other-namespaces</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>podSelector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>from</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>podSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></code></pre></div><ul><li>it applies the policy to ALL pods in the named namespace as the <code>spec.podSelector.matchLabels</code> is empty and therefore selects all pods.</li><li>it allows traffic from ALL pods in the named namespace, as <code>spec.ingress.from.podSelector</code> is empty and therefore selects all pods.</li></ul><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl apply -f ./network-policy.yaml -n=customer1
kubectl apply -f ./network-policy.yaml -n=customer2
</code></pre></div><p>after this <code>curl http://nginx.customer2</code> shouldn&rsquo;t work anymore if you are a service inside the namespace <em>customer1</em> and
vice versa</p><p><em>Note</em>: This policy, once applied, will also disable all external traffic to these pods. For example you can create a service of type <code>LoadBalancer</code> in namespace <code>customer1</code> that match the nginx pod. When you request the service by its <code>&lt;EXTERNAL_IP>:&lt;PORT></code>, then the network policy will deny the ingress traffic from the service and the request will time out.</p><h2 id=more>More</h2><p>You can get more information how to configure the <strong>NetworkPolicies</strong> on:</p><ul><li><a href=https://docs.projectcalico.org/v3.0/getting-started/kubernetes/tutorials/advanced-policy>Calico WebSite</a></li><li><a href=https://github.com/ahmetb/kubernetes-network-policy-recipes>Kubernetes NP Recipes</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-90f02665c7456e1a24afc104f91bea70>2.5.12 - Orchestration of container startup</h1><div class=lead>How to orchestrate startup sequence of multiple containers</div><h2 id=disclaimer>Disclaimer</h2><p>If an application depends on other services deployed separately do not rely on a certain start sequence of containers
but ensure that the application can cope with unavailability of the services it depends on.</p><h2 id=introduction>Introduction</h2><p>Kubernetes offers a feature called <a href=https://kubernetes.io/docs/concepts/workloads/pods/init-containers/>InitContainers</a> to perform some tasks during a pod&rsquo;s initialization.
In this tutorial we demonstrate how to use it orchestrate starting sequence of multiple containers. The tutorial uses the example app <a href=https://medium.com/@xcoulon/deploying-your-first-web-app-on-minikube-6e98d2884b3a>url-shortener</a> which consists of two components:</p><ul><li>postgresql database</li><li>webapp which depends on postgresql database and provides two endpoints: create a short url from a given location, and redirect from a given short URL to the corresponding target location.</li></ul><p>This app represents the minimal example where an application relies on another service or database. In this example, if the application starts before database is ready, the application will fail as shown below:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl logs webapp-958cf5567-h247n
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2018-06-12T11:02:42Z&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Connecting to Postgres database using: host=`postgres:5432` dbname=`url_shortener_db` username=`user`\n&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2018-06-12T11:02:42Z&#34;</span> <span class=nv>level</span><span class=o>=</span>fatal <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;failed to start: failed to open connection to database: dial tcp: lookup postgres on 100.64.0.10:53: no such host\n&#34;</span>


$ kubectl get po -w
NAME                                READY     STATUS    RESTARTS   AGE
webapp-958cf5567-h247n   0/1       Pending   <span class=m>0</span>         0s
webapp-958cf5567-h247n   0/1       Pending   <span class=m>0</span>         0s
webapp-958cf5567-h247n   0/1       ContainerCreating   <span class=m>0</span>         0s
webapp-958cf5567-h247n   0/1       ContainerCreating   <span class=m>0</span>         1s
webapp-958cf5567-h247n   0/1       Error     <span class=m>0</span>         2s
webapp-958cf5567-h247n   0/1       Error     <span class=m>1</span>         3s
webapp-958cf5567-h247n   0/1       CrashLoopBackOff   <span class=m>1</span>         4s
webapp-958cf5567-h247n   0/1       Error     <span class=m>2</span>         18s
webapp-958cf5567-h247n   0/1       CrashLoopBackOff   <span class=m>2</span>         29s
webapp-958cf5567-h247n   0/1       Error     <span class=m>3</span>         43s
webapp-958cf5567-h247n   0/1       CrashLoopBackOff   <span class=m>3</span>         56s

</code></pre></div><p>If the <code>restartPolicy</code> is set to <code>Always</code> (default) in yaml, the application will continue to restart the pod with an exponential back-off delay in case of failure.</p><h2 id=using-initcontaniner>Using InitContaniner</h2><p>To avoid such situation, <code>InitContainers</code> can be defined which are executed prior to the application container. If one InitContainers fails, the application container won&rsquo;t be triggered.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>webapp</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>webapp</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>webapp</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>  </span><span class=c># check if DB is ready, and only continue when true</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>check-db-ready</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>postgres:9.6.5</span><span class=w>
</span><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;sh&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;-c&#39;</span><span class=p>,</span><span class=w>  </span><span class=s1>&#39;until pg_isready -h postgres -p 5432;  do echo waiting for database; sleep 2; done;&#39;</span><span class=p>]</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>xcoulon/go-url-shortener:0.1.0</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>go-url-shortener</span><span class=w>
</span><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>POSTGRES_HOST</span><span class=w>
</span><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>postgres</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>POSTGRES_PORT</span><span class=w>
</span><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;5432&#34;</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>POSTGRES_DATABASE</span><span class=w>
</span><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>url_shortener_db</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>POSTGRES_USER</span><span class=w>
</span><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>user</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>POSTGRES_PASSWORD</span><span class=w>
</span><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>mysecretpassword</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></code></pre></div><p>In above example, the <code>InitContainers</code> uses docker image <code>postgres:9.6.5</code> which is different from the application container.
This also brings the advantage of not having to include unnecessary tools (e.g. pg_isready) in the application container.</p><p>With introduction of <code>InitContainers</code>, the pod startup will look like following in case database is not available yet:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl get po -w
NAME                                READY     STATUS    RESTARTS   AGE
nginx-deployment-5cc79d6bfd-t9n8h   1/1       Running   <span class=m>0</span>          5d
privileged-pod                      1/1       Running   <span class=m>0</span>          4d
webapp-fdcb49cbc-4gs4n   0/1       Pending   <span class=m>0</span>         0s
webapp-fdcb49cbc-4gs4n   0/1       Pending   <span class=m>0</span>         0s
webapp-fdcb49cbc-4gs4n   0/1       Init:0/1   <span class=m>0</span>         0s
webapp-fdcb49cbc-4gs4n   0/1       Init:0/1   <span class=m>0</span>         1s


$ kubectl  logs webapp-fdcb49cbc-4gs4n
Error from server <span class=o>(</span>BadRequest<span class=o>)</span>: container <span class=s2>&#34;go-url-shortener&#34;</span> in pod <span class=s2>&#34;webapp-fdcb49cbc-4gs4n&#34;</span> is waiting to start: PodInitializing
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-02cf553d7991e467aa6ce1be8575e57c>2.5.13 - Out-Dated HTML and JS files delivered</h1><div class=lead>Why is my application always outdated?</div><h2 id=problem>Problem</h2><p><strong>After updating your HTML and JavaScript sources in your web application,
the kubernetes cluster delivers outdated versions - why?</strong></p><h2 id=preamble>Preamble</h2><p>By default, Kubernetes service pods are not accessible from the external
network, but only from other pods within the same Kubernetes cluster.</p><p>The Gardener cluster has a built-in configuration for HTTP load balancing called <strong>Ingress</strong>,
defining rules for external connectivity to Kubernetes services. Users who want external access
to their Kubernetes services create an ingress resource that defines rules,
including the URI path, backing service name, and other information. The Ingress controller
can then automatically program a frontend load balancer to enable Ingress configuration.</p><p><img src=/__resources/howto-nginx_f7c046.svg alt=nginx></p><h2 id=example-ingress-configuration>Example Ingress Configuration</h2><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>vuejs-ingress</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>test.ingress.&lt;GARDENER-CLUSTER&gt;.&lt;GARDENER-PROJECT&gt;.shoot.canary.k8s-hana.ondemand.com</span><span class=w>
</span><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>vuejs-svc</span><span class=w>
</span><span class=w>          </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></code></pre></div><p>where:</p><ul><li><strong>&lt;GARDENER-CLUSTER></strong>: The cluster name in the Gardener</li><li><strong>&lt;GARDENER-PROJECT></strong>: You project name in the Gardener</li></ul><h2 id=what-is-the-underlying-problem>What is the underlying problem?</h2><p>The ingress controller we are using is <strong>NGINX</strong>.</p><blockquote><p>NGINX is a software load balancer, web server, and <strong>content cache</strong> built on top of open
source NGINX.</p></blockquote><p><strong>NGINX caches the content as specified in the HTTP header.</strong> If the HTTP header is missing,
it is assumed that the cache is <strong>forever</strong> and NGINX never updates the content in the
stupidest case.</p><h2 id=solution>Solution</h2><p>In general you can avoid this pitfall with one of the solutions below:</p><ul><li>use a cache buster + HTTP-Cache-Control(prefered)</li><li>use HTTP-Cache-Control with a lower retention period</li><li>disable the caching in the ingress (just for dev purpose)</li></ul><p>Learning how to set the HTTP header or setup a cache buster is left to the read as an exercise
for your web framework (e.g. Express/NodeJS, SpringBoot,&mldr;)</p><p>Here an example how to disable the cache control for your ingress done with an annotation in your
ingress YAML (during development).</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>ingress.kubernetes.io/cache-enable</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>vuejs-ingress</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>test.ingress.&lt;GARDENER-CLUSTER&gt;.&lt;GARDENER-PROJECT&gt;.shoot.canary.k8s-hana.ondemand.com</span><span class=w>
</span><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>vuejs-svc</span><span class=w>
</span><span class=w>          </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-424dc73fc8ed567a9cf1396d57f3cb2c>2.5.14 - Storing secrets in git 💀</h1><div class=lead>Never ever commit a kubeconfig.yaml into github</div><h2 id=problem>Problem</h2><p>If you commit sensitive data, such as a <code>kubeconfig.yaml</code> or <code>SSH key</code> into a Git repository, you can remove it from
the history. To entirely remove unwanted files from a repository&rsquo;s history you can use the git <code>filter-branch</code> command.</p><p>The git filter-branch command rewrite your repository&rsquo;s history, which changes the SHAs for
existing commits that you alter and any dependent commits. Changed commit SHAs may affect open pull requests
in your repository. <strong>I recommend merging or closing all open pull requests before removing files from your repository.</strong></p><blockquote><p><strong>Warning:</strong> - if someone has already checked out the repository, then of course he has the secret on his computer. So ALWAYS revoke the OAuthToken/Password or whatever it was imediately.</p></blockquote><h2 id=purging-a-file-from-your-repositorys-history>Purging a file from your repository&rsquo;s history</h2><blockquote><p><strong>Warning:</strong> If you run <code>git filter-branch</code> after stashing changes, you won&rsquo;t be able to retrieve your changes with other
stash commands. Before running git filter-branch, we recommend unstashing any changes you&rsquo;ve made. To unstash the
last set of changes you&rsquo;ve stashed, run <code>git stash show -p | git apply -R</code>. For more information, see Git Tools Stashing.</p></blockquote><p>To illustrate how <code>git filter-branch</code> works, we&rsquo;ll show you how to remove your file with sensitive data from the
history of your repository and add it to .gitignore to ensure that it is not accidentally re-committed.</p><p><strong>Navigate into the repository&rsquo;s working directory.</strong></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> YOUR-REPOSITORY
</code></pre></div><p><strong>Run the following command, replacing <code>PATH-TO-YOUR-FILE-WITH-SENSITIVE-DATA</code> with the path to the file you want to remove,
not just its filename.</strong></p><p>These arguments will:</p><ul><li>Force Git to process, but not check out, the entire history of every branch and tag</li><li>Remove the specified file, as well as any empty commits generated as a result</li><li>Overwrite your existing tags</li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>git filter-branch --force --index-filter <span class=se>\
</span><span class=se></span><span class=s1>&#39;git rm --cached --ignore-unmatch PATH-TO-YOUR-FILE-WITH-SENSITIVE-DATA&#39;</span> <span class=se>\
</span><span class=se></span>--prune-empty --tag-name-filter cat -- --all

</code></pre></div><p><strong>Add your file with sensitive data to <code>.gitignore</code> to ensure that you don&rsquo;t accidentally commit it again.</strong></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash> <span class=nb>echo</span> <span class=s2>&#34;YOUR-FILE-WITH-SENSITIVE-DATA&#34;</span> &gt;&gt; .gitignore
</code></pre></div><p><strong>Double-check that you&rsquo;ve removed everything you wanted to from your repository&rsquo;s history, and that all of your
branches are checked out.</strong></p><p><strong>Once you&rsquo;re happy with the state of your repository, force-push your local changes to overwrite your GitHub repository,
as well as all the branches you&rsquo;ve pushed up:</strong></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>git push origin --force --all
</code></pre></div><p><strong>In order to remove the sensitive file from your tagged releases, you&rsquo;ll also need to force-push against your Git tags:</strong></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>git push origin --force --tags
</code></pre></div><blockquote><p><strong>Warning:</strong> Tell your collaborators to <strong>rebase, not merge</strong>, any branches they created off of your old (tainted) repository history.
One merge commit could reintroduce some or all of the tainted history that you just went to the trouble of purging.</p></blockquote><p>References:</p><ul><li><a href=https://help.github.com/articles/removing-sensitive-data-from-a-repository/>https://help.github.com/articles/removing-sensitive-data-from-a-repository/</a></li></ul><style>blockquote{border:1px solid red;padding:10px;margin-top:40px;margin-bottom:40px}blockquote p{font-size:1.5rem;color:#000}</style></div><div class=td-content style=page-break-before:always><h1 id=pg-77bb872706e47f8307662d7339184bb5>2.5.15 - Using Prometheus and Grafana to monitor K8s</h1><div class=lead>How to deploy and configure Prometheus and Grafana to collect and monitor kubelet container metrics</div><h2 id=disclaimer>Disclaimer</h2><p>This post is meant to give a basic end-to-end description for deploying and using Prometheus and Grafana. Both
applications offer a wide range of flexibility which needs to be considered in case you have specific requirenments.
Such advanced details are not in the scope of this post.</p><h2 id=introduction>Introduction</h2><p><a href=https://prometheus.io/>Prometheus</a> is an open-source systems monitoring and alerting toolkit for recording numeric
time series. It fits both machine-centric monitoring as well as monitoring of highly dynamic service-oriented
architectures. In a world of microservices, its support for multi-dimensional data collection and querying is a
particular strength.</p><p>Prometheus graduates within CNCF <a href=https://prometheus.io/blog/2018/08/09/prometheus-graduates-within-cncf/>second hosted project</a>.</p><p>The following characteristics make Prometheus a good match for monitoring Kubernetes clusters:</p><ul><li><p>Pull-based monitoring<br>Prometheus is a <a href=https://prometheus.io/blog/2016/07/23/pull-does-not-scale-or-does-it/>pull-based</a> monitoring system,
which means that the Prometheus server dynamically discovers and pulls metrics from your services running in
Kubernetes.</p></li><li><p>Labels
Prometheus and Kubernetes share the same label (key-value) concept that can be used to select objects in the system.<br>Labels are used to identify time series and sets of label matchers can be used in the query language
( <a href=https://prometheus.io/docs/prometheus/latest/querying/basics/>PromQL</a> ) to select the time series to be aggregated..</p></li><li><p>Exporters<br>There are many <a href=https://prometheus.io/docs/instrumenting/exporters/>exporters</a> available which enable integration of
databases or even other monitoring systems not already providing a way to export metrics to Prometheus.
One prominent exporter is the so called <a href=https://github.com/prometheus/node_exporter>node-exporter</a>, which allows to
monitor hardware and OS related metrics of Unix systems.</p></li><li><p>Powerful query language<br>The Prometheus query language <a href=https://prometheus.io/docs/prometheus/latest/querying/basics/>PromQL</a> lets the user
select and aggregate time series data in real time. Results can either be shown as a graph, viewed
as tabular data in the Prometheus expression browser, or consumed by external systems via the <a href=https://prometheus.io/docs/prometheus/latest/querying/api/>HTTP API</a>.</p></li></ul><p>Find query examples on <a href=https://github.com/infinityworks/prometheus-example-queries/blob/master/README.md>Prometheus Query Examples</a>.</p><p>One very popular open-source visualization tool not only for Prometheus is <a href=https://grafana.com>Grafana</a>. Grafana is a
metric analytics and visualization suite. It is popular for for visualizing time series data for infrastructure
and application analytics but many use it in other domains including industrial sensors, home automation, weather, and
process control [see <a href=http://docs.grafana.org/>Grafana Documentation</a>].</p><p>Grafana accesses data via <a href=http://docs.grafana.org/guides/basic_concepts/>Data Sources</a>. The continuously growing
list of supported backends includes Prometheus.</p><p>Dashboards are created by combining panels, e.g. <a href=http://docs.grafana.org/reference/graph/>Graph</a> and <a href=http://docs.grafana.org/reference/dashlist/>Dashlist</a>.</p><p>In this example we describe an End-To-End scenario including the deployment of Prometheus and a basic monitoring
configuration as the one provided for Kubernetes clusters created by Gardener.</p><p>If you miss elements on the Prometheus web page when accessing it via its service URL <code>https://&lt;your K8s FQN>/api/v1/namespaces/&lt;your-prometheus-namespace>/services/prometheus-prometheus-server:80/proxy</code>
this is probably caused by Prometheus issue <a href=https://github.com/prometheus/prometheus/issues/1583>#1583</a>
To workaround this issue setup a port forward <code>kubectl port-forward -n &lt;your-prometheus-namespace> &lt;prometheus-pod> 9090:9090</code>
on your client and access the Prometheus UI from there with your locally installed web browser. This issue is not relevant
in case you use the service type <code>LoadBalancer</code>.</p><h2 id=preparation>Preparation</h2><p>The deployment of <a href=https://github.com/kubernetes/charts/tree/master/stable/prometheus>Prometheus</a> and <a href=https://github.com/kubernetes/charts/tree/master/stable/grafana>Grafana</a> is based on Helm charts.<br>Make sure to implement the <a href=/docs/guides/client_tools/helm>Helm settings</a> before deploying the Helm charts.</p><p>The Kubernetes clusters provided by <a href=https://github.com/gardener>Gardener</a> use role based
access control (<a href=https://kubernetes.io/docs/admin/authorization/rbac/>RBAC</a>). To authorize the Prometheus
node-exporter to access hardware and OS relevant metrics of your cluster&rsquo;s worker nodes specific artifacts need to be
deployed.</p><p>Bind the prometheus service account to the <code>garden.sapcloud.io:monitoring:prometheus</code> cluster role by running the command
<code>kubectl apply -f crbinding.yaml</code>.</p><p>Content of <code>crbinding.yaml</code></p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;your-prometheus-name&gt;-server</span><span class=w>
</span><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>garden.sapcloud.io:monitoring:prometheus</span><span class=w>
</span><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;your-prometheus-name&gt;-server</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>&lt;your-prometheus-namespace&gt;</span><span class=w>
</span></code></pre></div><h2 id=deployment-of-prometheus-and-grafana>Deployment of Prometheus and Grafana</h2><p>Only minor changes are needed to deploy <a href=https://github.com/kubernetes/charts/tree/master/stable/prometheus>Prometheus</a>
and <a href=https://github.com/kubernetes/charts/tree/master/stable/grafana>Grafana</a> based on Helm charts.</p><p>Copy the following configuration into a file called values.yaml and deploy Prometheus: <code>helm install &lt;your-prometheus-name> --namespace &lt;your-prometheus-namespace> stable/prometheus -f values.yaml</code></p><p>Typically, Prometheus and Grafana are deployed into the same namespace. There is no technical reason behind this so feel
free to choose different namespaces.</p><p>Content of <code>values.yaml</code> for Prometheus:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>rbac</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>create</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># Already created in Preparation step</span><span class=w>
</span><span class=w></span><span class=nt>nodeExporter</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># The node-exporter is already deployed by default</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>server</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>global</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span><span class=w>    </span><span class=nt>scrape_timeout</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>serverFiles</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>prometheus.yml</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>rule_files</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>/etc/config/rules</span><span class=w>
</span><span class=w>      </span>- <span class=l>/etc/config/alerts      </span><span class=w>
</span><span class=w>    </span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kube-kubelet&#39;</span><span class=w>
</span><span class=w>      </span><span class=nt>honor_labels</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>      </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>https</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>tls_config</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=c># This is needed because the kubelets&#39; certificates are not generated</span><span class=w>
</span><span class=w>      </span><span class=c># for a specific pod IP</span><span class=w>
</span><span class=w>        </span><span class=nt>insecure_skip_verify</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>bearer_token_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>node</span><span class=w>
</span><span class=w>      </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span><span class=w>        </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>/metrics</span><span class=w>
</span><span class=w>      </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_node_address_InternalIP]</span><span class=w>
</span><span class=w>        </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>instance</span><span class=w>
</span><span class=w>      </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span><span class=w>        </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_node_label_(.+)</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kube-kubelet-cadvisor&#39;</span><span class=w>
</span><span class=w>      </span><span class=nt>honor_labels</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>      </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>https</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>tls_config</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=c># This is needed because the kubelets&#39; certificates are not generated</span><span class=w>
</span><span class=w>      </span><span class=c># for a specific pod IP</span><span class=w>
</span><span class=w>        </span><span class=nt>insecure_skip_verify</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>bearer_token_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>node</span><span class=w>
</span><span class=w>      </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span><span class=w>        </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>/metrics/cadvisor</span><span class=w>
</span><span class=w>      </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_node_address_InternalIP]</span><span class=w>
</span><span class=w>        </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>instance</span><span class=w>
</span><span class=w>      </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span><span class=w>        </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_node_label_(.+)</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=c># Example scrape config for probing services via the Blackbox Exporter.</span><span class=w>
</span><span class=w>    </span><span class=c>#</span><span class=w>
</span><span class=w>    </span><span class=c># Relabelling allows to configure the actual service scrape endpoint using the following annotations:</span><span class=w>
</span><span class=w>    </span><span class=c>#</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/probe`: Only probe services that have a value of `true`</span><span class=w>
</span><span class=w>    </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubernetes-services&#39;</span><span class=w>
</span><span class=w>      </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=l>/probe</span><span class=w>
</span><span class=w>      </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>module</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>http_2xx]</span><span class=w>
</span><span class=w>      </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>service</span><span class=w>
</span><span class=w>      </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_prometheus_io_probe]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__address__]</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__param_target</span><span class=w>
</span><span class=w>        </span>- <span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span><span class=w>          </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>blackbox</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__param_target]</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>instance</span><span class=w>
</span><span class=w>        </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_service_label_(.+)</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_namespace]</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_namespace</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_name]</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_name</span><span class=w>
</span><span class=w>    </span><span class=c># Example scrape config for pods</span><span class=w>
</span><span class=w>    </span><span class=c>#</span><span class=w>
</span><span class=w>    </span><span class=c># Relabelling allows to configure the actual service scrape endpoint using the following annotations:</span><span class=w>
</span><span class=w>    </span><span class=c>#</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/scrape`: Only scrape pods that have a value of `true`</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/path`: If the metrics path is not `/metrics` override this.</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/port`: Scrape the pod on the indicated port instead of the default of `9102`.</span><span class=w>
</span><span class=w>    </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubernetes-pods&#39;</span><span class=w>
</span><span class=w>      </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>pod</span><span class=w>
</span><span class=w>      </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_pod_annotation_prometheus_io_path]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+):(?:\d+);(\d+)</span><span class=w>
</span><span class=w>          </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>${1}:${2}</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span><span class=w>        </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_pod_label_(.+)</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_namespace]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_namespace</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_pod_name]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_pod_name</span><span class=w>
</span><span class=w>    </span><span class=c># Scrape config for service endpoints.</span><span class=w>
</span><span class=w>    </span><span class=c>#</span><span class=w>
</span><span class=w>    </span><span class=c># The relabeling allows the actual service scrape endpoint to be configured</span><span class=w>
</span><span class=w>    </span><span class=c># via the following annotations:</span><span class=w>
</span><span class=w>    </span><span class=c>#</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/scrape`: Only scrape services that have a value of `true`</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/scheme`: If the metrics endpoint is secured then you will need</span><span class=w>
</span><span class=w>    </span><span class=c># to set this to `https` &amp; most likely set the `tls_config` of the scrape config.</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/path`: If the metrics path is not `/metrics` override this.</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/port`: If the metrics are exposed on a different port to the</span><span class=w>
</span><span class=w>    </span><span class=c># service then set this appropriately.</span><span class=w>
</span><span class=w>    </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubernetes-service-endpoints&#39;</span><span class=w>
</span><span class=w>      </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>endpoints</span><span class=w>
</span><span class=w>      </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_prometheus_io_scrape]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__scheme__</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(https?)</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_prometheus_io_path]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)(?::\d+);(\d+)</span><span class=w>
</span><span class=w>          </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>$1:$2</span><span class=w>
</span><span class=w>        </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_service_label_(.+)</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_namespace]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_namespace</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_name]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_name</span><span class=w> </span><span class=c># Add your additional configuration here...</span><span class=w>
</span></code></pre></div><p>Next, deploy Grafana. Since the deployment in this post is based on the Helm default values, the settings below are set
explicitly in case the default changed.
Deploy Grafana via <code>helm install grafana --namespace &lt;your-prometheus-namespace> stable/grafana -f values.yaml</code>. Here, the same namespace is chosen for Prometheus and for Grafana.</p><p>Content of <code>values.yaml</code> for Grafana:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>server</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>  </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></code></pre></div><p>Check the running state of the pods on the Kubernetes Dashboard or by running <code>kubectl get pods -n &lt;your-prometheus-namespace></code>.
In case of errors check the log files of the pod(s) in question.</p><p>The text output of Helm after the deployment of Prometheus and Grafana contains very useful information, e.g. the user
and password of the Grafana Admin user. The credentials are stored as secrets in the namespace <code>&lt;your-prometheus-namespace></code>
and could be decoded via <code>kubectl get secret --namespace &lt;my-grafana-namespace> grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo</code>.</p><h2 id=basic-functional-tests>Basic functional tests</h2><p>To access the web UI of both applications use port forwarding of port 9090.</p><p>Setup port forwarding for port 9090:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl port-forward -n &lt;your-prometheus-namespace&gt; &lt;your-prometheus-server-pod&gt; 9090:9090
</code></pre></div><p>Open <code>http://localhost:9090</code> in your web browser. Select Graph from the top tab and enter the following expressing to show the overall CPU usage for a server
(see <a href=https://github.com/infinityworks/prometheus-example-queries/blob/master/README.md>Prometheus Query Examples</a>)</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>100 * (1 - avg by(instance)(irate(node_cpu{mode=&#39;idle&#39;}[5m])))
</code></pre></div><p>This should show some data in a graph.</p><p>To show the same data in Grafana setup port forwarding for port 3000 for the
Grafana pod and open the Grafana Web UI by opening http://localhost:3000 in a browser.
Enter the credentials of the admin user.</p><p>Next, you need to enter the server name of your Prometheus deployment. This name is shown directly after the
installation via helm.</p><p>Run</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>helm status &lt;your-prometheus-name&gt;
</code></pre></div><p>to find this name. Below this server name is referenced by <code>&lt;your-prometheus-server-name></code>.</p><p>First, you need to add your Prometheus server as data source.</p><ul><li>select <em>Dashboards → Data Sources</em></li><li>select <em>Add data source</em></li><li>enter
<em>Name</em>: <code>&lt;your-prometheus-datasource-name></code><br><em>Type</em>: Prometheus<br><em>URL</em>: <code>http://&lt;your-prometheus-server-name></code><br>_Access: <code>proxy</code></li><li>select <em>Save & Test</em></li></ul><p>In case of failure check the Prometheus URL in the Kubernetes Dashboard.</p><p>To add a Graph follow these steps:</p><ul><li>in the left corner, select <em>Dashboards → New</em> to create a new dashboard</li><li>select <em>Graph</em> to create a new graph</li><li>next, select the <em>Panel Title → Edit</em></li><li>select your Prometheus Data Source in the drop down list</li><li>enter the expression <code>100 * (1 - avg by(instance)(irate(node_cpu{mode='idle'}[5m])))</code> in the entry field A</li><li>select the floppy disk symbol (Save) on top</li></ul><p>Now you should have a very basic Prometheus and Grafana setup for your Kubernetes cluster.</p><p>As a next step you can implement monitoring for your applications by implementing the <a href=https://prometheus.io/docs/instrumenting/clientlibs/>Prometheus client API</a>.</p><h2 id=links>Links</h2><ul><li><a href=https://prometheus.io/>Prometheus</a></li><li><a href=https://github.com/kubernetes/charts/tree/master/stable/prometheus>Prometheus Helm Chart</a></li><li><a href=https://www.weave.works/blog/prometheus-kubernetes-perfect-match/>Prometheus and Kubernetes: A Perfect Match</a></li><li><a href=https://grafana.com>Grafana</a></li><li><a href=https://github.com/kubernetes/charts/tree/master/stable/grafana>Grafana Helm Chart</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-9fd36c058dee824f8b5ff5b67dfb92f5>2.6 - Gardener Cookies</h1><h1 id=green-tea-matcha-cookies>Green Tea Matcha Cookies</h1><p>For a team event during the Christmas season we decided to completely reinterpret the topic <code>cookies</code>. :-)</p><img style=width:50%;height:auto;margin:0,auto src=/__resources/cookie-00_bfd721.jpg><p>Matcha cookies have the delicate flavor and color of green tea. These soft, pillowy and chewy green tea cookies
are perfect with tea. And of course they fit perfectly to our logo</p><h2 id=ingredients>Ingredients</h2><ul><li>1 stick butter, softened</li><li>⅞ cup of granulated sugar</li><li>1 cup + 2 tablespoons all-purpose flour</li><li>2 eggs</li><li>1¼ tablespoons culinary grade matcha powder</li><li>1 teaspoon baking powder</li><li>Pinch of salt</li></ul><h2 id=instructions>Instructions</h2><ol><li>Cream together the butter and sugar in a large mixing bowl - it should be creamy colored and airy. A hand blender or stand mixer works well for this. This helps the cookie become fluffy and chewy.</li><li>Gently incorporate the eggs to the butter mixture one at a time.</li><li>In a separate bowl, sift together all the dry ingredients.</li><li>Add the dry ingredients to the wet by adding a little at a time and folding or gently mixing the batter together. Keep going until you&rsquo;ve incorporated all the remaining flour mixture. The dough should be a beautiful green color.</li><li>Chill the dough for at least an hour - up to overnight. The longer the better!</li><li>Preheat your oven to 325 F.</li><li>Roll the dough into balls the size of ping pong balls and place them on a non-stick cookie sheet.</li><li>Bake them for 12-15 minutes until the bottoms just start to become golden brown and the cookie no longer looks wet in the middle. Note: you can always bake them at 350 F for a less moist, fluffy cookie. It will bake faster by about 2-4 minutes 350 F so watch them closely.</li><li>Remove and let cool on a rack and enjoy!</li></ol><h2 id=note>Note</h2><p>Make sure you get culinary grade matcha powder. You should be able to find this in Asian or natural grocers</p><img style=width:50%;height:auto src=/__resources/cookie-01_5ce6cc.jpg>
<img style=width:50%;height:auto src=/__resources/cookie-02_2fb6ea.jpg>
<img style=width:50%;height:auto src=/__resources/cookie-03_29d23f.jpg>
<img style=width:50%;height:auto src=/__resources/cookie-05_3785b6.jpg></div><div class=td-content style=page-break-before:always><h1 id=pg-f7745599833058eb85caaa55efe6a4aa>2.7 - Landscape Setup</h1><h1 id=---deprecated--->&mdash;DEPRECATED&mdash;</h1><p><strong>This project is outdated and won&rsquo;t be updated anymore. Please use <a href=https://github.com/gardener/garden-setup>https://github.com/gardener/garden-setup</a> instead!</strong></p><h1 id=gardener-setup-scripts>Gardener Setup Scripts</h1><p>This README is the installation manual for a simple Gardener setup. The installation scripts in this repo are embedded in a configuration template in the <a href=https://github.com/gardener/landscape-setup-template>landscape-setup-template</a> project. You can find further information there.</p><p>We do recommend this simplified setup for demonstration purposes only. For productive workloads we do recommend that all components (Gardener/Seed/Shoot) run in their own IaaS accounts and that network policies are enabled and properly tested on the seed clusters. A documentation on how to do this is currently work in progress.</p><ul><li><a href=#gardener-setup-scripts>Gardener Setup Scripts</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#gardener-installation>Gardener Installation</a><ul><li><a href=#tldr>TL;DR</a><ul><li><a href=#kubectl-aliases>Kubectl Aliases</a></li></ul></li><li><a href=#step-1-clone-the-repositories-and-get-dependencies>Step 1: Clone the Repositories and get Dependencies</a><ul><li><a href=#submodule-management>Submodule Management</a></li></ul></li><li><a href=#step-2-configure-the-landscape>Step 2: Configure the Landscape</a><ul><li><a href=#building-the-landscapeyaml-file>Building the &lsquo;landscape.yaml&rsquo; File</a></li><li><a href=#the-base-cluster>The Base Cluster</a><ul><li><a href=#kubify>Kubify</a></li><li><a href=#shoot-cluster>Shoot Cluster</a></li><li><a href=#using-an-arbitrary-base-cluster>Using an Arbitrary Base Cluster</a></li></ul></li></ul></li><li><a href=#step-3-build-and-run-docker-container>Step 3: Build and Run Docker Container</a></li><li><a href=#step-4-10-deploying-components>Step 4-10: Deploying Components</a><ul><li><a href=#undeploying-components>Undeploying Components</a></li><li><a href=#the-all-component>The &lsquo;all&rsquo; Component</a></li></ul></li><li><a href=#step-4-10-deploying-components-detailed>Step 4-10: Deploying Components (detailed)</a><ul><li><a href=#step-4-kubify--etcd>Step 4: Kubify / etcd</a></li><li><a href=#step-5-generate-certificates>Step 5: Generate Certificates</a></li><li><a href=#step-6-deploy-tiller>Step 6: Deploy tiller</a></li><li><a href=#step-7-deploy-gardener>Step 7: Deploy Gardener</a></li><li><a href=#step-8-register-garden-cluster-as-seed-cluster>Step 8: Register Garden Cluster as Seed Cluster</a><ul><li><a href=#configuring-additional-seeds>Configuring Additional Seeds</a></li><li><a href=#creating-a-shoot>Creating a Shoot</a></li></ul></li><li><a href=#step-9-install-identity-and-dashboard>Step 9: Install Identity and Dashboard</a><ul><li><a href=#create-cname-entry>Create CNAME Entry</a></li></ul></li><li><a href=#step-10-apply-valid-certificates>Step 10: Apply Valid Certificates</a></li><li><a href=#letsencrypt-quota-limits>Letsencrypt Quota Limits</a><ul><li><a href=#accessing-the-dashboard>Accessing the Dashboard</a></li></ul></li></ul></li></ul></li><li><a href=#tearing-down-the-landscape>Tearing Down the Landscape</a></li><li><a href=#cleanup>Cleanup</a></li></ul><h1 id=prerequisites>Prerequisites</h1><p>Before getting started make sure you have the following at hand:</p><ul><li>You need a cloud account with sufficient quota to set up a Kubernetes cluster with a couple of VMs. <strong>The Gardener supports AWS, Azure, GCP, and Openstack, but this simplified setup currently only supports AWS and Openstack.</strong></li><li>A Linux machine (virtual machine is fine) or a Mac with basic tools such as a git client and the Docker runtime installed.</li></ul><h1 id=gardener-installation>Gardener Installation</h1><p>Follow these steps to install Gardener. Do not proceed to the next step in case of errors.</p><h2 id=tldr>TL;DR</h2><p>If you are already familiar with the installation procedure and just want a short summary of the commands you have to use, here it is:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># setup</span>
git clone  --recursive https://github.com/gardener/landscape-setup-template.git landscape
<span class=c1># fill in landscape/landscape_config.yaml now</span>
<span class=nb>cd</span> landscape/setup
./docker_run.sh
deploy all

<span class=c1># -------------------------------------------------------------------</span>

<span class=c1># teardown</span>
undeploy all
./cleanup.sh
</code></pre></div><p>Otherwise, follow the detailed guide below.</p><h3 id=kubectl-aliases>Kubectl Aliases</h3><p>The following aliases can be used within the docker container:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>k =&gt; kubectl
ks =&gt; kubectl -n kube-system
kg =&gt; kubectl -n garden
kn =&gt; kubectl -n
ka =&gt; kubectl get --all-namespaces
</code></pre></div><p>Bash completion works for all of them except for <code>ka</code>.</p><h2 id=step-1-clone-the-repositories-and-get-dependencies>Step 1: Clone the Repositories and get Dependencies</h2><p>Get the <code>landscape-setup-template</code> from GitHub and initialize the submodules:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>git clone  --recursive https://github.com/gardener/landscape-setup-template.git landscape
<span class=nb>cd</span> landscape
</code></pre></div><p>After step 2, this repository will contain all passwords and keys for your landscape. You will be in trouble if you loose them so we recommend that you store this landscape configuration in a private repository. It might be a good idea to change the origin so you do not accidentally publish your secrets to the public template repository.</p><h3 id=submodule-management>Submodule Management</h3><p>This project needs the <a href=https://github.com/gardener/gardener>Gardener</a> and <a href=https://github.com/gardener/dashboard>dashboard</a> as submodules. To avoid conflicts between the checked out versions and the ones specified in the <code>landscape_base.yaml</code> file, automatic version management has been added. As long as the <code>managed</code> field in the chart area of each submodule is set to <code>true</code>, the version specified in the <code>tag</code> field will be checked out before deploying.</p><p>To check vor the correct version, the <code>VERSION</code> file in the submodule&rsquo;s main folder is read and compared to the tag in the config file. If the <code>VERSION</code> file doesn&rsquo;t exist, the component is added as a submodule. If it exists, but the versions differ, the fitting version will be checked out. If it exists and the versions are identical, nothing is done. The automatic version management will fail if a) the component is already added as a submodule, but the <code>VERSION</code> file is missing or b) the landscape folder is not a git repo.</p><p>It is also possible to trigger the version update manually: call the <code>manage_submodule</code> function with <code>gardener</code> or <code>dashboard</code> as an argument, or run the <code>manage_submodules.sh</code> script which will update Gardener and dashboard. Both will only work from inside the docker container / with sourced <code>init.sh</code> file.</p><h2 id=step-2-configure-the-landscape>Step 2: Configure the Landscape</h2><p>There is a <code>landscape_config.yaml</code> file in the landscape project. This is the only file that you need to modify - all other configuration files will be derived from this and the <code>landscape_base.yaml</code> file. The latter one contains the merging instructions as well as technical configurations and it shouldn&rsquo;t be touched unless you know what you are doing.</p><h4 id=building-the-landscapeyaml-file>Building the &lsquo;landscape.yaml&rsquo; File</h4><p>Both config files - <code>landscape_config.yaml</code> and <code>landscape_base.yaml</code> - are merged into one <code>landscape.yaml</code> file which is then used as configuration for the scripts. Sourcing the <code>init.sh</code> file (which happens automatically when entering the docker image) will perform this merge <strong>unless the file already exists.</strong> This means if you change something in one of the original config files after the <code>landscape.yaml</code> file has already been created, you need to manually rebuild it in order for the changes to take effect.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>./build_landscape_yaml.sh
</code></pre></div><p>This script will recreate the <code>landscape.yaml</code> file. It will also source the <code>init.sh</code> file again, as some of the environment variables are extracted from this file.</p><h4 id=the-base-cluster>The Base Cluster</h4><p>Gardener extends the Kubernetes apiserver, so in order to deploy it, you need a Kubernetes cluster first. This setup gives you two options for this:</p><h5 id=kubify>Kubify</h5><p>You can use <a href=https://github.com/gardener/kubify>Kubify</a> to create the initial cluster. Kubify uses Terraform to create the cluster and it is integrated into this project - you don&rsquo;t need to create the cluster yourself, just make sure you fill out all relevant parts of the config file.</p><h5 id=shoot-cluster>Shoot Cluster</h5><p>A shoot cluster is a cluster created by a Gardener instance and it can be used as a base cluster for this project. These flags have to be set for the kube-apiserver (if not set, the Gardener will still work, but the dashboard won&rsquo;t):</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml>--<span class=l>oidc-issuer-url=https://identity.ingress.&lt;your cluster domain&gt;</span><span class=w>
</span><span class=w></span>--<span class=l>oidc-client-id=kube-kubectl</span><span class=w>
</span><span class=w></span>--<span class=l>oidc-username-claim=email</span><span class=w>
</span><span class=w></span>--<span class=l>oidc-groups-claim=groups</span><span class=w>
</span></code></pre></div><p>For a shoot this can be done by setting <code>issuerUrl</code>, <code>clientID</code>, <code>usernameClaim</code>, and <code>groupsClaim</code> in <code>spec.kubernetes.kubeAPIServer.oidcConfig</code> in the shoot manifest.</p><p>Also make sure that the CIDRs of your base cluster and the from your Gardener spawned shoots don&rsquo;t overlap - if you want to be able to create shoots from the Gardener dashboard later, then don&rsquo;t use the default CIDRs for this base cluster.</p><p>Some fields in the <code>landscape_config.yaml</code> are marked with <code># kubify only</code>, they can be ignored when using a shoot as the base cluster. The etcd server address defaults to the address for Kubify and needs to be changed for the shoot setup (see the comments in the config file).</p><p>The <em>kubeconfig</em> for the base cluster is expected to be named <code>kubeconfig</code> and reside in the directory containing this project&rsquo;s directory (next to the <code>landscape_config.yaml</code> file).</p><h5 id=using-an-arbitrary-base-cluster>Using an Arbitrary Base Cluster</h5><p>While this setup has only been tested for clusters created by Kubify or the Gardener (shoot clusters), it is theoretically possible to use the shoot setup method to deploy the Gardener to an arbitrary kubernetes cluster.</p><h2 id=step-3-build-and-run-docker-container>Step 3: Build and Run Docker Container</h2><p>First, <code>cd</code> into the folder containing this project.</p><p>Then run the container:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>./docker_run.sh
</code></pre></div><p>After this,</p><ul><li>you will be connected to the container via an interactive shell</li><li>the landscape folder will be mounted in that container</li><li>your current working directory will be <code>setup</code> folder</li><li><code>setup/init.sh</code> is sourced, meaning<ul><li>the environment variables will be set</li><li>kubectl will be configured to communicate with your cluster</li><li><code>landscape.yaml</code> file will have been created if it didn&rsquo;t exist before</li></ul></li></ul><p>The <code>docker_run.sh</code> script searches for the image locally and pulls it from an image repository, if it isn&rsquo;t found.
If pulling the image doesn&rsquo;t work for whatever reason, you can use the <code>docker_build.sh</code> script to build the image locally.</p><h2 id=step-4-10-deploying-components>Step 4-10: Deploying Components</h2><p>The Gardener deployment is splitted into components. A single component can be easily deployed using</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy &lt;component name&gt;
</code></pre></div><p>Please take care that most of the components depend on each other and therefore have to be deployed in the order given below.</p><p>The <code>deploy</code> command is added to the <code>PATH</code> environment variable and can thus be called from anywhere. Bash auto-completion can be used for the component names.</p><h4 id=undeploying-components>Undeploying Components</h4><p>It is also possible to &ldquo;undeploy&rdquo; a component using</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>undeploy &lt;component name&gt;
</code></pre></div><p>Components need to be undeployed in the inverse order. Do not undeploy components without undeploying their successors in the component order first. Take care to delete all shoots before undeploying the <code>gardener</code> or <code>seed-config</code> components (although both undeploy scripts will check for that and trigger a deletion themselves).</p><h4 id=the-all-component>The &lsquo;all&rsquo; Component</h4><p>The <code>all</code> component is a special component: it serves as a dummy to deploy several components in one go. Usually, manual intervention between deploying components is not necessary and most of them are deployed directly one after the other, so the <code>all</code> component makes the &ldquo;normal&rdquo; use-case easier.</p><p>For better control which components are deployed, a component range can be given as an argument. The argument should have the form <code>&lt;start component name>:&lt;end component name></code> and then the start component, the end component, and all components in between will be deployed. The order of the arguments is taken from the environment variables with the <code>$COMPONENT_ORDER_</code> prefix. The variable with the suffix that matches the <code>clusters.base_cluster</code> entry in the config file will be used.</p><p>It is also possible to drop one part of the range or to drop the whole argument. For missing parts the defaults will be used, which are the first and the last component of the active component order, respectively.</p><p>The <code>undeploy</code> command can also be used with the <code>all</code> component, but take care that the component order is inverted.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># Examples</span>
<span class=c1># (start and end component are always inclusive)</span>
deploy all                          <span class=c1># deploys all components</span>
deploy all gardener:dashboard       <span class=c1># deploys &#39;gardener&#39; through &#39;dashboard&#39; </span>
deploy all gardener:                <span class=c1># deploys all components starting from &#39;gardener&#39;</span>
deploy all :gardener                <span class=c1># deploys all components up to &#39;gardener&#39;</span>

<span class=c1># (all undeploy commands use the inverse component order)</span>
undeploy all                        <span class=c1># undeploys all components</span>
undeploy all :helm-tiller           <span class=c1># undeploys all components up to &#39;helm-tiller&#39;</span>
undeploy all dashboard:cert         <span class=c1># undeploys &#39;dashboard&#39; through &#39;cert&#39;</span>
</code></pre></div><h2 id=step-4-10-deploying-components-detailed>Step 4-10: Deploying Components (detailed)</h2><h3 id=step-4-kubify--etcd>Step 4: Kubify / etcd</h3><p>If you want to create a Kubify cluster, deploy the component:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy kubify
</code></pre></div><p>The script will wait some time for the cluster to come up and then partly validate that the cluster is ready.</p><p>If you get errors during the cluster setup, just try to run the command again.</p><p>Once completed the following command should show all deployed pods:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>root@c41327633d6d:/landscape# kubectl get pods --all-namespaces
NAMESPACE       NAME                                                                  READY     STATUS    RESTARTS   AGE
kube-system     etcd-operator-75dcfcf4f7-xkm4h                                        1/1       Running   0          6m
kube-system     heapster-c8fb4f746-tvts6                                              2/2       Running   0          2m
kube-system     kube-apiserver-hcdnc                                                  1/1       Running   0          6m
[...]
</code></pre></div><hr><p>If you already have a cluster, you don&rsquo;t need Kubify. To deploy an etcd in your cluster, run</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy etcd
</code></pre></div><p>This component is not meant to be used in combination with Kubify and might require manual steps to make it work.</p><p>It should also be possible to plug in your own etcd - check the deploy scripts for the <code>etcd</code> and <code>gardener</code> components for information on where to put the certificates, etc.</p><h3 id=step-5-generate-certificates>Step 5: Generate Certificates</h3><p>This step will generate a self-signed cluster CA and sign some certificates with it.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy cert
</code></pre></div><h3 id=step-6-deploy-tiller>Step 6: Deploy tiller</h3><p>Tiller is needed to deploy the Helm charts of Gardener and other components.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy helm-tiller
</code></pre></div><h3 id=step-7-deploy-gardener>Step 7: Deploy Gardener</h3><p>Now we can deploy Gardener. If the previous steps were executed successfully this should be completed in a couple of seconds.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy gardener
</code></pre></div><p>You might see a couple of messages like these:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>Gardener API server not yet reachable. Waiting...
</code></pre></div><p>while the script waits for the Gardener to start. Once Gardener is up when the deployment script finished you can verify the correct setup by running the following command:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl get shoots
No resources found. 
</code></pre></div><p>As we do not have a seed cluster yet we cannot create any shoot clusters.
The Gardener itself is installed in the <code>garden</code> namespace:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl get po -n garden
NAME                                          READY     STATUS    RESTARTS   AGE
gardener-apiserver-56cc665667-nvrjl           1/1       Running   0          6m
gardener-controller-manager-5c9f8db55-hfcts   1/1       Running   0          6m
</code></pre></div><h3 id=step-8-register-garden-cluster-as-seed-cluster>Step 8: Register Garden Cluster as Seed Cluster</h3><p>In heterogeneous productive environments one would run Gardener and seed in separate clusters but for simplicity and resource consumption reasons we will register the Gardener cluster that we have just created also as the seed cluster. Make sure that the <code>seed_config</code> in the landscape file is correct and matches the region that you are using. Keep in mind that image ids differ between regions as well. Also, valid credentials for the seed provider have to be specified in the <code>authentication</code> part of the <code>landscape_config.yaml</code> file (the etcd backups of the shoot clusters are stored on the seed).</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy seed-config
</code></pre></div><h4 id=configuring-additional-seeds>Configuring Additional Seeds</h4><p>By default, this step will create a seed for the cloud provider the Gardener has been deployed on and thus creating shoots on this provider will be possible. If you want to create shoots on other cloud providers, you will have to configure additional seeds. There are two options for that:</p><p>If the seed-config deploy script is called without any arguments (as shown above), it will create seeds for all providers specified in the <code>seed_config.seeds</code> section in the <code>landscape_config.yaml</code> file. By default, the only entry in that list is the cloud provider chosen for the Gardener cluster, but you can extend the list.</p><p>It is also possible to provide the seed-config deploy script with additional arguments specifying which seeds should be created. Multiple arguments can be given and the script will ignore the list in the <code>landscape_config.yaml</code> file when called with arguments. Only the specified seeds will be created, already existing seeds are not affected. If a given seed already exists, it will be updated to the current configuration.</p><p>In both cases, the corresponding variant nodes in <code>authentication</code> and <code>seed_config</code> have to be filled out in the config file.</p><p>Valid values for seeds are <code>aws</code>, <code>az</code> (for Azure), <code>gcp</code>, and <code>openstack</code>. Please note, that while it is possible to create seeds for any cloud provider on any cloud provider, shoot creation may not work across cloud providers for every combination. It should always work if seed (Gardener cluster in this setup) and shoot are on the same provider, though.</p><h4 id=creating-a-shoot>Creating a Shoot</h4><p>That&rsquo;s it! If everything went fine you should now be able to create shoot clusters.
You can start with a sample <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot-aws.yaml>manifest</a> and create a shoot cluster by standard Kubernetes means:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f shoot-aws.yaml
</code></pre></div><h3 id=step-9-install-identity-and-dashboard>Step 9: Install Identity and Dashboard</h3><p>Creating clusters based on a shoot manifest is quite nice but also a little complex. While almost all aspects of a shoot cluster can be configured, it can be quite difficult for beginners, so go on and install the dashboard:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy identity
<span class=o>[</span>...<span class=o>]</span>
deploy dashboard
<span class=o>[</span>...<span class=o>]</span>
</code></pre></div><h4 id=create-cname-entry>Create CNAME Entry</h4><p>Dashboard and identity need a CNAME entry pointing the domain <code>*.ingress.&lt;your cluster domain></code> to your cluster&rsquo;s nginx ingress ip/hostname. Kubify creates this entry automatically. If you are not using kubify to create your base cluster, you can create the CNAME entry with the corresponding component:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy cname
</code></pre></div><p>The script uses the AWS CLI to create the entry, so it will only work for route53.</p><h3 id=step-10-apply-valid-certificates>Step 10: Apply Valid Certificates</h3><p>The following command will install the <a href=https://github.com/jetstack/cert-manager>cert-manager</a> and request valid letsencrypt certificates for both the identity and dashboard ingresses:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy certmanager
</code></pre></div><p>After a few minutes valid certificates should be installed.</p><h3 id=letsencrypt-quota-limits>Letsencrypt Quota Limits</h3><p>Letsencrypt <a href=https://letsencrypt.org/docs/rate-limits/>limits</a> how many certificates you can get for the same host within a short time. To avoid hitting these limits, you can use the letsencrypt staging server for testing, which has a significantly higher rate limit but produces untrusted certificates.<br>The <code>charts.[certmanager].live</code> field in the config file allows to switch between live and staging server (remember to rebuild the <code>landscape.yaml</code> file after you changed something in the <code>landscape_config.yaml</code> file).</p><h4 id=accessing-the-dashboard>Accessing the Dashboard</h4><p>After step 9 you will be able to access the Gardener dashboard. There is a difference in how you access it depending on whether you used the letsencrypt live server or the staging one (and thus have untrusted credentials in the latter case).</p><p>The <code>print_dashboard_urls.sh</code> script constructs two URLs from the domain name given in the <code>landscape.yaml</code> file and prints them.</p><p>If you have trusted certificates, just use the second one (the one for the dashboard) and everything will be fine.</p><p>If you used the letsencrypt staging server, you will need to visit the first link first. Your browser will show a warning regarding untrusted certificates, you need to ignore that warning. You will then see a nearly blank page with some 404 message. After that, you can open the dashboard link, ignore the certificate warning again and should be able to login.
If you skip the first link, you will still be able to see the dashboard, but the login button probably won&rsquo;t work.
While you will be able to login and create projects with the untrusted certificates from the letsencrypt staging server, creating secrets or shoots won&rsquo;t be possible. You&rsquo;ll need trusted certificates for that.</p><p>To log into the dashboard, use the options you have specified in the identity chart part of the <code>landscape_config.yaml</code>.</p><h1 id=tearing-down-the-landscape>Tearing Down the Landscape</h1><p>Make sure that you delete all shoot clusters prior to tearing down the cluster. Not deleting <code>project</code> resources before deleting the Gardener can also cause troubles, because the namespaces associated with the projects have a finalizer which can&rsquo;t be handled anymore when the Gardener is gone. Both, shoots and projects, can be deleted using the <code>delete_all.sh</code> script (give &lsquo;shoots&rsquo; or &lsquo;projects&rsquo; as an argument). To delete a single shoot/project, use <a href=https://github.com/gardener/gardener/blob/master/hack/delete>this</a> script.</p><p>The following command should not return any shoot clusters:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl get shoots --all-namespaces
No resources found.
</code></pre></div><p>If you created your base cluster with the Kubify component, you can destroy it using the undeploy command:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>undeploy kubify
</code></pre></div><h1 id=cleanup>Cleanup</h1><p>After destroying the Kubify cluster, there will be some files left that prevent you from simply starting the project up again.</p><p><strong>ATTENTION: Only do this if you are sure the cluster has been completely destroyed!</strong>
Since this removes the terraform state, an automated deletion of resources won&rsquo;t be possible anymore - you will have to clean up any leftovers manually.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>./cleanup.sh
</code></pre></div><p>This will reset your landscape folder to its initial state (including the deletion of <code>landscape.yaml</code>).</p><p>The script takes an optional &ldquo;-y&rdquo; argument to skip the confirmation.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-68ec2370d0409cc27325be36693f9368>3 - Tutorials</h1><div class=lead>Walkthroughs of common use case implementations and goals that require a set of tasks to accomplish</div></div><div class=td-content><h1 id=pg-c29db379d9a38d027354d38e2e735f08>3.1 - Authenticating with an Identity Provider</h1><div class=lead>Authenticating with an Identity Provider using OpenID Connect</div><p>Use an identity provider to authenticate users to access shoot clusters.</p><h2 id=prerequisites>Prerequisites</h2><p>Please read the following background material on <a href=https://kubernetes.io/docs/reference/access-authn-authz/authentication/#openid-connect-tokens>Authenticating</a>.</p><h2 id=overview>Overview</h2><p>Kubernetes on its own doesn’t provide any user management. In other words, users aren’t managed through Kubernetes resources. Whenever you refer to a human user it’s sufficient to use a unique ID, for example, an email address. Nevertheless, Gardener project owners can use an identity provider to authenticate user access for shoot clusters in the following way:</p><ol><li><a href=#configure-an-identity-provider>Configure an Identity Provider</a> using <strong>OpenID Connect</strong> (OIDC).</li><li><a href=#configure-a-local-kubectl-oidc-login>Configure a local kubectl oidc-login</a> to enable <code>oidc-login</code>.</li><li><a href=#configure-the-shoot-cluster>Configure the shoot cluster</a> to share details of the OIDC-compliant identity provider with the Kubernetes API Server.</li><li><a href=#authorize-an-authenticated-user>Authorize an authenticated user</a> using role-based access control (RBAC).</li><li><a href=#verify-the-result>Verify the result</a></li></ol><blockquote><p>Gardener allows administrators to modify aspects of the control plane setup. It gives administrators full control of how the control plane is parameterized. While this offers much flexibility, administrators need to ensure that they don’t configure a control plane that goes beyond the service level agreements of the responsible operators team.</p></blockquote><h2 id=configure-an-identity-provider>Configure an Identity Provider</h2><p>Create a tenant in an OIDC compatible Identity Provider. For simplicity, we use <em>Auth0</em>, which has a free plan.</p><ol><li><p>In your tenant, create a client application to use authentication with <code>kubectl</code>:</p><p><img src=/__resources/Create-client-application_9ff006.png alt="Create client application"></p></li><li><p>Provide a <em>Name</em>, choose <em>Native</em> as application type, and choose <em>CREATE</em>.</p><p><img src=/__resources/Choose-application-type_08fa62.png alt="Choose application type"></p></li><li><p>On tab <em>Settings</em>, copy the following parameters to a local text file:</p><ul><li><p><em>Domain</em></p><blockquote><p>Corresponds to the <strong>issuer</strong> in OIDC. It must be an <code>https</code>-secured endpoint (Auth0 requires a trailing <code>/</code> at the end). More information: <a href=https://openid.net/specs/openid-connect-core-1_0.html#Terminology>Issuer Identifier</a>.</p></blockquote></li><li><p><em>Client ID</em></p></li><li><p><em>Client Secret</em></p><p><img src=/__resources/Basic-information_a3f3a1.png alt="Basic information"></p></li></ul></li><li><p>Configure the client to have a callback url of http://localhost:8000. This callback connects to your local <code>kubectl oidc-login</code> plugin:</p><p><img src=/__resources/Configure-callback_a7c1eb.png alt="Configure callback"></p></li><li><p>Save your changes.</p></li><li><p>Verify that <code>https://&lt;Auth0 Domain>/.well-known/openid-configuration</code> is reachable.</p></li><li><p>Choose <em>Users & Roles</em> > <em>Users</em> > <em>CREATE USERS</em> to create a user with a user and password:</p><p><img src=/__resources/Create-user_e28cd3.png alt="Create user"></p><blockquote><p>Users must have a <em>verified</em> email address.</p></blockquote></li></ol><h2 id=configure-a-local-kubectl-oidc-login>Configure a local <code>kubectl</code> <code>oidc-login</code></h2><ol><li><p>Install the <code>kubectl</code> plugin <a href=https://github.com/int128/kubelogin>oidc-login</a>. We highly recommend the <a href=https://github.com/kubernetes-sigs/krew>krew</a> install tool, which also makes other plugins easily available.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl krew install oidc-login
</code></pre></div><p>The response looks like this:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>Updated the local copy of plugin index.
Installing plugin: oidc-login
CAVEATS:
\
|  You need to setup the OIDC provider, Kubernetes API server, role binding and kubeconfig.
|  See https://github.com/int128/kubelogin for more.
/
Installed plugin: oidc-login
</code></pre></div></li><li><p>Prepare a <code>kubeconfig</code> for later use:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>cp ~/.kube/config ~/.kube/config-oidc
</code></pre></div></li><li><p>Modify the configuration of <code>~/.kube/config-oidc</code> as follows:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>shoot--project--mycluster</span><span class=w>
</span><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>my-oidc</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shoot--project--mycluster</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-oidc</span><span class=w>
</span><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>exec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>client.authentication.k8s.io/v1beta1</span><span class=w>
</span><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>kubectl</span><span class=w>
</span><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>oidc-login</span><span class=w>
</span><span class=w>      </span>- <span class=l>get-token</span><span class=w>
</span><span class=w>      </span>- --<span class=l>oidc-issuer-url=https://&lt;Issuer&gt;/ </span><span class=w>
</span><span class=w>      </span>- --<span class=l>oidc-client-id=&lt;Client ID&gt;</span><span class=w>
</span><span class=w>      </span>- --<span class=l>oidc-client-secret=&lt;Client Secret&gt;</span><span class=w>
</span><span class=w>      </span>- --<span class=l>oidc-extra-scope=email,offline_access,profile</span><span class=w>
</span></code></pre></div></li></ol><p>To test our OIDC-based authentication, context <code>shoot--project--mycluster</code> of <code>~/.kube/config-oidc</code> is used in a later step. For now, continue to use the configuration <code>~/.kube/config</code> with administration rights for your cluster.</p><h2 id=configure-the-shoot-cluster>Configure the shoot cluster</h2><p>Modify the shoot cluster YAML as follows, using the client ID and the domain (as issuer) from the settings of the client application you created in Auth0:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>garden.sapcloud.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mycluster</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden-project</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>kubernetes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>kubeAPIServer</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>oidcConfig</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>clientID</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Client ID&gt;</span><span class=w>
</span><span class=w>        </span><span class=nt>issuerURL</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://&lt;Issuer&gt;/&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>usernameClaim</span><span class=p>:</span><span class=w> </span><span class=l>email</span><span class=w>
</span></code></pre></div><p>This change of the <code>Shoot</code> manifest triggers a reconciliation. Once the reconciliation is finished, your OIDC configuration is applied. It <strong>doesn&rsquo;t</strong> invalidate other certificate-based authentication methods. Wait for Gardener to reconcile the change. It can take up to 5 minutes.</p><h2 id=authorize-an-authenticated-user>Authorize an authenticated user</h2><p>In Auth0, you created a user with a verified email address, <code>test@test.com</code> in our example. For simplicity, we authorize a single user identified by this email address with cluster role <code>view</code>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>viewer-test</span><span class=w>
</span><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>view</span><span class=w>
</span><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>User</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test@test.com</span><span class=w>
</span></code></pre></div><p>As administrator, apply the cluster role binding in your shoot cluster.</p><h2 id=verify-the-result>Verify the result</h2><ol><li><p>To step into the shoes of your user, use the prepared <code>kubeconfig</code> file <code>~/.kube/config-oidc</code>, and switch to the context that uses <code>oidc-login</code>:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>cd ~/.kube
export KUBECONFIG=$(pwd)/config-oidc
kubectl config use-context `shoot--project--mycluster`
</code></pre></div></li><li><p><code>kubectl</code> delegates the authentication to plugin <code>oidc-login</code> the first time the user uses <code>kubectl</code> to contact the API server, for example:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl get all
</code></pre></div><p>The plugin opens a browser for an interactive authentication session with Auth0, and in parallel serves a local webserver for the configured callback.</p></li><li><p>Enter your login credentials.</p><p><img src=/__resources/Login-through-identity-provider_471b16.png alt="Login through identity provider"></p><p>You should get a successful response from the API server:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>Opening in existing browser session.
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   100.64.0.1   &lt;none&gt;        443/TCP   86m
</code></pre></div><blockquote><p>After a successful login, <code>kubectl</code> uses a token for authentication so that you don’t have to provide user and password for every new <code>kubectl</code> command. How long the token is valid can be configured. If you want to log in again earlier, reset plugin <code>oidc-login</code>:</p><ol><li>Delete directory <code>~/.kube/cache/oidc-login</code>.</li><li>Delete the browser cache.</li></ol></blockquote></li><li><p>To see if your user uses cluster role <code>view</code>, do some checks with <code>kubectl auth can-i</code>.</p><ul><li><p>The response for the following commands should be <code>no</code>:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl auth can-i create clusterrolebindings
</code></pre></div><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl auth can-i get secrets
</code></pre></div><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl auth can-i describe secrets
</code></pre></div></li><li><p>The response for the following commands should be <code>yes</code>:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl auth can-i list pods
</code></pre></div><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl auth can-i get pods
</code></pre></div></li></ul></li></ol><p>If the last step is successful, you’ve configured your cluster to authenticate against an identity provider using OIDC.</p><h2 id=related-links>Related Links</h2><p><a href=https://auth0.com/pricing/>Auth0 Pricing</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-7e234a5492bf6ac145bc63720536b8c8>3.2 - Dynamic Volume Provisioning</h1><div class=lead>Running a Postgres database on Kubernetes and dynamically provision and mount the storage volumes needed by the database</div><h2 id=introduction>Introduction</h2><p>The example shows how to run a postgres database on Kubernetes and how to dynamically provision and mount the storage
volumes needed by the database</p><h2 id=run-postgres-database>Run postgres database</h2><p>Define the following Kubernetes resources in a yaml file</p><ul><li>PersistentVolumeClaim (PVC)</li><li>Deployment</li></ul><h4 id=persistentvolumeclaim>PersistentVolumeClaim</h4><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>postgresdb-pvc</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>9Gi</span><span class=w>
</span><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;default&#39;</span><span class=w>
</span></code></pre></div><p>This defines a PVC using storage class <code>default</code>. Storage classes abstract from the underlying storage provider as well
as other parameters, like disk-type (e.g.; solid-state vs standard disks).</p><p>The default storage class has annotation <strong>{&ldquo;storageclass.kubernetes.io/is-default-class&rdquo;:&ldquo;true&rdquo;}</strong>.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>
$ kubectl describe sc default
Name:            default
IsDefaultClass:  Yes
Annotations:     kubectl.kubernetes.io/last-applied-configuration<span class=o>={</span><span class=s2>&#34;apiVersion&#34;</span>:<span class=s2>&#34;storage.k8s.io/v1beta1&#34;</span>,<span class=s2>&#34;kind&#34;</span>:<span class=s2>&#34;StorageClass&#34;</span>,<span class=s2>&#34;metadata&#34;</span>:<span class=o>{</span><span class=s2>&#34;annotations&#34;</span>:<span class=o>{</span><span class=s2>&#34;storageclass.kubernetes.io/is-default-class&#34;</span>:<span class=s2>&#34;true&#34;</span><span class=o>}</span>,<span class=s2>&#34;labels&#34;</span>:<span class=o>{</span><span class=s2>&#34;addonmanager.kubernetes.io/mode&#34;</span>:<span class=s2>&#34;Exists&#34;</span><span class=o>}</span>,<span class=s2>&#34;name&#34;</span>:<span class=s2>&#34;default&#34;</span>,<span class=s2>&#34;namespace&#34;</span>:<span class=s2>&#34;&#34;</span><span class=o>}</span>,<span class=s2>&#34;parameters&#34;</span>:<span class=o>{</span><span class=s2>&#34;type&#34;</span>:<span class=s2>&#34;gp2&#34;</span><span class=o>}</span>,<span class=s2>&#34;provisioner&#34;</span>:<span class=s2>&#34;kubernetes.io/aws-ebs&#34;</span><span class=o>}</span>
,storageclass.kubernetes.io/is-default-class<span class=o>=</span><span class=nb>true</span>
Provisioner:           kubernetes.io/aws-ebs
Parameters:            <span class=nv>type</span><span class=o>=</span>gp2
AllowVolumeExpansion:  &lt;unset&gt;
MountOptions:          &lt;none&gt;
ReclaimPolicy:         Delete
VolumeBindingMode:     Immediate
Events:                &lt;none&gt;

</code></pre></div><p>A Persistent Volume is automatically created when it is dynamically provisioned. In following example, the PVC is defined
as &ldquo;postgresdb-pvc&rdquo;, and a corresponding PV &ldquo;pvc-06c81c30-72ea-11e8-ada2-aa3b2329c8bb&rdquo; is created and associated with pvc automatically.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl create -f .<span class=se>\p</span>ostgres_deployment.yaml
persistentvolumeclaim <span class=s2>&#34;postgresdb-pvc&#34;</span> created

$ kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS    CLAIM                    STORAGECLASS   REASON    AGE
pvc-06c81c30-72ea-11e8-ada2-aa3b2329c8bb   9Gi        RWO            Delete           Bound     default/postgresdb-pvc   default                  3s

$ kubectl get pvc
NAME             STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
postgresdb-pvc   Bound     pvc-06c81c30-72ea-11e8-ada2-aa3b2329c8bb   9Gi        RWO            default        8s
</code></pre></div><p>Notice that the <strong>RECLAIM POLICY</strong> is <strong>Delete</strong> (default value), which is one of the two reclaim policies, the other
one is <strong>Retain</strong>. (A third policy <strong>Recycle</strong> has been deprecated). In case of <strong>Delete</strong>, the PV is deleted automatically
when the PVC is removed, and the data on the PVC will also be lost.</p><p>On the other hand, PV with <strong>Retain</strong> policy will not be deleted when the PVC is removed, and moved to <strong>Release</strong> status, so
that data can be recovered by Administrators later.</p><p>You can use the <code>kubectl patch</code> command to change the reclaim policy as described here <a href=https://kubernetes.io/docs/tasks/administer-cluster/change-pv-reclaim-policy/>here</a>
or use <code>kubectl edit pv &lt;pv-name></code> to edit online as below:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS    CLAIM                    STORAGECLASS   REASON    AGE
pvc-06c81c30-72ea-11e8-ada2-aa3b2329c8bb   9Gi        RWO            Delete           Bound     default/postgresdb-pvc   default                  44m

<span class=c1># change the relcaim policy from &#34;Delete&#34; to &#34;Retain&#34;</span>
$ kubectl edit pv pvc-06c81c30-72ea-11e8-ada2-aa3b2329c8bb
persistentvolume <span class=s2>&#34;pvc-06c81c30-72ea-11e8-ada2-aa3b2329c8bb&#34;</span> edited

<span class=c1># check the reclaim policy afterwards</span>
$ kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS    CLAIM                    STORAGECLASS   REASON    AGE
pvc-06c81c30-72ea-11e8-ada2-aa3b2329c8bb   9Gi        RWO            Retain           Bound     default/postgresdb-pvc   default                  45m
</code></pre></div><h4 id=deployment>Deployment</h4><p>Once a PVC is created, you can use it in your container via <code>volumes.persistentVolumeClaim.claimName</code>. In below
example, pvc <strong>postgresdb-pvc</strong> is mounted as readable and writable, and in <code>volumeMounts</code> two paths in the container are mounted to subfolders in the volume.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>postgres</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>postgres</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>deployment.kubernetes.io/revision</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w>
</span><span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>postgres</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>postgres</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>postgres</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>postgres</span><span class=w>
</span><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;cpettech.docker.repositories.sap.ondemand.com/jtrack_postgres:howto&#34;</span><span class=w>
</span><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>POSTGRES_USER</span><span class=w>
</span><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>postgres</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>POSTGRES_PASSWORD</span><span class=w>
</span><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>p5FVqfuJFrM42cVX9muQXxrC3r8S9yn0zqWnFR6xCoPqxqVQ</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>POSTGRES_INITDB_XLOGDIR</span><span class=w>
</span><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/var/log/postgresql/logs&#34;</span><span class=w>
</span><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>5432</span><span class=w>
</span><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/postgresql/data</span><span class=w>
</span><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>postgre-db</span><span class=w>
</span><span class=w>              </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>data    </span><span class=w> </span><span class=c># https://github.com/kubernetes/website/pull/2292.  Solve the issue of crashing initdb due to non-empty directory (i.e. lost+found)</span><span class=w>
</span><span class=w>            </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/log/postgresql/logs</span><span class=w>
</span><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>postgre-db</span><span class=w>
</span><span class=w>              </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>logs</span><span class=w>
</span><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>postgre-db</span><span class=w>
</span><span class=w>          </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>postgresdb-pvc</span><span class=w>
</span><span class=w>            </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>      </span><span class=nt>imagePullSecrets</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpettechregistry</span><span class=w>
</span><span class=w>
</span></code></pre></div><p>To check the mount points in the container:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl get po
NAME                        READY     STATUS    RESTARTS   AGE
postgres-7f485fd768-c5jf9   1/1       Running   <span class=m>0</span>          32m

$ kubectl <span class=nb>exec</span> -it postgres-7f485fd768-c5jf9 bash

root@postgres-7f485fd768-c5jf9:/# ls /var/lib/postgresql/data/
base    pg_clog       pg_dynshmem  pg_ident.conf  pg_multixact  pg_replslot  pg_snapshots  pg_stat_tmp  pg_tblspc    PG_VERSION  postgresql.auto.conf  postmaster.opts
global  pg_commit_ts  pg_hba.conf  pg_logical     pg_notify     pg_serial    pg_stat       pg_subtrans  pg_twophase  pg_xlog     postgresql.conf       postmaster.pid

root@postgres-7f485fd768-c5jf9:/# ls /var/log/postgresql/logs/
<span class=m>000000010000000000000001</span>  archive_status

</code></pre></div><h4 id=deleting-a-persistentvolumeclaim>Deleting a PersistentVolumeClaim</h4><p>In case of &ldquo;Delete&rdquo; policy, deleting a PVC will also delete its associated PV. If &ldquo;Retain&rdquo; is the reclaim policy, the
PV will change status from <strong>Bound</strong> to <strong>Released</strong> when PVC is deleted.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># Check pvc and pv before deletion</span>
$ kubectl get pvc
NAME             STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
postgresdb-pvc   Bound     pvc-06c81c30-72ea-11e8-ada2-aa3b2329c8bb   9Gi        RWO            default        50m

$ kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS    CLAIM                    STORAGECLASS   REASON    AGE
pvc-06c81c30-72ea-11e8-ada2-aa3b2329c8bb   9Gi        RWO            Retain           Bound     default/postgresdb-pvc   default                  50m

<span class=c1># delete pvc</span>
$ kubectl delete pvc postgresdb-pvc
persistentvolumeclaim <span class=s2>&#34;postgresdb-pvc&#34;</span> deleted

<span class=c1># pv changed to status &#34;Released&#34;</span>
$ kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM                    STORAGECLASS   REASON    AGE
pvc-06c81c30-72ea-11e8-ada2-aa3b2329c8bb   9Gi        RWO            Retain           Released   default/postgresdb-pvc   default                  51m
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c90be487b1be659d530b3635ace83618>3.3 - Gardener yourself a Shoot with Istio, custom Domains, and Certificates</h1><p>As we ramp up more and more friends of Gardener, I thought it worthwile to explore and write a tutorial about how to simply</p><ul><li>create a Gardener managed Kubernetes Cluster (Shoot) via kubectl,</li><li>install Istio as a preferred, production ready Ingress/Service Mesh (instead of the Nginx Ingress addon),</li><li>attach your own custom domain to be managed by Gardener,</li><li>combine everything with certificates from Let&rsquo;s Encrypt.</li></ul><p>Here are some pre-pointers that you will need to go deeper:</p><ul><li><a href=https://gardener.cloud/docs/guides/administer_shoots/create-delete-shoot/>CRUD Gardener Shoot</a></li><li><a href=https://gardener.cloud/docs/guides/administer_shoots/create-delete-shoot/>DNS Management</a></li><li><a href=https://gardener.cloud/docs/concepts/networking/cert-managment/>Certificate Management</a></li><li><a href=https://gardener.cloud/docs/guides/administer_shoots/dns_names/>Tutorial Domain Names</a></li><li><a href=https://gardener.cloud/docs/guides/administer_shoots/request_cert/>Tutorial Certificates</a></li></ul><div class="alert alert-primary" role=alert><h4 class=alert-heading>Tip</h4>If you try my instructions and fail, then read the alternative title of this tutorial as "Shoot yourself in foot with Gardener, custom Domains, Istio and Certificates".</div><h2 id=first-things-first>First Things First</h2><p>Login to your Gardener landscape, setup a project with adequate infrastructure credentials and then navigate to your account. Note down the name of your secret. I chose the GCP infrastructure from the vast possible options that my Gardener provides me with, so i had named the secret as <code>shoot-operator-gcp</code>.</p><p>From the Access widget (leave the default settings) download your personalized <code>kubeconfig</code> into <code>~/.kube/kubeconfig-garden-myproject</code>. Follow the instructions to setup <code>kubelogin</code>:</p><p><img src=/__resources/access_1f1c85.png alt=access></p><p>For convinience, let us set an alias command with</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>alias</span> <span class=nv>kgarden</span><span class=o>=</span><span class=s2>&#34;kubectl --kubeconfig ~/.kube/kubeconfig-garden-myproject.yaml&#34;</span>
</code></pre></div><p><code>kgarden</code> now gives you all botanical powers and connects you directly with your Gardener.</p><p>You should now be able to run <code>kgarden get shoots</code>, automatically get an oidc token, and list already running clusters/shoots.</p><h2 id=prepare-your-custom-domain>Prepare your Custom Domain</h2><p>I am going to use <a href=https://www.cloudflare.com/>Cloud Flare</a> as programmatic DNS of my custom domain <code>mydomain.io</code>. Please follow detailed instructions from Cloud Flare on how to delegate your domain (the free account does not support delegating subdomains). Alternatively, AWS Route53 (and most others) support <a href=https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/CreatingNewSubdomain.html>delegating subdomains</a>.</p><p>I needed to follow these <a href=https://github.com/gardener/external-dns-management/blob/master/docs/cloudflare/README.md>instructions</a> and created the following secret:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudflare-mydomain-io</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>CLOUDFLARE_API_TOKEN</span><span class=p>:</span><span class=w> </span><span class=l>useYOURownDAMITzNDU2Nzg5MDEyMzQ1Njc4OQ==</span><span class=w>
</span></code></pre></div><p>Apply this secret into your project with <code>kgarden create -f cloudflare-mydomain-io.yaml</code>.</p><p>Our <a href=https://github.com/gardener/external-dns-management/>External DNS Manager</a> also supports Amazon Route53, Google CloudDNS, AliCloud DNS, Azure DNS, or OpenStack Designate. Check it out.</p><h2 id=prepare-gardener-extensions>Prepare Gardener Extensions</h2><p>I now need to prepare the Gardener extensions <code>shoot-dns-service</code> and <code>shoot-cert-service</code> and set the parameters accordingly.</p><div class="alert alert-info" role=alert>Please note, that the availability of Gardener Extensions depends on how your administrator has configured the Gardener landscape. Please contact your Gardener administrator in case you experience any issues during activation.</div><p>The following snipplet allows Gardener to manage my entire custom domain, whereas with the <code>include:</code> attribute I restrict all dynamic entries under the subdomain <code>gsicdc.mydomain.io</code>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>  </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>providers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>domains</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>include</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=l>gsicdc.mydomain.io</span><span class=w>
</span><span class=w>        </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>        </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>cloudflare-mydomain-io</span><span class=w>
</span><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>cloudflare-dns</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-dns-service</span><span class=w>
</span></code></pre></div><p>The next snipplet allows Gardener to manage certificates automatically from <em><a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a></em> on <code>mydomain.io</code> for me:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-cert-service</span><span class=w>
</span><span class=w>      </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>service.cert.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>        </span><span class=nt>issuers</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>email</span><span class=p>:</span><span class=w> </span><span class=l>me@mail.com</span><span class=w>
</span><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mydomain</span><span class=w>
</span><span class=w>            </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span><span class=w>
</span><span class=w>          </span>- <span class=nt>email</span><span class=p>:</span><span class=w> </span><span class=l>me@mail.com</span><span class=w>
</span><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mydomain-staging</span><span class=w>
</span><span class=w>            </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;https://acme-staging-v02.api.letsencrypt.org/directory&#39;</span><span class=w>
</span></code></pre></div><div class="alert alert-info" role=alert>Adjust the snipplets with your parameters (don't forget your email). And please use the mydomain-staging issuer while you are testing and learning. Otherwise, Let's Encrypt will rate limit your frequent requests and you can wait a week until you can continue.</div><p>References for <a href=https://letsencrypt.org>Let&rsquo;s Encrypt</a>:</p><ul><li><a href=https://letsencrypt.org/docs/rate-limits/>Rate limit</a></li><li><a href=https://letsencrypt.org/docs/staging-environment/>Staging environment</a></li><li><a href=https://letsencrypt.org/docs/challenge-types/>Challenge Types</a></li><li><a href=https://community.letsencrypt.org/t/acme-v2-production-environment-wildcards/55578>Wildcard Certificates</a></li></ul><h2 id=create-the-gardener-shoot-cluster>Create the Gardener Shoot Cluster</h2><p>Remember I chose to create the Shoot on GCP, so below is the simplest declarative shoot or cluster order document. Notice that I am referring to the infrastructure credentials with <code>shoot-operator-gcp</code> and I combined the above snipplets into the yaml file:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gsicdc</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>providers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>domains</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>include</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=l>gsicdc.mydomain.io</span><span class=w>
</span><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>cloudflare-mydomain-io</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>cloudflare-dns</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-dns-service</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-cert-service</span><span class=w>
</span><span class=w>    </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>service.cert.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>      </span><span class=nt>issuers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>email</span><span class=p>:</span><span class=w> </span><span class=l>me@mail.com</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mydomain</span><span class=w>
</span><span class=w>          </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span><span class=w>
</span><span class=w>        </span>- <span class=nt>email</span><span class=p>:</span><span class=w> </span><span class=l>me@mail.com</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mydomain-staging</span><span class=w>
</span><span class=w>          </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;https://acme-staging-v02.api.letsencrypt.org/directory&#39;</span><span class=w>
</span><span class=w>  </span><span class=nt>cloudProfileName</span><span class=p>:</span><span class=w> </span><span class=l>gcp</span><span class=w>
</span><span class=w>  </span><span class=nt>kubernetes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>allowPrivilegedContainers</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.18.2</span><span class=w>
</span><span class=w>  </span><span class=nt>maintenance</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>autoUpdate</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>kubernetesVersion</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>machineImageVersion</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>  </span><span class=nt>networking</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>nodes</span><span class=p>:</span><span class=w> </span><span class=m>10.250.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>    </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=m>100.96.0.0</span><span class=l>/11</span><span class=w>
</span><span class=w>    </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=m>100.64.0.0</span><span class=l>/13</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>calico</span><span class=w>
</span><span class=w>  </span><span class=nt>provider</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>controlPlaneConfig</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>gcp.provider.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ControlPlaneConfig</span><span class=w>
</span><span class=w>      </span><span class=nt>zone</span><span class=p>:</span><span class=w> </span><span class=l>europe-west1-d</span><span class=w>
</span><span class=w>    </span><span class=nt>infrastructureConfig</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>gcp.provider.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>InfrastructureConfig</span><span class=w>
</span><span class=w>      </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>workers</span><span class=p>:</span><span class=w> </span><span class=m>10.250.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>gcp</span><span class=w>
</span><span class=w>    </span><span class=nt>workers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>machine</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlinux</span><span class=w>
</span><span class=w>          </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>11.29.2</span><span class=w>
</span><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>n1-standard-2</span><span class=w>
</span><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span><span class=w>      </span><span class=nt>maximum</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span><span class=w>      </span><span class=nt>minimum</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-workerpool</span><span class=w>
</span><span class=w>      </span><span class=nt>volume</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=l>50Gi</span><span class=w>
</span><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>pd-standard</span><span class=w>
</span><span class=w>      </span><span class=nt>zones</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>europe-west1-d</span><span class=w>
</span><span class=w>  </span><span class=nt>purpose</span><span class=p>:</span><span class=w> </span><span class=l>testing</span><span class=w>
</span><span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>europe-west1</span><span class=w>
</span><span class=w>  </span><span class=nt>secretBindingName</span><span class=p>:</span><span class=w> </span><span class=l>shoot-operator-gcp</span><span class=w>
</span></code></pre></div><p>Create your cluster and wait for it to be ready (about 5 to 7min).</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kgarden create -f gsicdc.yaml
shoot.core.gardener.cloud/gsicdc created

$ kgarden get shoot gsicdc --watch
NAME     CLOUDPROFILE   VERSION   SEED   DOMAIN                                        HIBERNATION   OPERATION    PROGRESS   APISERVER     CONTROL       NODES     SYSTEM    AGE
gsicdc   gcp            1.18.2    gcp    gsicdc.myproject.shoot.devgarden.cloud   Awake         Processing   <span class=m>38</span>         Progressing   Progressing   Unknown   Unknown   83s
...
gsicdc   gcp            1.18.2    gcp    gsicdc.myproject.shoot.devgarden.cloud   Awake         Succeeded    <span class=m>100</span>        True          True          True          False         6m7s
</code></pre></div><p>Get access to your freshly baked cluster and set your <code>KUBECONFIG</code>:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kgarden get secrets gsicdc.kubeconfig -o <span class=nv>jsonpath</span><span class=o>={</span>.data.kubeconfig<span class=o>}</span> <span class=p>|</span> base64 -d &gt;kubeconfig-gsicdc.yaml

$ <span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>/kubeconfig-gsicdc.yaml
$ kubectl get all
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>   AGE
service/kubernetes   ClusterIP   100.64.0.1   &lt;none&gt;        443/TCP   89m
</code></pre></div><h2 id=install-istio>Install Istio</h2><p>Please follow the Istio installation <a href=https://istio.io/docs/setup/getting-started/>instructions</a> and download <code>istioctl</code>. If you are on a Mac, I recommend</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ brew install istioctl
</code></pre></div><p>I want to install Istio with a default profile and SDS enabled. Furthermore I pass the following annotations to the service object <code>istio-ingressgateway</code> in the <code>istio-system</code> namespace.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cert.gardener.cloud/issuer</span><span class=p>:</span><span class=w> </span><span class=l>mydomain-staging</span><span class=w>
</span><span class=w>    </span><span class=nt>cert.gardener.cloud/secretname</span><span class=p>:</span><span class=w> </span><span class=l>wildcard-tls</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/class</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/dnsnames</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*.gsicdc.mydomain.io&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>dns.gardener.cloud/ttl</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;120&#34;</span><span class=w>
</span></code></pre></div><p>With these annotations three things now happen automagically:</p><ol><li>The <a href=https://gardener.cloud/docs/guides/install_gardener/setup/>External DNS Manager</a>, provided to you as a service (<code>dns.gardener.cloud/class: garden</code>), picks up the request and creates the wildcard DNS entry <code>*.gsicdc.mydomain.io</code> with a time to live of 120sec at your DNS provider. My provider Cloud Flare is very very quick (as opposed to some other services). You should be able to verify the entry with <code>dig lovemygardener.gsicdc.mydomain.io</code> within seconds.</li><li>The <a href=https://gardener.cloud/docs/concepts/networking/cert-managment/>Certificate Mangement</a> picks up the request as well and initates a DNS01 protocol exchange with Let&rsquo;s Encrypt; using the staging environment referred to with the issuer behind <code>mydomain-staging</code>.</li><li>After aproximately 70sec (give and take) you will receive the wildcard certificate in the <code>wildcard-tls</code> secret in the namespace <code>istio-system</code>.</li></ol><div class="alert alert-info" role=alert>Notice, that the namespace for the certificate secret is often the cause of many troubeshooting sessions: the secret must reside in the same namespace of the gateway.</div><p>Here is the istio-install script:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>export</span> <span class=nv>domainname</span><span class=o>=</span><span class=s2>&#34;*.gsicdc.mydomain.io&#34;</span>
$ <span class=nb>export</span> <span class=nv>issuer</span><span class=o>=</span><span class=s2>&#34;mydomain-staging&#34;</span>

$ cat <span class=s>&lt;&lt;EOF | istioctl install -y -f -
</span><span class=s>apiVersion: install.istio.io/v1alpha1
</span><span class=s>kind: IstioOperator
</span><span class=s>spec:
</span><span class=s>  profile: default
</span><span class=s>  components:
</span><span class=s>    ingressGateways:
</span><span class=s>    - name: istio-ingressgateway
</span><span class=s>      enabled: true
</span><span class=s>      k8s:
</span><span class=s>        serviceAnnotations:
</span><span class=s>          cert.gardener.cloud/issuer: &#34;${issuer}&#34;
</span><span class=s>          cert.gardener.cloud/secretname: wildcard-tls
</span><span class=s>          dns.gardener.cloud/class: garden
</span><span class=s>          dns.gardener.cloud/dnsnames: &#34;${domainname}&#34;
</span><span class=s>          dns.gardener.cloud/ttl: &#34;120&#34; 
</span><span class=s>EOF</span>
</code></pre></div><p>Verify that setup is working and that DNS and certificates have been created/delivered:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl -n istio-system describe service istio-ingressgateway
&lt;snip&gt;
Events:
  Type    Reason                Age                From                     Message
  ----    ------                ----               ----                     -------
  Normal  EnsuringLoadBalancer  58s                service-controller       Ensuring load balancer
  Normal  reconcile             58s                cert-controller-manager  created certificate object istio-system/istio-ingressgateway-service-pwqdm
  Normal  cert-annotation       58s                cert-controller-manager  wildcard-tls: cert request is pending
  Normal  cert-annotation       54s                cert-controller-manager  wildcard-tls: certificate pending: certificate requested, preparing/waiting <span class=k>for</span> successful DNS01 challenge
  Normal  cert-annotation       28s                cert-controller-manager  wildcard-tls: certificate ready
  Normal  EnsuredLoadBalancer   26s                service-controller       Ensured load balancer
  Normal  reconcile             26s                dns-controller-manager   created dns entry object shoot--core--gsicdc/istio-ingressgateway-service-p9qqb
  Normal  dns-annotation        26s                dns-controller-manager   *.gsicdc.mydomain.io: dns entry is pending
  Normal  dns-annotation        21s <span class=o>(</span>x3 over 21s<span class=o>)</span>  dns-controller-manager   *.gsicdc.mydomain.io: dns entry active

$ dig lovemygardener.gsicdc.mydomain.io

<span class=p>;</span> &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; lovemygardener.gsicdc.mydomain.io
&lt;snip&gt;
<span class=p>;;</span> ANSWER SECTION:
lovemygardener.gsicdc.mydomain.io. <span class=m>120</span> IN A	35.195.120.62
&lt;snip&gt;
</code></pre></div><p>There you have it, the wildcard-tls certificate is ready and the *.gsicdc.mydomain.io dns entry is active. Traffic will be going your way.</p><h2 id=handy-tools-to-install>Handy tools to install</h2><p>Another set of fine tools to use are <a href=https://get-kapp.io/>kapp</a> (formerly known as k14s), <a href=https://k9scli.io/>k9s</a> and <a href=https://httpie.org/>HTTPie</a>. While we are at it, let&rsquo;s install them all. If you are on a Mac, I recommend:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>brew tap vmware-tanzu/carvel
brew install ytt kbld kapp kwt imgpkg vendir
brew install derailed/k9s/k9s
brew install httpie
</code></pre></div><h2 id=ingress-to-your-service>Ingress to your service</h2><div class="alert alert-info" role=alert>Networking is a central part of Kubernetes, but it can be challenging to understand exactly how it is expected to work. You should learn about Kubernetes networking, and first try to debug problems yourself. With a solid managed cluster from Gardener, it is always PEBCAK!</div><p>Kubernetes Ingress is a subject that is evolving to much broader standard. Please watch <a href="https://www.youtube.com/watch?v=cduG0FrjdJA">Evolving the Kubernetes Ingress APIs to GA and Beyond</a> for a good introduction. In this example, I did not want to use the Kubernetes <code>Ingress</code> compatibility option of Istio. Instead, I used <code>VirtualService</code> and <code>Gateway</code> from the Istio&rsquo;s API group <code>networking.istio.io/v1beta1</code> directly, and enabled istio-injection generically for the namespace.</p><p>I use <a href=https://httpbin.org/>httpbin</a> as service that I want to expose to the internet, or where my ingress should be routed to (depends on your point of view, I guess).</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Namespace</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>production</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>istio-injection</span><span class=p>:</span><span class=w> </span><span class=l>enabled</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>production</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>production</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/kennethreitz/httpbin</span><span class=w>
</span><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Gateway</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpbin-gw</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>production</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>istio</span><span class=p>:</span><span class=w> </span><span class=l>ingressgateway</span><span class=w> </span><span class=c>#! use istio default ingress gateway</span><span class=w>
</span><span class=w>  </span><span class=nt>servers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span><span class=w>    </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>httpsRedirect</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=s2>&#34;httpbin.gsicdc.mydomain.io&#34;</span><span class=w>
</span><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>443</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>https</span><span class=w>
</span><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>HTTPS</span><span class=w>
</span><span class=w>    </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>SIMPLE</span><span class=w>
</span><span class=w>      </span><span class=nt>credentialName</span><span class=p>:</span><span class=w> </span><span class=l>wildcard-tls</span><span class=w>
</span><span class=w>    </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=s2>&#34;httpbin.gsicdc.mydomain.io&#34;</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>VirtualService</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpbin-vs</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>production</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=s2>&#34;httpbin.gsicdc.mydomain.io&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>gateways</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=l>httpbin-gw</span><span class=w>
</span><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>uri</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>/.*</span><span class=w>
</span><span class=w>    </span><span class=nt>route</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>httpbin</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span></code></pre></div><p>Let us now deploy the whole package of Kubernetes primitives using <code>kapp</code>:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kapp deploy -a httpbin -f httpbin-kapp.yaml
Target cluster <span class=s1>&#39;https://api.gsicdc.myproject.shoot.devgarden.cloud&#39;</span> <span class=o>(</span>nodes: shoot--myproject--gsicdc-my-workerpool-z1-6586c8f6cb-x24kh<span class=o>)</span>

Changes

Namespace   Name        Kind            Conds.  Age  Op      Wait to    Rs  Ri
<span class=o>(</span>cluster<span class=o>)</span>   production  Namespace       -       -    create  reconcile  -   -
production  httpbin     Deployment      -       -    create  reconcile  -   -
^           httpbin     Service         -       -    create  reconcile  -   -
^           httpbin-gw  Gateway         -       -    create  reconcile  -   -
^           httpbin-vs  VirtualService  -       -    create  reconcile  -   -

Op:      <span class=m>5</span> create, <span class=m>0</span> delete, <span class=m>0</span> update, <span class=m>0</span> noop
Wait to: <span class=m>5</span> reconcile, <span class=m>0</span> delete, <span class=m>0</span> noop

Continue? <span class=o>[</span>yN<span class=o>]</span>: y

5:36:31PM: ---- applying <span class=m>1</span> changes <span class=o>[</span>0/5 <span class=k>done</span><span class=o>]</span> ----
&lt;snip&gt;
5:37:00PM: ok: reconcile deployment/httpbin <span class=o>(</span>apps/v1<span class=o>)</span> namespace: production
5:37:00PM: ---- applying <span class=nb>complete</span> <span class=o>[</span>5/5 <span class=k>done</span><span class=o>]</span> ----
5:37:00PM: ---- waiting <span class=nb>complete</span> <span class=o>[</span>5/5 <span class=k>done</span><span class=o>]</span> ----

Succeeded
</code></pre></div><p>Let&rsquo;s finaly test the service (Of course you can use the browser as well):</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ http httpbin.gsicdc.mydomain.io
HTTP/1.1 <span class=m>301</span> Moved Permanently
content-length: <span class=m>0</span>
date: Wed, <span class=m>13</span> May <span class=m>2020</span> 21:29:13 GMT
location: https://httpbin.gsicdc.mydomain.io/
server: istio-envoy

$ curl -k https://httpbin.gsicdc.mydomain.io/ip
<span class=o>{</span>
    <span class=s2>&#34;origin&#34;</span>: <span class=s2>&#34;10.250.0.2&#34;</span>
<span class=o>}</span>
</code></pre></div><p>Quod erat demonstrandum.
The proof of exchanging the issuer is now left to the reader.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Tip</h4>Remember that the certificate is actually not valid because it is issued from the Let's encrypt staging environment. Thus, we needed "curl -k" or "http --verify no".</div><p>Hint: use the interactive k9s tool.
<img src=/__resources/k9s_e59227.png alt=k9s></p><h2 id=cleanup>Cleanup</h2><p>Remove the cloud native application:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kapp ls
Apps in namespace <span class=s1>&#39;default&#39;</span>

Name     Namespaces            Lcs   Lca
httpbin  <span class=o>(</span>cluster<span class=o>)</span>,production  <span class=nb>true</span>  17m

$ kapp delete -a httpbin
...
Continue? <span class=o>[</span>yN<span class=o>]</span>: y
...
11:47:47PM: ---- waiting <span class=nb>complete</span> <span class=o>[</span>8/8 <span class=k>done</span><span class=o>]</span> ----

Succeeded
</code></pre></div><p>Remove Istio:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ istioctl x uninstall --purge
clusterrole.rbac.authorization.k8s.io <span class=s2>&#34;prometheus-istio-system&#34;</span> deleted
clusterrolebinding.rbac.authorization.k8s.io <span class=s2>&#34;prometheus-istio-system&#34;</span> deleted
...
</code></pre></div><p>Delete your Shoot:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kgarden annotate shoot gsicdc confirmation.gardener.cloud/deletion<span class=o>=</span><span class=nb>true</span> --overwrite
kgarden delete shoot gsicdc --wait<span class=o>=</span><span class=nb>false</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-d100c12a1d1b23c6d674069394a6bcf2>3.4 - GPU Enabled Cluster</h1><div class=lead>Setting up a GPU Enabled Cluster for Deep Learning</div><h2 id=intro>Intro</h2><p>Be aware, that the following sections might be opinionated. Kubernetes, and the GPU support in particular,
are rapidly evolving, which means that this guide is likely to be outdated sometime soon. For this reason,
<strong>contributions are highly appreciated</strong> to update this guide.</p><h2 id=create-a-cluster>Create a Cluster</h2><p>First thing first, let’s create a k8s cluster with GPU accelerated nodes. In this example we will use AWS
<strong>p2.xlarge</strong> EC2 instance because it&rsquo;s the cheapest available option at the moment. Use such cheap instances
for learning to limit your resource costs. <strong>This costs around 1€/hour per GPU</strong></p><p><img src=/__resources/howto-gpu_4413ce.png alt=gpu-selection></p><h2 id=install-nvidia-driver-as-daemonset>Install NVidia Driver as Daemonset</h2><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nvidia-driver-installer</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>nvidia-driver-installer</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nvidia-driver-installer</span><span class=w>
</span><span class=w>      </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>nvidia-driver-installer</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nvidia-driver-installer</span><span class=w>
</span><span class=w>        </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>nvidia-driver-installer</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>hostPID</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>squat/modulus:4a1799e7aa0143bcbb70d354bab3e419b1f54972</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>modulus</span><span class=w>
</span><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=l>compile</span><span class=w>
</span><span class=w>        </span>- <span class=l>nvidia</span><span class=w>
</span><span class=w>        </span>- <span class=s2>&#34;410.104&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MODULUS_CHROOT</span><span class=w>
</span><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MODULUS_INSTALL</span><span class=w>
</span><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MODULUS_INSTALL_DIR</span><span class=w>
</span><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>/opt/drivers</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MODULUS_CACHE_DIR</span><span class=w>
</span><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>/opt/modulus/cache</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MODULUS_LD_ROOT</span><span class=w>
</span><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>/root</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>IGNORE_MISSING_MODULE_SYMVERS</span><span class=w>
</span><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>          
</span><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>etc-coreos</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/coreos</span><span class=w>
</span><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>usr-share-coreos</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/usr/share/coreos</span><span class=w>
</span><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ld-root</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/root</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>module-cache</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/opt/modulus/cache</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>module-install-dir-base</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/opt/drivers</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/dev</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;gcr.io/google-containers/pause:3.1&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pause</span><span class=w>
</span><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;nvidia.com/gpu&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>etc-coreos</span><span class=w>
</span><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/coreos</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>usr-share-coreos</span><span class=w>
</span><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/usr/share/coreos</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ld-root</span><span class=w>
</span><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>module-cache</span><span class=w>
</span><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/opt/modulus/cache</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/dev</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>module-install-dir-base</span><span class=w>
</span><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/opt/drivers</span><span class=w>
</span></code></pre></div><h2 id=install-device-plugin>Install Device Plugin</h2><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nvidia-gpu-device-plugin</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>nvidia-gpu-device-plugin</span><span class=w>
</span><span class=w>    </span><span class=c>#addonmanager.kubernetes.io/mode: Reconcile</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>nvidia-gpu-device-plugin</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>nvidia-gpu-device-plugin</span><span class=w>
</span><span class=w>      </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>scheduler.alpha.kubernetes.io/critical-pod</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>priorityClassName</span><span class=p>:</span><span class=w> </span><span class=l>system-node-critical</span><span class=w>
</span><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>device-plugin</span><span class=w>
</span><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/kubelet/device-plugins</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/dev</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;k8s.gcr.io/nvidia-gpu-device-plugin@sha256:08509a36233c5096bb273a492251a9a5ca28558ab36d74007ca2a9d3f0b61e1d&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/usr/bin/nvidia-gpu-device-plugin&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-logtostderr&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-host-path=/opt/drivers/nvidia&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nvidia-gpu-device-plugin</span><span class=w>
</span><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>50m</span><span class=w>
</span><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>10Mi</span><span class=w>
</span><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>50m</span><span class=w>
</span><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>10Mi</span><span class=w>
</span><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>device-plugin</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/device-plugin</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/dev</span><span class=w>
</span><span class=w>  </span><span class=nt>updateStrategy</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w>
</span></code></pre></div><h2 id=test>Test</h2><p>To run an example training on a GPU node, start first a base image with Tensorflow with GPU support & Keras</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>deeplearning-workbench</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>deeplearning-workbench</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>deeplearning-workbench</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>deeplearning-workbench</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>afritzler/deeplearning-workbench</span><span class=w>
</span><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>nvidia.com/gpu</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;nvidia.com/gpu&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span></code></pre></div><p>Note: the <code>tolerations</code> section above is not required if you deploy the <code>ExtendedResourceToleration</code>
admission controller to your cluster. You can do this in the <code>kubernetes</code> section of your Gardener
cluster <code>shoot.yaml</code> as follows:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>  kubernetes:
    kubeAPIServer:
      admissionPlugins:
      - name: ExtendedResourceToleration
</code></pre></div><p>Now exec into the container and start an example Keras training</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl <span class=nb>exec</span> -it deeplearning-workbench-8676458f5d-p4d2v -- /bin/bash
<span class=nb>cd</span> /keras/example
python imdb_cnn.py
</code></pre></div><h2 id=acknowledgments--references>Acknowledgments & References</h2><ul><li><a href=https://github.com/afritzler/kubernetes-gpu>Andreas Fritzler</a> from the Gardener Core team for the R&D and providing this setup.</li><li><a href=https://github.com/squat/modulus>Build and install NVIDIA driver on CoreOS</a></li><li><a href=https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/device-plugins/nvidia-gpu/daemonset.yaml>Nvidia Device Plugin</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-82db4b0a88ec43d5df912dae1cd481bf>3.5 - Install Knative in Gardener clusters</h1><div class=lead>A walkthrough the steps for installing Knative in Gardener shoot clusters.</div><p>This guide walks you through the installation of the latest version of Knative
using pre-built images on a <a href=https://gardener.cloud>Gardener</a> created cluster
environment. To set up your own Gardener, see the
<a href=https://github.com/gardener/gardener/blob/master/docs/README.md>documentation</a>
or have a look at the
<a href=https://github.com/gardener/landscape-setup-template>landscape-setup-template</a>
project. To learn more about this open source project, read the
<a href=https://kubernetes.io/blog/2018/05/17/gardener/>blog on kubernetes.io</a>.</p><h2 id=before-you-begin>Before you begin</h2><p>Knative requires a Kubernetes cluster v1.15 or newer.</p><h3 id=install-and-configure-kubectl>Install and configure kubectl</h3><ol><li><p>If you already have <code>kubectl</code> CLI, run <code>kubectl version --short</code> to check
the version. You need v1.10 or newer. If your <code>kubectl</code> is older, follow the
next step to install a newer version.</p></li><li><p><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl>Install the kubectl CLI</a>.</p></li></ol><h3 id=access-gardener>Access Gardener</h3><ol><li><p>Create a project in the Gardener dashboard. This will essentially create a
Kubernetes namespace with the name <code>garden-&lt;my-project></code>.</p></li><li><p><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/#configure-kubectl>Configure access to your Gardener project</a>
using a kubeconfig. If you are not the Gardener Administrator already, you
can create a technical user in the Gardener dashboard: go to the &ldquo;Members&rdquo;
section and add a service account. You can then download the kubeconfig for
your project. You can skip this step if you create your cluster using the
user interface; it is only needed for programmatic access, make sure you set
<code>export KUBECONFIG=garden-my-project.yaml</code> in your shell.
<img src=/__resources/gardener_service_account_0a4a8a.png alt="Download kubeconfig for Gardener" title="downloading the kubeconfig using a service account"></p></li></ol><h3 id=creating-a-kubernetes-cluster>Creating a Kubernetes cluster</h3><p>You can create your cluster using <code>kubectl</code> cli by providing a cluster
specification yaml file. You can find an example for GCP
<a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml>here</a>.
Make sure the namespace matches that of your project. Then just apply the
prepared so-called &ldquo;shoot&rdquo; cluster crd with kubectl:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl apply --filename my-cluster.yaml
</code></pre></div><p>The easier alternative is to create the cluster following the cluster creation
wizard in the Gardener dashboard:
<img src=/__resources/gardener_shoot_creation_49a4ca.png alt="shoot creation" title="shoot creation via the dashboard"></p><h3 id=configure-kubectl-for-your-cluster>Configure kubectl for your cluster</h3><p>You can now download the kubeconfig for your freshly created cluster in the
Gardener dashboard or via cli as follows:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl --namespace shoot--my-project--my-cluster get secret kubecfg --output jsonpath={.data.kubeconfig} | base64 --decode &gt; my-cluster.yaml
</code></pre></div><p>This kubeconfig file has full administrators access to you cluster. For the rest
of this guide be sure you have <code>export KUBECONFIG=my-cluster.yaml</code> set.</p><h2 id=installing-istio>Installing Istio</h2><p>Knative depends on Istio. If your cloud platform offers a managed Istio
installation, we recommend installing Istio that way, unless you need the
ability to customize your installation.</p><p>Otherwise, see the <a href=https://knative.dev/docs/install/installing-istio/>Installing Istio for Knative guide</a>
to install Istio.</p><p>You must install Istio on your Kubernetes cluster before continuing with these
instructions to install Knative.</p><h2 id=installing-cluster-local-gateway-for-serving-cluster-internal-traffic>Installing <code>cluster-local-gateway</code> for serving cluster-internal traffic</h2><p>If you installed Istio, you can install a <code>cluster-local-gateway</code> within your Knative cluster so that you can serve cluster-internal traffic. If you want to configure your revisions to use routes that are visible only within your cluster, <a href=https://knative.dev/docs/admin/install/knative-offerings/>install and use the <code>cluster-local-gateway</code></a>.</p><h2 id=installing-knative>Installing Knative</h2><p>The following commands install all available Knative components as well as the
standard set of observability plugins. Knative&rsquo;s installation guide - <a href=https://knative.dev/docs/admin/install/>Installing Knative</a>.</p><ol><li><p>If you are upgrading from Knative 0.3.x: Update your domain and static IP
address to be associated with the LoadBalancer <code>istio-ingressgateway</code> instead
of <code>knative-ingressgateway</code>. Then run the following to clean up leftover
resources:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl delete svc knative-ingressgateway -n istio-system
kubectl delete deploy knative-ingressgateway -n istio-system
</code></pre></div><p>If you have the Knative Eventing Sources component installed, you will also
need to delete the following resource before upgrading:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl delete statefulset/controller-manager -n knative-sources
</code></pre></div><p>While the deletion of this resource during the upgrade process will not
prevent modifications to Eventing Source resources, those changes will not be
completed until the upgrade process finishes.</p></li><li><p>To install Knative, first install the CRDs by running the <code>kubectl apply</code>
command once with the <code>-l knative.dev/crd-install=true</code> flag. This prevents
race conditions during the install, which cause intermittent errors:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply --selector knative.dev/crd-install<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>--filename https://github.com/knative/serving/releases/download/v0.12.1/serving.yaml <span class=se>\
</span><span class=se></span>--filename https://github.com/knative/eventing/releases/download/v0.12.1/eventing.yaml <span class=se>\
</span><span class=se></span>--filename https://github.com/knative/serving/releases/download/v0.12.1/monitoring.yaml
</code></pre></div></li><li><p>To complete the install of Knative and its dependencies, run the
<code>kubectl apply</code> command again, this time without the <code>--selector</code> flag, to
complete the install of Knative and its dependencies:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply --filename https://github.com/knative/serving/releases/download/v0.12.1/serving.yaml <span class=se>\
</span><span class=se></span>--filename https://github.com/knative/eventing/releases/download/v0.12.1/eventing.yaml <span class=se>\
</span><span class=se></span>--filename https://github.com/knative/serving/releases/download/v0.12.1/monitoring.yaml
</code></pre></div></li><li><p>Monitor the Knative components until all of the components show a <code>STATUS</code> of
<code>Running</code>:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl get pods --namespace knative-serving
kubectl get pods --namespace knative-eventing
kubectl get pods --namespace knative-monitoring
</code></pre></div></li></ol><h2 id=set-your-custom-domain>Set your custom domain</h2><ol><li>Fetch the external IP or CNAME of the knative-ingressgateway</li></ol><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl --namespace istio-system get service knative-ingressgateway
NAME                     TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                                      AGE
knative-ingressgateway   LoadBalancer   100.70.219.81   35.233.41.212   80:32380/TCP,443:32390/TCP,32400:32400/TCP   4d
</code></pre></div><ol start=2><li>Create a wildcard DNS entry in your custom domain to point to above IP or
CNAME</li></ol><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>*.knative.&lt;my domain&gt; == A 35.233.41.212
# or CNAME if you are on AWS
*.knative.&lt;my domain&gt; == CNAME a317a278525d111e89f272a164fd35fb-1510370581.eu-central-1.elb.amazonaws.com
</code></pre></div><ol start=3><li>Adapt your knative config-domain (set your domain in the data field)</li></ol><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl --namespace knative-serving get configmaps config-domain --output yaml
apiVersion: v1
data:
  knative.&lt;my domain&gt;: &#34;&#34;
kind: ConfigMap
  name: config-domain
  namespace: knative-serving
</code></pre></div><h2 id=whats-next>What&rsquo;s next</h2><p>Now that your cluster has Knative installed, you can see what Knative has to
offer.</p><p>To deploy your first app with the
<a href=https://knative.dev/docs/serving/getting-started-knative-app/>Getting Started with Knative App Deployment</a>
guide.</p><p>Get started with Knative Eventing by walking through one of the
<a href=https://knative.dev/docs/eventing/samples/>Eventing Samples</a>.</p><p><a href=https://knative.dev/docs/serving/installing-cert-manager/>Install Cert-Manager</a> if you want to use the
<a href=https://knative.dev/docs/serving/using-auto-tls/>automatic TLS cert provisioning feature</a>.</p><h2 id=cleaning-up>Cleaning up</h2><p>Use the Gardener dashboard to delete your cluster, or execute the following with
kubectl pointing to your <code>garden-my-project.yaml</code> kubeconfig:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl --kubeconfig garden-my-project.yaml --namespace garden--my-project annotate shoot my-cluster confirmation.gardener.cloud/deletion=true

kubectl --kubeconfig garden-my-project.yaml --namespace garden--my-project delete shoot my-cluster
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-b25746ecc02152f58a677e6b79819ba8>3.6 - Shared storage with S3 backend</h1><div class=lead>Using S3 bucket as shared storage for pods</div><h2 id=shared-storage-with-s3-backend>Shared storage with S3 backend</h2><p>The storage is definitely the most complex and important part of an application setup, once this part is
completed, 80% of the tasks are completed.</p><p>Mounting an S3 bucket into a pod using FUSE allows you to access the data as if it were on the local disk. The
mount is a pointer to an S3 location, so the data is never synced locally. Once mounted, any pod can read or even write
from that directory without the need for explicit keys.</p><p>However, it can be used to import and parse large amounts of data into a database.</p><h2 id=overview>Overview</h2><p><img src=https://github.com/freegroup/kube-s3/raw/master/images/s3-mount.png alt=s3-mount></p><h2 id=limitations>Limitations</h2><p>Generally S3 cannot offer the same performance or semantics as a local file system. More specifically:</p><ul><li>random writes or appends to files require rewriting the entire file</li><li>metadata operations such as listing directories have poor performance due to network latency</li><li>eventual consistency can temporarily yield stale data(Amazon S3 Data Consistency Model)</li><li>no atomic renames of files or directories</li><li>no coordination between multiple clients mounting the same bucket</li><li>no hard links</li></ul><h2 id=before-you-begin>Before you Begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must be configured to communicate with
your cluster. If you do not already have a cluster, you can create one by using the <a href=https://gardener.cloud/>Gardener</a>.</p><p>Ensure that you have create the &ldquo;imagePullSecret&rdquo; in your cluster.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>kubectl create secret docker-registry artifactory --docker-server<span class=o>=</span>&lt;YOUR-REGISTRY&gt;.docker.repositories.sap.ondemand.com --docker-username<span class=o>=</span>&lt;USERNAME&gt; --docker-password<span class=o>=</span>&lt;PASSWORD&gt; --docker-email<span class=o>=</span>&lt;EMAIL&gt; -n &lt;NAMESPACE&gt;
</code></pre></div><h2 id=setup>Setup</h2><p>The first step is to clone this repository. Next is the Secret for the AWS API credentials of the user that has
full access to our S3 bucket. Copy the <code>configmap_secrets_template.yaml</code> to <code>configmap_secrets.yaml</code> and place
your secrets at the right place</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>s3-config</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>S3_BUCKET</span><span class=p>:</span><span class=w> </span><span class=l>&lt;YOUR-S3-BUCKET-NAME&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>AWS_KEY</span><span class=p>:</span><span class=w> </span><span class=l>&lt;YOUR-AWS-TECH-USER-ACCESS-KEY&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>AWS_SECRET_KEY</span><span class=p>:</span><span class=w> </span><span class=l>&lt;YOUR-AWS-TECH-USER-SECRET&gt;</span><span class=w>
</span></code></pre></div><h2 id=build-and-deploy>Build and deploy</h2><p>Change the settings in the <code>build.sh</code> file with your docker registry settings.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#!/usr/bin/env bash
</span><span class=cp></span>
<span class=c1>########################################################################################################################</span>
<span class=c1># PREREQUISTITS</span>
<span class=c1>########################################################################################################################</span>
<span class=c1>#</span>
<span class=c1># - ensure that you have a valid Artifactory or other Docker registry account</span>
<span class=c1># - Create your image pull secret in your namespace</span>
<span class=c1>#   kubectl create secret docker-registry artifactory --docker-server=&lt;YOUR-REGISTRY&gt;.docker.repositories.sap.ondemand.com --docker-username=&lt;USERNAME&gt; --docker-password=&lt;PASSWORD&gt; --docker-email=&lt;EMAIL&gt; -n &lt;NAMESPACE&gt;</span>
<span class=c1># - change the settings below arcording your settings</span>
<span class=c1>#</span>
<span class=c1># usage:</span>
<span class=c1># Call this script with the version to build and push to the registry. After build/push the</span>
<span class=c1># yaml/* files are deployed into your cluster</span>
<span class=c1>#</span>
<span class=c1>#  ./build.sh 1.0</span>
<span class=c1>#</span>
<span class=nv>VERSION</span><span class=o>=</span><span class=nv>$1</span>
<span class=nv>PROJECT</span><span class=o>=</span>kube-s3
<span class=nv>REPOSITORY</span><span class=o>=</span>cp-enablement.docker.repositories.sap.ondemand.com


<span class=c1># causes the shell to exit if any subcommand or pipeline returns a non-zero status.</span>
<span class=nb>set</span> -e
<span class=c1># set debug mode</span>
<span class=c1>#set -x</span>

.
.
.
.

</code></pre></div><p>Create the S3Fuse Pod and check the status:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># build and push the image to your docker registry</span>
./build.sh 1.0 

<span class=c1># check that the pods are up and running</span>
kubectl get pods

</code></pre></div><h2 id=check-success>Check success</h2><p>Create a demo Pod and check the status:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>kubectl apply -f ./yaml/example_pod.yaml

<span class=c1># wait some second to get the pod up and running...</span>
kubectl get pods

<span class=c1># go into the pd and check that the /var/s3 is mounted with your S3 bucket content inside</span>
kubectl <span class=nb>exec</span> -ti test-pd  sh

<span class=c1># inside the pod</span>
ls -la /var/s3

</code></pre></div><h2 id=why-does-this-work>Why does this work?</h2><p>Docker engine 1.10 added a new feature which allows containers to share the host mount namespace. This feature makes
it possible to mount a s3fs container file system to a host file system through a shared mount, providing a persistent
network storage with S3 backend.</p><p>The key part is mountPath: <code>/var/s3:shared</code> which enables the volume to be mounted as shared inside the pod. When the
container starts it will mount the S3 bucket onto <code>/var/s3</code> and consequently the data will be available under
<code>/mnt/data-s3fs</code> on the host and thus to any other container/pod running on it (and has <code>/mnt/data-s3fs</code> mounted too).</p></div><div class=td-content style=page-break-before:always><h1 id=pg-043610093194cf60e3758f9f695c73cb>4 - API Reference</h1><div class=lead>Reference documentation for the Gardener API</div></div><div class=td-content><h1 id=pg-0834e906239fffd3f36ee63049e3adfd>4.1 - Core</h1><p>Packages:</p><ul><li><a href=#core.gardener.cloud%2fv1beta1>core.gardener.cloud/v1beta1</a></li></ul><h2 id=core.gardener.cloud/v1beta1>core.gardener.cloud/v1beta1</h2><p><p>Package v1beta1 is a version of the API.</p></p>Resource Types:<ul><li><a href=#core.gardener.cloud/v1beta1.BackupBucket>BackupBucket</a></li><li><a href=#core.gardener.cloud/v1beta1.BackupEntry>BackupEntry</a></li><li><a href=#core.gardener.cloud/v1beta1.CloudProfile>CloudProfile</a></li><li><a href=#core.gardener.cloud/v1beta1.ControllerDeployment>ControllerDeployment</a></li><li><a href=#core.gardener.cloud/v1beta1.ControllerInstallation>ControllerInstallation</a></li><li><a href=#core.gardener.cloud/v1beta1.ControllerRegistration>ControllerRegistration</a></li><li><a href=#core.gardener.cloud/v1beta1.Plant>Plant</a></li><li><a href=#core.gardener.cloud/v1beta1.Project>Project</a></li><li><a href=#core.gardener.cloud/v1beta1.Quota>Quota</a></li><li><a href=#core.gardener.cloud/v1beta1.SecretBinding>SecretBinding</a></li><li><a href=#core.gardener.cloud/v1beta1.Seed>Seed</a></li><li><a href=#core.gardener.cloud/v1beta1.Shoot>Shoot</a></li></ul><h3 id=core.gardener.cloud/v1beta1.BackupBucket>BackupBucket</h3><p><p>BackupBucket holds details about backup bucket</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>core.gardener.cloud/v1beta1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>BackupBucket</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#core.gardener.cloud/v1beta1.BackupBucketSpec>BackupBucketSpec</a></em></td><td><p>Specification of the Backup Bucket.</p><br><br><table><tr><td><code>provider</code></br><em><a href=#core.gardener.cloud/v1beta1.BackupBucketProvider>BackupBucketProvider</a></em></td><td><p>Provider hold the details of cloud provider of the object store.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig is the configuration passed to BackupBucket resource.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the credentials to access object store.</p></td></tr><tr><td><code>seedName</code></br><em>string</em></td><td><em>(Optional)</em><p>SeedName holds the name of the seed allocated to BackupBucket for running controller.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#core.gardener.cloud/v1beta1.BackupBucketStatus>BackupBucketStatus</a></em></td><td><p>Most recently observed status of the Backup Bucket.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.BackupEntry>BackupEntry</h3><p><p>BackupEntry holds details about shoot backup.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>core.gardener.cloud/v1beta1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>BackupEntry</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#core.gardener.cloud/v1beta1.BackupEntrySpec>BackupEntrySpec</a></em></td><td><em>(Optional)</em><p>Spec contains the specification of the Backup Entry.</p><br><br><table><tr><td><code>bucketName</code></br><em>string</em></td><td><p>BucketName is the name of backup bucket for this Backup Entry.</p></td></tr><tr><td><code>seedName</code></br><em>string</em></td><td><em>(Optional)</em><p>SeedName holds the name of the seed to which this BackupEntry is scheduled</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#core.gardener.cloud/v1beta1.BackupEntryStatus>BackupEntryStatus</a></em></td><td><em>(Optional)</em><p>Status contains the most recently observed status of the Backup Entry.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.CloudProfile>CloudProfile</h3><p><p>CloudProfile represents certain properties about a provider environment.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>core.gardener.cloud/v1beta1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>CloudProfile</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#core.gardener.cloud/v1beta1.CloudProfileSpec>CloudProfileSpec</a></em></td><td><em>(Optional)</em><p>Spec defines the provider environment properties.</p><br><br><table><tr><td><code>caBundle</code></br><em>string</em></td><td><em>(Optional)</em><p>CABundle is a certificate bundle which will be installed onto every host machine of shoot cluster targeting this profile.</p></td></tr><tr><td><code>kubernetes</code></br><em><a href=#core.gardener.cloud/v1beta1.KubernetesSettings>KubernetesSettings</a></em></td><td><p>Kubernetes contains constraints regarding allowed values of the &lsquo;kubernetes&rsquo; block in the Shoot specification.</p></td></tr><tr><td><code>machineImages</code></br><em><a href=#core.gardener.cloud/v1beta1.MachineImage>[]MachineImage</a></em></td><td><p>MachineImages contains constraints regarding allowed values for machine images in the Shoot specification.</p></td></tr><tr><td><code>machineTypes</code></br><em><a href=#core.gardener.cloud/v1beta1.MachineType>[]MachineType</a></em></td><td><p>MachineTypes contains constraints regarding allowed values for machine types in the &lsquo;workers&rsquo; block in the Shoot specification.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig contains provider-specific configuration for the profile.</p></td></tr><tr><td><code>regions</code></br><em><a href=#core.gardener.cloud/v1beta1.Region>[]Region</a></em></td><td><p>Regions contains constraints regarding allowed values for regions and zones.</p></td></tr><tr><td><code>seedSelector</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSelector>SeedSelector</a></em></td><td><em>(Optional)</em><p>SeedSelector contains an optional list of labels on <code>Seed</code> resources that marks those seeds whose shoots may use this provider profile.
An empty list means that all seeds of the same provider type are supported.
This is useful for environments that are of the same type (like openstack) but may have different &ldquo;instances&rdquo;/landscapes.
Optionally a list of possible providers can be added to enable cross-provider scheduling. By default, the provider
type of the seed must match the shoot&rsquo;s provider.</p></td></tr><tr><td><code>type</code></br><em>string</em></td><td><p>Type is the name of the provider.</p></td></tr><tr><td><code>volumeTypes</code></br><em><a href=#core.gardener.cloud/v1beta1.VolumeType>[]VolumeType</a></em></td><td><em>(Optional)</em><p>VolumeTypes contains constraints regarding allowed values for volume types in the &lsquo;workers&rsquo; block in the Shoot specification.</p></td></tr></table></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ControllerDeployment>ControllerDeployment</h3><p><p>ControllerDeployment contains information about how this controller is deployed.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>core.gardener.cloud/v1beta1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>ControllerDeployment</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>type</code></br><em>string</em></td><td><p>Type is the deployment type.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><p>ProviderConfig contains type-specific configuration. It contains assets that deploy the controller.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ControllerInstallation>ControllerInstallation</h3><p><p>ControllerInstallation represents an installation request for an external controller.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>core.gardener.cloud/v1beta1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>ControllerInstallation</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#core.gardener.cloud/v1beta1.ControllerInstallationSpec>ControllerInstallationSpec</a></em></td><td><p>Spec contains the specification of this installation.</p><br><br><table><tr><td><code>registrationRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectreference-v1-core>Kubernetes core/v1.ObjectReference</a></em></td><td><p>RegistrationRef is used to reference a ControllerRegistration resource.</p></td></tr><tr><td><code>seedRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectreference-v1-core>Kubernetes core/v1.ObjectReference</a></em></td><td><p>SeedRef is used to reference a Seed resource.</p></td></tr><tr><td><code>deploymentRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectreference-v1-core>Kubernetes core/v1.ObjectReference</a></em></td><td><em>(Optional)</em><p>DeploymentRef is used to reference a ControllerDeployment resource.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#core.gardener.cloud/v1beta1.ControllerInstallationStatus>ControllerInstallationStatus</a></em></td><td><p>Status contains the status of this installation.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ControllerRegistration>ControllerRegistration</h3><p><p>ControllerRegistration represents a registration of an external controller.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>core.gardener.cloud/v1beta1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>ControllerRegistration</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#core.gardener.cloud/v1beta1.ControllerRegistrationSpec>ControllerRegistrationSpec</a></em></td><td><p>Spec contains the specification of this registration.</p><br><br><table><tr><td><code>resources</code></br><em><a href=#core.gardener.cloud/v1beta1.ControllerResource>[]ControllerResource</a></em></td><td><em>(Optional)</em><p>Resources is a list of combinations of kinds (DNSProvider, Infrastructure, Generic, &mldr;) and their actual types
(aws-route53, gcp, auditlog, &mldr;).</p></td></tr><tr><td><code>deployment</code></br><em><a href=#core.gardener.cloud/v1beta1.ControllerRegistrationDeployment>ControllerRegistrationDeployment</a></em></td><td><em>(Optional)</em><p>Deployment contains information for how this controller is deployed.</p></td></tr></table></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Plant>Plant</h3><p><p>Plant represents an external kubernetes cluster.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>core.gardener.cloud/v1beta1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>Plant</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#core.gardener.cloud/v1beta1.PlantSpec>PlantSpec</a></em></td><td><p>Spec contains the specification of this Plant.</p><br><br><table><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#localobjectreference-v1-core>Kubernetes core/v1.LocalObjectReference</a></em></td><td><p>SecretRef is a reference to a Secret object containing the Kubeconfig of the external kubernetes
clusters to be added to Gardener.</p></td></tr><tr><td><code>endpoints</code></br><em><a href=#core.gardener.cloud/v1beta1.Endpoint>[]Endpoint</a></em></td><td><em>(Optional)</em><p>Endpoints is the configuration plant endpoints</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#core.gardener.cloud/v1beta1.PlantStatus>PlantStatus</a></em></td><td><p>Status contains the status of this Plant.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Project>Project</h3><p><p>Project holds certain properties about a Gardener project.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>core.gardener.cloud/v1beta1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>Project</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#core.gardener.cloud/v1beta1.ProjectSpec>ProjectSpec</a></em></td><td><em>(Optional)</em><p>Spec defines the project properties.</p><br><br><table><tr><td><code>createdBy</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#subject-v1-rbac>Kubernetes rbac/v1.Subject</a></em></td><td><em>(Optional)</em><p>CreatedBy is a subject representing a user name, an email address, or any other identifier of a user
who created the project.</p></td></tr><tr><td><code>description</code></br><em>string</em></td><td><em>(Optional)</em><p>Description is a human-readable description of what the project is used for.</p></td></tr><tr><td><code>owner</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#subject-v1-rbac>Kubernetes rbac/v1.Subject</a></em></td><td><em>(Optional)</em><p>Owner is a subject representing a user name, an email address, or any other identifier of a user owning
the project.
IMPORTANT: Be aware that this field will be removed in the <code>v1</code> version of this API in favor of the <code>owner</code>
role. The only way to change the owner will be by moving the <code>owner</code> role. In this API version the only way
to change the owner is to use this field.
TODO: Remove this field in favor of the <code>owner</code> role in <code>v1</code>.</p></td></tr><tr><td><code>purpose</code></br><em>string</em></td><td><em>(Optional)</em><p>Purpose is a human-readable explanation of the project&rsquo;s purpose.</p></td></tr><tr><td><code>members</code></br><em><a href=#core.gardener.cloud/v1beta1.ProjectMember>[]ProjectMember</a></em></td><td><em>(Optional)</em><p>Members is a list of subjects representing a user name, an email address, or any other identifier of a user,
group, or service account that has a certain role.</p></td></tr><tr><td><code>namespace</code></br><em>string</em></td><td><em>(Optional)</em><p>Namespace is the name of the namespace that has been created for the Project object.
A nil value means that Gardener will determine the name of the namespace.</p></td></tr><tr><td><code>tolerations</code></br><em><a href=#core.gardener.cloud/v1beta1.ProjectTolerations>ProjectTolerations</a></em></td><td><em>(Optional)</em><p>Tolerations contains the tolerations for taints on seed clusters.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#core.gardener.cloud/v1beta1.ProjectStatus>ProjectStatus</a></em></td><td><em>(Optional)</em><p>Most recently observed status of the Project.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Quota>Quota</h3><p><p>Quota represents a quota on resources consumed by shoot clusters either per project or per provider secret.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>core.gardener.cloud/v1beta1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>Quota</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#core.gardener.cloud/v1beta1.QuotaSpec>QuotaSpec</a></em></td><td><em>(Optional)</em><p>Spec defines the Quota constraints.</p><br><br><table><tr><td><code>clusterLifetimeDays</code></br><em>int32</em></td><td><em>(Optional)</em><p>ClusterLifetimeDays is the lifetime of a Shoot cluster in days before it will be terminated automatically.</p></td></tr><tr><td><code>metrics</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#resourcelist-v1-core>Kubernetes core/v1.ResourceList</a></em></td><td><p>Metrics is a list of resources which will be put under constraints.</p></td></tr><tr><td><code>scope</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectreference-v1-core>Kubernetes core/v1.ObjectReference</a></em></td><td><p>Scope is the scope of the Quota object, either &lsquo;project&rsquo; or &lsquo;secret&rsquo;.</p></td></tr></table></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SecretBinding>SecretBinding</h3><p><p>SecretBinding represents a binding to a secret in the same or another namespace.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>core.gardener.cloud/v1beta1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>SecretBinding</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret object in the same or another namespace.</p></td></tr><tr><td><code>quotas</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectreference-v1-core>[]Kubernetes core/v1.ObjectReference</a></em></td><td><em>(Optional)</em><p>Quotas is a list of references to Quota objects in the same or another namespace.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Seed>Seed</h3><p><p>Seed represents an installation request for an external controller.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>core.gardener.cloud/v1beta1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>Seed</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSpec>SeedSpec</a></em></td><td><p>Spec contains the specification of this installation.</p><br><br><table><tr><td><code>backup</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedBackup>SeedBackup</a></em></td><td><em>(Optional)</em><p>Backup holds the object store configuration for the backups of shoot (currently only etcd).
If it is not specified, then there won&rsquo;t be any backups taken for shoots associated with this seed.
If backup field is present in seed, then backups of the etcd from shoot control plane will be stored
under the configured object store.</p></td></tr><tr><td><code>dns</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedDNS>SeedDNS</a></em></td><td><p>DNS contains DNS-relevant information about this seed cluster.</p></td></tr><tr><td><code>networks</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedNetworks>SeedNetworks</a></em></td><td><p>Networks defines the pod, service and worker network of the Seed cluster.</p></td></tr><tr><td><code>provider</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedProvider>SeedProvider</a></em></td><td><p>Provider defines the provider type and region for this Seed cluster.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><em>(Optional)</em><p>SecretRef is a reference to a Secret object containing the Kubeconfig and the cloud provider credentials for
the account the Seed cluster has been deployed to.</p></td></tr><tr><td><code>taints</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedTaint>[]SeedTaint</a></em></td><td><em>(Optional)</em><p>Taints describes taints on the seed.</p></td></tr><tr><td><code>volume</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedVolume>SeedVolume</a></em></td><td><em>(Optional)</em><p>Volume contains settings for persistentvolumes created in the seed cluster.</p></td></tr><tr><td><code>settings</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSettings>SeedSettings</a></em></td><td><em>(Optional)</em><p>Settings contains certain settings for this seed cluster.</p></td></tr><tr><td><code>ingress</code></br><em><a href=#core.gardener.cloud/v1beta1.Ingress>Ingress</a></em></td><td><em>(Optional)</em><p>Ingress configures Ingress specific settings of the Seed cluster.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedStatus>SeedStatus</a></em></td><td><p>Status contains the status of this installation.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Shoot>Shoot</h3><p><p>Shoot represents a Shoot cluster created and managed by Gardener.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>core.gardener.cloud/v1beta1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>Shoot</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a></em></td><td><em>(Optional)</em><p>Specification of the Shoot cluster.</p><br><br><table><tr><td><code>addons</code></br><em><a href=#core.gardener.cloud/v1beta1.Addons>Addons</a></em></td><td><em>(Optional)</em><p>Addons contains information about enabled/disabled addons and their configuration.</p></td></tr><tr><td><code>cloudProfileName</code></br><em>string</em></td><td><p>CloudProfileName is a name of a CloudProfile object.</p></td></tr><tr><td><code>dns</code></br><em><a href=#core.gardener.cloud/v1beta1.DNS>DNS</a></em></td><td><em>(Optional)</em><p>DNS contains information about the DNS settings of the Shoot.</p></td></tr><tr><td><code>extensions</code></br><em><a href=#core.gardener.cloud/v1beta1.Extension>[]Extension</a></em></td><td><em>(Optional)</em><p>Extensions contain type and provider information for Shoot extensions.</p></td></tr><tr><td><code>hibernation</code></br><em><a href=#core.gardener.cloud/v1beta1.Hibernation>Hibernation</a></em></td><td><em>(Optional)</em><p>Hibernation contains information whether the Shoot is suspended or not.</p></td></tr><tr><td><code>kubernetes</code></br><em><a href=#core.gardener.cloud/v1beta1.Kubernetes>Kubernetes</a></em></td><td><p>Kubernetes contains the version and configuration settings of the control plane components.</p></td></tr><tr><td><code>networking</code></br><em><a href=#core.gardener.cloud/v1beta1.Networking>Networking</a></em></td><td><p>Networking contains information about cluster networking such as CNI Plugin type, CIDRs, &mldr;etc.</p></td></tr><tr><td><code>maintenance</code></br><em><a href=#core.gardener.cloud/v1beta1.Maintenance>Maintenance</a></em></td><td><em>(Optional)</em><p>Maintenance contains information about the time window for maintenance operations and which
operations should be performed.</p></td></tr><tr><td><code>monitoring</code></br><em><a href=#core.gardener.cloud/v1beta1.Monitoring>Monitoring</a></em></td><td><em>(Optional)</em><p>Monitoring contains information about custom monitoring configurations for the shoot.</p></td></tr><tr><td><code>provider</code></br><em><a href=#core.gardener.cloud/v1beta1.Provider>Provider</a></em></td><td><p>Provider contains all provider-specific and provider-relevant information.</p></td></tr><tr><td><code>purpose</code></br><em><a href=#core.gardener.cloud/v1beta1.ShootPurpose>ShootPurpose</a></em></td><td><em>(Optional)</em><p>Purpose is the purpose class for this cluster.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is a name of a region.</p></td></tr><tr><td><code>secretBindingName</code></br><em>string</em></td><td><p>SecretBindingName is the name of the a SecretBinding that has a reference to the provider secret.
The credentials inside the provider secret will be used to create the shoot in the respective account.</p></td></tr><tr><td><code>seedName</code></br><em>string</em></td><td><em>(Optional)</em><p>SeedName is the name of the seed cluster that runs the control plane of the Shoot.</p></td></tr><tr><td><code>seedSelector</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSelector>SeedSelector</a></em></td><td><em>(Optional)</em><p>SeedSelector is an optional selector which must match a seed&rsquo;s labels for the shoot to be scheduled on that seed.</p></td></tr><tr><td><code>resources</code></br><em><a href=#core.gardener.cloud/v1beta1.NamedResourceReference>[]NamedResourceReference</a></em></td><td><em>(Optional)</em><p>Resources holds a list of named resource references that can be referred to in extension configs by their names.</p></td></tr><tr><td><code>tolerations</code></br><em><a href=#core.gardener.cloud/v1beta1.Toleration>[]Toleration</a></em></td><td><em>(Optional)</em><p>Tolerations contains the tolerations for taints on seed clusters.</p></td></tr><tr><td><code>exposureClassName</code></br><em>string</em></td><td><em>(Optional)</em><p>ExposureClassName is the optional name of an exposure class to apply a control plane endpoint exposure strategy.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#core.gardener.cloud/v1beta1.ShootStatus>ShootStatus</a></em></td><td><em>(Optional)</em><p>Most recently observed status of the Shoot cluster.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Addon>Addon</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubernetesDashboard>KubernetesDashboard</a>,
<a href=#core.gardener.cloud/v1beta1.NginxIngress>NginxIngress</a>)</p><p><p>Addon allows enabling or disabling a specific addon and is used to derive from.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>enabled</code></br><em>bool</em></td><td><p>Enabled indicates whether the addon is enabled or not.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Addons>Addons</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a>)</p><p><p>Addons is a collection of configuration for specific addons which are managed by the Gardener.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>kubernetesDashboard</code></br><em><a href=#core.gardener.cloud/v1beta1.KubernetesDashboard>KubernetesDashboard</a></em></td><td><em>(Optional)</em><p>KubernetesDashboard holds configuration settings for the kubernetes dashboard addon.</p></td></tr><tr><td><code>nginxIngress</code></br><em><a href=#core.gardener.cloud/v1beta1.NginxIngress>NginxIngress</a></em></td><td><em>(Optional)</em><p>NginxIngress holds configuration settings for the nginx-ingress addon.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.AdmissionPlugin>AdmissionPlugin</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubeAPIServerConfig>KubeAPIServerConfig</a>)</p><p><p>AdmissionPlugin contains information about a specific admission plugin and its corresponding configuration.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the name of the plugin.</p></td></tr><tr><td><code>config</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>Config is the configuration of the plugin.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Alerting>Alerting</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Monitoring>Monitoring</a>)</p><p><p>Alerting contains information about how alerting will be done (i.e. who will receive alerts and how).</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>emailReceivers</code></br><em>[]string</em></td><td><em>(Optional)</em><p>MonitoringEmailReceivers is a list of recipients for alerts</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.AuditConfig>AuditConfig</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubeAPIServerConfig>KubeAPIServerConfig</a>)</p><p><p>AuditConfig contains settings for audit of the api server</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>auditPolicy</code></br><em><a href=#core.gardener.cloud/v1beta1.AuditPolicy>AuditPolicy</a></em></td><td><em>(Optional)</em><p>AuditPolicy contains configuration settings for audit policy of the kube-apiserver.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.AuditPolicy>AuditPolicy</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.AuditConfig>AuditConfig</a>)</p><p><p>AuditPolicy contains audit policy for kube-apiserver</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>configMapRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectreference-v1-core>Kubernetes core/v1.ObjectReference</a></em></td><td><em>(Optional)</em><p>ConfigMapRef is a reference to a ConfigMap object in the same namespace,
which contains the audit policy for the kube-apiserver.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.AvailabilityZone>AvailabilityZone</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Region>Region</a>)</p><p><p>AvailabilityZone is an availability zone.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name is an an availability zone name.</p></td></tr><tr><td><code>unavailableMachineTypes</code></br><em>[]string</em></td><td><em>(Optional)</em><p>UnavailableMachineTypes is a list of machine type names that are not availability in this zone.</p></td></tr><tr><td><code>unavailableVolumeTypes</code></br><em>[]string</em></td><td><em>(Optional)</em><p>UnavailableVolumeTypes is a list of volume type names that are not availability in this zone.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.BackupBucketProvider>BackupBucketProvider</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.BackupBucketSpec>BackupBucketSpec</a>)</p><p><p>BackupBucketProvider holds the details of cloud provider of the object store.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></br><em>string</em></td><td><p>Type is the type of provider.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is the region of the bucket.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.BackupBucketSpec>BackupBucketSpec</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.BackupBucket>BackupBucket</a>)</p><p><p>BackupBucketSpec is the specification of a Backup Bucket.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>provider</code></br><em><a href=#core.gardener.cloud/v1beta1.BackupBucketProvider>BackupBucketProvider</a></em></td><td><p>Provider hold the details of cloud provider of the object store.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig is the configuration passed to BackupBucket resource.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the credentials to access object store.</p></td></tr><tr><td><code>seedName</code></br><em>string</em></td><td><em>(Optional)</em><p>SeedName holds the name of the seed allocated to BackupBucket for running controller.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.BackupBucketStatus>BackupBucketStatus</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.BackupBucket>BackupBucket</a>)</p><p><p>BackupBucketStatus holds the most recently observed status of the Backup Bucket.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>providerStatus</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderStatus is the configuration passed to BackupBucket resource.</p></td></tr><tr><td><code>lastOperation</code></br><em><a href=#core.gardener.cloud/v1beta1.LastOperation>LastOperation</a></em></td><td><em>(Optional)</em><p>LastOperation holds information about the last operation on the BackupBucket.</p></td></tr><tr><td><code>lastError</code></br><em><a href=#core.gardener.cloud/v1beta1.LastError>LastError</a></em></td><td><em>(Optional)</em><p>LastError holds information about the last occurred error during an operation.</p></td></tr><tr><td><code>observedGeneration</code></br><em>int64</em></td><td><em>(Optional)</em><p>ObservedGeneration is the most recent generation observed for this BackupBucket. It corresponds to the
BackupBucket&rsquo;s generation, which is updated on mutation by the API Server.</p></td></tr><tr><td><code>generatedSecretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><em>(Optional)</em><p>GeneratedSecretRef is reference to the secret generated by backup bucket, which
will have object store specific credentials.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.BackupEntrySpec>BackupEntrySpec</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.BackupEntry>BackupEntry</a>)</p><p><p>BackupEntrySpec is the specification of a Backup Entry.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>bucketName</code></br><em>string</em></td><td><p>BucketName is the name of backup bucket for this Backup Entry.</p></td></tr><tr><td><code>seedName</code></br><em>string</em></td><td><em>(Optional)</em><p>SeedName holds the name of the seed to which this BackupEntry is scheduled</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.BackupEntryStatus>BackupEntryStatus</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.BackupEntry>BackupEntry</a>)</p><p><p>BackupEntryStatus holds the most recently observed status of the Backup Entry.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>lastOperation</code></br><em><a href=#core.gardener.cloud/v1beta1.LastOperation>LastOperation</a></em></td><td><em>(Optional)</em><p>LastOperation holds information about the last operation on the BackupEntry.</p></td></tr><tr><td><code>lastError</code></br><em><a href=#core.gardener.cloud/v1beta1.LastError>LastError</a></em></td><td><em>(Optional)</em><p>LastError holds information about the last occurred error during an operation.</p></td></tr><tr><td><code>observedGeneration</code></br><em>int64</em></td><td><em>(Optional)</em><p>ObservedGeneration is the most recent generation observed for this BackupEntry. It corresponds to the
BackupEntry&rsquo;s generation, which is updated on mutation by the API Server.</p></td></tr><tr><td><code>seedName</code></br><em>string</em></td><td><em>(Optional)</em><p>SeedName is the name of the seed to which this BackupEntry is currently scheduled. This field is populated
at the beginning of a create/reconcile operation. It is used when moving the BackupEntry between seeds.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.CRI>CRI</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.MachineImageVersion>MachineImageVersion</a>,
<a href=#core.gardener.cloud/v1beta1.Worker>Worker</a>)</p><p><p>CRI contains information about the Container Runtimes.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em><a href=#core.gardener.cloud/v1beta1.CRIName>CRIName</a></em></td><td><p>The name of the CRI library. Supported values are <code>docker</code> and <code>containerd</code>.</p></td></tr><tr><td><code>containerRuntimes</code></br><em><a href=#core.gardener.cloud/v1beta1.ContainerRuntime>[]ContainerRuntime</a></em></td><td><em>(Optional)</em><p>ContainerRuntimes is the list of the required container runtimes supported for a worker pool.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.CRIName>CRIName
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.CRI>CRI</a>)</p><p><p>CRIName is a type alias for the CRI name string.</p></p><h3 id=core.gardener.cloud/v1beta1.CloudInfo>CloudInfo</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ClusterInfo>ClusterInfo</a>)</p><p><p>CloudInfo contains information about the cloud</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></br><em>string</em></td><td><p>Type is the cloud type</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is the cloud region</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.CloudProfileSpec>CloudProfileSpec</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.CloudProfile>CloudProfile</a>)</p><p><p>CloudProfileSpec is the specification of a CloudProfile.
It must contain exactly one of its defined keys.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>caBundle</code></br><em>string</em></td><td><em>(Optional)</em><p>CABundle is a certificate bundle which will be installed onto every host machine of shoot cluster targeting this profile.</p></td></tr><tr><td><code>kubernetes</code></br><em><a href=#core.gardener.cloud/v1beta1.KubernetesSettings>KubernetesSettings</a></em></td><td><p>Kubernetes contains constraints regarding allowed values of the &lsquo;kubernetes&rsquo; block in the Shoot specification.</p></td></tr><tr><td><code>machineImages</code></br><em><a href=#core.gardener.cloud/v1beta1.MachineImage>[]MachineImage</a></em></td><td><p>MachineImages contains constraints regarding allowed values for machine images in the Shoot specification.</p></td></tr><tr><td><code>machineTypes</code></br><em><a href=#core.gardener.cloud/v1beta1.MachineType>[]MachineType</a></em></td><td><p>MachineTypes contains constraints regarding allowed values for machine types in the &lsquo;workers&rsquo; block in the Shoot specification.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig contains provider-specific configuration for the profile.</p></td></tr><tr><td><code>regions</code></br><em><a href=#core.gardener.cloud/v1beta1.Region>[]Region</a></em></td><td><p>Regions contains constraints regarding allowed values for regions and zones.</p></td></tr><tr><td><code>seedSelector</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSelector>SeedSelector</a></em></td><td><em>(Optional)</em><p>SeedSelector contains an optional list of labels on <code>Seed</code> resources that marks those seeds whose shoots may use this provider profile.
An empty list means that all seeds of the same provider type are supported.
This is useful for environments that are of the same type (like openstack) but may have different &ldquo;instances&rdquo;/landscapes.
Optionally a list of possible providers can be added to enable cross-provider scheduling. By default, the provider
type of the seed must match the shoot&rsquo;s provider.</p></td></tr><tr><td><code>type</code></br><em>string</em></td><td><p>Type is the name of the provider.</p></td></tr><tr><td><code>volumeTypes</code></br><em><a href=#core.gardener.cloud/v1beta1.VolumeType>[]VolumeType</a></em></td><td><em>(Optional)</em><p>VolumeTypes contains constraints regarding allowed values for volume types in the &lsquo;workers&rsquo; block in the Shoot specification.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ClusterAutoscaler>ClusterAutoscaler</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Kubernetes>Kubernetes</a>)</p><p><p>ClusterAutoscaler contains the configuration flags for the Kubernetes cluster autoscaler.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>scaleDownDelayAfterAdd</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>ScaleDownDelayAfterAdd defines how long after scale up that scale down evaluation resumes (default: 1 hour).</p></td></tr><tr><td><code>scaleDownDelayAfterDelete</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>ScaleDownDelayAfterDelete how long after node deletion that scale down evaluation resumes, defaults to scanInterval (default: 0 secs).</p></td></tr><tr><td><code>scaleDownDelayAfterFailure</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>ScaleDownDelayAfterFailure how long after scale down failure that scale down evaluation resumes (default: 3 mins).</p></td></tr><tr><td><code>scaleDownUnneededTime</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>ScaleDownUnneededTime defines how long a node should be unneeded before it is eligible for scale down (default: 30 mins).</p></td></tr><tr><td><code>scaleDownUtilizationThreshold</code></br><em>float64</em></td><td><em>(Optional)</em><p>ScaleDownUtilizationThreshold defines the threshold in fraction (0.0 - 1.0) under which a node is being removed (default: 0.5).</p></td></tr><tr><td><code>scanInterval</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>ScanInterval how often cluster is reevaluated for scale up or down (default: 10 secs).</p></td></tr><tr><td><code>expander</code></br><em><a href=#core.gardener.cloud/v1beta1.ExpanderMode>ExpanderMode</a></em></td><td><em>(Optional)</em><p>Expander defines the algorithm to use during scale up (default: least-waste).
See: <a href=https://github.com/gardener/autoscaler/blob/machine-controller-manager-provider/cluster-autoscaler/FAQ.md#what-are-expanders>https://github.com/gardener/autoscaler/blob/machine-controller-manager-provider/cluster-autoscaler/FAQ.md#what-are-expanders</a>.</p></td></tr><tr><td><code>maxNodeProvisionTime</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>MaxNodeProvisionTime defines how long CA waits for node to be provisioned (default: 20 mins).</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ClusterInfo>ClusterInfo</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.PlantStatus>PlantStatus</a>)</p><p><p>ClusterInfo contains information about the Plant cluster</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>cloud</code></br><em><a href=#core.gardener.cloud/v1beta1.CloudInfo>CloudInfo</a></em></td><td><p>Cloud describes the cloud information</p></td></tr><tr><td><code>kubernetes</code></br><em><a href=#core.gardener.cloud/v1beta1.KubernetesInfo>KubernetesInfo</a></em></td><td><p>Kubernetes describes kubernetes meta information (e.g., version)</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Condition>Condition</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ControllerInstallationStatus>ControllerInstallationStatus</a>,
<a href=#core.gardener.cloud/v1beta1.PlantStatus>PlantStatus</a>,
<a href=#core.gardener.cloud/v1beta1.SeedStatus>SeedStatus</a>,
<a href=#core.gardener.cloud/v1beta1.ShootStatus>ShootStatus</a>)</p><p><p>Condition holds the information about the state of a resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></br><em><a href=#core.gardener.cloud/v1beta1.ConditionType>ConditionType</a></em></td><td><p>Type of the Shoot condition.</p></td></tr><tr><td><code>status</code></br><em><a href=#core.gardener.cloud/v1beta1.ConditionStatus>ConditionStatus</a></em></td><td><p>Status of the condition, one of True, False, Unknown.</p></td></tr><tr><td><code>lastTransitionTime</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#time-v1-meta>Kubernetes meta/v1.Time</a></em></td><td><p>Last time the condition transitioned from one status to another.</p></td></tr><tr><td><code>lastUpdateTime</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#time-v1-meta>Kubernetes meta/v1.Time</a></em></td><td><p>Last time the condition was updated.</p></td></tr><tr><td><code>reason</code></br><em>string</em></td><td><p>The reason for the condition&rsquo;s last transition.</p></td></tr><tr><td><code>message</code></br><em>string</em></td><td><p>A human readable message indicating details about the transition.</p></td></tr><tr><td><code>codes</code></br><em><a href=#core.gardener.cloud/v1beta1.ErrorCode>[]ErrorCode</a></em></td><td><em>(Optional)</em><p>Well-defined error codes in case the condition reports a problem.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ConditionStatus>ConditionStatus
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Condition>Condition</a>)</p><p><p>ConditionStatus is the status of a condition.</p></p><h3 id=core.gardener.cloud/v1beta1.ConditionType>ConditionType
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Condition>Condition</a>)</p><p><p>ConditionType is a string alias.</p></p><h3 id=core.gardener.cloud/v1beta1.ContainerRuntime>ContainerRuntime</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.CRI>CRI</a>)</p><p><p>ContainerRuntime contains information about worker&rsquo;s available container runtime</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></br><em>string</em></td><td><p>Type is the type of the Container Runtime.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig is the configuration passed to container runtime resource.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ControllerDeploymentPolicy>ControllerDeploymentPolicy
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ControllerRegistrationDeployment>ControllerRegistrationDeployment</a>)</p><p><p>ControllerDeploymentPolicy is a string alias.</p></p><h3 id=core.gardener.cloud/v1beta1.ControllerInstallationSpec>ControllerInstallationSpec</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ControllerInstallation>ControllerInstallation</a>)</p><p><p>ControllerInstallationSpec is the specification of a ControllerInstallation.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>registrationRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectreference-v1-core>Kubernetes core/v1.ObjectReference</a></em></td><td><p>RegistrationRef is used to reference a ControllerRegistration resource.</p></td></tr><tr><td><code>seedRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectreference-v1-core>Kubernetes core/v1.ObjectReference</a></em></td><td><p>SeedRef is used to reference a Seed resource.</p></td></tr><tr><td><code>deploymentRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectreference-v1-core>Kubernetes core/v1.ObjectReference</a></em></td><td><em>(Optional)</em><p>DeploymentRef is used to reference a ControllerDeployment resource.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ControllerInstallationStatus>ControllerInstallationStatus</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ControllerInstallation>ControllerInstallation</a>)</p><p><p>ControllerInstallationStatus is the status of a ControllerInstallation.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>conditions</code></br><em><a href=#core.gardener.cloud/v1beta1.Condition>[]Condition</a></em></td><td><em>(Optional)</em><p>Conditions represents the latest available observations of a ControllerInstallations&rsquo;s current state.</p></td></tr><tr><td><code>providerStatus</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderStatus contains type-specific status.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ControllerRegistrationDeployment>ControllerRegistrationDeployment</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ControllerRegistrationSpec>ControllerRegistrationSpec</a>)</p><p><p>ControllerRegistrationDeployment contains information for how this controller is deployed.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></br><em>string</em></td><td><em>(Optional)</em><p>Type is the deployment type.
Deprecated: Declare type via <code>ControllerDeployment</code> instead.
ATTENTION: This field will be deleted with Gardener v1.32.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig contains type-specific configuration.
Deprecated: Use <code>DeploymentRefs</code> instead.
ATTENTION: This field will be deleted with Gardener v1.32.</p></td></tr><tr><td><code>policy</code></br><em><a href=#core.gardener.cloud/v1beta1.ControllerDeploymentPolicy>ControllerDeploymentPolicy</a></em></td><td><em>(Optional)</em><p>Policy controls how the controller is deployed. It defaults to &lsquo;OnDemand&rsquo;.</p></td></tr><tr><td><code>seedSelector</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#labelselector-v1-meta>Kubernetes meta/v1.LabelSelector</a></em></td><td><em>(Optional)</em><p>SeedSelector contains an optional label selector for seeds. Only if the labels match then this controller will be
considered for a deployment.
An empty list means that all seeds are selected.</p></td></tr><tr><td><code>deploymentRefs</code></br><em><a href=#core.gardener.cloud/v1beta1.DeploymentRef>[]DeploymentRef</a></em></td><td><em>(Optional)</em><p>DeploymentRefs holds references to <code>ControllerDeployments</code>. Only one element is support now.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ControllerRegistrationSpec>ControllerRegistrationSpec</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ControllerRegistration>ControllerRegistration</a>)</p><p><p>ControllerRegistrationSpec is the specification of a ControllerRegistration.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>resources</code></br><em><a href=#core.gardener.cloud/v1beta1.ControllerResource>[]ControllerResource</a></em></td><td><em>(Optional)</em><p>Resources is a list of combinations of kinds (DNSProvider, Infrastructure, Generic, &mldr;) and their actual types
(aws-route53, gcp, auditlog, &mldr;).</p></td></tr><tr><td><code>deployment</code></br><em><a href=#core.gardener.cloud/v1beta1.ControllerRegistrationDeployment>ControllerRegistrationDeployment</a></em></td><td><em>(Optional)</em><p>Deployment contains information for how this controller is deployed.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ControllerResource>ControllerResource</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ControllerRegistrationSpec>ControllerRegistrationSpec</a>)</p><p><p>ControllerResource is a combination of a kind (DNSProvider, Infrastructure, Generic, &mldr;) and the actual type for this
kind (aws-route53, gcp, auditlog, &mldr;).</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>kind</code></br><em>string</em></td><td><p>Kind is the resource kind, for example &ldquo;OperatingSystemConfig&rdquo;.</p></td></tr><tr><td><code>type</code></br><em>string</em></td><td><p>Type is the resource type, for example &ldquo;coreos&rdquo; or &ldquo;ubuntu&rdquo;.</p></td></tr><tr><td><code>globallyEnabled</code></br><em>bool</em></td><td><em>(Optional)</em><p>GloballyEnabled determines if this ControllerResource is required by all Shoot clusters.</p></td></tr><tr><td><code>reconcileTimeout</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>ReconcileTimeout defines how long Gardener should wait for the resource reconciliation.</p></td></tr><tr><td><code>primary</code></br><em>bool</em></td><td><em>(Optional)</em><p>Primary determines if the controller backed by this ControllerRegistration is responsible for the extension
resource&rsquo;s lifecycle. This field defaults to true. There must be exactly one primary controller for this kind/type
combination.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.DNS>DNS</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a>)</p><p><p>DNS holds information about the provider, the hosted zone id and the domain.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>domain</code></br><em>string</em></td><td><em>(Optional)</em><p>Domain is the external available domain of the Shoot cluster. This domain will be written into the
kubeconfig that is handed out to end-users. Once set it is immutable.</p></td></tr><tr><td><code>providers</code></br><em><a href=#core.gardener.cloud/v1beta1.DNSProvider>[]DNSProvider</a></em></td><td><em>(Optional)</em><p>Providers is a list of DNS providers that shall be enabled for this shoot cluster. Only relevant if
not a default domain is used.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.DNSIncludeExclude>DNSIncludeExclude</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.DNSProvider>DNSProvider</a>,
<a href=#core.gardener.cloud/v1beta1.SeedDNSProvider>SeedDNSProvider</a>)</p><p><p>DNSIncludeExclude contains information about which domains shall be included/excluded.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>include</code></br><em>[]string</em></td><td><em>(Optional)</em><p>Include is a list of domains that shall be included.</p></td></tr><tr><td><code>exclude</code></br><em>[]string</em></td><td><em>(Optional)</em><p>Exclude is a list of domains that shall be excluded.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.DNSProvider>DNSProvider</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.DNS>DNS</a>)</p><p><p>DNSProvider contains information about a DNS provider.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>domains</code></br><em><a href=#core.gardener.cloud/v1beta1.DNSIncludeExclude>DNSIncludeExclude</a></em></td><td><em>(Optional)</em><p>Domains contains information about which domains shall be included/excluded for this provider.</p></td></tr><tr><td><code>primary</code></br><em>bool</em></td><td><em>(Optional)</em><p>Primary indicates that this DNSProvider is used for shoot related domains.</p></td></tr><tr><td><code>secretName</code></br><em>string</em></td><td><em>(Optional)</em><p>SecretName is a name of a secret containing credentials for the stated domain and the
provider. When not specified, the Gardener will use the cloud provider credentials referenced
by the Shoot and try to find respective credentials there (primary provider only). Specifying this field may override
this behavior, i.e. forcing the Gardener to only look into the given secret.</p></td></tr><tr><td><code>type</code></br><em>string</em></td><td><em>(Optional)</em><p>Type is the DNS provider type.</p></td></tr><tr><td><code>zones</code></br><em><a href=#core.gardener.cloud/v1beta1.DNSIncludeExclude>DNSIncludeExclude</a></em></td><td><em>(Optional)</em><p>Zones contains information about which hosted zones shall be included/excluded for this provider.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.DataVolume>DataVolume</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Worker>Worker</a>)</p><p><p>DataVolume contains information about a data volume.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name of the volume to make it referencable.</p></td></tr><tr><td><code>type</code></br><em>string</em></td><td><em>(Optional)</em><p>Type is the type of the volume.</p></td></tr><tr><td><code>size</code></br><em>string</em></td><td><p>VolumeSize is the size of the volume.</p></td></tr><tr><td><code>encrypted</code></br><em>bool</em></td><td><em>(Optional)</em><p>Encrypted determines if the volume should be encrypted.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.DeploymentRef>DeploymentRef</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ControllerRegistrationDeployment>ControllerRegistrationDeployment</a>)</p><p><p>DeploymentRef contains information about <code>ControllerDeployment</code> references.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the name of the <code>ControllerDeployment</code> that is being referred to.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Endpoint>Endpoint</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.PlantSpec>PlantSpec</a>)</p><p><p>Endpoint is an endpoint for monitoring, logging and other services around the plant.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the name of the endpoint</p></td></tr><tr><td><code>url</code></br><em>string</em></td><td><p>URL is the url of the endpoint</p></td></tr><tr><td><code>purpose</code></br><em>string</em></td><td><p>Purpose is the purpose of the endpoint</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ErrorCode>ErrorCode
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Condition>Condition</a>,
<a href=#core.gardener.cloud/v1beta1.LastError>LastError</a>)</p><p><p>ErrorCode is a string alias.</p></p><h3 id=core.gardener.cloud/v1beta1.ExpanderMode>ExpanderMode
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ClusterAutoscaler>ClusterAutoscaler</a>)</p><p><p>ExpanderMode is type used for Expander values</p></p><h3 id=core.gardener.cloud/v1beta1.ExpirableVersion>ExpirableVersion</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubernetesSettings>KubernetesSettings</a>,
<a href=#core.gardener.cloud/v1beta1.MachineImageVersion>MachineImageVersion</a>)</p><p><p>ExpirableVersion contains a version and an expiration date.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>version</code></br><em>string</em></td><td><p>Version is the version identifier.</p></td></tr><tr><td><code>expirationDate</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#time-v1-meta>Kubernetes meta/v1.Time</a></em></td><td><em>(Optional)</em><p>ExpirationDate defines the time at which this version expires.</p></td></tr><tr><td><code>classification</code></br><em><a href=#core.gardener.cloud/v1beta1.VersionClassification>VersionClassification</a></em></td><td><em>(Optional)</em><p>Classification defines the state of a version (preview, supported, deprecated)</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Extension>Extension</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a>)</p><p><p>Extension contains type and provider information for Shoot extensions.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></br><em>string</em></td><td><p>Type is the type of the extension resource.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig is the configuration passed to extension resource.</p></td></tr><tr><td><code>disabled</code></br><em>bool</em></td><td><em>(Optional)</em><p>Disabled allows to disable extensions that were marked as &lsquo;globally enabled&rsquo; by Gardener administrators.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Gardener>Gardener</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedStatus>SeedStatus</a>,
<a href=#core.gardener.cloud/v1beta1.ShootStatus>ShootStatus</a>)</p><p><p>Gardener holds the information about the Gardener version that operated a resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></br><em>string</em></td><td><p>ID is the Docker container id of the Gardener which last acted on a resource.</p></td></tr><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the hostname (pod name) of the Gardener which last acted on a resource.</p></td></tr><tr><td><code>version</code></br><em>string</em></td><td><p>Version is the version of the Gardener which last acted on a resource.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Hibernation>Hibernation</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a>)</p><p><p>Hibernation contains information whether the Shoot is suspended or not.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>enabled</code></br><em>bool</em></td><td><em>(Optional)</em><p>Enabled specifies whether the Shoot needs to be hibernated or not. If it is true, the Shoot&rsquo;s desired state is to be hibernated.
If it is false or nil, the Shoot&rsquo;s desired state is to be awaken.</p></td></tr><tr><td><code>schedules</code></br><em><a href=#core.gardener.cloud/v1beta1.HibernationSchedule>[]HibernationSchedule</a></em></td><td><em>(Optional)</em><p>Schedules determine the hibernation schedules.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.HibernationSchedule>HibernationSchedule</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Hibernation>Hibernation</a>)</p><p><p>HibernationSchedule determines the hibernation schedule of a Shoot.
A Shoot will be regularly hibernated at each start time and will be woken up at each end time.
Start or End can be omitted, though at least one of each has to be specified.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>start</code></br><em>string</em></td><td><em>(Optional)</em><p>Start is a Cron spec at which time a Shoot will be hibernated.</p></td></tr><tr><td><code>end</code></br><em>string</em></td><td><em>(Optional)</em><p>End is a Cron spec at which time a Shoot will be woken up.</p></td></tr><tr><td><code>location</code></br><em>string</em></td><td><em>(Optional)</em><p>Location is the time location in which both start and and shall be evaluated.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.HorizontalPodAutoscalerConfig>HorizontalPodAutoscalerConfig</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubeControllerManagerConfig>KubeControllerManagerConfig</a>)</p><p><p>HorizontalPodAutoscalerConfig contains horizontal pod autoscaler configuration settings for the kube-controller-manager.
Note: Descriptions were taken from the Kubernetes documentation.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>cpuInitializationPeriod</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>The period after which a ready pod transition is considered to be the first.</p></td></tr><tr><td><code>downscaleStabilization</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>The configurable window at which the controller will choose the highest recommendation for autoscaling.</p></td></tr><tr><td><code>initialReadinessDelay</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>The configurable period at which the horizontal pod autoscaler considers a Pod “not yet ready” given that it’s unready and it has transitioned to unready during that time.</p></td></tr><tr><td><code>syncPeriod</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>The period for syncing the number of pods in horizontal pod autoscaler.</p></td></tr><tr><td><code>tolerance</code></br><em>float64</em></td><td><em>(Optional)</em><p>The minimum change (from 1.0) in the desired-to-actual metrics ratio for the horizontal pod autoscaler to consider scaling.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Ingress>Ingress</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedSpec>SeedSpec</a>)</p><p><p>Ingress configures the Ingress specific settings of the Seed cluster</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>domain</code></br><em>string</em></td><td><p>Domain specifies the IngressDomain of the Seed cluster pointing to the ingress controller endpoint. It will be used
to construct ingress URLs for system applications running in Shoot clusters. Once set this field is immutable.</p></td></tr><tr><td><code>controller</code></br><em><a href=#core.gardener.cloud/v1beta1.IngressController>IngressController</a></em></td><td><p>Controller configures a Gardener managed Ingress Controller listening on the ingressDomain</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.IngressController>IngressController</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Ingress>Ingress</a>)</p><p><p>IngressController enables a Gardener managed Ingress Controller listening on the ingressDomain</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>kind</code></br><em>string</em></td><td><p>Kind defines which kind of IngressController to use, for example <code>nginx</code></p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig specifies infrastructure specific configuration for the ingressController</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.KubeAPIServerConfig>KubeAPIServerConfig</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Kubernetes>Kubernetes</a>)</p><p><p>KubeAPIServerConfig contains configuration settings for the kube-apiserver.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>KubernetesConfig</code></br><em><a href=#core.gardener.cloud/v1beta1.KubernetesConfig>KubernetesConfig</a></em></td><td><p>(Members of <code>KubernetesConfig</code> are embedded into this type.)</p></td></tr><tr><td><code>admissionPlugins</code></br><em><a href=#core.gardener.cloud/v1beta1.AdmissionPlugin>[]AdmissionPlugin</a></em></td><td><em>(Optional)</em><p>AdmissionPlugins contains the list of user-defined admission plugins (additional to those managed by Gardener), and, if desired, the corresponding
configuration.</p></td></tr><tr><td><code>apiAudiences</code></br><em>[]string</em></td><td><em>(Optional)</em><p>APIAudiences are the identifiers of the API. The service account token authenticator will
validate that tokens used against the API are bound to at least one of these audiences.
Defaults to [&ldquo;kubernetes&rdquo;].</p></td></tr><tr><td><code>auditConfig</code></br><em><a href=#core.gardener.cloud/v1beta1.AuditConfig>AuditConfig</a></em></td><td><em>(Optional)</em><p>AuditConfig contains configuration settings for the audit of the kube-apiserver.</p></td></tr><tr><td><code>enableBasicAuthentication</code></br><em>bool</em></td><td><em>(Optional)</em><p>EnableBasicAuthentication defines whether basic authentication should be enabled for this cluster or not.</p></td></tr><tr><td><code>oidcConfig</code></br><em><a href=#core.gardener.cloud/v1beta1.OIDCConfig>OIDCConfig</a></em></td><td><em>(Optional)</em><p>OIDCConfig contains configuration settings for the OIDC provider.</p></td></tr><tr><td><code>runtimeConfig</code></br><em>map[string]bool</em></td><td><em>(Optional)</em><p>RuntimeConfig contains information about enabled or disabled APIs.</p></td></tr><tr><td><code>serviceAccountConfig</code></br><em><a href=#core.gardener.cloud/v1beta1.ServiceAccountConfig>ServiceAccountConfig</a></em></td><td><em>(Optional)</em><p>ServiceAccountConfig contains configuration settings for the service account handling
of the kube-apiserver.</p></td></tr><tr><td><code>watchCacheSizes</code></br><em><a href=#core.gardener.cloud/v1beta1.WatchCacheSizes>WatchCacheSizes</a></em></td><td><em>(Optional)</em><p>WatchCacheSizes contains configuration of the API server&rsquo;s watch cache sizes.
Configuring these flags might be useful for large-scale Shoot clusters with a lot of parallel update requests
and a lot of watching controllers (e.g. large shooted Seed clusters). When the API server&rsquo;s watch cache&rsquo;s
capacity is too small to cope with the amount of update requests and watchers for a particular resource, it
might happen that controller watches are permanently stopped with <code>too old resource version</code> errors.
Starting from kubernetes v1.19, the API server&rsquo;s watch cache size is adapted dynamically and setting the watch
cache size flags will have no effect, except when setting it to 0 (which disables the watch cache).</p></td></tr><tr><td><code>requests</code></br><em><a href=#core.gardener.cloud/v1beta1.KubeAPIServerRequests>KubeAPIServerRequests</a></em></td><td><em>(Optional)</em><p>Requests contains configuration for request-specific settings for the kube-apiserver.</p></td></tr><tr><td><code>enableAnonymousAuthentication</code></br><em>bool</em></td><td><em>(Optional)</em><p>EnableAnonymousAuthentication defines whether anonymous requests to the secure port
of the API server should be allowed (flag <code>--anonymous-auth</code>).
See: <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/>https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/</a></p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.KubeAPIServerRequests>KubeAPIServerRequests</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubeAPIServerConfig>KubeAPIServerConfig</a>)</p><p><p>KubeAPIServerRequests contains configuration for request-specific settings for the kube-apiserver.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>maxNonMutatingInflight</code></br><em>int32</em></td><td><em>(Optional)</em><p>MaxNonMutatingInflight is the maximum number of non-mutating requests in flight at a given time. When the server
exceeds this, it rejects requests.</p></td></tr><tr><td><code>maxMutatingInflight</code></br><em>int32</em></td><td><em>(Optional)</em><p>MaxMutatingInflight is the maximum number of mutating requests in flight at a given time. When the server
exceeds this, it rejects requests.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.KubeControllerManagerConfig>KubeControllerManagerConfig</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Kubernetes>Kubernetes</a>)</p><p><p>KubeControllerManagerConfig contains configuration settings for the kube-controller-manager.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>KubernetesConfig</code></br><em><a href=#core.gardener.cloud/v1beta1.KubernetesConfig>KubernetesConfig</a></em></td><td><p>(Members of <code>KubernetesConfig</code> are embedded into this type.)</p></td></tr><tr><td><code>horizontalPodAutoscaler</code></br><em><a href=#core.gardener.cloud/v1beta1.HorizontalPodAutoscalerConfig>HorizontalPodAutoscalerConfig</a></em></td><td><em>(Optional)</em><p>HorizontalPodAutoscalerConfig contains horizontal pod autoscaler configuration settings for the kube-controller-manager.</p></td></tr><tr><td><code>nodeCIDRMaskSize</code></br><em>int32</em></td><td><em>(Optional)</em><p>NodeCIDRMaskSize defines the mask size for node cidr in cluster (default is 24)</p></td></tr><tr><td><code>podEvictionTimeout</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>PodEvictionTimeout defines the grace period for deleting pods on failed nodes. Defaults to 2m.</p></td></tr><tr><td><code>nodeMonitorGracePeriod</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>NodeMonitorGracePeriod defines the grace period before an unresponsive node is marked unhealthy.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.KubeProxyConfig>KubeProxyConfig</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Kubernetes>Kubernetes</a>)</p><p><p>KubeProxyConfig contains configuration settings for the kube-proxy.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>KubernetesConfig</code></br><em><a href=#core.gardener.cloud/v1beta1.KubernetesConfig>KubernetesConfig</a></em></td><td><p>(Members of <code>KubernetesConfig</code> are embedded into this type.)</p></td></tr><tr><td><code>mode</code></br><em><a href=#core.gardener.cloud/v1beta1.ProxyMode>ProxyMode</a></em></td><td><em>(Optional)</em><p>Mode specifies which proxy mode to use.
defaults to IPTables.</p></td></tr><tr><td><code>enabled</code></br><em>bool</em></td><td><em>(Optional)</em><p>Enabled indicates whether kube-proxy should be deployed or not.
Depending on the networking extensions switching kube-proxy off might be rejected. Consulting the respective documentation of the used networking extension is recommended before using this field.
defaults to true if not specified.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.KubeSchedulerConfig>KubeSchedulerConfig</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Kubernetes>Kubernetes</a>)</p><p><p>KubeSchedulerConfig contains configuration settings for the kube-scheduler.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>KubernetesConfig</code></br><em><a href=#core.gardener.cloud/v1beta1.KubernetesConfig>KubernetesConfig</a></em></td><td><p>(Members of <code>KubernetesConfig</code> are embedded into this type.)</p></td></tr><tr><td><code>kubeMaxPDVols</code></br><em>string</em></td><td><em>(Optional)</em><p>KubeMaxPDVols allows to configure the <code>KUBE_MAX_PD_VOLS</code> environment variable for the kube-scheduler.
Please find more information here: <a href=https://kubernetes.io/docs/concepts/storage/storage-limits/#custom-limits>https://kubernetes.io/docs/concepts/storage/storage-limits/#custom-limits</a>
Note that using this field is considered alpha-/experimental-level and is on your own risk. You should be aware
of all the side-effects and consequences when changing it.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.KubeletConfig>KubeletConfig</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Kubernetes>Kubernetes</a>,
<a href=#core.gardener.cloud/v1beta1.WorkerKubernetes>WorkerKubernetes</a>)</p><p><p>KubeletConfig contains configuration settings for the kubelet.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>KubernetesConfig</code></br><em><a href=#core.gardener.cloud/v1beta1.KubernetesConfig>KubernetesConfig</a></em></td><td><p>(Members of <code>KubernetesConfig</code> are embedded into this type.)</p></td></tr><tr><td><code>cpuCFSQuota</code></br><em>bool</em></td><td><em>(Optional)</em><p>CPUCFSQuota allows you to disable/enable CPU throttling for Pods.</p></td></tr><tr><td><code>cpuManagerPolicy</code></br><em>string</em></td><td><em>(Optional)</em><p>CPUManagerPolicy allows to set alternative CPU management policies (default: none).</p></td></tr><tr><td><code>evictionHard</code></br><em><a href=#core.gardener.cloud/v1beta1.KubeletConfigEviction>KubeletConfigEviction</a></em></td><td><em>(Optional)</em><p>EvictionHard describes a set of eviction thresholds (e.g. memory.available<1Gi) that if met would trigger a Pod eviction.
Default:
memory.available: &ldquo;100Mi/1Gi/5%&rdquo;
nodefs.available: &ldquo;5%&rdquo;
nodefs.inodesFree: &ldquo;5%&rdquo;
imagefs.available: &ldquo;5%&rdquo;
imagefs.inodesFree: &ldquo;5%&rdquo;</p></td></tr><tr><td><code>evictionMaxPodGracePeriod</code></br><em>int32</em></td><td><em>(Optional)</em><p>EvictionMaxPodGracePeriod describes the maximum allowed grace period (in seconds) to use when terminating pods in response to a soft eviction threshold being met.
Default: 90</p></td></tr><tr><td><code>evictionMinimumReclaim</code></br><em><a href=#core.gardener.cloud/v1beta1.KubeletConfigEvictionMinimumReclaim>KubeletConfigEvictionMinimumReclaim</a></em></td><td><em>(Optional)</em><p>EvictionMinimumReclaim configures the amount of resources below the configured eviction threshold that the kubelet attempts to reclaim whenever the kubelet observes resource pressure.
Default: 0 for each resource</p></td></tr><tr><td><code>evictionPressureTransitionPeriod</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>EvictionPressureTransitionPeriod is the duration for which the kubelet has to wait before transitioning out of an eviction pressure condition.
Default: 4m0s</p></td></tr><tr><td><code>evictionSoft</code></br><em><a href=#core.gardener.cloud/v1beta1.KubeletConfigEviction>KubeletConfigEviction</a></em></td><td><em>(Optional)</em><p>EvictionSoft describes a set of eviction thresholds (e.g. memory.available<1.5Gi) that if met over a corresponding grace period would trigger a Pod eviction.
Default:
memory.available: &ldquo;200Mi/1.5Gi/10%&rdquo;
nodefs.available: &ldquo;10%&rdquo;
nodefs.inodesFree: &ldquo;10%&rdquo;
imagefs.available: &ldquo;10%&rdquo;
imagefs.inodesFree: &ldquo;10%&rdquo;</p></td></tr><tr><td><code>evictionSoftGracePeriod</code></br><em><a href=#core.gardener.cloud/v1beta1.KubeletConfigEvictionSoftGracePeriod>KubeletConfigEvictionSoftGracePeriod</a></em></td><td><em>(Optional)</em><p>EvictionSoftGracePeriod describes a set of eviction grace periods (e.g. memory.available=1m30s) that correspond to how long a soft eviction threshold must hold before triggering a Pod eviction.
Default:
memory.available: 1m30s
nodefs.available: 1m30s
nodefs.inodesFree: 1m30s
imagefs.available: 1m30s
imagefs.inodesFree: 1m30s</p></td></tr><tr><td><code>maxPods</code></br><em>int32</em></td><td><em>(Optional)</em><p>MaxPods is the maximum number of Pods that are allowed by the Kubelet.
Default: 110</p></td></tr><tr><td><code>podPidsLimit</code></br><em>int64</em></td><td><em>(Optional)</em><p>PodPIDsLimit is the maximum number of process IDs per pod allowed by the kubelet.</p></td></tr><tr><td><code>imagePullProgressDeadline</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>ImagePullProgressDeadline describes the time limit under which if no pulling progress is made, the image pulling will be cancelled.
Default: 1m</p></td></tr><tr><td><code>failSwapOn</code></br><em>bool</em></td><td><em>(Optional)</em><p>FailSwapOn makes the Kubelet fail to start if swap is enabled on the node. (default true).</p></td></tr><tr><td><code>kubeReserved</code></br><em><a href=#core.gardener.cloud/v1beta1.KubeletConfigReserved>KubeletConfigReserved</a></em></td><td><em>(Optional)</em><p>KubeReserved is the configuration for resources reserved for kubernetes node components (mainly kubelet and container runtime).
When updating these values, be aware that cgroup resizes may not succeed on active worker nodes. Look for the NodeAllocatableEnforced event to determine if the configuration was applied.
Default: cpu=80m,memory=1Gi,pid=20k</p></td></tr><tr><td><code>systemReserved</code></br><em><a href=#core.gardener.cloud/v1beta1.KubeletConfigReserved>KubeletConfigReserved</a></em></td><td><em>(Optional)</em><p>SystemReserved is the configuration for resources reserved for system processes not managed by kubernetes (e.g. journald).
When updating these values, be aware that cgroup resizes may not succeed on active worker nodes. Look for the NodeAllocatableEnforced event to determine if the configuration was applied.</p></td></tr><tr><td><code>imageGCHighThresholdPercent</code></br><em>int32</em></td><td><em>(Optional)</em><p>ImageGCHighThresholdPercent describes the percent of the disk usage which triggers image garbage collection.
Default: 50</p></td></tr><tr><td><code>imageGCLowThresholdPercent</code></br><em>int32</em></td><td><em>(Optional)</em><p>ImageGCLowThresholdPercent describes the percent of the disk to which garbage collection attempts to free.
Default: 40</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.KubeletConfigEviction>KubeletConfigEviction</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubeletConfig>KubeletConfig</a>)</p><p><p>KubeletConfigEviction contains kubelet eviction thresholds supporting either a resource.Quantity or a percentage based value.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>memoryAvailable</code></br><em>string</em></td><td><em>(Optional)</em><p>MemoryAvailable is the threshold for the free memory on the host server.</p></td></tr><tr><td><code>imageFSAvailable</code></br><em>string</em></td><td><em>(Optional)</em><p>ImageFSAvailable is the threshold for the free disk space in the imagefs filesystem (docker images and container writable layers).</p></td></tr><tr><td><code>imageFSInodesFree</code></br><em>string</em></td><td><em>(Optional)</em><p>ImageFSInodesFree is the threshold for the available inodes in the imagefs filesystem.</p></td></tr><tr><td><code>nodeFSAvailable</code></br><em>string</em></td><td><em>(Optional)</em><p>NodeFSAvailable is the threshold for the free disk space in the nodefs filesystem (docker volumes, logs, etc).</p></td></tr><tr><td><code>nodeFSInodesFree</code></br><em>string</em></td><td><em>(Optional)</em><p>NodeFSInodesFree is the threshold for the available inodes in the nodefs filesystem.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.KubeletConfigEvictionMinimumReclaim>KubeletConfigEvictionMinimumReclaim</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubeletConfig>KubeletConfig</a>)</p><p><p>KubeletConfigEvictionMinimumReclaim contains configuration for the kubelet eviction minimum reclaim.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>memoryAvailable</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><em>(Optional)</em><p>MemoryAvailable is the threshold for the memory reclaim on the host server.</p></td></tr><tr><td><code>imageFSAvailable</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><em>(Optional)</em><p>ImageFSAvailable is the threshold for the disk space reclaim in the imagefs filesystem (docker images and container writable layers).</p></td></tr><tr><td><code>imageFSInodesFree</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><em>(Optional)</em><p>ImageFSInodesFree is the threshold for the inodes reclaim in the imagefs filesystem.</p></td></tr><tr><td><code>nodeFSAvailable</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><em>(Optional)</em><p>NodeFSAvailable is the threshold for the disk space reclaim in the nodefs filesystem (docker volumes, logs, etc).</p></td></tr><tr><td><code>nodeFSInodesFree</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><em>(Optional)</em><p>NodeFSInodesFree is the threshold for the inodes reclaim in the nodefs filesystem.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.KubeletConfigEvictionSoftGracePeriod>KubeletConfigEvictionSoftGracePeriod</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubeletConfig>KubeletConfig</a>)</p><p><p>KubeletConfigEvictionSoftGracePeriod contains grace periods for kubelet eviction thresholds.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>memoryAvailable</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>MemoryAvailable is the grace period for the MemoryAvailable eviction threshold.</p></td></tr><tr><td><code>imageFSAvailable</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>ImageFSAvailable is the grace period for the ImageFSAvailable eviction threshold.</p></td></tr><tr><td><code>imageFSInodesFree</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>ImageFSInodesFree is the grace period for the ImageFSInodesFree eviction threshold.</p></td></tr><tr><td><code>nodeFSAvailable</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>NodeFSAvailable is the grace period for the NodeFSAvailable eviction threshold.</p></td></tr><tr><td><code>nodeFSInodesFree</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>NodeFSInodesFree is the grace period for the NodeFSInodesFree eviction threshold.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.KubeletConfigReserved>KubeletConfigReserved</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubeletConfig>KubeletConfig</a>)</p><p><p>KubeletConfigReserved contains reserved resources for daemons</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>cpu</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><em>(Optional)</em><p>CPU is the reserved cpu.</p></td></tr><tr><td><code>memory</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><em>(Optional)</em><p>Memory is the reserved memory.</p></td></tr><tr><td><code>ephemeralStorage</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><em>(Optional)</em><p>EphemeralStorage is the reserved ephemeral-storage.</p></td></tr><tr><td><code>pid</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><em>(Optional)</em><p>PID is the reserved process-ids.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Kubernetes>Kubernetes</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a>)</p><p><p>Kubernetes contains the version and configuration variables for the Shoot control plane.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>allowPrivilegedContainers</code></br><em>bool</em></td><td><em>(Optional)</em><p>AllowPrivilegedContainers indicates whether privileged containers are allowed in the Shoot (default: true).</p></td></tr><tr><td><code>clusterAutoscaler</code></br><em><a href=#core.gardener.cloud/v1beta1.ClusterAutoscaler>ClusterAutoscaler</a></em></td><td><em>(Optional)</em><p>ClusterAutoscaler contains the configuration flags for the Kubernetes cluster autoscaler.</p></td></tr><tr><td><code>kubeAPIServer</code></br><em><a href=#core.gardener.cloud/v1beta1.KubeAPIServerConfig>KubeAPIServerConfig</a></em></td><td><em>(Optional)</em><p>KubeAPIServer contains configuration settings for the kube-apiserver.</p></td></tr><tr><td><code>kubeControllerManager</code></br><em><a href=#core.gardener.cloud/v1beta1.KubeControllerManagerConfig>KubeControllerManagerConfig</a></em></td><td><em>(Optional)</em><p>KubeControllerManager contains configuration settings for the kube-controller-manager.</p></td></tr><tr><td><code>kubeScheduler</code></br><em><a href=#core.gardener.cloud/v1beta1.KubeSchedulerConfig>KubeSchedulerConfig</a></em></td><td><em>(Optional)</em><p>KubeScheduler contains configuration settings for the kube-scheduler.</p></td></tr><tr><td><code>kubeProxy</code></br><em><a href=#core.gardener.cloud/v1beta1.KubeProxyConfig>KubeProxyConfig</a></em></td><td><em>(Optional)</em><p>KubeProxy contains configuration settings for the kube-proxy.</p></td></tr><tr><td><code>kubelet</code></br><em><a href=#core.gardener.cloud/v1beta1.KubeletConfig>KubeletConfig</a></em></td><td><em>(Optional)</em><p>Kubelet contains configuration settings for the kubelet.</p></td></tr><tr><td><code>version</code></br><em>string</em></td><td><p>Version is the semantic Kubernetes version to use for the Shoot cluster.</p></td></tr><tr><td><code>verticalPodAutoscaler</code></br><em><a href=#core.gardener.cloud/v1beta1.VerticalPodAutoscaler>VerticalPodAutoscaler</a></em></td><td><em>(Optional)</em><p>VerticalPodAutoscaler contains the configuration flags for the Kubernetes vertical pod autoscaler.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.KubernetesConfig>KubernetesConfig</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubeAPIServerConfig>KubeAPIServerConfig</a>,
<a href=#core.gardener.cloud/v1beta1.KubeControllerManagerConfig>KubeControllerManagerConfig</a>,
<a href=#core.gardener.cloud/v1beta1.KubeProxyConfig>KubeProxyConfig</a>,
<a href=#core.gardener.cloud/v1beta1.KubeSchedulerConfig>KubeSchedulerConfig</a>,
<a href=#core.gardener.cloud/v1beta1.KubeletConfig>KubeletConfig</a>)</p><p><p>KubernetesConfig contains common configuration fields for the control plane components.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>featureGates</code></br><em>map[string]bool</em></td><td><em>(Optional)</em><p>FeatureGates contains information about enabled feature gates.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.KubernetesDashboard>KubernetesDashboard</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Addons>Addons</a>)</p><p><p>KubernetesDashboard describes configuration values for the kubernetes-dashboard addon.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>Addon</code></br><em><a href=#core.gardener.cloud/v1beta1.Addon>Addon</a></em></td><td><p>(Members of <code>Addon</code> are embedded into this type.)</p></td></tr><tr><td><code>authenticationMode</code></br><em>string</em></td><td><em>(Optional)</em><p>AuthenticationMode defines the authentication mode for the kubernetes-dashboard.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.KubernetesInfo>KubernetesInfo</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ClusterInfo>ClusterInfo</a>)</p><p><p>KubernetesInfo contains the version and configuration variables for the Plant cluster.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>version</code></br><em>string</em></td><td><p>Version is the semantic Kubernetes version to use for the Plant cluster.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.KubernetesSettings>KubernetesSettings</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.CloudProfileSpec>CloudProfileSpec</a>)</p><p><p>KubernetesSettings contains constraints regarding allowed values of the &lsquo;kubernetes&rsquo; block in the Shoot specification.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>versions</code></br><em><a href=#core.gardener.cloud/v1beta1.ExpirableVersion>[]ExpirableVersion</a></em></td><td><em>(Optional)</em><p>Versions is the list of allowed Kubernetes versions with optional expiration dates for Shoot clusters.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.LastError>LastError</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.BackupBucketStatus>BackupBucketStatus</a>,
<a href=#core.gardener.cloud/v1beta1.BackupEntryStatus>BackupEntryStatus</a>,
<a href=#core.gardener.cloud/v1beta1.ShootStatus>ShootStatus</a>)</p><p><p>LastError indicates the last occurred error for an operation on a resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>description</code></br><em>string</em></td><td><p>A human readable message indicating details about the last error.</p></td></tr><tr><td><code>taskID</code></br><em>string</em></td><td><em>(Optional)</em><p>ID of the task which caused this last error</p></td></tr><tr><td><code>codes</code></br><em><a href=#core.gardener.cloud/v1beta1.ErrorCode>[]ErrorCode</a></em></td><td><em>(Optional)</em><p>Well-defined error codes of the last error(s).</p></td></tr><tr><td><code>lastUpdateTime</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#time-v1-meta>Kubernetes meta/v1.Time</a></em></td><td><em>(Optional)</em><p>Last time the error was reported</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.LastOperation>LastOperation</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.BackupBucketStatus>BackupBucketStatus</a>,
<a href=#core.gardener.cloud/v1beta1.BackupEntryStatus>BackupEntryStatus</a>,
<a href=#core.gardener.cloud/v1beta1.ShootStatus>ShootStatus</a>)</p><p><p>LastOperation indicates the type and the state of the last operation, along with a description
message and a progress indicator.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>description</code></br><em>string</em></td><td><p>A human readable message indicating details about the last operation.</p></td></tr><tr><td><code>lastUpdateTime</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#time-v1-meta>Kubernetes meta/v1.Time</a></em></td><td><p>Last time the operation state transitioned from one to another.</p></td></tr><tr><td><code>progress</code></br><em>int32</em></td><td><p>The progress in percentage (0-100) of the last operation.</p></td></tr><tr><td><code>state</code></br><em><a href=#core.gardener.cloud/v1beta1.LastOperationState>LastOperationState</a></em></td><td><p>Status of the last operation, one of Aborted, Processing, Succeeded, Error, Failed.</p></td></tr><tr><td><code>type</code></br><em><a href=#core.gardener.cloud/v1beta1.LastOperationType>LastOperationType</a></em></td><td><p>Type of the last operation, one of Create, Reconcile, Delete.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.LastOperationState>LastOperationState
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.LastOperation>LastOperation</a>)</p><p><p>LastOperationState is a string alias.</p></p><h3 id=core.gardener.cloud/v1beta1.LastOperationType>LastOperationType
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.LastOperation>LastOperation</a>)</p><p><p>LastOperationType is a string alias.</p></p><h3 id=core.gardener.cloud/v1beta1.Machine>Machine</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Worker>Worker</a>)</p><p><p>Machine contains information about the machine type and image.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></br><em>string</em></td><td><p>Type is the machine type of the worker group.</p></td></tr><tr><td><code>image</code></br><em><a href=#core.gardener.cloud/v1beta1.ShootMachineImage>ShootMachineImage</a></em></td><td><em>(Optional)</em><p>Image holds information about the machine image to use for all nodes of this pool. It will default to the
latest version of the first image stated in the referenced CloudProfile if no value has been provided.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.MachineControllerManagerSettings>MachineControllerManagerSettings</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Worker>Worker</a>)</p><p><p>MachineControllerManagerSettings contains configurations for different worker-pools. Eg. MachineDrainTimeout, MachineHealthTimeout.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>machineDrainTimeout</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>MachineDrainTimeout is the period after which machine is forcefully deleted.</p></td></tr><tr><td><code>machineHealthTimeout</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>MachineHealthTimeout is the period after which machine is declared failed.</p></td></tr><tr><td><code>machineCreationTimeout</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>MachineCreationTimeout is the period after which creation of the machine is declared failed.</p></td></tr><tr><td><code>maxEvictRetries</code></br><em>int32</em></td><td><em>(Optional)</em><p>MaxEvictRetries are the number of eviction retries on a pod after which drain is declared failed, and forceful deletion is triggered.</p></td></tr><tr><td><code>nodeConditions</code></br><em>[]string</em></td><td><em>(Optional)</em><p>NodeConditions are the set of conditions if set to true for the period of MachineHealthTimeout, machine will be declared failed.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.MachineImage>MachineImage</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.CloudProfileSpec>CloudProfileSpec</a>)</p><p><p>MachineImage defines the name and multiple versions of the machine image in any environment.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the name of the image.</p></td></tr><tr><td><code>versions</code></br><em><a href=#core.gardener.cloud/v1beta1.MachineImageVersion>[]MachineImageVersion</a></em></td><td><p>Versions contains versions, expiration dates and container runtimes of the machine image</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.MachineImageVersion>MachineImageVersion</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.MachineImage>MachineImage</a>)</p><p><p>MachineImageVersion is an expirable version with list of supported container runtimes and interfaces</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>ExpirableVersion</code></br><em><a href=#core.gardener.cloud/v1beta1.ExpirableVersion>ExpirableVersion</a></em></td><td><p>(Members of <code>ExpirableVersion</code> are embedded into this type.)</p></td></tr><tr><td><code>cri</code></br><em><a href=#core.gardener.cloud/v1beta1.CRI>[]CRI</a></em></td><td><em>(Optional)</em><p>CRI list of supported container runtime and interfaces supported by this version</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.MachineType>MachineType</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.CloudProfileSpec>CloudProfileSpec</a>)</p><p><p>MachineType contains certain properties of a machine type.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>cpu</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><p>CPU is the number of CPUs for this machine type.</p></td></tr><tr><td><code>gpu</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><p>GPU is the number of GPUs for this machine type.</p></td></tr><tr><td><code>memory</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><p>Memory is the amount of memory for this machine type.</p></td></tr><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the name of the machine type.</p></td></tr><tr><td><code>storage</code></br><em><a href=#core.gardener.cloud/v1beta1.MachineTypeStorage>MachineTypeStorage</a></em></td><td><em>(Optional)</em><p>Storage is the amount of storage associated with the root volume of this machine type.</p></td></tr><tr><td><code>usable</code></br><em>bool</em></td><td><em>(Optional)</em><p>Usable defines if the machine type can be used for shoot clusters.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.MachineTypeStorage>MachineTypeStorage</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.MachineType>MachineType</a>)</p><p><p>MachineTypeStorage is the amount of storage associated with the root volume of this machine type.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>class</code></br><em>string</em></td><td><p>Class is the class of the storage type.</p></td></tr><tr><td><code>size</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><em>(Optional)</em><p>StorageSize is the storage size.</p></td></tr><tr><td><code>type</code></br><em>string</em></td><td><p>Type is the type of the storage.</p></td></tr><tr><td><code>minSize</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><em>(Optional)</em><p>MinSize is the minimal supported storage size.
This overrides any other common minimum size configuration from <code>spec.volumeTypes[*].minSize</code>.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Maintenance>Maintenance</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a>)</p><p><p>Maintenance contains information about the time window for maintenance operations and which
operations should be performed.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>autoUpdate</code></br><em><a href=#core.gardener.cloud/v1beta1.MaintenanceAutoUpdate>MaintenanceAutoUpdate</a></em></td><td><em>(Optional)</em><p>AutoUpdate contains information about which constraints should be automatically updated.</p></td></tr><tr><td><code>timeWindow</code></br><em><a href=#core.gardener.cloud/v1beta1.MaintenanceTimeWindow>MaintenanceTimeWindow</a></em></td><td><em>(Optional)</em><p>TimeWindow contains information about the time window for maintenance operations.</p></td></tr><tr><td><code>confineSpecUpdateRollout</code></br><em>bool</em></td><td><em>(Optional)</em><p>ConfineSpecUpdateRollout prevents that changes/updates to the shoot specification will be rolled out immediately.
Instead, they are rolled out during the shoot&rsquo;s maintenance time window. There is one exception that will trigger
an immediate roll out which is changes to the Spec.Hibernation.Enabled field.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.MaintenanceAutoUpdate>MaintenanceAutoUpdate</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Maintenance>Maintenance</a>)</p><p><p>MaintenanceAutoUpdate contains information about which constraints should be automatically updated.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>kubernetesVersion</code></br><em>bool</em></td><td><p>KubernetesVersion indicates whether the patch Kubernetes version may be automatically updated (default: true).</p></td></tr><tr><td><code>machineImageVersion</code></br><em>bool</em></td><td><p>MachineImageVersion indicates whether the machine image version may be automatically updated (default: true).</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.MaintenanceTimeWindow>MaintenanceTimeWindow</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Maintenance>Maintenance</a>)</p><p><p>MaintenanceTimeWindow contains information about the time window for maintenance operations.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>begin</code></br><em>string</em></td><td><p>Begin is the beginning of the time window in the format HHMMSS+ZONE, e.g. &ldquo;220000+0100&rdquo;.
If not present, a random value will be computed.</p></td></tr><tr><td><code>end</code></br><em>string</em></td><td><p>End is the end of the time window in the format HHMMSS+ZONE, e.g. &ldquo;220000+0100&rdquo;.
If not present, the value will be computed based on the &ldquo;Begin&rdquo; value.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Monitoring>Monitoring</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a>)</p><p><p>Monitoring contains information about the monitoring configuration for the shoot.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>alerting</code></br><em><a href=#core.gardener.cloud/v1beta1.Alerting>Alerting</a></em></td><td><em>(Optional)</em><p>Alerting contains information about the alerting configuration for the shoot cluster.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.NamedResourceReference>NamedResourceReference</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a>)</p><p><p>NamedResourceReference is a named reference to a resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name of the resource reference.</p></td></tr><tr><td><code>resourceRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#crossversionobjectreference-v1-autoscaling>Kubernetes autoscaling/v1.CrossVersionObjectReference</a></em></td><td><p>ResourceRef is a reference to a resource.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Networking>Networking</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a>)</p><p><p>Networking defines networking parameters for the shoot cluster.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></br><em>string</em></td><td><p>Type identifies the type of the networking plugin.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig is the configuration passed to network resource.</p></td></tr><tr><td><code>pods</code></br><em>string</em></td><td><em>(Optional)</em><p>Pods is the CIDR of the pod network.</p></td></tr><tr><td><code>nodes</code></br><em>string</em></td><td><em>(Optional)</em><p>Nodes is the CIDR of the entire node network.</p></td></tr><tr><td><code>services</code></br><em>string</em></td><td><em>(Optional)</em><p>Services is the CIDR of the service network.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.NginxIngress>NginxIngress</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Addons>Addons</a>)</p><p><p>NginxIngress describes configuration values for the nginx-ingress addon.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>Addon</code></br><em><a href=#core.gardener.cloud/v1beta1.Addon>Addon</a></em></td><td><p>(Members of <code>Addon</code> are embedded into this type.)</p></td></tr><tr><td><code>loadBalancerSourceRanges</code></br><em>[]string</em></td><td><em>(Optional)</em><p>LoadBalancerSourceRanges is list of allowed IP sources for NginxIngress</p></td></tr><tr><td><code>config</code></br><em>map[string]string</em></td><td><em>(Optional)</em><p>Config contains custom configuration for the nginx-ingress-controller configuration.
See <a href=https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/configmap.md#configuration-options>https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/configmap.md#configuration-options</a></p></td></tr><tr><td><code>externalTrafficPolicy</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#serviceexternaltrafficpolicytype-v1-core>Kubernetes core/v1.ServiceExternalTrafficPolicyType</a></em></td><td><em>(Optional)</em><p>ExternalTrafficPolicy controls the <code>.spec.externalTrafficPolicy</code> value of the load balancer <code>Service</code>
exposing the nginx-ingress. Defaults to <code>Cluster</code>.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.OIDCConfig>OIDCConfig</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubeAPIServerConfig>KubeAPIServerConfig</a>)</p><p><p>OIDCConfig contains configuration settings for the OIDC provider.
Note: Descriptions were taken from the Kubernetes documentation.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>caBundle</code></br><em>string</em></td><td><em>(Optional)</em><p>If set, the OpenID server&rsquo;s certificate will be verified by one of the authorities in the oidc-ca-file, otherwise the host&rsquo;s root CA set will be used.</p></td></tr><tr><td><code>clientAuthentication</code></br><em><a href=#core.gardener.cloud/v1beta1.OpenIDConnectClientAuthentication>OpenIDConnectClientAuthentication</a></em></td><td><em>(Optional)</em><p>ClientAuthentication can optionally contain client configuration used for kubeconfig generation.</p></td></tr><tr><td><code>clientID</code></br><em>string</em></td><td><em>(Optional)</em><p>The client ID for the OpenID Connect client, must be set if oidc-issuer-url is set.</p></td></tr><tr><td><code>groupsClaim</code></br><em>string</em></td><td><em>(Optional)</em><p>If provided, the name of a custom OpenID Connect claim for specifying user groups. The claim value is expected to be a string or array of strings. This flag is experimental, please see the authentication documentation for further details.</p></td></tr><tr><td><code>groupsPrefix</code></br><em>string</em></td><td><em>(Optional)</em><p>If provided, all groups will be prefixed with this value to prevent conflicts with other authentication strategies.</p></td></tr><tr><td><code>issuerURL</code></br><em>string</em></td><td><em>(Optional)</em><p>The URL of the OpenID issuer, only HTTPS scheme will be accepted. If set, it will be used to verify the OIDC JSON Web Token (JWT).</p></td></tr><tr><td><code>requiredClaims</code></br><em>map[string]string</em></td><td><em>(Optional)</em><p>key=value pairs that describes a required claim in the ID Token. If set, the claim is verified to be present in the ID Token with a matching value.</p></td></tr><tr><td><code>signingAlgs</code></br><em>[]string</em></td><td><em>(Optional)</em><p>List of allowed JOSE asymmetric signing algorithms. JWTs with a &lsquo;alg&rsquo; header value not in this list will be rejected. Values are defined by RFC 7518 <a href=https://tools.ietf.org/html/rfc7518#section-3.1>https://tools.ietf.org/html/rfc7518#section-3.1</a></p></td></tr><tr><td><code>usernameClaim</code></br><em>string</em></td><td><em>(Optional)</em><p>The OpenID claim to use as the user name. Note that claims other than the default (&lsquo;sub&rsquo;) is not guaranteed to be unique and immutable. This flag is experimental, please see the authentication documentation for further details. (default &ldquo;sub&rdquo;)</p></td></tr><tr><td><code>usernamePrefix</code></br><em>string</em></td><td><em>(Optional)</em><p>If provided, all usernames will be prefixed with this value. If not provided, username claims other than &lsquo;email&rsquo; are prefixed by the issuer URL to avoid clashes. To skip any prefixing, provide the value &lsquo;-&rsquo;.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.OpenIDConnectClientAuthentication>OpenIDConnectClientAuthentication</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.OIDCConfig>OIDCConfig</a>)</p><p><p>OpenIDConnectClientAuthentication contains configuration for OIDC clients.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>extraConfig</code></br><em>map[string]string</em></td><td><em>(Optional)</em><p>Extra configuration added to kubeconfig&rsquo;s auth-provider.
Must not be any of idp-issuer-url, client-id, client-secret, idp-certificate-authority, idp-certificate-authority-data, id-token or refresh-token</p></td></tr><tr><td><code>secret</code></br><em>string</em></td><td><em>(Optional)</em><p>The client Secret for the OpenID Connect client.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.PlantSpec>PlantSpec</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Plant>Plant</a>)</p><p><p>PlantSpec is the specification of a Plant.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#localobjectreference-v1-core>Kubernetes core/v1.LocalObjectReference</a></em></td><td><p>SecretRef is a reference to a Secret object containing the Kubeconfig of the external kubernetes
clusters to be added to Gardener.</p></td></tr><tr><td><code>endpoints</code></br><em><a href=#core.gardener.cloud/v1beta1.Endpoint>[]Endpoint</a></em></td><td><em>(Optional)</em><p>Endpoints is the configuration plant endpoints</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.PlantStatus>PlantStatus</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Plant>Plant</a>)</p><p><p>PlantStatus is the status of a Plant.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>conditions</code></br><em><a href=#core.gardener.cloud/v1beta1.Condition>[]Condition</a></em></td><td><em>(Optional)</em><p>Conditions represents the latest available observations of a Plant&rsquo;s current state.</p></td></tr><tr><td><code>observedGeneration</code></br><em>int64</em></td><td><em>(Optional)</em><p>ObservedGeneration is the most recent generation observed for this Plant. It corresponds to the
Plant&rsquo;s generation, which is updated on mutation by the API Server.</p></td></tr><tr><td><code>clusterInfo</code></br><em><a href=#core.gardener.cloud/v1beta1.ClusterInfo>ClusterInfo</a></em></td><td><p>ClusterInfo is additional computed information about the newly added cluster (Plant)</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ProjectMember>ProjectMember</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ProjectSpec>ProjectSpec</a>)</p><p><p>ProjectMember is a member of a project.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>Subject</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#subject-v1-rbac>Kubernetes rbac/v1.Subject</a></em></td><td><p>(Members of <code>Subject</code> are embedded into this type.)</p><p>Subject is representing a user name, an email address, or any other identifier of a user, group, or service
account that has a certain role.</p></td></tr><tr><td><code>role</code></br><em>string</em></td><td><p>Role represents the role of this member.
IMPORTANT: Be aware that this field will be removed in the <code>v1</code> version of this API in favor of the <code>roles</code>
list.
TODO: Remove this field in favor of the <code>roles</code> list in <code>v1</code>.</p></td></tr><tr><td><code>roles</code></br><em>[]string</em></td><td><em>(Optional)</em><p>Roles represents the list of roles of this member.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ProjectPhase>ProjectPhase
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ProjectStatus>ProjectStatus</a>)</p><p><p>ProjectPhase is a label for the condition of a project at the current time.</p></p><h3 id=core.gardener.cloud/v1beta1.ProjectSpec>ProjectSpec</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Project>Project</a>)</p><p><p>ProjectSpec is the specification of a Project.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>createdBy</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#subject-v1-rbac>Kubernetes rbac/v1.Subject</a></em></td><td><em>(Optional)</em><p>CreatedBy is a subject representing a user name, an email address, or any other identifier of a user
who created the project.</p></td></tr><tr><td><code>description</code></br><em>string</em></td><td><em>(Optional)</em><p>Description is a human-readable description of what the project is used for.</p></td></tr><tr><td><code>owner</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#subject-v1-rbac>Kubernetes rbac/v1.Subject</a></em></td><td><em>(Optional)</em><p>Owner is a subject representing a user name, an email address, or any other identifier of a user owning
the project.
IMPORTANT: Be aware that this field will be removed in the <code>v1</code> version of this API in favor of the <code>owner</code>
role. The only way to change the owner will be by moving the <code>owner</code> role. In this API version the only way
to change the owner is to use this field.
TODO: Remove this field in favor of the <code>owner</code> role in <code>v1</code>.</p></td></tr><tr><td><code>purpose</code></br><em>string</em></td><td><em>(Optional)</em><p>Purpose is a human-readable explanation of the project&rsquo;s purpose.</p></td></tr><tr><td><code>members</code></br><em><a href=#core.gardener.cloud/v1beta1.ProjectMember>[]ProjectMember</a></em></td><td><em>(Optional)</em><p>Members is a list of subjects representing a user name, an email address, or any other identifier of a user,
group, or service account that has a certain role.</p></td></tr><tr><td><code>namespace</code></br><em>string</em></td><td><em>(Optional)</em><p>Namespace is the name of the namespace that has been created for the Project object.
A nil value means that Gardener will determine the name of the namespace.</p></td></tr><tr><td><code>tolerations</code></br><em><a href=#core.gardener.cloud/v1beta1.ProjectTolerations>ProjectTolerations</a></em></td><td><em>(Optional)</em><p>Tolerations contains the tolerations for taints on seed clusters.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ProjectStatus>ProjectStatus</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Project>Project</a>)</p><p><p>ProjectStatus holds the most recently observed status of the project.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>observedGeneration</code></br><em>int64</em></td><td><em>(Optional)</em><p>ObservedGeneration is the most recent generation observed for this project.</p></td></tr><tr><td><code>phase</code></br><em><a href=#core.gardener.cloud/v1beta1.ProjectPhase>ProjectPhase</a></em></td><td><p>Phase is the current phase of the project.</p></td></tr><tr><td><code>staleSinceTimestamp</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#time-v1-meta>Kubernetes meta/v1.Time</a></em></td><td><em>(Optional)</em><p>StaleSinceTimestamp contains the timestamp when the project was first discovered to be stale/unused.</p></td></tr><tr><td><code>staleAutoDeleteTimestamp</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#time-v1-meta>Kubernetes meta/v1.Time</a></em></td><td><em>(Optional)</em><p>StaleAutoDeleteTimestamp contains the timestamp when the project will be garbage-collected/automatically deleted
because it&rsquo;s stale/unused.</p></td></tr><tr><td><code>lastActivityTimestamp</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#time-v1-meta>Kubernetes meta/v1.Time</a></em></td><td><em>(Optional)</em><p>LastActivityTimestamp contains the timestamp from the last activity performed in this project.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ProjectTolerations>ProjectTolerations</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ProjectSpec>ProjectSpec</a>)</p><p><p>ProjectTolerations contains the tolerations for taints on seed clusters.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>defaults</code></br><em><a href=#core.gardener.cloud/v1beta1.Toleration>[]Toleration</a></em></td><td><em>(Optional)</em><p>Defaults contains a list of tolerations that are added to the shoots in this project by default.</p></td></tr><tr><td><code>whitelist</code></br><em><a href=#core.gardener.cloud/v1beta1.Toleration>[]Toleration</a></em></td><td><em>(Optional)</em><p>Whitelist contains a list of tolerations that are allowed to be added to the shoots in this project. Please note
that this list may only be added by users having the <code>spec-tolerations-whitelist</code> verb for project resources.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Provider>Provider</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a>)</p><p><p>Provider contains provider-specific information that are handed-over to the provider-specific
extension controller.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></br><em>string</em></td><td><p>Type is the type of the provider.</p></td></tr><tr><td><code>controlPlaneConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ControlPlaneConfig contains the provider-specific control plane config blob. Please look up the concrete
definition in the documentation of your provider extension.</p></td></tr><tr><td><code>infrastructureConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>InfrastructureConfig contains the provider-specific infrastructure config blob. Please look up the concrete
definition in the documentation of your provider extension.</p></td></tr><tr><td><code>workers</code></br><em><a href=#core.gardener.cloud/v1beta1.Worker>[]Worker</a></em></td><td><p>Workers is a list of worker groups.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ProxyMode>ProxyMode
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubeProxyConfig>KubeProxyConfig</a>)</p><p><p>ProxyMode available in Linux platform: &lsquo;userspace&rsquo; (older, going to be EOL), &lsquo;iptables&rsquo;
(newer, faster), &lsquo;ipvs&rsquo; (newest, better in performance and scalability).
As of now only &lsquo;iptables&rsquo; and &lsquo;ipvs&rsquo; is supported by Gardener.
In Linux platform, if the iptables proxy is selected, regardless of how, but the system&rsquo;s kernel or iptables versions are
insufficient, this always falls back to the userspace proxy. IPVS mode will be enabled when proxy mode is set to &lsquo;ipvs&rsquo;,
and the fall back path is firstly iptables and then userspace.</p></p><h3 id=core.gardener.cloud/v1beta1.QuotaSpec>QuotaSpec</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Quota>Quota</a>)</p><p><p>QuotaSpec is the specification of a Quota.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>clusterLifetimeDays</code></br><em>int32</em></td><td><em>(Optional)</em><p>ClusterLifetimeDays is the lifetime of a Shoot cluster in days before it will be terminated automatically.</p></td></tr><tr><td><code>metrics</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#resourcelist-v1-core>Kubernetes core/v1.ResourceList</a></em></td><td><p>Metrics is a list of resources which will be put under constraints.</p></td></tr><tr><td><code>scope</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectreference-v1-core>Kubernetes core/v1.ObjectReference</a></em></td><td><p>Scope is the scope of the Quota object, either &lsquo;project&rsquo; or &lsquo;secret&rsquo;.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Region>Region</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.CloudProfileSpec>CloudProfileSpec</a>)</p><p><p>Region contains certain properties of a region.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name is a region name.</p></td></tr><tr><td><code>zones</code></br><em><a href=#core.gardener.cloud/v1beta1.AvailabilityZone>[]AvailabilityZone</a></em></td><td><em>(Optional)</em><p>Zones is a list of availability zones in this region.</p></td></tr><tr><td><code>labels</code></br><em>map[string]string</em></td><td><em>(Optional)</em><p>Labels is an optional set of key-value pairs that contain certain administrator-controlled labels for this region.
It can be used by Gardener administrators/operators to provide additional information about a region, e.g. wrt
quality, reliability, access restrictions, etc.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ResourceWatchCacheSize>ResourceWatchCacheSize</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.WatchCacheSizes>WatchCacheSizes</a>)</p><p><p>ResourceWatchCacheSize contains configuration of the API server&rsquo;s watch cache size for one specific resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiGroup</code></br><em>string</em></td><td><em>(Optional)</em><p>APIGroup is the API group of the resource for which the watch cache size should be configured.
An unset value is used to specify the legacy core API (e.g. for <code>secrets</code>).</p></td></tr><tr><td><code>resource</code></br><em>string</em></td><td><p>Resource is the name of the resource for which the watch cache size should be configured
(in lowercase plural form, e.g. <code>secrets</code>).</p></td></tr><tr><td><code>size</code></br><em>int32</em></td><td><p>CacheSize specifies the watch cache size that should be configured for the specified resource.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedBackup>SeedBackup</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedSpec>SeedSpec</a>)</p><p><p>SeedBackup contains the object store configuration for backups for shoot (currently only etcd).</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>provider</code></br><em>string</em></td><td><p>Provider is a provider name.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig is the configuration passed to BackupBucket resource.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><em>(Optional)</em><p>Region is a region name.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a Secret object containing the cloud provider credentials for
the object store where backups should be stored. It should have enough privileges to manipulate
the objects as well as buckets.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedDNS>SeedDNS</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedSpec>SeedSpec</a>)</p><p><p>SeedDNS contains DNS-relevant information about this seed cluster.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>ingressDomain</code></br><em>string</em></td><td><em>(Optional)</em><p>IngressDomain is the domain of the Seed cluster pointing to the ingress controller endpoint. It will be used
to construct ingress URLs for system applications running in Shoot clusters. Once set this field is immutable.
This will be removed in the next API version and replaced by spec.ingress.domain.</p></td></tr><tr><td><code>provider</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedDNSProvider>SeedDNSProvider</a></em></td><td><em>(Optional)</em><p>Provider configures a DNSProvider</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedDNSProvider>SeedDNSProvider</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedDNS>SeedDNS</a>)</p><p><p>SeedDNSProvider configures a DNSProvider for Seeds</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></br><em>string</em></td><td><p>Type describes the type of the dns-provider, for example <code>aws-route53</code></p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a Secret object containing cloud provider credentials used for registering external domains.</p></td></tr><tr><td><code>domains</code></br><em><a href=#core.gardener.cloud/v1beta1.DNSIncludeExclude>DNSIncludeExclude</a></em></td><td><em>(Optional)</em><p>Domains contains information about which domains shall be included/excluded for this provider.</p></td></tr><tr><td><code>zones</code></br><em><a href=#core.gardener.cloud/v1beta1.DNSIncludeExclude>DNSIncludeExclude</a></em></td><td><em>(Optional)</em><p>Zones contains information about which hosted zones shall be included/excluded for this provider.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedNetworks>SeedNetworks</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedSpec>SeedSpec</a>)</p><p><p>SeedNetworks contains CIDRs for the pod, service and node networks of a Kubernetes cluster.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>nodes</code></br><em>string</em></td><td><em>(Optional)</em><p>Nodes is the CIDR of the node network.</p></td></tr><tr><td><code>pods</code></br><em>string</em></td><td><p>Pods is the CIDR of the pod network.</p></td></tr><tr><td><code>services</code></br><em>string</em></td><td><p>Services is the CIDR of the service network.</p></td></tr><tr><td><code>shootDefaults</code></br><em><a href=#core.gardener.cloud/v1beta1.ShootNetworks>ShootNetworks</a></em></td><td><em>(Optional)</em><p>ShootDefaults contains the default networks CIDRs for shoots.</p></td></tr><tr><td><code>blockCIDRs</code></br><em>[]string</em></td><td><em>(Optional)</em><p>BlockCIDRs is a list of network addresses that should be blocked for shoot control plane components running
in the seed cluster.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedProvider>SeedProvider</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedSpec>SeedSpec</a>)</p><p><p>SeedProvider defines the provider type and region for this Seed cluster.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></br><em>string</em></td><td><p>Type is the name of the provider.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig is the configuration passed to Seed resource.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is a name of a region.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedSelector>SeedSelector</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.CloudProfileSpec>CloudProfileSpec</a>,
<a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a>)</p><p><p>SeedSelector contains constraints for selecting seed to be usable for shoots using a profile</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>LabelSelector</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#labelselector-v1-meta>Kubernetes meta/v1.LabelSelector</a></em></td><td><p>(Members of <code>LabelSelector</code> are embedded into this type.)</p><em>(Optional)</em><p>LabelSelector is optional and can be used to select seeds by their label settings</p></td></tr><tr><td><code>providerTypes</code></br><em>[]string</em></td><td><em>(Optional)</em><p>Providers is optional and can be used by restricting seeds by their provider type. &lsquo;*&rsquo; can be used to enable seeds regardless of their provider type.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedSettingExcessCapacityReservation>SeedSettingExcessCapacityReservation</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedSettings>SeedSettings</a>)</p><p><p>SeedSettingExcessCapacityReservation controls the excess capacity reservation for shoot control planes in the seed.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>enabled</code></br><em>bool</em></td><td><p>Enabled controls whether the excess capacity reservation should be enabled.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedSettingLoadBalancerServices>SeedSettingLoadBalancerServices</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedSettings>SeedSettings</a>)</p><p><p>SeedSettingLoadBalancerServices controls certain settings for services of type load balancer that are created in the
seed.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>annotations</code></br><em>map[string]string</em></td><td><em>(Optional)</em><p>Annotations is a map of annotations that will be injected/merged into every load balancer service object.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedSettingScheduling>SeedSettingScheduling</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedSettings>SeedSettings</a>)</p><p><p>SeedSettingScheduling controls settings for scheduling decisions for the seed.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>visible</code></br><em>bool</em></td><td><p>Visible controls whether the gardener-scheduler shall consider this seed when scheduling shoots. Invisible seeds
are not considered by the scheduler.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedSettingShootDNS>SeedSettingShootDNS</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedSettings>SeedSettings</a>)</p><p><p>SeedSettingShootDNS controls the shoot DNS settings for the seed.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>enabled</code></br><em>bool</em></td><td><p>Enabled controls whether the DNS for shoot clusters should be enabled. When disabled then all shoots using the
seed won&rsquo;t get any DNS providers, DNS records, and no DNS extension controller is required to be installed here.
This is useful for environments where DNS is not required.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedSettingVerticalPodAutoscaler>SeedSettingVerticalPodAutoscaler</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedSettings>SeedSettings</a>)</p><p><p>SeedSettingVerticalPodAutoscaler controls certain settings for the vertical pod autoscaler components deployed in the
seed.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>enabled</code></br><em>bool</em></td><td><p>Enabled controls whether the VPA components shall be deployed into the garden namespace in the seed cluster. It
is enabled by default because Gardener heavily relies on a VPA being deployed. You should only disable this if
your seed cluster already has another, manually/custom managed VPA deployment.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedSettings>SeedSettings</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedSpec>SeedSpec</a>)</p><p><p>SeedSettings contains certain settings for this seed cluster.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>excessCapacityReservation</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSettingExcessCapacityReservation>SeedSettingExcessCapacityReservation</a></em></td><td><em>(Optional)</em><p>ExcessCapacityReservation controls the excess capacity reservation for shoot control planes in the seed.</p></td></tr><tr><td><code>scheduling</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSettingScheduling>SeedSettingScheduling</a></em></td><td><em>(Optional)</em><p>Scheduling controls settings for scheduling decisions for the seed.</p></td></tr><tr><td><code>shootDNS</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSettingShootDNS>SeedSettingShootDNS</a></em></td><td><em>(Optional)</em><p>ShootDNS controls the shoot DNS settings for the seed.</p></td></tr><tr><td><code>loadBalancerServices</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSettingLoadBalancerServices>SeedSettingLoadBalancerServices</a></em></td><td><em>(Optional)</em><p>LoadBalancerServices controls certain settings for services of type load balancer that are created in the seed.</p></td></tr><tr><td><code>verticalPodAutoscaler</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSettingVerticalPodAutoscaler>SeedSettingVerticalPodAutoscaler</a></em></td><td><em>(Optional)</em><p>VerticalPodAutoscaler controls certain settings for the vertical pod autoscaler components deployed in the seed.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedSpec>SeedSpec</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Seed>Seed</a>,
<a href=#core.gardener.cloud/v1beta1.SeedTemplate>SeedTemplate</a>)</p><p><p>SeedSpec is the specification of a Seed.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>backup</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedBackup>SeedBackup</a></em></td><td><em>(Optional)</em><p>Backup holds the object store configuration for the backups of shoot (currently only etcd).
If it is not specified, then there won&rsquo;t be any backups taken for shoots associated with this seed.
If backup field is present in seed, then backups of the etcd from shoot control plane will be stored
under the configured object store.</p></td></tr><tr><td><code>dns</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedDNS>SeedDNS</a></em></td><td><p>DNS contains DNS-relevant information about this seed cluster.</p></td></tr><tr><td><code>networks</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedNetworks>SeedNetworks</a></em></td><td><p>Networks defines the pod, service and worker network of the Seed cluster.</p></td></tr><tr><td><code>provider</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedProvider>SeedProvider</a></em></td><td><p>Provider defines the provider type and region for this Seed cluster.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><em>(Optional)</em><p>SecretRef is a reference to a Secret object containing the Kubeconfig and the cloud provider credentials for
the account the Seed cluster has been deployed to.</p></td></tr><tr><td><code>taints</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedTaint>[]SeedTaint</a></em></td><td><em>(Optional)</em><p>Taints describes taints on the seed.</p></td></tr><tr><td><code>volume</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedVolume>SeedVolume</a></em></td><td><em>(Optional)</em><p>Volume contains settings for persistentvolumes created in the seed cluster.</p></td></tr><tr><td><code>settings</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSettings>SeedSettings</a></em></td><td><em>(Optional)</em><p>Settings contains certain settings for this seed cluster.</p></td></tr><tr><td><code>ingress</code></br><em><a href=#core.gardener.cloud/v1beta1.Ingress>Ingress</a></em></td><td><em>(Optional)</em><p>Ingress configures Ingress specific settings of the Seed cluster.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedStatus>SeedStatus</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Seed>Seed</a>)</p><p><p>SeedStatus is the status of a Seed.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>gardener</code></br><em><a href=#core.gardener.cloud/v1beta1.Gardener>Gardener</a></em></td><td><em>(Optional)</em><p>Gardener holds information about the Gardener which last acted on the Shoot.</p></td></tr><tr><td><code>kubernetesVersion</code></br><em>string</em></td><td><em>(Optional)</em><p>KubernetesVersion is the Kubernetes version of the seed cluster.</p></td></tr><tr><td><code>conditions</code></br><em><a href=#core.gardener.cloud/v1beta1.Condition>[]Condition</a></em></td><td><em>(Optional)</em><p>Conditions represents the latest available observations of a Seed&rsquo;s current state.</p></td></tr><tr><td><code>observedGeneration</code></br><em>int64</em></td><td><em>(Optional)</em><p>ObservedGeneration is the most recent generation observed for this Seed. It corresponds to the
Seed&rsquo;s generation, which is updated on mutation by the API Server.</p></td></tr><tr><td><code>clusterIdentity</code></br><em>string</em></td><td><em>(Optional)</em><p>ClusterIdentity is the identity of the Seed cluster</p></td></tr><tr><td><code>capacity</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#resourcelist-v1-core>Kubernetes core/v1.ResourceList</a></em></td><td><em>(Optional)</em><p>Capacity represents the total resources of a seed.</p></td></tr><tr><td><code>allocatable</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#resourcelist-v1-core>Kubernetes core/v1.ResourceList</a></em></td><td><em>(Optional)</em><p>Allocatable represents the resources of a seed that are available for scheduling.
Defaults to Capacity.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedTaint>SeedTaint</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedSpec>SeedSpec</a>)</p><p><p>SeedTaint describes a taint on a seed.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>key</code></br><em>string</em></td><td><p>Key is the taint key to be applied to a seed.</p></td></tr><tr><td><code>value</code></br><em>string</em></td><td><em>(Optional)</em><p>Value is the taint value corresponding to the taint key.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedTemplate>SeedTemplate</h3><p><p>SeedTemplate is a template for creating a Seed object.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSpec>SeedSpec</a></em></td><td><em>(Optional)</em><p>Specification of the desired behavior of the Seed.</p><br><br><table><tr><td><code>backup</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedBackup>SeedBackup</a></em></td><td><em>(Optional)</em><p>Backup holds the object store configuration for the backups of shoot (currently only etcd).
If it is not specified, then there won&rsquo;t be any backups taken for shoots associated with this seed.
If backup field is present in seed, then backups of the etcd from shoot control plane will be stored
under the configured object store.</p></td></tr><tr><td><code>dns</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedDNS>SeedDNS</a></em></td><td><p>DNS contains DNS-relevant information about this seed cluster.</p></td></tr><tr><td><code>networks</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedNetworks>SeedNetworks</a></em></td><td><p>Networks defines the pod, service and worker network of the Seed cluster.</p></td></tr><tr><td><code>provider</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedProvider>SeedProvider</a></em></td><td><p>Provider defines the provider type and region for this Seed cluster.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><em>(Optional)</em><p>SecretRef is a reference to a Secret object containing the Kubeconfig and the cloud provider credentials for
the account the Seed cluster has been deployed to.</p></td></tr><tr><td><code>taints</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedTaint>[]SeedTaint</a></em></td><td><em>(Optional)</em><p>Taints describes taints on the seed.</p></td></tr><tr><td><code>volume</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedVolume>SeedVolume</a></em></td><td><em>(Optional)</em><p>Volume contains settings for persistentvolumes created in the seed cluster.</p></td></tr><tr><td><code>settings</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSettings>SeedSettings</a></em></td><td><em>(Optional)</em><p>Settings contains certain settings for this seed cluster.</p></td></tr><tr><td><code>ingress</code></br><em><a href=#core.gardener.cloud/v1beta1.Ingress>Ingress</a></em></td><td><em>(Optional)</em><p>Ingress configures Ingress specific settings of the Seed cluster.</p></td></tr></table></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedVolume>SeedVolume</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedSpec>SeedSpec</a>)</p><p><p>SeedVolume contains settings for persistentvolumes created in the seed cluster.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>minimumSize</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><em>(Optional)</em><p>MinimumSize defines the minimum size that should be used for PVCs in the seed.</p></td></tr><tr><td><code>providers</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedVolumeProvider>[]SeedVolumeProvider</a></em></td><td><em>(Optional)</em><p>Providers is a list of storage class provisioner types for the seed.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.SeedVolumeProvider>SeedVolumeProvider</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedVolume>SeedVolume</a>)</p><p><p>SeedVolumeProvider is a storage class provisioner type.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>purpose</code></br><em>string</em></td><td><p>Purpose is the purpose of this provider.</p></td></tr><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the name of the storage class provisioner type.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ServiceAccountConfig>ServiceAccountConfig</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubeAPIServerConfig>KubeAPIServerConfig</a>)</p><p><p>ServiceAccountConfig is the kube-apiserver configuration for service accounts.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>issuer</code></br><em>string</em></td><td><em>(Optional)</em><p>Issuer is the identifier of the service account token issuer. The issuer will assert this
identifier in &ldquo;iss&rdquo; claim of issued tokens. This value is a string or URI.
Defaults to URI of the API server.</p></td></tr><tr><td><code>signingKeySecretName</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#localobjectreference-v1-core>Kubernetes core/v1.LocalObjectReference</a></em></td><td><em>(Optional)</em><p>SigningKeySecret is a reference to a secret that contains an optional private key of the
service account token issuer. The issuer will sign issued ID tokens with this private key.
Only useful if service account tokens are also issued by another external system.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ShootAdvertisedAddress>ShootAdvertisedAddress</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ShootStatus>ShootStatus</a>)</p><p><p>ShootAdvertisedAddress contains information for the shoot&rsquo;s Kube API server.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name of the advertised address. e.g. external</p></td></tr><tr><td><code>url</code></br><em>string</em></td><td><p>The URL of the API Server. e.g. <a href=https://api.foo.bar>https://api.foo.bar</a> or <a href=https://1.2.3.4>https://1.2.3.4</a></p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ShootMachineImage>ShootMachineImage</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Machine>Machine</a>)</p><p><p>ShootMachineImage defines the name and the version of the shoot&rsquo;s machine image in any environment. Has to be
defined in the respective CloudProfile.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the name of the image.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig is the shoot&rsquo;s individual configuration passed to an extension resource.</p></td></tr><tr><td><code>version</code></br><em>string</em></td><td><em>(Optional)</em><p>Version is the version of the shoot&rsquo;s image.
If version is not provided, it will be defaulted to the latest version from the CloudProfile.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ShootNetworks>ShootNetworks</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.SeedNetworks>SeedNetworks</a>)</p><p><p>ShootNetworks contains the default networks CIDRs for shoots.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>pods</code></br><em>string</em></td><td><em>(Optional)</em><p>Pods is the CIDR of the pod network.</p></td></tr><tr><td><code>services</code></br><em>string</em></td><td><em>(Optional)</em><p>Services is the CIDR of the service network.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ShootPurpose>ShootPurpose
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a>)</p><p><p>ShootPurpose is a type alias for string.</p></p><h3 id=core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Shoot>Shoot</a>,
<a href=#core.gardener.cloud/v1beta1.ShootTemplate>ShootTemplate</a>)</p><p><p>ShootSpec is the specification of a Shoot.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>addons</code></br><em><a href=#core.gardener.cloud/v1beta1.Addons>Addons</a></em></td><td><em>(Optional)</em><p>Addons contains information about enabled/disabled addons and their configuration.</p></td></tr><tr><td><code>cloudProfileName</code></br><em>string</em></td><td><p>CloudProfileName is a name of a CloudProfile object.</p></td></tr><tr><td><code>dns</code></br><em><a href=#core.gardener.cloud/v1beta1.DNS>DNS</a></em></td><td><em>(Optional)</em><p>DNS contains information about the DNS settings of the Shoot.</p></td></tr><tr><td><code>extensions</code></br><em><a href=#core.gardener.cloud/v1beta1.Extension>[]Extension</a></em></td><td><em>(Optional)</em><p>Extensions contain type and provider information for Shoot extensions.</p></td></tr><tr><td><code>hibernation</code></br><em><a href=#core.gardener.cloud/v1beta1.Hibernation>Hibernation</a></em></td><td><em>(Optional)</em><p>Hibernation contains information whether the Shoot is suspended or not.</p></td></tr><tr><td><code>kubernetes</code></br><em><a href=#core.gardener.cloud/v1beta1.Kubernetes>Kubernetes</a></em></td><td><p>Kubernetes contains the version and configuration settings of the control plane components.</p></td></tr><tr><td><code>networking</code></br><em><a href=#core.gardener.cloud/v1beta1.Networking>Networking</a></em></td><td><p>Networking contains information about cluster networking such as CNI Plugin type, CIDRs, &mldr;etc.</p></td></tr><tr><td><code>maintenance</code></br><em><a href=#core.gardener.cloud/v1beta1.Maintenance>Maintenance</a></em></td><td><em>(Optional)</em><p>Maintenance contains information about the time window for maintenance operations and which
operations should be performed.</p></td></tr><tr><td><code>monitoring</code></br><em><a href=#core.gardener.cloud/v1beta1.Monitoring>Monitoring</a></em></td><td><em>(Optional)</em><p>Monitoring contains information about custom monitoring configurations for the shoot.</p></td></tr><tr><td><code>provider</code></br><em><a href=#core.gardener.cloud/v1beta1.Provider>Provider</a></em></td><td><p>Provider contains all provider-specific and provider-relevant information.</p></td></tr><tr><td><code>purpose</code></br><em><a href=#core.gardener.cloud/v1beta1.ShootPurpose>ShootPurpose</a></em></td><td><em>(Optional)</em><p>Purpose is the purpose class for this cluster.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is a name of a region.</p></td></tr><tr><td><code>secretBindingName</code></br><em>string</em></td><td><p>SecretBindingName is the name of the a SecretBinding that has a reference to the provider secret.
The credentials inside the provider secret will be used to create the shoot in the respective account.</p></td></tr><tr><td><code>seedName</code></br><em>string</em></td><td><em>(Optional)</em><p>SeedName is the name of the seed cluster that runs the control plane of the Shoot.</p></td></tr><tr><td><code>seedSelector</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSelector>SeedSelector</a></em></td><td><em>(Optional)</em><p>SeedSelector is an optional selector which must match a seed&rsquo;s labels for the shoot to be scheduled on that seed.</p></td></tr><tr><td><code>resources</code></br><em><a href=#core.gardener.cloud/v1beta1.NamedResourceReference>[]NamedResourceReference</a></em></td><td><em>(Optional)</em><p>Resources holds a list of named resource references that can be referred to in extension configs by their names.</p></td></tr><tr><td><code>tolerations</code></br><em><a href=#core.gardener.cloud/v1beta1.Toleration>[]Toleration</a></em></td><td><em>(Optional)</em><p>Tolerations contains the tolerations for taints on seed clusters.</p></td></tr><tr><td><code>exposureClassName</code></br><em>string</em></td><td><em>(Optional)</em><p>ExposureClassName is the optional name of an exposure class to apply a control plane endpoint exposure strategy.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ShootStatus>ShootStatus</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Shoot>Shoot</a>)</p><p><p>ShootStatus holds the most recently observed status of the Shoot cluster.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>conditions</code></br><em><a href=#core.gardener.cloud/v1beta1.Condition>[]Condition</a></em></td><td><em>(Optional)</em><p>Conditions represents the latest available observations of a Shoots&rsquo;s current state.</p></td></tr><tr><td><code>constraints</code></br><em><a href=#core.gardener.cloud/v1beta1.Condition>[]Condition</a></em></td><td><em>(Optional)</em><p>Constraints represents conditions of a Shoot&rsquo;s current state that constraint some operations on it.</p></td></tr><tr><td><code>gardener</code></br><em><a href=#core.gardener.cloud/v1beta1.Gardener>Gardener</a></em></td><td><p>Gardener holds information about the Gardener which last acted on the Shoot.</p></td></tr><tr><td><code>hibernated</code></br><em>bool</em></td><td><p>IsHibernated indicates whether the Shoot is currently hibernated.</p></td></tr><tr><td><code>lastOperation</code></br><em><a href=#core.gardener.cloud/v1beta1.LastOperation>LastOperation</a></em></td><td><em>(Optional)</em><p>LastOperation holds information about the last operation on the Shoot.</p></td></tr><tr><td><code>lastErrors</code></br><em><a href=#core.gardener.cloud/v1beta1.LastError>[]LastError</a></em></td><td><em>(Optional)</em><p>LastErrors holds information about the last occurred error(s) during an operation.</p></td></tr><tr><td><code>observedGeneration</code></br><em>int64</em></td><td><em>(Optional)</em><p>ObservedGeneration is the most recent generation observed for this Shoot. It corresponds to the
Shoot&rsquo;s generation, which is updated on mutation by the API Server.</p></td></tr><tr><td><code>retryCycleStartTime</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#time-v1-meta>Kubernetes meta/v1.Time</a></em></td><td><em>(Optional)</em><p>RetryCycleStartTime is the start time of the last retry cycle (used to determine how often an operation
must be retried until we give up).</p></td></tr><tr><td><code>seedName</code></br><em>string</em></td><td><em>(Optional)</em><p>SeedName is the name of the seed cluster that runs the control plane of the Shoot. This value is only written
after a successful create/reconcile operation. It will be used when control planes are moved between Seeds.</p></td></tr><tr><td><code>technicalID</code></br><em>string</em></td><td><p>TechnicalID is the name that is used for creating the Seed namespace, the infrastructure resources, and
basically everything that is related to this particular Shoot.</p></td></tr><tr><td><code>uid</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/types#UID>k8s.io/apimachinery/pkg/types.UID</a></em></td><td><p>UID is a unique identifier for the Shoot cluster to avoid portability between Kubernetes clusters.
It is used to compute unique hashes.</p></td></tr><tr><td><code>clusterIdentity</code></br><em>string</em></td><td><em>(Optional)</em><p>ClusterIdentity is the identity of the Shoot cluster</p></td></tr><tr><td><code>advertisedAddresses</code></br><em><a href=#core.gardener.cloud/v1beta1.ShootAdvertisedAddress>[]ShootAdvertisedAddress</a></em></td><td><em>(Optional)</em><p>List of addresses on which the Kube API server can be reached.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.ShootTemplate>ShootTemplate</h3><p><p>ShootTemplate is a template for creating a Shoot object.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a></em></td><td><em>(Optional)</em><p>Specification of the desired behavior of the Shoot.</p><br><br><table><tr><td><code>addons</code></br><em><a href=#core.gardener.cloud/v1beta1.Addons>Addons</a></em></td><td><em>(Optional)</em><p>Addons contains information about enabled/disabled addons and their configuration.</p></td></tr><tr><td><code>cloudProfileName</code></br><em>string</em></td><td><p>CloudProfileName is a name of a CloudProfile object.</p></td></tr><tr><td><code>dns</code></br><em><a href=#core.gardener.cloud/v1beta1.DNS>DNS</a></em></td><td><em>(Optional)</em><p>DNS contains information about the DNS settings of the Shoot.</p></td></tr><tr><td><code>extensions</code></br><em><a href=#core.gardener.cloud/v1beta1.Extension>[]Extension</a></em></td><td><em>(Optional)</em><p>Extensions contain type and provider information for Shoot extensions.</p></td></tr><tr><td><code>hibernation</code></br><em><a href=#core.gardener.cloud/v1beta1.Hibernation>Hibernation</a></em></td><td><em>(Optional)</em><p>Hibernation contains information whether the Shoot is suspended or not.</p></td></tr><tr><td><code>kubernetes</code></br><em><a href=#core.gardener.cloud/v1beta1.Kubernetes>Kubernetes</a></em></td><td><p>Kubernetes contains the version and configuration settings of the control plane components.</p></td></tr><tr><td><code>networking</code></br><em><a href=#core.gardener.cloud/v1beta1.Networking>Networking</a></em></td><td><p>Networking contains information about cluster networking such as CNI Plugin type, CIDRs, &mldr;etc.</p></td></tr><tr><td><code>maintenance</code></br><em><a href=#core.gardener.cloud/v1beta1.Maintenance>Maintenance</a></em></td><td><em>(Optional)</em><p>Maintenance contains information about the time window for maintenance operations and which
operations should be performed.</p></td></tr><tr><td><code>monitoring</code></br><em><a href=#core.gardener.cloud/v1beta1.Monitoring>Monitoring</a></em></td><td><em>(Optional)</em><p>Monitoring contains information about custom monitoring configurations for the shoot.</p></td></tr><tr><td><code>provider</code></br><em><a href=#core.gardener.cloud/v1beta1.Provider>Provider</a></em></td><td><p>Provider contains all provider-specific and provider-relevant information.</p></td></tr><tr><td><code>purpose</code></br><em><a href=#core.gardener.cloud/v1beta1.ShootPurpose>ShootPurpose</a></em></td><td><em>(Optional)</em><p>Purpose is the purpose class for this cluster.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is a name of a region.</p></td></tr><tr><td><code>secretBindingName</code></br><em>string</em></td><td><p>SecretBindingName is the name of the a SecretBinding that has a reference to the provider secret.
The credentials inside the provider secret will be used to create the shoot in the respective account.</p></td></tr><tr><td><code>seedName</code></br><em>string</em></td><td><em>(Optional)</em><p>SeedName is the name of the seed cluster that runs the control plane of the Shoot.</p></td></tr><tr><td><code>seedSelector</code></br><em><a href=#core.gardener.cloud/v1beta1.SeedSelector>SeedSelector</a></em></td><td><em>(Optional)</em><p>SeedSelector is an optional selector which must match a seed&rsquo;s labels for the shoot to be scheduled on that seed.</p></td></tr><tr><td><code>resources</code></br><em><a href=#core.gardener.cloud/v1beta1.NamedResourceReference>[]NamedResourceReference</a></em></td><td><em>(Optional)</em><p>Resources holds a list of named resource references that can be referred to in extension configs by their names.</p></td></tr><tr><td><code>tolerations</code></br><em><a href=#core.gardener.cloud/v1beta1.Toleration>[]Toleration</a></em></td><td><em>(Optional)</em><p>Tolerations contains the tolerations for taints on seed clusters.</p></td></tr><tr><td><code>exposureClassName</code></br><em>string</em></td><td><em>(Optional)</em><p>ExposureClassName is the optional name of an exposure class to apply a control plane endpoint exposure strategy.</p></td></tr></table></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Toleration>Toleration</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ProjectTolerations>ProjectTolerations</a>,
<a href=#core.gardener.cloud/v1beta1.ShootSpec>ShootSpec</a>)</p><p><p>Toleration is a toleration for a seed taint.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>key</code></br><em>string</em></td><td><p>Key is the toleration key to be applied to a project or shoot.</p></td></tr><tr><td><code>value</code></br><em>string</em></td><td><em>(Optional)</em><p>Value is the toleration value corresponding to the toleration key.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.VersionClassification>VersionClassification
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.ExpirableVersion>ExpirableVersion</a>)</p><p><p>VersionClassification is the logical state of a version according to <a href=https://github.com/gardener/gardener/blob/master/docs/operations/versioning.md>https://github.com/gardener/gardener/blob/master/docs/operations/versioning.md</a></p></p><h3 id=core.gardener.cloud/v1beta1.VerticalPodAutoscaler>VerticalPodAutoscaler</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Kubernetes>Kubernetes</a>)</p><p><p>VerticalPodAutoscaler contains the configuration flags for the Kubernetes vertical pod autoscaler.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>enabled</code></br><em>bool</em></td><td><p>Enabled specifies whether the Kubernetes VPA shall be enabled for the shoot cluster.</p></td></tr><tr><td><code>evictAfterOOMThreshold</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>EvictAfterOOMThreshold defines the threshold that will lead to pod eviction in case it OOMed in less than the given
threshold since its start and if it has only one container (default: 10m0s).</p></td></tr><tr><td><code>evictionRateBurst</code></br><em>int32</em></td><td><em>(Optional)</em><p>EvictionRateBurst defines the burst of pods that can be evicted (default: 1)</p></td></tr><tr><td><code>evictionRateLimit</code></br><em>float64</em></td><td><em>(Optional)</em><p>EvictionRateLimit defines the number of pods that can be evicted per second. A rate limit set to 0 or -1 will
disable the rate limiter (default: -1).</p></td></tr><tr><td><code>evictionTolerance</code></br><em>float64</em></td><td><em>(Optional)</em><p>EvictionTolerance defines the fraction of replica count that can be evicted for update in case more than one
pod can be evicted (default: 0.5).</p></td></tr><tr><td><code>recommendationMarginFraction</code></br><em>float64</em></td><td><em>(Optional)</em><p>RecommendationMarginFraction is the fraction of usage added as the safety margin to the recommended request
(default: 0.15).</p></td></tr><tr><td><code>updaterInterval</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>UpdaterInterval is the interval how often the updater should run (default: 1m0s).</p></td></tr><tr><td><code>recommenderInterval</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/apis/meta/v1#Duration>Kubernetes meta/v1.Duration</a></em></td><td><em>(Optional)</em><p>RecommenderInterval is the interval how often metrics should be fetched (default: 1m0s).</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Volume>Volume</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Worker>Worker</a>)</p><p><p>Volume contains information about the volume type, size, and encryption.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><em>(Optional)</em><p>Name of the volume to make it referencable.</p></td></tr><tr><td><code>type</code></br><em>string</em></td><td><em>(Optional)</em><p>Type is the type of the volume.</p></td></tr><tr><td><code>size</code></br><em>string</em></td><td><p>VolumeSize is the size of the volume.</p></td></tr><tr><td><code>encrypted</code></br><em>bool</em></td><td><em>(Optional)</em><p>Encrypted determines if the volume should be encrypted.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.VolumeType>VolumeType</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.CloudProfileSpec>CloudProfileSpec</a>)</p><p><p>VolumeType contains certain properties of a volume type.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>class</code></br><em>string</em></td><td><p>Class is the class of the volume type.</p></td></tr><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the name of the volume type.</p></td></tr><tr><td><code>usable</code></br><em>bool</em></td><td><em>(Optional)</em><p>Usable defines if the volume type can be used for shoot clusters.</p></td></tr><tr><td><code>minSize</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/api/resource#Quantity>k8s.io/apimachinery/pkg/api/resource.Quantity</a></em></td><td><em>(Optional)</em><p>MinSize is the minimal supported storage size.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.WatchCacheSizes>WatchCacheSizes</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.KubeAPIServerConfig>KubeAPIServerConfig</a>)</p><p><p>WatchCacheSizes contains configuration of the API server&rsquo;s watch cache sizes.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>default</code></br><em>int32</em></td><td><em>(Optional)</em><p>Default configures the default watch cache size of the kube-apiserver
(flag <code>--default-watch-cache-size</code>, defaults to 100).
See: <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/>https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/</a></p></td></tr><tr><td><code>resources</code></br><em><a href=#core.gardener.cloud/v1beta1.ResourceWatchCacheSize>[]ResourceWatchCacheSize</a></em></td><td><em>(Optional)</em><p>Resources configures the watch cache size of the kube-apiserver per resource
(flag <code>--watch-cache-sizes</code>).
See: <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/>https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/</a></p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.Worker>Worker</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Provider>Provider</a>)</p><p><p>Worker is the base definition of a worker group.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>annotations</code></br><em>map[string]string</em></td><td><em>(Optional)</em><p>Annotations is a map of key/value pairs for annotations for all the <code>Node</code> objects in this worker pool.</p></td></tr><tr><td><code>caBundle</code></br><em>string</em></td><td><em>(Optional)</em><p>CABundle is a certificate bundle which will be installed onto every machine of this worker pool.</p></td></tr><tr><td><code>cri</code></br><em><a href=#core.gardener.cloud/v1beta1.CRI>CRI</a></em></td><td><em>(Optional)</em><p>CRI contains configurations of CRI support of every machine in the worker pool.
Defaults to a CRI with name <code>containerd</code> when the Kubernetes version of the <code>Shoot</code> is >= 1.22.</p></td></tr><tr><td><code>kubernetes</code></br><em><a href=#core.gardener.cloud/v1beta1.WorkerKubernetes>WorkerKubernetes</a></em></td><td><em>(Optional)</em><p>Kubernetes contains configuration for Kubernetes components related to this worker pool.</p></td></tr><tr><td><code>labels</code></br><em>map[string]string</em></td><td><em>(Optional)</em><p>Labels is a map of key/value pairs for labels for all the <code>Node</code> objects in this worker pool.</p></td></tr><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the name of the worker group.</p></td></tr><tr><td><code>machine</code></br><em><a href=#core.gardener.cloud/v1beta1.Machine>Machine</a></em></td><td><p>Machine contains information about the machine type and image.</p></td></tr><tr><td><code>maximum</code></br><em>int32</em></td><td><p>Maximum is the maximum number of VMs to create.</p></td></tr><tr><td><code>minimum</code></br><em>int32</em></td><td><p>Minimum is the minimum number of VMs to create.</p></td></tr><tr><td><code>maxSurge</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/util/intstr#IntOrString>k8s.io/apimachinery/pkg/util/intstr.IntOrString</a></em></td><td><em>(Optional)</em><p>MaxSurge is maximum number of VMs that are created during an update.</p></td></tr><tr><td><code>maxUnavailable</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/util/intstr#IntOrString>k8s.io/apimachinery/pkg/util/intstr.IntOrString</a></em></td><td><em>(Optional)</em><p>MaxUnavailable is the maximum number of VMs that can be unavailable during an update.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig is the provider-specific configuration for this worker pool.</p></td></tr><tr><td><code>taints</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#taint-v1-core>[]Kubernetes core/v1.Taint</a></em></td><td><em>(Optional)</em><p>Taints is a list of taints for all the <code>Node</code> objects in this worker pool.</p></td></tr><tr><td><code>volume</code></br><em><a href=#core.gardener.cloud/v1beta1.Volume>Volume</a></em></td><td><em>(Optional)</em><p>Volume contains information about the volume type and size.</p></td></tr><tr><td><code>dataVolumes</code></br><em><a href=#core.gardener.cloud/v1beta1.DataVolume>[]DataVolume</a></em></td><td><em>(Optional)</em><p>DataVolumes contains a list of additional worker volumes.</p></td></tr><tr><td><code>kubeletDataVolumeName</code></br><em>string</em></td><td><em>(Optional)</em><p>KubeletDataVolumeName contains the name of a dataVolume that should be used for storing kubelet state.</p></td></tr><tr><td><code>zones</code></br><em>[]string</em></td><td><em>(Optional)</em><p>Zones is a list of availability zones that are used to evenly distribute this worker pool. Optional
as not every provider may support availability zones.</p></td></tr><tr><td><code>systemComponents</code></br><em><a href=#core.gardener.cloud/v1beta1.WorkerSystemComponents>WorkerSystemComponents</a></em></td><td><em>(Optional)</em><p>SystemComponents contains configuration for system components related to this worker pool</p></td></tr><tr><td><code>machineControllerManager</code></br><em><a href=#core.gardener.cloud/v1beta1.MachineControllerManagerSettings>MachineControllerManagerSettings</a></em></td><td><em>(Optional)</em><p>MachineControllerManagerSettings contains configurations for different worker-pools. Eg. MachineDrainTimeout, MachineHealthTimeout.</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.WorkerKubernetes>WorkerKubernetes</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Worker>Worker</a>)</p><p><p>WorkerKubernetes contains configuration for Kubernetes components related to this worker pool.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>kubelet</code></br><em><a href=#core.gardener.cloud/v1beta1.KubeletConfig>KubeletConfig</a></em></td><td><em>(Optional)</em><p>Kubelet contains configuration settings for all kubelets of this worker pool.
If set, all <code>spec.kubernetes.kubelet</code> settings will be overwritten for this worker pool (no merge of settings).</p></td></tr></tbody></table><h3 id=core.gardener.cloud/v1beta1.WorkerSystemComponents>WorkerSystemComponents</h3><p>(<em>Appears on:</em>
<a href=#core.gardener.cloud/v1beta1.Worker>Worker</a>)</p><p><p>WorkerSystemComponents contains configuration for system components related to this worker pool</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>allow</code></br><em>bool</em></td><td><p>Allow determines whether the pool should be allowed to host system components or not (defaults to true)</p></td></tr></tbody></table><hr><p><em>Generated with <a href=https://github.com/ahmetb/gen-crd-api-reference-docs>gen-crd-api-reference-docs</a></em></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ffdba5d143db85f200ae08cca2a02fb2>4.2 - Extensions</h1><p>Packages:</p><ul><li><a href=#extensions.gardener.cloud%2fv1alpha1>extensions.gardener.cloud/v1alpha1</a></li></ul><h2 id=extensions.gardener.cloud/v1alpha1>extensions.gardener.cloud/v1alpha1</h2><p><p>Package v1alpha1 is the v1alpha1 version of the API.</p></p>Resource Types:<ul><li><a href=#extensions.gardener.cloud/v1alpha1.BackupBucket>BackupBucket</a></li><li><a href=#extensions.gardener.cloud/v1alpha1.BackupEntry>BackupEntry</a></li><li><a href=#extensions.gardener.cloud/v1alpha1.Bastion>Bastion</a></li><li><a href=#extensions.gardener.cloud/v1alpha1.Cluster>Cluster</a></li><li><a href=#extensions.gardener.cloud/v1alpha1.ContainerRuntime>ContainerRuntime</a></li><li><a href=#extensions.gardener.cloud/v1alpha1.ControlPlane>ControlPlane</a></li><li><a href=#extensions.gardener.cloud/v1alpha1.DNSRecord>DNSRecord</a></li><li><a href=#extensions.gardener.cloud/v1alpha1.Extension>Extension</a></li><li><a href=#extensions.gardener.cloud/v1alpha1.Infrastructure>Infrastructure</a></li><li><a href=#extensions.gardener.cloud/v1alpha1.Network>Network</a></li><li><a href=#extensions.gardener.cloud/v1alpha1.OperatingSystemConfig>OperatingSystemConfig</a></li><li><a href=#extensions.gardener.cloud/v1alpha1.Worker>Worker</a></li></ul><h3 id=extensions.gardener.cloud/v1alpha1.BackupBucket>BackupBucket</h3><p><p>BackupBucket is a specification for backup bucket.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>extensions.gardener.cloud/v1alpha1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>BackupBucket</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em>
Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.BackupBucketSpec>BackupBucketSpec</a></em></td><td><br><br><table><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is the region of this bucket.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the credentials to access object store.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.BackupBucketStatus>BackupBucketStatus</a></em></td><td><em>(Optional)</em></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.BackupEntry>BackupEntry</h3><p><p>BackupEntry is a specification for backup Entry.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>extensions.gardener.cloud/v1alpha1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>BackupEntry</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em>
Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.BackupEntrySpec>BackupEntrySpec</a></em></td><td><br><br><table><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>backupBucketProviderStatus</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>BackupBucketProviderStatus contains the provider status that has
been generated by the controller responsible for the <code>BackupBucket</code> resource.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is the region of this Entry.</p></td></tr><tr><td><code>bucketName</code></br><em>string</em></td><td><p>BucketName is the name of backup bucket for this Backup Entry.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the credentials to access object store.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.BackupEntryStatus>BackupEntryStatus</a></em></td><td><em>(Optional)</em></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.Bastion>Bastion</h3><p><p>Bastion is a bastion or jump host that is dynamically created
to provide SSH access to shoot nodes.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>extensions.gardener.cloud/v1alpha1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>Bastion</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em>
Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.BastionSpec>BastionSpec</a></em></td><td><p>Spec is the specification of this Bastion.</p><br><br><table><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>userData</code></br><em>[]byte</em></td><td><p>UserData is the base64-encoded user data for the bastion instance. This should
contain code to provision the SSH key on the bastion instance.</p></td></tr><tr><td><code>ingress</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.BastionIngressPolicy>[]BastionIngressPolicy</a></em></td><td><p>Ingress controls from where the created bastion host should be reachable.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.BastionStatus>BastionStatus</a></em></td><td><em>(Optional)</em><p>Status is the bastion&rsquo;s status.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.Cluster>Cluster</h3><p><p>Cluster is a specification for a Cluster resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>extensions.gardener.cloud/v1alpha1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>Cluster</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.ClusterSpec>ClusterSpec</a></em></td><td><br><br><table><tr><td><code>cloudProfile</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><p>CloudProfile is a raw extension field that contains the cloudprofile resource referenced
by the shoot that has to be reconciled.</p></td></tr><tr><td><code>seed</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><p>Seed is a raw extension field that contains the seed resource referenced by the shoot that
has to be reconciled.</p></td></tr><tr><td><code>shoot</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><p>Shoot is a raw extension field that contains the shoot resource that has to be reconciled.</p></td></tr></table></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.ContainerRuntime>ContainerRuntime</h3><p><p>ContainerRuntime is a specification for a container runtime resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>extensions.gardener.cloud/v1alpha1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>ContainerRuntime</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em>
Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.ContainerRuntimeSpec>ContainerRuntimeSpec</a></em></td><td><br><br><table><tr><td><code>binaryPath</code></br><em>string</em></td><td><p>BinaryPath is the Worker&rsquo;s machine path where container runtime extensions should copy the binaries to.</p></td></tr><tr><td><code>workerPool</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.ContainerRuntimeWorkerPool>ContainerRuntimeWorkerPool</a></em></td><td><p>WorkerPool identifies the worker pool of the Shoot.
For each worker pool and type, Gardener deploys a ContainerRuntime CRD.</p></td></tr><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.ContainerRuntimeStatus>ContainerRuntimeStatus</a></em></td><td><em>(Optional)</em></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.ControlPlane>ControlPlane</h3><p><p>ControlPlane is a specification for a ControlPlane resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>extensions.gardener.cloud/v1alpha1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>ControlPlane</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.ControlPlaneSpec>ControlPlaneSpec</a></em></td><td><br><br><table><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>purpose</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.Purpose>Purpose</a></em></td><td><em>(Optional)</em><p>Purpose contains the data if a cloud provider needs additional components in order to expose the control plane.</p></td></tr><tr><td><code>infrastructureProviderStatus</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>InfrastructureProviderStatus contains the provider status that has
been generated by the controller responsible for the <code>Infrastructure</code> resource.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is the region of this control plane.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the cloud provider specific credentials.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.ControlPlaneStatus>ControlPlaneStatus</a></em></td><td><em>(Optional)</em></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.DNSRecord>DNSRecord</h3><p><p>DNSRecord is a specification for a DNSRecord resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>extensions.gardener.cloud/v1alpha1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>DNSRecord</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DNSRecordSpec>DNSRecordSpec</a></em></td><td><br><br><table><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the cloud provider specific credentials.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><em>(Optional)</em><p>Region is the region of this DNS record. If not specified, the region specified in SecretRef will be used.
If that is also not specified, the extension controller will use its default region.</p></td></tr><tr><td><code>zone</code></br><em>string</em></td><td><em>(Optional)</em><p>Zone is the DNS hosted zone of this DNS record. If not specified, it will be determined automatically by
getting all hosted zones of the account and searching for the longest zone name that is a suffix of Name.</p></td></tr><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the fully qualified domain name, e.g. &ldquo;api.<shoot domain>&rdquo;.</p></td></tr><tr><td><code>recordType</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DNSRecordType>DNSRecordType</a></em></td><td><p>RecordType is the DNS record type. Only A, CNAME, and TXT records are currently supported.</p></td></tr><tr><td><code>values</code></br><em>[]string</em></td><td><p>Values is a list of IP addresses for A records, a single hostname for CNAME records, or a list of texts for TXT records.</p></td></tr><tr><td><code>ttl</code></br><em>int64</em></td><td><em>(Optional)</em><p>TTL is the time to live in seconds. Defaults to 120.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DNSRecordStatus>DNSRecordStatus</a></em></td><td><em>(Optional)</em></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.Extension>Extension</h3><p><p>Extension is a specification for a Extension resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>extensions.gardener.cloud/v1alpha1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>Extension</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em>
Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.ExtensionSpec>ExtensionSpec</a></em></td><td><br><br><table><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.ExtensionStatus>ExtensionStatus</a></em></td><td><em>(Optional)</em></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.Infrastructure>Infrastructure</h3><p><p>Infrastructure is a specification for cloud provider infrastructure.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>extensions.gardener.cloud/v1alpha1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>Infrastructure</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em>
Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.InfrastructureSpec>InfrastructureSpec</a></em></td><td><br><br><table><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is the region of this infrastructure.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the actual result of the generated cloud config.</p></td></tr><tr><td><code>sshPublicKey</code></br><em>[]byte</em></td><td><em>(Optional)</em><p>SSHPublicKey is the public SSH key that should be used with this infrastructure.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.InfrastructureStatus>InfrastructureStatus</a></em></td><td><em>(Optional)</em></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.Network>Network</h3><p><p>Network is the specification for cluster networking.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>extensions.gardener.cloud/v1alpha1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>Network</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em>
Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.NetworkSpec>NetworkSpec</a></em></td><td><br><br><table><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>podCIDR</code></br><em>string</em></td><td><p>PodCIDR defines the CIDR that will be used for pods.</p></td></tr><tr><td><code>serviceCIDR</code></br><em>string</em></td><td><p>ServiceCIDR defines the CIDR that will be used for services.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.NetworkStatus>NetworkStatus</a></em></td><td><em>(Optional)</em></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.OperatingSystemConfig>OperatingSystemConfig</h3><p><p>OperatingSystemConfig is a specification for a OperatingSystemConfig resource</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>extensions.gardener.cloud/v1alpha1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>OperatingSystemConfig</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em>
Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.OperatingSystemConfigSpec>OperatingSystemConfigSpec</a></em></td><td><br><br><table><tr><td><code>criConfig</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.CRIConfig>CRIConfig</a></em></td><td><em>(Optional)</em><p>CRI config is a structure contains configurations of the CRI library</p></td></tr><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>purpose</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.OperatingSystemConfigPurpose>OperatingSystemConfigPurpose</a></em></td><td><p>Purpose describes how the result of this OperatingSystemConfig is used by Gardener. Either it
gets sent to the <code>Worker</code> extension controller to bootstrap a VM, or it is downloaded by the
cloud-config-downloader script already running on a bootstrapped VM.</p></td></tr><tr><td><code>reloadConfigFilePath</code></br><em>string</em></td><td><em>(Optional)</em><p>ReloadConfigFilePath is the path to the generated operating system configuration. If set, controllers
are asked to use it when determining the .status.command of this resource. For example, if for CoreOS
the reload-path might be &ldquo;/var/lib/config&rdquo;; then the controller shall set .status.command to
&ldquo;/usr/bin/coreos-cloudinit &ndash;from-file=/var/lib/config&rdquo;.</p></td></tr><tr><td><code>units</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.Unit>[]Unit</a></em></td><td><em>(Optional)</em><p>Units is a list of unit for the operating system configuration (usually, a systemd unit).</p></td></tr><tr><td><code>files</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.File>[]File</a></em></td><td><em>(Optional)</em><p>Files is a list of files that should get written to the host&rsquo;s file system.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.OperatingSystemConfigStatus>OperatingSystemConfigStatus</a></em></td><td><em>(Optional)</em></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.Worker>Worker</h3><p><p>Worker is a specification for a Worker resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>extensions.gardener.cloud/v1alpha1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>Worker</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><em>(Optional)</em>
Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.WorkerSpec>WorkerSpec</a></em></td><td><br><br><table><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>infrastructureProviderStatus</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>InfrastructureProviderStatus is a raw extension field that contains the provider status that has
been generated by the controller responsible for the <code>Infrastructure</code> resource.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is the name of the region where the worker pool should be deployed to.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the cloud provider specific credentials.</p></td></tr><tr><td><code>sshPublicKey</code></br><em>[]byte</em></td><td><em>(Optional)</em><p>SSHPublicKey is the public SSH key that should be used with these workers.</p></td></tr><tr><td><code>pools</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.WorkerPool>[]WorkerPool</a></em></td><td><p>Pools is a list of worker pools.</p></td></tr></table></td></tr><tr><td><code>status</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.WorkerStatus>WorkerStatus</a></em></td><td><em>(Optional)</em></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.BackupBucketSpec>BackupBucketSpec</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.BackupBucket>BackupBucket</a>)</p><p><p>BackupBucketSpec is the spec for an BackupBucket resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is the region of this bucket.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the credentials to access object store.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.BackupBucketStatus>BackupBucketStatus</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.BackupBucket>BackupBucket</a>)</p><p><p>BackupBucketStatus is the status for an BackupBucket resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultStatus</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultStatus>DefaultStatus</a></em></td><td><p>(Members of <code>DefaultStatus</code> are embedded into this type.)</p><p>DefaultStatus is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>generatedSecretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><em>(Optional)</em><p>GeneratedSecretRef is reference to the secret generated by backup bucket, which
will have object store specific credentials.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.BackupEntrySpec>BackupEntrySpec</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.BackupEntry>BackupEntry</a>)</p><p><p>BackupEntrySpec is the spec for an BackupEntry resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>backupBucketProviderStatus</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>BackupBucketProviderStatus contains the provider status that has
been generated by the controller responsible for the <code>BackupBucket</code> resource.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is the region of this Entry.</p></td></tr><tr><td><code>bucketName</code></br><em>string</em></td><td><p>BucketName is the name of backup bucket for this Backup Entry.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the credentials to access object store.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.BackupEntryStatus>BackupEntryStatus</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.BackupEntry>BackupEntry</a>)</p><p><p>BackupEntryStatus is the status for an BackupEntry resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultStatus</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultStatus>DefaultStatus</a></em></td><td><p>(Members of <code>DefaultStatus</code> are embedded into this type.)</p><p>DefaultStatus is a structure containing common fields used by all extension resources.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.BastionIngressPolicy>BastionIngressPolicy</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.BastionSpec>BastionSpec</a>)</p><p><p>BastionIngressPolicy represents an ingress policy for SSH bastion hosts.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>ipBlock</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#ipblock-v1-networking>Kubernetes networking/v1.IPBlock</a></em></td><td><p>IPBlock defines an IP block that is allowed to access the bastion.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.BastionSpec>BastionSpec</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.Bastion>Bastion</a>)</p><p><p>BastionSpec contains the specification for an SSH bastion host.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>userData</code></br><em>[]byte</em></td><td><p>UserData is the base64-encoded user data for the bastion instance. This should
contain code to provision the SSH key on the bastion instance.</p></td></tr><tr><td><code>ingress</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.BastionIngressPolicy>[]BastionIngressPolicy</a></em></td><td><p>Ingress controls from where the created bastion host should be reachable.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.BastionStatus>BastionStatus</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.Bastion>Bastion</a>)</p><p><p>BastionStatus holds the most recently observed status of the Bastion.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultStatus</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultStatus>DefaultStatus</a></em></td><td><p>(Members of <code>DefaultStatus</code> are embedded into this type.)</p><p>DefaultStatus is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>ingress</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#loadbalanceringress-v1-core>Kubernetes core/v1.LoadBalancerIngress</a></em></td><td><p>Ingress is the external IP and/or hostname of the bastion host.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.CRIConfig>CRIConfig</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.OperatingSystemConfigSpec>OperatingSystemConfigSpec</a>)</p><p><p>CRIConfig contains configurations of the CRI library.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.CRIName>CRIName</a></em></td><td><p>Name is a mandatory string containing the name of the CRI library. Supported values are <code>docker</code> and <code>containerd</code>.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.CRIName>CRIName
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.CRIConfig>CRIConfig</a>)</p><p><p>CRIName is a type alias for the CRI name string.</p></p><h3 id=extensions.gardener.cloud/v1alpha1.CloudConfig>CloudConfig</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.OperatingSystemConfigStatus>OperatingSystemConfigStatus</a>)</p><p><p>CloudConfig contains the generated output for the given operating system
config spec. It contains a reference to a secret as the result may contain confidential data.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the actual result of the generated cloud config.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.ClusterSpec>ClusterSpec</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.Cluster>Cluster</a>)</p><p><p>ClusterSpec is the spec for a Cluster resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>cloudProfile</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><p>CloudProfile is a raw extension field that contains the cloudprofile resource referenced
by the shoot that has to be reconciled.</p></td></tr><tr><td><code>seed</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><p>Seed is a raw extension field that contains the seed resource referenced by the shoot that
has to be reconciled.</p></td></tr><tr><td><code>shoot</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><p>Shoot is a raw extension field that contains the shoot resource that has to be reconciled.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.ContainerRuntimeSpec>ContainerRuntimeSpec</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.ContainerRuntime>ContainerRuntime</a>)</p><p><p>ContainerRuntimeSpec is the spec for a ContainerRuntime resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>binaryPath</code></br><em>string</em></td><td><p>BinaryPath is the Worker&rsquo;s machine path where container runtime extensions should copy the binaries to.</p></td></tr><tr><td><code>workerPool</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.ContainerRuntimeWorkerPool>ContainerRuntimeWorkerPool</a></em></td><td><p>WorkerPool identifies the worker pool of the Shoot.
For each worker pool and type, Gardener deploys a ContainerRuntime CRD.</p></td></tr><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.ContainerRuntimeStatus>ContainerRuntimeStatus</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.ContainerRuntime>ContainerRuntime</a>)</p><p><p>ContainerRuntimeStatus is the status for a ContainerRuntime resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultStatus</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultStatus>DefaultStatus</a></em></td><td><p>(Members of <code>DefaultStatus</code> are embedded into this type.)</p><p>DefaultStatus is a structure containing common fields used by all extension resources.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.ContainerRuntimeWorkerPool>ContainerRuntimeWorkerPool</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.ContainerRuntimeSpec>ContainerRuntimeSpec</a>)</p><p><p>ContainerRuntimeWorkerPool identifies a Shoot worker pool by its name and selector.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name specifies the name of the worker pool the container runtime should be available for.</p></td></tr><tr><td><code>selector</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#labelselector-v1-meta>Kubernetes meta/v1.LabelSelector</a></em></td><td><p>Selector is the label selector used by the extension to match the nodes belonging to the worker pool.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.ControlPlaneSpec>ControlPlaneSpec</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.ControlPlane>ControlPlane</a>)</p><p><p>ControlPlaneSpec is the spec of a ControlPlane resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>purpose</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.Purpose>Purpose</a></em></td><td><em>(Optional)</em><p>Purpose contains the data if a cloud provider needs additional components in order to expose the control plane.</p></td></tr><tr><td><code>infrastructureProviderStatus</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>InfrastructureProviderStatus contains the provider status that has
been generated by the controller responsible for the <code>Infrastructure</code> resource.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is the region of this control plane.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the cloud provider specific credentials.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.ControlPlaneStatus>ControlPlaneStatus</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.ControlPlane>ControlPlane</a>)</p><p><p>ControlPlaneStatus is the status of a ControlPlane resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultStatus</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultStatus>DefaultStatus</a></em></td><td><p>(Members of <code>DefaultStatus</code> are embedded into this type.)</p><p>DefaultStatus is a structure containing common fields used by all extension resources.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.DNSRecordSpec>DNSRecordSpec</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.DNSRecord>DNSRecord</a>)</p><p><p>DNSRecordSpec is the spec of a DNSRecord resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the cloud provider specific credentials.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><em>(Optional)</em><p>Region is the region of this DNS record. If not specified, the region specified in SecretRef will be used.
If that is also not specified, the extension controller will use its default region.</p></td></tr><tr><td><code>zone</code></br><em>string</em></td><td><em>(Optional)</em><p>Zone is the DNS hosted zone of this DNS record. If not specified, it will be determined automatically by
getting all hosted zones of the account and searching for the longest zone name that is a suffix of Name.</p></td></tr><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the fully qualified domain name, e.g. &ldquo;api.<shoot domain>&rdquo;.</p></td></tr><tr><td><code>recordType</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DNSRecordType>DNSRecordType</a></em></td><td><p>RecordType is the DNS record type. Only A, CNAME, and TXT records are currently supported.</p></td></tr><tr><td><code>values</code></br><em>[]string</em></td><td><p>Values is a list of IP addresses for A records, a single hostname for CNAME records, or a list of texts for TXT records.</p></td></tr><tr><td><code>ttl</code></br><em>int64</em></td><td><em>(Optional)</em><p>TTL is the time to live in seconds. Defaults to 120.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.DNSRecordStatus>DNSRecordStatus</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.DNSRecord>DNSRecord</a>)</p><p><p>DNSRecordStatus is the status of a DNSRecord resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultStatus</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultStatus>DefaultStatus</a></em></td><td><p>(Members of <code>DefaultStatus</code> are embedded into this type.)</p><p>DefaultStatus is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>zone</code></br><em>string</em></td><td><em>(Optional)</em><p>Zone is the DNS hosted zone of this DNS record.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.DNSRecordType>DNSRecordType
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.DNSRecordSpec>DNSRecordSpec</a>)</p><p><p>DNSRecordType is a string alias.</p></p><h3 id=extensions.gardener.cloud/v1alpha1.DataVolume>DataVolume</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.WorkerPool>WorkerPool</a>)</p><p><p>DataVolume contains information about a data volume.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name of the volume to make it referencable.</p></td></tr><tr><td><code>type</code></br><em>string</em></td><td><em>(Optional)</em><p>Type is the type of the volume.</p></td></tr><tr><td><code>size</code></br><em>string</em></td><td><p>Size is the of the root volume.</p></td></tr><tr><td><code>encrypted</code></br><em>bool</em></td><td><em>(Optional)</em><p>Encrypted determines if the volume should be encrypted.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.BackupBucketSpec>BackupBucketSpec</a>,
<a href=#extensions.gardener.cloud/v1alpha1.BackupEntrySpec>BackupEntrySpec</a>,
<a href=#extensions.gardener.cloud/v1alpha1.BastionSpec>BastionSpec</a>,
<a href=#extensions.gardener.cloud/v1alpha1.ContainerRuntimeSpec>ContainerRuntimeSpec</a>,
<a href=#extensions.gardener.cloud/v1alpha1.ControlPlaneSpec>ControlPlaneSpec</a>,
<a href=#extensions.gardener.cloud/v1alpha1.DNSRecordSpec>DNSRecordSpec</a>,
<a href=#extensions.gardener.cloud/v1alpha1.ExtensionSpec>ExtensionSpec</a>,
<a href=#extensions.gardener.cloud/v1alpha1.InfrastructureSpec>InfrastructureSpec</a>,
<a href=#extensions.gardener.cloud/v1alpha1.NetworkSpec>NetworkSpec</a>,
<a href=#extensions.gardener.cloud/v1alpha1.OperatingSystemConfigSpec>OperatingSystemConfigSpec</a>,
<a href=#extensions.gardener.cloud/v1alpha1.WorkerSpec>WorkerSpec</a>)</p><p><p>DefaultSpec contains common status fields for every extension resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code></br><em>string</em></td><td><p>Type contains the instance of the resource&rsquo;s kind.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig is the provider specific configuration.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.DefaultStatus>DefaultStatus</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.BackupBucketStatus>BackupBucketStatus</a>,
<a href=#extensions.gardener.cloud/v1alpha1.BackupEntryStatus>BackupEntryStatus</a>,
<a href=#extensions.gardener.cloud/v1alpha1.BastionStatus>BastionStatus</a>,
<a href=#extensions.gardener.cloud/v1alpha1.ContainerRuntimeStatus>ContainerRuntimeStatus</a>,
<a href=#extensions.gardener.cloud/v1alpha1.ControlPlaneStatus>ControlPlaneStatus</a>,
<a href=#extensions.gardener.cloud/v1alpha1.DNSRecordStatus>DNSRecordStatus</a>,
<a href=#extensions.gardener.cloud/v1alpha1.ExtensionStatus>ExtensionStatus</a>,
<a href=#extensions.gardener.cloud/v1alpha1.InfrastructureStatus>InfrastructureStatus</a>,
<a href=#extensions.gardener.cloud/v1alpha1.NetworkStatus>NetworkStatus</a>,
<a href=#extensions.gardener.cloud/v1alpha1.OperatingSystemConfigStatus>OperatingSystemConfigStatus</a>,
<a href=#extensions.gardener.cloud/v1alpha1.WorkerStatus>WorkerStatus</a>)</p><p><p>DefaultStatus contains common status fields for every extension resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>providerStatus</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderStatus contains provider-specific status.</p></td></tr><tr><td><code>conditions</code></br><em><a href=https://github.com/gardener/gardener/blob/master/hack/core#core.gardener.cloud/v1alpha1.Condition>[]github.com/gardener/gardener/pkg/apis/core/v1beta1.Condition</a></em></td><td><em>(Optional)</em><p>Conditions represents the latest available observations of a Seed&rsquo;s current state.</p></td></tr><tr><td><code>lastError</code></br><em><a href=https://github.com/gardener/gardener/blob/master/hack/core#core.gardener.cloud/v1alpha1.LastError>github.com/gardener/gardener/pkg/apis/core/v1beta1.LastError</a></em></td><td><em>(Optional)</em><p>LastError holds information about the last occurred error during an operation.</p></td></tr><tr><td><code>lastOperation</code></br><em><a href=https://github.com/gardener/gardener/blob/master/hack/core#core.gardener.cloud/v1alpha1.LastOperation>github.com/gardener/gardener/pkg/apis/core/v1beta1.LastOperation</a></em></td><td><em>(Optional)</em><p>LastOperation holds information about the last operation on the resource.</p></td></tr><tr><td><code>observedGeneration</code></br><em>int64</em></td><td><p>ObservedGeneration is the most recent generation observed for this resource.</p></td></tr><tr><td><code>state</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>State can be filled by the operating controller with what ever data it needs.</p></td></tr><tr><td><code>resources</code></br><em><a href=https://github.com/gardener/gardener/blob/master/hack/core#core.gardener.cloud/v1alpha1.NamedResourceReference>[]github.com/gardener/gardener/pkg/apis/core/v1beta1.NamedResourceReference</a></em></td><td><em>(Optional)</em><p>Resources holds a list of named resource references that can be referred to in the state by their names.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.DropIn>DropIn</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.Unit>Unit</a>)</p><p><p>DropIn is a drop-in configuration for a systemd unit.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the name of the drop-in.</p></td></tr><tr><td><code>content</code></br><em>string</em></td><td><p>Content is the content of the drop-in.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.ExtensionSpec>ExtensionSpec</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.Extension>Extension</a>)</p><p><p>ExtensionSpec is the spec for a Extension resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.ExtensionStatus>ExtensionStatus</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.Extension>Extension</a>)</p><p><p>ExtensionStatus is the status for a Extension resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultStatus</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultStatus>DefaultStatus</a></em></td><td><p>(Members of <code>DefaultStatus</code> are embedded into this type.)</p><p>DefaultStatus is a structure containing common fields used by all extension resources.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.File>File</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.OperatingSystemConfigSpec>OperatingSystemConfigSpec</a>)</p><p><p>File is a file that should get written to the host&rsquo;s file system. The content can either be inlined or
referenced from a secret in the same namespace.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>path</code></br><em>string</em></td><td><p>Path is the path of the file system where the file should get written to.</p></td></tr><tr><td><code>permissions</code></br><em>int32</em></td><td><em>(Optional)</em><p>Permissions describes with which permissions the file should get written to the file system.
Should be defaulted to octal 0644.</p></td></tr><tr><td><code>content</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.FileContent>FileContent</a></em></td><td><p>Content describe the file&rsquo;s content.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.FileContent>FileContent</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.File>File</a>)</p><p><p>FileContent can either reference a secret or contain inline configuration.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>secretRef</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.FileContentSecretRef>FileContentSecretRef</a></em></td><td><em>(Optional)</em><p>SecretRef is a struct that contains information about the referenced secret.</p></td></tr><tr><td><code>inline</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.FileContentInline>FileContentInline</a></em></td><td><em>(Optional)</em><p>Inline is a struct that contains information about the inlined data.</p></td></tr><tr><td><code>transmitUnencoded</code></br><em>bool</em></td><td><em>(Optional)</em><p>TransmitUnencoded set to true will ensure that the os-extension does not encode the file content when sent to the node.
This for example can be used to manipulate the clear-text content before it reaches the node.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.FileContentInline>FileContentInline</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.FileContent>FileContent</a>)</p><p><p>FileContentInline contains keys for inlining a file content&rsquo;s data and encoding.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>encoding</code></br><em>string</em></td><td><p>Encoding is the file&rsquo;s encoding (e.g. base64).</p></td></tr><tr><td><code>data</code></br><em>string</em></td><td><p>Data is the file&rsquo;s data.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.FileContentSecretRef>FileContentSecretRef</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.FileContent>FileContent</a>)</p><p><p>FileContentSecretRef contains keys for referencing a file content&rsquo;s data from a secret in the same namespace.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the name of the secret.</p></td></tr><tr><td><code>dataKey</code></br><em>string</em></td><td><p>DataKey is the key in the secret&rsquo;s <code>.data</code> field that should be read.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.InfrastructureSpec>InfrastructureSpec</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.Infrastructure>Infrastructure</a>)</p><p><p>InfrastructureSpec is the spec for an Infrastructure resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is the region of this infrastructure.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the actual result of the generated cloud config.</p></td></tr><tr><td><code>sshPublicKey</code></br><em>[]byte</em></td><td><em>(Optional)</em><p>SSHPublicKey is the public SSH key that should be used with this infrastructure.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.InfrastructureStatus>InfrastructureStatus</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.Infrastructure>Infrastructure</a>)</p><p><p>InfrastructureStatus is the status for an Infrastructure resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultStatus</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultStatus>DefaultStatus</a></em></td><td><p>(Members of <code>DefaultStatus</code> are embedded into this type.)</p><p>DefaultStatus is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>nodesCIDR</code></br><em>string</em></td><td><em>(Optional)</em><p>NodesCIDR is the CIDR of the node network that was optionally created by the acting extension controller.
This might be needed in environments in which the CIDR for the network for the shoot worker node cannot
be statically defined in the Shoot resource but must be computed dynamically.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.MachineDeployment>MachineDeployment</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.WorkerStatus>WorkerStatus</a>)</p><p><p>MachineDeployment is a created machine deployment.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the name of the <code>MachineDeployment</code> resource.</p></td></tr><tr><td><code>minimum</code></br><em>int32</em></td><td><p>Minimum is the minimum number for this machine deployment.</p></td></tr><tr><td><code>maximum</code></br><em>int32</em></td><td><p>Maximum is the maximum number for this machine deployment.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.MachineImage>MachineImage</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.WorkerPool>WorkerPool</a>)</p><p><p>MachineImage contains logical information about the name and the version of the machie image that
should be used. The logical information must be mapped to the provider-specific information (e.g.,
AMIs, &mldr;) by the provider itself.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the logical name of the machine image.</p></td></tr><tr><td><code>version</code></br><em>string</em></td><td><p>Version is the version of the machine image.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.NetworkSpec>NetworkSpec</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.Network>Network</a>)</p><p><p>NetworkSpec is the spec for an Network resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>podCIDR</code></br><em>string</em></td><td><p>PodCIDR defines the CIDR that will be used for pods.</p></td></tr><tr><td><code>serviceCIDR</code></br><em>string</em></td><td><p>ServiceCIDR defines the CIDR that will be used for services.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.NetworkStatus>NetworkStatus</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.Network>Network</a>)</p><p><p>NetworkStatus is the status for an Network resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultStatus</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultStatus>DefaultStatus</a></em></td><td><p>(Members of <code>DefaultStatus</code> are embedded into this type.)</p><p>DefaultStatus is a structure containing common fields used by all extension resources.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.Object>Object</h3><p><p>Object is an extension object resource.</p></p><h3 id=extensions.gardener.cloud/v1alpha1.OperatingSystemConfigPurpose>OperatingSystemConfigPurpose
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.OperatingSystemConfigSpec>OperatingSystemConfigSpec</a>)</p><p><p>OperatingSystemConfigPurpose is a string alias.</p></p><h3 id=extensions.gardener.cloud/v1alpha1.OperatingSystemConfigSpec>OperatingSystemConfigSpec</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.OperatingSystemConfig>OperatingSystemConfig</a>)</p><p><p>OperatingSystemConfigSpec is the spec for a OperatingSystemConfig resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>criConfig</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.CRIConfig>CRIConfig</a></em></td><td><em>(Optional)</em><p>CRI config is a structure contains configurations of the CRI library</p></td></tr><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>purpose</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.OperatingSystemConfigPurpose>OperatingSystemConfigPurpose</a></em></td><td><p>Purpose describes how the result of this OperatingSystemConfig is used by Gardener. Either it
gets sent to the <code>Worker</code> extension controller to bootstrap a VM, or it is downloaded by the
cloud-config-downloader script already running on a bootstrapped VM.</p></td></tr><tr><td><code>reloadConfigFilePath</code></br><em>string</em></td><td><em>(Optional)</em><p>ReloadConfigFilePath is the path to the generated operating system configuration. If set, controllers
are asked to use it when determining the .status.command of this resource. For example, if for CoreOS
the reload-path might be &ldquo;/var/lib/config&rdquo;; then the controller shall set .status.command to
&ldquo;/usr/bin/coreos-cloudinit &ndash;from-file=/var/lib/config&rdquo;.</p></td></tr><tr><td><code>units</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.Unit>[]Unit</a></em></td><td><em>(Optional)</em><p>Units is a list of unit for the operating system configuration (usually, a systemd unit).</p></td></tr><tr><td><code>files</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.File>[]File</a></em></td><td><em>(Optional)</em><p>Files is a list of files that should get written to the host&rsquo;s file system.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.OperatingSystemConfigStatus>OperatingSystemConfigStatus</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.OperatingSystemConfig>OperatingSystemConfig</a>)</p><p><p>OperatingSystemConfigStatus is the status for a OperatingSystemConfig resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultStatus</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultStatus>DefaultStatus</a></em></td><td><p>(Members of <code>DefaultStatus</code> are embedded into this type.)</p><p>DefaultStatus is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>cloudConfig</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.CloudConfig>CloudConfig</a></em></td><td><em>(Optional)</em><p>CloudConfig is a structure for containing the generated output for the given operating system
config spec. It contains a reference to a secret as the result may contain confidential data.</p></td></tr><tr><td><code>command</code></br><em>string</em></td><td><em>(Optional)</em><p>Command is the command whose execution renews/reloads the cloud config on an existing VM, e.g.
&ldquo;/usr/bin/reload-cloud-config -from-file=<path>&rdquo;. The <path>is optionally provided by Gardener
in the .spec.reloadConfigFilePath field.</p></td></tr><tr><td><code>units</code></br><em>[]string</em></td><td><em>(Optional)</em><p>Units is a list of systemd unit names that are part of the generated Cloud Config and shall be
restarted when a new version has been downloaded.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.Purpose>Purpose
(<code>string</code> alias)</p></h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.ControlPlaneSpec>ControlPlaneSpec</a>)</p><p><p>Purpose is a string alias.</p></p><h3 id=extensions.gardener.cloud/v1alpha1.Spec>Spec</h3><p><p>Spec is the spec section of an Object.</p></p><h3 id=extensions.gardener.cloud/v1alpha1.Status>Status</h3><p><p>Status is the status of an Object.</p></p><h3 id=extensions.gardener.cloud/v1alpha1.Unit>Unit</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.OperatingSystemConfigSpec>OperatingSystemConfigSpec</a>)</p><p><p>Unit is a unit for the operating system configuration (usually, a systemd unit).</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the name of a unit.</p></td></tr><tr><td><code>command</code></br><em>string</em></td><td><em>(Optional)</em><p>Command is the unit&rsquo;s command.</p></td></tr><tr><td><code>enable</code></br><em>bool</em></td><td><em>(Optional)</em><p>Enable describes whether the unit is enabled or not.</p></td></tr><tr><td><code>content</code></br><em>string</em></td><td><em>(Optional)</em><p>Content is the unit&rsquo;s content.</p></td></tr><tr><td><code>dropIns</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DropIn>[]DropIn</a></em></td><td><em>(Optional)</em><p>DropIns is a list of drop-ins for this unit.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.Volume>Volume</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.WorkerPool>WorkerPool</a>)</p><p><p>Volume contains information about the root disks that should be used for worker pools.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></br><em>string</em></td><td><em>(Optional)</em><p>Name of the volume to make it referencable.</p></td></tr><tr><td><code>type</code></br><em>string</em></td><td><em>(Optional)</em><p>Type is the type of the volume.</p></td></tr><tr><td><code>size</code></br><em>string</em></td><td><p>Size is the of the root volume.</p></td></tr><tr><td><code>encrypted</code></br><em>bool</em></td><td><em>(Optional)</em><p>Encrypted determines if the volume should be encrypted.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.WorkerPool>WorkerPool</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.WorkerSpec>WorkerSpec</a>)</p><p><p>WorkerPool is the definition of a specific worker pool.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>machineType</code></br><em>string</em></td><td><p>MachineType contains information about the machine type that should be used for this worker pool.</p></td></tr><tr><td><code>maximum</code></br><em>int32</em></td><td><p>Maximum is the maximum size of the worker pool.</p></td></tr><tr><td><code>maxSurge</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/util/intstr#IntOrString>k8s.io/apimachinery/pkg/util/intstr.IntOrString</a></em></td><td><p>MaxSurge is maximum number of VMs that are created during an update.</p></td></tr><tr><td><code>maxUnavailable</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/util/intstr#IntOrString>k8s.io/apimachinery/pkg/util/intstr.IntOrString</a></em></td><td><p>MaxUnavailable is the maximum number of VMs that can be unavailable during an update.</p></td></tr><tr><td><code>annotations</code></br><em>map[string]string</em></td><td><em>(Optional)</em><p>Annotations is a map of key/value pairs for annotations for all the <code>Node</code> objects in this worker pool.</p></td></tr><tr><td><code>labels</code></br><em>map[string]string</em></td><td><em>(Optional)</em><p>Labels is a map of key/value pairs for labels for all the <code>Node</code> objects in this worker pool.</p></td></tr><tr><td><code>taints</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#taint-v1-core>[]Kubernetes core/v1.Taint</a></em></td><td><em>(Optional)</em><p>Taints is a list of taints for all the <code>Node</code> objects in this worker pool.</p></td></tr><tr><td><code>machineImage</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.MachineImage>MachineImage</a></em></td><td><p>MachineImage contains logical information about the name and the version of the machie image that
should be used. The logical information must be mapped to the provider-specific information (e.g.,
AMIs, &mldr;) by the provider itself.</p></td></tr><tr><td><code>minimum</code></br><em>int32</em></td><td><p>Minimum is the minimum size of the worker pool.</p></td></tr><tr><td><code>name</code></br><em>string</em></td><td><p>Name is the name of this worker pool.</p></td></tr><tr><td><code>providerConfig</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>ProviderConfig is a provider specific configuration for the worker pool.</p></td></tr><tr><td><code>userData</code></br><em>[]byte</em></td><td><p>UserData is a base64-encoded string that contains the data that is sent to the provider&rsquo;s APIs
when a new machine/VM that is part of this worker pool shall be spawned.</p></td></tr><tr><td><code>volume</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.Volume>Volume</a></em></td><td><em>(Optional)</em><p>Volume contains information about the root disks that should be used for this worker pool.</p></td></tr><tr><td><code>dataVolumes</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DataVolume>[]DataVolume</a></em></td><td><em>(Optional)</em><p>DataVolumes contains a list of additional worker volumes.</p></td></tr><tr><td><code>kubeletDataVolumeName</code></br><em>string</em></td><td><em>(Optional)</em><p>KubeletDataVolumeName contains the name of a dataVolume that should be used for storing kubelet state.</p></td></tr><tr><td><code>zones</code></br><em>[]string</em></td><td><em>(Optional)</em><p>Zones contains information about availability zones for this worker pool.</p></td></tr><tr><td><code>machineControllerManager</code></br><em><a href=https://github.com/gardener/gardener/blob/master/hack/core#core.gardener.cloud/v1alpha1.MachineControllerManagerSettings>github.com/gardener/gardener/pkg/apis/core/v1beta1.MachineControllerManagerSettings</a></em></td><td><em>(Optional)</em><p>MachineControllerManagerSettings contains configurations for different worker-pools. Eg. MachineDrainTimeout, MachineHealthTimeout.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.WorkerSpec>WorkerSpec</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.Worker>Worker</a>)</p><p><p>WorkerSpec is the spec for a Worker resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultSpec</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultSpec>DefaultSpec</a></em></td><td><p>(Members of <code>DefaultSpec</code> are embedded into this type.)</p><p>DefaultSpec is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>infrastructureProviderStatus</code></br><em><a href=https://godoc.org/k8s.io/apimachinery/pkg/runtime#RawExtension>k8s.io/apimachinery/pkg/runtime.RawExtension</a></em></td><td><em>(Optional)</em><p>InfrastructureProviderStatus is a raw extension field that contains the provider status that has
been generated by the controller responsible for the <code>Infrastructure</code> resource.</p></td></tr><tr><td><code>region</code></br><em>string</em></td><td><p>Region is the name of the region where the worker pool should be deployed to.</p></td></tr><tr><td><code>secretRef</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#secretreference-v1-core>Kubernetes core/v1.SecretReference</a></em></td><td><p>SecretRef is a reference to a secret that contains the cloud provider specific credentials.</p></td></tr><tr><td><code>sshPublicKey</code></br><em>[]byte</em></td><td><em>(Optional)</em><p>SSHPublicKey is the public SSH key that should be used with these workers.</p></td></tr><tr><td><code>pools</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.WorkerPool>[]WorkerPool</a></em></td><td><p>Pools is a list of worker pools.</p></td></tr></tbody></table><h3 id=extensions.gardener.cloud/v1alpha1.WorkerStatus>WorkerStatus</h3><p>(<em>Appears on:</em>
<a href=#extensions.gardener.cloud/v1alpha1.Worker>Worker</a>)</p><p><p>WorkerStatus is the status for a Worker resource.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>DefaultStatus</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.DefaultStatus>DefaultStatus</a></em></td><td><p>(Members of <code>DefaultStatus</code> are embedded into this type.)</p><p>DefaultStatus is a structure containing common fields used by all extension resources.</p></td></tr><tr><td><code>machineDeployments</code></br><em><a href=#extensions.gardener.cloud/v1alpha1.MachineDeployment>[]MachineDeployment</a></em></td><td><p>MachineDeployments is a list of created machine deployments. It will be used to e.g. configure
the cluster-autoscaler properly.</p></td></tr></tbody></table><hr><p><em>Generated with <a href=https://github.com/ahmetb/gen-crd-api-reference-docs>gen-crd-api-reference-docs</a></em></p></div><div class=td-content style=page-break-before:always><h1 id=pg-6c772da78ca0b2c45bfdebe9d8fcc109>4.3 - Settings</h1><p>Packages:</p><ul><li><a href=#settings.gardener.cloud%2fv1alpha1>settings.gardener.cloud/v1alpha1</a></li></ul><h2 id=settings.gardener.cloud/v1alpha1>settings.gardener.cloud/v1alpha1</h2><p><p>Package v1alpha1 is a version of the API.</p></p>Resource Types:<ul><li><a href=#settings.gardener.cloud/v1alpha1.ClusterOpenIDConnectPreset>ClusterOpenIDConnectPreset</a></li><li><a href=#settings.gardener.cloud/v1alpha1.OpenIDConnectPreset>OpenIDConnectPreset</a></li></ul><h3 id=settings.gardener.cloud/v1alpha1.ClusterOpenIDConnectPreset>ClusterOpenIDConnectPreset</h3><p><p>ClusterOpenIDConnectPreset is a OpenID Connect configuration that is applied
to a Shoot objects cluster-wide.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>settings.gardener.cloud/v1alpha1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>ClusterOpenIDConnectPreset</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#settings.gardener.cloud/v1alpha1.ClusterOpenIDConnectPresetSpec>ClusterOpenIDConnectPresetSpec</a></em></td><td><p>Spec is the specification of this OpenIDConnect preset.</p><br><br><table><tr><td><code>OpenIDConnectPresetSpec</code></br><em><a href=#settings.gardener.cloud/v1alpha1.OpenIDConnectPresetSpec>OpenIDConnectPresetSpec</a></em></td><td><p>(Members of <code>OpenIDConnectPresetSpec</code> are embedded into this type.)</p></td></tr><tr><td><code>projectSelector</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#labelselector-v1-meta>Kubernetes meta/v1.LabelSelector</a></em></td><td><em>(Optional)</em><p>Project decides whether to apply the configuration if the
Shoot is in a specific Project matching the label selector.
Use the selector only if the OIDC Preset is opt-in, because end
users may skip the admission by setting the labels.
Defaults to the empty LabelSelector, which matches everything.</p></td></tr></table></td></tr></tbody></table><h3 id=settings.gardener.cloud/v1alpha1.OpenIDConnectPreset>OpenIDConnectPreset</h3><p><p>OpenIDConnectPreset is a OpenID Connect configuration that is applied
to a Shoot in a namespace.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code></br>string</td><td><code>settings.gardener.cloud/v1alpha1</code></td></tr><tr><td><code>kind</code></br>string</td><td><code>OpenIDConnectPreset</code></td></tr><tr><td><code>metadata</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#objectmeta-v1-meta>Kubernetes meta/v1.ObjectMeta</a></em></td><td><p>Standard object metadata.</p>Refer to the Kubernetes API documentation for the fields of the
<code>metadata</code> field.</td></tr><tr><td><code>spec</code></br><em><a href=#settings.gardener.cloud/v1alpha1.OpenIDConnectPresetSpec>OpenIDConnectPresetSpec</a></em></td><td><p>Spec is the specification of this OpenIDConnect preset.</p><br><br><table><tr><td><code>server</code></br><em><a href=#settings.gardener.cloud/v1alpha1.KubeAPIServerOpenIDConnect>KubeAPIServerOpenIDConnect</a></em></td><td><p>Server contains the kube-apiserver&rsquo;s OpenID Connect configuration.
This configuration is not overwritting any existing OpenID Connect
configuration already set on the Shoot object.</p></td></tr><tr><td><code>client</code></br><em><a href=#settings.gardener.cloud/v1alpha1.OpenIDConnectClientAuthentication>OpenIDConnectClientAuthentication</a></em></td><td><em>(Optional)</em><p>Client contains the configuration used for client OIDC authentication
of Shoot clusters.
This configuration is not overwritting any existing OpenID Connect
client authentication already set on the Shoot object.</p></td></tr><tr><td><code>shootSelector</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#labelselector-v1-meta>Kubernetes meta/v1.LabelSelector</a></em></td><td><em>(Optional)</em><p>ShootSelector decides whether to apply the configuration if the
Shoot has matching labels.
Use the selector only if the OIDC Preset is opt-in, because end
users may skip the admission by setting the labels.
Default to the empty LabelSelector, which matches everything.</p></td></tr><tr><td><code>weight</code></br><em>int32</em></td><td><p>Weight associated with matching the corresponding preset,
in the range 1-100.
Required.</p></td></tr></table></td></tr></tbody></table><h3 id=settings.gardener.cloud/v1alpha1.ClusterOpenIDConnectPresetSpec>ClusterOpenIDConnectPresetSpec</h3><p>(<em>Appears on:</em>
<a href=#settings.gardener.cloud/v1alpha1.ClusterOpenIDConnectPreset>ClusterOpenIDConnectPreset</a>)</p><p><p>ClusterOpenIDConnectPresetSpec contains the OpenIDConnect specification and
project selector matching Shoots in Projects.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>OpenIDConnectPresetSpec</code></br><em><a href=#settings.gardener.cloud/v1alpha1.OpenIDConnectPresetSpec>OpenIDConnectPresetSpec</a></em></td><td><p>(Members of <code>OpenIDConnectPresetSpec</code> are embedded into this type.)</p></td></tr><tr><td><code>projectSelector</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#labelselector-v1-meta>Kubernetes meta/v1.LabelSelector</a></em></td><td><em>(Optional)</em><p>Project decides whether to apply the configuration if the
Shoot is in a specific Project matching the label selector.
Use the selector only if the OIDC Preset is opt-in, because end
users may skip the admission by setting the labels.
Defaults to the empty LabelSelector, which matches everything.</p></td></tr></tbody></table><h3 id=settings.gardener.cloud/v1alpha1.KubeAPIServerOpenIDConnect>KubeAPIServerOpenIDConnect</h3><p>(<em>Appears on:</em>
<a href=#settings.gardener.cloud/v1alpha1.OpenIDConnectPresetSpec>OpenIDConnectPresetSpec</a>)</p><p><p>KubeAPIServerOpenIDConnect contains configuration settings for the OIDC provider.
Note: Descriptions were taken from the Kubernetes documentation.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>caBundle</code></br><em>string</em></td><td><em>(Optional)</em><p>If set, the OpenID server&rsquo;s certificate will be verified by one of the authorities in the oidc-ca-file, otherwise the host&rsquo;s root CA set will be used.</p></td></tr><tr><td><code>clientID</code></br><em>string</em></td><td><p>The client ID for the OpenID Connect client.
Required.</p></td></tr><tr><td><code>groupsClaim</code></br><em>string</em></td><td><em>(Optional)</em><p>If provided, the name of a custom OpenID Connect claim for specifying user groups. The claim value is expected to be a string or array of strings. This field is experimental, please see the authentication documentation for further details.</p></td></tr><tr><td><code>groupsPrefix</code></br><em>string</em></td><td><em>(Optional)</em><p>If provided, all groups will be prefixed with this value to prevent conflicts with other authentication strategies.</p></td></tr><tr><td><code>issuerURL</code></br><em>string</em></td><td><p>The URL of the OpenID issuer, only HTTPS scheme will be accepted. If set, it will be used to verify the OIDC JSON Web Token (JWT).
Required.</p></td></tr><tr><td><code>requiredClaims</code></br><em>map[string]string</em></td><td><em>(Optional)</em><p>key=value pairs that describes a required claim in the ID Token. If set, the claim is verified to be present in the ID Token with a matching value.</p></td></tr><tr><td><code>signingAlgs</code></br><em>[]string</em></td><td><em>(Optional)</em><p>List of allowed JOSE asymmetric signing algorithms. JWTs with a &lsquo;alg&rsquo; header value not in this list will be rejected. Values are defined by RFC 7518 <a href=https://tools.ietf.org/html/rfc7518#section-3.1>https://tools.ietf.org/html/rfc7518#section-3.1</a>
Defaults to [RS256]</p></td></tr><tr><td><code>usernameClaim</code></br><em>string</em></td><td><em>(Optional)</em><p>The OpenID claim to use as the user name. Note that claims other than the default (&lsquo;sub&rsquo;) is not guaranteed to be unique and immutable. This field is experimental, please see the authentication documentation for further details.
Defaults to &ldquo;sub&rdquo;.</p></td></tr><tr><td><code>usernamePrefix</code></br><em>string</em></td><td><em>(Optional)</em><p>If provided, all usernames will be prefixed with this value. If not provided, username claims other than &lsquo;email&rsquo; are prefixed by the issuer URL to avoid clashes. To skip any prefixing, provide the value &lsquo;-&rsquo;.</p></td></tr></tbody></table><h3 id=settings.gardener.cloud/v1alpha1.OpenIDConnectClientAuthentication>OpenIDConnectClientAuthentication</h3><p>(<em>Appears on:</em>
<a href=#settings.gardener.cloud/v1alpha1.OpenIDConnectPresetSpec>OpenIDConnectPresetSpec</a>)</p><p><p>OpenIDConnectClientAuthentication contains configuration for OIDC clients.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>secret</code></br><em>string</em></td><td><em>(Optional)</em><p>The client Secret for the OpenID Connect client.</p></td></tr><tr><td><code>extraConfig</code></br><em>map[string]string</em></td><td><em>(Optional)</em><p>Extra configuration added to kubeconfig&rsquo;s auth-provider.
Must not be any of idp-issuer-url, client-id, client-secret, idp-certificate-authority, idp-certificate-authority-data, id-token or refresh-token</p></td></tr></tbody></table><h3 id=settings.gardener.cloud/v1alpha1.OpenIDConnectPresetSpec>OpenIDConnectPresetSpec</h3><p>(<em>Appears on:</em>
<a href=#settings.gardener.cloud/v1alpha1.OpenIDConnectPreset>OpenIDConnectPreset</a>,
<a href=#settings.gardener.cloud/v1alpha1.ClusterOpenIDConnectPresetSpec>ClusterOpenIDConnectPresetSpec</a>)</p><p><p>OpenIDConnectPresetSpec contains the Shoot selector for which
a specific OpenID Connect configuration is applied.</p></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>server</code></br><em><a href=#settings.gardener.cloud/v1alpha1.KubeAPIServerOpenIDConnect>KubeAPIServerOpenIDConnect</a></em></td><td><p>Server contains the kube-apiserver&rsquo;s OpenID Connect configuration.
This configuration is not overwritting any existing OpenID Connect
configuration already set on the Shoot object.</p></td></tr><tr><td><code>client</code></br><em><a href=#settings.gardener.cloud/v1alpha1.OpenIDConnectClientAuthentication>OpenIDConnectClientAuthentication</a></em></td><td><em>(Optional)</em><p>Client contains the configuration used for client OIDC authentication
of Shoot clusters.
This configuration is not overwritting any existing OpenID Connect
client authentication already set on the Shoot object.</p></td></tr><tr><td><code>shootSelector</code></br><em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#labelselector-v1-meta>Kubernetes meta/v1.LabelSelector</a></em></td><td><em>(Optional)</em><p>ShootSelector decides whether to apply the configuration if the
Shoot has matching labels.
Use the selector only if the OIDC Preset is opt-in, because end
users may skip the admission by setting the labels.
Default to the empty LabelSelector, which matches everything.</p></td></tr><tr><td><code>weight</code></br><em>int32</em></td><td><p>Weight associated with matching the corresponding preset,
in the range 1-100.
Required.</p></td></tr></tbody></table><hr><p><em>Generated with <a href=https://github.com/ahmetb/gen-crd-api-reference-docs>gen-crd-api-reference-docs</a></em></p></div><div class=td-content style=page-break-before:always><h1 id=pg-4985cb55ddfb184639d767ec54b9f0f7>5 - Contribute</h1><div class=lead>Contributors guides for code and documentation</div><h1 id=contributing-to-gardener>Contributing to Gardener</h1><h2 id=code-of-conduct>Code of conduct</h2><p>All members of the Gardener community must abide by the
<a href=https://github.com/cncf/foundation/blob/master/code-of-conduct.md>CNCF Code of Conduct</a>.
Only by respecting each other can we develop a productive, collaborative community.
Instances of abusive, harassing, or otherwise unacceptable behavior may be reported by contacting <a href=mailto:gardener.opensource@sap.com>gardener.opensource@sap.com</a> and/or a Gardener project maintainer.</p><h2 id=contributing>Contributing</h2><p>Gardener uses GitHub to manage reviews of pull requests.</p><ul><li><p>If you are a new contributor see: <a href=#steps-to-contribute>Steps to Contribute</a></p></li><li><p>If you have a trivial fix or improvement, go ahead and create a pull request,
addressing (with <code>@...</code>) a suitable maintainer of this repository (see
<a href=https://github.com/gardener/gardener/blob/master/CODEOWNERS>CODEOWNERS</a> of the
repository you want to contribute to) in the description of the pull request.</p></li><li><p>If you plan to do something more involved, first discuss your ideas
on our <a href=https://groups.google.com/forum/?fromgroups#!forum/gardener>mailing list</a>.
This will avoid unnecessary work and surely give you and us a good deal
of inspiration.</p></li><li><p>Relevant coding style guidelines are the <a href=https://github.com/golang/go/wiki/CodeReviewComments>Go Code Review
Comments</a>
and the <em>Formatting and style</em> section of Peter Bourgon&rsquo;s <a href=http://peter.bourgon.org/go-in-production/#formatting-and-style>Go: Best
Practices for Production
Environments</a>.</p></li></ul><h2 id=steps-to-contribute>Steps to Contribute</h2><p>Should you wish to work on an issue, please claim it first by commenting on the GitHub issue that you want to work on it. This is to prevent duplicated efforts from contributors on the same issue.</p><p>If you have questions about one of the issues, with or without the tag, please comment on them and one of the maintainers will clarify it.</p><p>We kindly ask you to follow the <a href=#Pull-Request-Checklist>Pull Request Checklist</a> to ensure reviews can happen accordingly.</p><h2 id=contributing-code>Contributing Code</h2><p>You are welcome to contribute code to Gardener in order to fix a bug or to implement a new feature.</p><p>The following rules govern code contributions:</p><ul><li>Contributions must be licensed under the <a href=http://www.apache.org/licenses/LICENSE-2.0>Apache 2.0 License</a></li><li>You need to sign the <a href=#developer-certificate-of-origin>Developer Certificate of Origin</a>.</li></ul><h2 id=contributing-documentation>Contributing Documentation</h2><p>You are welcome to contribute documentation to Gardener.</p><p>The following rules govern documentation contributions:</p><ul><li>Contributions must be licensed under the <a href=https://creativecommons.org/licenses/by/4.0/legalcode>Creative Commons Attribution 4.0 International License</a></li><li>You need to sign the <a href=#developer-certificate-of-origin>Developer Certificate of Origin</a>.</li></ul><h2 id=developer-certificate-of-origin>Developer Certificate of Origin</h2><p>Due to legal reasons, contributors will be asked to accept a Developer Certificate of Origin (DCO) before they submit the first pull request to this projects, this happens in an automated fashion during the submission process. We use <a href=https://developercertificate.org/>the standard DCO text of the Linux Foundation</a>.</p><h2 id=pull-request-checklist>Pull Request Checklist</h2><ul><li><p>Branch from the master branch and, if needed, rebase to the current master branch before submitting your pull request. If it doesn&rsquo;t merge cleanly with master you may be asked to rebase your changes.</p></li><li><p>Commits should be as small as possible, while ensuring that each commit is correct independently (i.e., each commit should compile and pass tests).</p></li><li><p>Test your changes as thoroughly as possible before your commit them. Preferably, automate your test by unit / integration (e.g. <a href=https://github.com/gardener/gardener/blob/master/docs/testing/integration_tests.md>Gardener integration testing</a>) tests. If tested manually, provide information about the test scope in the PR description (e.g. “Test passed: Upgrade K8s version from 1.14.5 to 1.15.2 on AWS, Azure, GCP, Alicloud, Openstack.”).</p></li><li><p>Create <em>Work In Progress [WIP]</em> pull requests only if you need a clarification or an explicit review before you can continue your work item.</p></li><li><p>If your patch is not getting reviewed or you need a specific person to review it, you can @-reply a reviewer asking for a review in the pull request or a comment, or you can ask for a review on our <a href=https://groups.google.com/forum/?fromgroups#!forum/gardener>mailing list</a>.</p></li><li><p>If you add new features, make sure that they are documented in the <a href=https://github.com/gardener/documentation>Gardener documentation</a></p></li><li><p>If your changes are relevant for operators, consider to update the <a href=https://github.com/gardener/ops-toolbelt>ops toolbelt image</a></p></li><li><p>Post review:</p><ul><li>If a review requires you to change your commit(s), please test the changes again.</li><li>Amend the affected commit(s) and force push onto your branch.</li><li>Set respective comments in your GitHub review to resolved.</li><li>Create a general PR comment to notify the reviewers that your amendments are ready for another round of review.</li></ul></li></ul><h2 id=contributing-bigger-changes>Contributing Bigger Changes</h2><p>If you want to contribute bigger changes to Gardener, such as when introducing new API resources and their corresponding controllers, or implementing an approved <a href=https://github.com/gardener/gardener/tree/master/docs/proposals>Gardener Enhancement Proposal</a>, follow these guidelines:</p><ul><li><p>Avoid proposing a big change in one single PR. Instead, split your work into multiple stages which are independently mergeable and create one PR for each stage. For example, if introducing a new API resource and its controller, these stages could be:</p><ul><li>API resource types, including defaults and generated code.</li><li>API resource validation.</li><li>API server storage.</li><li>Admission plugin(s), if any.</li><li>Controller(s), including changes to existing controllers. Split this phase further into different functional subsets if appropriate.</li></ul></li><li><p>If you realize later that changes to artifacts introduced in a previous stage are required, by all means make them and explain in the PR why they were needed.</p></li><li><p>Consider splitting a big PR further into multiple commits to allow for more focused reviews. For example, you could add unit tests / documentation in separate commits from the rest of the code. If you have to adapt your PR to review feedback, prefer doing that also in a separate commit to make it easier for reviewers to check how their feedback has been addressed.</p></li><li><p>To make the review process more efficient and avoid too many long discussions in the PR itself, ask for a &ldquo;main reviewer&rdquo; to be assigned to your change, then work with this person to make sure he or she understands it in detail, and agree together on any improvements that may be needed. If you can&rsquo;t reach an agreement on certain topics, comment on the PR and invite other people to join the discussion.</p></li><li><p>Even if you have a &ldquo;main reviewer&rdquo; assigned, you may still get feedback from other reviewers. In general, these &ldquo;non-main reviewers&rdquo; are advised to focus more on the design and overall approach rather than the implementation details. Make sure that you address any concerns on this level appropriately.</p></li></ul><h2 id=issues-and-planning>Issues and Planning</h2><p>We use GitHub issues to track bugs and enhancement requests. Please provide as much context as possible when you open an issue. The information you provide must be comprehensive enough to reproduce that issue for the assignee. Therefore, contributors may use but aren&rsquo;t restricted to the issue template provided by the Gardener maintainers.</p><p>ZenHub is used for planning:</p><ul><li>Install the <a href=https://chrome.google.com/webstore/detail/zenhub-for-github/ogcgkffhplmphkaahpmffcafajaocjbd>ZenHub Chrome plugin</a></li><li>Login to <a href=https://www.zenhub.com/>ZenHub</a></li><li>Open the <a href=https://app.zenhub.com/workspace/o/gardener/gardener>Gardener ZenHub workspace</a></li></ul><h2 id=security-release-process>Security Release Process</h2><p>See <a href=https://github.com/gardener/documentation/blob/master/security-release-process.md>Security Release Process</a></p><h2 id=community>Community</h2><h3 id=slack-channel>Slack Channel</h3><p><a href=https://kubernetes.slack.com/messages/gardener>#gardener</a>, sign up <a href=http://slack.k8s.io/>here</a></p><h3 id=mailing-list>Mailing List</h3><p><a href=https://groups.google.com/forum/?fromgroups#!forum/gardener>gardener@googlegroups.com</a></p><p>The mailing list is hosted through Google Groups. To receive the lists' emails, <a href=https://support.google.com/groups/answer/1067205>join</a> the group, as you would any other Google Group.</p><h3 id=twitter>Twitter</h3><p>Follow <a href=https://twitter.com/GardenerProject>@GardenerProject</a> on Twitter. Please mention @GardenerProject
in your own posts about Gardener.</p><h3 id=accessing-community-documents>Accessing community documents</h3><p>In order to foster real time collaboration there are working documents and notes that are taken in Google Docs,
and then transferred to this repository if appropriate.</p><p>To gain edit access for these documents, you must subscribe to the
<a href=https://groups.google.com/forum/?fromgroups#!forum/gardener>gardener mailing list</a>,
as these documents are shared automatically with anyone who subscribes to that list.</p><h3 id=bi-weekly-meetings>Bi-Weekly Meetings</h3><p>We have a PUBLIC and RECORDED bi-weekly meeting. We meet every other Friday at <a href="https://www.google.de/search?q=10+CET+to+local+time">10:00 CET</a> over Zoom. Find recordings in the <a href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw/videos>Gardener Youtube channel</a>. Let us know if you want to participate and live in a timezone where 10:00 CET is in the night, we can also schedule meetings on Thursday <a href="https://www.google.de/search?q=17+CET+to+local+time">17:00 CET</a>.</p><p>See the meeting calendar on the web at <a href="https://calendar.google.com/calendar/embed?src=gardener.cloud.community%40gmail.com">calendar.google.com</a>, or paste this <a href=https://calendar.google.com/calendar/ical/gardener.cloud.community%40gmail.com/public/basic.ics>iCal url</a> into any iCal client.</p><p>If you have a topic you&rsquo;d like to present or would like to see discussed, please propose a specific date on the <a href=https://docs.google.com/document/d/1314v8ziVNQPjdBrWp-Y4BYrTDlv7dq2cWDFIa9SMaP4>Gardener Community Meeting Agenda</a>. Find minutes in the same document. Please upload slides or other documents you presented to the
<a href=https://drive.google.com/drive/u/0/folders/1myXFoaFL_9fYJdUwnZcIXMBpx3dynhM8>Gardener Community Meeting folder</a>. Subscribe to the <a href=https://groups.google.com/forum/?fromgroups#!forum/gardener>gardener mailing list</a> to get edit permissions.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a5fa4df509236d74f89bbc22f343d978>5.1 - Code</h1><p>You are welcome to <strong>contribute code</strong> to Gardener in order to fix a bug or to implement a new feature.</p><p>The following rules govern code contributions:</p><ul><li>Contributions must be licensed under the <a href=http://www.apache.org/licenses/LICENSE-2.0>Apache 2.0 License</a></li><li>You need to sign the Contributor License Agreement. We are using <em><a href=https://cla-assistant.io/>CLA assistant</a></em> providing a click-through workflow for accepting the CLA. For company contributors additionally the company needs to sign a corporate license agreement. See the following sections for details.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2525203726f294062263705771e54f3f>5.1.1 - CI/CD</h1><h1 id=cicd>CI/CD</h1><p>As an execution environment for CI/CD workloads, we use <a href=https://concourse-ci.org>Concourse</a>.
We however abstract from the underlying &ldquo;build executor&rdquo; and instead offer a
<code>Pipeline Definition Contract</code>, through which components declare their build pipelines as
required.</p><p><img src=/__resources/overview_63fb18.png alt=Overview></p><p>In order to run continuous delivery workloads for all components contributing to the
<a href=https://github.com/gardener>Gardener</a> project, we operate a central service.</p><p>Typical workloads encompass the execution of tests and builds of a variety of technologies,
as well as building and publishing container images, typically containing build results.</p><p>We are building our CI/CD offering around some principles:</p><ul><li><em>container-native</em> - each workload is executed within a container environment. Components may customise used container images</li><li><em>automation</em> - pipelines are generated without manual interaction</li><li><em>self-service</em> - components customise their pipelines by changing their sources</li><li><em>standardisation</em></li></ul><p><strong>Learn more on our: <a href=https://gardener.github.io/cc-utils/>Build Pipeline Reference Manual</a></strong></p></div><div class=td-content style=page-break-before:always><h1 id=pg-82bb154ddb490dade2d3681b3c82db85>5.1.2 - Configuration and Usage</h1><h1 id=gardener-configuration-and-usage>Gardener Configuration and Usage</h1><p>Gardener automates the full lifecycle of Kubernetes clusters as a service.
Additionally, it has several extension points allowing external controllers to plug-in to the lifecycle.
As a consequence, there are several configuration options for the various custom resources that are partially required.</p><p>This document describes the</p><ol><li><a href=#configuration-and-usage-of-gardener-as-operatoradministrator>configuration and usage of Gardener as operator/administrator</a>.</li><li><a href=#configuration-and-usage-of-gardener-as-end-userstakeholdercustomer>configuration and usage of Gardener as end-user/stakeholder/customer</a>.</li></ol><h2 id=configuration-and-usage-of-gardener-as-operatoradministrator>Configuration and Usage of Gardener as Operator/Administrator</h2><p>When we use the terms &ldquo;operator/administrator&rdquo; we refer to both the people deploying and operating Gardener.
Gardener consists out of four components:</p><ol><li><code>gardener-apiserver</code>, a Kubernetes-native API extension that serves custom resources in the Kubernetes-style (like <code>Seed</code>s and <code>Shoot</code>s), and a component that contains multiple admission plugins.</li><li><code>gardener-controller-manager</code>, a component consisting out of multiple controllers that implement reconciliation and deletion flows for some of the custom resources (e.g., it contains the logic for maintaining <code>Shoot</code>s, reconciling <code>Plant</code>s, etc.).</li><li><code>gardener-scheduler</code>, a component that assigns newly created <code>Shoot</code> clusters to appropriate <code>Seed</code> clusters.</li><li><code>gardenlet</code>, a component running in seed clusters and consisting out of multiple controllers that implement reconciliation and deletion flows for some of the custom resources (e.g., it contains the logic for reconciliation and deletion of <code>Shoot</code>s).</li></ol><p>Each of these components have various configuration options.
The <code>gardener-apiserver</code> uses the standard API server library maintained by the Kubernetes community, and as such it mainly supports command line flags.
The two other components are using so-called componentconfig files that describe their configuration in a Kubernetes-style versioned object.</p><h3 id=configuration-file-for-gardener-controller-manager>Configuration file for Gardener controller manager</h3><p>The Gardener controller manager does only support one command line flag which should be a path to a valid controller-manager configuration file.
Please take a look at <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/usage/../../example/20-componentconfig-gardener-controller-manager.yaml>this</a> example configuration.</p><h3 id=configuration-file-for-gardener-scheduler>Configuration file for Gardener scheduler</h3><p>The Gardener scheduler also only supports one command line flag which should be a path to a valid scheduler configuration file.
Please take a look at <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/usage/../../example/20-componentconfig-gardener-scheduler.yaml>this</a> example configuration.
Information about the concepts of the Gardener scheduler can be found <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/usage/../concepts/scheduler.md>here</a></p><h3 id=configuration-file-for-gardenlet>Configuration file for Gardenlet</h3><p>The Gardenlet also only supports one command line flag which should be a path to a valid gardenlet configuration file.
Please take a look at <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/usage/../../example/20-componentconfig-gardenlet.yaml>this</a> example configuration.
Information about the concepts of the Gardenlet can be found <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/usage/../concepts/gardenlet.md>here</a></p><h3 id=system-configuration>System configuration</h3><p>After successful deployment of the four components you need to setup the system.
Let&rsquo;s first focus on some &ldquo;static&rdquo; configuration.
When the <code>gardenlet</code> starts it scans the <code>garden</code> namespace of the garden cluster for <code>Secret</code>s that have influence on its reconciliation loops, mainly the <code>Shoot</code> reconciliation:</p><ul><li><p><strong>Internal domain secret</strong>, contains the DNS provider credentials (having appropriate privileges) which will be used to create/delete so-called &ldquo;internal&rdquo; DNS records for the Shoot clusters, please see <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/usage/../../example/10-secret-internal-domain.yaml>this</a> for an example.</p><ul><li>This secret is used in order to establish a stable endpoint for shoot clusters which is used internally by all control plane components.</li><li>The DNS records are normal DNS records but called &ldquo;internal&rdquo; in our scenario because only the kubeconfigs for the control plane components use this endpoint when talking to the shoot clusters.</li><li>It is forbidden to change the internal domain secret if there are existing shoot clusters.</li></ul></li><li><p><strong>Default domain secrets</strong> (optional), contain the DNS provider credentials (having appropriate privileges) which will be used to create/delete DNS records for a default domain for shoots (e.g., <code>example.com</code>), please see <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/usage/../../example/10-secret-default-domain.yaml>this</a> for an example.</p><ul><li>Not every end-user/stakeholder/customer has its own domain, however, Gardener needs to create a DNS record for every shoot cluster.</li><li>As landscape operator you might want to define a default domain owned and controlled by you that is used for all shoot clusters that don&rsquo;t specify their own domain.</li></ul></li></ul><p>:warning: Please note that the mentioned domain secrets are only needed if you have at least one seed cluster that is not tainted with <code>seed.gardener.cloud/disable-dns</code>.
Seeds with this taint don&rsquo;t create any DNS records for shoots scheduled on it, hence, if you only have such seeds, you don&rsquo;t need to create the domain secrets.</p><ul><li><p><strong>Alerting secrets</strong> (optional), contain the alerting configuration and credentials for the <a href=https://prometheus.io/docs/alerting/alertmanager/>AlertManager</a> to send email alerts. It is also possible to configure the monitoring stack to send alerts to an AlertManager not deployed by Gardener to handle alerting. Please see <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/usage/../../example/10-secret-alerting.yaml>this</a> for an example.</p><ul><li>If email alerting is configured:<ul><li>An AlertManager is deployed into each seed cluster that handles the alerting for all shoots on the seed cluster.</li><li>Gardener will inject the SMTP credentials into the configuration of the AlertManager.</li><li>The AlertManager will send emails to the configured email address in case any alerts are firing.</li></ul></li><li>If an external AlertManager is configured:<ul><li>Each shoot has a <a href=https://prometheus.io/docs/introduction/overview/>Prometheus</a> responsible for monitoring components and sending out alerts. The alerts will be sent to a URL configured in the alerting secret.</li><li>This external AlertManager is not managed by Gardener and can be configured however the operator sees fit.</li><li>Supported authentication types are no authentication, basic, or mutual TLS.</li></ul></li></ul></li><li><p><strong>OpenVPN Diffie-Hellmann Key secret</strong> (optional), contains the self-generated Diffie-Hellmann key used by OpenVPN in your landscape, please see <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/usage/../../example/10-secret-openvpn-diffie-hellman.yaml>this</a> for an example.</p><ul><li>If you don&rsquo;t specify a custom key then a default key is used, but for productive landscapes it&rsquo;s recommend to create a landscape-specific key and define it.</li></ul></li><li><p><strong>Global monitoring secrets</strong> (optional), contains basic authentication credentials for the Prometheus aggregating metrics for all clusters.</p><ul><li>These secrets are synced to each seed cluster and used to gain access to the aggregate monitoring components.</li></ul></li></ul><p>Apart from this &ldquo;static&rdquo; configuration there are several custom resources extending the Kubernetes API and used by Gardener.
As an operator/administrator you have to configure some of them to make the system work.</p><h3 id=configuration-and-usage-of-gardener-as-end-userstakeholdercustomer>Configuration and Usage of Gardener as End-User/Stakeholder/Customer</h3><p>As an end-user/stakeholder/customer you are using a Gardener landscape that has been setup for you by another team.
You don&rsquo;t need to care about how Gardener itself has to be configured or how it has to be deployed.
Take a look at <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/usage/../concepts/apiserver.md>this document</a> - it describes which resources are offered by Gardener.
You may want to have a more detailed look for <code>Project</code>s, <code>SecretBinding</code>s, <code>Shoot</code>s, <code>Plant</code>s, and <code>(Cluster)OpenIDConnectPreset</code>s.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-279d8411d77850358749a0c9f0e65b7c>5.1.3 - Contribution Guide</h1><h1 id=contributing-to-gardener>Contributing to Gardener</h1><h2 id=code-of-conduct>Code of conduct</h2><p>All members of the Gardener community must abide by the
<a href=https://github.com/cncf/foundation/blob/master/code-of-conduct.md>CNCF Code of Conduct</a>.
Only by respecting each other can we develop a productive, collaborative community.
Instances of abusive, harassing, or otherwise unacceptable behavior may be reported by contacting <a href=mailto:gardener.opensource@sap.com>gardener.opensource@sap.com</a> and/or a Gardener project maintainer.</p><h2 id=contributing>Contributing</h2><p>Gardener uses GitHub to manage reviews of pull requests.</p><ul><li><p>If you are a new contributor see: <a href=#steps-to-contribute>Steps to Contribute</a></p></li><li><p>If you have a trivial fix or improvement, go ahead and create a pull request,
addressing (with <code>@...</code>) a suitable maintainer of this repository (see
<a href=https://github.com/gardener/gardener/blob/master/CODEOWNERS>CODEOWNERS</a> of the
repository you want to contribute to) in the description of the pull request.</p></li><li><p>If you plan to do something more involved, first discuss your ideas
on our <a href=https://groups.google.com/forum/?fromgroups#!forum/gardener>mailing list</a>.
This will avoid unnecessary work and surely give you and us a good deal
of inspiration.</p></li><li><p>Relevant coding style guidelines are the <a href=https://github.com/golang/go/wiki/CodeReviewComments>Go Code Review
Comments</a>
and the <em>Formatting and style</em> section of Peter Bourgon&rsquo;s <a href=http://peter.bourgon.org/go-in-production/#formatting-and-style>Go: Best
Practices for Production
Environments</a>.</p></li></ul><h2 id=steps-to-contribute>Steps to Contribute</h2><p>Should you wish to work on an issue, please claim it first by commenting on the GitHub issue that you want to work on it. This is to prevent duplicated efforts from contributors on the same issue.</p><p>If you have questions about one of the issues, with or without the tag, please comment on them and one of the maintainers will clarify it.</p><p>We kindly ask you to follow the <a href=#Pull-Request-Checklist>Pull Request Checklist</a> to ensure reviews can happen accordingly.</p><h2 id=contributing-code>Contributing Code</h2><p>You are welcome to contribute code to Gardener in order to fix a bug or to implement a new feature.</p><p>The following rules govern code contributions:</p><ul><li>Contributions must be licensed under the <a href=http://www.apache.org/licenses/LICENSE-2.0>Apache 2.0 License</a></li><li>You need to sign the <a href=#developer-certificate-of-origin>Developer Certificate of Origin</a>.</li></ul><h2 id=contributing-documentation>Contributing Documentation</h2><p>You are welcome to contribute documentation to Gardener.</p><p>The following rules govern documentation contributions:</p><ul><li>Contributions must be licensed under the <a href=https://creativecommons.org/licenses/by/4.0/legalcode>Creative Commons Attribution 4.0 International License</a></li><li>You need to sign the <a href=#developer-certificate-of-origin>Developer Certificate of Origin</a>.</li></ul><h2 id=developer-certificate-of-origin>Developer Certificate of Origin</h2><p>Due to legal reasons, contributors will be asked to accept a Developer Certificate of Origin (DCO) before they submit the first pull request to this projects, this happens in an automated fashion during the submission process. We use <a href=https://developercertificate.org/>the standard DCO text of the Linux Foundation</a>.</p><h2 id=pull-request-checklist>Pull Request Checklist</h2><ul><li><p>Branch from the master branch and, if needed, rebase to the current master branch before submitting your pull request. If it doesn&rsquo;t merge cleanly with master you may be asked to rebase your changes.</p></li><li><p>Commits should be as small as possible, while ensuring that each commit is correct independently (i.e., each commit should compile and pass tests).</p></li><li><p>Test your changes as thoroughly as possible before your commit them. Preferably, automate your test by unit / integration (e.g. <a href=https://github.com/gardener/gardener/blob/master/docs/testing/integration_tests.md>Gardener integration testing</a>) tests. If tested manually, provide information about the test scope in the PR description (e.g. “Test passed: Upgrade K8s version from 1.14.5 to 1.15.2 on AWS, Azure, GCP, Alicloud, Openstack.”).</p></li><li><p>Create <em>Work In Progress [WIP]</em> pull requests only if you need a clarification or an explicit review before you can continue your work item.</p></li><li><p>If your patch is not getting reviewed or you need a specific person to review it, you can @-reply a reviewer asking for a review in the pull request or a comment, or you can ask for a review on our <a href=https://groups.google.com/forum/?fromgroups#!forum/gardener>mailing list</a>.</p></li><li><p>Post review:</p><ul><li>If a review requires you to change your commit(s), please test the changes again.</li><li>Amend the affected commit(s) and force push onto your branch.</li><li>Set respective comments in your GitHub review to resolved.</li><li>Create a general PR comment to notify the reviewers that your amendments are ready for another round of review.</li></ul></li></ul><h2 id=issues-and-planning>Issues and Planning</h2><p>We use GitHub issues to track bugs and enhancement requests. Please provide as much context as possible when you open an issue. The information you provide must be comprehensive enough to reproduce that issue for the assignee. Therefore, contributors may use but aren&rsquo;t restricted to the issue template provided by the Gardener maintainers.</p><p>ZenHub is used for planning:</p><ul><li>Install the <a href=https://chrome.google.com/webstore/detail/zenhub-for-github/ogcgkffhplmphkaahpmffcafajaocjbd>ZenHub Chrome plugin</a></li><li>Login to <a href=https://www.zenhub.com/>ZenHub</a></li><li>Open the <a href=https://app.zenhub.com/workspace/o/gardener/gardener>Gardener ZenHub workspace</a></li></ul><h2 id=security-release-process>Security Release Process</h2><p>See <a href=/docs/contribute/10_code/12-security_guide>Security Release Process</a></p><h2 id=community>Community</h2><h3 id=slack-channel>Slack Channel</h3><p><a href=https://kubernetes.slack.com/messages/gardener>#gardener</a>, sign up <a href=http://slack.k8s.io/>here</a></p><h3 id=mailing-list>Mailing List</h3><p><a href=https://groups.google.com/forum/?fromgroups#!forum/gardener>gardener@googlegroups.com</a></p><p>The mailing list is hosted through Google Groups. To receive the lists' emails, <a href=https://support.google.com/groups/answer/1067205>join</a> the group, as you would any other Google Group.</p><h3 id=twitter>Twitter</h3><p>Follow <a href=https://twitter.com/GardenerProject>@GardenerProject</a> on Twitter. Please mention @GardenerProject
in your own posts about Gardener.</p><h3 id=accessing-community-documents>Accessing community documents</h3><p>In order to foster real time collaboration there are working documents and notes that are taken in Google Docs,
and then transferred to this repository if appropriate.</p><p>To gain edit access for these documents, you must subscribe to the
<a href=https://groups.google.com/forum/?fromgroups#!forum/gardener>gardener mailing list</a>,
as these documents are shared automatically with anyone who subscribes to that list.</p><h3 id=weekly-meeting>Weekly Meeting</h3><p>We have a PUBLIC and RECORDED bi-weekly meeting. We meet every other Thursday at <a href="https://www.google.de/search?q=10+CET+to+local+time">10:00 CET</a> over Zoom. Find recordings in the <a href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw/videos>Gardener Youtube channel</a>. Let us know if you want to participate and live in a timezone which isn&rsquo;t compatible with 10:00 CET.</p><p>See the meeting calendar on the web at <a href="https://calendar.google.com/calendar/embed?src=gardener.cloud.community%40gmail.com">calendar.google.com</a>, or paste this <a href=https://calendar.google.com/calendar/ical/gardener.cloud.community%40gmail.com/public/basic.ics>iCal url</a> into any iCal client.</p><p>If you have a topic you&rsquo;d like to present or would like to see discussed, please propose a specific date on the <a href=https://docs.google.com/document/d/1314v8ziVNQPjdBrWp-Y4BYrTDlv7dq2cWDFIa9SMaP4>Gardener Community Meeting Agenda</a>. Find minutes in the same document. Please upload slides or other documents you presented to the
<a href=https://drive.google.com/drive/u/0/folders/1myXFoaFL_9fYJdUwnZcIXMBpx3dynhM8>Gardener Community Meeting folder</a>. Subscribe to the <a href=https://groups.google.com/forum/?fromgroups#!forum/gardener>gardener mailing list</a> to get edit permissions.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1cf3a14a3a218c3fe1bbf3356a18e887>5.1.4 - Dependencies</h1><h1 id=testing>Testing</h1><p>We follow the BDD-style testing principles and are leveraging the <a href=https://onsi.github.io/ginkgo/>Ginkgo</a> framework along with <a href=http://onsi.github.io/gomega/>Gomega</a> as matcher library. In order to execute the existing tests, you can use</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>make <span class=nb>test</span>         <span class=c1># runs tests</span>
make verify       <span class=c1># runs static code checks and test</span>
</code></pre></div><p>There is an additional command for analyzing the code coverage of the tests. Ginkgo will generate standard Golang cover profiles which will be translated into a HTML file by the <a href=https://blog.golang.org/cover>Go Cover Tool</a>. Another command helps you to clean up the filesystem from the temporary cover profile files and the HTML report:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>make test-cov
open gardener.coverage.html
make test-cov-clean
</code></pre></div><h3 id=sigsk8siocontroller-runtime-env-test>sigs.k8s.io/controller-runtime env test</h3><p>Some of the integration tests in Gardener are using the <code>sigs.k8s.io/controller-runtime/pkg/envtest</code> package.
It sets up a temporary control plane (etcd + kube-apiserver) against the integration tests can run.
The <code>test</code> and <code>test-cov</code> rules in the <code>Makefile</code> prepare this env test automatically by downloading the respective binaries (if not yet present) and set the necessary environment variables.</p><p>You can also run <code>go test</code> or <code>ginkgo</code> without the <code>test</code>/<code>test-cov</code> rules.
In this case you have to set the <code>KUBEBUILDER_ASSETS</code> environment variable to the path that contains the etcd + kube-apiserver binaries or you need to have the binaries pre-installed under <code>/usr/local/kubebuilder/bin</code>.</p><h2 id=dependency-management>Dependency Management</h2><p>We are using <a href=https://github.com/golang/go/wiki/Modules>go modules</a> for depedency management.
In order to add a new package dependency to the project, you can perform <code>go get &lt;PACKAGE>@&lt;VERSION></code> or edit the <code>go.mod</code> file and append the package along with the version you want to use.</p><h3 id=updating-dependencies>Updating Dependencies</h3><p>The <code>Makefile</code> contains a rule called <code>revendor</code> which performs <code>go mod vendor</code> and <code>go mod tidy</code>.
<code>go mod vendor</code> resets the main module&rsquo;s vendor directory to include all packages needed to build and test all the main module&rsquo;s packages. It does not include test code for vendored packages.
<code>go mod tidy</code> makes sure go.mod matches the source code in the module. It adds any missing modules necessary to build the current module&rsquo;s packages and dependencies, and it removes unused modules that don&rsquo;t provide any relevant packages.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>make revendor
</code></pre></div><p>The dependencies are installed into the <code>vendor</code> folder which <strong>should be added</strong> to the VCS.</p><p>:warning: Make sure that you test the code after you have updated the dependencies!</p></div><div class=td-content style=page-break-before:always><h1 id=pg-bfd4e0d1fff2782a11d588066baf1e21>5.1.5 - Deploy into a Cluster</h1><h1 id=deploying-the-gardener-into-a-kubernetes-cluster>Deploying the Gardener into a Kubernetes cluster</h1><p>Similar to Kubernetes, Gardener consists out of control plane components (Gardener API server, Gardener controller manager, Gardener scheduler), and an agent component (Gardenlet).
The control plane is deployed in the so-called garden cluster while the agent is installed into every seed cluster.
Please note that it is possible to use the garden cluster as seed cluster by simply deploying the Gardenlet into it.</p><p>We are providing <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../charts/gardener>Helm charts</a> in order to manage the various resources of the components.
Please always make sure that you use the Helm chart version that matches the Gardener version you want to deploy.</p><h2 id=deploying-the-gardener-control-plane-api-server-controller-manager-scheduler>Deploying the Gardener control plane (API server, controller manager, scheduler)</h2><p>The <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../charts/gardener/controlplane/values.yaml>configuration values</a> depict the various options to configure the different components.
Please consult <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../usage/configuration.md>this document</a> to get a detailed explanation of what can be configured for which component.
Also note that all resources and deployments need to be created in the <code>garden</code> namespace (not overrideable).</p><p>After preparing your values in a separate <code>controlplane-values.yaml</code> file, you can run the following command against your garden cluster:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>helm install charts/gardener/controlplane <span class=se>\
</span><span class=se></span>  --namespace garden <span class=se>\
</span><span class=se></span>  --name gardener-controlplane <span class=se>\
</span><span class=se></span>  -f gardener-values.yaml <span class=se>\
</span><span class=se></span>  --wait
</code></pre></div><h2 id=deploying-gardener-extensions>Deploying Gardener extensions</h2><p>Gardener is an extensible system that does not contain the logic for provider-specific things like DNS management, cloud infrastructures, network plugins, operating system configs, and many more.</p><p>You have to install extension controllers for these parts.
Please consult <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../extensions/overview.md>the documentation regarding extensions</a> to get more information.</p><h2 id=deploying-the-gardener-agent-gardenlet>Deploying the Gardener agent (Gardenlet)</h2><p>The Gardenlet requires a bootstrap token as well as a bootstrap kubeconfig in order to properly register itself with the Gardener control plane.</p><p>The <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../charts/gardener/gardenlet/values.yaml>configuration values</a> depict the various options to configure it.
Please consult <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../concepts/gardenlet.md#component-configuration>this document</a> to get a detailed explanation of what can be configured.</p><p>Prepare your values in a separate <code>gardenlet-values.yaml</code> file:</p><ol><li>Create a bootstrap token secret in the <code>kube-system</code> namespace of the garden cluster (see <a href=https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/>this</a> and <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#bootstrap-tokens>this</a>).</li><li>Create a bootstrap kubeconfig containing this token:</li></ol><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-bootstrap@default</span><span class=w>
</span><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>certificate-authority-data</span><span class=p>:</span><span class=w> </span><span class=l>&lt;ca-of-garden-cluster&gt;</span><span class=w>
</span><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://&lt;endpoint-of-garden-cluster&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-bootstrap</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-bootstrap@default</span><span class=w>
</span><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-bootstrap</span><span class=w>
</span><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>&lt;bootstrap-token&gt;</span><span class=w>
</span></code></pre></div><ol start=3><li>Provide this bootstrap kubeconfig together with a desired name and namespace to the Gardenlet Helm chart values <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../charts/gardener/gardenlet/values.yaml#L31-L35>here</a>:</li></ol><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>gardenClientConnection</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>bootstrapKubeconfig</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-kubeconfig-bootstrap</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>    </span><span class=nt>kubeconfig</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>      </span><span class=w>      </span><span class=l>&lt;bootstrap-kubeconfig&gt;</span><span class=w>
</span></code></pre></div><ol start=4><li>Define a name and namespace where the Gardenlet shall store the real kubeconfig it creates during the bootstrap process <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../charts/gardener/gardenlet/values.yaml#L31-L35>here</a>:</li></ol><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>gardenClientConnection</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>kubeconfigSecret</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-kubeconfig</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span></code></pre></div><ol start=5><li>Define either <code>seedSelector</code> or <code>seedConfig</code> (see <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../concepts/gardenlet.md#seed-config-vs-seed-selector>this document</a></li></ol><p>Now you are ready to deploy the Helm chart:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>helm install charts/gardener/gardenlet <span class=se>\
</span><span class=se></span>  --namespace garden <span class=se>\
</span><span class=se></span>  --name gardenlet <span class=se>\
</span><span class=se></span>  -f gardenlet-values.yaml <span class=se>\
</span><span class=se></span>  --wait
</code></pre></div><p>:warning: A current prerequisite of Kubernetes clusters that are used as seeds is to have a pre-deployed <code>nginx-ingress-controller</code> to make the Gardener work properly.
Moreover, there should exist a DNS record <code>*.ingress.&lt;SEED-CLUSTER-DOMAIN></code> where <code>&lt;SEED-CLUSTER-DOMAIN></code> is the value of the <code>.dns.ingressDomain</code> field of <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../example/50-seed.yaml>a Seed cluster resource</a> (or the <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../example/20-componentconfig-gardenlet.yaml#L84-L85>respective Gardenlet configuration</a>).</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ad025ee5c7e0c8dfb30028f708b6c9cf>5.1.6 - Deploy into AKS</h1><h1 id=deploying-the-previous-gardener-versions-and-a-seed-into-an-aks-cluster>Deploying the previous Gardener versions and a Seed into an AKS cluster</h1><p>This document demonstrates how to install Gardener into an existing
AKS cluster. We&rsquo;ll use a single cluster to host both Gardener and a Seed to the
same cluster for the sake of simplicity .</p><p>Please note that this document is to provide you an example
installation and is not to be used in a production environment since
there are some certificates hardcoded, non-HA and non-TLS-enabled etcd
setup.</p><h1 id=high-level-overview>High Level Overview</h1><p>In this example we&rsquo;ll follow these steps to create a Seed cluster on AKS:</p><ul><li><a href=#deploying-the-gardener-and-a-seed-into-an-aks-cluster>Deploying the Gardener and a Seed into an AKS cluster</a></li><li><a href=#high-level-overview>High Level Overview</a></li><li><a href=#prerequisites>Prerequisites</a><ul><li><a href=#aws-credentials-for-route-53-hosted-zone>AWS credentials for Route 53 Hosted Zone</a></li><li><a href=#deploy-aks-cluster>Deploy AKS cluster</a><ul><li><a href=#initialize-helm-on-the-cluster>Initialize Helm on the Cluster</a></li><li><a href=#deploy-stablenginx-ingress-chart-to-aks>Deploy stable/nginx-ingress chart to AKS</a></li><li><a href=#create-wildcard-dns-record-for-the-ingress>Create wildcard DNS record for the ingress</a></li></ul></li><li><a href=#create-azure-service-principle-to-get-azure-credentials>Create Azure Service Principle to get Azure credentials</a></li><li><a href=#install-gardenctl>Install gardenctl</a></li></ul></li><li><a href=#install-gardener>Install Gardener</a><ul><li><a href=#create-garden-namespace>Create garden namespace</a></li><li><a href=#deploy-etcd>Deploy etcd</a></li><li><a href=#deploy-gardener-helm-chart>Deploy Gardener Helm Chart</a></li></ul></li><li><a href=#create-a-cloudprofile>Create a CloudProfile</a></li><li><a href=#define-seed-cluster-in-gardener>Define Seed cluster in Gardener</a><ul><li><a href=#create-the-seed-resource-definition-with-its-secret>Create the Seed resource definition with its Secret</a></li></ul></li><li><a href=#create-a-shoot-cluster>Create a Shoot cluster</a><ul><li><a href=#create-a-project-namespace-for-shoots>Create a Project (namespace) for Shoots</a></li><li><a href=#create-a-secretbinding-and-related-secret>Create a SecretBinding and related Secret</a></li><li><a href=#create-the-shoot-resource>Create the Shoot resource</a><ul><li><a href=#cluster-resources-after-shoot-is-created>Cluster Resources After Shoot is Created</a></li><li><a href=#troubleshooting-shoot-creation-issues>Troubleshooting Shoot Creation Issues</a></li></ul></li></ul></li><li><a href=#access-shoot-cluster>Access Shoot cluster</a></li><li><a href=#delete-shoot-cluster>Delete Shoot cluster</a></li></ul><h1 id=prerequisites>Prerequisites</h1><p>Summary of prerequisites:</p><ul><li>An Azure AKS cluster with:<ul><li>Helm initialized,</li><li>an ingress controller deployed,</li><li>a wildcard DNS record pointing the ingress,</li><li><code>az</code> command line client configured for Azure subscription,</li></ul></li><li>An Azure service principle to provide Azure credentials to Gardener,</li><li>A Route53 Hosted Zone and AWS account credentials with permissions on that Route53 Zone,<ul><li><code>aws</code> command line client configured for this account,</li></ul></li><li><code>gardenctl</code> command line client configured for the AKS cluster&rsquo;s kubeconfig</li></ul><p><strong>Note</strong>: Gardener doesn&rsquo;t have support for Azure DNS yet (see
<a href=https://github.com/gardener/gardener/issues/494>#494</a>). So, we use a Route53 Hosted Zone
even if we are deploying on Azure.</p><h2 id=aws-credentials-for-route-53-hosted-zone>AWS credentials for Route 53 Hosted Zone</h2><p>You need to provide credentials for AWS with permission to access Route53
Hosted Zone. In this example we&rsquo;ll assume your domain for the Hosted
Zone is <code>.your.domain.here</code>.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>HOSTED_ZONE_ID=        # place your AWS Route53 hostedZoneID here
</code></pre></div><p>Create an AWS user, define policy to allow permission for the Hosted
Zone and note the <code>hostedZoneID</code>, <code>accessKeyID</code> and <code>secretAccessKey</code>
for later use.</p><h2 id=deploy-aks-cluster>Deploy AKS cluster</h2><p>Here you can find a summary for creating an AKS cluster, if you already
have one, skip this step.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>az group create --name garden-1 --location eastus
az aks create --resource-group garden-1 --name garden-1 \
  --kubernetes-version 1.11.5 \
  --node-count 2 --node-vm-size Standard_DS4_v2 \
  --generate-ssh-keys
az aks get-credentials --resource-group garden-1 --name garden-1 --admin
</code></pre></div><h3 id=initialize-helm-on-the-cluster>Initialize Helm on the Cluster</h3><p>Since RBAC is enabled by default we need to deploy helm with an RBAC config.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl apply -f https://raw.githubusercontent.com/Azure/helm-charts/master/docs/prerequisities/helm-rbac-config.yaml
helm init --service-account tiller
</code></pre></div><h3 id=deploy-stablenginx-ingress-chart-to-aks>Deploy stable/nginx-ingress chart to AKS</h3><p>At the moment the <code>Ingress</code> resources created by the Gardener are
expecting the nginx-ingress style annotations to work.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>helm upgrade --install \
  --namespace kube-system \
  nginx-ingress stable/nginx-ingress
</code></pre></div><h3 id=create-wildcard-dns-record-for-the-ingress>Create wildcard DNS record for the ingress</h3><p>You need to pick a wildcard subdomain matching your Route53 Hosted
Zone here. This ingress wildcard record is supposed to be part of the Seed
cluster rather than Gardener cluster, in our example we&rsquo;ll use
<code>*.seed-1.your.domain.here</code>.</p><p>Assuming you have the AWS cli for your Route53 Hosted Zone is
configured on your local, here we&rsquo;ll create the wildcard DNS record
using the <a href=https://github.com/wallix/awless#readme><code>awless</code></a>. You can also use the AWS
console or any other tool of your choice to create the wildcard
record:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>HOSTED_ZONE_DOMAIN=$(aws route53 get-hosted-zone --id /hostedzone/${HOSTED_ZONE_ID:?&#34;HOSTED_ZONE_ID is missing&#34;} --query &#39;HostedZone.Name&#39; --output text)
INGRESS_DOMAIN=&#34;seed-1.${HOSTED_ZONE_DOMAIN%%.}&#34;
# Get LB IP address from `kubectl -n kube-system get svc shared-ingress-nginx-ingress-controller`
LB_IP=$(kubectl -n kube-system get svc nginx-ingress-controller --template &#39;{{(index .status.loadBalancer.ingress 0).ip}}&#39;)
awless create record \
  zone=$HOSTED_ZONE_ID \
  name=&#34;*.$INGRESS_DOMAIN&#34; \
  value=$LB_IP \
  type=A \
  ttl=300
</code></pre></div><h2 id=create-azure-service-principle-to-get-azure-credentials>Create Azure Service Principle to get Azure credentials</h2><p>We need <code>client_id</code> and <code>client_secret</code> to allow Gardener to reach
Azure services, we can generate a pair by creating a Service Principle
on Azure:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ az ad sp create-for-rbac --role=&#34;Contributor&#34;
Retrying role assignment creation: 1/36
{
  &#34;appId&#34;: &#34;xxxxxx-xxx-xxxx-xxx-xxxxx&#34;,     #az_client_id
  &#34;displayName&#34;: &#34;azure-cli-2018-05-23-16-15-49&#34;,
  &#34;name&#34;: &#34;http://azure-cli-2018-05-23-16-15-49&#34;,
  &#34;password&#34;: &#34;xxxxxx-xxx-xxxx-xxx-xxxxx&#34;,  #az_client_secret
  &#34;tenant&#34;: &#34;xxxxxx-xxx-xxxx-xxx-xxxxx&#34;     #az_tenant_id
}
</code></pre></div><p>Let&rsquo;s define some env variables for later use</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>CLIENT_ID=       # place your Azure Service Principal appId
CLIENT_SECRET=   # place your Azure Service Principal password here
</code></pre></div><h2 id=install-gardenctl>Install gardenctl</h2><p>In this example we&rsquo;ll be using <code>gardenctl</code> to interact with
Gardener. You can install <code>gardenctl</code> following instruction in its
repo: <a href=https://github.com/gardener/gardenctl>https://github.com/gardener/gardenctl</a></p><p>Here is a sample configuration for gardenctl:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ cat ~/.garden/config
gardenClusters:
- name: dev
  kubeConfig: ~/.kube/config
</code></pre></div><h1 id=install-gardener>Install Gardener</h1><h2 id=create-garden-namespace>Create garden namespace</h2><p>This is where we deploy Gardener components.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl apply -f example/00-namespace-garden.yaml
</code></pre></div><h2 id=deploy-etcd>Deploy etcd</h2><p>Since Gardener is an extension API Server, it can share the etcd
backing native Kubernetes cluster&rsquo;s API Server, and hence explicit etcd
installation is optional. But in our case we have no access to the
control plane components of the AKS cluster and we have to deploy our
own etcd ourselves for Gardener. Lets deploy an etcd using the
<a href=https://github.com/gardener/etcd-backup-restore>gardener/etcd-backup-restore</a>
project, which is also used by the Gardener for Shoot control plane.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback># pull the etcd-backup-restore
git clone https://github.com/gardener/etcd-backup-restore.git

# deploy etcd
helm upgrade --install \
  --namespace garden \
  etcd etcd-backup-restore/chart \
  --set tls=
</code></pre></div><p><strong>Note</strong>: This etcd installation doesn&rsquo;t provide HA. But etcd will be
auto recovered by the Deployment. This could be sufficient for some
deployments but may not be suitable for production usage. Also note
that this etcd is not deployed with TLS enabled and doesn&rsquo;t use
certificates for authentication.</p><p>Check etcd pod&rsquo;s health, it should have <code>READY:2/2</code> and <code>STATUS:Running</code>:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl -n garden get pods
NAME              READY   STATUS    RESTARTS   AGE
etcd-for-test-0   2/2     Running   0          1m
</code></pre></div><h2 id=deploy-gardener-helm-chart>Deploy Gardener Helm Chart</h2><p>Check (current releases)[https://github.com/gardener/gardener/releases] and
pick a suitable one to install.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>GARDENER_RELEASE=0.17.1
</code></pre></div><p>gardener-controller-manager will need to maintain some DNS records for Seed.
So, you need to provide Route53 credentials in the values.yaml file:</p><ul><li><strong>global.controller.internalDomain.hostedZoneID</strong></li><li><strong>global.controller.internalDomain.domain</strong>: Here pick a subdomain for your
Gardener to maintain DNS records for your Shoot clusters. This domain has
to be within your Route53 Hosted Zone. e.g. <code>garden-1.your.domain.here</code></li><li><strong>global.controller.internalDomain.credentials</strong></li><li><strong>global.controller.internalDomain.secretAccessKey</strong></li></ul><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>HOSTED_ZONE_DOMAIN=$(
  aws route53 get-hosted-zone \
    --id /hostedzone/${HOSTED_ZONE_ID:?&#34;HOSTED_ZONE_ID is missing&#34;} \
    --query &#39;HostedZone.Name&#39; \
    --output text)
HOSTED_ZONE_DOMAIN=${HOSTED_ZONE_DOMAIN%%.}
GARDENER_DOMAIN=&#34;garden-1.${HOSTED_ZONE_DOMAIN}&#34;
ACCESS_KEY_ID=$(aws configure get aws_access_key_id)
SECRET_ACCESS_KEY=$(aws configure get aws_secret_access_key)
cat &lt;&lt;EOF &gt; gardener-values.yaml
global:
  apiserver:
    image:
      tag: ${GARDENER_RELEASE:?&#34;GARDENER_RELEASE is missing&#34;}
    etcd:
      servers: http://etcd-for-test-client:2379
      useSidecar: false
  controller:
    image:
      tag: ${GARDENER_RELEASE:?&#34;GARDENER_RELEASE is missing&#34;}
    internalDomain:
      provider: aws-route53
      hostedZoneID: ${HOSTED_ZONE_ID}
      domain: ${HOSTED_ZONE_DOMAIN}
      credentials:
        AWS_ACCESS_KEY_ID: ${ACCESS_KEY_ID}
        AWS_SECRET_ACCESS_KEY: ${SECRET_ACCESS_KEY}
EOF
</code></pre></div><p>After creating the <code>gardener-values.yaml</code> file, since chart definition in
master branch can have breaking changes after the release, checkout the
gardener tag for that release, and run:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>git checkout ${GARDENER_RELEASE:?&#34;GARDENER_RELEASE is missing&#34;}
helm upgrade --install \
  --namespace garden \
  garden charts/gardener \
  -f charts/gardener/local-values.yaml \
  -f gardener-values.yaml
</code></pre></div><p>Validate the Gardener is deployed:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>helm status garden  # Wait for `STATUS: DEPLOYED`

kubectl -n garden get deploy,pod -l app=gardener

# Better if you leave two terminals open in for below commands, and
# keep an eye on whats going on behind the scenes as you create/delete
# Gardener specific resources (Seed, CloudProfile, SecretBinding, Shoot).
kubectl -n garden logs -f deployment/gardener-apiserver           # confirm no issues
kubectl -n garden logs -f deployment/gardener-controller-manager  # confirm no issues, except some &#34;Failed to list *v1beta1...&#34; messages
</code></pre></div><p><strong>Note</strong>: This is not meant to be used in production. You may not want
to use <code>apiserver.insecureSkipTLSVerify=true</code>, the hardcoded apiserver
certificates, and insecure (non-tls enabled) etcd. But for the sake of
keeping this example simple you can just keep those values as they
are.</p><h1 id=create-a-cloudprofile>Create a CloudProfile</h1><p>We need to create a CloudProfile to be referred from the Shoot
(<a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../example/30-cloudprofile-azure.yaml><code>example/30-cloudprofile-azure.yaml</code></a>):</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl apply -f example/30-cloudprofile-azure.yaml
</code></pre></div><p>Validate that CloudProfile is created:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl describe -f example/30-cloudprofile-azure.yaml
</code></pre></div><h1 id=define-seed-cluster-in-gardener>Define Seed cluster in Gardener</h1><p>In our setup we&rsquo;ll use the cluster for Gardener also as a Seed, this
saves us from creating a new Kubernetes cluster. But you can also
create an explicit cluster for the Seed. Seed cluster can also be
placed into any other cloud provider or on prem. But keep in mind that
below steps may differ if you use a different cluster for seed.</p><p>Currently, a Seed cluster is just a Kubeconfig for the Gardener. The
seed cluster could have been created by any tool, Gardener only cares
about having a valid Kubeconfig to talk to its API.</p><h2 id=create-the-seed-resource-definition-with-its-secret>Create the Seed resource definition with its Secret</h2><p>Lets start with the required seed secret first. Here we need to
provide it&rsquo;s cloud provider credentials and kubeconfig in the seed
secret. Update
<a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../example/40-secret-seed-azure.yaml><code>example/40-secret-seed-azure.yaml</code></a>
and place the secrets for your environment:</p><ul><li><strong>data.subscriptionID</strong>: you can learn this one with <code>az account show</code></li><li><strong>data.tenantID</strong>: from <code>az ad sp create-for-rbac</code> output as you can see above</li><li><strong>data.clientID</strong>: from <code>az ad sp create-for-rbac</code> output as you can see above</li><li><strong>data.clientSecret</strong>: from <code>az ad sp create-for-rbac</code> output as you can see above</li><li><strong>data.kubeconfig</strong>: you can get this one with <code>az aks get-credentials --resource-group garden-1 --name garden-1 -f - | base64</code>)</li></ul><p><strong>Note</strong>: All of the above values must be base64 encoded. If you skip this it will hurt you later.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>SUBSCRIPTION_ID=$(az account list -o json | jq -r &#39;.[] | select(.isDefault == true) | .id&#39;)
TENANT_ID=$(az account show -o tsv --query &#39;tenantId&#39;)
KUBECONFIG_FOR_SEED_CLUSTER=$(az aks get-credentials --resource-group garden-1 --name garden-1 -f -)
sed -i \
  -e &#34;s@base64(uuid-of-subscription)@$(echo $SUBSCRIPTION_ID | tr -d &#39;\n&#39; | base64)@&#34; \
  -e &#34;s@base64(uuid-of-tenant)@$(echo &#34;$TENANT_ID&#34; | tr -d &#39;\n&#39; | base64)@&#34; \
  -e &#34;s@base64(uuid-of-client)@$(echo &#34;${CLIENT_ID:?&#34;CLIENT_ID is missing&#34;}&#34; | tr -d &#39;\n&#39; | base64)@&#34; \
  -e &#34;s@base64(client-secret)@$(echo &#34;${CLIENT_SECRET:?&#34;CLIENT_SECRET is missing&#34;}&#34; | tr -d &#39;\n&#39; | base64)@&#34; \
  -e &#34;s@base64(kubeconfig-for-seed-cluster)@$(echo &#34;$KUBECONFIG_FOR_SEED_CLUSTER&#34; | base64 -w 0)@&#34; \
  example/40-secret-seed-azure.yaml
</code></pre></div><p>After updating the fields, create the Seed secret:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl apply -f example/40-secret-seed-azure.yaml
</code></pre></div><p>Before creating Seed, we need to update the
<a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../example/50-seed-azure.yaml><code>example/50-seed-azure.yaml</code></a> file and
update:</p><ul><li><strong>spec.networks</strong>: IP ranges used in your AKS cluster.</li><li><strong>spec.ingressDomain</strong>: Place here the wildcard domain you have for
the ingress controller (we created this record in prerequisites).
Gardener doesn&rsquo;t create this DNS records but assumes its created
ahead of time, Seed clusters are not provisioned by Gardener.</li><li><strong>spec.cloud.region</strong>: <code>eastus</code> (the region of the existing AKS cluster)</li></ul><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>HOSTED_ZONE_DOMAIN=$(aws route53 get-hosted-zone --id /hostedzone/${HOSTED_ZONE_ID:?&#34;HOSTED_ZONE_ID is missing&#34;} --query &#39;HostedZone.Name&#39; --output text)
INGRESS_DOMAIN=&#34;seed-1.${HOSTED_ZONE_DOMAIN%%.}&#34;
# discover AKS CIDRs
NODE_CIDR=$(az network vnet list -g MC_garden-1_garden-1_eastus -o json | jq -r &#39;.[] | .subnets[] | .addressPrefix&#39;)
POD_CIDR=$(kubectl -n kube-system get daemonset/kube-proxy -o yaml | grep cluster-cidr= | grep -v annotations | cut -d = -f2)
SERVICE_CIDR=10.0.0.0/16  # This one is hardcoded for now, not easy to discover
sed -i \
  -e &#34;s/ingressDomain: dev.azure.seed.example.com/ingressDomain: $INGRESS_DOMAIN/&#34; \
  -e &#34;s/region: westeurope/region: eastus/&#34; \
  -e &#34;s@nodes: 10.240.0.0/16@nodes: $NODE_CIDR@&#34; \
  -e &#34;s@pods: 10.241.128.0/17@pods: $POD_CIDR@&#34; \
  -e &#34;s@services: 10.241.0.0/17@services: $SERVICE_CIDR@&#34; \
  example/50-seed-azure.yaml
</code></pre></div><p>Now we are ready to create the seed:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl apply -f example/50-seed-azure.yaml
</code></pre></div><p>Check the logs in gardener-controller-manager and also wait for seed
to be <code>Ready: True</code>. This means gardener-controller-manager is able to
reach the Seed cluster with the credentials you provide.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ gardenctl target garden dev
KUBECONFIG=/Users/user/.kube/config
$ kubectl get seed azure
NAME    CLOUDPROFILE   REGION   INGRESS DOMAIN            AVAILABLE   AGE
azure   azure          eastus   seed-1.your.domain.here   True        1m
$ gardenctl ls seeds
seeds:
- seed: azure
</code></pre></div><p>If something goes wrong verify that you provided right credentials,
and base64 encoded strings of those in the secret. Also check the
status field in the Seed resource and gardener-controller-manager
logs:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl get seed azure -o json | jq .status
{
  &#34;conditions&#34;: [
    {
      &#34;lastTransitionTime&#34;: &#34;2018-05-31T14:56:49Z&#34;,
      &#34;message&#34;: &#34;all checks passed&#34;,
      &#34;reason&#34;: &#34;Passed&#34;,
      &#34;status&#34;: &#34;True&#34;,
      &#34;type&#34;: &#34;Available&#34;
    }
  ]
}
</code></pre></div><h1 id=create-a-shoot-cluster>Create a Shoot cluster</h1><h2 id=create-a-project-namespace-for-shoots>Create a Project (namespace) for Shoots</h2><p>In this step we create a namespace in Gardener cluster to keep Shoot
resource definitions. A <code>project</code> in Gardener terminology is simply a
namespace that holds group of Shoots, during this example we&rsquo;ll deploy
a single Shoot. (Mind the extra labels defined in
<a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../example/00-namespace-garden-dev.yaml>example/00-namespace-garden-dev.yaml</a>).</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl apply -f example/05-project-dev.yaml
</code></pre></div><p>You can check the projects via <code>gardenctl</code>:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ gardenctl target garden dev
$ kubectl get project dev
NAME   NAMESPACE    STATUS   OWNER                  CREATOR   AGE
dev    garden-dev   Ready    john.doe@example.com   client    1m
$ kubectl get ns garden-dev
NAME          STATUS   AGE
garden-dev    Active   1m
$ gardenctl ls projects
projects:
- project: garden-dev
</code></pre></div><h2 id=create-a-secretbinding-and-related-secret>Create a SecretBinding and related Secret</h2><p>We&rsquo;ll use same Azure credentials with
<a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../example/40-secret-seed-azure.yaml><code>example/40-secret-seed-azure.yaml</code></a>,
this is due to the fact that we use the same Azure Subscription for
the Shoot and Seed clusters. Differently from the Seed secret, in this
one we don&rsquo;t need to provide <code>kubeconfig</code> since the Shoot cluster will
be provisioned by Gardener, and we need to provide credentials for
Route53 DNS records management.</p><p>Update
<a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../example/70-secret-cloudprovider-azure.yaml><code>example/70-secret-cloudprovider-azure.yaml</code></a>
and place the secrets for your environment:</p><ul><li><strong>data.subscriptionID</strong>: you can learn this one with <code>az account show</code></li><li><strong>data.tenantID</strong>: from <code>az ad sp create-for-rbac</code> output as you can see above</li><li><strong>data.clientID</strong>: from <code>az ad sp create-for-rbac</code> output as you can see above</li><li><strong>data.clientSecret</strong>: from <code>az ad sp create-for-rbac</code> output as you can see above</li><li><strong>data.accessKeyID</strong>: You need to add this field for Route53 records to be updated.</li><li><strong>data.secretAccessKey</strong>: You need to add this field for Route53 records to be updated.</li></ul><p><strong>Note</strong>: All of the above values must be base64 encoded. If you skip this it will hurt you later.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>SUBSCRIPTION_ID=$(az account list -o json | jq -r &#39;.[] | select(.isDefault == true) | .id&#39;)
TENANT_ID=$(az account show -o tsv --query &#39;tenantId&#39;)
ACCESS_KEY_ID=$(aws configure get aws_access_key_id)
SECRET_ACCESS_KEY=$(aws configure get aws_secret_access_key)
sed -i \
  -e &#34;s@base64(uuid-of-subscription)@$(echo $SUBSCRIPTION_ID | tr -d &#39;\n&#39; | base64)@&#34; \
  -e &#34;s@base64(uuid-of-tenant)@$(echo &#34;$TENANT_ID&#34; | tr -d &#39;\n&#39; | base64)@&#34; \
  -e &#34;s@base64(uuid-of-client)@$(echo &#34;${CLIENT_ID:?&#34;CLIENT_ID is missing&#34;}&#34; | tr -d &#39;\n&#39; | base64)@&#34; \
  -e &#34;s@base64(client-secret)@$(echo &#34;${CLIENT_SECRET:?&#34;CLIENT_SECRET is missing&#34;}&#34; | tr -d &#39;\n&#39; | base64)@&#34; \
  -e &#34;\$a\ \ accessKeyID: $(echo $ACCESS_KEY_ID | tr -d &#39;\n&#39; | base64 )&#34; \
  -e &#34;\$a\ \ secretAccessKey: $(echo $SECRET_ACCESS_KEY | tr -d &#39;\n&#39; | base64 )&#34; \
  example/70-secret-cloudprovider-azure.yaml
</code></pre></div><p>After updating the fields, create the cloud provider secret:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl apply -f example/70-secret-cloudprovider-azure.yaml
</code></pre></div><p>And create the SecretBinding resource to allow Gardener use that
secret
(<a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../example/80-secretbinding-cloudprovider-azure.yaml><code>example/80-secretbinding-cloudprovider-azure.yaml</code></a>):</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>sed -i \
  -e &#39;s/# namespace: .*/  namespace: garden-dev/&#39; \
  example/80-secretbinding-cloudprovider-azure.yaml
kubectl apply -f example/80-secretbinding-cloudprovider-azure.yaml
</code></pre></div><p>Check the logs in gardener-controller-manager, there should not be any
problems reported.</p><h2 id=create-the-shoot-resource>Create the Shoot resource</h2><p>Update the fields in <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../example/90-deprecated-shoot-azure.yaml><code>example/90-deprecated-shoot-azure.yaml</code></a>:</p><ul><li><strong>spec.cloud.region</strong>: <code>eastus</code> (this must match the seed cluster&rsquo;s region)</li><li><strong>spec.dns.domain</strong>: This is used to specify the base domain for
your api (and other in the future) endpoint(s). For example when
<code>johndoe-azure.garden-dev.your.domain.here</code> is used as a value, then your
apiserver is available at <code>api.johndoe-azure.garden-dev.your.domain.here</code></li><li><strong>spec.dns.hostedZoneID</strong>: This field doesn&rsquo;t exist in the example
you need to add this field and place the Route53 Hosted Zone ID.</li></ul><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>HOSTED_ZONE_DOMAIN=$(aws route53 get-hosted-zone --id /hostedzone/${HOSTED_ZONE_ID:?&#34;HOSTED_ZONE_ID is missing&#34;} --query &#39;HostedZone.Name&#39; --output text)
SHOOT_DOMAIN=&#34;johndoe-azure.garden-dev.${HOSTED_ZONE_DOMAIN%%.}&#34;
KUBE_LEGO_EMAIL=$(git config user.email)
sed -i \
  -e &#34;s/region: westeurope/region: eastus/&#34; \
  -e &#34;s/domain: johndoe-azure.garden-dev.example.com/domain: $SHOOT_DOMAIN/&#34; \
  -e &#34;/domain:/a\ \ \ \ hostedZoneID: $HOSTED_ZONE_ID&#34; \
  -e &#34;s/email: john.doe@example.com/email: $KUBE_LEGO_EMAIL/&#34; \
  example/90-deprecated-shoot-azure.yaml
</code></pre></div><p>And let&rsquo;s create the Shoot resource:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl apply -f example/90-deprecated-shoot-azure.yaml
</code></pre></div><p>After creating the Shoot resource, gardener-controller-manager will
pick it up and start provisioning the Shoot cluster.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl get -f example/90-deprecated-shoot-azure.yaml
NAME            CLOUDPROFILE   VERSION   SEED    DOMAIN                                      OPERATION    PROGRESS   APISERVER   CONTROL     NODES       SYSTEM      AGE
johndoe-azure   azure          1.12.3    azure   johndoe-azure.garden-dev.your.domain.here   Processing   15         &lt;unknown&gt;   &lt;unknown&gt;   &lt;unknown&gt;   &lt;unknown&gt;   16s
</code></pre></div><p>Follow the logs in your console with gardener-controller-manager,
starting like below you&rsquo;ll see plenty of <code>Waiting</code> and <code>Executing</code>,
etc. logs and many tasks will keep repeating:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>time=&#34;2018-06-09T07:35:45Z&#34; level=info msg=&#34;[SHOOT RECONCILE] garden-dev/johndoe-azure&#34;
time=&#34;2018-06-09T07:35:46Z&#34; level=info msg=&#34;Starting flow Shoot cluster creation&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:35:46Z&#34; level=info msg=&#34;Executing (*Botanist).botanist.Shoot.Components.DNS.External{Provider/Entry}.Deploy&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:35:46Z&#34; level=info msg=&#34;Executing (*Botanist).DeployNamespace&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:35:46Z&#34; level=info msg=&#34;Executing (*Botanist).DeployKubeAPIServerService&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:35:46Z&#34; level=info msg=&#34;Executing (*Botanist).DeployBackupNamespaceFromShoot&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:35:46Z&#34; level=info msg=&#34;Waiting for Terraform validation Pod &#39;johndoe-azure.external-dns.tf-pod-d8f66&#39; to be completed...&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:35:51Z&#34; level=info msg=&#34;Waiting for Terraform validation Pod &#39;johndoe-azure.external-dns.tf-pod-d8f66&#39; to be completed...&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:35:51Z&#34; level=info msg=&#34;Executing (*Botanist).MoveBackupTerraformResources&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:35:52Z&#34; level=info msg=&#34;Executing (*Botanist).WaitUntilKubeAPIServerServiceIsReady&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:35:52Z&#34; level=info msg=&#34;Waiting until the kube-apiserver service is ready...&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:35:52Z&#34; level=info msg=&#34;Waiting until the backup-infrastructure has been reconciled in the Garden cluster...&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:35:56Z&#34; level=info msg=&#34;Waiting for Terraform validation Pod &#39;johndoe-azure.external-dns.tf-pod-d8f66&#39; to be completed...&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:35:57Z&#34; level=info msg=&#34;Waiting until the kube-apiserver service is ready...&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:35:57Z&#34; level=info msg=&#34;Waiting until the backup-infrastructure has been reconciled in the Garden cluster...&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:36:01Z&#34; level=info msg=&#34;Waiting for Terraform validation Pod &#39;johndoe-azure.external-dns.tf-pod-d8f66&#39; to be completed...&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:36:02Z&#34; level=info msg=&#34;Waiting until the kube-apiserver service is ready...&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
time=&#34;2018-06-09T07:36:02Z&#34; level=info msg=&#34;Waiting until the backup-infrastructure has been reconciled in the Garden cluster...&#34; opid=VIBBBGFx shoot=garden-dev/johndoe-azure
...
</code></pre></div><p>At this stage you should be waiting for a while until the Shoot
cluster is provisioned and initial resources are deployed.</p><p>During the provisioning you can also check output of these commands to
have a better understanding about what&rsquo;s going on in the seed cluster:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ gardenctl ls shoots
projects:
- project: garden-dev
  shoots:
  - johndoe-azure
$ gardenctl ls issues
issues:
- project: garden-dev
  seed: azure
  shoot: johndoe-azure
  health: Unknown
  status:
    lastOperation:
      description: Executing DeployKubeAddonManager, ReconcileMachines.
      lastUpdateTime: 2018-06-09 08:40:20 +0100 IST
      progress: 74
      state: Processing
      type: Create
$ kubectl -n garden-dev get shoot johndoe-azure
NAMESPACE    NAME            SEED      DOMAIN                                       VERSION   CONTROL   NODES     SYSTEM    LATEST
garden-dev   johndoe-azure   azure     johndoe-azure.garden-dev.your.domain.here   1.10.1    True      True      True      Succeeded
$ kubectl -n garden-dev describe shoot johndoe-azure
...
Events:
  Type     Reason          Age   From                         Message
  ----     ------          ----  ----                         -------
  Normal   Reconciling     1h    gardener-controller-manager  [BrXWiztO] Reconciling Shoot cluster state
  Normal   Reconciling     59m   gardener-controller-manager  [rBFsfwU5] Reconciling Shoot cluster state
  Normal   Reconciling     59m   gardener-controller-manager  [2HAbm45D] Reconciling Shoot cluster state
  Normal   Reconciling     48m   gardener-controller-manager  [S1QA0ksz] Reconciling Shoot cluster state
  Normal   Reconciling     47m   gardener-controller-manager  [lvcSKy1Q] Reconciling Shoot cluster state
  Normal   Reconciling     47m   gardener-controller-manager  [MddMyk8W] Reconciling Shoot cluster state
  Normal   Reconciling     47m   gardener-controller-manager  [XDAAWABd] Reconciling Shoot cluster state
  Normal   Reconciling     46m   gardener-controller-manager  [6HYH9Psz] Reconciling Shoot cluster state
  Normal   Reconciling     46m   gardener-controller-manager  [rhL38ym4] Reconciling Shoot cluster state
  Normal   Reconciling     35m   gardener-controller-manager  [BOt4Nvso] Reconciling Shoot cluster state
  Normal   Reconciling     35m   gardener-controller-manager  [JPtmXmxD] Reconciling Shoot cluster state
  Normal   Reconciling     34m   gardener-controller-manager  [ldHsVA6G] Reconciling Shoot cluster state
  Normal   Reconciled      31m   gardener-controller-manager  [ldHsVA6G] Reconciled Shoot cluster state
  Normal   Reconciling     26m   gardener-controller-manager  [yBh2IBOF] Reconciling Shoot cluster state
  Normal   Reconciled      24m   gardener-controller-manager  [yBh2IBOF] Reconciled Shoot cluster state
  Normal   Reconciling     16m   gardener-controller-manager  [bqmFtHUA] Reconciling Shoot cluster state
  Normal   Reconciled      14m   gardener-controller-manager  [bqmFtHUA] Reconciled Shoot cluster state
  Normal   Reconciling     6m    gardener-controller-manager  [7QgHE5CH] Reconciling Shoot cluster state
  Normal   Reconciled      3m    gardener-controller-manager  [7QgHE5CH] Reconciled Shoot cluster state
</code></pre></div><p>Check Shoot cluster:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ gardenctl target garden dev
KUBECONFIG=/Users/user/.kube/config
$ gardenctl target project garden-dev
$ gardenctl target shoot johndoe-azure
KUBECONFIG=/Users/user/.garden/cache/projects/garden-dev/johndoe-azure/kubeconfig.yaml
$ gardenctl kubectl cluster-info
Kubernetes master is running at https://api.johndoe-azure.garden-dev.your.domain.here
CoreDNS is running at https://api.johndoe-azure.garden-dev.your.domain.here/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
kubernetes-dashboard is running at https://api.johndoe-azure.garden-dev.your.domain.here/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy

To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;.
</code></pre></div><h3 id=cluster-resources-after-shoot-is-created>Cluster Resources After Shoot is Created</h3><p>After the Shoot has been created the summary of the resources in the
AKS cluster handled by Gardener will be something like this:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>non-namespaced resources
  CloudProfile: azure
  Project: dev
  Namespace: garden-dev
  Seed: azure  # cloud.profile:azure, cloud.region:eastus, secretRef.name:seed-azure, secretRef.namespace: garden

Namespace: garden
  Secret: seed-azure  # aks credentials, kubeconfig
  # No other resources with any kind handled by Gardener
  # Gardener components as well lives in this namespace

Namespace: garden-dev  # maps to &#34;project:dev&#34; in Gardener
  Secret: core-azure         # credentials for aks + aws (for route53)
  SecretBinding: core-azure  # secretRef.name:core-azure
  Shoot: johndoe-azure       # seed:azure, secretBindingRef.name:core-azure

Namespace: shoot--dev--johndoe-azure
  # These are automatically created once Shoot resource is created
  AzureMachineClass: shoot--dev--johndoe-azure-cpu-worker-8506a
  MachineDeployment: shoot--dev--johndoe-azure-cpu-worker
  MachineSet: shoot--dev--johndoe-azure-cpu-worker-849bbbf75
  Machine: shoot--dev--johndoe-azure-cpu-worker-849bbbf75-b42vh
  BackupInfra: shoot--dev--johndoe-azure--c1b3b  # seed:azure, shootUID: shoot.status.UID.
  # Many other resources created as part of shoot cluster,
  #   but only above ones are handled by Gardener

Namespace: backup--shoot--dev--johndoe-azure--c1b3b
  # Secrets and configMap having info related to backup infrastructure
  #   are created by Gardener.
</code></pre></div><h3 id=troubleshooting-shoot-creation-issues>Troubleshooting Shoot Creation Issues</h3><p>For any issue happening during Shoot provisioning, you can consult the
gardener-controller-manager logs, or the state in the shoot resource,
<code>gardenctl</code> also provides a command to check Shoot cluster states:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback># check gardener-controller-manager logs
kubectl -n garden logs -f deployment/gardener-controller-manager
# kubectl describe can provide you a human readable output of
# same information in below gardenctl command.
kubectl -n garden-dev describe shoot johndoe-azure
# also try cheking the machine-controller-manager logs of the shoot
kubectl logs -n shoot--dev--johndoe-azure deployment/machine-controller-manager
</code></pre></div><p>With <code>gardenctl</code>:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ gardenctl ls issues
issues:
- project: garden-dev
  seed: azure
  shoot:
  health: Ready
  status: johndoe-azure
    lastError: &#34;Failed to reconcile Shoot cluster state: Errors occurred during flow
      execution: &#39;(*Botanist).Shoot.Components.DNS.External{Provider/Entry}.Destroy&#39; returned &#39;Terraform execution
	  ...
    lastOperation:
      description: &#34;Failed to reconcile Shoot cluster state: Errors occurred during
        flow execution: &#39;(*Botanist).Shoot.Components.DNS.External{Provider/Entry}.Destroy&#39; returned &#39;Terraform
		...
      lastUpdateTime: 2018-06-03 09:48:00 +0100 IST
      progress: 100
      state: Failed
      type: Reconcile
</code></pre></div><h1 id=access-shoot-cluster>Access Shoot cluster</h1><p>The <code>gardenctl</code> tool provides a convenient wrapper to operate on both
cluster and cloud providers, here are some commands you can run</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback># select target shoot cluster
gardenctl ls gardens
gardenctl target garden dev
gardenctl ls projects
gardenctl target shoot johndoe-azure

# issue Azure client (az) commands on target shoot
gardenctl az aks list

# issue kubectl commands on target shoot
gardenctl kubectl -- version --short  # &#39;--&#39; is required if you want to
                                      # pass any args starting with &#39;-&#39;

# open prometheus, alertmanager, grafana without having to find
# the user/pass for each
gardenctl show prometheus
gardenctl show grafana
gardenctl show alertmanager
</code></pre></div><p>Easiest way to obtain <code>kubeconfig</code> of the shoot cluster:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ gardenctl target shoot johndoe-azure
KUBECONFIG=/Users/user/.garden/cache/projects/garden-dev/johndoe-azure/kubeconfig.yaml
$ export KUBECONFIG=/Users/user/.garden/cache/projects/garden-dev/johndoe-azure/kubeconfig.yaml
$                        # From now on your local kubectl will be operating on target shoot
$ kubectl cluster-info   # will show your shoot cluster info
$ unset KUBECONFIG       # reset to your default kubectl
</code></pre></div><p>The shoot cluster&rsquo;s kubeconfig is being kept in a secret in the
project namespace:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl -n shoot--dev--johndoe-azure get secret kubecfg -o jsonpath=&#39;{.data.kubeconfig}&#39; | base64 -D &gt; /tmp/johndoe-azure-kubeconfig.yaml
export KUBECONFIG=/tmp/johndoe-azure-kubeconfig.yaml
</code></pre></div><h1 id=delete-shoot-cluster>Delete Shoot cluster</h1><p>Deleting a Shoot cluster is not straight forward, and this is to
protect users from undesired/accidental cluster deletion. One has to
place some special annotations to get a Shoot cluster removed. We use
the <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../../hack/usage/delete>hack/usage/delete</a> script for this purpose.</p><p>Please refer to <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/deployment/../usage/shoots.md>Creating / Deleting a Shoot
cluster</a> document for more details.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>hack/delete shoot johndoe-azure garden-dev
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-43e3406b9b1753792534a5c41b26e7c4>5.1.7 - Environment</h1><h1 id=preparing-the-setup>Preparing the Setup</h1><p>Conceptually, all Gardener components are designated to run inside as a Pod inside a Kubernetes cluster.
The API server extends the Kubernetes API via the user-aggregated API server concepts.
However, if you want to develop it, you may want to work locally with the Gardener without building a Docker image and deploying it to a cluster each and every time.
That means that the Gardener runs outside a Kubernetes cluster which requires providing a <a href=https://kubernetes.io/docs/tasks/access-application-cluster/authenticate-across-clusters-kubeconfig/>Kubeconfig</a> in your local filesystem and point the Gardener to it when starting it (see below).</p><p>Further details could be found in</p><ol><li><a href=https://kubernetes.io/docs/concepts/>Principles of Kubernetes</a>, and its <a href=https://kubernetes.io/docs/concepts/overview/components/>components</a></li><li><a href=https://github.com/kubernetes/community/tree/master/contributors/devel>Kubernetes Development Guide</a></li><li><a href=https://github.com/gardener/documentation/wiki/Architecture.md>Architecture of Gardener</a></li></ol><p>This setup is based on <a href=https://github.com/kubernetes/minikube>minikube</a>, a Kubernetes cluster running on a single node. Docker for Desktop and <a href=https://github.com/kubernetes-sigs/kind>kind</a> are also supported.</p><h2 id=installing-golang-environment>Installing Golang environment</h2><p>Install latest version of Golang. For MacOS you could use <a href=https://brew.sh/>Homebrew</a>:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>brew install golang
</code></pre></div><p>For other OS, please check <a href=https://golang.org/doc/install>Go installation documentation</a>.</p><h2 id=installing-kubectl-and-helm>Installing kubectl and helm</h2><p>As already mentioned in the introduction, the communication with the Gardener happens via the Kubernetes (Garden) cluster it is targeting. To interact with that cluster, you need to install <code>kubectl</code>. Please make sure that the version of <code>kubectl</code> is at least <code>v1.11.x</code>.</p><p>On MacOS run</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>brew install kubernetes-cli
</code></pre></div><p>Please check the <a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/>kubectl installation documentation</a> for other OS.</p><p>You may also need to develop Helm charts or interact with Tiller using the <a href=https://github.com/kubernetes/helm>Helm</a> CLI:</p><p>On MacOS run</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>brew install kubernetes-helm
</code></pre></div><p>On other OS please check the <a href=https://github.com/kubernetes/helm/blob/master/docs/install.md>Helm installation documentation</a>.</p><h2 id=installing-git>Installing git</h2><p>We use <code>git</code> as VCS which you need to install.</p><p>On MacOS run</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>brew install git
</code></pre></div><p>On other OS, please check the <a href=https://git-scm.com/book/en/v2/Getting-Started-Installing-Git>Git installation documentation</a>.</p><h2 id=installing-openvpn>Installing openvpn</h2><p>We use <code>OpenVPN</code> to establish network connectivity from the control plane running in the Seed cluster to the Shoot&rsquo;s worker nodes running in private networks.
To harden the security we need to generate another secret to encrypt the network traffic (<a href=https://openvpn.net/index.php/open-source/documentation/howto.html#security>details</a>).
Please install the <code>openvpn</code> binary. On MacOS run</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>brew install openvpn
<span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=k>$(</span>brew --prefix openvpn<span class=k>)</span>/sbin:<span class=nv>$PATH</span>
</code></pre></div><p>On other OS, please check the <a href=https://openvpn.net/index.php/open-source/downloads.html>OpenVPN downloads page</a>.</p><h2 id=installing-minikube>Installing Minikube</h2><p>You&rsquo;ll need to have <a href=https://github.com/kubernetes/minikube#installation>minikube</a> installed and running.</p><blockquote><p>Note: Gardener is working only with self-contained kubeconfig files because of <a href=https://banzaicloud.com/blog/kubeconfig-security/>security issue</a>. You can configure your minikube to create self-contained kubeconfig files via:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>minikube config <span class=nb>set</span> embed-certs <span class=nb>true</span>
</code></pre></div></blockquote><p>Alternatively, you can also install Docker for Desktop and <a href=https://github.com/kubernetes-sigs/kind>kind</a>.</p><p>In case you want to use the &ldquo;Docker for Mac Kubernetes&rdquo; or if you want to build Docker images for the Gardener you have to install Docker itself. On MacOS, please use <a href=https://docs.docker.com/docker-for-mac/>Docker for MacOS</a> which can be downloaded <a href=https://download.docker.com/mac/stable/Docker.dmg>here</a>.</p><p>On other OS, please check the <a href=https://docs.docker.com/install/>Docker installation documentation</a>.</p><h2 id=installing-iproute2>Installing iproute2</h2><p><code>iproute2</code> provides a collection of utilities for network administration and configuration.</p><p>On MacOS run</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>brew install iproute2mac
</code></pre></div><h2 id=installing-yaml2json-and-jq>Installing yaml2json and jq</h2><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>go get -u github.com/bronze1man/yaml2json
brew install jq
</code></pre></div><h2 id=macos-only-install-gnu-core-utilities>[MacOS only] Install GNU core utilities</h2><p>When running on MacOS you have to install the GNU core utilities:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>brew install coreutils gnu-sed
</code></pre></div><p>This will create symbolic links for the GNU utilities with <code>g</code> prefix in <code>/usr/local/bin</code>, e.g., <code>gsed</code> or <code>gbase64</code>. To allow using them without the <code>g</code> prefix please put <code>/usr/local/opt/coreutils/libexec/gnubin</code> at the beginning of your <code>PATH</code> environment variable, e.g., <code>export PATH=/usr/local/opt/coreutils/libexec/gnubin:$PATH</code>.</p><h2 id=windows-wsl2>[Windows] WSL2</h2><p>Apart from Linux distributions and MacOS, the local gardener setup can also run on the Windows Subsystem for Linux 2.</p><p>While WSL1, plain docker for windows and various Linux distributions and local Kubernetes environments may be supported, this setup was verified with:</p><ul><li><a href=https://docs.microsoft.com/en-us/windows/wsl/wsl2-index>WSL2</a></li><li><a href=https://docs.docker.com/docker-for-windows/wsl/>Docker Desktop WSL2 Engine</a></li><li><a href=https://ubuntu.com/blog/ubuntu-on-wsl-2-is-generally-available>Ubuntu 18.04 LTS on WSL2</a></li><li>Nodeless local garden (see below)</li></ul><p>The Gardener repository and all the above-mentioned tools (git, golang, kubectl, &mldr;) should be installed in your WSL2 distro, according to the distribution-specific Linux installation instructions.</p><h2 id=optional-installing-gcloud-sdk>[Optional] Installing gcloud SDK</h2><p>In case you have to create a new release or a new hotfix of the Gardener you have to push the resulting Docker image into a Docker registry. Currently, we are using the Google Container Registry (this could change in the future). Please follow the official <a href=https://cloud.google.com/sdk/downloads>installation instructions from Google</a>.</p><h2 id=local-gardener-setup>Local Gardener setup</h2><p>This setup is only meant to be used for developing purposes, which means that only the control plane of the Gardener cluster is running on your machine.</p><h3 id=get-the-sources>Get the sources</h3><p>Clone the repository from GitHub.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>git clone git@github.com:gardener/gardener.git
<span class=nb>cd</span> gardener
</code></pre></div><h3 id=start-the-gardener>Start the Gardener</h3><p>:warning: Before you start developing, please ensure to comply with the following requirements:</p><ol><li>You have understood the <a href=https://kubernetes.io/docs/concepts/>principles of Kubernetes</a>, and its <a href=https://kubernetes.io/docs/concepts/overview/components/>components</a>, what their purpose is and how they interact with each other.</li><li>You have understood the <a href=https://github.com/gardener/documentation/wiki/Architecture.md>architecture of Gardener</a>, and what the various clusters are used for.</li></ol><h4 id=start-a-local-kubernetes-cluster>Start a local kubernetes cluster</h4><p>For the development of Gardener you need some kind of Kubernetes cluster, which can be used as a &ldquo;garden&rdquo; cluster.
I.e. you need a Kubernetes API server on which you can register a <code>APIService</code> Gardener&rsquo;s own Extension API Server.<br>For this you can use a standard tool from the community to setup a local cluster like minikube, kind or the Kubernetes Cluster feature in Docker for Desktop.</p><p>However, if you develop and run Gardener&rsquo;s components locally, you don&rsquo;t actually a fully fledged Kubernetes Cluster,
i.e. you don&rsquo;t actually need to run Pods on it. If you want to use a more lightweight approach for development purposes,
you can use the &ldquo;nodeless Garden cluster setup&rdquo; residing in <code>hack/local-garden</code>. This is the easiest way to get your
Gardener development setup up and running.</p><p><strong>Using the nodeless cluster setup</strong></p><p>Setting up a local nodeless Garden cluster is quite simple. The only prerequisite is a running docker daemon.
Just use the provided Makefile rules to start your local Garden:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>make local-garden-up
<span class=o>[</span>...<span class=o>]</span>
Starting gardener-dev kube-etcd cluster..!
Starting gardener-dev kube-apiserver..!
Starting gardener-dev kube-controller-manager..!
Starting gardener-dev gardener-etcd cluster..!
namespace/garden created
clusterrole.rbac.authorization.k8s.io/gardener.cloud:admin created
clusterrolebinding.rbac.authorization.k8s.io/front-proxy-client created
<span class=o>[</span>...<span class=o>]</span>
</code></pre></div><p>This will start all minimally required components of a Kubernetes cluster (<code>etcd</code>, <code>kube-apiserver</code>, <code>kube-controller-manager</code>)
and an <code>etcd</code> Instance for the <code>gardener-apiserver</code> as Docker containers.</p><p>To tear down the local Garden cluster and remove the Docker containers, simply run:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>make local-garden-down
</code></pre></div><p><strong>Using minikube</strong></p><p>Alternatively, spin up a cluster with minikube with this command:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>minikube start --embed-certs <span class=c1>#  `--embed-certs` can be omitted if minikube has already been set to create self-contained kubeconfig files.</span>
😄  minikube v1.8.2 on Darwin 10.15.3
🔥  Creating virtualbox VM <span class=o>(</span><span class=nv>CPUs</span><span class=o>=</span>2, <span class=nv>Memory</span><span class=o>=</span>2048MB, <span class=nv>Disk</span><span class=o>=</span>20000MB<span class=o>)</span> ...
<span class=o>[</span>...<span class=o>]</span>
🏄  Done! Thank you <span class=k>for</span> using minikube!
</code></pre></div><h4 id=prepare-the-gardener>Prepare the Gardener</h4><p>Now, that you have started your local cluster, we can go ahead and register the Gardener API Server.
Just point your <code>KUBECONFIG</code> environment variable to the local cluster you created in the previous step and run:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>make dev-setup
Found Minikube ...
namespace/garden created
namespace/garden-dev created
deployment.apps/etcd created
service/etcd created
service/gardener-apiserver created
service/gardener-controller-manager created
endpoints/gardener-apiserver created
endpoints/gardener-controller-manager created
apiservice.apiregistration.k8s.io/v1alpha1.core.gardener.cloud created
apiservice.apiregistration.k8s.io/v1beta1.core.gardener.cloud created
validatingwebhookconfiguration.admissionregistration.k8s.io/gardener-controller-manager created
</code></pre></div><p>Optionally, you can switch off the <code>Logging</code> feature gate of Gardenlet to save resources:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sed -i -e <span class=s1>&#39;s/Logging: true/Logging: false/g&#39;</span> dev/20-componentconfig-gardenlet.yaml
</code></pre></div><p>The Gardener exposes the API servers of Shoot clusters via Kubernetes services of type <code>LoadBalancer</code>.
In order to establish stable endpoints (robust against changes of the load balancer address), it creates DNS records pointing to these load balancer addresses. They are used internally and by all cluster components to communicate.
You need to have control over a domain (or subdomain) for which these records will be created.
Please provide an <em>internal domain secret</em> (see <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/development/../../example/10-secret-internal-domain.yaml>this</a> for an example) which contains credentials with the proper privileges. Further information can be found <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/development/../usage/configuration.md>here</a>.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f example/10-secret-internal-domain-unmanaged.yaml
secret/internal-domain-unmanaged created
</code></pre></div><h4 id=run-the-gardener>Run the Gardener</h4><p>Next, run the Gardener API Server, the Gardener Controller Manager (optionally), the Gardener Scheduler (optionally), and the Gardenlet in different terminal windows/panes using rules in the <code>Makefile</code>.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>make start-apiserver
Found Minikube ...
I0306 15:23:51.044421   <span class=m>74536</span> plugins.go:84<span class=o>]</span> Registered admission plugin <span class=s2>&#34;ResourceReferenceManager&#34;</span>
I0306 15:23:51.044523   <span class=m>74536</span> plugins.go:84<span class=o>]</span> Registered admission plugin <span class=s2>&#34;DeletionConfirmation&#34;</span>
<span class=o>[</span>...<span class=o>]</span>
I0306 15:23:51.626836   <span class=m>74536</span> secure_serving.go:116<span class=o>]</span> Serving securely on <span class=o>[</span>::<span class=o>]</span>:8443
<span class=o>[</span>...<span class=o>]</span>
</code></pre></div><p>(Optional) Now you are ready to launch the Gardener Controller Manager.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>make start-controller-manager
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-03-06T15:24:17+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Starting Gardener controller manager...&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-03-06T15:24:17+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Feature Gates: &#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-03-06T15:24:17+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Starting HTTP server on 0.0.0.0:2718&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-03-06T15:24:17+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Acquired leadership, starting controllers.&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-03-06T15:24:18+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Starting HTTPS server on 0.0.0.0:2719&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-03-06T15:24:18+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Found internal domain secret internal-domain-unmanaged for domain nip.io.&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-03-06T15:24:18+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Successfully bootstrapped the Garden cluster.&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-03-06T15:24:18+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Gardener controller manager (version 1.0.0-dev) initialized.&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-03-06T15:24:18+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;ControllerRegistration controller initialized.&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-03-06T15:24:18+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;SecretBinding controller initialized.&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-03-06T15:24:18+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Project controller initialized.&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-03-06T15:24:18+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Quota controller initialized.&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-03-06T15:24:18+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;CloudProfile controller initialized.&#34;</span>
<span class=o>[</span>...<span class=o>]</span>
</code></pre></div><p>(Optional) Now you are ready to launch the Gardener Scheduler.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>make start-scheduler
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-05-02T16:31:50+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Starting Gardener scheduler ...&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-05-02T16:31:50+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Starting HTTP server on 0.0.0.0:10251&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-05-02T16:31:50+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Acquired leadership, starting scheduler.&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-05-02T16:31:50+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Gardener scheduler initialized (with Strategy: SameRegion)&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-05-02T16:31:50+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Scheduler controller initialized.&#34;</span>
<span class=o>[</span>...<span class=o>]</span>
</code></pre></div><p>(Optional) Now you are ready to launch the Gardenlet.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>make start-gardenlet
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-11-06T15:24:17+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Starting Gardenlet...&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-11-06T15:24:17+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Feature Gates: HVPA=true, Logging=true&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-11-06T15:24:17+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Acquired leadership, starting controllers.&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-11-06T15:24:18+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Found internal domain secret internal-domain-unmanaged for domain nip.io.&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-11-06T15:24:18+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Gardenlet (version 1.0.0-dev) initialized.&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-11-06T15:24:18+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;ControllerInstallation controller initialized.&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-11-06T15:24:18+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Shoot controller initialized.&#34;</span>
<span class=nv>time</span><span class=o>=</span><span class=s2>&#34;2019-11-06T15:24:18+02:00&#34;</span> <span class=nv>level</span><span class=o>=</span>info <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Seed controller initialized.&#34;</span>
<span class=o>[</span>...<span class=o>]</span>
</code></pre></div><p>:warning: The Gardenlet will handle all your seeds for this development scenario, although, for productive usage it is recommended to run it once per seed, see <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/development/../concepts/gardenlet.md>this document</a> for more information.
See the <a href=#appendix>Appendix</a> on how to configure the Seed clusters for the local development scenario.</p><p>Please checkout the <a href=https://github.com/gardener/gem>Gardener Extensions Manager</a> to install extension controllers - make sure that you install all of them required for your local development.
Also, please refer to <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/development/../extensions/controllerregistration.md>this document</a> for further information about how extensions are registered in case you want to use other versions than the latest releases.</p><p>The Gardener should now be ready to operate on Shoot resources. You can use</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl get shoots
No resources found.
</code></pre></div><p>to operate against your local running Gardener API Server.</p><blockquote><p>Note: It may take several seconds until the <code>minikube</code> cluster recognizes that the Gardener API server has been started and is available. <code>No resources found</code> is the expected result of our initial development setup.</p></blockquote><h4 id=limitations-of-local-development-setup>Limitations of local development setup</h4><p>You can run Gardener (API server, controller manager, scheduler, gardenlet) against any local Kubernetes cluster, however, your seed and shoot clusters must be deployed to a &ldquo;real&rdquo; provider.
Currently, it is not possible to run Gardener entirely isolated from any cloud provider.
We are planning to support a setup that can run completely locally (see <a href=https://github.com/gardener/gardener-extension-provider-mock>this for details</a>), however, it does not yet exist.
This means that - after you have setup Gardener - you need to register an external seed cluster (e.g., one created in AWS).
Only after that step you can start creating shoot clusters with your locally running Gardener.</p><p>Some time ago, we had a local setup based on VirtualBox/Vagrant.
However, as we have progressed with the <a href=https://github.com/gardener/gardener/issues/308>Extensibility epic</a> we noticed that this implementation/setup does no longer fit into how we envision external providers to be.
Moreover, it hid too many things and came with a bunch of limitations, making the development scenario too &ldquo;artificial&rdquo;:</p><ul><li>No integration with machine-controller-manager.</li><li>The Shoot API Server is exposed via a NodePort. In a cloud setup a LoadBalancer would be used.</li><li>It was not possible to create Shoot clusters consisting of more than one worker node. Cluster auto-scaling therefore is not supported.</li><li>It was not possible to create two or more Shoot clusters in parallel.</li><li>The communication between the Seed and the Shoot Clusters uses VPN tunnel. In this setup tunnels are not needed since all components run on localhost.</li></ul><h2 id=additional-information>Additional information</h2><p>To make sure that a specific Seed cluster will be chosen, specify the <code>.spec.seedName</code> field (see <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/development/../../example/90-shoot.yaml#L265-L266>here</a> for an example Shoot manifest).</p><p>Please take a look at the <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/development/../../example>example manifests folder</a> to see which resource objects you need to install into your Garden cluster.</p><h1 id=appendix>Appendix</h1><h2 id=configure-seed-clusters-for-local-development>Configure Seed clusters for local development</h2><p>When using the Gardenlet in a local development scenario with <code>make start-gardenlet</code> then the Gardenlet component configuration is setup with a <a href=https://raw.githubusercontent.com/gardener/gardener/master/docs/development/../concepts/gardenlet.md#seed-config-vs-seed-selector>seed selector</a> that targets all available Seed clusters.
However, a <code>Seed</code> resource needs to be configured to allow being reconciled by a Gardenlet which such a configuration.</p><p>When deploying the Gardenlet to reconcile only one Seed cluster (using component configuration <code>.seedConfig</code>),
the Gardenlet either needs to be supplied with a kubeconfig for the particular Seed cluster, or acquires one via bootstrapping.
Having said that, if the Gardenlet is configured to manage multiple Seed clusters based on a label selector, it needs to fetch the kubeconfig of each Seed cluster at runtime from somewhere.
That is why the <code>Seed</code> resource needs to be configured with an additional secret reference that contains the kubeconfig of the Seed cluster.</p><p>Create a secret containing the base64 encoded kubeconfig of the Seed cluster (the scope of the permissions should be identical to the kubeconfig that the Gardenlet creates during bootstrapping - for now, <code>cluster-admin</code> privileges are recommended).</p><p>Create the secret in the Garden cluster:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sweet-seed</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>kubeconfig</span><span class=p>:</span><span class=w> </span><span class=l>&lt;base64-seed-kubeconfig&gt;.</span><span class=w>
</span></code></pre></div><p>Adjust the <code>Seed</code> resource to reference the secret in <code>spec.secretRef</code> like so:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Seed</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-sweet-seed</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sweet-seed</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-fea3359b8970eaa265cbbbf03ff478d1>5.1.8 - Process</h1><h1 id=creating-a-new-feature>Creating a new Feature</h1><p>If you want to contribute to the Gardener, please do that always on a dedicated branch on your own fork named after the purpose of the code changes, for example <code>feature/helm-integration</code>.
Please do not forget to rebase your branch <strong>regularly</strong>.</p><p>If you have finished your work, please create a pull request <strong>based on <code>master</code></strong>. It will be reviewed and merged if no further changes are requested from you.</p><p>:warning: Please ensure that your modifications pass the lint checks, formatting checks, static code checks, and unit tests by executing</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>make verify
</code></pre></div><p>Please do not file your pull request unless you receive a successful response from here!</p><h2 id=creating-a-new-release>Creating a new Release</h2><p>Please refer to the <a href=/docs/contribute/10_code/10-contribution_guide>Gardener contributor guide</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ac343e053acb7edc1709491284185e87>5.1.9 - Repositories</h1></div><div class=td-content style=page-break-before:always><h1 id=pg-c9f86aaf1f411cffebc6ff8babbb89cb>5.1.10 - Security Release Process</h1><h1 id=gardener-security-release-process>Gardener Security Release Process</h1><p>Gardener is a growing community of volunteers and users. The Gardener community has adopted this security disclosure and response policy to ensure we responsibly handle critical issues.</p><h2 id=gardener-security-team>Gardener Security Team</h2><p>Security vulnerabilities should be handled quickly and sometimes privately. The primary goal of this process is to reduce the total time users are vulnerable to publicly known exploits.
The Gardener Security Team is responsible for organizing the entire response including internal communication and external disclosure but will need help from relevant developers and release managers to successfully run this process. The initial Gardener Security Team will consist of the following volunteers:</p><ul><li>Olaf Beier, (<strong><a href=https://github.com/olafbeier>@olafbeier</a></strong>)</li><li>Vasu Chandrasekhara, (<strong><a href=https://github.com/vasu1124>@vasu1124</a></strong>)</li><li>Alban Crequy, (<strong><a href=https://github.com/alban>@alban</a></strong>)</li><li>Norbert Hamann, (<strong><a href=https://github.com/norberthamann>@norberthamann</a></strong>)</li><li>Claudia Hölters, (<strong><a href=https://github.com/hoeltcl>@hoeltcl</a></strong>)</li><li>Oliver Kling, (<strong><a href=https://github.com/oliverkling>@oliverkling</a></strong>)</li><li>Vedran Lerenc, (<strong><a href=https://github.com/vlerenc>@vlerenc</a></strong>)</li><li>Dirk Marwinski, (<strong><a href=https://github.com/marwinski>@marwinski</a></strong>)</li><li>Michael Schubert, (<strong><a href=https://github.com/schu>@schu</a></strong>)</li><li>Matthias Sohn, (<strong><a href=https://github.com/msohn>@msohn</a></strong>)</li><li>Frederik Thormaehlen, (<strong><a href=https://github.com/ThormaehlenFred>@ThormaehlenFred</a></strong>)</li><li>Christian Cwienk (<strong><a href=https://github.com/ccwienk>@ccwienk</a></strong>)</li></ul><h2 id=disclosures>Disclosures</h2><h3 id=private-disclosure-processes>Private Disclosure Processes</h3><p>The Gardener community asks that all suspected vulnerabilities be privately and responsibly disclosed. If you&rsquo;ve found a vulnerability or a potential vulnerability in Gardener please let us know by writing an e-mail to <a href=mailto:secure@sap.com>secure@sap.com</a>. We&rsquo;ll send a confirmation e-mail to acknowledge your report, and we&rsquo;ll send an additional e-mail when we&rsquo;ve identified the issue positively or negatively.</p><h3 id=public-disclosure-processes>Public Disclosure Processes</h3><p>If you know of a publicly disclosed vulnerability please IMMEDIATELY e-mail to <a href=mailto:secure@sap.com>secure@sap.com</a> to inform the Gardener Security Team about the vulnerability so they may start the patch, release, and communication process.</p><p>If possible the Gardener Security Team will ask the person making the public report if the issue can be handled via a <a href=#private-disclosure-process>private disclosure process</a> (for example if the full exploit details have not yet been published). If the reporter denies the request for private disclosure, the Gardener Security Team will move swiftly with the fix and release process. In extreme cases GitHub can be asked to delete the issue but this generally isn&rsquo;t necessary and is unlikely to make a public disclosure less damaging.</p><h2 id=patch-release-and-public-communication>Patch, Release, and Public Communication</h2><p>For each vulnerability a member of the Gardener Security Team will volunteer to lead coordination with the &ldquo;Fix Team&rdquo; and is responsible for sending disclosure e-mails to the rest of the community. This lead will be referred to as the &ldquo;Fix Lead.&rdquo; The role of the Fix Lead should rotate round-robin across the Gardener Security Team. Note that given the current size of the Gardener community it is likely that the Gardener Security Team is the same as the &ldquo;Fix team.&rdquo; (I.e., all maintainers). The Gardener Security Team may decide to bring in additional contributors for added expertise depending on the area of the code that contains the vulnerability. All of the time lines below are suggestions and assume a private disclosure. The Fix Lead drives the schedule using his best judgment based on severity and development time. If the Fix Lead is dealing with a public disclosure all time lines become ASAP (assuming the vulnerability has a CVSS score >= 7; see below). If the fix relies on another upstream project&rsquo;s disclosure time line, that will adjust the process as well. We will work with the upstream project to fit their time line and best protect our users.</p><h3 id=fix-team-organization>Fix Team Organization</h3><p>The Fix Lead will work quickly to identify relevant engineers from the affected projects and packages and CC those engineers into the disclosure thread. These selected developers are the Fix Team.
The Fix Lead will give the Fix Team access to a private security repository to develop the fix.</p><h3 id=fix-development-process>Fix Development Process</h3><p>The Fix Lead and the Fix Team will create a <a href=https://www.first.org/cvss/specification-document>CVSS</a> using the <a href=https://www.first.org/cvss/calculator/3.0>CVSS Calculator</a>. The Fix Lead makes the final call on the calculated CVSS; it is better to move quickly than make the CVSS perfect.
The Fix Team will notify the Fix Lead that work on the fix branch is complete once there are LGTMs on all commits in the private repository from one or more maintainers.
If the CVSS score is under 7.0 (a <a href=https://www.first.org/cvss/specification-document#i5>medium severity score</a>) the Fix Team can decide to slow the release process down in the face of holidays, developer bandwidth, etc. These decisions must be discussed on the private <a href=#communication-channel>Gardener Security mailing list</a>.</p><h3 id=fix-disclosure-process>Fix Disclosure Process</h3><p>With the fix development underway, the Fix Lead needs to come up with an overall communication plan for the wider community. This Disclosure process should begin after the Fix Team has developed a Fix or mitigation so that a realistic time line can be communicated to users. The Fix Lead will inform the <a href=#communication-channel>Gardener mailing list</a> that a security vulnerability has been disclosed and that a fix will be made available in the future on a certain release date. The Fix Lead will include any mitigating steps users can take until a fix is available. The communication to Gardener users should be actionable. They should know when to block time to apply patches, understand exact mitigation steps, etc.</p><h3 id=fix-release-day>Fix Release Day</h3><p>The Release Managers will ensure all the binaries are built, publicly available, and functional before the Release Date.
The Release Managers will create a new patch release branch from the latest patch release tag + the fix from the security branch. As a practical example if v0.12.0 is the latest patch release in gardener.git a new branch will be created called v0.12.1 which includes only patches required to fix the issue.
The Fix Lead will cherry-pick the patches onto the master branch and all relevant release branches. The Fix Team will <a href=https://github.com/lgtmco/lgtm>LGTM</a> and merge.
The Release Managers will merge these PRs as quickly as possible. Changes shouldn&rsquo;t be made to the commits even for a typo in the CHANGELOG as this will change the git sha of the already built and commits leading to confusion and potentially conflicts as the fix is cherry-picked around branches.
The Fix Lead will request a CVE from the SAP Product Security Response Team via email to <a href=mailto:cna@sap.com>cna@sap.com</a> with all the relevant information (description, potential impact, affected version, fixed version, CVSS v3 base score and supporting documentation for the CVSS score) for every vulnerability. The Fix Lead will inform the <a href=#communication-channel>Gardener mailing list</a> and announce the new releases, the CVE number (if available), the location of the binaries, and the relevant merged PRs to get wide distribution and user action.</p><p>As much as possible this e-mail should be actionable and include links how to apply the fix to users environments; this can include links to external distributor documentation. The recommended target time is 4pm UTC on a non-Friday weekday. This means the announcement will be seen morning Pacific, early evening Europe, and late evening Asia.
The Fix Lead will remove the Fix Team from the private security repository.</p><h3 id=retrospective>Retrospective</h3><p>These steps should be completed after the Release Date. The retrospective process <a href=https://landing.google.com/sre/book/chapters/postmortem-culture.html>should be blameless</a>.</p><p>The Fix Lead will send a retrospective of the process to the <a href=#communication-channel>Gardener mailing list</a> including details on everyone involved, the time line of the process, links to relevant PRs that introduced the issue, if relevant, and any critiques of the response and release process.
The Release Managers and Fix Team are also encouraged to send their own feedback on the process to the <a href=#communication-channel>Gardener mailing list</a>. Honest critique is the only way we are going to get good at this as a community.</p><h3 id=communication-channel>Communication Channel</h3><p>The <a href=#private-disclosure-process>private</a> or <a href=#public-disclosure-process>public disclosure process</a> should be triggered exclusively by writing an e-mail to <a href=mailto:secure@sap.com>secure@sap.com</a>.</p><p>Gardener security announcements will be communicated by the Fix Lead sending an e-mail to the <a href=https://groups.google.com/forum/#!forum/gardener>Gardener mailing list</a> (reachable via <a href=mailto:gardener@googlegroups.com>gardener@googlegroups.com</a>) as well as posting a link in the <a href=https://kubernetes.slack.com/messages/CB57N0BFG/details/>Gardener Slack channel</a>. Public discussions about Gardener security announcements and retrospectives, will primarily happen in the Gardener mailing list. Thus Gardener community members who are interested in participating in discussions related to the Gardener Security Release Process are encouraged to join the Gardener mailing list (<a href="https://support.google.com/groups/answer/1067205?hl=en">how to find and join a group</a>)</p><p>The members of the <a href=#gardener-security-team>Gardener Security Team</a> are subscribed to the private <a href=https://groups.google.com/forum/#!forum/gardener-security>Gardener Security mailing list</a> (reachable via <a href=mailto:gardener-security@googlegroups.com>gardener-security@googlegroups.com</a>).</p></div><div class=td-content style=page-break-before:always><h1 id=pg-20f6c6ae2bde2a86d198747232bac9f7>5.2 - Documentation</h1><h1 id=contributing-documentation>Contributing Documentation</h1><p>You are welcome to <strong>contribute documentation</strong> to Gardener.</p><p>The following rules govern documentation contributions:</p><ul><li>Contributions must be licensed under the <a href=https://creativecommons.org/licenses/by/4.0/legalcode>Creative Commons Attribution 4.0 International License</a></li><li>You need to sign the Contributor License Agreement. We are using <em><a href=https://cla-assistant.io/>CLA assistant</a></em> providing a click-through workflow for accepting the CLA. For company contributors additionally the company needs to sign a corporate license agreement. See the following sections for details.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d62441ff72901a18cf74b4dd2be084ee>5.2.1 - Markdown</h1><p>Hugo uses Markdown for its simple content format. However, there are a lot of things that Markdown
doesn’t support well. You could use pure HTML to expand possibilities. A typical example is reducing
the original dimensions of an image.</p><p>However, use HTML judicially and to the minimum extent possible. Using HTML in markdowns makes it
harder to maintain and publish coherent documentation bundles. This is a job typically performed by
a publishing platform mechanisms, such as Hugo&rsquo;s layouts. Considering that the source documentation
might be published by multiple platforms you should be considerate in using markup that may bind it
to a particular one.</p><p>For that reason we no longer support Hugo shortcodes. Instead we plan to gradually introduce mechanisms
to compensate for Markdowns&rsquo;s limitations with regard to creating documentation without departing from
&lsquo;normal&rsquo; Markdown towards a publishing platform.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0e5702fc9886e66dce242f397b3ca73e>5.2.2 - Organization</h1><p>The Gardener project implements the <em>documentation-as-code</em> paradigm. Essentially this means that:</p><ul><li>Documentation resides close to the code it describes - in the corresponding GitHub repositories. Only documentation with regards to cross-cutting concerns that cannot be affiliated to a specific component repository is hosted in the general <a href=https://github.com/gardener/documentation>gardener/documentation</a> repository.</li><li>We use tools to develop, validate and integrate documentation <em>sources</em></li><li>The change management process is largely automated with automatic validation, integration and deployment using <a href=https://github.com/gardener/docforge>docforge</a> and <a href=https://github.com/gardener/docs-toolbelt>docs-toolbelt</a>.</li><li>The documentation sources are intended for <em>reuse</em> and <em>not bound</em> to a specific publishing platform.</li><li>The physical organization in a repository is irrelevant for the tool support. What needs to be maintained is the intended result in a <a href=https://github.com/gardener/docforge>docforge</a> documentation bundle manifest configuration, very much like virtual machines configurations, that docforge can reliably recreate in any case.</li><li>We use GitHub as distributed, versioning storage system and <a href=https://github.com/gardener/docforge>docforge</a> to pull sources in their desired state to forge documentation bundles according to a desired specification provided as a manifest.</li></ul><h2 id=content-organization>Content Organization</h2><p>Documentation that can be affiliated to component is hosted and maintained in the component repository.</p><p>A recommended template for organizing documentation sources is to place them all in a <code>docs</code> folder and organize it there per role activity. For example:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>repositoryX
|_ docs
   |_ usage
   |  |_ images
   |  |_ 01.png
   |  |_ hibernation.md
   |_ operations
   |_ deployment
</code></pre></div><p>Do not use folders just because they are in the template. Stick to the predefined roles and corresponding activities for naming convention. A system makes it easier to maintain and get oriented.</p><ul><li>User: <code>usage</code></li><li>Operator: <code>operations</code></li><li>Gardener (service) provider: <code>deployment</code></li><li>Gardener Developer: <code>development</code></li><li>Gardener Extension Developer: <code>extensions</code></li></ul><h2 id=publishing-on-gardenercloud>Publishing on gardener.cloud</h2><p>The Gardener website is one of the multiple optional publishing channels where the source material might end up as documentation. We use docforge and automated integration and publish process to enable transparent change
management.</p><p>To have documentation published on the website it is necessary to use the docforge manifests available at [gardener/documentation/.docforge] adn register a reference to your documentation.</p><blockquote><p><strong>Note</strong>: This is work in progress and we are transitioning to a more transparent way of integrating component
documentation. This guide will be updated as we progress.</p></blockquote><p>These manifests describe a particular publishing goal, i.e. using Hugo to publish on the website, and you will find out that they contain Hugo-specific front-matter properties.
Consult with the documentation maintainers for details. Use the gardener channel in slack or open a PR.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3062581d7de9a7681fa3379a44a604c8>5.2.3 - Style Guide</h1><p>This page gives writing style guidelines for the Gardener documentation.
These are guidelines, not rules. Use your best judgment, and feel free to
propose changes to this document in a pull request.</p><ul><li><a href=#language>Language</a></li><li><a href=#formatting-of-inline-elements>Formatting of Inline Elements</a></li><li><a href=#code-snippet-formatting>Code Snippet Formatting</a></li></ul><h2 id=language>Language</h2><ul><li>Gardener documentation uses US English.</li><li>Keep it simple and use words that non-native English speakers are also familiar with.</li></ul><h2 id=formatting-of-inline-elements>Formatting of Inline Elements</h2><table><thead><tr><th style=text-align:left>Type of Text</th><th style=text-align:left>Formatting</th><th style=text-align:left>Markdown Syntax</th></tr></thead><tbody><tr><td style=text-align:left><a href=#user-interface-elements>User Interface Elements</a></td><td style=text-align:left><em>italics</em></td><td style=text-align:left><code>Choose *CLUSTERS*</code>.</td></tr><tr><td style=text-align:left><a href=#new-terms-and-emphasis>New Terms and Emphasis</a></td><td style=text-align:left><strong>bold</strong></td><td style=text-align:left><code>Do **not** stop it.</code></td></tr><tr><td style=text-align:left><a href=#technical-names>Technical Names</a></td><td style=text-align:left><code>code</code></td><td style=text-align:left><code>Open file `root.yaml`.</code></td></tr><tr><td style=text-align:left><a href=#api-objects-and-technical-components>API Objects and Technical Components</a></td><td style=text-align:left><code>code</code></td><td style=text-align:left><code>Deploy a `Pod`.</code></td></tr><tr><td style=text-align:left><a href=#inline-code-and-inline-commands>Inline Code and Inline Commands</a></td><td style=text-align:left><code>code</code></td><td style=text-align:left><code>For declarative management, use `kubectl apply`.</code></td></tr><tr><td style=text-align:left><a href=#object-field-names-and-field-values>Object Field Names and Field Values</a></td><td style=text-align:left><code>code</code></td><td style=text-align:left><code>Set the value of `image` to `nginx:1.8`.</code></td></tr></tbody></table><h3 id=user-interface-elements>User Interface Elements</h3><p>When referring to UI elements, refrain from using verbs like &ldquo;Click&rdquo; or &ldquo;Select with right mouse button&rdquo;. This level of detail is hardly ever needed and also invalidates a procedure if other devices are used. For example, for a tablet you&rsquo;d say &ldquo;Tap on&rdquo;.</p><p>Use <em>italics</em> when you refer to UI elements.</p><table><thead><tr><th style=text-align:left>UI Element</th><th style=text-align:left>Standard Formulation</th><th style=text-align:left>Markdown Syntax</th></tr></thead><tbody><tr><td style=text-align:left>Button, Menu path</td><td style=text-align:left>Choose <em>UI Element</em>.</td><td style=text-align:left><code>Choose *UI Element*.</code></td></tr><tr><td style=text-align:left>Menu path, context menu, navigation path</td><td style=text-align:left>Choose <em>System</em> > <em>User Profile</em> > <em>Own Data</em>.</td><td style=text-align:left><code>Choose *System* \> *User Profile* \> *Own Data*.</code></td></tr><tr><td style=text-align:left>Entry fields</td><td style=text-align:left>Enter your password.</td><td style=text-align:left><code>Enter your password.</code></td></tr><tr><td style=text-align:left>Checkbox, radio button</td><td style=text-align:left>Select <em>Filter</em>.</td><td style=text-align:left><code>Select *Filter*.</code></td></tr><tr><td style=text-align:left>Expandable screen elements</td><td style=text-align:left>Expand <em>User Settings</em>.<br>Collapse <em>User Settings</em>.</td><td style=text-align:left><code>Expand *User Settings*</code>.<br><code>Collapse *User Settings*.</code></td></tr></tbody></table><h3 id=new-terms-and-emphasis>New Terms and Emphasis</h3><p>Use <strong>bold</strong> to emphasize something or to introduce a new term.</p><table><thead><tr><th style=text-align:left>Do</th><th style=text-align:left>Don&rsquo;t</th></tr></thead><tbody><tr><td style=text-align:left>A <strong>cluster</strong> is a set of nodes &mldr;</td><td style=text-align:left>A &ldquo;cluster&rdquo; is a set of nodes &mldr;</td></tr><tr><td style=text-align:left>The system does <strong>not</strong> delete your objects.</td><td style=text-align:left>The system does not(!) delete your objects.</td></tr></tbody></table><h3 id=technical-names>Technical Names</h3><p>Use code style (using backticks) for filenames, technical componentes, directories, and paths.</p><table><thead><tr><th style=text-align:left>Do</th><th style=text-align:left>Don&rsquo;t</th></tr></thead><tbody><tr><td style=text-align:left>Open file <code>envars.yaml</code>.</td><td style=text-align:left>Open the envars.yaml file.</td></tr><tr><td style=text-align:left>Go to directory <code>/docs/tutorials</code>.</td><td style=text-align:left>Go to the /docs/tutorials directory.</td></tr><tr><td style=text-align:left>Open file <code>/_data/concepts.yaml</code>.</td><td style=text-align:left>Open the /_data/concepts.yaml file.</td></tr></tbody></table><h3 id=api-objects-and-technical-components>API Objects and Technical Components</h3><p>When you refer to an API object, use the same uppercase and lowercase letters
that are used in the actual object name, and use backticks to format them. Typically, the names of API
objects use
<a href=https://en.wikipedia.org/wiki/Camel_case>camel case</a>.</p><p>Don&rsquo;t split the API object name into separate words. For example, use
<code>PodTemplateList</code>, not Pod Template List.</p><p>Refer to API objects without saying &ldquo;object,&rdquo; unless omitting &ldquo;object&rdquo;
leads to an awkward construction.</p><table><thead><tr><th style=text-align:left>Do</th><th style=text-align:left>Don&rsquo;t</th></tr></thead><tbody><tr><td style=text-align:left>The <code>Pod</code> has two containers.</td><td style=text-align:left>The pod has two containers.</td></tr><tr><td style=text-align:left>The <code>Deployment</code> is responsible for &mldr;</td><td style=text-align:left>The Deployment object is responsible for &mldr;</td></tr><tr><td style=text-align:left>A <code>PodList</code> is a list of Pods.</td><td style=text-align:left>A Pod List is a list of pods.</td></tr><tr><td style=text-align:left>The <code>gardener-control-manager</code> has control loops&mldr;</td><td style=text-align:left>The gardener-control-manager has control loops&mldr;</td></tr><tr><td style=text-align:left>The <code>gardenlet</code> starts up with a bootstrap <code>kubeconfig</code> having a bootstrap token that allows to create <code>CertificateSigningRequest</code> (CSR) resources.</td><td style=text-align:left>The gardenlet starts up with a bootstrap kubeconfig having a bootstrap token that allows to create CertificateSigningRequest (CSR) resources.</td></tr></tbody></table><h3 id=inline-code-and-inline-commands>Inline Code and Inline Commands</h3><p>Use backticks (`) for inline code.</p><table><thead><tr><th style=text-align:left>Do</th><th style=text-align:left>Don&rsquo;t</th></tr></thead><tbody><tr><td style=text-align:left>The <code>kubectl run</code> command creates a <code>Deployment</code>.</td><td style=text-align:left>The &ldquo;kubectl run&rdquo; command creates a Deployment.</td></tr><tr><td style=text-align:left>For declarative management, use <code>kubectl apply</code>.</td><td style=text-align:left>For declarative management, use &ldquo;kubectl apply&rdquo;.</td></tr></tbody></table><h3 id=object-field-names-and-field-values>Object Field Names and Field Values</h3><p>Use backticks (`) for field names, and field values.</p><table><thead><tr><th style=text-align:left>Do</th><th style=text-align:left>Don&rsquo;t</th></tr></thead><tbody><tr><td style=text-align:left>Set the value of the <code>replicas</code> field in the configuration file.</td><td style=text-align:left>Set the value of the &ldquo;replicas&rdquo; field in the configuration file.</td></tr><tr><td style=text-align:left>The value of the <code>exec</code> field is an <code>ExecAction</code> object.</td><td style=text-align:left>The value of the &ldquo;exec&rdquo; field is an ExecAction object.</td></tr><tr><td style=text-align:left>Set the value of <code>imagePullPolicy</code> to <code>Always</code>.</td><td style=text-align:left>Set the value of <code>imagePullPolicy</code> to &ldquo;Always&rdquo;.</td></tr><tr><td style=text-align:left>Set the value of <code>image</code> to <code>nginx:1.8</code>.</td><td style=text-align:left>the value of <code>image</code> to nginx:1.8.</td></tr></tbody></table><h2 id=code-snippet-formatting>Code Snippet Formatting</h2><h3 id=dont-include-the-command-prompt>Don&rsquo;t include the command prompt</h3><table><thead><tr><th style=text-align:left>Do</th><th style=text-align:left>Don&rsquo;t</th></tr></thead><tbody><tr><td style=text-align:left><code>kubectl get pods</code></td><td style=text-align:left><code>$ kubectl get pods</code></td></tr></tbody></table><h3 id=separate-commands-from-output>Separate commands from output</h3><code>Verify that the pod is running on your chosen node:<pre><code>kubectl get pods --output=wide
</code></pre><p>The output is similar to:</p><pre><code>NAME     READY     STATUS    RESTARTS   AGE    IP           NODE
nginx    1/1       Running   0          13s    10.200.0.4   worker0
</code></pre></code><h3 id=placeholders>Placeholders</h3><p>Use angle brackets for placeholders. Tell the reader what a placeholder
represents, for example:</p><code><p>Display information about a pod:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl describe pod &lt;pod-name&gt;
</code></pre></div><p><code>&lt;pod-name></code> is the name of one of your pods.</p></code><h3 id=versioning-kubernetes-examples>Versioning Kubernetes examples</h3><p>Make code examples and configuration examples that include version information consistent with the accompanying text. Identify the Kubernetes version in the <strong>Prerequisites</strong> section.</p></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=/blog/>Blogs</a></li><li><a href=/community/>Community</a></li><li><a href=/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2021 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script></body></html>