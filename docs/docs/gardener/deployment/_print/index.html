<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=https://gardener.cloud/docs/gardener/deployment/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/gardener/deployment/index.xml><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=icon type=image/x-icon href=https://gardener.cloud/images/favicon.ico><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-16x16.png sizes=16x16><title>Deployment | Gardener</title><meta name=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:title" content="Deployment"><meta property="og:description" content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:type" content="website"><meta property="og:url" content="https://gardener.cloud/docs/gardener/deployment/"><meta itemprop=name content="Deployment"><meta itemprop=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deployment"><meta name=twitter:description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><link rel=preload href=/scss/main.min.122f9effc36493edf1f25030c2ce7965b16b3b0eaeb02528b9a50e0fa9110c15.css as=style><link href=/scss/main.min.122f9effc36493edf1f25030c2ce7965b16b3b0eaeb02528b9a50e0fa9110c15.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.1525207f35291721f88a0d0e4bab8bca.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/gardener/deployment/>Return to the regular view of this page</a>.</p></div><h1 class=title>Deployment</h1><div class=content></div></div><div class=td-content><h1 id=pg-ac0acc1100465755b2c4985cf68f7409>1 - Configuring Logging</h1><h1 id=configuring-the-logging-stack-via-gardenlet-configurations>Configuring the Logging stack via Gardenlet configurations</h1><h1 id=enable-the-logging>Enable the Logging</h1><p>Logging feature gate must be enabled in order to install the Gardener Logging stack.</p><p>In the Gardenlet configuration add:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>featureGates</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>Logging</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></code></pre></div><p>From now on each Seed is going to have a logging stack which will collect logs from all pods and some systemd services. Logs related to Shoots with <code>testing</code> purpose are dropped in the <code>fluent-bit</code> output plugin. Shoots with a purpose different than <code>testing</code> have the same type of log aggregator (but different instance) as the Seed. The logs can be viewed in the Grafana in the <code>garden</code> namespace for the Seed components and in the respective shoot control plane namespaces.</p><h1 id=enable-logs-from-the-shoots-node-systemd-services>Enable logs from the Shoot&rsquo;s node systemd services.</h1><p>The logs from the systemd services on each node can be retrieved by enabling the <code>logging.shootNodeLogging</code> option in the Gardenlet configuration:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>featureGates</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>Logging</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w></span><span class=nt>logging</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>shootNodeLogging</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>shootPurposes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=s2>&#34;evaluation&#34;</span><span class=w>
</span><span class=w>    </span>- <span class=s2>&#34;deployment&#34;</span><span class=w>
</span></code></pre></div><p>Under the <code>shootPurpose</code> section just list all the shoot purposes for which the Shoot node logging feature will be enabled. Specifying the <code>testing</code> purpose has no effect because this purpose prevents the logging stack installation.
Logs can be viewed in the operator Grafana!
The dedicated labels are <code>unit</code>, <code>syslog_identifier</code> and <code>nodename</code> in the <code>Explore</code> menu.</p><h1 id=configuring-the-log-processor>Configuring the log processor</h1><p>Under <code>logging.fluentBit</code> there is three optional sections.</p><ul><li><code>input</code>: This overwrite the input configuration of the fluent-bit log processor.</li><li><code>output</code>: This overwrite the output configuration of the fluent-bit log processor.</li><li><code>service</code>: This overwrite the service configuration of the fluent-bit log processor.</li></ul><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>featureGates</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>Logging</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w></span><span class=nt>logging</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>fluentBit</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>output</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span><span class=sd>      [Output]
</span><span class=sd>          ...</span><span class=w>      
</span><span class=w>    </span><span class=nt>input</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span><span class=sd>      [Input]
</span><span class=sd>          ...</span><span class=w>      
</span><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span><span class=sd>      [Service]
</span><span class=sd>          ...</span><span class=w>      
</span></code></pre></div><h1 id=configuring-the-loki-priorityclass>Configuring the Loki PriorityClass</h1><p>The central Loki, which is in the <code>garden</code> namespace, contains all the logs from the most important seed components. When the central Loki <code>PriorityClass</code> is with low value then its pods can be preempted and often moved from one node to another while Kubernetes tries to free space for more important pods. The persistent volume will be detached/attached again as well. Based on the performance of the underlying infrastructure, this leads to great central Loki downtime. To give greater priority of the seed Loki you can use the <code>logging.loki.garden.priority</code> option.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>featureGates</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>Logging</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w></span><span class=nt>logging</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>loki</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>garden</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>priority</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-e2f3032b3740e0030af0d52262ec390e>2 - Deploy Gardenlet</h1><h1 id=deploying-gardenlets>Deploying Gardenlets</h1><p>Gardenlets act as decentral &ldquo;agents&rdquo; to manage shoot clusters of a seed cluster.</p><p>To support scaleability in an automated way, gardenlets are deployed automatically. However, you can still deploy gardenlets manually to be more flexible, for example, when shoot clusters that need to be managed by Gardener are behind a firewall. The gardenlet only requires network connectivity from the gardenlet to the Garden cluster (not the other way round), so it can be used to register Kubernetes clusters with no public endpoint.</p><h2 id=procedure>Procedure</h2><ol><li><p>First, an initial gardenlet needs to be deployed:</p><ul><li>Deploy it manually if you have special requirements. More information: <a href=/docs/gardener/deployment/deploy_gardenlet_manually>Deploy a Gardenlet Manually</a></li><li>Let the Gardener installer deploy it automatically otherwise. More information: <a href=/docs/gardener/deployment/deploy_gardenlet_automatically>Automatic Deployment of Gardenlets</a></li></ul></li><li><p>To add additional seed clusters, it is recommended to use regular shoot clusters. You can do this by creating a <code>ManagedSeed</code> resource with a <code>gardenlet</code> section as described in <a href=/docs/gardener/usage/managed_seed>Register Shoot as Seed</a>.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-0af204f84f4a80fc61988beb16c39e12>3 - Deploy Gardenlet Automatically</h1><h1 id=automatic-deployment-of-gardenlets>Automatic Deployment of Gardenlets</h1><p>The gardenlet can automatically deploy itself into shoot clusters, and register this cluster as a seed cluster.
These clusters are called &ldquo;managed seeds&rdquo; (aka &ldquo;shooted seeds&rdquo;).
This procedure is the preferred way to add additional seed clusters, because shoot clusters already come with production-grade qualities that are also demanded for seed clusters.</p><h2 id=prerequisites>Prerequisites</h2><p>The only prerequisite is to register an initial cluster as a seed cluster that has already a gardenlet deployed:</p><ul><li>This gardenlet was either deployed as part of a Gardener installation using a setup tool (for example, <code>gardener/garden-setup</code>) or</li><li>the gardenlet was deployed manually<ul><li>for a step-by-step manual installation Guide see: <a href=/docs/gardener/deployment/deploy_gardenlet_manually>Deploy a Gardenlet Manually</a>)</li><li>for a Gardenlet deployment using an installation tool see: <a href=https://github.com/gardener/gardener/blob/master/landscaper/pkg/gardenlet/README.md>Gardenlet landscaper component</a>.</li></ul></li></ul><blockquote><p>The initial cluster can be the garden cluster itself.</p></blockquote><h2 id=self-deployment-of-gardenlets-in-additional-managed-seed-clusters>Self-Deployment of Gardenlets in Additional Managed Seed Clusters</h2><p>For a better scalability, you usually need more seed clusters that you can create as follows:</p><ol><li>Use the initial cluster as the seed cluster for other managed seed clusters. It hosts the control planes of the other seed clusters.</li><li>The gardenlet deployed in the initial cluster deploys itself automatically into the managed seed clusters.</li></ol><p>The advantage of this approach is that there’s only one initial gardenlet installation required. Every other managed seed cluster has a gardenlet deployed automatically.</p><h2 id=related-links>Related Links</h2><p><a href=/docs/gardener/usage/managed_seed>Register Shoot as Seed</a></p><p><a href=http://github.com/gardener/garden-setup>garden-setup</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ed3b289c8b619ea2a52bab3ae97c199c>4 - Deploy Gardenlet Manually</h1><h1 id=deploy-a-gardenlet-manually>Deploy a Gardenlet Manually</h1><p>Manually deploying a gardenlet is required in the following cases:</p><ul><li><p>The Kubernetes cluster to be registered as a seed cluster has no public endpoint,
because it is behind a firewall.
The gardenlet must then be deployed into the cluster itself.</p></li><li><p>The Kubernetes cluster to be registered as a seed cluster is managed externally
(the Kubernetes cluster is not a shoot cluster, so <a href=/docs/gardener/deployment/deploy_gardenlet_automatically>Automatic Deployment of Gardenlets</a> cannot be used).</p></li><li><p>The gardenlet runs outside of the Kubernetes cluster
that should be registered as a seed cluster.
(The gardenlet is not restricted to run in the seed cluster or
to be deployed into a Kubernetes cluster at all).</p></li></ul><blockquote><p>Once you’ve deployed a gardenlet manually, for example, behind a firewall, you can deploy new gardenlets automatically. The manually deployed gardenlet is then used as a template for the new gardenlets. More information: <a href=/docs/gardener/deployment/deploy_gardenlet_automatically>Automatic Deployment of Gardenlets</a>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><h3 id=kubernetes-cluster-that-should-be-registered-as-a-seed-cluster>Kubernetes cluster that should be registered as a seed cluster</h3><ul><li><p>Verify that the cluster has a <a href=/docs/gardener/usage/supported_k8s_versions>supported Kubernetes version</a>.</p></li><li><p>Determine the nodes, pods, and services CIDR of the cluster.
You need to configure this information in the <code>Seed</code> configuration.
Gardener uses this information to check that the shoot cluster isn’t created with overlapping CIDR ranges.</p></li><li><p>Every Seed cluster needs an Ingress controller which distributes external requests to internal components like grafana and prometheus. Gardener supports two approaches to achieve this:</p></li></ul><p>a. Gardener managed Ingress controller and DNS records. For this configure the following lines in your <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml>Seed resource</a>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>provider</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws-route53</span><span class=w>
</span><span class=w>      </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ingress-secret</span><span class=w>
</span><span class=w>        </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>domain</span><span class=p>:</span><span class=w> </span><span class=l>ingress.my-seed.example.com</span><span class=w>
</span><span class=w>    </span><span class=nt>controller</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>      </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=l>&lt;some-optional-provider-specific-config-for-the-ingressController&gt;</span><span class=w>
</span></code></pre></div><p>⚠ Please note that if you set <code>.spec.ingress</code> then <code>.spec.dns.ingressDomain</code> must be <code>nil</code>.</p><p>b. Self-managed DNS record and Ingress controller:</p><p>:warning:
There should exist a DNS record <code>*.ingress.&lt;SEED-CLUSTER-DOMAIN></code> where <code>&lt;SEED-CLUSTER-DOMAIN></code> is the value of the <code>.dns.ingressDomain</code> field of <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml>a Seed cluster resource</a> (or the <a href=https://github.com/gardener/gardener/blob/master/example/20-componentconfig-gardenlet.yaml#L84-L85>respective Gardenlet configuration</a>).</p><p><em>This is how it could be done for the Nginx ingress controller</em></p><p>Deploy nginx into the <code>kube-system</code> namespace in the Kubernetes cluster that should be registered as a <code>Seed</code>.</p><p>Nginx will on most cloud providers create the service with type <code>LoadBalancer</code> with an external ip.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>NAME                        TYPE           CLUSTER-IP    EXTERNAL-IP
nginx-ingress-controller    LoadBalancer   10.0.15.46    34.200.30.30
</code></pre></div><p>Create a wildcard <code>A</code> record (e.g *.ingress.sweet-seed.<my-domain>. IN A 34.200.30.30) with your DNS provider and point it to the external ip of the ingress service. This ingress domain is later required to register the <code>Seed</code> cluster.</p><p>Please configure the ingress domain in the <code>Seed</code> specification as follows:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>ingressDomain</span><span class=p>:</span><span class=w> </span><span class=l>ingress.sweet-seed.&lt;my-domain&gt;</span><span class=w>
</span></code></pre></div><p>⚠ Please note that if you set <code>.spec.dns.ingressDomain</code> then <code>.spec.ingress</code> must be <code>nil</code>.</p><h3 id=kubeconfig-for-the-seed-cluster><code>kubeconfig</code> for the Seed Cluster</h3><p>The <code>kubeconfig</code> is required to deploy the gardenlet Helm chart to the seed cluster.
The gardenlet requires certain privileges to be able to operate.
These privileges are described in RBAC resources in the gardenlet Helm chart (see <a href=https://github.com/gardener/gardener/tree/master/charts/gardener/gardenlet/charts/runtime/templates>charts/gardener/gardenlet/charts/runtime/templates</a>).
The Helm chart contains a service account <code>gardenlet</code>
that the gardenlet deployment uses by default to talk to the Seed API server.</p><blockquote><p>If the gardenlet isn’t deployed in the seed cluster,
the gardenlet can be configured to use a <code>kubeconfig</code>,
which also requires the above-mentioned privileges, from a mounted directory.
The <code>kubeconfig</code> is specified in section <code>seedClientConnection.kubeconfig</code>
of the <a href=https://github.com/gardener/gardener/blob/master/example/20-componentconfig-gardenlet.yaml>Gardenlet configuration</a>.
This configuration option isn’t used in the following,
as this procedure only describes the recommended setup option
where the gardenlet is running in the seed cluster itself.</p></blockquote><h2 id=procedure-overview>Procedure Overview</h2><ol><li><p>Prepare the garden cluster:</p><ol><li><a href=#create-a-bootstrap-token-secret-in-the-kube-system-namespace-of-the-garden-cluster>Create a bootstrap token secret in the <code>kube-system</code> namespace of the garden cluster</a></li><li><a href=#create-rbac-roles-for-the-gardenlet-to-allow-bootstrapping-in-the-garden-cluster>Create RBAC roles for the gardenlet to allow bootstrapping in the garden cluster</a></li></ol></li><li><p><a href=#prepare-the-gardenlet-helm-chart>Prepare the gardenlet Helm chart</a>.</p></li><li><p><a href=#automatically-register-shoot-cluster-as-a-seed-cluster>Automatically register shoot cluster as a seed cluster</a>.</p></li><li><p><a href=#deploy-the-gardenlet>Deploy the gardenlet</a></p></li><li><p><a href=#check-that-the-gardenlet-is-successfully-deployed>Check that the gardenlet is successfully deployed</a></p></li></ol><h2 id=create-a-bootstrap-token-secret-in-the-kube-system-namespace-of-the-garden-cluster>Create a bootstrap token secret in the <code>kube-system</code> namespace of the garden cluster</h2><p>The gardenlet needs to talk to the <a href=/docs/gardener/concepts/apiserver>Gardener API server</a> residing in the garden cluster.</p><p>The gardenlet can be configured with an already existing garden cluster <code>kubeconfig</code> in one of the following ways:</p><ul><li><p>Either by specifying <code>gardenClientConnection.kubeconfig</code>
in the <a href=https://github.com/gardener/gardener/blob/master/example/20-componentconfig-gardenlet.yaml>Gardenlet configuration</a> or</p></li><li><p>by supplying the environment variable <code>GARDEN_KUBECONFIG</code> pointing to
a mounted <code>kubeconfig</code> file).</p></li></ul><p>The preferred way however, is to use the gardenlets ability to request
a signed certificate for the garden cluster by leveraging
<a href=https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/>Kubernetes Certificate Signing Requests</a>.
The gardenlet performs a TLS bootstrapping process that is similar to the
<a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/>Kubelet TLS Bootstrapping</a>.
Make sure that the API server of the garden cluster has
<a href=https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/#enabling-bootstrap-token-authentication>bootstrap token authentication</a>
enabled.</p><p>The client credentials required for the gardenlets TLS bootstrapping process,
need to be either <code>token</code> or <code>certificate</code> (OIDC isn’t supported) and have permissions
to create a Certificate Signing Request (<a href=https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/>CSR</a>).
It’s recommended to use <a href=https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/>bootstrap tokens</a>
due to their desirable security properties (such as a limited token lifetime).</p><p>Therefore, first create a bootstrap token secret for the garden cluster:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># Name MUST be of form &#34;bootstrap-token-&lt;token id&gt;&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>bootstrap-token-07401b</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># Type MUST be &#39;bootstrap.kubernetes.io/token&#39;</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>bootstrap.kubernetes.io/token</span><span class=w>
</span><span class=w></span><span class=nt>stringData</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># Human readable description. Optional.</span><span class=w>
</span><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Token to be used by the gardenlet for Seed `sweet-seed`.&#34;</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># Token ID and secret. Required.</span><span class=w>
</span><span class=w>  </span><span class=nt>token-id</span><span class=p>:</span><span class=w> </span><span class=l>07401b</span><span class=w> </span><span class=c># 6 characters</span><span class=w>
</span><span class=w>  </span><span class=nt>token-secret</span><span class=p>:</span><span class=w> </span><span class=l>f395accd246ae52d</span><span class=w> </span><span class=c># 16 characters</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># Expiration. Optional.</span><span class=w>
</span><span class=w>  </span><span class=c># expiration: 2017-03-10T03:22:11Z</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=c># Allowed usages.</span><span class=w>
</span><span class=w>  </span><span class=nt>usage-bootstrap-authentication</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>usage-bootstrap-signing</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></code></pre></div><p>When you later prepare the gardenlet Helm chart,
a <code>kubeconfig</code> based on this token is shared with the gardenlet upon deployment.</p><h2 id=create-rbac-roles-for-the-gardenlet-to-allow-bootstrapping-in-the-garden-cluster>Create RBAC roles for the gardenlet to allow bootstrapping in the garden cluster</h2><p>This step is only required if the gardenlet you deploy is the first gardenlet
in the Gardener installation.
Additionally, when using the <a href=https://github.com/gardener/gardener/tree/master/charts/gardener/controlplane>control plane chart</a>,
the following resources are already contained in the Helm chart,
that is, if you use it you can skip these steps as the needed RBAC roles already exist.</p><p>The gardenlet uses the configured bootstrap <code>kubeconfig</code> in <code>gardenClientConnection.bootstrapKubeconfig</code> to request a signed certificate for the user <code>gardener.cloud:system:seed:&lt;seed-name></code> in the group <code>gardener.cloud:system:seeds</code>.</p><p>Create a <code>ClusterRole</code> and <code>ClusterRoleBinding</code> that grant full admin permissions to authenticated gardenlets.</p><p>Create the following resources in the garden cluster:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener.cloud:system:seeds</span><span class=w>
</span><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener.cloud:system:seeds</span><span class=w>
</span><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener.cloud:system:seeds</span><span class=w>
</span><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener.cloud:system:seeds</span><span class=w>
</span><span class=w>    </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener.cloud:system:seed-bootstrapper</span><span class=w>
</span><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>certificates.k8s.io</span><span class=w>
</span><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>certificatesigningrequests</span><span class=w>
</span><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>create</span><span class=w>
</span><span class=w>      </span>- <span class=l>get</span><span class=w>
</span><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>certificates.k8s.io</span><span class=w>
</span><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>certificatesigningrequests/seedclient</span><span class=w>
</span><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>create</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=c># A kubelet/gardenlet authenticating using bootstrap tokens is authenticated as a user in the group system:bootstrappers</span><span class=w>
</span><span class=w></span><span class=c># Allows the Gardenlet to create a CSR</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener.cloud:system:seed-bootstrapper</span><span class=w>
</span><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardener.cloud:system:seed-bootstrapper</span><span class=w>
</span><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrappers</span><span class=w>
</span><span class=w>    </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></code></pre></div><p>ℹ️ After bootstrapping, the gardenlet has full administrative access to the garden cluster.
You might be interested to harden this and limit its permissions to only resources related to the seed cluster it is responsible for.
Please take a look into <a href=/docs/gardener/deployment/gardenlet_api_access>this document</a>.</p><h2 id=prepare-the-gardenlet-helm-chart>Prepare the gardenlet Helm chart</h2><p>This section only describes the minimal configuration,
using the global configuration values of the gardenlet Helm chart.
For an overview over all values, see the <a href=https://github.com/gardener/gardener/blob/master/charts/gardener/gardenlet/values.yaml>configuration values</a>.
We refer to the global configuration values as <em>gardenlet configuration</em> in the remaining procedure.</p><ol><li><p>Create a gardenlet configuration <code>gardenlet-values.yaml</code> based on <a href=https://github.com/gardener/gardener/blob/master/charts/gardener/gardenlet/values.yaml>this template</a>.</p></li><li><p>Create a bootstrap <code>kubeconfig</code> based on the bootstrap token created in the garden cluster.</p><p>Replace the <code>&lt;bootstrap-token></code> with <code>token-id.token-secret</code> (from our previous example: <code>07401b.f395accd246ae52d</code>) from the bootstrap token secret.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-bootstrap@default</span><span class=w>
</span><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>certificate-authority-data</span><span class=p>:</span><span class=w> </span><span class=l>&lt;ca-of-garden-cluster&gt;</span><span class=w>
</span><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://&lt;endpoint-of-garden-cluster&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-bootstrap</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-bootstrap@default</span><span class=w>
</span><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-bootstrap</span><span class=w>
</span><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>&lt;bootstrap-token&gt;</span><span class=w>
</span></code></pre></div></li><li><p>In section <code>gardenClientConnection.bootstrapKubeconfig</code> of your gardenlet configuration, provide the bootstrap <code>kubeconfig</code> together with a name and namespace to the gardenlet Helm chart.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>gardenClientConnection</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>bootstrapKubeconfig</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-kubeconfig-bootstrap</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>    </span><span class=nt>kubeconfig</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>      </span><span class=w>      </span><span class=l>&lt;bootstrap-kubeconfig&gt; </span><span class=w> </span><span class=c># will be base64 encoded by helm</span><span class=w>
</span></code></pre></div><p>The bootstrap <code>kubeconfig</code> is stored in the specified secret.</p></li><li><p>In section <code>gardenClientConnection.kubeconfigSecret</code> of your gardenlet configuration,
define a name and a namespace where the gardenlet stores
the real <code>kubeconfig</code> that it creates during the bootstrap process. If the secret doesn&rsquo;t exist,
the gardenlet creates it for you.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>gardenClientConnection</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>kubeconfigSecret</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-kubeconfig</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span></code></pre></div></li></ol><h2 id=automatically-register-shoot-cluster-as-a-seed-cluster>Automatically register shoot cluster as a seed cluster</h2><p>A seed cluster can either be registered by manually creating
the <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml><code>Seed</code> resource</a>
or automatically by the gardenlet.
This functionality is useful for managed seed clusters,
as the gardenlet in the garden cluster deploys a copy of itself
into the cluster with automatic registration of the <code>Seed</code> configured.
However, it can also be used to have a streamlined seed cluster registration process when manually deploying the gardenlet.</p><blockquote><p>This procedure doesn’t describe all the possible configurations
for the <code>Seed</code> resource. For more information, see:</p><ul><li><a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml>Example Seed resource</a></li><li><a href=/docs/gardener/usage/seed_settings>Configurable Seed settings</a>.</li></ul></blockquote><h3 id=adjust-the-gardenlet-component-configuration>Adjust the gardenlet component configuration</h3><ol><li><p>Supply the <code>Seed</code> resource in section <code>seedConfig</code> of your gardenlet configuration <code>gardenlet-values.yaml</code>.</p></li><li><p>Add the <code>seedConfig</code> to your gardenlet configuration <code>gardenlet-values.yaml</code>.
The field <code>seedConfig.spec.provider.type</code> specifies the infrastructure provider type (for example, <code>aws</code>) of the seed cluster.
For all supported infrastructure providers, see <a href=https://github.com/gardener/gardener/blob/master/extensions/README.md#known-extension-implementations>Known Extension Implementations</a>.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>...</span><span class=l>.</span><span class=w>
</span><span class=w></span><span class=nt>seedConfig</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sweet-seed</span><span class=w>
</span><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>ingressDomain</span><span class=p>:</span><span class=w> </span><span class=l>ingress.sweet-seed.&lt;my-domain&gt;</span><span class=w> </span><span class=c># see prerequisites</span><span class=w>
</span><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w> </span><span class=c># see prerequisites</span><span class=w>
</span><span class=w>      </span><span class=nt>nodes</span><span class=p>:</span><span class=w> </span><span class=m>10.240.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>      </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=m>100.244.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>      </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=m>100.32.0.0</span><span class=l>/13</span><span class=w>
</span><span class=w>      </span><span class=nt>shootDefaults: # optional</span><span class=p>:</span><span class=w> </span><span class=l>non-overlapping default CIDRs for shoot clusters of that Seed</span><span class=w>
</span><span class=w>        </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=m>100.96.0.0</span><span class=l>/11</span><span class=w>
</span><span class=w>        </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=m>100.64.0.0</span><span class=l>/13</span><span class=w>
</span><span class=w>    </span><span class=nt>provider</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>&lt;provider&gt;</span><span class=w>
</span></code></pre></div></li></ol><h3 id=optional-enable-backup-and-restore>Optional: Enable backup and restore</h3><p>The seed cluster can be set up with backup and restore
for the main <code>etcds</code> of shoot clusters.</p><p>Gardener uses <a href=https://github.com/gardener/etcd-backup-restore>etcd-backup-restore</a>
that <a href=https://github.com/gardener/etcd-backup-restore/blob/master/doc/usage/getting_started.md#usage>integrates with different storage providers</a>
to store the shoot cluster&rsquo;s main <code>etcd</code> backups.
Make sure to obtain client credentials that have sufficient permissions with the chosen storage provider.</p><p>Create a secret in the garden cluster with client credentials for the storage provider.
The format of the secret is cloud provider specific and can be found
in the repository of the respective Gardener extension.
For example, the secret for AWS S3 can be found in the AWS provider extension
(<a href=https://github.com/gardener/gardener-extension-provider-aws/blob/master/example/30-etcd-backup-secret.yaml>30-etcd-backup-secret.yaml</a>).</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sweet-seed-backup</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># client credentials format is provider specific</span><span class=w>
</span></code></pre></div><p>Configure the <code>Seed</code> resource in section <code>seedConfig</code> of your gardenlet configuration to use backup and restore:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>seedConfig</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sweet-seed</span><span class=w>
</span><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>backup</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>provider</span><span class=p>:</span><span class=w> </span><span class=l>&lt;provider&gt;</span><span class=w>
</span><span class=w>      </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sweet-seed-backup</span><span class=w>
</span><span class=w>        </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span></code></pre></div><h2 id=deploy-the-gardenlet>Deploy the gardenlet</h2><blockquote><p>The gardenlet doesn’t have to run in the same Kubernetes cluster as the seed cluster
it’s registering and reconciling, but it is in most cases advantageous
to use in-cluster communication to talk to the Seed API server.
Running a gardenlet outside of the cluster is mostly used for local development.</p></blockquote><p>The <code>gardenlet-values.yaml</code> looks something like this
(with automatic Seed registration and backup for shoot clusters enabled):</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>global</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># Gardenlet configuration values</span><span class=w>
</span><span class=w>  </span><span class=nt>gardenlet</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=l>...</span><span class=w>
</span><span class=w>    </span><span class=l>&lt;default config&gt;</span><span class=w>
</span><span class=w>    </span><span class=l>...</span><span class=w>
</span><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>gardenClientConnection</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=l>...</span><span class=w>
</span><span class=w>        </span><span class=nt>bootstrapKubeconfig</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-bootstrap-kubeconfig</span><span class=w>
</span><span class=w>          </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>          </span><span class=nt>kubeconfig</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>            apiVersion: v1
</span><span class=sd>            clusters:
</span><span class=sd>            - cluster:
</span><span class=sd>                certificate-authority-data: &lt;dummy&gt;
</span><span class=sd>                server: &lt;my-garden-cluster-endpoint&gt;
</span><span class=sd>              name: my-kubernetes-cluster
</span><span class=sd>            ....</span><span class=w>            
</span><span class=w>
</span><span class=w>        </span><span class=nt>kubeconfigSecret</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-kubeconfig</span><span class=w>
</span><span class=w>          </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>      </span><span class=l>...</span><span class=w>
</span><span class=w>      </span><span class=l>&lt;default config&gt;</span><span class=w>
</span><span class=w>      </span><span class=l>...</span><span class=w>
</span><span class=w>      </span><span class=nt>seedConfig</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sweet-seed</span><span class=w>
</span><span class=w>        </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>ingressDomain</span><span class=p>:</span><span class=w> </span><span class=l>ingress.sweet-seed.&lt;my-domain&gt;</span><span class=w>
</span><span class=w>          </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>nodes</span><span class=p>:</span><span class=w> </span><span class=m>10.240.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>            </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=m>100.244.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>            </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=m>100.32.0.0</span><span class=l>/13</span><span class=w>
</span><span class=w>            </span><span class=nt>shootDefaults</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=m>100.96.0.0</span><span class=l>/11</span><span class=w>
</span><span class=w>              </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=m>100.64.0.0</span><span class=l>/13</span><span class=w>
</span><span class=w>          </span><span class=nt>provider</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>&lt;provider&gt;</span><span class=w>
</span><span class=w>          </span><span class=nt>backup</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>provider</span><span class=p>:</span><span class=w> </span><span class=l>&lt;provider&gt;</span><span class=w>
</span><span class=w>            </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sweet-seed-backup</span><span class=w>
</span><span class=w>              </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span></code></pre></div><p>Deploy the gardenlet Helm chart to the Kubernetes cluster.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>helm install gardenlet charts/gardener/gardenlet <span class=se>\
</span><span class=se></span>  --namespace garden <span class=se>\
</span><span class=se></span>  -f gardenlet-values.yaml <span class=se>\
</span><span class=se></span>  --wait
</code></pre></div><p>This helm chart creates:</p><ul><li>A service account <code>gardenlet</code> that the gardenlet can use to talk to the Seed API server.</li><li>RBAC roles for the service account (full admin rights at the moment).</li><li>The secret (<code>garden</code>/<code>gardenlet-bootstrap-kubeconfig</code>) containing the bootstrap <code>kubeconfig</code>.</li><li>The gardenlet deployment in the <code>garden</code> namespace.</li></ul><h2 id=check-that-the-gardenlet-is-successfully-deployed>Check that the gardenlet is successfully deployed</h2><ol><li><p>Check that the gardenlets certificate bootstrap was successful.</p><p>Check if the secret <code>gardenlet-kubeconfig</code> in the namespace <code>garden</code> in the seed cluster
is created and contains a <code>kubeconfig</code> with a valid certificate.</p><ol><li><p>Get the <code>kubeconfig</code> from the created secret.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ kubectl -n garden get secret gardenlet-kubeconfig -o json | jq -r .data.kubeconfig | base64 -d
</code></pre></div></li><li><p>Test against the garden cluster and verify it’s working.</p></li><li><p>Extract the <code>client-certificate-data</code> from the user <code>gardenlet</code>.</p></li><li><p>View the certificate:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ openssl x509 -in ./gardenlet-cert -noout -text
</code></pre></div><p>Check that the certificate is valid for a year (that is the lifetime of new certificates).</p></li></ol></li><li><p>Check that the bootstrap secret <code>gardenlet-bootstrap-kubeconfig</code> has been deleted from the seed cluster in namespace <code>garden</code>.</p></li><li><p>Check that the seed cluster is registered and <code>READY</code> in the garden cluster.</p><p>Check that the seed cluster <code>sweet-seed</code> exists and all conditions indicate that it’s available.
If so, the <a href=https://github.com/gardener/gardener/blob/master/docs/concepts/gardenlet.md#heartbeats>Gardenlet is sending regular heartbeats</a> and the <a href=/docs/gardener/usage/seed_bootstrapping>seed bootstrapping</a> was successful.</p><p>Check that the conditions on the <code>Seed</code> resource look similar to the following:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ kubectl get seed sweet-seed -o json <span class=p>|</span> jq .status.conditions
<span class=o>[</span>
  <span class=o>{</span>
    <span class=s2>&#34;lastTransitionTime&#34;</span>: <span class=s2>&#34;2020-07-17T09:17:29Z&#34;</span>,
    <span class=s2>&#34;lastUpdateTime&#34;</span>: <span class=s2>&#34;2020-07-17T09:17:29Z&#34;</span>,
    <span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Gardenlet is posting ready status.&#34;</span>,
    <span class=s2>&#34;reason&#34;</span>: <span class=s2>&#34;GardenletReady&#34;</span>,
    <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;True&#34;</span>,
    <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;GardenletReady&#34;</span>
  <span class=o>}</span>,
  <span class=o>{</span>
    <span class=s2>&#34;lastTransitionTime&#34;</span>: <span class=s2>&#34;2020-07-17T09:17:49Z&#34;</span>,
    <span class=s2>&#34;lastUpdateTime&#34;</span>: <span class=s2>&#34;2020-07-17T09:53:17Z&#34;</span>,
    <span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Seed cluster has been bootstrapped successfully.&#34;</span>,
    <span class=s2>&#34;reason&#34;</span>: <span class=s2>&#34;BootstrappingSucceeded&#34;</span>,
    <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;True&#34;</span>,
    <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;Bootstrapped&#34;</span>
  <span class=o>}</span>,
  <span class=o>{</span>
    <span class=s2>&#34;lastTransitionTime&#34;</span>: <span class=s2>&#34;2020-07-17T09:17:49Z&#34;</span>,
    <span class=s2>&#34;lastUpdateTime&#34;</span>: <span class=s2>&#34;2020-07-17T09:53:17Z&#34;</span>,
    <span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Backup Buckets are available.&#34;</span>,
    <span class=s2>&#34;reason&#34;</span>: <span class=s2>&#34;BackupBucketsAvailable&#34;</span>,
    <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;True&#34;</span>,
    <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;BackupBucketsReady&#34;</span>
  <span class=o>}</span>
<span class=o>]</span>
</code></pre></div></li></ol><h2 id=related-links>Related Links</h2><p><a href=https://github.com/gardener/gardener/issues/1724>Issue #1724: Harden Gardenlet RBAC privileges</a>.</p><p><a href=/docs/gardener/concepts/backup-restore>Backup and Restore</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c3272d62c1687598614ee78517d7640c>5 - Feature Gates</h1><h1 id=feature-gates-in-gardener>Feature Gates in Gardener</h1><p>This page contains an overview of the various feature gates an administrator can specify on different Gardener components.</p><h2 id=overview>Overview</h2><p>Feature gates are a set of key=value pairs that describe Gardener features. You can turn these features on or off using the a component configuration file for a specific component.</p><p>Each Gardener component lets you enable or disable a set of feature gates that are relevant to that component. For example this is the configuration of the <a href=https://github.com/gardener/gardener/blob/master/example/20-componentconfig-gardenlet.yaml>gardenlet</a> component.</p><p>The following tables are a summary of the feature gates that you can set on different Gardener components.</p><ul><li>The “Since” column contains the Gardener release when a feature is introduced or its release stage is changed.</li><li>The “Until” column, if not empty, contains the last Gardener release in which you can still use a feature gate.</li><li>If a feature is in the Alpha or Beta state, you can find the feature listed in the Alpha/Beta feature gate table.</li><li>If a feature is stable you can find all stages for that feature listed in the Graduated/Deprecated feature gate table.</li><li>The Graduated/Deprecated feature gate table also lists deprecated and withdrawn features.</li></ul><h2 id=feature-gates-for-alpha-or-beta-features>Feature gates for Alpha or Beta features</h2><table><thead><tr><th>Feature</th><th>Default</th><th>Stage</th><th>Since</th><th>Until</th></tr></thead><tbody><tr><td>Logging</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>0.13</code></td><td></td></tr><tr><td>HVPA</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>0.31</code></td><td></td></tr><tr><td>HVPAForShootedSeed</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>0.32</code></td><td></td></tr><tr><td>ManagedIstio</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.5</code></td><td><code>1.18</code></td></tr><tr><td>ManagedIstio</td><td><code>true</code></td><td><code>Beta</code></td><td><code>1.19</code></td><td></td></tr><tr><td>APIServerSNI</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.7</code></td><td><code>1.18</code></td></tr><tr><td>APIServerSNI</td><td><code>true</code></td><td><code>Beta</code></td><td><code>1.19</code></td><td></td></tr><tr><td>CachedRuntimeClients</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.7</code></td><td><code>1.33</code></td></tr><tr><td>CachedRuntimeClients</td><td><code>true</code></td><td><code>Beta</code></td><td><code>1.34</code></td><td></td></tr><tr><td>SeedChange</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.12</code></td><td></td></tr><tr><td>SeedKubeScheduler</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.15</code></td><td></td></tr><tr><td>ReversedVPN</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.22</code></td><td></td></tr><tr><td>AdminKubeconfigRequest</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.24</code></td><td></td></tr><tr><td>UseDNSRecords</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.27</code></td><td></td></tr><tr><td>DisallowKubeconfigRotationForShootInDeletion</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.28</code></td><td><code>1.31</code></td></tr><tr><td>DisallowKubeconfigRotationForShootInDeletion</td><td><code>true</code></td><td><code>Beta</code></td><td><code>1.32</code></td><td></td></tr><tr><td>RotateSSHKeypairOnMaintenance</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.28</code></td><td></td></tr><tr><td>DenyInvalidExtensionResources</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.31</code></td><td></td></tr></tbody></table><h2 id=feature-gates-for-graduated-or-deprecated-features>Feature gates for graduated or deprecated features</h2><table><thead><tr><th>Feature</th><th>Default</th><th>Stage</th><th>Since</th><th>Until</th></tr></thead><tbody><tr><td>NodeLocalDNS</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.7</code></td><td></td></tr><tr><td>NodeLocalDNS</td><td></td><td><code>Removed</code></td><td><code>1.26</code></td><td></td></tr><tr><td>KonnectivityTunnel</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.6</code></td><td></td></tr><tr><td>KonnectivityTunnel</td><td></td><td><code>Removed</code></td><td><code>1.27</code></td><td></td></tr><tr><td>MountHostCADirectories</td><td><code>false</code></td><td><code>Alpha</code></td><td><code>1.11</code></td><td><code>1.25</code></td></tr><tr><td>MountHostCADirectories</td><td><code>true</code></td><td><code>Beta</code></td><td><code>1.26</code></td><td><code>1.27</code></td></tr><tr><td>MountHostCADirectories</td><td><code>true</code></td><td><code>GA</code></td><td><code>1.27</code></td><td></td></tr><tr><td>MountHostCADirectories</td><td></td><td><code>Removed</code></td><td><code>1.30</code></td><td></td></tr></tbody></table><h2 id=using-a-feature>Using a feature</h2><p>A feature can be in <em>Alpha</em>, <em>Beta</em> or <em>GA</em> stage.
An <em>Alpha</em> feature means:</p><ul><li>Disabled by default.</li><li>Might be buggy. Enabling the feature may expose bugs.</li><li>Support for feature may be dropped at any time without notice.</li><li>The API may change in incompatible ways in a later software release without notice.</li><li>Recommended for use only in short-lived testing clusters, due to increased
risk of bugs and lack of long-term support.</li></ul><p>A <em>Beta</em> feature means:</p><ul><li>Enabled by default.</li><li>The feature is well tested. Enabling the feature is considered safe.</li><li>Support for the overall feature will not be dropped, though details may change.</li><li>The schema and/or semantics of objects may change in incompatible ways in a
subsequent beta or stable release. When this happens, we will provide instructions
for migrating to the next version. This may require deleting, editing, and
re-creating API objects. The editing process may require some thought.
This may require downtime for applications that rely on the feature.</li><li>Recommended for only non-critical uses because of potential for
incompatible changes in subsequent releases.</li></ul><blockquote><p>Please do try <em>Beta</em> features and give feedback on them!
After they exit beta, it may not be practical for us to make more changes.</p></blockquote><p>A <em>General Availability</em> (GA) feature is also referred to as a <em>stable</em> feature. It means:</p><ul><li>The feature is always enabled; you cannot disable it.</li><li>The corresponding feature gate is no longer needed.</li><li>Stable versions of features will appear in released software for many subsequent versions.</li></ul><h2 id=list-of-feature-gates>List of feature gates</h2><ul><li><code>Logging</code> enables logging stack for Seed clusters.</li><li><code>HVPA</code> enables simultaneous horizontal and vertical scaling in Seed Clusters.</li><li><code>HVPAForShootedSeed</code> enables simultaneous horizontal and vertical scaling in managed seed (aka &ldquo;shooted seed&rdquo;) clusters.</li><li><code>ManagedIstio</code> enables a Gardener-tailored <a href=https://istio.io>Istio</a> in each Seed cluster. Disable this feature if Istio is already installed in the cluster. Istio is not automatically removed if this feature is disabled. See the <a href=/docs/gardener/usage/istio>detailed documentation</a> for more information.</li><li><code>APIServerSNI</code> enables only one LoadBalancer to be used for every Shoot cluster API server in a Seed. Enable this feature when <code>ManagedIstio</code> is enabled or Istio is manually deployed in Seed cluster. See <a href=/docs/gardener/proposals/08-shoot-apiserver-via-sni>GEP-8</a> for more details.</li><li><code>MountHostCADirectories</code> enables mounting common CA certificate directories in the Shoot API server pod that might be required for webhooks or OIDC.</li><li><code>CachedRuntimeClients</code> enables a cache in the controller-runtime clients, that Gardener components use. If disabled all controller-runtime clients will directly talk to the API server instead of relying on a cache. The feature gate can be specified for gardenlet and gardener-controller-manager (and gardener-scheduler for the versions <code>&lt; 1.29</code>).</li><li><code>SeedChange</code> enables updating the <code>spec.seedName</code> field during shoot validation from a non-empty value in order to trigger shoot control plane migration.</li><li><code>SeedKubeScheduler</code> adds custom <code>kube-scheduler</code> in <code>gardener-kube-scheduler</code> namespace. It schedules <a href=https://github.com/gardener/gardener/blob/master/docs/concepts/seed-admission-controller.md#mutating-webhooks>pods with scheduler name</a> <code>gardener-kube-scheduler</code> on Nodes with higher resource utilization. It requires Seed cluster with kubernetes version <code>1.18</code> or higher.</li><li><code>ReversedVPN</code> reverses the connection setup of the vpn tunnel between the Seed and the Shoot cluster(s). It allows Seed and Shoot clusters to be in different networks with only direct access in one direction (Shoot -> Seed). In addition to that, it reduces the amount of load balancers required, i.e. no load balancers are required for the vpn tunnel anymore. It requires <code>APIServerSNI</code> and kubernetes version <code>1.18</code> or higher to work. Details can be found in <a href=/docs/gardener/proposals/14-reversed-cluster-vpn>GEP-14</a>.</li><li><code>AdminKubeconfigRequest</code> enables the <code>AdminKubeconfigRequest</code> endpoint on Shoot resources. See <a href=/docs/gardener/proposals/16-adminkubeconfig-subresource>GEP-16</a> for more details.</li><li><code>UseDNSRecords</code> enables using <code>DNSRecord</code> resources for Gardener DNS records instead of <code>DNSProvider</code>, <code>DNSEntry</code>, and <code>DNSOwner</code> resources. See <a href=/docs/gardener/extensions/dnsrecord>Contract: <code>DNSRecord</code> resources</a> for more details.</li><li><code>DisallowKubeconfigRotationForShootInDeletion</code> when enabled, does not allow kubeconfig rotation to be requested for shoot cluster that is already in deletion phase, i.e. <code>metadata.deletionTimestamp</code> is set.</li><li><code>RotateSSHKeypairOnMaintenance</code> enables SSH keypair rotation in the maintenance controller of the gardener-controller-manager. Details can be found in <a href=/docs/gardener/proposals/15-manage-bastions-and-ssh-key-pair-rotation>GEP-15</a>.</li><li><code>DenyInvalidExtensionResources</code> causes the <code>seed-admission-controller</code> to deny invalid extension resources, instead of just logging validation errors.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-9cfd104830b4bc8eafa2e90c3d9ff542>6 - Gardenlet Api Access</h1><h1 id=scoped-api-access-for-gardenlets>Scoped API Access for Gardenlets</h1><p>By default, <code>gardenlet</code>s have administrative access in the garden cluster.
They are able to execute any API request on any object independent of whether the object is related to the seed cluster the <code>gardenlet</code> is responsible fto.
As RBAC is not powerful enough for fine-grained checks and for the sake of security, Gardener provides two optional but recommended configurations for your environments that scope the API access for <code>gardenlet</code>s.</p><p>Similar to the <a href=https://kubernetes.io/docs/reference/access-authn-authz/node/><code>Node</code> authorization mode in Kubernetes</a>, Gardener features a <code>SeedAuthorizer</code> plugin.
It is a special-purpose authorization plugin that specifically authorizes API requests made by the <code>gardenlet</code>s.</p><p>Likewise, similar to the <a href=https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction><code>NodeRestriction</code> admission plugin in Kubernetes</a>, Gardener features a <code>SeedRestriction</code> plugin.
It is a special-purpose admission plugin that specifically limits the Kubernetes objects <code>gardenlet</code>s can modify.</p><p>📚 You might be interested to look into the <a href=https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/kubelet-authorizer.md>design proposal for scoped Kubelet API access</a> from the Kubernetes community.
It can be translated to Gardener and Gardenlets with their <code>Seed</code> and <code>Shoot</code> resources.</p><h2 id=flow-diagram>Flow Diagram</h2><p>The following diagram shows how the two plugins are included in the request flow of a <code>gardenlet</code>.
When they are not enabled then the <code>kube-apiserver</code> is internally authorizing the request via RBAC before forwarding the request directly to the <code>gardener-apiserver</code>, i.e., the <code>gardener-admission-controller</code> would not be consulted (this is not entirely correct because it also serves other admission webhook handlers, but for simplicity reasons this document focuses on the API access scope only).</p><p>When enabling the plugins, there is one additional step for each before the <code>gardener-apiserver</code> responds to the request.</p><p><img src=/__resources/gardenlet_api_access_flow_ba7867.png alt="Flow Diagram"></p><p>Please note that the example shows a request to an object (<code>Shoot</code>) residing in one of the API groups served by <code>gardener-apiserver</code>.
However, the <code>gardenlet</code> is also interacting with objects in API groups served by the <code>kube-apiserver</code> (e.g., <code>Secret</code>,<code>ConfigMap</code>, etc.).
In this case, the consultation of the <code>SeedRestriction</code> admission plugin is performed by the <code>kube-apiserver</code> itself before it forwards the request to the <code>gardener-apiserver</code>.</p><p>Today, the following rules are implemented:</p><table><thead><tr><th>Resource</th><th>Verbs</th><th>Path(s)</th><th>Description</th></tr></thead><tbody><tr><td><code>BackupBucket</code></td><td><code>get</code>, <code>list</code>, <code>watch</code>, <code>create</code>, <code>update</code>, <code>patch</code>, <code>delete</code></td><td><code>BackupBucket</code> -> <code>Seed</code></td><td>Allow <code>get</code>, <code>list</code>, <code>watch</code> requests for all <code>BackupBucket</code>s. Allow only <code>create</code>, <code>update</code>, <code>patch</code>, <code>delete</code> requests for <code>BackupBucket</code>s assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code>.</td></tr><tr><td><code>BackupEntry</code></td><td><code>get</code>, <code>list</code>, <code>watch</code>, <code>create</code>, <code>update</code>, <code>patch</code></td><td><code>BackupEntry</code> -> <code>Seed</code></td><td>Allow <code>get</code>, <code>list</code>, <code>watch</code> requests for all <code>BackupEntry</code>s. Allow only <code>create</code>, <code>update</code>, <code>patch</code> requests for <code>BackupEntry</code>s assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code> and referencing <code>BackupBucket</code>s assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code>.</td></tr><tr><td><code>Bastion</code></td><td><code>get</code>, <code>list</code>, <code>watch</code>, <code>create</code>, <code>update</code>, <code>patch</code></td><td><code>Bastion</code> -> <code>Seed</code></td><td>Allow <code>get</code>, <code>list</code>, <code>watch</code> requests for all <code>Bastion</code>s. Allow only <code>create</code>, <code>update</code>, <code>patch</code> requests for <code>Bastion</code>s assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code>.</td></tr><tr><td><code>CertificateSigningRequest</code></td><td><code>get</code>, <code>create</code></td><td><code>CertificateSigningRequest</code> -> <code>Seed</code></td><td>Allow only <code>get</code>, <code>create</code> requests for <code>CertificateSigningRequest</code>s related to the <code>gardenlet</code>&rsquo;s <code>Seed</code>.</td></tr><tr><td><code>CloudProfile</code></td><td><code>get</code></td><td><code>CloudProfile</code> -> <code>Shoot</code> -> <code>Seed</code></td><td>Allow only <code>get</code> requests for <code>CloudProfile</code>s referenced by <code>Shoot</code>s that are assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code>.</td></tr><tr><td><code>ClusterRoleBinding</code></td><td><code>create</code>, <code>get</code>, <code>update</code>, <code>patch</code>, <code>delete</code></td><td><code>ClusterRoleBinding</code> -> <code>ManagedSeed</code> -> <code>Shoot</code> -> <code>Seed</code></td><td>Allow <code>create</code>, <code>get</code>, <code>update</code>, <code>patch</code> requests for <code>ManagedSeed</code>s in the bootstrapping phase assigned to the gardenlet&rsquo;s <code>Seed</code>s. Allow <code>delete</code> requests from gardenlets bootstrapped via <code>ManagedSeed</code>s.</td></tr><tr><td><code>ConfigMap</code></td><td><code>get</code></td><td><code>ConfigMap</code> -> <code>Shoot</code> -> <code>Seed</code></td><td>Allow only <code>get</code> requests for <code>ConfigMap</code>s referenced by <code>Shoot</code>s that are assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code>. Allows reading the <code>kube-system/cluster-identity</code> <code>ConfigMap</code>.</td></tr><tr><td><code>ControllerRegistration</code></td><td><code>get</code>, <code>list</code>, <code>watch</code></td><td><code>ControllerRegistration</code> -> <code>ControllerInstallation</code> -> <code>Seed</code></td><td>Allow <code>get</code>, <code>list</code>, <code>watch</code> requests for all <code>ControllerRegistration</code>s.</td></tr><tr><td><code>ControllerDeployment</code></td><td><code>get</code></td><td><code>ControllerDeployment</code> -> <code>ControllerInstallation</code> -> <code>Seed</code></td><td>Allow <code>get</code> requests for <code>ControllerDeployments</code>s referenced by <code>ControllerInstallation</code>s assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code>.</td></tr><tr><td><code>ControllerInstallation</code></td><td><code>get</code>, <code>list</code>, <code>watch</code>, <code>update</code>, <code>patch</code></td><td><code>ControllerInstallation</code> -> <code>Seed</code></td><td>Allow <code>get</code>, <code>list</code>, <code>watch</code> requests for all <code>ControllerInstallation</code>s. Allow only <code>update</code>, <code>patch</code> requests for <code>ControllerInstallation</code>s assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code>.</td></tr><tr><td><code>Event</code></td><td><code>create</code>, <code>patch</code></td><td>none</td><td>Allow to <code>create</code> or <code>patch</code> all kinds of <code>Event</code>s.</td></tr><tr><td><code>ExposureClass</code></td><td><code>get</code></td><td><code>ExposureClass</code> -> <code>Shoot</code> -> <code>Seed</code></td><td>Allow <code>get</code> requests for <code>ExposureClass</code>es referenced by <code>Shoot</code>s that are assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code>. Deny <code>get</code> requests to other <code>ExposureClass</code>es.</td></tr><tr><td><code>Lease</code></td><td><code>create</code>, <code>get</code>, <code>watch</code>, <code>update</code></td><td><code>Lease</code> -> <code>Seed</code></td><td>Allow <code>create</code>, <code>get</code>, <code>update</code>, and <code>delete</code> requests for <code>Lease</code>s of the <code>gardenlet</code>&rsquo;s <code>Seed</code>.</td></tr><tr><td><code>ManagedSeed</code></td><td><code>get</code>, <code>list</code>, <code>watch</code>, <code>update</code>, <code>patch</code></td><td><code>ManagedSeed</code> -> <code>Shoot</code> -> <code>Seed</code></td><td>Allow <code>get</code>, <code>list</code>, <code>watch</code> requests for all <code>ManagedSeed</code>s. Allow only <code>update</code>, <code>patch</code> requests for <code>ManagedSeed</code>s referencing a <code>Shoot</code> assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code>.</td></tr><tr><td><code>Namespace</code></td><td><code>get</code></td><td><code>Namespace</code> -> <code>Shoot</code> -> <code>Seed</code></td><td>Allow <code>get</code> requests for <code>Namespace</code>s of <code>Shoot</code>s that are assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code>. Always allow <code>get</code> requests for the <code>garden</code> <code>Namespace</code>.</td></tr><tr><td><code>Project</code></td><td><code>get</code></td><td><code>Project</code> -> <code>Namespace</code> -> <code>Shoot</code> -> <code>Seed</code></td><td>Allow <code>get</code> requests for <code>Project</code>s referenced by the <code>Namespace</code> of <code>Shoot</code>s that are assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code>.</td></tr><tr><td><code>SecretBinding</code></td><td><code>get</code></td><td><code>SecretBinding</code> -> <code>Shoot</code> -> <code>Seed</code></td><td>Allow only <code>get</code> requests for <code>SecretBinding</code>s referenced by <code>Shoot</code>s that are assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code>.</td></tr><tr><td><code>Secret</code></td><td><code>create</code>, <code>get</code>, <code>update</code>, <code>patch</code>, <code>delete</code>(, <code>list</code>, <code>watch</code>)</td><td><code>Secret</code> -> <code>Seed</code>, <code>Secret</code> -> <code>Shoot</code> -> <code>Seed</code>, <code>Secret</code> -> <code>SecretBinding</code> -> <code>Shoot</code> -> <code>Seed</code>, <code>BackupBucket</code> -> <code>Seed</code></td><td>Allow <code>get</code>, <code>list</code>, <code>watch</code> requests for all <code>Secret</code>s in the <code>seed-&lt;name></code> namespace. Allow only <code>create</code>, <code>get</code>, <code>update</code>, <code>patch</code>, <code>delete</code> requests for the <code>Secret</code>s related to resources assigned to the gardenlet<code>'s </code>Seed`s.</td></tr><tr><td><code>Seed</code></td><td><code>get</code>, <code>list</code>, <code>watch</code>, <code>create</code>, <code>update</code>, <code>patch</code>, <code>delete</code></td><td><code>Seed</code></td><td>Allow <code>get</code>, <code>list</code>, <code>watch</code> requests for all <code>Seed</code>s. Allow only <code>create</code>, <code>update</code>, <code>patch</code>, <code>delete</code> requests for the <code>gardenlet</code>&rsquo;s <code>Seed</code>s. [1]</td></tr><tr><td><code>ServiceAccount</code></td><td><code>create</code>, <code>get</code>, <code>update</code>, <code>patch</code>, <code>delete</code></td><td><code>ServiceAccount</code> -> <code>ManagedSeed</code> -> <code>Shoot</code> -> <code>Seed</code></td><td>Allow <code>create</code>, <code>get</code>, <code>update</code>, <code>patch</code> requests for <code>ManagedSeed</code>s in the bootstrapping phase assigned to the gardenlet&rsquo;s <code>Seed</code>s. Allow <code>delete</code> requests from gardenlets bootstrapped via <code>ManagedSeed</code>s.</td></tr><tr><td><code>Shoot</code></td><td><code>get</code>, <code>list</code>, <code>watch</code>, <code>update</code>, <code>patch</code></td><td><code>Shoot</code> -> <code>Seed</code></td><td>Allow <code>get</code>, <code>list</code>, <code>watch</code> requests for all <code>Shoot</code>s. Allow only <code>update</code>, <code>patch</code> requests for <code>Shoot</code>s assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code>.</td></tr><tr><td><code>ShootState</code></td><td><code>get</code>, <code>create</code>, <code>update</code>, <code>patch</code></td><td><code>ShootState</code> -> <code>Shoot</code> -> <code>Seed</code></td><td>Allow only <code>get</code>, <code>create</code>, <code>update</code>, <code>patch</code> requests for <code>ShootState</code>s belonging by <code>Shoot</code>s that are assigned to the <code>gardenlet</code>&rsquo;s <code>Seed</code>.</td></tr></tbody></table><p>[1] If you use <code>ManagedSeed</code> resources then the gardenlet reconciling them (&ldquo;parent gardenlet&rdquo;) may be allowed to submit certain requests for the <code>Seed</code> resources resulting out of such <code>ManagedSeed</code> reconciliations (even if the &ldquo;parent gardenlet&rdquo; is not responsible for them):</p><ul><li>ℹ️ It is allowed to delete the <code>Seed</code> resources if the corresponding <code>ManagedSeed</code> objects already have a <code>deletionTimestamp</code> (this is secure as gardenlets themselves don&rsquo;t have permissions for deleting <code>ManagedSeed</code>s).</li><li>⚠ It is allowed to create or update <code>Seed</code> resources if the corresponding <code>ManagedSeed</code> objects use a seed template, i.e., <code>.spec.seedTemplate != nil</code>. In this case, there is at least one gardenlet in your system which is responsible for two or more <code>Seed</code>s. Please keep in mind that this use case is not recommended for production scenarios (you should only have one dedicated gardenlet per seed cluster), hence, the security improvements discussed in this document might be limited.</li></ul><h2 id=seedauthorizer-authorization-webhook-enablement><code>SeedAuthorizer</code> Authorization Webhook Enablement</h2><p>The <code>SeedAuthorizer</code> is implemented as <a href=https://kubernetes.io/docs/reference/access-authn-authz/webhook/>Kubernetes authorization webhook</a> and part of the <a href=../concepts/admission-controller.md><code>gardener-admission-controller</code></a> component running in the garden cluster.</p><p>🎛 In order to activate it, you have to follow these steps:</p><ol><li><p>Set the following flags for the <code>kube-apiserver</code> of the garden cluster (i.e., the <code>kube-apiserver</code> whose API is extended by Gardener):</p><ul><li><code>--authorization-mode=RBAC,Node,Webhook</code> (please note that <code>Webhook</code> should appear after <code>RBAC</code> in the list [1]; <code>Node</code> might not be needed if you use a virtual garden cluster)</li><li><code>--authorization-webhook-config-file=&lt;path-to-the-webhook-config-file></code></li><li><code>--authorization-webhook-cache-authorized-ttl=0</code></li><li><code>--authorization-webhook-cache-unauthorized-ttl=0</code></li></ul></li><li><p>The webhook config file (stored at <code>&lt;path-to-the-webhook-config-file></code>) should look as follows:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>  </span><span class=nt>cluster</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>certificate-authority-data</span><span class=p>:</span><span class=w> </span><span class=l>base64(CA-CERT-OF-GARDENER-ADMISSION-CONTROLLER)</span><span class=w>
</span><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://gardener-admission-controller.garden/webhooks/auth/seed</span><span class=w>
</span><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-apiserver</span><span class=w>
</span><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>auth-webhook</span><span class=w>
</span><span class=w>  </span><span class=nt>context</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>kube-apiserver</span><span class=w>
</span><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>auth-webhook</span><span class=w>
</span></code></pre></div></li><li><p>When deploying the <a href=../../charts/gardener/controlplane>Gardener <code>controlplane</code> Helm chart</a>, set <code>.global.rbac.seedAuthorizer.enabled=true</code>. This will prevent that the RBAC resources granting global access for all gardenlets will be deployed.</p></li><li><p>Delete the existing RBAC resources granting global access for all gardenlets by running:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl delete <span class=se>\
</span><span class=se></span>  clusterrole.rbac.authorization.k8s.io/gardener.cloud:system:seeds <span class=se>\
</span><span class=se></span>  clusterrolebinding.rbac.authorization.k8s.io/gardener.cloud:system:seeds <span class=se>\
</span><span class=se></span>  --ignore-not-found
</code></pre></div></li></ol><p>Please note that you should activate the <a href=#seedrestriction-admission-webhook-enablement><code>SeedRestriction</code></a> admission handler as well.</p><blockquote><p>[1] The reason for the fact that <code>Webhook</code> authorization plugin should appear after <code>RBAC</code> is that the <code>kube-apiserver</code> will be depending on the <code>gardener-admission-controller</code> (serving the webhook). However, the <code>gardener-admission-controller</code> can only start when <code>gardener-apiserver</code> runs, but <code>gardener-apiserver</code> itself can only start when <code>kube-apiserver</code> runs. If <code>Webhook</code> is before <code>RBAC</code> then <code>gardener-apiserver</code> might not be able to start, leading to a deadlock.</p></blockquote><h3 id=authorizer-decisions>Authorizer Decisions</h3><p>As mentioned earlier, it&rsquo;s the authorizer&rsquo;s job to evaluate API requests and return one of the following decisions:</p><ul><li><code>DecisionAllow</code>: The request is allowed, further configured authorizers won&rsquo;t be consulted.</li><li><code>DecisionDeny</code>: The request is denied, further configured authorizers won&rsquo;t be consulted.</li><li><code>DecisionNoOpinion</code>: A decision cannot be made, further configured authorizers will be consulted.</li></ul><p>For backwards compatibility, no requests are denied at the moment, so that an ambiguous request is still deferred to a subsequent authorizer like RBAC.</p><p>First, the <code>SeedAuthorizer</code> extracts the <code>Seed</code> name from the API request. This requires a proper TLS certificate the <code>gardenlet</code> uses to contact the API server and is automatically given if <a href=../concepts/gardenlet.md#TLS-Bootstrapping>TLS bootstrapping</a> is used.
Concretely, the authorizer checks the certificate for name <code>gardener.cloud:system:seed:&lt;seed-name></code> and group <code>gardener.cloud:system:seeds</code>.
In cases this information is missing e.g., when a custom Kubeconfig is used, the authorizer cannot make any decision.
Likewise, if <code>gardenlet</code> is responsible for more than one <code>Seed</code>, the name in the mentioned TLS certificate is <code>gardener.cloud:system:seed:&lt;ambiguous></code> and a definite decision cannot be made as well.
The authorizer immediately returns with <code>DecisionNoOpinion</code> for all ambiguous cases which means that the request is neither allowed nor denied and further configured authorizers (e.g. RBAC) will be contacted.
Thus, RBAC is still a considerable option to restrict the <code>gardenlet</code>&rsquo;s access permission if the above explained preconditions are not given.</p><p>With the <code>Seed</code> name at hand, the authorizer checks for an <strong>existing path</strong> from the resource that a request is being made for to the <code>Seed</code> belonging to the <code>gardenlet</code>. Take a look at the <a href=#implementation-details>Implementation Details</a> section for more information.</p><h3 id=implementation-details>Implementation Details</h3><p>Internally, the <code>SeedAuthorizer</code> uses a directed, acyclic graph data structure in order to efficiently respond to authorization requests for gardenlets:</p><ul><li>A vertex in this graph represents a Kubernetes resource with its kind, namespace, and name (e.g., <code>Shoot:garden-my-project/my-shoot</code>).</li><li>An edge from vertex <code>u</code> to vertex <code>v</code> in this graph exists when<ul><li>(1) <code>v</code> is referred by <code>u</code> and <code>v</code> is a <code>Seed</code>, or when</li><li>(2) <code>u</code> is referred by <code>v</code>, or when</li><li>(3) <code>u</code> is strictly associated with <code>v</code>.</li></ul></li></ul><p>For example, a <code>Shoot</code> refers to a <code>Seed</code>, a <code>CloudProfile</code>, a <code>SecretBinding</code>, etc., so it has an outgoing edge to the <code>Seed</code> (1) and incoming edges from the <code>CloudProfile</code> and <code>SecretBinding</code> vertices (2).
However, there might also be a <code>ShootState</code> or a <code>BackupEntry</code> resource strictly associated with this <code>Shoot</code>, hence, it has incoming edges from these vertices (3).</p><p><img src=gardenlet_api_access_graph.png alt="Resource Dependency Graph"></p><p>In above picture the resources that are actively watched have are shaded.
Gardener resources are green while Kubernetes resources are blue.
It shows the dependencies between the resources and how the graph is built based on above rules.</p><p>ℹ️ Above picture shows all resources that may be accessed by <code>gardenlet</code>s, except for the <code>Quota</code> resource which is only included for completeness.</p><p>Now, when a <code>gardenlet</code> wants to access certain resources then the <code>SeedAuthorizer</code> uses a Depth-First traversal starting from the vertex representing the resource in question, e.g., from a <code>Project</code> vertex.
If there is a path from the <code>Project</code> vertex to the vertex representing the <code>Seed</code> the gardenlet is responsible for then it allows the request.</p><h4 id=metrics>Metrics</h4><p>The <code>SeedAuthorizer</code> registers the following metrics related to the mentioned graph implementation:</p><table><thead><tr><th>Metric</th><th>Description</th></tr></thead><tbody><tr><td><code>gardener_admission_controller_seed_authorizer_graph_update_duration_seconds</code></td><td>Histogram of duration of resource dependency graph updates in seed authorizer, i.e., how long does it take to update the graph&rsquo;s vertices/edges when a resource is created, changed, or deleted.</td></tr><tr><td><code>gardener_admission_controller_seed_authorizer_graph_path_check_duration_seconds</code></td><td>Histogram of duration of checks whether a path exists in the resource dependency graph in seed authorizer.</td></tr></tbody></table><h4 id=debug-handler>Debug Handler</h4><p>When the <code>.server.enableDebugHandlers</code> field in the <code>gardener-admission-controller</code>&rsquo;s component configuration is set to <code>true</code> then it serves a handler that can be used for debugging the resource dependency graph under <code>/debug/resource-dependency-graph</code>.</p><p>🚨 Only use this setting for development purposes as it enables unauthenticated users to view all data if they have access to the <code>gardener-admission-controller</code> component.</p><p>The handler renders an HTML page displaying the current graph with a list of vertices and its associated incoming and outgoing edges to other vertices.
Depending on the size of the Gardener landscape (and consequently, the size of the graph), it might not be possible to render it in its entirety.
If there are more than 2000 vertices then the default filtering will selected for <code>kind=Seed</code> to prevent overloading the output.</p><p><em>Example output</em>:</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>-------------------------------------------------------------------------------
|
| # Seed:my-seed
|   &lt;- (11)
|     BackupBucket:73972fe2-3d7e-4f61-a406-b8f9e670e6b7
|     BackupEntry:garden-my-project/shoot--dev--my-shoot--4656a460-1a69-4f00-9372-7452cbd38ee3
|     ControllerInstallation:dns-external-mxt8m
|     ControllerInstallation:extension-shoot-cert-service-4qw5j
|     ControllerInstallation:networking-calico-bgrb2
|     ControllerInstallation:os-gardenlinux-qvb5z
|     ControllerInstallation:provider-gcp-w4mvf
|     Secret:garden/backup
|     Shoot:garden-my-project/my-shoot
|
-------------------------------------------------------------------------------
|
| # Shoot:garden-my-project/my-shoot
|   &lt;- (5)
|     CloudProfile:gcp
|     Namespace:garden-my-project
|     Secret:garden-my-project/my-dns-secret
|     SecretBinding:garden-my-project/my-credentials
|     ShootState:garden-my-project/my-shoot
|   -&gt; (1)
|     Seed:my-seed
|
-------------------------------------------------------------------------------
|
| # ShootState:garden-my-project/my-shoot
|   -&gt; (1)
|     Shoot:garden-my-project/my-shoot
|
-------------------------------------------------------------------------------

... (etc., similarly for the other resources)
</code></pre></div><p>There are anchor links to easily jump from one resource to another, and the page provides means for filtering the results based on the <code>kind</code>, <code>namespace</code>, and/or <code>name</code>.</p><h4 id=pitfalls>Pitfalls</h4><p>When there is a relevant update to an existing resource, i.e., when a reference to another resource is changed, then the corresponding vertex (along with all associated edges) is first deleted from the graph before it gets added again with the up-to-date edges.
However, this does only work for vertices belonging to resources that are only created in exactly one &ldquo;watch handler&rdquo;.
For example, the vertex for a <code>SecretBinding</code> can either be created in the <code>SecretBinding</code> handler itself or in the <code>Shoot</code> handler.
In such cases, deleting the vertex before (re-)computing the edges might lead to race conditions and potentially renders the graph invalid.
Consequently, instead of deleting the vertex, only the edges the respective handler is responsible for are deleted.
If the vertex ends up with no remaining edges then it also gets deleted automatically.
Afterwards, the vertex can either be added again or the updated edges can be created.</p><h2 id=seedrestriction-admission-webhook-enablement><code>SeedRestriction</code> Admission Webhook Enablement</h2><p>The <code>SeedRestriction</code> is implemented as <a href=https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/>Kubernetes admission webhook</a> and part of the <a href=../concepts/admission-controller.md><code>gardener-admission-controller</code></a> component running in the garden cluster.</p><p>🎛 In order to activate it, you have to set <code>.global.admission.seedRestriction.enabled=true</code> when using the <a href=../../charts/gardener/controlplane>Gardener <code>controlplane</code> Helm chart</a>.
This will add an additional webhook in the existing <code>ValidatingWebhookConfiguration</code> of the <code>gardener-admission-controller</code> which contains the configuration for the <code>SeedRestriction</code> handler.
Please note that it should only be activated when the <code>SeedAuthorizer</code> is active as well.</p><h3 id=admission-decisions>Admission Decisions</h3><p>The admission&rsquo;s purpose is to perform extended validation on requests which require the body of the object in question.
Additionally, it handles <code>CREATE</code> requests of gardenlets (above discussed resource dependency graph cannot be used in such cases because there won&rsquo;t be any vertex/edge for non-existing resources).</p><p>Gardenlets are restricted to only create new resources which are somehow related to the seed clusters they are responsible for.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5a53ffb401b7a9ba7d6243e70af0be09>7 - Image Vector</h1><h1 id=image-vector>Image Vector</h1><p>The Gardenlet is deploying several different container images into the seed and the shoot clusters.
The image repositories and tags are defined in a <a href=https://github.com/gardener/gardener/blob/master/charts/images.yaml>central image vector file</a>.
Obviously, the image versions defined there must fit together with the deployment manifests (e.g., some command-line flags do only exist in certain versions).</p><h2 id=example>Example</h2><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>images</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pause-container</span><span class=w>
</span><span class=w>  </span><span class=nt>sourceRepository</span><span class=p>:</span><span class=w> </span><span class=l>github.com/kubernetes/kubernetes/blob/master/build/pause/Dockerfile</span><span class=w>
</span><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/google_containers/pause-amd64</span><span class=w>
</span><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.0&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.15</span><span class=l>.x</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pause-container</span><span class=w>
</span><span class=w>  </span><span class=nt>sourceRepository</span><span class=p>:</span><span class=w> </span><span class=l>github.com/kubernetes/kubernetes/blob/master/build/pause/Dockerfile</span><span class=w>
</span><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/google_containers/pause-amd64</span><span class=w>
</span><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.1&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&gt;= 1.16&#34;</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>That means that the Gardenlet will use the <code>pause-container</code> in with tag <code>3.0</code> for all seed/shoot clusters with Kubernetes version <code>1.15.x</code>, and tag <code>3.1</code> for all clusters with Kubernetes <code>>= 1.16</code>.</p><h2 id=overwrite-image-vector>Overwrite image vector</h2><p>In some environment it is not possible to use these &ldquo;pre-defined&rdquo; images that come with a Gardener release.
A prominent example for that is Alicloud in China which does not allow access to Google&rsquo;s GCR.
In these cases you might want to overwrite certain images, e.g., point the <code>pause-container</code> to a different registry.</p><p>:warning: If you specify an image that does not fit to the resource manifest then the seed/shoot reconciliation might fail.</p><p>In order to overwrite the images you must provide a similar file to Gardenlet:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>images</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pause-container</span><span class=w>
</span><span class=w>  </span><span class=nt>sourceRepository</span><span class=p>:</span><span class=w> </span><span class=l>github.com/kubernetes/kubernetes/blob/master/build/pause/Dockerfile</span><span class=w>
</span><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>my-custom-image-registry/pause-amd64</span><span class=w>
</span><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.0&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.15</span><span class=l>.x</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pause-container</span><span class=w>
</span><span class=w>  </span><span class=nt>sourceRepository</span><span class=p>:</span><span class=w> </span><span class=l>github.com/kubernetes/kubernetes/blob/master/build/pause/Dockerfile</span><span class=w>
</span><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>my-custom-image-registry/pause-amd64</span><span class=w>
</span><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.1&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&gt;= 1.16&#34;</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>During deployment of the gardenlet create a <code>ConfigMap</code> containing the above content and mount it as a volume into the gardenlet pod.
Next, specify the environment variable <code>IMAGEVECTOR_OVERWRITE</code> whose value must be the path to the file you just mounted:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-images-overwrite</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>images_overwrite.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    images:
</span><span class=sd>    - ...</span><span class=w>    
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>garden</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=l>...</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet</span><span class=w>
</span><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>IMAGEVECTOR_OVERWRITE</span><span class=w>
</span><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>/charts-overwrite/images_overwrite.yaml</span><span class=w>
</span><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-images-overwrite</span><span class=w>
</span><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/charts-overwrite</span><span class=w>
</span><span class=w>        </span><span class=l>...</span><span class=w>
</span><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-images-overwrite</span><span class=w>
</span><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gardenlet-images-overwrite</span><span class=w>
</span><span class=w>  </span><span class=l>...</span><span class=w>
</span></code></pre></div><h2 id=image-vectors-for-dependent-components>Image vectors for dependent components</h2><p>The gardenlet is deploying a lot of different components that might deploy other images themselves.
These components might use an image vector as well.
Operators might want to customize the image locations for these transitive images as well, hence, they might need to specify an image vector overwrite for the components directly deployed by Gardener.</p><p>It is possible to specify the <code>IMAGEVECTOR_OVERWRITE_COMPONENTS</code> environment variable to the gardenlet that points to a file with the following content:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>components</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>etcd-druid</span><span class=w>
</span><span class=w>  </span><span class=nt>imageVectorOverwrite</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    images:
</span><span class=sd>    - name: etcd
</span><span class=sd>      tag: v1.2.3
</span><span class=sd>      repository: etcd/etcd</span><span class=w>    
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><p>The gardenlet will, if supported by the directly deployed component (<code>etcd-druid</code> in this example), inject the given <code>imageVectorOverwrite</code> into the <code>Deployment</code> manifest.
The respective component is responsible for using the overwritten images instead of its defaults.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d48433bb7b23a8ada3fb3a2f6c8674f1>8 - Migration V0 To V1</h1><h1 id=migration-from-gardener-v0-to-v1>Migration from Gardener <code>v0</code> to <code>v1</code></h1><p>Please refer to the <a href=https://github.com/gardener/gardener/blob/v1.10.1/docs/deployment/migration_v0_to_v1.md>document for older Gardener versions</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-83f23df3bdd8e7e5f8233751ed6600f6>9 - Setup Gardener</h1><h1 id=deploying-the-gardener-into-a-kubernetes-cluster>Deploying the Gardener into a Kubernetes cluster</h1><p>Similar to Kubernetes, Gardener consists out of control plane components (Gardener API server, Gardener controller manager, Gardener scheduler), and an agent component (Gardenlet).
The control plane is deployed in the so-called garden cluster while the agent is installed into every seed cluster.
Please note that it is possible to use the garden cluster as seed cluster by simply deploying the Gardenlet into it.</p><p>We are providing <a href=https://github.com/gardener/gardener/tree/master/charts/gardener>Helm charts</a> in order to manage the various resources of the components.
Please always make sure that you use the Helm chart version that matches the Gardener version you want to deploy.</p><h2 id=deploying-the-gardener-control-plane-api-server-admission-controller-controller-manager-scheduler>Deploying the Gardener control plane (API server, admission controller, controller manager, scheduler)</h2><p>The <a href=https://github.com/gardener/gardener/blob/master/charts/gardener/controlplane/values.yaml>configuration values</a> depict the various options to configure the different components.
Please consult <a href=/docs/gardener/usage/configuration>this document</a> to get a detailed explanation of what can be configured for which component.</p><p>Also note that all resources and deployments need to be created in the <code>garden</code> namespace (not overrideable).
If you enable the Gardener admission controller as part of you setup, please make sure the <code>garden</code> namespace is labelled with <code>app: gardener</code>.
Otherwise, the backing service account for the admission controller Pod might not be created successfully.
No action is necessary, if you deploy the <code>garden</code> namespace with the Gardener control plane Helm chart.</p><p>After preparing your values in a separate <code>controlplane-values.yaml</code> file (<a href=https://github.com/gardener/gardener/blob/master/charts/gardener/controlplane/values.yaml>values.yaml</a> can be used as starting point), you can run the following command against your garden cluster:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>helm install charts/gardener/controlplane <span class=se>\
</span><span class=se></span>  --namespace garden <span class=se>\
</span><span class=se></span>  --name gardener-controlplane <span class=se>\
</span><span class=se></span>  -f controlplane-values.yaml <span class=se>\
</span><span class=se></span>  --wait
</code></pre></div><h2 id=deploying-gardener-extensions>Deploying Gardener extensions</h2><p>Gardener is an extensible system that does not contain the logic for provider-specific things like DNS management, cloud infrastructures, network plugins, operating system configs, and many more.</p><p>You have to install extension controllers for these parts.
Please consult <a href=/docs/gardener/extensions/overview>the documentation regarding extensions</a> to get more information.</p><h2 id=deploying-the-gardener-agent-gardenlet>Deploying the Gardener agent (Gardenlet)</h2><p>Please refer to <a href=/docs/gardener/deployment/deploy_gardenlet>this document</a> on how to deploy a Gardenlet.</p></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=/blog/>Blogs</a></li><li><a href=/community/>Community</a></li><li><a href=/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2021 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script></body></html>