<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=https://gardener.cloud/docs/extensions/infrastructure-extensions/gardener-extension-provider-kubevirt/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/extensions/infrastructure-extensions/gardener-extension-provider-kubevirt/index.xml><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=icon type=image/x-icon href=https://gardener.cloud/images/favicon.ico><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-16x16.png sizes=16x16><title>Provider KubeVirt | Gardener</title><meta name=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:title" content="Provider KubeVirt"><meta property="og:description" content="Gardener Extension Provider for KubeVirt"><meta property="og:type" content="website"><meta property="og:url" content="https://gardener.cloud/docs/extensions/infrastructure-extensions/gardener-extension-provider-kubevirt/"><meta itemprop=name content="Provider KubeVirt"><meta itemprop=description content="Gardener Extension Provider for KubeVirt"><meta name=twitter:card content="summary"><meta name=twitter:title content="Provider KubeVirt"><meta name=twitter:description content="Gardener Extension Provider for KubeVirt"><link rel=preload href=/scss/main.min.ca2e9ddee7809848b536632b41e4e4df665800778ffe11b75edde5bdd6c78963.css as=style><link href=/scss/main.min.ca2e9ddee7809848b536632b41e4e4df665800778ffe11b75edde5bdd6c78963.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.2035d9813dafac83fe2a48b18d50f237.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-kubevirt/>Return to the regular view of this page</a>.</p></div><h1 class=title>Provider KubeVirt</h1><div class=lead>Gardener Extension Provider for KubeVirt</div><div class=content><h1 id=gardener-extension-for-kubevirt-providerhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for KubeVirt provider</a></h1><p><a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-provider-kubevirt-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-provider-kubevirt-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-provider-kubevirt><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-provider-kubevirt alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=/docs/gardener/proposals/01-extensibility/>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This extension implements Gardener&rsquo;s extension contract for the <a href=https://kubevirt.io>KubeVirt</a> provider.
It includes KubeVirt-specific controllers for <code>Infrastructure</code>, <code>ControlPlane</code>, and <code>Worker</code> resources, as well as KubeVirt-specific control plane webhooks.
Unlike other provider extensions, it does not include controllers for <code>BackupBucket</code> and <code>BackupEntry</code> resources, since KubeVirt as technology is not concerned with backup storage.
Use the Gardener extension for your respective cloud provider to backup and restore your ETCD data.
On OpenShift clusters, use <a href=https://github.com/gardener/gardener-extension-provider-openshift>Gardener extension for OpenShift provider</a>.</p><p>For more information about Gardener integration with KubeVirt see <a href=https://gardener.cloud/blog/2020-10/00/gardener-integrates-with-kubevirt/>this gardener.cloud blog post</a>.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register the controllers of this extension with Gardener can be found <a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=/docs/gardener/proposals/01-extensibility/>here</a>.</p><h2 id=supported-kubernetes-versions>Supported Kubernetes versions</h2><p>This extension supports the following Kubernetes versions:</p><table><thead><tr><th>Version</th><th>Support</th><th>Conformance test results</th></tr></thead><tbody><tr><td>Kubernetes 1.19</td><td>not tested</td><td>N/A</td></tr><tr><td>Kubernetes 1.18</td><td>1.18.0+</td><td>N/A</td></tr><tr><td>Kubernetes 1.17</td><td>1.17.0+</td><td>N/A</td></tr><tr><td>Kubernetes 1.16</td><td>not tested</td><td>N/A</td></tr><tr><td>Kubernetes 1.15</td><td>not tested</td><td>N/A</td></tr></tbody></table><p>Please take a look <a href=/docs/gardener/usage/supported_k8s_versions/>here</a> to see which versions are supported by Gardener in general.</p><hr><h2 id=how-to-start-using-or-developing-this-extension-locally>How to start using or developing this extension locally</h2><p>You can run the extension locally on your machine by executing <code>make start</code>.</p><p>Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support</h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-provider-kubevirt/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!</h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=/docs/gardener/proposals/01-extensibility/>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=/docs/gardener/proposals/04-new-core-gardener-cloud-apis/>GEP-4 (New <code>core.gardener.cloud/v1alpha1</code> API)</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-15865a12aa5d76c98dc989741c55dce3>1 - Dev Setup</h1><h1 id=development-setup>Development Setup</h1><p>This document describes the recommended development setup for the <a href=https://github.com/gardener/gardener-extension-provider-kubevirt>KubeVirt provider extension</a>. Following the guidelines presented here would allow you to test the full Gardener reconciliation and deletion flows with the KubeVirt provider extension and the <a href=https://github.com/gardener/machine-controller-manager-provider-kubevirt>KubeVirt MCM extension</a>.</p><p>In this setup, only Gardener itself is running in your local development cluster. All other components, as well as KubeVirt VMs, are deployed and run on external clusters, which avoids high CPU and memory load on your local laptop.</p><h2 id=prerequisites>Prerequisites</h2><p>Follow the steps outlined in <a href=/docs/gardener/development/local_setup/>Setting up a local development environment</a> for Gardener in order to install all needed prerequisites and enable running <code>gardener-apiserver</code>, <code>gardener-controller-manager</code>, and <code>gardenlet</code> locally. You can use either minikube, kind, or the nodeless cluster as your local development cluster.</p><p>Before continuing, copy all files from <code>docs/development/manifests</code> and <code>docs/development/scripts</code> to your <code>dev</code> directory and adapt them as needed. The sections that follow assume that you have already done this and all needed manifests and scripts can be found in your <code>dev</code> directory.</p><h2 id=creating-the-controllerregistrations>Creating the ControllerRegistrations</h2><p>Before you register seeds or create shoots, you need to register all needed extensions using <code>ControllerRegistration</code> resources. The easiest way to manage <code>ControllerRegistrations</code> is via <a href=https://github.com/gardener/gem>gem</a>.</p><p>After installing <code>gem</code>, create a <code>requirements.yaml</code> file similar to <a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/docs/manifests/requirements.yaml>requirements.yaml</a>. The example file contains only the extensions needed for the development setup described here, but you could add any other Gardener extensions you may need.</p><p>In your <code>requirements.yaml</code> file you can refer to a released extension version, or to a revision (commit) from a Gardener repo or your fork of it. This version or revision is used to find the correct <code>controller-registration.yaml</code> file for the extension.</p><p>You can generate or update the <code>controller-registrations.yaml</code> file out of your <code>requirements.yaml</code> file by running:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>gem ensure --requirements dev/requirements.yaml --controller-registrations dev/controller-registrations.yaml
</code></pre></div><p>After generating or updating the <code>controller-registrations.yaml</code> file, review it and make sure all versions are the ones you want to use for your tests. For example, if you are working on a PR for the KubeVirt provider extension, in addition to specifying the revision in your fork in <code>requirements.yaml</code>, you may need to change the version from <code>0.1.0-dev</code> to something unique to you or your PR, e.g. <code>0.1.0-dev-johndoe</code>. You can also add <code>pullPolicy: Always</code> to ensure that if you push a new extension image with that version and delete the corresponding pod, the new image will always be pulled when the pod is recreated.</p><p>Once you are satisfied with your controller registrations, apply the <code>controller-registrations.yaml</code> to your local Gardener:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f dev/controller-registrations.yaml
</code></pre></div><h2 id=registering-the-seed-cluster>Registering the Seed Cluster</h2><p>Create or choose an external cluster, different from your local development cluster, to register as seed in your local Gardener. This can be any cluster and it can be the same or different from your <a href=#creating-the-provider-cluster>provider cluster</a>. It is recommended to use a different cluster to avoid confusion between the two. If you want to use your provider cluster as seed, first create it as described below and then return to this step.</p><p>To register your cluster as a seed, create the secret containing the kubeconfig for your seed cluster, the secret containing the credentials for your cloud provider (e.g. GCP), and the seed resource itself. See the following files as examples:</p><ul><li><a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/docs/manifests/secret-gcp1-kubeconfig.yaml>secret-gcp1-kubeconfig.yaml</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/docs/manifests/secret-seed-operator-gcp.yaml>secret-seed-operator-gcp.yaml</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/docs/manifests/seed-gcp1.yaml>seed-gcp1.yaml</a></li></ul><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f dev/secret-gcp1-kubeconfig.yaml
kubectl apply -f dev/secret-seed-operator-gcp.yaml
kubectl apply -f dev/seed-gcp1.yaml
</code></pre></div><h2 id=creating-the-project>Creating the Project</h2><p>At this point, you should create a <code>dev</code> project in your local Gardener.</p><p>Create the project resource for your local <code>dev</code> project, see <a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/docs/manifests/project-dev.yaml>project-dev</a> as an example.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f dev/project-dev.yaml
</code></pre></div><h2 id=creating-the-dns-domain-secrets>Creating the DNS Domain Secrets</h2><p>At this point, you should create the domain secrets used by the DNS extension.</p><p>If you want to use an external DNS provider (e.g. route53), create default and internal domain secrets similar to <a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/docs/manifests/secret-default-domain.yaml>secret-default-domain.yaml</a> and <a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/docs/manifests/secret-internal-domain.yaml>secret-internal-domain.yaml</a>.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f dev/secret-default-domain.yaml
kubectl apply -f dev/secret-internal-domain.yaml
</code></pre></div><p>Alternatively, if you don&rsquo;t want to use an external DNS provider and use <code>nip.io</code> addresses instead, create just an internal domain secret similar to <a href=https://github.com/gardener/gardener/blob/master/example/10-secret-internal-domain-unmanaged.yaml>10-secret-internal-domain-unmanaged.yaml</a>. For more information, see <a href=/docs/gardener/development/local_setup/#prepare-the-gardener>Prepare the Gardener</a>.</p><h2 id=creating-the-provider-cluster>Creating the Provider Cluster</h2><p>Create or choose an external cluster, different from your local development cluster, to use as a provider cluster. The only requirement to this cluster is that virtualization extensions are supported on its nodes. You can check if this is the case as described in <a href=https://kubevirt.io/pages/cloud.html>Easy install using Cloud Providers</a>, by executing the command <code>egrep 'svm|vmx' /proc/cpuinfo</code> and checking for non-empty output.</p><h3 id=creating-an-os-image-with-nested-virtualization-enabled>Creating an OS Image with Nested Virtualization Enabled</h3><p>Before you can create such a cluster, you need to ensure that nested virtualizaton is enabled for its instances by using an appropriate OS image. To create such an image in GCP, follow the steps described in <a href=https://cloud.google.com/compute/docs/instances/enable-nested-virtualization-vm-instances>Enabling nested virtualization for VM instances</a>. For example, to create a custom Ubuntu image with nested virtualizaton enabled based on Ubuntu 18.04, execute the following commands:</p><pre><code>gcloud compute disks create ubuntu-disk1 
  --image-project ubuntu-os-cloud \
  --image ubuntu-1804-bionic-v20200916 \
  --zone us-central1-b
gcloud compute images create ubuntu-1804-bionic-v20200916-vmx-enabled \
  --source-disk ubuntu-disk1 \
  --source-disk-zone us-central1-b \
  --licenses &quot;https://compute.googleapis.com/compute/v1/projects/vm-options/global/licenses/enable-vmx&quot;
gcloud compute images list | grep ubuntu
</code></pre><p>Once the image has been created, to create the provider cluster, you could use any Kubernetes provisioning tool, including of course Gardener itself, to create a cluster using this image.</p><h3 id=creating-the-provider-cluster-using-gardener>Creating the Provider Cluster Using Gardener</h3><p>To create the provider cluster using Gardener, simply create a shoot in the seed you registered previously using a custom GCP cloud profile that contains the above image, such as <a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/docs/manifests/cloudprofile-gcp.yaml>cloudprofile-gcp.yaml</a>. To do this, follow these steps:</p><ol><li><p>Create the custom GCP cloud profile, for example <a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/docs/manifests/cloudprofile-gcp.yaml>cloudprofile-gcp.yaml</a>.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f dev/cloudprofile-gcp.yaml
</code></pre></div></li><li><p>Create the shoot secret binding, you could bind to the <code>seed-operator-gcp</code> secret you created previously for your seed, see <a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/docs/manifests/secretbinding-shoot-operator-gcp.yaml>secretbinding-shoot-operator-gcp.yaml</a> as an example.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f dev/secretbinding-shoot-operator-gcp.yaml
</code></pre></div></li><li><p>Create the GCP shoot itself. See <a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/docs/manifests/shoot-gcp-vmx.yaml>shoot-gcp-vmx.yaml</a> as an example. Note that this shoot should use the image with name <code>ubuntu</code> and version <code>18.4.20200916-vmx</code> from the custom GCP cloud profile you created previously. Also, please rename the shoot to contain an unique prefix such as your github username, e.g. <code>johndoe-gcp-vmx</code>, to avoid naming conflicts in GCP.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f dev/shoot-gcp-vmx.yaml
</code></pre></div><p>During the reconciliation by your local <code>gardenlet</code>, you may want to connect to the seed to monitor the shoot namespace <code>shoot--dev--&lt;prefix>-gcp-vmx</code>.</p></li><li><p>Once the shoot is successfully reconciled by your local <code>gardenlet</code>, get its kubeconfig by executing:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get secret &lt;prefix&gt;-gcp-vmx.kubeconfig -n garden-dev -o jsonpath={.data.kubeconfig} | base64 -d &gt; dev/kubeconfig-gcp-vmx.yaml
</code></pre></div></li></ol><h3 id=installing-kubevirt-cdi-and-multus-in-the-provider-cluster>Installing KubeVirt, CDI, and Multus in the Provider Cluster</h3><p>Once the provider cluster has been created (with Gardener or any other provisioning tool), you should install KubeVirt, CDI, and optionally Multus in it so that it can serve its purpose as a provider cluster.</p><ol><li><p>Install KubeVirt and CDI in this cluster by executing the <a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/hack/kubevirt/install-kubevirt.sh>install-kubevirt.sh</a> script:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>export KUBECONFIG=dev/kubeconfig-gcp-vmx.yaml
hack/kubevirt/install-kubevirt.sh
</code></pre></div></li><li><p>Optionally, to use networking features, install <a href=https://github.com/k8snetworkplumbingwg/multus-cni/blob/master/docs/quickstart.md>Multus CNI</a> as described in its documentation, or by applying the provided <a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/hack/kubevirt/multus.yaml>multus.yaml</a> manifest.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>export KUBECONFIG=dev/kubeconfig-gcp-vmx.yaml
kubectl apply -f hack/kubevirt/multus.yaml
</code></pre></div><p><strong>Note:</strong> In order to use any additional CNI plugins, the plugin binaries must be present in the <code>/opt/cni/bin</code> directory of the provider cluster nodes. For testing purposes, they can be installed manually by downloading a <a href=https://github.com/containernetworking/plugins>containernetworking/plugins</a> release and copying the needed plugins to the <code>/opt/cni/bin</code> directory of each provider cluster node.</p></li></ol><h2 id=testing-the-gardener-reconciliation-flow>Testing the Gardener Reconciliation Flow</h2><p>To test the Gardener reconciliation flow with the KubeVirt provider extensions, create the KubeVirt shoot cluster in your local <code>dev</code> project, by following these steps:</p><ol><li><p>Create the KubeVirt cloud profile, for example <a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/docs/manifests/cloudprofile-kubevirt.yaml>cloudprofile-kubevirt.yaml</a>.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f dev/cloudprofile-kubevirt.yaml
</code></pre></div><p><strong>Note:</strong> The example cloud profile is intentionally rather simple and does not take advantage of some of the features supported by the KubeVirt provider extension. To test these features, modify the cloud profile manifest accordingly. For more information, see <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-kubevirt/docs/usage-as-operator/>Using the KubeVirt provider extension with Gardener as operator</a>.</p></li><li><p>Create the shoot secret and secret binding. You should create a secret containing the kubeconfig for your provider cluster, and a corresponding secret binding:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl create secret generic kubevirt-credentials -n garden-dev --from-file=kubeconfig=dev/kubeconfig-gcp-vmx.yaml
kubectl apply -f dev/secretbinding-kubevirt-credentials.yaml
</code></pre></div></li><li><p>Create the KubeVirt shoot itself. See <a href=https://github.com/gardener/gardener-extension-provider-kubevirt/blob/master/docs/manifests/shoot-kubevirt.yaml>shoot-kubevirt.yaml</a> as an example. Note that the nodes CIDR for this shoot must be the same range as the pods CIDR of your provider cluster.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f dev/shoot-kubevirt.yaml
</code></pre></div><p><strong>Note:</strong> The example shoot is intentionally very simple and does not take advantage of many of the features supported by the KubeVirt provider extension. To test these features, modify the shoot manifest accordingly. For more information, see <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-kubevirt/docs/usage-as-end-user/>Using the KubeVirt provider extension with Gardener as end-user</a>.</p></li><li><p>During the shoot reconciliation by your local <code>gardenlet</code>, you may want to:</p><ul><li>Monitor the <code>gardenlet</code> logs in your local console where <code>gardenlet</code> is running.</li><li>Connect to the seed to monitor the shoot namespace <code>shoot--dev--kubevirt</code> and the logs of the KubeVirt provider extension in the <code>extension-provider-kubevirt-*</code> namespace.</li><li>Connect to the provider cluster to monitor the <code>default</code> namespace where VMs and VMIs are being created.</li></ul></li><li><p>Once the shoot has been successfully reconciled, get its kubeconfig by executing:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get secret kubevirt.kubeconfig -n garden-dev -o jsonpath={.data.kubeconfig} | base64 -d &gt; dev/kubeconfig-kubevirt.yaml
</code></pre></div><p>At this point, you may want to connect to the KubeVirt shoot and check if it&rsquo;s usable.</p></li></ol><h2 id=testing-the-gardener-deletion-flow>Testing the Gardener Deletion Flow</h2><p>To test the Gardener deletion flow with the KubeVirt provider extensions, delete the KubeVirt shoot cluster in your local <code>dev</code> project, by following these steps:</p><ol><li><p>Delete the KubeVirt shoot itself using the <a href=https://github.com/gardener/gardener/blob/master/hack/usage/delete>delete</a> script.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl annotate shoot kubevirt -n garden-dev confirmation.gardener.cloud/deletion=1
kubectl delete shoot kubevirt -n garden-dev
</code></pre></div></li><li><p>During the shoot deletion by your local <code>gardenlet</code>, you may want to:</p><ul><li>Monitor the <code>gardenlet</code> logs in your local console where <code>gardenlet</code> is running.</li><li>Connect to the seed to monitor the shoot namespace <code>shoot--dev--kubevirt</code> and the logs of the KubeVirt provider extension in the <code>extension-provider-kubevirt-*</code> namespace.</li><li>Connect to the provider cluster to monitor the <code>default</code> namespace where VMs and VMIs are being created.</li></ul></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-78a8317c0864839f105133c6758a4a96>2 - Local Setup Admission</h1><h3 id=admission-kubevirt>admission-kubevirt</h3><p><code>admission-kubevirt</code> is an admission webhook server which is responsible for the validation of the cloud provider (KubeVirt in this case) specific fields and resources. The Gardener API server is cloud provider agnostic and it wouldn&rsquo;t be able to perform similar validation.</p><p>Follow the steps below to run the admission webhook server locally.</p><ol><li><p>Start the Gardener API server.</p><p>For details, check the Gardener <a href=/docs/gardener/development/local_setup/>local setup</a>.</p></li><li><p>Start the webhook server</p><p>Make sure that the <code>KUBECONFIG</code> environment variable is pointing to the local garden cluster.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>make start-admission
</code></pre></div></li><li><p>Setup the <code>ValidatingWebhookConfiguration</code>.</p><p><code>hack/dev-setup-admission-kubevirt.sh</code> will configure the webhook Service which will allow the kube-apiserver of your local cluster to reach the webhook server. It will also apply the <code>ValidatingWebhookConfiguration</code> manifest.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>./hack/dev-setup-admission-kubevirt.sh
</code></pre></div></li></ol><p>You are now ready to experiment with the <code>admission-kubevirt</code> webhook server locally.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-67ed47f87cb01457e11c1d03e04e81bc>3 - Usage As End User</h1><h1 id=using-the-kubevirt-provider-extension-with-gardener-as-end-user>Using the KubeVirt provider extension with Gardener as end-user</h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a few fields that are meant to contain provider-specific configuration.</p><p>This document describes how this configuration looks like for KubeVirt and provides an example <code>Shoot</code> manifest with minimal configuration that you can use to create a KubeVirt shoot cluster (without the landscape-specific information such as cloud profile names, secret binding names, etc.).</p><h2 id=provider-secret-data>Provider Secret Data</h2><p>Every shoot cluster references a <code>SecretBinding</code> which itself references a <code>Secret</code>, and this <code>Secret</code> contains the kubeconfig of your <em>KubeVirt provider cluster</em>. This cluster is the cluster where KubeVirt itself is installed, and that hosts the KubeVirt virtual machines used as shoot worker nodes. This <code>Secret</code> must look as follows:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: v1
kind: Secret
metadata:
  name: provider-cluster-kubeconfig
  namespace: garden-dev
type: Opaque
data:
  kubeconfig: base64(kubeconfig)
</code></pre></div><h3 id=permissions>Permissions</h3><p>All KubeVirt resources (<code>VirtualMachines</code>, <code>DataVolumes</code>, etc.) are created in the namespace of the current context of the above kubeconfig, that is <code>my-shoot</code> in the example below:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>...
current-context: provider-cluster
contexts:
- name: provider-cluster
  context:
    cluster: provider-cluster
    namespace: my-shoot
    user: provider-cluster-token
...
</code></pre></div><p>If no namespace is specified, the <code>default</code> namespace is assumed. You can use the same namespace for multiple shoots. The user specified in the <code>kubeconfig</code> must have permissions to read and write KubeVirt and Kubernetes core resources in this namespace.</p><h2 id=infrastructureconfig><code>InfrastructureConfig</code></h2><p>The infrastructure configuration can contain additional networks used by the shoot worker nodes. If this configuration is empty, all KubeVirt virtual machines used as shoot worker nodes use only the pod network of the provider cluster.</p><p>An example <code>InfrastructureConfig</code> for the KubeVirt extension looks as follows:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: kubevirt.provider.extensions.gardener.cloud/v1alpha1
kind: InfrastructureConfig
networks:
  sharedNetworks:
  <span style=color:green># Reference to the network defined by the NetworkAttachmentDefinition default/net-conf</span>
  - name: net-conf
    namespace: default
  tenantNetworks:
  - name: network-1
    <span style=color:green># Configuration for the CNI plugins bridge and firewall</span>
    config: |<span style=color:#a31515>
</span><span style=color:#a31515>      {
</span><span style=color:#a31515>        &#34;cniVersion&#34;: &#34;0.4.0&#34;,
</span><span style=color:#a31515>        &#34;name&#34;: &#34;bridge-firewall&#34;,
</span><span style=color:#a31515>        &#34;plugins&#34;: [
</span><span style=color:#a31515>          {
</span><span style=color:#a31515>            &#34;type&#34;: &#34;bridge&#34;,
</span><span style=color:#a31515>            &#34;isGateway&#34;: true,
</span><span style=color:#a31515>            &#34;isDefaultGateway&#34;: true,
</span><span style=color:#a31515>            &#34;ipMasq&#34;: true,
</span><span style=color:#a31515>            &#34;ipam&#34;: {
</span><span style=color:#a31515>              &#34;type&#34;: &#34;host-local&#34;,
</span><span style=color:#a31515>              &#34;subnet&#34;: &#34;10.100.0.0/16&#34;
</span><span style=color:#a31515>            }
</span><span style=color:#a31515>          },
</span><span style=color:#a31515>          {
</span><span style=color:#a31515>            &#34;type&#34;: &#34;firewall&#34;
</span><span style=color:#a31515>          }
</span><span style=color:#a31515>        ]
</span><span style=color:#a31515>      }</span>      
    <span style=color:green># Don&#39;t attach the pod network at all, instead use this network as default</span>
    default: <span style=color:#00f>true</span>
</code></pre></div><p>A non-empty infrastructure configuration can contain:</p><ul><li>References to pre-existing, <em>shared</em> networks that can be shared between multiple shoots. These networks must exist in the provider cluster prior to shoot creation.</li><li>CNI configurations for <em>tenant</em> networks that are created, updated, and deleted together with the shoot. If one of these networks is marked as <code>default: true</code>, it becomes the default network instead of the pod network of the provider cluster. This can be used to achieve higher level of network isolation, since the networks of the different shoots can be isolated from each other, and in some cases better performance.</li></ul><p>Both shared and tenant networks are maintained in the provider cluster via <a href=https://github.com/intel/multus-cni/blob/master/README.md>Multus CNI</a> <a href=https://github.com/k8snetworkplumbingwg/multus-cni/blob/master/docs/quickstart.md>NetworkAttachmentDefinition</a> resources. For shared networks, these resources must be created in advance, while for tenant networks they are managed by the shoot reconciliation process.</p><p>In order to use any additional CNI plugins in a tenant network configuration, such as <code>bridge</code> or <code>firewall</code> in the above example, the plugin binaries must be present in the <code>/opt/cni/bin</code> directory of the provider cluster nodes. They can be installed manually by downloading a <a href=https://github.com/containernetworking/plugins>containernetworking/plugins</a> release (not recommended except for testing a new configuration). Alternatively, they can be installed via a specially prepared daemon set that ensures the existence of the plugin binaries on each provider cluster node.</p><p><strong>Note:</strong> Although it is possible to update the network configuration in <code>InfrastructureConfig</code>, any such changes will result in recreating all KubeVirt VMs, so that the new network configuration is properly taken into account. This will be done automatically by the MCM using rolling update.</p><h2 id=controlplaneconfig><code>ControlPlaneConfig</code></h2><p>The control plane configuration contains options for the KubeVirt-specific control plane components. Currently, the only component deployed by the KubeVirt extension is the <a href=https://github.com/kubevirt/cloud-provider-kubevirt>KubeVirt Cloud Controller Manager (CCM)</a>.</p><p>An example <code>ControlPlaneConfig</code> for the KubeVirt extension looks as follows:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: kubevirt.provider.extensions.gardener.cloud/v1alpha1
kind: ControlPlaneConfig
cloudControllerManager:
  featureGates:
    CustomResourceValidation: <span style=color:#00f>true</span>
</code></pre></div><p>The <code>cloudControllerManager.featureGates</code> contains a map of explicitly enabled or disabled feature gates. For production usage it&rsquo;s not recommend to use this field at all as you can enable alpha features or disable beta/stable features, potentially impacting the cluster stability. If you don&rsquo;t want to configure anything for the CCM, simply omit the key in the YAML specification.</p><h2 id=workerconfig><code>WorkerConfig</code></h2><p>The KubeVirt extension supports specifying additional data volumes per machine in the worker pool. For each data volume, you must specify a name and a type.</p><p>Below is an example <code>Shoot</code> resource snippet with root volume and data volumes:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>spec:
  provider:
    workers:
    - name: cpu-worker
      ...
      volume:
        type: default
        size: 20Gi
      dataVolumes:
      - name: volume-1
        type: default
        size: 10Gi
</code></pre></div><p><strong>Note:</strong> The additional data volumes will be attached as blank disks to the KubeVirt VMs. These disks must be formatted and mounted manually to the VM before they can be used.</p><p>The KubeVirt extension does not currently support encryption for volumes.</p><p>Additionally, it is possible to specify additional KubeVirt-specific options for configuring the worker pools. They can be specified in <code>.spec.provider.workers[].providerConfig</code> and are evaluated by the KubeVirt worker controller when it reconciles the shoot machines.</p><p>An example <code>WorkerConfig</code> for the KubeVirt extension looks as follows:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: kubevirt.provider.extensions.gardener.cloud/v1alpha1
kind: WorkerConfig
devices:
  <span style=color:green># disks allow to customize disks attached to KubeVirt VM</span>
  <span style=color:green># check [link](https://kubevirt.io/user-guide/#/creation/disks-and-volumes?id=disks-and-volumes) for full specification and options</span>
  disks:
  <span style=color:green># name must match defined dataVolume name</span>
  <span style=color:green># to modify root volume the name must be equal to &#39;root-disk&#39;</span>
  - name: root-disk <span style=color:green># modify root-disk</span>
    <span style=color:green># disk type, check [link](https://kubevirt.io/user-guide/#/creation/disks-and-volumes?id=disks) for more types</span>
    disk:
      <span style=color:green># bus indicates the type of disk device to emulate.</span>
      bus: virtio
    <span style=color:green># set disk device cache</span>
    cache: writethrough
    <span style=color:green># dedicatedIOThread indicates this disk should have an exclusive IO Thread</span>
    dedicatedIOThread: <span style=color:#00f>true</span>
  - name: volume-1 <span style=color:green># modify dataVolume named volume-1</span>
    disk: {}
  <span style=color:green># whether to have random number generator from host</span>
  rng: {}
  <span style=color:green># whether or not to enable virtio multi-queue for block devices</span>
  blockMultiQueue: <span style=color:#00f>true</span>
  <span style=color:green># if specified, virtual network interfaces configured with a virtio bus will also enable the vhost multiqueue feature</span>
  networkInterfaceMultiQueue: <span style=color:#00f>true</span>
cpu:
  <span style=color:green># number of cores inside the VMI</span>
  cores: 1
  <span style=color:green># number of sockets inside the VMI</span>
  sockets: 2
  <span style=color:green># number of threads inside the VMI</span>
  threads: 1
  <span style=color:green># models specifies the CPU model of the VMI</span>
  <span style=color:green># list of available models https://github.com/libvirt/libvirt/tree/master/src/cpu_map.</span>
  <span style=color:green># and options https://libvirt.org/formatdomain.html#cpu-model-and-topology</span>
  model: <span style=color:#a31515>&#34;host-model&#34;</span>
  <span style=color:green># features specifies the CPU features list inside the VMI</span>
  features:
  - <span style=color:#a31515>&#34;pcid&#34;</span>
  <span style=color:green># dedicatedCPUPlacement requests the scheduler to place the VirtualMachineInstance on a node</span>
  <span style=color:green># with dedicated pCPUs and pin the vCPUs to it.</span>
  dedicatedCpuPlacement: <span style=color:#00f>false</span>
  <span style=color:green># isolateEmulatorThread requests one more dedicated pCPU to be allocated for the VMI to place the emulator thread on it.</span>
  isolateEmulatorThread: <span style=color:#00f>false</span>
<span style=color:green># memory configuration for KubeVirt VMs, allows to set &#39;hugepages&#39; and &#39;guest&#39; settings. </span>
<span style=color:green># See https://kubevirt.io/api-reference/master/definitions.html#_v1_memory</span>
memory:
  <span style=color:green># hugepages requires appropriate feature gate to be enabled, take a look at the following links for more details:</span>
  <span style=color:green># * k8s - https://kubernetes.io/docs/tasks/manage-hugepages/scheduling-hugepages/</span>
  <span style=color:green># * okd - https://docs.okd.io/latest/scalability_and_performance/what-huge-pages-do-and-how-they-are-consumed-by-apps.html</span>
  hugepages:
     pageSize: <span style=color:#a31515>&#34;2Mi&#34;</span>
  <span style=color:green># guest allows to specifying the amount of memory which is visible inside the Guest OS. It must lie between requests and limits.</span>
  <span style=color:green># Defaults to the requested memory in the machineTypes.</span>
  guest: <span style=color:#a31515>&#34;1Gi&#34;</span>
<span style=color:green># overcommitGuestOverhead informs the scheduler to not take the guest-management overhead into account. Instead</span>
<span style=color:green># put the overhead only into the container&#39;s memory limit. This can lead to crashes if</span>
<span style=color:green># all memory is in use on a node. Defaults to false.</span>
<span style=color:green># For more details take a look at https://kubevirt.io/user-guide/#/usage/overcommit?id=overcommit-the-guest-overhead</span>
overcommitGuestOverhead: <span style=color:#00f>true</span>
<span style=color:green># DNS policy for KubeVirt VMs. Valid values are &#39;ClusterFirstWithHostNet&#39;, &#39;ClusterFirst&#39;, &#39;Default&#39; or &#39;None&#39;.</span>
<span style=color:green># Defaults to &#39;ClusterFirst`.</span>
<span style=color:green># See https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/</span>
dnsPolicy: ClusterFirst
<span style=color:green># DNS configuration for KubeVirt VMs, merged with the generated DNS configuration based on dnsPolicy.</span>
<span style=color:green># See https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/</span>
dnsConfig:
  nameservers:
  - 8.8.8.8
<span style=color:green># Disable using pre-allocated data volumes. Defaults to &#39;false&#39;.</span>
disablePreAllocatedDataVolumes: <span style=color:#00f>true</span>
<span style=color:green># cpu allows to set the CPU topology of the VMI</span>
<span style=color:green># See https://kubevirt.io/api-reference/master/definitions.html#_v1_cpu</span>
</code></pre></div><p>Currently, these KubeVirt-specific options may include:</p><ul><li>The CPU topology and memory configuration of the KubVirt VMs. For more information, see <a href=https://kubevirt.io/api-reference/master/definitions.html#_v1_cpu>CPU.v1</a> and <a href=https://kubevirt.io/api-reference/master/definitions.html#_v1_memory>Memory.v1</a>.</li><li>The DNS policy and DNS configuration of the KubeVirt VMs. For more information, see <a href=https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/>DNS for Services and Pods</a>.</li><li>Whether to use <em>pre-allocated data volumes</em> with KubeVirt VMs. With pre-allocated data volumes (the default), a data volume is created in advance for each machine class, the OS image is imported into this volume only once, and actual KubeVirt VM data volumes are cloned from this data volume. Typically, this significantly speeds up the data volume creation process. You can disable this feature by setting the <code>disablePreAllocatedDataVolumes</code> option to <code>true</code>.</li></ul><h2 id=region-and-zone-support>Region and Zone Support</h2><p>Nodes in the provider cluster may belong to provider-specific regions and zones, and Kubernetes would then use this information to spread pods across zones as described in <a href=https://kubernetes.io/docs/setup/best-practices/multiple-zones/>Running in multiple zones</a>. You may want to take advantage of these capabilities in the shoot cluster as well.</p><p>To achieve this, the KubeVirt provider extension ensures that the region and zones specified in the <code>Shoot</code> resource are taken into account when creating the KubeVirt VMs used as shoot cluster nodes.</p><p>Below is an example <code>Shoot</code> resource snippet with region and zones:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>spec:  
  region: europe-west1
  provider:
    ...
    workers:
    - name: cpu-worker
      ...
      zones:
      - europe-west1-c
      - europe-west1-d
</code></pre></div><p>The shoot region and zones must correspond to the region and zones of the provider cluster. A KubeVirt VM designated for specific region and zone will only be scheduled on provider cluster nodes belonging to these region and zone. If there are no such nodes, or they have insufficient resources, the KubeVirt VM may remain in <code>Pending</code> state for a longer period and the shoot reconciliation may fail. Therefore, always make sure that the provider cluster contains nodes for all zones specified in the shoot.</p><p>If multiple zones are specified for a worker pool, the KubeVirt VMs will be equally distributed over these zones in the specified order.</p><p>If your provider cluster is not region and zone aware, or if it contains nodes that don&rsquo;t belong to any region or zone, you can use <code>default</code> as a region or zone name in the <code>Shoot</code> resource to target such nodes.</p><p>Note that the <code>region</code> and <code>zones</code> are mandatory fields in the <code>Shoot</code> resource, so you must specify either a concrete region / zone or <code>default</code>.</p><p>Once the KubeVirt VMs are scheduled on the correct provider cluster nodes, the KubeVirt Cloud Controller Manager (CCM) mentioned above will appropriately label the shoot worker nodes themselves with the appropriate <a href=https://kubernetes.io/docs/reference/kubernetes-api/labels-annotations-taints/>region and zone labels</a>, by propagating the region and zone from the provider cluster nodes, so that Kubernetes multi-zone capabilities are also available in the shoot cluster.</p><h2 id=example-shoot-manifest>Example <code>Shoot</code> Manifest</h2><p>Please find below an example <code>Shoot</code> manifest for one availability zone:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: core.gardener.cloud/v1beta1
kind: Shoot
metadata:
  name: johndoe-kubevirt
  namespace: garden-dev
spec:
  cloudProfileName: kubevirt
  secretBindingName: provider-cluster-kubeconfig
  region: europe-west1
  provider:
    type: kubevirt
<span style=color:green>#   infrastructureConfig:</span>
<span style=color:green>#     apiVersion: kubevirt.provider.extensions.gardener.cloud/v1alpha1</span>
<span style=color:green>#     kind: InfrastructureConfig</span>
<span style=color:green>#     networks:</span>
<span style=color:green>#       tenantNetworks:</span>
<span style=color:green>#       - name: network-1</span>
<span style=color:green>#         config: &#34;{...}&#34;</span>
<span style=color:green>#         default: true</span>
<span style=color:green>#   controlPlaneConfig:</span>
<span style=color:green>#     apiVersion: kubevirt.provider.extensions.gardener.cloud/v1alpha1</span>
<span style=color:green>#     kind: ControlPlaneConfig</span>
<span style=color:green>#     cloudControllerManager:</span>
<span style=color:green>#       featureGates:</span>
<span style=color:green>#         CustomResourceValidation: true</span>
    workers:
    - name: cpu-worker
      machine:
        type: standard-1
        image:
          name: ubuntu
          version: <span style=color:#a31515>&#34;18.04&#34;</span>
      minimum: 1
      maximum: 2
      volume:
        type: default
        size: 20Gi
<span style=color:green>#     dataVolumes:</span>
<span style=color:green>#     - name: volume-1</span>
<span style=color:green>#       type: default</span>
<span style=color:green>#       size: 10Gi</span>
<span style=color:green>#     providerConfig:</span>
<span style=color:green>#       apiVersion: kubevirt.provider.extensions.gardener.cloud/v1alpha1</span>
<span style=color:green>#       kind: WorkerConfig</span>
<span style=color:green>#       disablePreAllocatedDataVolumes: true</span>
      zones:
      - europe-west1-c
  networking:
    type: calico
    pods: 100.96.0.0/11
    <span style=color:green># Must match the IPAM subnet of the default tenant network, if present.</span>
    <span style=color:green># Otherwise, must be the same as the provider cluster pod network range.</span>
    nodes: 10.225.128.0/17 <span style=color:green># 10.100.0.0/16</span>
    services: 100.64.0.0/13
  kubernetes:
    version: 1.17.8
  maintenance:
    autoUpdate:
      kubernetesVersion: <span style=color:#00f>true</span>
      machineImageVersion: <span style=color:#00f>true</span>
  addons:
    kubernetesDashboard:
      enabled: <span style=color:#00f>true</span>
    nginxIngress:
      enabled: <span style=color:#00f>true</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c8ac00cf9e8750118007c79249658ad5>4 - Usage As Operator</h1><h1 id=using-the-kubevirt-provider-extension-with-gardener-as-operator>Using the KubeVirt provider extension with Gardener as operator</h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/30-cloudprofile.yaml><code>core.gardener.cloud/v1beta1.CloudProfile</code> resource</a> declares a <code>providerConfig</code> field that is meant to contain provider-specific configuration. The <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml><code>core.gardener.cloud/v1beta1.Seed</code> resource</a> is structured in a similar way. Additionally, it allows configuring settings for the backups of the main etcds' data of shoot clusters control planes running in this seed cluster.</p><p>This document explains what is necessary to configure for this provider extension.</p><h2 id=cloudprofile-resource><code>CloudProfile</code> resource</h2><p>In this section we are describing how the configuration for <code>CloudProfile</code>s looks like for KubeVirt and provide an example <code>CloudProfile</code> manifest with minimal configuration that you can use to allow creating KubeVirt shoot clusters.</p><h3 id=cloudprofileconfig><code>CloudProfileConfig</code></h3><p>The cloud profile configuration contains information about the machine images source URLs. You have to map every version that you specify in <code>.spec.machineImages[].versions</code> here so that the KubeVirt extension could find the source URL for every version you want to offer.</p><p>An example <code>CloudProfileConfig</code> for the KubeVirt extension looks as follows:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: kubevirt.provider.extensions.gardener.cloud/v1alpha1
kind: CloudProfileConfig
machineImages:
- name: ubuntu
  versions:
  - version: <span style=color:#a31515>&#34;18.04&#34;</span>
    sourceURL: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img
<span style=color:green># machineTypes extend cloud profile&#39;s spec.machineType object to KubeVirt provider specific config</span>
machineTypes:
<span style=color:green># name is used as a reference to the machineType object</span>
- name: standard-1  
  <span style=color:green># limits is equivalent to resource limits of pod</span>
  <span style=color:green># https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#resource-requests-and-limits-of-pod-and-container</span>
  limits:
    cpu: <span style=color:#a31515>&#34;2&#34;</span>
    memory: 8Gi
</code></pre></div><h3 id=example-cloudprofile-manifest>Example <code>CloudProfile</code> manifest</h3><p>Please find below an example <code>CloudProfile</code> manifest:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: core.gardener.cloud/v1beta1
kind: CloudProfile
metadata:
  name: kubevirt
spec:
  type: kubevirt
  providerConfig:
    apiVersion: kubevirt.provider.extensions.gardener.cloud/v1alpha1
    kind: CloudProfileConfig
    machineImages:
    - name: ubuntu
      versions:
      - version: <span style=color:#a31515>&#34;18.04&#34;</span>
        sourceURL: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img
  kubernetes:
    versions:
    - version: 1.18.5
    - version: 1.17.8
  machineImages:
  - name: ubuntu
    versions:
    - version: <span style=color:#a31515>&#34;18.04&#34;</span>
  machineTypes:
  - name: standard-1
    cpu: <span style=color:#a31515>&#34;1&#34;</span>
    gpu: <span style=color:#a31515>&#34;0&#34;</span>
    memory: 4Gi
  volumeTypes:
  - name: default
    class: default
  regions:
  - name: europe-west1
    zones:
    - name: europe-west1-b
    - name: europe-west1-c
    - name: europe-west1-d
</code></pre></div><h2 id=seed-resource><code>Seed</code> resource</h2><p>This provider extension does not support any provider configuration for the <code>Seed</code>&rsquo;s <code>.spec.provider.providerConfig</code> field.</p></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2022 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity=sha384-uQikAXnCAqsMb3ygtdqBYvcwvHUkzGIpjdGyy9owhURXHUxLC5LgTcSxJQH/RzjK crossorigin=anonymous></script><script src=/js/main.min.ef8e0714aff556fd5a9768ed6ecabd2964dd962cd9f89762a373947bb53bc742.js integrity="sha256-744HFK/1Vv1al2jtbsq9KWTdlizZ+Jdio3OUe7U7x0I=" crossorigin=anonymous></script></body></html>