<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=https://gardener.cloud/docs/extensions/others/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/extensions/others/index.xml><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=icon type=image/x-icon href=https://gardener.cloud/images/favicon.ico><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-16x16.png sizes=16x16><title>Others | Gardener</title><meta name=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:title" content="Others"><meta property="og:description" content="Other Gardener extensions"><meta property="og:type" content="website"><meta property="og:url" content="https://gardener.cloud/docs/extensions/others/"><meta itemprop=name content="Others"><meta itemprop=description content="Other Gardener extensions"><meta name=twitter:card content="summary"><meta name=twitter:title content="Others"><meta name=twitter:description content="Other Gardener extensions"><link rel=preload href=/scss/main.min.ca2e9ddee7809848b536632b41e4e4df665800778ffe11b75edde5bdd6c78963.css as=style><link href=/scss/main.min.ca2e9ddee7809848b536632b41e4e4df665800778ffe11b75edde5bdd6c78963.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.2035d9813dafac83fe2a48b18d50f237.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/extensions/others/>Return to the regular view of this page</a>.</p></div><h1 class=title>Others</h1><div class=lead>Other Gardener extensions</div><div class=content></div></div><div class=td-content><h1 id=pg-ed74ceaa562b93985c3d5ce5042a7a22>1 - Certificate services</h1><div class=lead>Gardener extension controller for certificate services for shoot clusters</div><h1 id=gardener-extension-for-certificate-serviceshttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for certificate services</a></h1><p><a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-shoot-cert-service-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-shoot-cert-service-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-shoot-cert-service><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-shoot-cert-service alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service. Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>. However, the project has grown to a size where it is very hard to extend, maintain, and test. With <a href=/docs/gardener/proposals/01-extensibility/>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics. This way, we can keep Gardener core clean and independent.</p><h2 id=configuration>Configuration</h2><p>Example configuration for this extension controller:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: shoot-cert-service.extensions.config.gardener.cloud/v1alpha1
kind: Configuration
issuerName: gardener
restrictIssuer: <span style=color:#00f>true</span> <span style=color:green># restrict issuer to any sub-domain of shoot.spec.dns.domain (default)</span>
acme:
  email: john.doe@example.com
  server: https://acme-v02.api.letsencrypt.org/directory
<span style=color:green># privateKey: | # Optional key for Let&#39;s Encrypt account.</span>
<span style=color:green>#   -----BEGIN BEGIN RSA PRIVATE KEY-----</span>
<span style=color:green>#   ...</span>
<span style=color:green>#   -----END RSA PRIVATE KEY-----</span>
</code></pre></div><h2 id=extension-resources>Extension-Resources</h2><p>Example extension resource:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: extensions.gardener.cloud/v1alpha1
kind: Extension
metadata:
  name: <span style=color:#a31515>&#34;extension-certificate-service&#34;</span>
  namespace: shoot--project--abc
spec:
  type: shoot-cert-service
</code></pre></div><p>When an extension resource is reconciled, the extension controller will create an instance of <a href=https://github.com/gardener/cert-management>Cert-Management</a> as well as an <code>Issuer</code> with the ACME information provided in the <a href=#Configuration>configuration</a> above. These resources are placed inside the shoot namespace on the seed. Also, the controller takes care about generating necessary <code>RBAC</code> resources for the seed as well as for the shoot.</p><p>Please note, this extension controller relies on the <a href=https://github.com/gardener/gardener-resource-manager>Gardener-Resource-Manager</a> to deploy k8s resources to seed and shoot clusters, i.e. it never deploys them directly.</p><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally</h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the kubeconfig to the cluster you want to connect to ready in the <code>./dev/kubeconfig</code> file.
Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support</h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-cert-service/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!</h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=/docs/gardener/proposals/01-extensibility/>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c482a0726f279fe3ad5f53ba778b84f3>1.1 - Gardener yourself a Shoot with Istio, custom Domains, and Certificates</h1><p>As we ramp up more and more friends of Gardener, I thought it worthwile to explore and write a tutorial about how to simply</p><ul><li>create a Gardener managed Kubernetes Cluster (Shoot) via kubectl,</li><li>install Istio as a preferred, production ready Ingress/Service Mesh (instead of the Nginx Ingress addon),</li><li>attach your own custom domain to be managed by Gardener,</li><li>combine everything with certificates from Let&rsquo;s Encrypt.</li></ul><p>Here are some pre-pointers that you will need to go deeper:</p><ul><li><a href=https://github.com/gardener/documentation/blob/master/website/documentation/guides/administer_shoots/create-delete-shoot/_index.md>CRUD Gardener Shoot</a></li><li><a href=https://github.com/gardener/external-dns-management/blob/master/README.md>DNS Management</a></li><li><a href=https://github.com/gardener/cert-management/blob/master/README.md>Certificate Management</a></li><li><a href=/docs/extensions/others/gardener-extension-shoot-dns-service/docs/usage/dns_names/>Tutorial Domain Names</a></li><li><a href=/docs/extensions/others/gardener-extension-shoot-cert-service/docs/usage/request_cert/>Tutorial Certificates</a></li></ul><div class="alert alert-primary" role=alert><h4 class=alert-heading>Tip</h4>If you try my instructions and fail, then read the alternative title of this tutorial as "Shoot yourself in the foot with Gardener, custom Domains, Istio and Certificates".</div><h2 id=first-things-first>First Things First</h2><p>Login to your Gardener landscape, setup a project with adequate infrastructure credentials and then navigate to your account. Note down the name of your secret. I chose the GCP infrastructure from the vast possible options that my Gardener provides me with, so i had named the secret as <code>shoot-operator-gcp</code>.</p><p>From the Access widget (leave the default settings) download your personalized <code>kubeconfig</code> into <code>~/.kube/kubeconfig-garden-myproject</code>. Follow the instructions to setup <code>kubelogin</code>:</p><p><img src=/__resources/access_5deea7.png alt=access></p><p>For convinience, let us set an alias command with</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>alias kgarden=<span style=color:#a31515>&#34;kubectl --kubeconfig ~/.kube/kubeconfig-garden-myproject.yaml&#34;</span>
</code></pre></div><p><code>kgarden</code> now gives you all botanical powers and connects you directly with your Gardener.</p><p>You should now be able to run <code>kgarden get shoots</code>, automatically get an oidc token, and list already running clusters/shoots.</p><h2 id=prepare-your-custom-domain>Prepare your Custom Domain</h2><p>I am going to use <a href=https://www.cloudflare.com/>Cloud Flare</a> as programmatic DNS of my custom domain <code>mydomain.io</code>. Please follow detailed instructions from Cloud Flare on how to delegate your domain (the free account does not support delegating subdomains). Alternatively, AWS Route53 (and most others) support <a href=https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/CreatingNewSubdomain.html>delegating subdomains</a>.</p><p>I needed to follow these <a href=https://github.com/gardener/external-dns-management/blob/master/docs/cloudflare/README.md>instructions</a> and created the following secret:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: v1
kind: Secret
metadata:
  name: cloudflare-mydomain-io
type: Opaque
data:
  CLOUDFLARE_API_TOKEN: useYOURownDAMITzNDU2Nzg5MDEyMzQ1Njc4OQ==
</code></pre></div><p>Apply this secret into your project with <code>kgarden create -f cloudflare-mydomain-io.yaml</code>.</p><p>Our <a href=https://github.com/gardener/external-dns-management/>External DNS Manager</a> also supports Amazon Route53, Google CloudDNS, AliCloud DNS, Azure DNS, or OpenStack Designate. Check it out.</p><h2 id=prepare-gardener-extensions>Prepare Gardener Extensions</h2><p>I now need to prepare the Gardener extensions <code>shoot-dns-service</code> and <code>shoot-cert-service</code> and set the parameters accordingly.</p><div class="alert alert-info" role=alert>Please note, that the availability of Gardener Extensions depends on how your administrator has configured the Gardener landscape. Please contact your Gardener administrator in case you experience any issues during activation.</div><p>The following snipplet allows Gardener to manage my entire custom domain, whereas with the <code>include:</code> attribute I restrict all dynamic entries under the subdomain <code>gsicdc.mydomain.io</code>:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  dns:
    providers:
      - domains:
          include:
            - gsicdc.mydomain.io
        primary: <span style=color:#00f>false</span>
        secretName: cloudflare-mydomain-io
        type: cloudflare-dns
  extensions:
    - type: shoot-dns-service
</code></pre></div><p>The next snipplet allows Gardener to manage certificates automatically from <em><a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a></em> on <code>mydomain.io</code> for me:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  extensions:
    - type: shoot-cert-service
      providerConfig:
        apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
        issuers:
          - email: me@mail.com
            name: mydomain
            server: <span style=color:#a31515>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span>
          - email: me@mail.com
            name: mydomain-staging
            server: <span style=color:#a31515>&#39;https://acme-staging-v02.api.letsencrypt.org/directory&#39;</span>
</code></pre></div><div class="alert alert-info" role=alert>Adjust the snipplets with your parameters (don't forget your email). And please use the mydomain-staging issuer while you are testing and learning. Otherwise, Let's Encrypt will rate limit your frequent requests and you can wait a week until you can continue.</div><p>References for <a href=https://letsencrypt.org>Let&rsquo;s Encrypt</a>:</p><ul><li><a href=https://letsencrypt.org/docs/rate-limits/>Rate limit</a></li><li><a href=https://letsencrypt.org/docs/staging-environment/>Staging environment</a></li><li><a href=https://letsencrypt.org/docs/challenge-types/>Challenge Types</a></li><li><a href=https://community.letsencrypt.org/t/acme-v2-production-environment-wildcards/55578>Wildcard Certificates</a></li></ul><h2 id=create-the-gardener-shoot-cluster>Create the Gardener Shoot Cluster</h2><p>Remember I chose to create the Shoot on GCP, so below is the simplest declarative shoot or cluster order document. Notice that I am referring to the infrastructure credentials with <code>shoot-operator-gcp</code> and I combined the above snipplets into the yaml file:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: core.gardener.cloud/v1beta1
kind: Shoot
metadata:
  name: gsicdc
spec:
  dns:
    providers:
    - domains:
        include:
          - gsicdc.mydomain.io
      primary: <span style=color:#00f>false</span>
      secretName: cloudflare-mydomain-io
      type: cloudflare-dns
  extensions:
  - type: shoot-dns-service
  - type: shoot-cert-service
    providerConfig:
      apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
      issuers:
        - email: me@mail.com
          name: mydomain
          server: <span style=color:#a31515>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span>
        - email: me@mail.com
          name: mydomain-staging
          server: <span style=color:#a31515>&#39;https://acme-staging-v02.api.letsencrypt.org/directory&#39;</span>
  cloudProfileName: gcp
  kubernetes:
    allowPrivilegedContainers: <span style=color:#00f>true</span>
    version: 1.18.2
  maintenance:
    autoUpdate:
      kubernetesVersion: <span style=color:#00f>true</span>
      machineImageVersion: <span style=color:#00f>true</span>
  networking:
    nodes: 10.250.0.0/16
    pods: 100.96.0.0/11
    services: 100.64.0.0/13
    type: calico
  provider:
    controlPlaneConfig:
      apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
      kind: ControlPlaneConfig
      zone: europe-west1-d
    infrastructureConfig:
      apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
      kind: InfrastructureConfig
      networks:
        workers: 10.250.0.0/16
    type: gcp
    workers:
    - machine:
        image:
          name: gardenlinux
          version: 11.29.2
        type: n1-standard-2
      maxSurge: 1
      maxUnavailable: 0
      maximum: 2
      minimum: 1
      name: my-workerpool
      volume:
        size: 50Gi
        type: pd-standard
      zones:
      - europe-west1-d
  purpose: testing
  region: europe-west1
  secretBindingName: shoot-operator-gcp
</code></pre></div><p>Create your cluster and wait for it to be ready (about 5 to 7min).</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kgarden create -f gsicdc.yaml
shoot.core.gardener.cloud/gsicdc created

$ kgarden get shoot gsicdc --watch
NAME     CLOUDPROFILE   VERSION   SEED   DOMAIN                                        HIBERNATION   OPERATION    PROGRESS   APISERVER     CONTROL       NODES     SYSTEM    AGE
gsicdc   gcp            1.18.2    gcp    gsicdc.myproject.shoot.devgarden.cloud   Awake         Processing   38         Progressing   Progressing   Unknown   Unknown   83s
...
gsicdc   gcp            1.18.2    gcp    gsicdc.myproject.shoot.devgarden.cloud   Awake         Succeeded    100        True          True          True          False         6m7s
</code></pre></div><p>Get access to your freshly baked cluster and set your <code>KUBECONFIG</code>:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kgarden get secrets gsicdc.kubeconfig -o jsonpath={.data.kubeconfig} | base64 -d &gt;kubeconfig-gsicdc.yaml

$ export KUBECONFIG=<span style=color:#00f>$(</span>pwd<span style=color:#00f>)</span>/kubeconfig-gsicdc.yaml
$ kubectl get all
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   100.64.0.1   &lt;none&gt;        443/TCP   89m
</code></pre></div><h2 id=install-istio>Install Istio</h2><p>Please follow the Istio installation <a href=https://istio.io/docs/setup/getting-started/>instructions</a> and download <code>istioctl</code>. If you are on a Mac, I recommend</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ brew install istioctl
</code></pre></div><p>I want to install Istio with a default profile and SDS enabled. Furthermore I pass the following annotations to the service object <code>istio-ingressgateway</code> in the <code>istio-system</code> namespace.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  annotations:
    cert.gardener.cloud/issuer: mydomain-staging
    cert.gardener.cloud/secretname: wildcard-tls
    dns.gardener.cloud/class: garden
    dns.gardener.cloud/dnsnames: <span style=color:#a31515>&#34;*.gsicdc.mydomain.io&#34;</span>
    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;120&#34;</span>
</code></pre></div><p>With these annotations three things now happen automagically:</p><ol><li>The <a href=https://github.com/gardener/external-dns-management/blob/master/README.md>External DNS Manager</a>, provided to you as a service (<code>dns.gardener.cloud/class: garden</code>), picks up the request and creates the wildcard DNS entry <code>*.gsicdc.mydomain.io</code> with a time to live of 120sec at your DNS provider. My provider Cloud Flare is very very quick (as opposed to some other services). You should be able to verify the entry with <code>dig lovemygardener.gsicdc.mydomain.io</code> within seconds.</li><li>The <a href=https://github.com/gardener/cert-management/blob/master/README.md>Certificate Management</a> picks up the request as well and initates a DNS01 protocol exchange with Let&rsquo;s Encrypt; using the staging environment referred to with the issuer behind <code>mydomain-staging</code>.</li><li>After aproximately 70sec (give and take) you will receive the wildcard certificate in the <code>wildcard-tls</code> secret in the namespace <code>istio-system</code>.</li></ol><div class="alert alert-info" role=alert>Notice, that the namespace for the certificate secret is often the cause of many troubeshooting sessions: the secret must reside in the same namespace of the gateway.</div><p>Here is the istio-install script:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ export domainname=<span style=color:#a31515>&#34;*.gsicdc.mydomain.io&#34;</span>
$ export issuer=<span style=color:#a31515>&#34;mydomain-staging&#34;</span>

$ cat <span style=color:#a31515>&lt;&lt;EOF | istioctl install -y -f -
</span><span style=color:#a31515>apiVersion: install.istio.io/v1alpha1
</span><span style=color:#a31515>kind: IstioOperator
</span><span style=color:#a31515>spec:
</span><span style=color:#a31515>  profile: default
</span><span style=color:#a31515>  components:
</span><span style=color:#a31515>    ingressGateways:
</span><span style=color:#a31515>    - name: istio-ingressgateway
</span><span style=color:#a31515>      enabled: true
</span><span style=color:#a31515>      k8s:
</span><span style=color:#a31515>        serviceAnnotations:
</span><span style=color:#a31515>          cert.gardener.cloud/issuer: &#34;${issuer}&#34;
</span><span style=color:#a31515>          cert.gardener.cloud/secretname: wildcard-tls
</span><span style=color:#a31515>          dns.gardener.cloud/class: garden
</span><span style=color:#a31515>          dns.gardener.cloud/dnsnames: &#34;${domainname}&#34;
</span><span style=color:#a31515>          dns.gardener.cloud/ttl: &#34;120&#34; 
</span><span style=color:#a31515>EOF</span>
</code></pre></div><p>Verify that setup is working and that DNS and certificates have been created/delivered:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl -n istio-system describe service istio-ingressgateway
&lt;snip&gt;
Events:
  Type    Reason                Age                From                     Message
  ----    ------                ----               ----                     -------
  Normal  EnsuringLoadBalancer  58s                service-controller       Ensuring load balancer
  Normal  reconcile             58s                cert-controller-manager  created certificate object istio-system/istio-ingressgateway-service-pwqdm
  Normal  cert-annotation       58s                cert-controller-manager  wildcard-tls: cert request is pending
  Normal  cert-annotation       54s                cert-controller-manager  wildcard-tls: certificate pending: certificate requested, preparing/waiting <span style=color:#00f>for</span> successful DNS01 challenge
  Normal  cert-annotation       28s                cert-controller-manager  wildcard-tls: certificate ready
  Normal  EnsuredLoadBalancer   26s                service-controller       Ensured load balancer
  Normal  reconcile             26s                dns-controller-manager   created dns entry object shoot--core--gsicdc/istio-ingressgateway-service-p9qqb
  Normal  dns-annotation        26s                dns-controller-manager   *.gsicdc.mydomain.io: dns entry is pending
  Normal  dns-annotation        21s (x3 over 21s)  dns-controller-manager   *.gsicdc.mydomain.io: dns entry active

$ dig lovemygardener.gsicdc.mydomain.io

; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; lovemygardener.gsicdc.mydomain.io
&lt;snip&gt;
;; ANSWER SECTION:
lovemygardener.gsicdc.mydomain.io. 120 IN A	35.195.120.62
&lt;snip&gt;
</code></pre></div><p>There you have it, the wildcard-tls certificate is ready and the *.gsicdc.mydomain.io dns entry is active. Traffic will be going your way.</p><h2 id=handy-tools-to-install>Handy tools to install</h2><p>Another set of fine tools to use are <a href=https://get-kapp.io/>kapp</a> (formerly known as k14s), <a href=https://k9scli.io/>k9s</a> and <a href=https://httpie.org/>HTTPie</a>. While we are at it, let&rsquo;s install them all. If you are on a Mac, I recommend:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>brew tap vmware-tanzu/carvel
brew install ytt kbld kapp kwt imgpkg vendir
brew install derailed/k9s/k9s
brew install httpie
</code></pre></div><h2 id=ingress-to-your-service>Ingress to your service</h2><div class="alert alert-info" role=alert>Networking is a central part of Kubernetes, but it can be challenging to understand exactly how it is expected to work. You should learn about Kubernetes networking, and first try to debug problems yourself. With a solid managed cluster from Gardener, it is always PEBCAK!</div><p>Kubernetes Ingress is a subject that is evolving to much broader standard. Please watch <a href="https://www.youtube.com/watch?v=cduG0FrjdJA">Evolving the Kubernetes Ingress APIs to GA and Beyond</a> for a good introduction. In this example, I did not want to use the Kubernetes <code>Ingress</code> compatibility option of Istio. Instead, I used <code>VirtualService</code> and <code>Gateway</code> from the Istio&rsquo;s API group <code>networking.istio.io/v1beta1</code> directly, and enabled istio-injection generically for the namespace.</p><p>I use <a href=https://httpbin.org/>httpbin</a> as service that I want to expose to the internet, or where my ingress should be routed to (depends on your point of view, I guess).</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    istio-injection: enabled
---
apiVersion: v1
kind: Service
metadata:
  name: httpbin
  namespace: production
  labels:
    app: httpbin
spec:
  ports:
  - name: http
    port: 8000
    targetPort: 80
  selector:
    app: httpbin
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: httpbin
  namespace: production
spec:
  replicas: 1
  selector:
    matchLabels:
      app: httpbin
  template:
    metadata:
      labels:
        app: httpbin
    spec:
      containers:
      - image: docker.io/kennethreitz/httpbin
        imagePullPolicy: IfNotPresent
        name: httpbin
        ports:
        - containerPort: 80
---
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: httpbin-gw
  namespace: production
spec:
  selector:
    istio: ingressgateway <span style=color:green>#! use istio default ingress gateway</span>
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    tls:
      httpsRedirect: <span style=color:#00f>true</span>
    hosts:
    - <span style=color:#a31515>&#34;httpbin.gsicdc.mydomain.io&#34;</span>
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: wildcard-tls
    hosts:
    - <span style=color:#a31515>&#34;httpbin.gsicdc.mydomain.io&#34;</span>
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: httpbin-vs
  namespace: production
spec:
  hosts:
  - <span style=color:#a31515>&#34;httpbin.gsicdc.mydomain.io&#34;</span>
  gateways:
  - httpbin-gw
  http:
  - match:
    - uri:
        regex: /.*
    route:
    - destination:
        port:
          number: 8000
        host: httpbin
---
</code></pre></div><p>Let us now deploy the whole package of Kubernetes primitives using <code>kapp</code>:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kapp deploy -a httpbin -f httpbin-kapp.yaml
Target cluster <span style=color:#a31515>&#39;https://api.gsicdc.myproject.shoot.devgarden.cloud&#39;</span> (nodes: shoot--myproject--gsicdc-my-workerpool-z1-6586c8f6cb-x24kh)

Changes

Namespace   Name        Kind            Conds.  Age  Op      Wait to    Rs  Ri
(cluster)   production  Namespace       -       -    create  reconcile  -   -
production  httpbin     Deployment      -       -    create  reconcile  -   -
^           httpbin     Service         -       -    create  reconcile  -   -
^           httpbin-gw  Gateway         -       -    create  reconcile  -   -
^           httpbin-vs  VirtualService  -       -    create  reconcile  -   -

Op:      5 create, 0 delete, 0 update, 0 noop
Wait to: 5 reconcile, 0 delete, 0 noop

Continue? [yN]: y

5:36:31PM: ---- applying 1 changes [0/5 <span style=color:#00f>done</span>] ----
&lt;snip&gt;
5:37:00PM: ok: reconcile deployment/httpbin (apps/v1) namespace: production
5:37:00PM: ---- applying complete [5/5 <span style=color:#00f>done</span>] ----
5:37:00PM: ---- waiting complete [5/5 <span style=color:#00f>done</span>] ----

Succeeded
</code></pre></div><p>Let&rsquo;s finaly test the service (Of course you can use the browser as well):</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ http httpbin.gsicdc.mydomain.io
HTTP/1.1 301 Moved Permanently
content-length: 0
date: Wed, 13 May 2020 21:29:13 GMT
location: https://httpbin.gsicdc.mydomain.io/
server: istio-envoy

$ curl -k https://httpbin.gsicdc.mydomain.io/ip
{
    <span style=color:#a31515>&#34;origin&#34;</span>: <span style=color:#a31515>&#34;10.250.0.2&#34;</span>
}
</code></pre></div><p>Quod erat demonstrandum.
The proof of exchanging the issuer is now left to the reader.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Tip</h4>Remember that the certificate is actually not valid because it is issued from the Let's encrypt staging environment. Thus, we needed "curl -k" or "http --verify no".</div><p>Hint: use the interactive k9s tool.
<img src=/__resources/k9s_5b92ae.png alt=k9s></p><h2 id=cleanup>Cleanup</h2><p>Remove the cloud native application:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kapp ls
Apps in namespace <span style=color:#a31515>&#39;default&#39;</span>

Name     Namespaces            Lcs   Lca
httpbin  (cluster),production  true  17m

$ kapp delete -a httpbin
...
Continue? [yN]: y
...
11:47:47PM: ---- waiting complete [8/8 <span style=color:#00f>done</span>] ----

Succeeded
</code></pre></div><p>Remove Istio:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ istioctl x uninstall --purge
clusterrole.rbac.authorization.k8s.io <span style=color:#a31515>&#34;prometheus-istio-system&#34;</span> deleted
clusterrolebinding.rbac.authorization.k8s.io <span style=color:#a31515>&#34;prometheus-istio-system&#34;</span> deleted
...
</code></pre></div><p>Delete your Shoot:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kgarden annotate shoot gsicdc confirmation.gardener.cloud/deletion=true --overwrite
kgarden delete shoot gsicdc --wait=false
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-d8df150994f505e48131ac2122a9c747>1.2 - Request Cert</h1><h1 id=request-x509-certificates>Request X.509 Certificates</h1><h2 id=introduction>Introduction</h2><p>Dealing with applications on Kubernetes which offer service endpoints (e.g. HTTP) may also require you to enable a
secured communication via SSL/TLS. Gardener let&rsquo;s you request a commonly trusted X.509 certificate for your application
endpoint. Furthermore, Gardener takes care about the renewal process for your requested certificate.</p><p>Let&rsquo;s get the basics straight first. If this is too long for you, you can read below how to get certificates by</p><ul><li><a href=#request-a-certificate-via-certificate>Certificate Resources</a></li><li><a href=#request-a-certificate-via-ingress>Ingress</a></li><li><a href=#request-a-certificate-via-service>Service</a></li></ul><h2 id=restrictions>Restrictions</h2><h3 id=service-scope>Service Scope</h3><p>This service enables users to request managed X.509 certificates with the help of <a href=https://tools.ietf.org/html/rfc8555>ACME</a> and <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a>.
It <strong>does not</strong> equip or manage DNS records for cluster assets like <code>Services</code> or <code>Ingresses</code>. Thus, you can obtain a valid certificate but your service might still not be resolvable or reachable due to missing DNS configuration. Please consult <a href=https://github.com/gardener/gardener-extension-shoot-dns-service/tree/master/docs/usage/dns_names.md>this page</a> if your services require managed DNS records.</p><h3 id=supported-domains>Supported Domains</h3><p>Certificates may be obtained for any subdomain of your shoot&rsquo;s domain (see <code>.spec.dns.domain</code> of your shoot resource) with the default <code>issuer</code>. For custom domains, please consult <a href=#Custom-Domains>custom domains</a>.</p><h3 id=character-restrictions>Character Restrictions</h3><p>Due to the ACME protocol specification, at least one domain of the domains you request a certificate for must not exceed a character limit of 64 (CN - Common Name).</p><p>For example, the following request is invalid:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: cert.gardener.cloud/v1alpha1
kind: Certificate
metadata:
  name: cert-invalid
  namespace: default
spec:
  commonName: morethan64characters.ingress.shoot.project.default-domain.gardener.cloud
</code></pre></div><p>But it is valid to request a certificate for this domain if you have at least one domain which does not exceed the mentioned limit:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: cert.gardener.cloud/v1alpha1
kind: Certificate
metadata:
  name: cert-example
  namespace: default
spec:
  commonName: short.ingress.shoot.project.default-domain.gardener.cloud
  dnsNames:
  - morethan64characters.ingress.shoot.project.default-domain.gardener.cloud
</code></pre></div><h2 id=certificate-resources>Certificate Resources</h2><p>Every X.509 certificate is represented by a Kubernetes custom resource <code>certificate.cert.gardener.cloud</code> in your cluster. A <code>Certificate</code> resource may be used to initiate a new certificate request as well as to manage its lifecycle. Gardener&rsquo;s certificate service regularly checks the expiration timestamp of Certificates, triggers a renewal process if necessary and replaces the existing X.509 certificate with a new one.</p><blockquote><p>Your application should be able to reload replaced certificates in a timely manner to avoid service disruptions.</p></blockquote><p>Certificates can either be requested by creating <code>Certificate</code> resources in the Kubernetes cluster or by configuring <code>Ingress</code> or <code>Service</code> (type <code>LoadBalancer</code>) resources. If the latter is used, a <code>Certificate</code> resource will automatically be created by Gardener&rsquo;s certificate service.</p><p>If you&rsquo;re interested in the current progress of your request, you&rsquo;re advised to consult the <code>Certificate</code>&rsquo;s <code>status</code> subresource. You&rsquo;ll also find error descriptions in the <code>status</code> in case the issuance failed.</p><p>Certificate status example:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: cert.gardener.cloud/v1alpha1
kind: Certificate
...
status:
  commonName: short.ingress.shoot.project.default-domain.gardener.cloud
  expirationDate: <span style=color:#a31515>&#34;2020-02-27T15:39:10Z&#34;</span>
  issuerRef:
    name: garden
    namespace: shoot--foo--bar
  lastPendingTimestamp: <span style=color:#a31515>&#34;2019-11-29T16:38:40Z&#34;</span>
  observedGeneration: 11
  state: Ready
</code></pre></div><h2 id=custom-domains>Custom Domains</h2><p>If you want to request certificates for domains other then any subdomain of <code>shoot.spec.dns.domain</code>, the following configuration is required:</p><h3 id=dns-provider>DNS provider</h3><p>In order to issue certificates for a custom domain you need to specify a DNS provider which is permitted to create DNS records for subdomains of your requested domain in the certificate. For example, if you request a certificate for <code>host.example.com</code> your DNS provider must be capable of managing subdomains of <code>host.example.com</code>.</p><p>DNS providers are normally specified in the shoot manifest.</p><p>If the <code>DNSProvider</code> replication feature is enabled, an provider can alternatively defined in
the shoot cluster.</p><h4 id=provider-in-the-shoot-manifest>Provider in the shoot manifest</h4><p>Example for a provider in the shoot manifest:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>kind: Shoot
...
spec:
  dns:
    providers:
    - type: aws-route53 <span style=color:green># consult the DNS provisioning controllers group (dnscontrollers) in https://github.com/gardener/external-dns-management#using-the-dns-controller-manager for possible values</span>
      secretName: provider-example-com <span style=color:green># contains credentials for service account, see any 20-secret-&lt;provider&gt;-credentials.yaml in https://github.com/gardener/external-dns-management/tree/master/examples</span>
</code></pre></div><p>The secret referenced by <code>secretName</code> can also be conveniently created via the Gardener dashboard.</p><h4 id=provider-resouce-in-the-shoot-cluster>Provider resouce in the shoot cluster</h4><p><em>Prerequiste</em>: The <code>DNSProvider</code> replication feature has to be enabled.
It is either enabled globally in the <code>ControllerDeployment</code> or in the shoot manifest
with:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>...
spec:
  extensions:
    - type: shoot-dns-service
      providerConfig:
        apiVersion: service.dns.extensions.gardener.cloud/v1alpha1
        kind: DNSConfig
        dnsProviderReplication:
          enabled: <span style=color:#00f>true</span>
...
</code></pre></div><p>Example for specifying a <code>DNSProvider</code> resource and its <code>Secret</code> in any namespace of the shoot cluster:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: dns.gardener.cloud/v1alpha1
kind: DNSProvider
metadata:
  annotations:
    dns.gardener.cloud/class: garden  
  name: my-own-domain
  namespace: my-namespace
spec:
  type: aws-route53
  secretRef:
    name: my-own-domain-credentials
  domains:
    include:
    - my.own.domain.com
---
apiVersion: v1
kind: Secret
metadata:
  name: my-own-domain-credentials
  namespace: my-namespace
type: Opaque
data:
  <span style=color:green># replace &#39;...&#39; with values encoded as base64</span>
  AWS_ACCESS_KEY_ID: ...
  AWS_SECRET_ACCESS_KEY: ...
</code></pre></div><h3 id=issuer>Issuer</h3><p>Another prerequisite to request certificates for custom domains is a dedicated issuer.</p><p>Note: This is only needed if the default issuer provided by Gardener is restricted to shoot related domains or you are using
domain names not visible to public DNS servers. You may therefore try first without defining an own issuer.</p><p>The custom issuers are specified normally in the shoot manifest.</p><p>If the <code>shootIssuers</code> feature is enabled, it can alternatively be defined in the shoot cluster.</p><h4 id=issuer-in-the-shoot-manifest>Issuer in the shoot manifest</h4><p>Example for an issuer in the shoot manifest:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>kind: Shoot
...
spec:
  extensions:
  - type: shoot-cert-service
    providerConfig:
      apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
      kind: CertConfig
      issuers:
        - email: your-email@example.com
          name: custom-issuer <span style=color:green># issuer name must be specified in every custom issuer request, must not be &#34;garden&#34;</span>
          server: <span style=color:#a31515>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span>
          privateKeySecretName: my-privatekey <span style=color:green># referenced resource, the private key must be stored in the secret at `data.privateKey`</span>
      <span style=color:green>#shootIssuers:</span>
      <span style=color:green>#  enabled: true # if true, allows to specify issuers in the shoot cluster</span>

      <span style=color:green>#precheckNameservers: &#34;10.0.0.53,10.123.56.53,8.8.8.8&#34; # optional comma separated list of DNS server IP addresses if public DNS servers are not sufficient for prechecking DNS challenges</span>

  resources:
  - name: my-privatekey
    resourceRef:
      apiVersion: v1
      kind: Secret
      name: custom-issuer-privatekey <span style=color:green># name of secret in Gardener project</span>
</code></pre></div><p>If you are using an ACME provider for private domains, you may need to change the nameservers used for
checking the availability of the DNS challenge&rsquo;s TXT record before the certificate is requested from the ACME provider.
By default, only public DNS servers may be used for this purpose.
At least one of the <code>precheckNameservers</code> must be able to resolve the private domain names.</p><h4 id=heading></h4><p><em>Prerequiste</em>: The <code>shootIssuers</code> feature has to be enabled.
It is either enabled globally in the <code>ControllerDeployment</code> or in the shoot manifest
with:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>kind: Shoot
...
spec:
  extensions:
  - type: shoot-cert-service
    providerConfig:
      apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
      kind: CertConfig
      shootIssuers:
        enabled: <span style=color:#00f>true</span> <span style=color:green># if true, allows to specify issuers in the shoot cluster</span>
...
</code></pre></div><p>Example for specifying an <code>Issuer</code> resource and its <code>Secret</code> directly in any
namespace of the shoot cluster:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: cert.gardener.cloud/v1alpha1
kind: Issuer
metadata:
  name: my-own-issuer
  namespace: my-namespace
spec:
  acme:
    domains:
      include:
      - my.own.domain.com
    email: some.user@my.own.domain.com
    privateKeySecretRef:
      name: my-own-issuer-secret
      namespace: my-namespace
    server: https://acme-v02.api.letsencrypt.org/directory
---
apiVersion: v1
kind: Secret
metadata:
  name: my-own-issuer-secret
  namespace: my-namespace
type: Opaque
data:
  privateKey: ... <span style=color:green># replace &#39;...&#39; with valus encoded as base64</span>
</code></pre></div><h2 id=examples>Examples</h2><h3 id=request-a-certificate-via-certificate>Request a certificate via Certificate</h3><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: cert.gardener.cloud/v1alpha1
kind: Certificate
metadata:
  name: cert-example
  namespace: default
spec:
  commonName: short.ingress.shoot.project.default-domain.gardener.cloud
  dnsNames:
  - morethan64characters.ingress.shoot.project.default-domain.gardener.cloud
  secretRef:
    name: cert-example
    namespace: default
<span style=color:green># issuerRef:</span>
<span style=color:green>#   name: custom-issuer</span>
</code></pre></div><table><thead><tr><th style=text-align:left>Path</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>spec.commonName</code> (required)</td><td style=text-align:left>Specifies for which domain the certificate request will be created. This entry must comply with the <a href=#Character-Restrictions>64 character</a> limit.</td></tr><tr><td style=text-align:left><code>spec.dnsName</code></td><td style=text-align:left>Additional domains the certificate should be valid for. Entries in this list can be longer than 64 characters.</td></tr><tr><td style=text-align:left><code>spec.secretRef</code></td><td style=text-align:left>Specifies the secret which contains the certificate/key pair. If the secret is not available yet, it&rsquo;ll be created automatically as soon as the X.509 certificate has been issued.</td></tr><tr><td style=text-align:left><code>spec.issuerRef</code></td><td style=text-align:left>Specifies the issuer you want to use. Only necessary if you request certificates for <a href=#Custom-Domains>custom domains</a>.</td></tr></tbody></table><h3 id=request-a-wildcard-certificate-via-certificate>Request a wildcard certificate via Certificate</h3><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: cert.gardener.cloud/v1alpha1
kind: Certificate
metadata:
  name: cert-wildcard
  namespace: default
spec:
  commonName: <span style=color:#a31515>&#39;*.ingress.shoot.project.default-domain.gardener.cloud&#39;</span>
  secretRef:
    name: cert-wildcard
    namespace: default
<span style=color:green># issuerRef:</span>
<span style=color:green>#   name: custom-issuer</span>
</code></pre></div><table><thead><tr><th style=text-align:left>Path</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>spec.commonName</code> (required)</td><td style=text-align:left>Specifies for which domain the certificate request will be created. This entry must comply with the <a href=#Character-Restrictions>64 character</a> limit.</td></tr><tr><td style=text-align:left><code>spec.secretRef</code></td><td style=text-align:left>Specifies the secret which contains the certificate/key pair. If the secret is not available yet, it&rsquo;ll be created automatically as soon as the X.509 certificate has been issued.</td></tr><tr><td style=text-align:left><code>spec.issuerRef</code></td><td style=text-align:left>Specifies the issuer you want to use. Only necessary if you request certificates for <a href=#Custom-Domains>custom domains</a>.</td></tr></tbody></table><h3 id=request-a-certificate-via-ingress>Request a certificate via Ingress</h3><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: vuejs-ingress
  annotations:
    cert.gardener.cloud/purpose: managed
  <span style=color:green># cert.gardener.cloud/issuer: custom-issuer</span>
spec:
  tls:
  <span style=color:green># Must not exceed 64 characters.</span>
  - hosts:
    - short.ingress.shoot.project.default-domain.gardener.cloud
    - morethan64characters.ingress.shoot.project.default-domain.gardener.cloud
    <span style=color:green># Certificate and private key reside in this secret.</span>
    secretName: testsecret-tls
  rules:
  - host: morethan64characters.ingress.shoot.project.default-domain.gardener.cloud
    http:
      paths:
      - backend:
          serviceName: vuejs-svc
          servicePort: 8080
</code></pre></div><table><thead><tr><th style=text-align:left>Path</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>metadata.annotations</code></td><td style=text-align:left>Annotations should have <code>cert.gardener.cloud/purpose: managed</code> to activate the certificate service on this resource. <code>cert.gardener.cloud/issuer: &lt;name></code> is optional and may be specified if the certificate is request for a <a href=#Custom-Domains>custom domains</a>.</td></tr><tr><td style=text-align:left><code>spec.tls[].hosts</code></td><td style=text-align:left>Specifies for which domains the certificate request will be created. The first entry is always taken to fill the <code>Common Name</code> field and must therefore comply with the <a href=#Character-Restrictions>64 character</a> limit.</td></tr><tr><td style=text-align:left><code>spec.tls[].secretName</code></td><td style=text-align:left>Specifies the secret which contains the certificate/key pair to be used by this Ingress. If the secret is not available yet, it&rsquo;ll be created automatically as soon as the certificate has been issued. Once configured, you&rsquo;re not advised to change the name while the Ingress is still managed by the certificate service.</td></tr></tbody></table><h3 id=request-a-wildcard-certificate-via-ingress>Request a wildcard certificate via Ingress</h3><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: vuejs-ingress
  annotations:
    cert.gardener.cloud/purpose: managed
  <span style=color:green># cert.gardener.cloud/issuer: custom-issuer</span>
spec:
  tls:
  <span style=color:green># Must not exceed 64 characters.</span>
  - hosts:
    - <span style=color:#a31515>&#34;*.ingress.shoot.project.default-domain.gardener.cloud&#34;</span>
    <span style=color:green># Certificate and private key reside in this secret.</span>
    secretName: testsecret-tls
  rules:
  - host: morethan64characters.ingress.shoot.project.default-domain.gardener.cloud
    http:
      paths:
      - backend:
          serviceName: vuejs-svc
          servicePort: 8080
</code></pre></div><blockquote><p>Domains must not overlap when requesting a wildcard certificate. For example, requests for <code>*.example.com</code> must not contain <code>foo.example.com</code> at the same time.</p></blockquote><table><thead><tr><th style=text-align:left>Path</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>metadata.annotations</code></td><td style=text-align:left>Annotations should have <code>cert.gardener.cloud/purpose: managed</code> to activate the certificate service on this resource. <code>cert.gardener.cloud/issuer: &lt;name></code> is optional and may be specified if the certificate is request for a <a href=#Custom-Domains>custom domains</a>.</td></tr><tr><td style=text-align:left><code>spec.tls[].hosts</code></td><td style=text-align:left>Specifies for which domains the certificate request will be created. The first entry is always taken to fill the <code>Common Name</code> field and must therefore comply with the <a href=#Character-Restrictions>64 character</a> limit.</td></tr><tr><td style=text-align:left><code>spec.tls[].secretName</code></td><td style=text-align:left>Specifies the secret which contains the certificate/key pair to be used by this Ingress. If the secret is not available yet, it&rsquo;ll be created automatically as soon as the certificate has been issued. Once configured, you&rsquo;re not advised to change the name while the Ingress is still managed by the certificate service.</td></tr></tbody></table><h3 id=request-a-certificate-via-service>Request a certificate via Service</h3><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: v1
kind: Service
metadata:
  annotations:
    cert.gardener.cloud/secretname: test-service-secret
  <span style=color:green># cert.gardener.cloud/issuer: custom-issuer</span>
    dns.gardener.cloud/dnsnames: <span style=color:#a31515>&#34;service.shoot.project.default-domain.gardener.cloud, morethan64characters.svc.shoot.project.default-domain.gardener.cloud&#34;</span>
    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;600&#34;</span>
  name: test-service
  namespace: default
spec:
  ports:
    - name: http
      port: 80
      protocol: TCP
      targetPort: 8080
  type: LoadBalancer
</code></pre></div><table><thead><tr><th style=text-align:left>Path</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>metadata.annotations[cert.gardener.cloud/secretname]</code></td><td style=text-align:left>Specifies the secret which contains the certificate/key pair. If the secret is not available yet, it&rsquo;ll be created automatically as soon as the certificate has been issued.</td></tr><tr><td style=text-align:left><code>metadata.annotations[cert.gardener.cloud/issuer]</code></td><td style=text-align:left>Optional and may be specified if the certificate is request for a <a href=#Custom-Domains>custom domains</a>.</td></tr><tr><td style=text-align:left><code>metadata.annotations[dns.gardener.cloud/dnsnames]</code></td><td style=text-align:left>Specifies for which domains the certificate request will be created. The first entry is always taken to fill the <code>Common Name</code> field and must therefore comply with the <a href=#Character-Restrictions>64 character</a> limit.</td></tr></tbody></table><h3 id=request-a-wildcard-certificate-via-service>Request a wildcard certificate via Service</h3><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: v1
kind: Service
metadata:
  annotations:
    cert.gardener.cloud/secretname: test-service-secret
  <span style=color:green># cert.gardener.cloud/issuer: custom-issuer</span>
    dns.gardener.cloud/dnsnames: <span style=color:#a31515>&#34;*.service.shoot.project.default-domain.gardener.cloud&#34;</span>
    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;600&#34;</span>
  name: test-service
  namespace: default
spec:
  ports:
    - name: http
      port: 80
      protocol: TCP
      targetPort: 8080
  type: LoadBalancer
</code></pre></div><blockquote><p>Domains must not overlap when requesting a wildcard certificate. For example, requests for <code>*.example.com</code> must not contain <code>foo.example.com</code> at the same time.</p></blockquote><table><thead><tr><th style=text-align:left>Path</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>metadata.annotations[cert.gardener.cloud/secretname]</code></td><td style=text-align:left>Specifies the secret which contains the certificate/key pair. If the secret is not available yet, it&rsquo;ll be created automatically as soon as the certificate has been issued.</td></tr><tr><td style=text-align:left><code>metadata.annotations[cert.gardener.cloud/issuer]</code></td><td style=text-align:left>Optional and may be specified if the certificate is request for a <a href=#Custom-Domains>custom domains</a>.</td></tr><tr><td style=text-align:left><code>metadata.annotations[dns.gardener.cloud/dnsnames]</code></td><td style=text-align:left>Specifies for which domains the certificate request will be created. The first entry is always taken to fill the <code>Common Name</code> field and must therefore comply with the <a href=#Character-Restrictions>64 character</a> limit.</td></tr></tbody></table><h2 id=quotas>Quotas</h2><p>For security reasons there may be a default quota on the certificate requests per day set globally in the controller
registration of the shoot-cert-service.</p><p>The default quota only applies if there is no explicit quota defined for the issuer itself with the field
<code>requestsPerDayQuota</code>, e.g.:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>kind: Shoot
...
spec:
  extensions:
  - type: shoot-cert-service
    providerConfig:
      apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
      kind: CertConfig
      issuers:
        - email: your-email@example.com
          name: custom-issuer <span style=color:green># issuer name must be specified in every custom issuer request, must not be &#34;garden&#34;</span>
          server: <span style=color:#a31515>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span>
          requestsPerDayQuota: 10
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5414c77c31206a3d115894d74244106d>1.3 - Setup</h1><h1 id=gardener-certificate-management>Gardener Certificate Management</h1><h2 id=introduction>Introduction</h2><p>Gardener comes with an extension that enables shoot owners to request X.509 compliant certificates for shoot domains.</p><h2 id=extension-installation>Extension Installation</h2><p>The <code>Shoot-Cert-Service</code> extension can be deployed and configured via Gardener&rsquo;s native resource <a href=/docs/gardener/extensions/controllerregistration/>ControllerRegistration</a>.</p><h3 id=prerequisites>Prerequisites</h3><p>To let the <code>Shoot-Cert-Service</code> operate properly, you need to have:</p><ul><li>a <a href=https://github.com/gardener/external-dns-management>DNS service</a> in your seed</li><li>contact details and optionally a private key for a pre-existing <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a> account</li></ul><h3 id=controllerregistration>ControllerRegistration</h3><p>An example of a <code>ControllerRegistration</code> for the <code>Shoot-Cert-Service</code> can be found here: <a href=https://github.com/gardener/gardener-extension-shoot-cert-service/blob/master/example/controller-registration.yaml>https://github.com/gardener/gardener-extension-shoot-cert-service/blob/master/example/controller-registration.yaml</a></p><p>The <code>ControllerRegistration</code> contains a Helm chart which eventually deploy the <code>Shoot-Cert-Service</code> to seed clusters. It offers some configuration options, mainly to set up a default issuer for shoot clusters. With a default issuer, pre-existing Let&rsquo;s Encrypt accounts can be used and shared with shoot clusters (See &ldquo;One Account or Many?&rdquo; of the <a href=https://letsencrypt.org/docs/integration-guide/>Integration Guide</a>).</p><blockquote><p>Please keep the Let&rsquo;s Encrypt <a href=https://letsencrypt.org/docs/rate-limits/>Rate Limits</a> in mind when using this shared account model. Depending on the amount of shoots and domains it is recommended to use an account with increased rate limits.</p></blockquote><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: core.gardener.cloud/v1beta1
kind: ControllerRegistration
...
  values:
    certificateConfig:
      defaultIssuer:
        acme:
            email: foo@example.com
            privateKey: |-<span style=color:#a31515>
</span><span style=color:#a31515>            -----BEGIN RSA PRIVATE KEY-----
</span><span style=color:#a31515>            ...
</span><span style=color:#a31515>            -----END RSA PRIVATE KEY-----
</span><span style=color:#a31515>            server: https://acme-v02.api.letsencrypt.org/directory</span>            
        name: default-issuer
<span style=color:green>#       restricted: true # restrict default issuer to any sub-domain of shoot.spec.dns.domain</span>

<span style=color:green>#     defaultRequestsPerDayQuota: 50</span>

<span style=color:green>#     precheckNameservers: 8.8.8.8,8.8.4.4</span>

<span style=color:green>#     caCertificates: | # optional custom CA certificates when using private ACME provider</span>
<span style=color:green>#     -----BEGIN CERTIFICATE-----</span>
<span style=color:green>#     ...</span>
<span style=color:green>#     -----END CERTIFICATE-----</span>
<span style=color:green>#</span>
<span style=color:green>#     -----BEGIN CERTIFICATE-----</span>
<span style=color:green>#     ...</span>
<span style=color:green>#     -----END CERTIFICATE-----</span>

      shootIssuers:
        enabled: <span style=color:#00f>false</span> <span style=color:green># if true, allows to specify issuers in the shoot clusters</span>

</code></pre></div><h4 id=enablement>Enablement</h4><p>If the <code>Shoot-Cert-Service</code> should be enabled for every shoot cluster in your Gardener managed environment, you need to globally enable it in the <code>ControllerRegistration</code>:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: core.gardener.cloud/v1beta1
kind: ControllerRegistration
...
  resources:
  - globallyEnabled: <span style=color:#00f>true</span>
    kind: Extension
    type: shoot-cert-service
</code></pre></div><p>Alternatively, you&rsquo;re given the option to only enable the service for certain shoots:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>kind: Shoot
apiVersion: core.gardener.cloud/v1beta1
...
spec:
  extensions:
  - type: shoot-cert-service
...
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4773e80fa0a0952ed75e41786df93e8c>2 - DNS services</h1><div class=lead>Gardener extension controller for DNS services for shoot clusters</div><h1 id=gardener-extension-for-dns-serviceshttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for DNS services</a></h1><p><a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-shoot-dns-service-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-shoot-dns-service-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-shoot-dns-service><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-shoot-dns-service alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service. Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>. However, the project has grown to a size where it is very hard to extend, maintain, and test. With <a href=/docs/gardener/proposals/01-extensibility/>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics. This way, we can keep Gardener core clean and independent.</p><h2 id=extension-resources>Extension-Resources</h2><p>Example extension resource:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: extensions.gardener.cloud/v1alpha1
kind: Extension
metadata:
  name: <span style=color:#a31515>&#34;extension-dns-service&#34;</span>
  namespace: shoot--project--abc
spec:
  type: shoot-dns-service
</code></pre></div><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally</h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the kubeconfig to the cluster you want to connect to ready in the <code>./dev/kubeconfig</code> file.
Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support</h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-dns-service/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!</h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=/docs/gardener/proposals/01-extensibility/>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-239831692757463bc316d892218e20f9>2.1 - Dns Names</h1><h1 id=request-dns-names-in-shoot-clusters>Request DNS Names in Shoot Clusters</h1><h2 id=introduction>Introduction</h2><p>Within a shoot cluster, it is possible to request DNS records via the following resource types:</p><ul><li><a href=https://kubernetes.io/docs/concepts/services-networking/ingress/>Ingress</a></li><li><a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a></li><li><a href=https://github.com/gardener/external-dns-management/blob/master/examples/40-entry-dns.yaml>DNSEntry</a></li></ul><p>It is necessary that the Gardener installation your shoot cluster runs in is equipped with a <code>shoot-dns-service</code> extension. This extension uses the seed&rsquo;s dns management infrastructure to maintain DNS names for shoot clusters. Please ask your Gardener operator if the extension is available in your environment.</p><h2 id=shoot-feature-gate>Shoot Feature Gate</h2><p>In some Gardener setups the <code>shoot-dns-service</code> extension is not enabled globally and thus must be configured per shoot cluster. Please adapt the shoot specification by the configuration shown below to activate the extension individually.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>kind: Shoot
...
spec:
  extensions:
    - type: shoot-dns-service
...
</code></pre></div><h2 id=dns-providers-domain-scope>DNS providers, domain scope</h2><p>Gardener can only manage DNS records on your behalf if you have proper DNS providers in place. Please consult <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/docs/usage/dns_providers/>this page</a> for more information.</p><h2 id=request-dns-records-via-serviceingress-resources>Request DNS records via Service/Ingress resources</h2><p>To request a DNS name for an Ingress or Service object in the shoot cluster
it must be annotated with the DNS class <code>garden</code> and an annotation denoting
the desired DNS names.</p><p>For a Service (it must have the type <code>LoadBalancer</code>) this looks like this:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: v1
kind: Service
metadata:
  annotations:
    dns.gardener.cloud/class: garden
    dns.gardener.cloud/dnsnames: my.subdomain.for.shootsomain.cloud
  name: my-service
  namespace: default
spec:
  ports:
    - port: 80
      protocol: TCP
      targetPort: 80
  type: LoadBalancer
</code></pre></div><p>The <em>dnsnames</em> annotation accepts a comma-separated list of DNS names, if
multiple names are required.</p><p>For an Ingress, the dns names are already declared in the specification.
Nevertheless the <em>dnsnames</em> annotation must be present. Here a subset of the
dns names of the ingress can be specified. If DNS names for all names are
desired, the value <code>all</code> can be used.</p><p>If one of the accepted dns names is a direct subname of the shoot&rsquo;s ingress
domain, this is already handled by the standard wildcard entry for the ingress
domain. Therefore this name should be excluded from the <em>dnsnames</em> list in the
annotation. If only this dns name is configured in the ingress, no explicit
dns entry is required, and the dns annotations should be omitted at all.</p><h2 id=request-dns-records-via-dnsentry-resources>Request DNS records via DNSEntry resources</h2><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: dns.gardener.cloud/v1alpha1
kind: DNSEntry
metadata:
  annotations:
    dns.gardener.cloud/class: garden
  name: dns
  namespace: default
spec:
  dnsName: <span style=color:#a31515>&#34;my.subdomain.for.shootsomain.cloud&#34;</span>
  ttl: 600
  <span style=color:green># txt records, either text or targets must be specified</span>
<span style=color:green># text:</span>
<span style=color:green># - foo-bar</span>
  targets:
  <span style=color:green># target records (CNAME or A records)</span>
  - 8.8.8.8
</code></pre></div><h2 id=dns-record-events>DNS record events</h2><p>The DNS controller publishes Kubernetes events for the resource which requested the DNS record (Ingress, Service, DNSEntry). These events reveal more information about the DNS requests being processed and are especially useful to check any kind of misconfiguration, e.g. requests for a domain you don&rsquo;t own.</p><p>Events for a successfully created DNS record:</p><pre><code>$ kubectl -n default describe service my-service

Events:
  Type    Reason          Age                From                    Message
  ----    ------          ----               ----                    -------
  Normal  dns-annotation  19s                dns-controller-manager  my.subdomain.for.shootsomain.cloud: dns entry is pending
  Normal  dns-annotation  19s (x3 over 19s)  dns-controller-manager  my.subdomain.for.shootsomain.cloud: dns entry pending: waiting for dns reconciliation
  Normal  dns-annotation  9s (x3 over 10s)   dns-controller-manager  my.subdomain.for.shootsomain.cloud: dns entry active
</code></pre><p>Please note, events vanish after their retention period (usually <code>1h</code>).</p><h2 id=dnsentry-status>DNSEntry status</h2><p><code>DNSEntry</code> resources offer a <code>.status</code> sub-resource which can be used to check the current state of the object.</p><p>Status of a erroneous <code>DNSEntry</code>.</p><pre><code>  status:
    message: No responsible provider found
    observedGeneration: 3
    provider: remote
    state: Error
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-c899528b6cabcab3ac3befed9c9602e1>2.2 - Dns Providers</h1><h1 id=dns-providers>DNS Providers</h1><h2 id=introduction>Introduction</h2><p>Gardener can manage DNS records on your behalf, so that you can request them via different resource types (see <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/docs/usage/dns_names/>here</a>) within the shoot cluster. The domains for which you are permitted to request records, are however restricted and depend on the DNS provider configuration.</p><h2 id=shoot-provider>Shoot provider</h2><p>By default, every shoot cluster is equipped with a default provider. It is the very same provider that manages the shoot cluster&rsquo;s <code>kube-apiserver</code> public DNS record (DNS address in your Kubeconfig).</p><pre><code>kind: Shoot
...
dns:
  domain: shoot.project.default-domain.gardener.cloud
</code></pre><p>You are permitted to request any sub-domain of <code>.dns.domain</code> that is not already taken (e.g. <code>api.shoot.project.default-domain.gardener.cloud</code>, <code>*.ingress.shoot.project.default-domain.gardener.cloud</code>) with this provider.</p><h2 id=additional-providers>Additional providers</h2><p>If you need to request DNS records for domains not managed by the <a href=#Shoot-provider>default provider</a>, additional providers can
be configured in the shoot specification.
Alternatively, if it is enabled, it can be added as <code>DNSProvider</code> resources to the shoot cluster.</p><h3 id=additional-providers-in-the-shoot-specification>Additional providers in the shoot specification</h3><p>To add a providers in the shoot spec, you need set them in the <code>spec.dns.providers</code> list.</p><p>For example:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>kind: Shoot
...
spec:
  dns:
    domain: shoot.project.default-domain.gardener.cloud
    providers:
    - secretName: my-aws-account
      type: aws-route53
    - secretName: my-gcp-account
      type: google-clouddns
</code></pre></div><blockquote><p>Please consult the <a href=https://gardener.cloud/docs/gardener/api-reference/core/#core.gardener.cloud/v1beta1.DNSProvider>API-Reference</a> to get a complete list of supported fields and configuration options.</p></blockquote><p>Referenced secrets should exist in the project namespace in the Garden cluster and must comply with the provider specific credentials format. The <strong>External-DNS-Management</strong> project provides corresponding examples (<a href=https://github.com/gardener/external-dns-management/tree/master/examples>20-secret-&lt;provider-name>-credentials.yaml</a>) for known providers.</p><h3 id=additional-providers-as-resources-in-the-shoot-cluster>Additional providers as resources in the shoot cluster</h3><p>If it is not enabled globally, you have to enable the feature in the shoot manifest:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>Kind: Shoot
...
spec:
  extensions:
    - type: shoot-dns-service
      providerConfig:
        apiVersion: service.dns.extensions.gardener.cloud/v1alpha1
        kind: DNSConfig
        dnsProviderReplication:
          enabled: <span style=color:#00f>true</span>
...
</code></pre></div><p>To add a provider directly in the shoot cluster, provide a <code>DNSProvider</code> in any namespace together
with <code>Secret</code> containing the credentials.</p><p>For example if the domain is hosted with AWS Route 53 (provider type <code>aws-route53</code>):</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: dns.gardener.cloud/v1alpha1
kind: DNSProvider
metadata:
  annotations:
    dns.gardener.cloud/class: garden
  name: my-own-domain
  namespace: my-namespace
spec:
  type: aws-route53
  secretRef:
    name: my-own-domain-credentials
  domains:
    include:
    - my.own.domain.com
---
apiVersion: v1
kind: Secret
metadata:
  name: my-own-domain-credentials
  namespace: my-namespace
type: Opaque
data:
  <span style=color:green># replace &#39;...&#39; with values encoded as base64</span>
  AWS_ACCESS_KEY_ID: ...
  AWS_SECRET_ACCESS_KEY: ...
</code></pre></div><p>The <strong>External-DNS-Management</strong> project provides examples with more details for <code>DNSProviders</code> (30-provider-&lt;provider-name>.yaml)
and credential <code>Secrets</code> (20-secret-&lt;provider-name>.yaml) at <a href=https://github.com/gardener/external-dns-management/tree/master/examples>https://github.com/gardener/external-dns-management//examples</a>
for all supported provider types.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cbae37fec9d116b4ad59b1b4a7edbe19>2.3 - Setup</h1><h1 id=gardener-dns-management-for-shoots>Gardener DNS Management for Shoots</h1><h2 id=introduction>Introduction</h2><p>Gardener allows Shoot clusters to request DNS names for Ingresses and Services out of the box.
To support this the gardener must be installed with the <code>shoot-dns-service</code>
extension.
This extension uses the seed&rsquo;s dns management infrastructure to maintain DNS
names for shoot clusters. So, far only the external DNS domain of a shoot
(already used for the kubernetes api server and ingress DNS names) can be used
for managed DNS names.</p><h2 id=configuration>Configuration</h2><p>A general description for configuring the DNS management of the
gardener can be found <a href=/docs/gardener/extensions/dns/>here</a>.</p><p>To generally enable the DNS management for shoot objects the
<code>shoot-dns-service</code> extension must be registered by providing an
appropriate <a href=https://github.com/gardener/gardener-extension-shoot-dns-service/blob/master/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available
for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots the registration must set the <em>globallyEnabled</em> flag to <code>true</code>.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>spec:
  resources:
    - kind: Extension
      type: shoot-dns-service
      globallyEnabled: <span style=color:#00f>true</span>
</code></pre></div><h3 id=providing-base-domains-usable-for-a-shoot>Providing Base Domains usable for a Shoot</h3><p>So, far only the external DNS domain of a shoot already used
for the kubernetes api server and ingress DNS names can be used for managed
DNS names. This is either the shoot domain as subdomain of the default domain
configured for the gardener installation, or a dedicated domain with dedicated
access credentials configured for a dedicated shoot via the shoot manifest.</p><p>Alternatively, you can specify <code>DNSProviders</code> and its credentials
<code>Secret</code> directly in the shoot, if this feature is enabled.
By default, <code>DNSProvider</code> replication is disabled, but it can be enabled globally in the <code>ControllerDeployment</code>
or for a shoot cluster in the shoot manifest (details see further below).</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: core.gardener.cloud/v1beta1
kind: ControllerDeployment
metadata:
  name: extension-shoot-dns-service
type: helm
providerConfig:
  chart: ...
  values:
    image:
      ...
    dnsProviderReplication:
      enabled: <span style=color:#00f>true</span>
</code></pre></div><p>See <a href=https://github.com/gardener/external-dns-management/tree/master/examples>example files (20-* and 30-*)</a>
for details for the various provider types.</p><h3 id=shoot-feature-gate>Shoot Feature Gate</h3><p>If the shoot DNS feature is not globally enabled by default (depends on the
extension registration on the garden cluster), it must be enabled per shoot.</p><p>To enable the feature for a shoot, the shoot manifest must explicitly add the
<code>shoot-dns-service</code> extension.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>...
spec:
  extensions:
    - type: shoot-dns-service
...
</code></pre></div><h4 id=enabledisable-dns-provider-replication-for-a-shoot>Enable/disable DNS provider replication for a shoot</h4><p>The DNSProvider` replication feature enablement can be overwritten in the
shoot manifest, e.g.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>Kind: Shoot
...
spec:
  extensions:
    - type: shoot-dns-service
      providerConfig:
        apiVersion: service.dns.extensions.gardener.cloud/v1alpha1
        kind: DNSConfig
        dnsProviderReplication:
          enabled: <span style=color:#00f>true</span>
...
</code></pre></div><h3 id=dnsactivation-for-dnsowner>DNSActivation for DNSOwner</h3><p>To support migration of the control plane of shoots, the <code>DNSOwner</code> created and used for all <code>DNSEntries</code> created by the
Shoot-DNS-Service can optionally be activated and deactivated by a DNS record.
If the DNSActivation feature is enabled, the <code>DNSOwner</code> will be only be active if the value of the owner DNS record
managed by Gardener matches the cluster identity of the seed hosting the control plane.
This feature must only be enabled if the Gardener feature gate <code>UseDNSRecords</code> is enabled for all seeds.</p><p>By default this feature is enabled and can be disabled in the controller deployment:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>apiVersion: core.gardener.cloud/v1beta1
kind: ControllerDeployment
metadata:
  name: extension-shoot-dns-service
type: helm
providerConfig:
  chart: ...
  values:
    image:
      ...
    ownerDnsActivation:
      enabled: <span style=color:#00f>false</span>
</code></pre></div></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2022 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity=sha384-uQikAXnCAqsMb3ygtdqBYvcwvHUkzGIpjdGyy9owhURXHUxLC5LgTcSxJQH/RzjK crossorigin=anonymous></script><script src=/js/main.min.ef8e0714aff556fd5a9768ed6ecabd2964dd962cd9f89762a373947bb53bc742.js integrity="sha256-744HFK/1Vv1al2jtbsq9KWTdlizZ+Jdio3OUe7U7x0I=" crossorigin=anonymous></script></body></html>