<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://gardener.cloud/docs/extensions/others/gardener-extension-shoot-rsyslog-relp/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/extensions/others/gardener-extension-shoot-rsyslog-relp/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Node Audit Logging | Gardener</title>
<meta name=description content="Gardener extension controller which configures the rsyslog and auditd services installed on shoot nodes."><meta property="og:url" content="https://gardener.cloud/docs/extensions/others/gardener-extension-shoot-rsyslog-relp/"><meta property="og:site_name" content="Gardener"><meta property="og:title" content="Node Audit Logging"><meta property="og:description" content="Gardener extension controller which configures the rsyslog and auditd services installed on shoot nodes."><meta property="og:locale" content="en_US"><meta property="og:type" content="website"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Node Audit Logging"><meta itemprop=description content="Gardener extension controller which configures the rsyslog and auditd services installed on shoot nodes."><meta itemprop=wordCount content="77"><meta itemprop=image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Node Audit Logging"><meta name=twitter:description content="Gardener extension controller which configures the rsyslog and auditd services installed on shoot nodes."><link rel=preload href=/scss/main.min.52d93bcd446cd63373e35bf3f68b78c63f08370d066ccb303bdd0e25f237661c.css as=style integrity="sha256-Utk7zURs1jNz41vz9ot4xj8INw0GbMswO90OJfI3Zhw=" crossorigin=anonymous><link href=/scss/main.min.52d93bcd446cd63373e35bf3f68b78c63f08370d066ccb303bdd0e25f237661c.css rel=stylesheet integrity="sha256-Utk7zURs1jNz41vz9ot4xj8INw0GbMswO90OJfI3Zhw=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><style>.nav-link:hover{text-decoration:none}.ml-md-auto{margin-left:auto!important}.td-search__icon{color:#fff!important}.td-search__input.form-control::placeholder{color:#fff;border:1px;border-radius:20px}.td-search__input.form-control{border:1px;border-radius:20px}.td-search__input{max-width:90%}.td-search:not(:focus-within){color:#fff!important}</style><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://demo.gardener.cloud target=_blank><span>Demo</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><div class=dropdown><a href=/docs class=nav-link>Documentation</a><div class=dropdown-content><a class=taxonomy-term href=/docs>Users</a>
<a class=taxonomy-term href=/docs>Operators</a>
<a class=taxonomy-term href=/docs>Developers</a>
<a class=taxonomy-term href=/docs>All</a></div></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.118284ff37843555829ad9329f456bb7.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/extensions/others/gardener-extension-shoot-rsyslog-relp/>Return to the regular view of this page</a>.</p></div><h1 class=title>Node Audit Logging</h1><div class=lead>Gardener extension controller which configures the rsyslog and auditd services installed on shoot nodes.</div><div class=content><h1 id=gardener-extension-to-configure-rsyslog-with-relp-modulehttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension to configure rsyslog with relp module</a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-rsyslog-relp><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-rsyslog-relp alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-shoot-rsyslog-relp-main/jobs/main-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-shoot-rsyslog-relp-main/jobs/main-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-shoot-rsyslog-relp><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-shoot-rsyslog-relp alt="Go Report Card"></a></p><p>Gardener extension controller which configures the rsyslog and auditd services installed on shoot nodes.</p><h2 id=usage>Usage</h2><ul><li><a href=/docs/extensions/others/gardener-extension-shoot-rsyslog-relp/configuration/>Configuring the Rsyslog Relp Extension</a> - learn what is the use-case for rsyslog-relp, how to enable it and configure it</li></ul><h2 id=local-setup-and-development>Local Setup and Development</h2><ul><li><a href=/docs/extensions/others/gardener-extension-shoot-rsyslog-relp/getting-started/>Deploying the Rsyslog Relp Extension Locally</a> - learn how to set up a local development environment</li><li><a href=/docs/extensions/others/gardener-extension-shoot-rsyslog-relp/shoot-rsyslog-relp/>Developer Docs for Gardener Shoot Rsyslog Relp Extension</a> - learn about the inner workings</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5ebc3f99478b6244b628fb0367c1bbaa>1 - Configuration</h1><h1 id=configuring-the-rsyslog-relp-extension>Configuring the Rsyslog Relp Extension</h1><h2 id=introduction>Introduction</h2><p>As a cluster owner, you might need audit logs on a Shoot node level. With these audit logs you can track actions on your nodes like privilege escalation, file integrity, process executions, and who is the user that performed these actions. Such information is essential for the security of your Shoot cluster. Linux operating systems collect such logs via the <code>auditd</code> and <code>journald</code> daemons. However, these logs can be lost if they are only kept locally on the operating system. You need a reliable way to send them to a remote server where they can be stored for longer time periods and retrieved when necessary.</p><p><a href=https://www.rsyslog.com/>Rsyslog</a> offers a solution for that. It gathers and processes logs from <code>auditd</code> and <code>journald</code> and then forwards them to a remote server. Moreover, <code>rsyslog</code> can make use of the RELP protocol so that logs are sent reliably and no messages are lost.</p><p>The <code>shoot-rsyslog-relp</code> extension is used to configure <code>rsyslog</code> on each Shoot node so that the following can take place:</p><ol><li><code>Rsyslog</code> reads logs from the <code>auditd</code> and <code>journald</code> sockets.</li><li>The logs are filtered based on the program name and syslog severity of the message.</li><li>The logs are enriched with metadata containing the name of the Project in which the Shoot is created, the name of the Shoot, the UID of the Shoot, and the hostname of the node on which the log event occurred.</li><li>The enriched logs are sent to the target remote server via the RELP protocol.</li></ol><p>The following graph shows a rough outline of how that looks in a Shoot cluster:
<img src=/__resources/rsyslog-logging-architecture_a57f91.png alt=rsyslog-logging-architecture></p><h2 id=shoot-configuration>Shoot Configuration</h2><p>The extension is not globally enabled and must be configured per Shoot cluster. The Shoot specification has to be adapted to include the <code>shoot-rsyslog-relp</code> extension configuration, which specifies the target server to which logs are forwarded, its port, and some optional rsyslog settings described in the examples below.</p><p>Below is an example <code>shoot-rsyslog-relp</code> extension configuration as part of the Shoot spec:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: bar
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-rsyslog-relp
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>      <span style=color:green># Set the target server to which logs are sent. The server must support the RELP protocol.</span>
</span></span><span style=display:flex><span>      target: some.rsyslog-relp.server
</span></span><span style=display:flex><span>      <span style=color:green># Set the port of the target server.</span>
</span></span><span style=display:flex><span>      port: 10250
</span></span><span style=display:flex><span>      <span style=color:green># Define rules to select logs from which programs and with what syslog severity</span>
</span></span><span style=display:flex><span>      <span style=color:green># are forwarded to the target server.</span>
</span></span><span style=display:flex><span>      loggingRules:
</span></span><span style=display:flex><span>      - severity: 4
</span></span><span style=display:flex><span>        programNames: [<span style=color:#a31515>&#34;kubelet&#34;</span>, <span style=color:#a31515>&#34;audisp-syslog&#34;</span>]
</span></span><span style=display:flex><span>      - severity: 1
</span></span><span style=display:flex><span>        programNames: [<span style=color:#a31515>&#34;audisp-syslog&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:green># Define an interval of 90 seconds at which the current connection is broken and re-established.</span>
</span></span><span style=display:flex><span>      <span style=color:green># By default this value is 0 which means that the connection is never broken and re-established.</span>
</span></span><span style=display:flex><span>      rebindInterval: 90
</span></span><span style=display:flex><span>      <span style=color:green># Set the timeout for relp sessions to 90 seconds. If set too low, valid sessions may be considered</span>
</span></span><span style=display:flex><span>      <span style=color:green># dead and tried to recover.</span>
</span></span><span style=display:flex><span>      timeout: 90
</span></span><span style=display:flex><span>      <span style=color:green># Set how often an action is retried before it is considered to have failed.</span>
</span></span><span style=display:flex><span>      <span style=color:green># Failed actions discard log messages. Setting `-1` here means that messages are never discarded.</span>
</span></span><span style=display:flex><span>      resumeRetryCount: -1
</span></span><span style=display:flex><span>      <span style=color:green># Configures rsyslog to report continuation of action suspension, e.g. when the connection to the target</span>
</span></span><span style=display:flex><span>      <span style=color:green># server is broken.</span>
</span></span><span style=display:flex><span>      reportSuspensionContinuation: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      <span style=color:green># Add tls settings if tls should be used to encrypt the connection to the target server.</span>
</span></span><span style=display:flex><span>      tls:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        <span style=color:green># Use `name` authentication mode for the tls connection.</span>
</span></span><span style=display:flex><span>        authMode: name
</span></span><span style=display:flex><span>        <span style=color:green># Only allow connections if the server&#39;s name is `some.rsyslog-relp.server`</span>
</span></span><span style=display:flex><span>        permittedPeer:
</span></span><span style=display:flex><span>        - <span style=color:#a31515>&#34;some.rsyslog-relp.server&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:green># Reference to the resource which contains certificates used for the tls connection.</span>
</span></span><span style=display:flex><span>        <span style=color:green># It must be added to the `.spec.resources` field of the Shoot.</span>
</span></span><span style=display:flex><span>        secretReferenceName: rsyslog-relp-tls
</span></span><span style=display:flex><span>        <span style=color:green># Instruct librelp on the Shoot nodes to use the gnutls tls library.</span>
</span></span><span style=display:flex><span>        tlsLib: gnutls
</span></span><span style=display:flex><span>      <span style=color:green># Add auditConfig settings if you want to customize node level auditing.</span>
</span></span><span style=display:flex><span>      auditConfig:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        <span style=color:green># Reference to the resource which contains the audit configuration.</span>
</span></span><span style=display:flex><span>        <span style=color:green># It must be added to the `.spec.resources` field of the Shoot.</span>
</span></span><span style=display:flex><span>        configMapReferenceName: audit-config
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    <span style=color:green># Add the rsyslog-relp-tls secret in the resources field of the Shoot spec.</span>
</span></span><span style=display:flex><span>    - name: rsyslog-relp-tls
</span></span><span style=display:flex><span>      resourceRef:
</span></span><span style=display:flex><span>        apiVersion: v1
</span></span><span style=display:flex><span>        kind: Secret
</span></span><span style=display:flex><span>        name: rsyslog-relp-tls-v1
</span></span><span style=display:flex><span>    - name: audit-config
</span></span><span style=display:flex><span>      resourceRef:
</span></span><span style=display:flex><span>        apiVersion: v1
</span></span><span style=display:flex><span>        kind: ConfigMap
</span></span><span style=display:flex><span>        name: audit-config-v1
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h3 id=choosing-which-log-messages-to-send-to-the-target-server>Choosing Which Log Messages to Send to the Target Server</h3><p>The <code>.loggingRules</code> field defines rules about which logs should be sent to the target server. When a log is processed by rsyslog, it is compared against the list of rules in order. If the program name and the syslog severity of the log messages matches the rule, the message is forwarded to the target server. The following table describes the syslog severity and their corresponding codes:</p><pre tabindex=0><code>Numerical         Severity
  Code

  0               Emergency: system is unusable
  1               Alert: action must be taken immediately
  2               Critical: critical conditions
  3               Error: error conditions
  4               Warning: warning conditions
  5               Notice: normal but significant condition
  6               Informational: informational messages
  7               Debug: debug-level messages
</code></pre><p>Below is an example with a <code>.loggingRules</code> section that will only forward logs from the <code>kubelet</code> program with syslog severity of 6 or lower and any other program with syslog severity of 2 or lower:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>target: localhost
</span></span><span style=display:flex><span>port: 1520
</span></span><span style=display:flex><span>loggingRules:
</span></span><span style=display:flex><span>- severity: 6
</span></span><span style=display:flex><span>  programNames: [<span style=color:#a31515>&#34;kubelet&#34;</span>]
</span></span><span style=display:flex><span>- severity: 2
</span></span></code></pre></div><p>You can use a minimal <code>shoot-rsyslog-relp</code> extension configuration to forward all logs to the target server:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>target: some.rsyslog-relp.server
</span></span><span style=display:flex><span>port: 10250
</span></span><span style=display:flex><span>loggingRules:
</span></span><span style=display:flex><span>- severity: 7
</span></span></code></pre></div><h3 id=securing-the-communication-to-the-target-server-with-tls>Securing the Communication to the Target Server with TLS</h3><p>The communication to the target server is not encrypted by default. To enable encryption, set the <code>.tls.enabled</code> field in the <code>shoot-rsyslog-relp</code> extension configuration to <code>true</code>. In this case, an immutable secret which contains the TLS certificates used to establish the TLS connection to the server must be created in the same project namespace as your Shoot.</p><p>An example Secret is given below:</p><blockquote><p><strong>Note:</strong> The secret must be immutable</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: rsyslog-relp-tls-v1
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>immutable: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  ca: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----BEGIN BEGIN RSA PRIVATE KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>    ...
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----END RSA PRIVATE KEY-----</span>    
</span></span><span style=display:flex><span>  crt: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----BEGIN BEGIN RSA PRIVATE KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>    ...
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----END RSA PRIVATE KEY-----</span>    
</span></span><span style=display:flex><span>  key: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----BEGIN BEGIN RSA PRIVATE KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>    ...
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----END RSA PRIVATE KEY-----</span>    
</span></span></code></pre></div><p>The Secret must be referenced in the Shoot&rsquo;s <code>.spec.resources</code> field and the corresponding resource entry must be referenced in the <code>.tls.secretReferenceName</code> of the <code>shoot-rsyslog-relp</code> extension configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: bar
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-rsyslog-relp
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>      target: some.rsyslog-relp.server
</span></span><span style=display:flex><span>      port: 10250
</span></span><span style=display:flex><span>      loggingRules:
</span></span><span style=display:flex><span>      - severity: 7
</span></span><span style=display:flex><span>      tls:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        secretReferenceName: rsyslog-relp-tls
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - name: rsyslog-relp-tls
</span></span><span style=display:flex><span>      resourceRef:
</span></span><span style=display:flex><span>        apiVersion: v1
</span></span><span style=display:flex><span>        kind: Secret
</span></span><span style=display:flex><span>        name: rsyslog-relp-tls-v1
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>You can set a few additional parameters for the TLS connection: <code>.tls.authMode</code>, <code>tls.permittedPeer</code>, and <code>tls.tlsLib</code>. Refer to the rsyslog documentation for more information on these parameters:</p><ul><li><a href=https://www.rsyslog.com/doc/v8-stable/configuration/modules/omrelp.html#tls-authmode><code>.tls.authMode</code></a></li><li><a href=https://www.rsyslog.com/doc/v8-stable/configuration/modules/omrelp.html#tls-permittedpeer><code>.tls.permittedPeer</code></a></li><li><a href=https://www.rsyslog.com/doc/v8-stable/configuration/modules/imrelp.html#tls-tlslib><code>.tls.tlsLib</code></a></li></ul><h3 id=configuring-the-audit-daemon-on-the-shoot-nodes>Configuring the Audit Daemon on the Shoot Nodes</h3><p>The <code>shoot-rsyslog-relp</code> extension also allows you to configure the Audit Daemon (<code>auditd</code>) on the Shoot nodes.</p><p>By default, the audit rules located under the <code>/etc/audit/rules.d</code> directory on your Shoot&rsquo;s nodes will be moved to <code>/etc/audit/rules.d.original</code> and the following rules will be placed under the <code>/etc/audit/rules.d</code> directory: <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/auditrules/00-base-config.rules>00-base-config.rules</a>, <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/auditrules/10-privilege-escalation.rules>10-privilege-escalation.rules</a>, <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/auditrules/11-privileged-special.rules>11-privilege-special.rules</a>, <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/auditrules/12-system-integrity.rules>12-system-integrity.rules</a>. Next, <code>augerules --load</code> will be called and the audit daemon (<code>auditd</code>) restarted so that the new rules can take effect.</p><p>Alternatively, you can define your own <code>auditd</code> rules to be placed on your Shoot&rsquo;s nodes by using the following configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Auditd
</span></span><span style=display:flex><span>auditRules: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>  ## First rule - delete all existing rules
</span></span></span><span style=display:flex><span><span style=color:#a31515>  -D
</span></span></span><span style=display:flex><span><span style=color:#a31515>  ## Now define some custom rules
</span></span></span><span style=display:flex><span><span style=color:#a31515>  -a exit,always -F arch=b64 -S setuid -S setreuid -S setgid -S setregid -F auid&gt;0 -F auid!=-1 -F key=privilege_escalation
</span></span></span><span style=display:flex><span><span style=color:#a31515>  -a exit,always -F arch=b64 -S execve -S execveat -F euid=0 -F auid&gt;0 -F auid!=-1 -F key=privilege_escalation</span>  
</span></span></code></pre></div><p>In this case the original rules are also backed up in the <code>/etc/audit/rules.d.original</code> directory.</p><p>To deploy this configuration, it must be embedded in an immutable ConfigMap.</p><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>The data key storing this configuration must be named <code>auditd</code>.</p></blockquote><p>An example <code>ConfigMap</code> is given below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: ConfigMap
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: audit-config-v1
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>immutable: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  auditd: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#a31515>    kind: Auditd
</span></span></span><span style=display:flex><span><span style=color:#a31515>    auditRules: |
</span></span></span><span style=display:flex><span><span style=color:#a31515>      ## First rule - delete all existing rules
</span></span></span><span style=display:flex><span><span style=color:#a31515>      -D
</span></span></span><span style=display:flex><span><span style=color:#a31515>      ## Now define some custom rules
</span></span></span><span style=display:flex><span><span style=color:#a31515>      -a exit,always -F arch=b64 -S setuid -S setreuid -S setgid -S setregid -F auid&gt;0 -F auid!=-1 -F key=privilege_escalation
</span></span></span><span style=display:flex><span><span style=color:#a31515>      -a exit,always -F arch=b64 -S execve -S execveat -F euid=0 -F auid&gt;0 -F auid!=-1 -F key=privilege_escalation</span>    
</span></span></code></pre></div><p>After creating such a <code>ConfigMap</code>, it must be included in the Shoot&rsquo;s <code>spec.resources</code> array and then referenced from the <code>providerConfig.auditConfig.configMapReferenceName</code> field in the <code>shoot-rsyslog-relp</code> extension configuration.</p><p>An example configuration is given below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: bar
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-rsyslog-relp
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>      target: some.rsyslog-relp.server
</span></span><span style=display:flex><span>      port: 10250
</span></span><span style=display:flex><span>      loggingRules:
</span></span><span style=display:flex><span>      - severity: 7
</span></span><span style=display:flex><span>      auditConfig:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        configMapReferenceName: audit-config
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - name: audit-config
</span></span><span style=display:flex><span>      resourceRef:
</span></span><span style=display:flex><span>        apiVersion: v1
</span></span><span style=display:flex><span>        kind: ConfigMap
</span></span><span style=display:flex><span>        name: audit-config-v1
</span></span></code></pre></div><p>Finally, by setting <code>providerConfig.auditConfig.enabled</code> to <code>false</code> in the <code>shoot-rsyslog-relp</code> extension configuration, the original audit rules on your Shoot&rsquo;s nodes will not be modified and <code>auditd</code> will not be restarted.</p><p>Examples on how the <code>providerConfig.auditConfig.enabled</code> field functions are given below:</p><ul><li>The following deploys the extension default audit rules as of today:<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  auditConfig:
</span></span><span style=display:flex><span>    enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div></li><li>The following deploys only the rules specified in the referenced ConfigMap:<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  auditConfig:
</span></span><span style=display:flex><span>    enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    configMapReferenceName: audit-config
</span></span></code></pre></div></li><li>Both of the following do not deploy any audit rules:<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  auditConfig:
</span></span><span style=display:flex><span>    enabled: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>    configMapReferenceName: audit-config
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  auditConfig:
</span></span><span style=display:flex><span>    enabled: <span style=color:#00f>false</span>
</span></span></code></pre></div></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d98ae8d67f017fd530967ee60a540c5c>2 - Deploying Rsyslog Relp Extension Remotely</h1><div class=lead>Learn how to set up a development environment using own Seed clusters on an existing Kubernetes cluster</div><h1 id=deploying-rsyslog-relp-extension-remotely>Deploying Rsyslog Relp Extension Remotely</h1><p>This document will walk you through running the Rsyslog Relp extension controller on a remote seed cluster and the rsyslog relp admission component in your local garden cluster for development purposes. This guide uses Gardener&rsquo;s <a href=/docs/gardener/deployment/getting_started_locally_with_extensions/>setup with provider extensions</a> and builds on top of it.</p><p>If you encounter difficulties, please open an issue so that we can make this process easier.</p><h2 id=prerequisites>Prerequisites</h2><ul><li>Make sure that you have a running Gardener setup with provider extensions. The steps to complete this can be found in the <a href=/docs/gardener/deployment/getting_started_locally_with_extensions/>Deploying Gardener Locally and Enabling Provider-Extensions</a> guide.</li><li>Make sure you are running Gardener version <code>>= 1.95.0</code> or the latest version of the master branch.</li></ul><h2 id=setting-up-the-rsyslog-relp-extension>Setting up the Rsyslog Relp Extension</h2><p><strong>Important:</strong> Make sure that your <code>KUBECONFIG</code> env variable is targeting the local Gardener cluster!</p><p>The location of the Gardener project from the Gardener setup is expected to be under the same root as this repository (e.g. ~/go/src/github.com/gardener/). If this is not the case, the location of Gardener project should be specified in <code>GARDENER_REPO_ROOT</code> environment variable:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export GARDENER_REPO_ROOT=<span style=color:#a31515>&#34;&lt;path_to_gardener_project&gt;&#34;</span>
</span></span></code></pre></div><p>Then you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-up
</span></span></code></pre></div><p>In case you have added additional Seeds you can specify the seed name:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-up SEED_NAME=&lt;seed-name&gt;
</span></span></code></pre></div><h2 id=creating-a-shoot-cluster>Creating a Shoot Cluster</h2><p>Once the above step is completed, you can create a Shoot cluster. In order to create a Shoot cluster, please create your own <code>Shoot</code> definition depending on providers on your <code>Seed</code> cluster.</p><h2 id=configuring-the-shoot-cluster-and-deploying-the-rsyslog-relp-echo-server>Configuring the Shoot Cluster and deploying the Rsyslog Relp Echo Server</h2><p>To be able to properly test the rsyslog relp extension you need a running rsyslog relp echo server to which logs from the Shoot nodes can be sent. To deploy the server and configure the rsyslog relp extension on your Shoot cluster you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make configure-shoot SHOOT_NAME=&lt;shoot-name&gt; SHOOT_NAMESPACE=&lt;shoot-namespace&gt;
</span></span></code></pre></div><p>This command will deploy an rsyslog relp echo server in your Shoot cluster in the <code>rsyslog-relp-echo-server</code> namespace.
It will also add configuration for the <code>shoot-rsyslog-relp</code> extension to your <code>Shoot</code> spec by patching it with <code>./example/extension/&lt;shoot-name>--&lt;shoot-namespace>--extension-config-patch.yaml</code>. This file is automatically copied from <code>extension-config-patch.yaml.tmpl</code> in the same directory when you run <code>make configure-shoot</code> for the first time. The file also includes explanations of the properties you should set or change.
The command will also deploy the <code>rsyslog-relp-tls</code> secret in case you wish to enable tls.</p><h2 id=tearing-down-the-development-environment>Tearing Down the Development Environment</h2><p>To tear down the development environment, delete the Shoot cluster or disable the <code>shoot-rsyslog-relp</code> extension in the Shoot&rsquo;s specification. When the extension is not used by the Shoot anymore, you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-down
</span></span></code></pre></div><p>The make target will delete the ControllerDeployment and ControllerRegistration of the extension, and the <code>shoot-rsyslog-relp</code> admission helm deployment.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5931a564b136d80a746006d8ebc0311b>3 - Getting Started</h1><h1 id=deploying-rsyslog-relp-extension-locally>Deploying Rsyslog Relp Extension Locally</h1><p>This document will walk you through running the Rsyslog Relp extension and a fake rsyslog relp service on your local machine for development purposes. This guide uses Gardener&rsquo;s local development setup and builds on top of it.</p><p>If you encounter difficulties, please open an issue so that we can make this process easier.</p><h2 id=prerequisites>Prerequisites</h2><ul><li>Make sure that you have a running local Gardener setup. The steps to complete this can be found <a href=/docs/gardener/deployment/getting_started_locally/>here</a>.</li><li>Make sure you are running Gardener version <code>>= 1.74.0</code> or the latest version of the master branch.</li></ul><h2 id=setting-up-the-rsyslog-relp-extension>Setting up the Rsyslog Relp Extension</h2><p><strong>Important:</strong> Make sure that your <code>KUBECONFIG</code> env variable is targeting the local Gardener cluster!</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-up
</span></span></code></pre></div><p>This will build the <code>shoot-rsyslog-relp</code>, <code>shoot-rsyslog-relp-admission</code>, and <code>shoot-rsyslog-relp-echo-server</code> images and deploy the needed resources and configurations in the garden cluster. The <code>shoot-rsyslog-relp-echo-server</code> will act as development replacement of a real rsyslog relp server.</p><h2 id=creating-a-shoot-cluster>Creating a Shoot Cluster</h2><p>Once the above step is completed, we can deploy and configure a Shoot cluster with default rsyslog relp settings.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f ./example/shoot.yaml
</span></span></code></pre></div><p>Once the Shoot&rsquo;s namespace is created, we can create a <code>networkpolicy</code> that will allow egress traffic from the <code>rsyslog</code> on the Shoot&rsquo;s nodes to the <code>rsyslog-relp-echo-server</code> that serves as a fake rsyslog target server.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f ./example/local/allow-machine-to-rsyslog-relp-echo-server-netpol.yaml
</span></span></code></pre></div><p>Currently, the Shoot&rsquo;s nodes run Ubuntu, which does not have the <code>rsyslog-relp</code> and <code>auditd</code> packages installed, so the configuration done by the extension has no effect.
Once the Shoot is created, we have to manually install the <code>rsyslog-relp</code> and <code>auditd</code> packages:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n shoot--local--local exec -it <span style=color:#00f>$(</span>kubectl -n shoot--local--local get po -l app=machine,machine-provider=local -o name<span style=color:#00f>)</span> -- bash -c <span style=color:#a31515>&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>   apt-get update &amp;&amp; \
</span></span></span><span style=display:flex><span><span style=color:#a31515>   apt-get install -y rsyslog-relp auditd &amp;&amp; \
</span></span></span><span style=display:flex><span><span style=color:#a31515>   systemctl enable rsyslog.service &amp;&amp; \
</span></span></span><span style=display:flex><span><span style=color:#a31515>   systemctl start rsyslog.service&#34;</span>
</span></span></code></pre></div><p>Once that is done we can verify that log messages are forwarded to the <code>rsyslog-relp-echo-server</code> by checking its logs.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n rsyslog-relp-echo-server logs deployment/rsyslog-relp-echo-server
</span></span></code></pre></div><h2 id=making-changes-to-the-rsyslog-relp-extension>Making Changes to the Rsyslog Relp Extension</h2><p>Changes to the rsyslog relp extension can be applied to the local environment by repeatedly running the <code>make</code> recipe.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-up
</span></span></code></pre></div><h2 id=tearing-down-the-development-environment>Tearing Down the Development Environment</h2><p>To tear down the development environment, delete the Shoot cluster or disable the <code>shoot-rsyslog-relp</code> extension in the Shoot&rsquo;s spec. When the extension is not used by the Shoot anymore, you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-down
</span></span></code></pre></div><p>This will delete the <code>ControllerRegistration</code> and <code>ControllerDeployment</code> of the extension, the <code>shoot-rsyslog-relp-admission</code> deployment, and the <code>rsyslog-relp-echo-server</code> deployment.</p><h1 id=maintaining-the-publicly-available-image-for-the-rsyslog-relp-echo-server>Maintaining the Publicly Available Image for the rsyslog-relp Echo Server</h1><p>The <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/tree/main/test/testmachinery/shoot>testmachinery tests</a> use an <code>rsyslog-relp-echo-server</code> image from a publicly available repository. The one which is currently used is <code>eu.gcr.io/gardener-project/gardener/extensions/shoot-rsyslog-relp-echo-server:v0.1.0</code>.</p><p>Sometimes it might be necessary to update the image and publish it, e.g. when updating the <code>alpine</code> base image version specified in the repository&rsquo;s <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/Dockerfile#L34>Dokerfile</a>.</p><p>To do that:</p><ol><li><p>Bump the version with which the image is built in the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/Makefile#L17>Makefile</a>.</p></li><li><p>Build the <code>shoot-rsyslog-relp-echo-server</code> image:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make echo-server-docker-image
</span></span></code></pre></div></li><li><p>Once the image is built, push it to <code>gcr</code> with:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make push-echo-server-image
</span></span></code></pre></div></li><li><p>Finally, bump the version of the image used by the <code>testmachinery</code> tests <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/test/testmachinery/shoot/common_test.go>here</a>.</p></li><li><p>Create a PR with the changes.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-1841124a2d14ff1da23f3b3ac50c5742>4 - Monitoring</h1><h1 id=monitoring>Monitoring</h1><p>The <code>shoot-rsyslog-relp</code> extension exposes metrics for the <code>rsyslog</code> service running on a Shoot&rsquo;s nodes so that they can be easily viewed by cluster owners and operators in the Shoot&rsquo;s Prometheus and Plutono instances. The exposed monitoring data offers valuable insights into the operation of the <code>rsyslog</code> service and can be used to detect and debug ongoing issues. This guide describes the various metrics, alerts and logs available to cluster owners and operators.</p><h2 id=metrics>Metrics</h2><p>Metrics for the <code>rsyslog</code> service originate from its <code>impstats</code> module. These include the number of messages in the various queues, the number of ingested messages, the number of processed messages by configured actions, system resources used by the <code>rsyslog</code> service, and others. More information about them can be found in the <a href=https://www.rsyslog.com/doc/configuration/modules/impstats.html><code>impstats</code> documentation</a> and the <a href=https://www.rsyslog.com/doc/configuration/rsyslog_statistic_counter.html>statistics counter documentation</a>. They are exposed via the <a href="https://github.com/prometheus/node_exporter?tab=readme-ov-file#node-exporter"><code>node-exporter</code></a> running on each Shoot node and are scraped by the Shoot&rsquo;s <a href=https://github.com/gardener/gardener/blob/release-v1.99/docs/monitoring/README.md#shoot-prometheus>Prometheus instance</a>.</p><p>These metrics can also be viewed in a dedicated dashboard named <code>Rsyslog Stats</code> in the Shoot&rsquo;s Plutono instance. You can select the node for which you wish the metrics to be displayed from the <code>Node</code> dropdown menu (by default metrics are summed over all nodes).</p><p>Following is a list of all exposed <code>rsyslog</code> metrics. The <code>name</code> and <code>origin</code> labels can be used to determine wether the metric is for: a <a href=https://www.rsyslog.com/doc/configuration/rsyslog_statistic_counter.html#queue>queue</a>, an <a href=https://www.rsyslog.com/doc/configuration/rsyslog_statistic_counter.html#queue>action</a>, <a href=https://www.rsyslog.com/doc/configuration/rsyslog_statistic_counter.html#plugins>plugins</a> or <a href=https://www.rsyslog.com/doc/configuration/modules/impstats.html#statistic-counter>system stats</a>; the <code>node</code> label can be used to determine the node the metric originates from:</p><h4 id=rsyslog_pstat_submitted>rsyslog_pstat_submitted</h4><p>Number of messages that were submitted to the <code>rsyslog</code> service from its input. Currently <code>rsyslog</code> uses the <code>/run/systemd/journal/syslog</code> socket as input.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_processed>rsyslog_pstat_processed</h4><p>Number of messages that are successfully processed by an action and sent to the target server.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_failed>rsyslog_pstat_failed</h4><p>Number of messages that could not be processed by an action nor sent to the target server.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_suspended>rsyslog_pstat_suspended</h4><p>Total number of times an action suspended itself. Note that this counts the number of times the action transitioned from active to suspended state. The counter is no indication of how long the action was suspended or how often it was retried.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_suspended_duration>rsyslog_pstat_suspended_duration</h4><p>The total number of seconds this action was disabled.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_resumed>rsyslog_pstat_resumed</h4><p>The total number of times this action resumed itself. A resumption occurs after the action has detected that a failure condition does no longer exist.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_utime>rsyslog_pstat_utime</h4><p>User time used in microseconds.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_stime>rsyslog_pstat_stime</h4><p>System time used in microsends.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_maxrss>rsyslog_pstat_maxrss</h4><p>Maximum resident set size</p><ul><li>Type: Gauge</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_minflt>rsyslog_pstat_minflt</h4><p>Total number of minor faults the task has made per second, those which have not required loading a memory page from disk.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_majflt>rsyslog_pstat_majflt</h4><p>Total number of major faults the task has made per second, those which have required loading a memory page from disk.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_inblock>rsyslog_pstat_inblock</h4><p>Filesystem input operations.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_oublock>rsyslog_pstat_oublock</h4><p>Filesystem output operations.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_nvcsw>rsyslog_pstat_nvcsw</h4><p>Voluntary context switches.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_nivcsw>rsyslog_pstat_nivcsw</h4><p>Involuntary context switches.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_openfiles>rsyslog_pstat_openfiles</h4><p>Number of open files.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_size>rsyslog_pstat_size</h4><p>Messages currently in queue.</p><ul><li>Type: Gauge</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_enqueued>rsyslog_pstat_enqueued</h4><p>Total messages enqueued.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_full>rsyslog_pstat_full</h4><p>Times queue was full.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_discarded_full>rsyslog_pstat_discarded_full</h4><p>Messages discarded due to queue being full.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_discarded_nf>rsyslog_pstat_discarded_nf</h4><p>Messages discarded when queue not full.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_maxqsize>rsyslog_pstat_maxqsize</h4><p>Maximum size queue has reached.</p><ul><li>Type: Gauge</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_augenrules_load_success>rsyslog_augenrules_load_success</h4><p>Shows whether the <code>augenrules --load</code> command was executed successfully or not on the node.</p><ul><li>Type: Gauge</li><li>Labels: <code>node</code></li></ul><h2 id=alerts>Alerts</h2><p>There are three alerts defined for the <code>rsyslog</code> service in the Shoot&rsquo;s Prometheus instance:</p><h4 id=rsyslogtoomanyrelpactionfailures>RsyslogTooManyRelpActionFailures</h4><p>This indicates that the cumulative failure rate in processing <code>relp</code> action messages is greater than 2%. In other words, it compares the rate of processed <code>relp</code> action messages to the rate of failed <code>relp</code> action messages and fires an alert when the following expression evaluates to true:</p><pre tabindex=0><code>sum(rate(rsyslog_pstat_failed{origin=&#34;core.action&#34;,name=&#34;rsyslg-relp&#34;}[5m])) / sum(rate(rsyslog_pstat_processed{origin=&#34;core.action&#34;,name=&#34;rsyslog-relp&#34;}[5m])) &gt; bool 0.02`
</code></pre><h4 id=rsyslogrelpactionprocessingrateiszero>RsyslogRelpActionProcessingRateIsZero</h4><p>This indicates that no messages are being sent to the upstream rsyslog target by the <code>relp</code> action. An alert is fired when the following expression evaluates to true:</p><pre tabindex=0><code>rate(rsyslog_pstat_processed{origin=&#34;core.action&#34;,name=&#34;rsyslog-relp&#34;}[5m]) == 0
</code></pre><h4 id=rsyslogrelpauditrulesnotloadedsuccessfully>RsyslogRelpAuditRulesNotLoadedSuccessfully</h4><p>This indicates that <code>augenrules --load</code> was not executed successfully when called to load the configured audit rules. You should check if the <code>auditd</code> configuration you provided is valid. An alert is fired when the following expression evaluates to true:</p><pre tabindex=0><code>absent(rsyslog_augenrules_load_success == 1)
</code></pre><p>Users can subscribe to these alerts by following the Gardener <a href=/docs/gardener/monitoring/alerting/#alerting-for-users>alerting guide</a>.</p><h2 id=logging>Logging</h2><p>There are two ways to view the logs of the <code>rsyslog</code> service running on the Shoot&rsquo;s nodes - either using the <code>Explore</code> tab of the Shoot&rsquo;s Plutono instance, or <code>ssh</code>-ing directly to a node.</p><p>To view logs in Plutono, navigate to the <code>Explore</code> tab and select <code>vali</code> from the <code>Explore</code> dropdown menu. Afterwards enter the following <code>vali</code> query:</p><p><code>{nodename="&lt;name-of-node>"} |~ "\"unit\":\"rsyslog.service\""</code></p><p>Notice that you cannot use the <code>unit</code> label to filter for the <code>rsyslog.service</code> unit logs. Instead, you have to <code>grep</code> for the service as displayed in the example above.</p><p>To view logs when directly <code>ssh</code>-ing to a node in the Shoot cluster, use either of the following commands on the node:</p><p><code>systemctl status rsyslog</code></p><p><code>journalctl -u rsyslog</code></p></div><div class=td-content style=page-break-before:always><h1 id=pg-9de2fab25f87ab9a7ba8bb94aa9858b9>5 - Shoot Rsyslog Relp</h1><h1 id=developer-docs-for-gardener-shoot-rsyslog-relp-extension>Developer Docs for Gardener Shoot Rsyslog Relp Extension</h1><p>This document outlines how Shoot reconciliation and deletion works for a Shoot with the shoot-rsyslog-relp extension enabled.</p><h2 id=shoot-reconciliation>Shoot Reconciliation</h2><p>This section outlines how the reconciliation works for a Shoot with the shoot-rsyslog-relp extension enabled.</p><h3 id=extension-enablement--reconciliation>Extension Enablement / Reconciliation</h3><p>This section outlines how the extension enablement/reconciliation works, e.g., the extension has been added to the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, the gardenlet deploys the <a href=https://github.com/gardener/gardener/blob/v1.82.0/docs/extensions/extension.md>Extension</a> resource.</li><li>The shoot-rsyslog-relp extension reconciles the Extension resource. <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/controller/lifecycle/actuator.go>pkg/controller/lifecycle/actuator.go</a> contains the implementation of the <a href=https://github.com/gardener/gardener/blob/v1.82.0/extensions/pkg/controller/extension/actuator.go>extension.Actuator</a> interface. The reconciliation of an Extension of type <code>shoot-rsyslog-relp</code> only deploys the necessary monitoring configuration - the <code>shoot-rsyslog-relp-dashboards</code> ConfigMap which contains the definitions for: Plutono dashboard for the Rsyslog component, and the <code>shoot-shoot-rsyslog-relp</code> <code>ServiceMonitor</code> and <code>PrometheusRule</code> resources which contains the definitions for: scraping metrics by prometheus, alerting rules.</li><li>As part of the Shoot reconciliation flow, the gardenlet deploys the OperatingSystemConfig resource.</li><li>The shoot-rsyslog-relp extension serves a webhook that mutates the OperatingSystemConfig resource for Shoots having the shoot-rsyslog-relp extension enabled (the corresponding namespace gets labeled by the gardenlet with <code>extensions.gardener.cloud/shoot-rsyslog-relp=true</code>). <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/ensurer.go>pkg/webhook/operatingsystemconfig/ensurer.go</a> contains implementation of the <a href=https://github.com/gardener/gardener/blob/v1.82.0/extensions/pkg/webhook/controlplane/genericmutator/mutator.go>genericmutator.Ensurer</a> interface.<ol><li>The webhook renders the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/templates/scripts/configure-rsyslog.tpl.sh>60-audit.conf.tpl</a> template script and appends it to the OperatingSystemConfig files. When rendering the template, the configuration of the shoot-rsyslog-relp extension is used to fill in the required template values. The file is installed as <code>/var/lib/rsyslog-relp-configurator/rsyslog.d/60-audit.conf</code> on the host OS.</li><li>The webhook appends the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/tree/main/pkg/webhook/operatingsystemconfig/resources/auditrules>audit rules</a> to the OperatingSystemConfig. The files are installed under <code>/var/lib/rsyslog-relp-configurator/rules.d</code> on the host OS.</li><li>If the user has specified alternative audit rules in a config map reference, the webhook fetches the referenced <code>ConfigMap</code> from the Shoot&rsquo;s control plane namespace and decodes the value of its <code>auditd</code> data key into an object of type <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/apis/rsyslog/types_auditd.go><code>Auditd</code></a>. It then takes the <code>auditRules</code> defined in the object and places those under the <code>/var/lib/rsyslog-relp-configurator/rules.d</code> directory in a single file.</li><li>The webhook renders the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/templates/scripts/configure-rsyslog.tpl.sh>configure-rsyslog.tpl.sh</a> script and appends it to the OperatingSystemConfig files. This script is installed as <code>/var/lib/rsyslog-relp-configurator/configure-rsyslog.sh</code> on the host OS. It keeps the configuration of the <code>rsyslog</code> systemd service up-to-date by copying <code>/var/lib/rsyslog-relp-configurator/rsyslog.d/60-audit.conf</code> to <code>/etc/rsyslog.d/60-audit.conf</code>, if <code>/etc/rsyslog.d/60-audit.conf</code> does not exist or the files differ. The script also takes care of syncing the audit rules in <code>/etc/audit/rules.d</code> with the ones installed in <code>/var/lib/rsyslog-relp-configurator/rules.d</code> and restarts the auditd systemd service if necessary.</li><li>The webhook renders the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/templates/scripts/process-rsyslog-pstats.tpl.sh>process-rsyslog-pstats.tpl.sh</a> and appends it to the OperatingSystemConfig files. This script receives metrics from the <code>rsyslog</code> process, transforms them, and writes them to <code>/var/lib/node-exporter/textfile-collector/rsyslog_pstats.prom</code> so that they can be collected by the <code>node-exporter</code>.</li><li>As part of the Shoot reconciliation, before the shoot-rsyslog-relp extension is deployed, the gardenlet copies all Secret and ConfigMap resources referenced in <code>.spec.resources[]</code> to the Shoot&rsquo;s control plane namespace on the Seed.
When the <code>.tls.enabled</code> field is <code>true</code> in the shoot-rsyslog-relp extension configuration, a value for <code>.tls.secretReferenceName</code> must also be specified so that it references a <a href=https://github.com/gardener/gardener/blob/v1.82.0/pkg/apis/core/v1beta1/types_shoot.go#L487>named resource reference</a> in the Shoot&rsquo;s <code>.spec.resources[]</code> array.
The webhook appends the data of the referenced Secret in the Shoot&rsquo;s control plane namespace to the OperatingSystemConfig files.</li><li>The webhook appends the <code>rsyslog-configurator.service</code> unit to the OperatingSystemConfig units. The unit invokes the <code>configure-rsyslog.sh</code> script every 15 seconds.</li></ol></li></ol><h3 id=extension-disablement>Extension Disablement</h3><p>This section outlines how the extension disablement works, i.e., the extension has to be removed from the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, the gardenlet destroys the <a href=https://github.com/gardener/gardener/blob/v1.82.0/docs/extensions/extension.md>Extension</a> resource because it is no longer needed.<ol><li>As part of the deletion flow, the shoot-rsyslog-relp extension deploys the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/component/rsyslogrelpconfigcleaner/rsyslog_relp_config_cleaner.go><code>rsyslog-relp-configuration-cleaner</code> DaemonSet</a> to the Shoot cluster to clean up the existing rsyslog configuration and revert the audit rules.</li></ol></li></ol><h2 id=shoot-deletion>Shoot Deletion</h2><p>This section outlines how the deletion works for a Shoot with the shoot-rsyslog-relp extension enabled.</p><ol><li>As part of the Shoot deletion flow, the gardenlet destroys the <a href=https://github.com/gardener/gardener/blob/v1.82.0/docs/extensions/extension.md>Extension</a> resource.<ol><li>In the Shoot deletion flow, the Extension resource is deleted after the Worker resource. Hence, there is no need to deploy the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/component/rsyslogrelpconfigcleaner/rsyslog_relp_config_cleaner.go><code>rsyslog-relp-configuration-cleaner</code> DaemonSet</a> to the Shoot cluster to clean up the existing rsyslog configuration and revert the audit rules.</li></ol></li></ol></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2023 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>