<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://gardener.cloud/docs/gardener/security/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/gardener/security/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Security | Gardener</title>
<meta name=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:url" content="https://gardener.cloud/docs/gardener/security/"><meta property="og:site_name" content="Gardener"><meta property="og:title" content="Security"><meta property="og:description" content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:locale" content="en_US"><meta property="og:type" content="website"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Security"><meta itemprop=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta itemprop=image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Security"><meta name=twitter:description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><link rel=preload href=/scss/main.min.a0c8c4899ce282dcbb2306a0b99a4fae18db6c239ce7b3bc375f59e6ee82bdad.css as=style integrity="sha256-oMjEiZzigty7IwaguZpPrhjbbCOc57O8N19Z5u6Cva0=" crossorigin=anonymous><link href=/scss/main.min.a0c8c4899ce282dcbb2306a0b99a4fae18db6c239ce7b3bc375f59e6ee82bdad.css rel=stylesheet integrity="sha256-oMjEiZzigty7IwaguZpPrhjbbCOc57O8N19Z5u6Cva0=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg width="90" height="90" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=navbar-brand__name>Gardener</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://demo.gardener.cloud target=_blank rel=noopener><span>Demo</span></a></li><li class=nav-item><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class=nav-item><a class=nav-link href=/docs><span>Documentation</span></a></li><li class=nav-item><a class=nav-link href=/blog><span>Blogs</span></a></li><li class=nav-item><a class=nav-link href=/community><span>Community</span></a></li><li class=nav-item><a class=nav-link href=https://join.slack.com/t/gardener-cloud/shared_invite/zt-33c9daems-3oOorhnqOSnldZPWqGmIBw target=_blank rel=noopener><span>Join us on</span></a></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.aa14855e051698d1fd61277f3db21e47.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/gardener/security/>Return to the regular view of this page</a>.</p></div><h1 class=title>Security</h1><div class=content></div></div><div class=td-content><h1 id=pg-9ccbf475c477afd442198e96c9aff311>1 - Admission Configuration for the `PodSecurity` Admission Plugin</h1><div class=lead>Adding custom configuration for the <code>PodSecurity</code> plugin in <code>.spec.kubernetes.kubeAPIServer.admissionPlugins</code></div><h2 id=admission-configuration-for-the-podsecurity-admission-plugin>Admission Configuration for the <code>PodSecurity</code> Admission Plugin<a class=td-heading-self-link href=#admission-configuration-for-the-podsecurity-admission-plugin aria-label="Heading self-link"></a></h2><p>If you wish to add your custom configuration for the <code>PodSecurity</code> plugin, you can do so in the Shoot spec under <code>.spec.kubernetes.kubeAPIServer.admissionPlugins</code> by adding:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>admissionPlugins:
</span></span><span style=display:flex><span>- name: PodSecurity
</span></span><span style=display:flex><span>  config:
</span></span><span style=display:flex><span>    apiVersion: pod-security.admission.config.k8s.io/v1
</span></span><span style=display:flex><span>    kind: PodSecurityConfiguration
</span></span><span style=display:flex><span>    <span style=color:green># Defaults applied when a mode label is not set.</span>
</span></span><span style=display:flex><span>    <span style=color:green>#</span>
</span></span><span style=display:flex><span>    <span style=color:green># Level label values must be one of:</span>
</span></span><span style=display:flex><span>    <span style=color:green># - &#34;privileged&#34; (default)</span>
</span></span><span style=display:flex><span>    <span style=color:green># - &#34;baseline&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:green># - &#34;restricted&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#</span>
</span></span><span style=display:flex><span>    <span style=color:green># Version label values must be one of:</span>
</span></span><span style=display:flex><span>    <span style=color:green># - &#34;latest&#34; (default) </span>
</span></span><span style=display:flex><span>    <span style=color:green># - specific version like &#34;v1.25&#34;</span>
</span></span><span style=display:flex><span>    defaults:
</span></span><span style=display:flex><span>      enforce: <span style=color:#a31515>&#34;privileged&#34;</span>
</span></span><span style=display:flex><span>      enforce-version: <span style=color:#a31515>&#34;latest&#34;</span>
</span></span><span style=display:flex><span>      audit: <span style=color:#a31515>&#34;privileged&#34;</span>
</span></span><span style=display:flex><span>      audit-version: <span style=color:#a31515>&#34;latest&#34;</span>
</span></span><span style=display:flex><span>      warn: <span style=color:#a31515>&#34;privileged&#34;</span>
</span></span><span style=display:flex><span>      warn-version: <span style=color:#a31515>&#34;latest&#34;</span>
</span></span><span style=display:flex><span>    exemptions:
</span></span><span style=display:flex><span>      <span style=color:green># Array of authenticated usernames to exempt.</span>
</span></span><span style=display:flex><span>      usernames: []
</span></span><span style=display:flex><span>      <span style=color:green># Array of runtime class names to exempt.</span>
</span></span><span style=display:flex><span>      runtimeClasses: []
</span></span><span style=display:flex><span>      <span style=color:green># Array of namespaces to exempt.</span>
</span></span><span style=display:flex><span>      namespaces: []
</span></span></code></pre></div><p>For proper functioning of Gardener, <code>kube-system</code> namespace will also be automatically added to the <code>exemptions.namespaces</code> list.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1a9a632f03be2887303f831bd0ef4c2c>2 - Audit a Kubernetes Cluster</h1><div class=lead>How to define a custom audit policy through a <code>ConfigMap</code> and reference it in the shoot spec</div><h1 id=audit-a-kubernetes-cluster>Audit a Kubernetes Cluster<a class=td-heading-self-link href=#audit-a-kubernetes-cluster aria-label="Heading self-link"></a></h1><p>The shoot cluster is a Kubernetes cluster and its <code>kube-apiserver</code> handles the audit events. In order to define which audit events must be logged, a proper audit policy file must be passed to the Kubernetes API server. You could find more information about auditing a kubernetes cluster in the <a href=https://kubernetes.io/docs/tasks/debug-application-cluster/audit/>Auditing</a> topic.</p><h2 id=default-audit-policy>Default Audit Policy<a class=td-heading-self-link href=#default-audit-policy aria-label="Heading self-link"></a></h2><p>By default, the Gardener will deploy the shoot cluster with audit policy defined in the <a href=https://github.com/gardener/gardener/blob/master/pkg/component/kubernetes/apiserver/secrets.go>kube-apiserver package</a>.</p><h2 id=custom-audit-policy>Custom Audit Policy<a class=td-heading-self-link href=#custom-audit-policy aria-label="Heading self-link"></a></h2><p>If you need specific audit policy for your shoot cluster, then you could deploy the required audit policy in the garden cluster as <code>ConfigMap</code> resource and set up your shoot to refer this <code>ConfigMap</code>. Note that the policy must be stored under the key <code>policy</code> in the data section of the <code>ConfigMap</code>.</p><p>For example, deploy the auditpolicy <code>ConfigMap</code> in the same namespace as your <code>Shoot</code> resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f example/95-configmap-custom-audit-policy.yaml
</span></span></code></pre></div><p>then set your shoot to refer that <code>ConfigMap</code> (only related fields are shown):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    kubeAPIServer:
</span></span><span style=display:flex><span>      auditConfig:
</span></span><span style=display:flex><span>        auditPolicy:
</span></span><span style=display:flex><span>          configMapRef:
</span></span><span style=display:flex><span>            name: auditpolicy
</span></span></code></pre></div><p>Gardener validate the <code>Shoot</code> resource to refer only existing <code>ConfigMap</code> containing valid audit policy, and rejects the <code>Shoot</code> on failure.
If you want to switch back to the default audit policy, you have to remove the section</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>auditPolicy:
</span></span><span style=display:flex><span>  configMapRef:
</span></span><span style=display:flex><span>    name: &lt;configmap-name&gt;
</span></span></code></pre></div><p>from the shoot spec.</p><h2 id=rolling-out-changes-to-the-audit-policy>Rolling Out Changes to the Audit Policy<a class=td-heading-self-link href=#rolling-out-changes-to-the-audit-policy aria-label="Heading self-link"></a></h2><p>Gardener is not automatically rolling out changes to the Audit Policy to minimize the amount of Shoot reconciliations in order to prevent cloud provider rate limits, etc.
Gardener will pick up the changes on the next reconciliation of Shoots referencing the Audit Policy ConfigMap.
If users want to immediately rollout Audit Policy changes, they can manually trigger a Shoot reconciliation as described in <a href=/docs/gardener/shoot-operations/shoot_operations/#immediate-reconciliation>triggering an immediate reconciliation</a>.
This is similar to changes to the cloud provider secret referenced by Shoots.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-12d2a6dd3f3a821f0ed0c91f31d6dc22>3 - Default Seccomp Profile</h1><div class=lead>Enable the use of <code>RuntimeDefault</code> as the default seccomp profile through <code>spec.kubernetes.kubelet.seccompDefault</code></div><h1 id=default-seccomp-profile-and-configuration>Default Seccomp Profile and Configuration<a class=td-heading-self-link href=#default-seccomp-profile-and-configuration aria-label="Heading self-link"></a></h1><p>This is a short guide describing how to enable the defaulting of seccomp profiles for Gardener managed workloads in the seed. Running pods in <code>Unconfined</code> (seccomp disabled) mode is undesirable since this is the least restrictive profile. Also, mind that any privileged container will always run as <code>Unconfined</code>. More information about seccomp can be found in this <a href=https://kubernetes.io/docs/tutorials/security/seccomp/>Kubernetes tutorial</a>.</p><h2 id=setting-the-seccomp-profile-to-runtimedefault-for-seed-clusters>Setting the Seccomp Profile to RuntimeDefault for Seed Clusters<a class=td-heading-self-link href=#setting-the-seccomp-profile-to-runtimedefault-for-seed-clusters aria-label="Heading self-link"></a></h2><p>To address the above issue, Gardener provides a webhook that is capable of mutating pods in the seed clusters, explicitly providing them with a seccomp profile type of <code>RuntimeDefault</code>. This profile is defined by the container runtime and represents a set of default syscalls that are allowed or not.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  securityContext:
</span></span><span style=display:flex><span>    seccompProfile:
</span></span><span style=display:flex><span>      type: RuntimeDefault
</span></span></code></pre></div><p>A <code>Pod</code> is mutated when all of the following preconditions are fulfilled:</p><ol><li>The <code>Pod</code> is created in a Gardener managed namespace.</li><li>The <code>Pod</code> is NOT labeled with <code>seccompprofile.resources.gardener.cloud/skip</code>.</li><li>The <code>Pod</code> does NOT explicitly specify <code>.spec.securityContext.seccompProfile.type</code>.</li></ol><h3 id=how-to-configure>How to Configure<a class=td-heading-self-link href=#how-to-configure aria-label="Heading self-link"></a></h3><p>To enable this feature, the gardenlet <code>DefaultSeccompProfile</code> feature gate must be set to <code>true</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>featureGates:
</span></span><span style=display:flex><span>  DefaultSeccompProfile: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>Please refer to the examples in this <a href=https://github.com/gardener/gardener/blob/master/example/20-componentconfig-gardenlet.yaml>yaml file</a> for more information.</p><p>Once the feature gate is enabled, the webhook will be registered and configured for the seed cluster. Newly created pods will be mutated to have their seccomp profile set to <code>RuntimeDefault</code>.</p><blockquote><p><strong>Note:</strong> Please note that this feature is still in Alpha, so you might see instabilities every now and then.</p></blockquote><h2 id=setting-the-seccomp-profile-to-runtimedefault-for-shoot-clusters>Setting the Seccomp Profile to RuntimeDefault for Shoot Clusters<a class=td-heading-self-link href=#setting-the-seccomp-profile-to-runtimedefault-for-shoot-clusters aria-label="Heading self-link"></a></h2><p>You can enable the use of <code>RuntimeDefault</code> as the default seccomp profile for all workloads. If enabled, the kubelet will use the <code>RuntimeDefault</code> seccomp profile by default, which is defined by the container runtime, instead of using the <code>Unconfined</code> mode. More information for this feature can be found in the <a href=https://kubernetes.io/docs/tutorials/security/seccomp/#enable-the-use-of-runtimedefault-as-the-default-seccomp-profile-for-all-workloads>Kubernetes documentation</a>.</p><p>To use seccomp profile defaulting, you must run the kubelet with the <code>SeccompDefault</code> feature gate enabled (this is the default).</p><h3 id=how-to-configure-1>How to Configure<a class=td-heading-self-link href=#how-to-configure-1 aria-label="Heading self-link"></a></h3><p>To enable this feature, the kubelet <code>seccompDefault</code> configuration parameter must be set to <code>true</code> in the shoot&rsquo;s spec.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.25.0
</span></span><span style=display:flex><span>    kubelet:
</span></span><span style=display:flex><span>      seccompDefault: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>Please refer to the examples in this <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml>yaml file</a> for more information.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5478f1d77e76647d077ff6d8dc5d2dd0>4 - ETCD Encryption Config</h1><div class=lead>Specifying resource types for encryption with <code>spec.kubernetes.kubeAPIServer.encryptionConfig</code></div><h1 id=etcd-encryption-config>ETCD Encryption Config<a class=td-heading-self-link href=#etcd-encryption-config aria-label="Heading self-link"></a></h1><p>The <code>spec.kubernetes.kubeAPIServer.encryptionConfig</code> field in the Shoot API allows users to customize encryption configurations for the API server. It provides options to specify additional resources for encryption beyond secrets.</p><h2 id=usage-guidelines>Usage Guidelines<a class=td-heading-self-link href=#usage-guidelines aria-label="Heading self-link"></a></h2><ul><li>The <code>resources</code> field can be used to specify resources that should be encrypted in addition to secrets. Secrets are always encrypted.</li><li>Each item is a Kubernetes resource name in plural (resource or resource.group). Wild cards are not supported.</li><li>Adding an item to this list will cause patch requests for all the resources of that kind to encrypt them in the etcd. See <a href=https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data>Encrypting Confidential Data at Rest</a> for more details.</li><li>Removing an item from this list will cause patch requests for all the resources of that type to decrypt and rewrite the resource as plain text. See <a href=https://kubernetes.io/docs/tasks/administer-cluster/decrypt-data/>Decrypt Confidential Data that is Already Encrypted at Rest</a> for more details.</li></ul><h2 id=example-usage-in-a-shoot>Example Usage in a <code>Shoot</code><a class=td-heading-self-link href=#example-usage-in-a-shoot aria-label="Heading self-link"></a></h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    kubeAPIServer:
</span></span><span style=display:flex><span>      encryptionConfig:
</span></span><span style=display:flex><span>        resources:
</span></span><span style=display:flex><span>          - configmaps
</span></span><span style=display:flex><span>          - statefulsets.apps
</span></span><span style=display:flex><span>          - customresource.fancyoperator.io
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5e579ef6e8dc6b1bbc514f029f0951f6>5 - OpenIDConnect Presets</h1><h1 id=clusteropenidconnectpreset-and-openidconnectpreset>ClusterOpenIDConnectPreset and OpenIDConnectPreset<a class=td-heading-self-link href=#clusteropenidconnectpreset-and-openidconnectpreset aria-label="Heading self-link"></a></h1><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>OpenID Connect is deprecated in favor of <a href=/docs/gardener/shoot/shoot_access/#structured-authentication>Structured Authentication configuration</a>. Setting OpenID Connect configurations is forbidden for clusters with Kubernetes version <code>>= 1.32</code>.</p></blockquote><p>This page provides an overview of ClusterOpenIDConnectPresets and OpenIDConnectPresets, which are objects for injecting <a href=https://openid.net/connect/>OpenIDConnect Configuration</a> into <code>Shoot</code> at creation time. The injected information contains configuration for the Kube API Server and optionally configuration for kubeconfig generation using said configuration.</p><h2 id=openidconnectpreset>OpenIDConnectPreset<a class=td-heading-self-link href=#openidconnectpreset aria-label="Heading self-link"></a></h2><p>An OpenIDConnectPreset is an API resource for injecting additional runtime OIDC requirements into a Shoot at creation time. You use label selectors to specify the <code>Shoot</code> to which a given OpenIDConnectPreset applies.</p><p>Using a OpenIDConnectPresets allows project owners to not have to explicitly provide the same OIDC configuration for every <code>Shoot</code> in their <code>Project</code>.</p><p>For more information about the background, see the <a href=https://github.com/gardener/gardener/issues/1161>issue</a> for OpenIDConnectPreset.</p><h3 id=how-openidconnectpreset-works>How OpenIDConnectPreset Works<a class=td-heading-self-link href=#how-openidconnectpreset-works aria-label="Heading self-link"></a></h3><p>Gardener provides an admission controller (OpenIDConnectPreset) which, when enabled, applies OpenIDConnectPresets to incoming <code>Shoot</code> creation requests. When a <code>Shoot</code> creation request occurs, the system does the following:</p><ul><li><p>Retrieve all OpenIDConnectPreset available for use in the <code>Shoot</code> namespace.</p></li><li><p>Check if the shoot label selectors of any OpenIDConnectPreset matches the labels on the Shoot being created.</p></li><li><p>If multiple presets are matched then only one is chosen and results are sorted based on:</p><ol><li><code>.spec.weight</code> value.</li><li>lexicographically ordering their names (e.g., <code>002preset</code> > <code>001preset</code>)</li></ol></li><li><p>If the <code>Shoot</code> already has a <code>.spec.kubernetes.kubeAPIServer.oidcConfig</code>, then no mutation occurs.</p></li></ul><h3 id=simple-openidconnectpreset-example>Simple OpenIDConnectPreset Example<a class=td-heading-self-link href=#simple-openidconnectpreset-example aria-label="Heading self-link"></a></h3><p>This is a simple example to show how a <code>Shoot</code> is modified by the OpenIDConnectPreset:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: settings.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: OpenIDConnectPreset
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name:  test-1
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  shootSelector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      oidc: enabled
</span></span><span style=display:flex><span>  server:
</span></span><span style=display:flex><span>    clientID: test-1
</span></span><span style=display:flex><span>    issuerURL: https://foo.bar
</span></span><span style=display:flex><span>    <span style=color:green># caBundle: |</span>
</span></span><span style=display:flex><span>    <span style=color:green>#   -----BEGIN CERTIFICATE-----</span>
</span></span><span style=display:flex><span>    <span style=color:green>#   Li4u</span>
</span></span><span style=display:flex><span>    <span style=color:green>#   -----END CERTIFICATE-----</span>
</span></span><span style=display:flex><span>    groupsClaim: groups-claim
</span></span><span style=display:flex><span>    groupsPrefix: groups-prefix
</span></span><span style=display:flex><span>    usernameClaim: username-claim
</span></span><span style=display:flex><span>    usernamePrefix: username-prefix
</span></span><span style=display:flex><span>    signingAlgs:
</span></span><span style=display:flex><span>    - RS256
</span></span><span style=display:flex><span>    requiredClaims:
</span></span><span style=display:flex><span>      key: value
</span></span><span style=display:flex><span>  weight: 90
</span></span></code></pre></div><p>Create the OpenIDConnectPreset:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>kubectl apply -f preset.yaml
</span></span></code></pre></div><p>Examine the created OpenIDConnectPreset:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>kubectl get openidconnectpresets
</span></span><span style=display:flex><span>NAME     ISSUER            SHOOT-SELECTOR   AGE
</span></span><span style=display:flex><span>test-1   https://foo.bar   oidc=enabled     1s
</span></span></code></pre></div><p>Simple <code>Shoot</code> example:</p><p>This is a sample of a <code>Shoot</code> with some fields omitted:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: preset
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    oidc: enabled
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.20.2
</span></span></code></pre></div><p>Create the Shoot:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>kubectl apply -f shoot.yaml
</span></span></code></pre></div><p>Examine the created Shoot:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>kubectl get shoot preset -o yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: preset
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    oidc: enabled
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    kubeAPIServer:
</span></span><span style=display:flex><span>      oidcConfig:
</span></span><span style=display:flex><span>        clientID: test-1
</span></span><span style=display:flex><span>        groupsClaim: groups-claim
</span></span><span style=display:flex><span>        groupsPrefix: groups-prefix
</span></span><span style=display:flex><span>        issuerURL: https://foo.bar
</span></span><span style=display:flex><span>        requiredClaims:
</span></span><span style=display:flex><span>          key: value
</span></span><span style=display:flex><span>        signingAlgs:
</span></span><span style=display:flex><span>        - RS256
</span></span><span style=display:flex><span>        usernameClaim: username-claim
</span></span><span style=display:flex><span>        usernamePrefix: username-prefix
</span></span><span style=display:flex><span>    version: 1.20.2
</span></span></code></pre></div><h3 id=disable-openidconnectpreset>Disable OpenIDConnectPreset<a class=td-heading-self-link href=#disable-openidconnectpreset aria-label="Heading self-link"></a></h3><p>The OpenIDConnectPreset admission control is enabled by default. To disable it, use the <code>--disable-admission-plugins</code> flag on the gardener-apiserver.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>--disable-admission-plugins=OpenIDConnectPreset
</span></span></code></pre></div><h2 id=clusteropenidconnectpreset>ClusterOpenIDConnectPreset<a class=td-heading-self-link href=#clusteropenidconnectpreset aria-label="Heading self-link"></a></h2><p>A ClusterOpenIDConnectPreset is an API resource for injecting additional runtime OIDC requirements into a Shoot at creation time. In contrast to OpenIDConnect, it&rsquo;s a cluster-scoped resource. You use label selectors to specify the <code>Project</code> and <code>Shoot</code> to which a given OpenIDCConnectPreset applies.</p><p>Using a OpenIDConnectPresets allows cluster owners to not have to explicitly provide the same OIDC configuration for every <code>Shoot</code> in specific <code>Project</code>.</p><p>For more information about the background, see the <a href=https://github.com/gardener/gardener/issues/1161>issue</a> for ClusterOpenIDConnectPreset.</p><h3 id=how-clusteropenidconnectpreset-works>How ClusterOpenIDConnectPreset Works<a class=td-heading-self-link href=#how-clusteropenidconnectpreset-works aria-label="Heading self-link"></a></h3><p>Gardener provides an admission controller (ClusterOpenIDConnectPreset) which, when enabled, applies ClusterOpenIDConnectPresets to incoming <code>Shoot</code> creation requests. When a <code>Shoot</code> creation request occurs, the system does the following:</p><ul><li><p>Retrieve all ClusterOpenIDConnectPresets available.</p></li><li><p>Check if the project label selector of any ClusterOpenIDConnectPreset matches the labels of the <code>Project</code> in which the <code>Shoot</code> is being created.</p></li><li><p>Check if the shoot label selectors of any ClusterOpenIDConnectPreset matches the labels on the <code>Shoot</code> being created.</p></li><li><p>If multiple presets are matched then only one is chosen and results are sorted based on:</p><ol><li><code>.spec.weight</code> value.</li><li>lexicographically ordering their names ( e.g. <code>002preset</code> > <code>001preset</code> )</li></ol></li><li><p>If the <code>Shoot</code> already has a <code>.spec.kubernetes.kubeAPIServer.oidcConfig</code> then no mutation occurs.</p></li></ul><blockquote><p><strong>Note:</strong> Due to the previous requirement, if a <code>Shoot</code> is matched by both <code>OpenIDConnectPreset</code> and <code>ClusterOpenIDConnectPreset</code>, then <code>OpenIDConnectPreset</code> takes precedence over <code>ClusterOpenIDConnectPreset</code>.</p></blockquote><h3 id=simple-clusteropenidconnectpreset-example>Simple ClusterOpenIDConnectPreset Example<a class=td-heading-self-link href=#simple-clusteropenidconnectpreset-example aria-label="Heading self-link"></a></h3><p>This is a simple example to show how a <code>Shoot</code> is modified by the ClusterOpenIDConnectPreset:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: settings.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: ClusterOpenIDConnectPreset
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name:  test
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  shootSelector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      oidc: enabled
</span></span><span style=display:flex><span>  projectSelector: {} <span style=color:green># selects all projects.</span>
</span></span><span style=display:flex><span>  server:
</span></span><span style=display:flex><span>    clientID: cluster-preset
</span></span><span style=display:flex><span>    issuerURL: https://foo.bar
</span></span><span style=display:flex><span>    <span style=color:green># caBundle: |</span>
</span></span><span style=display:flex><span>    <span style=color:green>#   -----BEGIN CERTIFICATE-----</span>
</span></span><span style=display:flex><span>    <span style=color:green>#   Li4u</span>
</span></span><span style=display:flex><span>    <span style=color:green>#   -----END CERTIFICATE-----</span>
</span></span><span style=display:flex><span>    groupsClaim: groups-claim
</span></span><span style=display:flex><span>    groupsPrefix: groups-prefix
</span></span><span style=display:flex><span>    usernameClaim: username-claim
</span></span><span style=display:flex><span>    usernamePrefix: username-prefix
</span></span><span style=display:flex><span>    signingAlgs:
</span></span><span style=display:flex><span>    - RS256
</span></span><span style=display:flex><span>    requiredClaims:
</span></span><span style=display:flex><span>      key: value
</span></span><span style=display:flex><span>  weight: 90
</span></span></code></pre></div><p>Create the ClusterOpenIDConnectPreset:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>kubectl apply -f preset.yaml
</span></span></code></pre></div><p>Examine the created ClusterOpenIDConnectPreset:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get clusteropenidconnectpresets
</span></span><span style=display:flex><span>NAME     ISSUER            PROJECT-SELECTOR   SHOOT-SELECTOR   AGE
</span></span><span style=display:flex><span>test     https://foo.bar   &lt;none&gt;             oidc=enabled     1s
</span></span></code></pre></div><p>This is a sample of a <code>Shoot</code>, with some fields omitted:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: preset
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    oidc: enabled
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.20.2
</span></span></code></pre></div><p>Create the Shoot:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>kubectl apply -f shoot.yaml
</span></span></code></pre></div><p>Examine the created Shoot:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>kubectl get shoot preset -o yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: preset
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    oidc: enabled
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    kubeAPIServer:
</span></span><span style=display:flex><span>      oidcConfig:
</span></span><span style=display:flex><span>        clientID: cluster-preset
</span></span><span style=display:flex><span>        groupsClaim: groups-claim
</span></span><span style=display:flex><span>        groupsPrefix: groups-prefix
</span></span><span style=display:flex><span>        issuerURL: https://foo.bar
</span></span><span style=display:flex><span>        requiredClaims:
</span></span><span style=display:flex><span>          key: value
</span></span><span style=display:flex><span>        signingAlgs:
</span></span><span style=display:flex><span>        - RS256
</span></span><span style=display:flex><span>        usernameClaim: username-claim
</span></span><span style=display:flex><span>        usernamePrefix: username-prefix
</span></span><span style=display:flex><span>    version: 1.20.2
</span></span></code></pre></div><h3 id=disable-clusteropenidconnectpreset>Disable ClusterOpenIDConnectPreset<a class=td-heading-self-link href=#disable-clusteropenidconnectpreset aria-label="Heading self-link"></a></h3><p>The ClusterOpenIDConnectPreset admission control is enabled by default. To disable it, use the <code>--disable-admission-plugins</code> flag on the gardener-apiserver.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>--disable-admission-plugins=ClusterOpenIDConnectPreset
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-9874fa39203219de2ed17f201974cfb1>6 - Shoot Serviceaccounts</h1><h1 id=serviceaccount-configurations-for-shoot-clusters><code>ServiceAccount</code> Configurations for Shoot Clusters<a class=td-heading-self-link href=#serviceaccount-configurations-for-shoot-clusters aria-label="Heading self-link"></a></h1><p>The <code>Shoot</code> specification allows to configure some of the settings for the handling of <code>ServiceAccount</code>s:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    kubeAPIServer:
</span></span><span style=display:flex><span>      serviceAccountConfig:
</span></span><span style=display:flex><span>        issuer: foo
</span></span><span style=display:flex><span>        acceptedIssuers:
</span></span><span style=display:flex><span>        - foo1
</span></span><span style=display:flex><span>        - foo2
</span></span><span style=display:flex><span>        extendTokenExpiration: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        maxTokenExpiration: 45d
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=issuer-and-accepted-issuers>Issuer and Accepted Issuers<a class=td-heading-self-link href=#issuer-and-accepted-issuers aria-label="Heading self-link"></a></h2><p>The <code>.spec.kubernetes.kubeAPIServer.serviceAccountConfig.{issuer,acceptedIssuers}</code> fields are translated to the <code>--service-account-issuer</code> flag for the <code>kube-apiserver</code>.
The issuer will assert its identifier in the <code>iss</code> claim of the issued tokens.
According to the <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/>upstream specification</a>, values need to meet the following requirements:</p><blockquote><p>This value is a string or URI. If this option is not a valid URI per the OpenID Discovery 1.0 spec, the ServiceAccountIssuerDiscovery feature will remain disabled, even if the feature gate is set to true. It is highly recommended that this value comply with the OpenID spec: <a href=https://openid.net/specs/openid-connect-discovery-1_0.html>https://openid.net/specs/openid-connect-discovery-1_0.html</a>. In practice, this means that service-account-issuer must be an https URL. It is also highly recommended that this URL be capable of serving OpenID discovery documents at {service-account-issuer}/.well-known/openid-configuration.</p></blockquote><p>By default, Gardener uses the internal cluster domain as issuer (e.g., <code>https://api.foo.bar.example.com</code>).
If you specify the <code>issuer</code>, then this default issuer will always be part of the list of accepted issuers (you don&rsquo;t need to specify it yourself).</p><blockquote class="alert alert-caution"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-octagon-outline</title><path d="M8.27 3 3 8.27v7.46L8.27 21h7.46C17.5 19.24 21 15.73 21 15.73V8.27L15.73 3M9.1 5h5.8L19 9.1v5.8L14.9 19H9.1L5 14.9V9.1M11 15h2v2H11V15m0-8h2v6H11V7"/></svg><p>Caution</p></div><p>If you change from the default issuer to a custom <code>issuer</code>, all previously issued tokens will still be valid/accepted.
However, if you change from a custom <code>issuer</code> <code>A</code> to another <code>issuer</code> <code>B</code> (custom or default), then you have to add <code>A</code> to the <code>acceptedIssuers</code> so that previously issued tokens are not invalidated.
Otherwise, the control plane components as well as system components and your workload pods might fail.
You can remove <code>A</code> from the <code>acceptedIssuers</code> when all currently active tokens have been issued solely by <code>B</code>.
This can be ensured by using <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>projected token volumes</a> with a short validity, or by rolling out all pods.
Additionally, all <a href=https://kubernetes.io/docs/concepts/configuration/secret/#service-account-token-secrets><code>ServiceAccount</code> token secrets</a> should be recreated.
Apart from this, you should wait for at least <code>12h</code> to make sure the control plane and system components have received a new token from Gardener.</p></blockquote><h2 id=token-expirations>Token Expirations<a class=td-heading-self-link href=#token-expirations aria-label="Heading self-link"></a></h2><p>The <code>.spec.kubernetes.kubeAPIServer.serviceAccountConfig.extendTokenExpiration</code> configures the <code>--service-account-extend-token-expiration</code> flag of the <code>kube-apiserver</code>.
It is enabled by default and has the following specification:</p><blockquote><p>Turns on projected service account expiration extension during token generation, which helps safe transition from legacy token to bound service account token feature. If this flag is enabled, admission injected tokens would be extended up to 1 year to prevent unexpected failure during transition, ignoring value of service-account-max-token-expiration.</p></blockquote><p>The <code>.spec.kubernetes.kubeAPIServer.serviceAccountConfig.maxTokenExpiration</code> configures the <code>--service-account-max-token-expiration</code> flag of the <code>kube-apiserver</code>.
It has the following specification:</p><blockquote><p>The maximum validity duration of a token created by the service account token issuer. If an otherwise valid TokenRequest with a validity duration larger than this value is requested, a token will be issued with a validity duration of this value.</p></blockquote><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>The value for this field must be in the <code>[30d,90d]</code> range.
The background for this limitation is that all Gardener components rely on the <code>TokenRequest</code> API and the Kubernetes service account token projection feature with short-lived, auto-rotating tokens.
Any values lower than <code>30d</code> risk impacting the SLO for shoot clusters, and any values above <code>90d</code> violate security best practices with respect to maximum validity of credentials before they must be rotated.
Given that the field just specifies the upper bound, end-users can still use lower values for their individual workload by specifying the <code>.spec.volumes[].projected.sources[].serviceAccountToken.expirationSeconds</code> in the <code>PodSpec</code>s.</p></blockquote><h2 id=managed-service-account-issuer>Managed Service Account Issuer<a class=td-heading-self-link href=#managed-service-account-issuer aria-label="Heading self-link"></a></h2><p>Gardener also provides a way to manage the service account issuer of a shoot cluster as well as serving its OIDC discovery documents from a centrally managed server called <a href=https://github.com/gardener/gardener-discovery-server>Gardener Discovery Server</a>.
This ability removes the need for changing the <code>.spec.kubernetes.kubeAPIServer.serviceAccountConfig.issuer</code> and exposing it separately.</p><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>The following prerequisites are responsibility of the Gardener Administrators and are not something that end users can configure by themselves.
If uncertain that these requirements are met, please contact your Gardener Administrator.</p></blockquote><p>Prerequisites:</p><ul><li>The Garden Cluster should have the Gardener Discovery Server deployed and configured.
The easiest way to handle this is by using the <a href=/docs/gardener/concepts/operator/#gardener-discovery-server>gardener-operator</a>.</li></ul><h3 id=enablement>Enablement<a class=td-heading-self-link href=#enablement aria-label="Heading self-link"></a></h3><p>If the prerequisites are met then the feature can be enabled for a shoot cluster by annotating it with <code>authentication.gardener.cloud/issuer=managed</code>.
Mind that once enabled, this feature cannot be disabled.</p><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>After annotating the shoot with <code>authentication.gardener.cloud/issuer=managed</code> the reconciliation will not be triggered immediately.
One can wait for the shoot maintenance window or trigger reconciliation by annotating the shoot with <code>gardener.cloud/operation=reconcile</code>.</p></blockquote><p>After the shoot is reconciled, you can retrieve the new shoot service account issuer value from the shoot&rsquo;s status.
A sample query that will retrieve the managed issuer looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n my-project get shoot my-shoot -o jsonpath=<span style=color:#a31515>&#39;{.status.advertisedAddresses[?(@.name==&#34;service-account-issuer&#34;)].url}&#39;</span>
</span></span></code></pre></div><p>Once retrieved, the shoot&rsquo;s OIDC discovery documents can be explored by querying the <code>/.well-known/openid-configuration</code> endpoint of the issuer.</p><p>Mind that this annotation is incompatible with the <code>.spec.kubernetes.kubeAPIServer.serviceAccountConfig.issuer</code> field, so if you want to enable it then the <code>issuer</code> field should not be set in the shoot specification.</p><blockquote class="alert alert-caution"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-octagon-outline</title><path d="M8.27 3 3 8.27v7.46L8.27 21h7.46C17.5 19.24 21 15.73 21 15.73V8.27L15.73 3M9.1 5h5.8L19 9.1v5.8L14.9 19H9.1L5 14.9V9.1M11 15h2v2H11V15m0-8h2v6H11V7"/></svg><p>Caution</p></div><p>If you change from the default issuer to a managed issuer, all previously issued tokens will still be valid/accepted.
However, if you change from a custom <code>issuer</code> <code>A</code> to a managed issuer, then you have to add <code>A</code> to the <code>.spec.kubernetes.kubeAPIServer.serviceAccountConfig.acceptedIssuers</code> so that previously issued tokens are not invalidated.
Otherwise, the control plane components as well as system components and your workload pods might fail.
You can remove <code>A</code> from the <code>acceptedIssuers</code> when all currently active tokens have been issued solely by the managed issuer.
This can be ensured by using <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>projected token volumes</a> with a short validity, or by rolling out all pods.
Additionally, all <a href=https://kubernetes.io/docs/concepts/configuration/secret/#service-account-token-secrets><code>ServiceAccount</code> token secrets</a> should be recreated.
Apart from this, you should wait for at least <code>12h</code> to make sure the control plane and system components have received a new token from Gardener.</p></blockquote></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://demo.gardener.cloud>Demo</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://gardener-cloud.slack.com/><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://x.com/GardenerProject><img src=/images/branding/x-logo-white.svg class=media-icon><div class=media-text>X</div></a></li></ul><span class=copyright>Copyright 2019-2025 Gardener project authors.
<a href=https://www.sap.com/about/legal/terms-of-use.html>Terms of Use
<i class="fa fa-external-link" aria-hidden=true></i>
</a>|
<a href=https://www.sap.com/about/legal/terms-of-use.html>Privacy Statement
<i class="fa fa-external-link" aria-hidden=true></i>
</a>|
<a href=https://www.sap.com/about/legal/terms-of-use.html>Legal Disclosure
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script><script src=/js/navbar.js></script><script src=/js/filtering.js></script><script src=/js/page-content.js></script></body></html>