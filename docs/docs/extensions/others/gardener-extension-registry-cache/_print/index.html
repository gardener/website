<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.95.0"><link rel=canonical type=text/html href=https://gardener.cloud/docs/extensions/others/gardener-extension-registry-cache/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/extensions/others/gardener-extension-registry-cache/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Registry cache | Gardener</title><meta name=description content="Gardener extension controller which deploys pull-through caches for container registries."><meta property="og:title" content="Registry cache"><meta property="og:description" content="Gardener extension controller which deploys pull-through caches for container registries."><meta property="og:type" content="website"><meta property="og:url" content="https://gardener.cloud/docs/extensions/others/gardener-extension-registry-cache/"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Registry cache"><meta itemprop=description content="Gardener extension controller which deploys pull-through caches for container registries."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Registry cache"><meta name=twitter:description content="Gardener extension controller which deploys pull-through caches for container registries."><link rel=preload href=/scss/main.min.b5b806bb2cd9fe9ed809539377398aa9df0eb8ca0c983a6eae0b413d528d8f0e.css as=style><link href=/scss/main.min.b5b806bb2cd9fe9ed809539377398aa9df0eb8ca0c983a6eae0b413d528d8f0e.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.e6a0963b1e2d2c8d69cdf89eac05c569.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/extensions/others/gardener-extension-registry-cache/>Return to the regular view of this page</a>.</p></div><h1 class=title>Registry cache</h1><div class=lead>Gardener extension controller which deploys pull-through caches for container registries.</div><div class=content><h1 id=gardener-extension-for-registry-cachehttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Registry Cache</a></h1><p><a href=https://concourse.ci.gardener.cloud/teams/gardener-tests/pipelines/gardener-extension-registry-cache-main/jobs/main-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener-tests/pipelines/gardener-extension-registry-cache-main/jobs/main-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-registry-cache><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-registry-cache alt="Go Report Card"></a></p><p>Gardener extension controller which deploys pull-through caches for container registries.</p><h2 id=usage>Usage</h2><ul><li><a href=/docs/extensions/others/gardener-extension-registry-cache/configuration/>Configuring the Registry Cache Extension</a> - learn what is the use-case for a pull-through cache, how to enable it and configure it</li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/upstream-credentials/>How to provide credentials for upstream repository?</a></li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/migration-from-v1alpha1-to-v1alpha2/>Migration from <code>v1alpha1</code> to <code>v1alpha2</code></a> - learn how to migrate from the <code>v1alpha1</code> API version of the <code>RegistryConfig</code> to <code>v1alpha2</code></li></ul><h2 id=local-setup-and-development>Local setup and development</h2><ul><li><a href=/docs/extensions/others/gardener-extension-registry-cache/getting-started-locally/>Deploying Registry Cache Extension Locally</a> - learn how to set up a local development environment</li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/extension-registry-cache/>Developer Docs for Gardener Extension Registry Cache</a> - learn about the inner workings</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-87d8490f33137ca866b523574411cfbb>1 - Configuration</h1><h1 id=configuring-the-registry-cache-extension>Configuring the Registry Cache Extension</h1><h2 id=introduction>Introduction</h2><h3 id=use-case>Use-case</h3><p>For a Shoot cluster, the containerd daemon of every Node goes to the internet and fetches an image that it doesn&rsquo;t have locally in the Node&rsquo;s image cache. New Nodes are often created due to events such as auto-scaling (scale up), rolling update, or replacement of unhealthy Node. Such a new Node would need to pull all of the images of the Pods running on it from the internet because the Node&rsquo;s cache is initially empty. Pulling an image from a registry produces network traffic and registry costs. To avoid these network traffic and registry costs, you can use the registry-cache extension to run a registry as pull-through cache.</p><p>The following diagram shows a rough outline of how image pull looks like for a Shoot cluster <strong>without registry cache</strong>:
<img src=/__resources/shoot-cluster-without-registry-cache_7e2f53.png alt=shoot-cluster-without-registry-cache></p><h3 id=solution>Solution</h3><p>The registry-cache extension deploys and manages a registry in the Shoot cluster that runs as pull-through cache. The used registry implementation is <a href=https://github.com/distribution/distribution>distribution/distribution</a>.</p><h3 id=how-does-it-work>How does it work?</h3><p>When the extension is enabled, a registry cache for each configured upstream is deployed to the Shoot cluster. Along with this, the containerd daemon on the Shoot cluster Nodes gets configured to use as a mirror the Service IP address of the deployed registry cache. For example, if a registry cache for upstream <code>docker.io</code> is requested via the Shoot spec, then containerd gets configured to first pull the image from the deployed cache in the Shoot cluster. If this image pull operation fails, containerd falls back to the upstream itself (<code>docker.io</code> in that case).</p><p>The first time an image is requested from the pull-through cache, it pulls the image from the configured upstream registry and stores it locally before handing it back to the client. On subsequent requests, the pull-through cache is able to serve the image from its own storage.</p><blockquote><p>Note: The used registry implementation (<a href=https://github.com/distribution/distribution>distribution/distribution</a>) supports mirroring of only one upstream registry.</p></blockquote><p>The following diagram shows a rough outline of how image pull looks like for a Shoot cluster <strong>with registry cache</strong>:
<img src=/__resources/shoot-cluster-with-registry-cache_8634e1.png alt=shoot-cluster-with-registry-cache></p><h2 id=shoot-configuration>Shoot Configuration</h2><p>The extension is not globally enabled and must be configured per Shoot cluster. The Shoot specification has to be adapted to include the <code>registry-cache</code> extension configuration.</p><p>Below is an example of <code>registry-cache</code> extension configuration as part of the Shoot spec:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: crazy-botany
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: registry-cache
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: registry.extensions.gardener.cloud/v1alpha2
</span></span><span style=display:flex><span>      kind: RegistryConfig
</span></span><span style=display:flex><span>      caches:
</span></span><span style=display:flex><span>      - upstream: docker.io
</span></span><span style=display:flex><span>        volume:
</span></span><span style=display:flex><span>          size: 100Gi
</span></span><span style=display:flex><span>          storageClassName: premium
</span></span><span style=display:flex><span>      - upstream: ghcr.io
</span></span><span style=display:flex><span>      - upstream: quay.io
</span></span><span style=display:flex><span>        garbageCollection:
</span></span><span style=display:flex><span>          enabled: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>        secretReferenceName: quay-credentials
</span></span><span style=display:flex><span>  <span style=color:green># ...</span>
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - name: quay-credentials
</span></span><span style=display:flex><span>    resourceRef:
</span></span><span style=display:flex><span>      apiVersion: v1
</span></span><span style=display:flex><span>      kind: Secret
</span></span><span style=display:flex><span>      name: quay-credentials-v1
</span></span></code></pre></div><p>The <code>providerConfig</code> field is required.</p><p>The <code>providerConfig.caches</code> field contains information about the registry caches to deploy. It is a required field. At least one cache has to be specified.</p><p>The <code>providerConfig.caches[].upstream</code> field is the remote registry host to cache. It is a required field.
The value must be a valid DNS subdomain (RFC 1123). It must not include a scheme or port. The configured upstream registry must be accessible by <code>https</code> (<code>https://</code> is the assumed scheme).</p><p>The <code>providerConfig.caches[].volume</code> field contains settings for the registry cache volume.
The registry-cache extension deploys a StatefulSet with a volume claim template. A PersistentVolumeClaim is created with the configured size and StorageClass name.</p><p>The <code>providerConfig.caches[].volume.size</code> field is the size of the registry cache. Defaults to <code>10Gi</code>. The size must be a positive quantity (greater than 0).
This field is immutable. See <a href=/docs/extensions/others/gardener-extension-registry-cache/configuration/#increase-the-cache-disk-size>Increase the cache disk size</a> on how to resize the disk.</p><p>The <code>providerConfig.caches[].volume.storageClassName</code> field is the name of the StorageClass used by the registry cache volume.
This field is immutable. If the field is not specified, then the <a href=https://kubernetes.io/docs/concepts/storage/storage-classes/#default-storageclass>default StorageClass</a> will be used.</p><p>The <code>providerConfig.caches[].garbageCollection.enabled</code> field enables/disables the cache&rsquo;s garbage collection. Defaults to <code>true</code>. The time to live (ttl) for an image is <code>7d</code>. See the <a href=/docs/extensions/others/gardener-extension-registry-cache/configuration/#garbage-collection>garbage collection section</a> for more details.</p><p>The <code>providerConfig.caches[].secretReferenceName</code> is the name of the reference for the Secret containing the upstream registry credentials. To cache images from a private registry, credentials to the upstream registry should be supplied. For details see <a href=/docs/extensions/others/gardener-extension-registry-cache/upstream-credentials/#how-to-provide-credentials-for-upstream-registry>How to provide credentials for upstream registry</a>.</p><blockquote><p><strong>Note</strong>: It&rsquo;s only possible to provide one set of credentials for one private upstream registry.</p></blockquote><h2 id=garbage-collection>Garbage Collection</h2><p>When the registry cache receives a request for an image that is not present in its local store, it fetches the image from the upstream, returns it to the client and stores the image in the local store. The registry cache runs a scheduler that deletes images when their time to live (ttl) expires. When adding an image to the local store, the registry cache also adds a time to live for the image. The ttl value is <code>7d</code>. Requesting an image from the registry cache does not extend the time to live of the image. Hence, an image is always garbage collected from the registry cache store after <code>7d</code>.
At the time of writing this document, there is no functionality for garbage collection based on disk size - e.g. garbage collecting images when a certain disk usage threshold is passed.
The garbage collection cannot be enabled once it is disabled. This constraint is added to mitigate <a href=https://github.com/distribution/distribution/issues/4249>distribution/distribution#4249</a>.</p><h2 id=increase-the-cache-disk-size>Increase the cache disk size</h2><p>When there is no available disk space, the registry cache continues to respond to requests. However, it cannot store the remotely fetched images locally because it has no free disk space. In such case, it is simply acting as a proxy without being able to cache the images in its local store. The disk has to be resized to ensure that the registry cache continues to cache images.</p><p>There are two alternatives to enlarge the cache&rsquo;s disk size.</p><h4 id=alternative-1-resize-the-pvc>[Alternative 1] Resize the PVC</h4><p>To enlarge the PVC&rsquo;s size follow the following steps:</p><ol><li><p>Make sure that the <code>KUBECONFIG</code> environment variable is targeting the correct Shoot cluster.</p></li><li><p>Find the PVC name to resize for the desired upstream. The below example fetches the PVC for the <code>docker.io</code> upstream:</p><pre tabindex=0><code>% kubectl -n kube-system get pvc -l upstream-host=docker.io
</code></pre></li><li><p>Patch the PVC&rsquo;s size to the desired size. The below example patches the size of a PVC to <code>10Gi</code>:</p><pre tabindex=0><code>% kubectl -n kube-system patch pvc $PVC_NAME --type merge -p &#39;{&#34;spec&#34;:{&#34;resources&#34;:{&#34;requests&#34;: {&#34;storage&#34;: &#34;10Gi&#34;}}}}&#39;
</code></pre></li><li><p>Make sure that the PVC gets resized. Describe the PVC to check the resize operation result:</p><pre tabindex=0><code>% kubectl -n kube-system describe pvc -l upstream-host=docker.io
</code></pre></li></ol><blockquote><p>Drawback of this approach: The cache&rsquo;s size in the Shoot spec (<code>providerConfig.caches[].size</code>) diverges from the PVC&rsquo;s size.</p></blockquote><h4 id=alternative-2-remove-and-re-add-the-cache>[Alternative 2] Remove and re-add the cache</h4><p>There is always the option to remove the cache from the Shoot spec and to re-add it again with the updated size.</p><blockquote><p>Drawback of this approach: The already cached images get lost and the cache starts with an empty disk.</p></blockquote><h2 id=high-availability>High-availability</h2><p>The registry cache runs with a single replica. This fact may lead to concerns for the high-availability such as &ldquo;What happens when the registry cache is down? Does containerd fail to pull the image?&rdquo;. As outlined in the <a href=/docs/extensions/others/gardener-extension-registry-cache/configuration/#how-does-it-work>How does it work? section</a>, containerd is configured to fall back to the upstream registry if it fails to pull the image from the registry cache. Hence, when the registry cache is unavailable, the containerd&rsquo;s image pull operations are not affected because containerd falls back to image pull from the upstream registry.</p><h2 id=gotchas>Gotchas</h2><ul><li>The used registry implementation (<a href=https://github.com/distribution/distribution>distribution/distribution</a>) supports mirroring of only one upstream registry. The extension deploys a pull-through cache for each configured upstream.</li><li><code>us-docker.pkg.dev</code>, <code>europe-docker.pkg.dev</code>, and <code>asia-docker.pkg.dev</code> are different upstreams. Hence, configuring <code>pkg.dev</code> as upstream won&rsquo;t cache images from <code>us-docker.pkg.dev</code>, <code>europe-docker.pkg.dev</code>, or <code>asia-docker.pkg.dev</code>.</li></ul><h2 id=limitations>Limitations</h2><ol><li><p>Images that are pulled before a registry cache Pod is running or before a registry cache Service is reachable from the corresponding Node won&rsquo;t be cached - containerd will pull these images directly from the upstream.</p><p>The reasoning behind this limitation is that a registry cache Pod is running in the Shoot cluster. To have a registry cache&rsquo;s Service cluster IP reachable from containerd running on the Node, the registry cache Pod has to be running and kube-proxy has to configure iptables/IPVS rules for the registry cache Service. If kube-proxy hasn&rsquo;t configured iptables/IPVS rules for the registry cache Service, then the image pull times (and new Node bootstrap times) will be increased significantly. For more detailed explanations, see point 2. and <a href=https://github.com/gardener/gardener-extension-registry-cache/pull/68>https://github.com/gardener/gardener-extension-registry-cache/pull/68</a>.</p><p>That&rsquo;s why the registry configuration on a Node is applied only after the registry cache Service is reachable from the Node. The <code>configure-containerd-registries.service</code> systemd unit sends requests to the registry cache&rsquo;s Service. Once the registry cache responds with <code>HTTP 200</code>, the unit creates the needed registry configuration file (<code>hosts.toml</code>).</p><p>As a result, for images from Shoot system components:</p><ul><li>On Shoot creation with the registry cache extension enabled a registry cache is unable to cache all of the images from the Shoot system components. Usually, until the registry cache Pod is running containerd pulls from upstream the images from Shoot system components (before the registry configuration gets applied).</li><li>On new Node creation for existing Shoot with the registry cache extension enabled, a registry cache is unable to cache most of the images from Shoot system components. The reachability of the registry cache Service requires the Service network to be set up, i.e. the kube-proxy for that new Node to be running and to have set up iptables/IPVS configuration for the registry cache Service.</li></ul></li><li><p>containerd requests will time out in 30s in case kube-proxy hasn&rsquo;t configured iptables/IPVS rules for the registry cache Service - the image pull times will increase significantly.</p><p>containerd is configured to fall back to the upstream itself if a request against the cache fails. However, if the cluster IP of the registry cache Service does not exist or if kube-proxy hasn&rsquo;t configured iptables/IPVS rules for the registry cache Service, then containerd requests against the registry cache time out in 30 seconds. This increases significantly the image pull times because containerd does multiple requests as part of the image pull (HEAD request to resolve the manifest by tag, GET request for the manifest by SHA, GET requests for blobs)</p><p>Example: If the Service of a registry cache is deleted, then a new Service will be created. containerd registry config will still contain the old Service&rsquo;s cluster IP. containerd requests against the old Service&rsquo;s cluster IP will time out and containerd will fall back to upstream.</p><ul><li>Image pull of <code>docker.io/library/alpine:3.13.2</code> from the upstream takes ~2s while image pull of the same image with invalid registry cache cluster IP takes ~2m.2s.</li><li>Image pull of <code>eu.gcr.io/gardener-project/gardener/ops-toolbelt:0.18.0</code> from the upstream takes ~10s while image pull of the same image with invalid registry cache cluster IP takes ~3m.10s.</li></ul></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-c7f55909c55d9671db41105c674d8223>2 - Extension Registry Cache</h1><h1 id=developer-docs-for-gardener-extension-registry-cache>Developer Docs for Gardener Extension Registry Cache</h1><p>This document outlines how the Shoot reconciliation and deletion work for a Shoot with the registry-cache extension enabled.</p><h2 id=shoot-reconciliation>Shoot reconciliation</h2><p>This section outlines how the reconciliation works for a Shoot with the registry-cache extension enabled.</p><h4 id=extension-enablementreconciliation>Extension enablement/reconciliation</h4><p>This section outlines how the extension enablement/reconciliation works, e.g the extension has beeen added to the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, gardenlet deploys the <a href=https://github.com/gardener/gardener/blob/v1.82.0/docs/extensions/extension.md>Extension</a> resource.</li><li>The registry-cache extension reconciles the Extension resource. <a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/pkg/controller/extension/actuator.go>pkg/controller/extension/actuator.go</a> contains the implementation of the <a href=https://github.com/gardener/gardener/blob/v1.82.0/extensions/pkg/controller/extension/actuator.go>extension.Actuator</a> interface. The reconciliation of an Extension of type <code>registry-cache</code> consists of the following steps:<ol><li>The extension checks if a registry has been removed (by comparing the status and the spec of the Extension). If an upstream is being removed, then it deploys the <a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/pkg/component/registryconfigurationcleaner/registry_configuration_cleaner.go><code>registry-cleaner</code> DaemonSet</a> to the Shoot cluster to clean up the existing configuration for the upstream that has to be removed.</li><li>The registry-cache extension deploys resources to the Shoot cluster via ManagedResource. For every configured upstream it creates a StatefulSet (with PVC), Service and other resources.</li><li>It lists all Services from the <code>kube-system</code> namespace having the <code>upstream-host</code> label. It will return an error (and retry in exponential backoff) until the Services count matches the configured registries count.</li><li>When there is a Service created for each configured upstream registry, the registry-cache extension populates the Extension resource status. In the Extension status, for each upstream, it maintains an endpoint (in format <code>http://&lt;cluster-ip>:5000</code>) which can be used to access the registry cache from within the Shoot cluster. <code>&lt;cluster-ip></code> is the cluster IP of the registry cache Service. The cluster IP of a Service is assigned by the Kubernetes API server on Service creation.</li></ol></li><li>As part of the Shoot reconciliation flow, gardenlet deploys the <a href=https://github.com/gardener/gardener/blob/v1.82.0/docs/extensions/operatingsystemconfig.md>OperatingSystemConfig</a> resource.</li><li>The registry-cache extension serves a webhook that mutates the OperatingSystemConfig resource for Shoots having the registry-cache extension enabled (the corresponding namespace gets labeled by gardenlet with <code>extensions.gardener.cloud/registry-cache=true</code>). <a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/pkg/webhook/operatingsystemconfig/ensurer.go>pkg/webhook/operatingsystemconfig/ensurer.go</a> contains implementation of the <a href=https://github.com/gardener/gardener/blob/v1.82.0/extensions/pkg/webhook/controlplane/genericmutator/mutator.go>genericmutator.Ensurer</a> interface.<ol><li>The webhook appends the <a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/pkg/webhook/operatingsystemconfig/scripts/configure-containerd-registries.sh>configure-containerd-registries.sh</a> script to the OperatingSystemConfig files. The script accepts registries in the format <code>&lt;upstream_host>,&lt;registry_cache_endpoint>,&lt;upstream_url></code> separated by a space. For each given registry the script waits until the given registry is available (a request to the <code>&lt;registry_cache_endpoint></code> succeeds). Then it creates a <code>hosts.toml</code> file for the given <code>&lt;upstream_host></code>. In short, the <code>hosts.toml</code> file instructs containerd to first try to pull images for the given <code>&lt;upstream_host></code> from the configured <code>&lt;registry_cache_endpoint></code>. For more information about containerd registry configuration, see the <a href=https://github.com/containerd/containerd/blob/main/docs/hosts.md>containerd documentation</a>. The motivation to introduce the <code>configure-containerd-registries.sh</code> script is that we need to create the <code>hosts.toml</code> file when the corresponding registry is available. For more details, see <a href=https://github.com/gardener/gardener-extension-registry-cache/pull/68>https://github.com/gardener/gardener-extension-registry-cache/pull/68</a>.</li><li>The webhook appends the <code>configure-containerd-registries.service</code> unit to the OperatingSystemConfig units. The webhook fetches the Extension resource and then it configures the unit to invoke the <code>configure-containerd-registries.sh</code> script with the registries from the Extension status.</li></ol></li></ol><h4 id=extension-disablement>Extension disablement</h4><p>This section outlines how the extension disablement works, i.e the extension has be removed from the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, gardenlet destroys the <a href=https://github.com/gardener/gardener/blob/v1.82.0/docs/extensions/extension.md>Extension</a> resource because it is no longer needed.<ol><li>If the Extension resource contains registries in its status, the registry-cache extension deploys the <a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/pkg/component/registryconfigurationcleaner/registry_configuration_cleaner.go><code>registry-cleaner</code> DaemonSet</a> to the Shoot cluster to clean up the existing registry configuration.</li><li>The extension deletes the ManagedResource containing the registry cache resources.</li></ol></li></ol><h2 id=shoot-deletion>Shoot deletion</h2><p>This section outlines how the deletion works for a Shoot with the registry-cache extension enabled.</p><ol><li>As part of the Shoot deletion flow, gardenlet destroys the <a href=https://github.com/gardener/gardener/blob/v1.82.0/docs/extensions/extension.md>Extension</a> resource.<ol><li>In the Shoot deletion flow the Extension resource is deleted after the Worker resource. Hence, there is no need to deploy the <a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/pkg/component/registryconfigurationcleaner/registry_configuration_cleaner.go><code>registry-cleaner</code> DaemonSet</a> to the Shoot cluster to clean up the existing registry configuration.</li><li>The extension deletes the ManagedResource containing the registry cache resources.</li></ol></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-6292d6e3adb445c003eb0156582838fc>3 - Getting Started Locally</h1><h1 id=deploying-registry-cache-extension-locally>Deploying Registry Cache Extension Locally</h1><h2 id=prerequisites>Prerequisites</h2><ul><li>Make sure that you have a running local Gardener setup. The steps to complete this can be found in the <a href=/docs/gardener/deployment/getting_started_locally/>Deploying Gardener Locally guide</a>.</li></ul><h2 id=setting-up-the-registry-cache-extension>Setting up the Registry Cache Extension</h2><p>Make sure that your <code>KUBECONFIG</code> environment variable is targeting the local Gardener cluster. When this is ensured, run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-up
</span></span></code></pre></div><p>The corresponding make target will build the extension image, load it into the kind cluster Nodes, and deploy the registry-cache ControllerDeployment and ControllerRegistration resources. The container image in the ControllerDeployment will be the image that was build and loaded into the kind cluster Nodes.</p><p>The make target will then deploy then registry-cache admission component. It will build the admission image, load it into the kind cluster Nodes, and finally install the admission component charts to the kind cluster.</p><h2 id=creating-a-shoot-cluster>Creating a <code>Shoot</code> Cluster</h2><p>Once the above step is completed you can create a Shoot cluster. Review the Shoot specification in <a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/example/shoot.yaml><code>example/shoot.yaml</code></a>. Create the Shoot:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f example/shoot.yaml
</span></span></code></pre></div><h2 id=tearing-down-the-dev-environment>Tearing Down the Dev Environment</h2><p>To tear down the development environment delete the Shoot cluster or disable the <code>registry-cache</code> extension in the Shoot&rsquo;s specification. When the extension is not used by the Shoot anymore, you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-down
</span></span></code></pre></div><p>The make target will delete the ControllerDeployment and ControllerRegistration of the extension, and the registry-cache admission helm deployment.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-bcc26d03c6847a4b525645d597bb7ce6>4 - Migration From V1alpha1 To V1alpha2</h1><h1 id=migration-from-v1alpha1-to-v1alpha2>Migration from <code>v1alpha1</code> to <code>v1alpha2</code></h1><p>This document descibres how to migrate from API version <code>registry.extensions.gardener.cloud/v1alpha1</code> of the <code>RegistryConfig</code> to <code>registry.extensions.gardener.cloud/v1alpha2</code>.</p><p>The <code>registry.extensions.gardener.cloud/v1alpha1</code> is deprecated and will be removed in a future version. Use <code>registry.extensions.gardener.cloud/v1alpha2</code> instead.</p><p>Let&rsquo;s first inspect how the <code>RegistryConfig</code> looks like in API version <code>registry.extensions.gardener.cloud/v1alpha1</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: registry.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: RegistryConfig
</span></span><span style=display:flex><span>caches:
</span></span><span style=display:flex><span>- upstream: docker.io
</span></span><span style=display:flex><span>  size: 10Gi
</span></span><span style=display:flex><span>  garbageCollection:
</span></span><span style=display:flex><span>    enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  secretReferenceName: docker-credentials
</span></span></code></pre></div><p>The translation of the above <code>RegistryConfig</code> in API version <code>registry.extensions.gardener.cloud/v1alpha2</code> is:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: registry.extensions.gardener.cloud/v1alpha2
</span></span><span style=display:flex><span>kind: RegistryConfig
</span></span><span style=display:flex><span>caches:
</span></span><span style=display:flex><span>- upstream: docker.io
</span></span><span style=display:flex><span>  volume:
</span></span><span style=display:flex><span>    size: 10Gi
</span></span><span style=display:flex><span>    storageClassName: default
</span></span><span style=display:flex><span>  garbageCollection:
</span></span><span style=display:flex><span>    enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  secretReferenceName: docker-credentials
</span></span></code></pre></div><p>As you can notice, there is one breaking change in API version <code>registry.extensions.gardener.cloud/v1alpha2</code> - the <code>caches[].size</code> field is moved to <code>caches[].volume.size</code>.</p><p><code>registry.extensions.gardener.cloud/v1alpha2</code> also adds a new field <code>caches[].volume.storageClassName</code>. In <code>v1alpha1</code> the StorageClass name was not configurable and the registry-cache extension assumed the StorageClass name to be <code>default</code>. When migrating from <code>v1alpha1</code> to <code>v1alpha2</code>, the <code>caches[].volume.storageClassName</code> field has to be set to <code>default</code>. This is required due to backwards-compatibility reasons for registry caches created according to the <code>v1alpha1</code> API version.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c91d6cfd4f3d49b959122675e2c865e7>5 - Upstream Credentials</h1><h1 id=how-to-provide-credentials-for-upstream-registry>How to provide credentials for upstream registry?</h1><p>In order to pull private images through registry cache, it is required to supply credentials for the private upstream registry.</p><h2 id=how-to-configure-the-registry-cache-to-use-upstream-registry-credentials>How to configure the registry cache to use upstream registry credentials?</h2><ol><li><p>Create an immutable Secret with the upstream registry credentials in the Garden cluster</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>% kubectl create -f - <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: ro-docker-secret-v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: garden-dev
</span></span></span><span style=display:flex><span><span style=color:#a31515>type: Opaque
</span></span></span><span style=display:flex><span><span style=color:#a31515>immutable: true
</span></span></span><span style=display:flex><span><span style=color:#a31515>data:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  username: $(echo -n $USERNAME | base64 -w0)
</span></span></span><span style=display:flex><span><span style=color:#a31515>  password: $(echo -n $PASSWORD | base64 -w0)
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>For Artifact Registry, the username is <code>_json_key</code> and the password is the service account key in JSON format. To base64 encode the service account key, copy it and run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>% echo -n $SERVICE_ACCOUNT_KEY_JSON | base64 -w0
</span></span></code></pre></div></li><li><p>Add the newly created Secret as a reference to the Shoot spec, and then to the registry-cache extension configuration</p><p>In the registry-cache configuration set the <code>secretReferenceName</code> field. It should point to a resource reference under <code>spec.resources</code>. The resource reference itself points to the Secret in project namespace.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span><span style=color:green># ...</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: registry-cache
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: registry.extensions.gardener.cloud/v1alpha2
</span></span><span style=display:flex><span>      kind: RegistryConfig
</span></span><span style=display:flex><span>      caches:
</span></span><span style=display:flex><span>      - upstream: docker.io
</span></span><span style=display:flex><span>        secretReferenceName: docker-secret
</span></span><span style=display:flex><span>  <span style=color:green># ...</span>
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - name: docker-secret
</span></span><span style=display:flex><span>    resourceRef:
</span></span><span style=display:flex><span>      apiVersion: v1
</span></span><span style=display:flex><span>      kind: Secret
</span></span><span style=display:flex><span>      name: ro-docker-secret-v1
</span></span><span style=display:flex><span><span style=color:green># ...</span>
</span></span></code></pre></div></li></ol><h2 id=how-to-rotate-the-registry-credentials>How to rotate the registry credentials?</h2><p>To rotate registry credentials perform the following steps:</p><ol><li>Generate new pair of credentials in the cloud provider account. Do not invalidate the old ones.</li><li>Create a new Secret (e.g. <code>ro-docker-secret-v2</code>) with the newly generated credentials as described step 1. in <a href=/docs/extensions/others/gardener-extension-registry-cache/upstream-credentials/#how-to-configure-the-registry-cache-to-use-upstream-registry-credentials>How to configure the registry cache to use upstream registry credentials?</a>.</li><li>Update the Shoot spec with newly created Secret as described step 2. in <a href=/docs/extensions/others/gardener-extension-registry-cache/upstream-credentials/#how-to-configure-the-registry-cache-to-use-upstream-registry-credentials>How to configure the registry cache to use upstream registry credentials?</a>.
1 The above step will trigger a Shoot reconciliation. Wait for the Shoot reconciliation to complete.</li><li>Make sure that the old Secret is no longer referenced by any Shoot cluster. Finally, delete the Secret containing the old credentials (e.g. <code>ro-docker-secret-v1</code>).</li><li>Delete the corresponding old credentials from the cloud provider account.</li></ol><h2 id=gotchas>Gotchas</h2><ul><li>The registry cache provides the credentials for every request against the corresponding upstream. In some cases, misconfigured credentials can prevent the registry cache to pull even public images from the upstream (for example: invalid service account key for Artifact Registry). However, this behaviour is controlled by the server-side logic of the upstream registry.</li></ul></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2023 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid@8.13.4/dist/mermaid.min.js integrity="sha512-JERecFUBbsm75UpkVheAuDOE8NdHjQBrPACfEQYPwvPG+fjgCpHAz1Jw2ci9EXmd3DdfiWth3O3CQvcfEg8gsA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.7b24c0fb082ffb2de6cb14d6c95e9f8053053709ffcf8c761ef8e9ad2f8021e4.js integrity="sha256-eyTA+wgv+y3myxTWyV6fgFMFNwn/z4x2HvjprS+AIeQ=" crossorigin=anonymous></script></body></html>