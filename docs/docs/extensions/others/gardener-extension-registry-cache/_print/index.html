<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://gardener.cloud/docs/extensions/others/gardener-extension-registry-cache/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/extensions/others/gardener-extension-registry-cache/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Registry cache | Gardener</title>
<meta name=description content="Gardener extension controller which deploys pull-through caches for container registries."><meta property="og:url" content="https://gardener.cloud/docs/extensions/others/gardener-extension-registry-cache/"><meta property="og:site_name" content="Gardener"><meta property="og:title" content="Registry cache"><meta property="og:description" content="Gardener extension controller which deploys pull-through caches for container registries."><meta property="og:locale" content="en_US"><meta property="og:type" content="website"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Registry cache"><meta itemprop=description content="Gardener extension controller which deploys pull-through caches for container registries."><meta itemprop=wordCount content="146"><meta itemprop=image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Registry cache"><meta name=twitter:description content="Gardener extension controller which deploys pull-through caches for container registries."><link rel=preload href=/scss/main.min.49c1324f1f1dba4c9ef68ad97115fa0ab62113d3bc7c5137b64b13a0cfb423c4.css as=style integrity="sha256-ScEyTx8dukye9orZcRX6CrYhE9O8fFE3tksToM+0I8Q=" crossorigin=anonymous><link href=/scss/main.min.49c1324f1f1dba4c9ef68ad97115fa0ab62113d3bc7c5137b64b13a0cfb423c4.css rel=stylesheet integrity="sha256-ScEyTx8dukye9orZcRX6CrYhE9O8fFE3tksToM+0I8Q=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://demo.gardener.cloud target=_blank><span>Demo</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><div class=dropdown><a href=/docs class=nav-link>Documentation</a><div class=dropdown-content><a class=taxonomy-term href=/docs>Users</a>
<a class=taxonomy-term href=/docs>Operators</a>
<a class=taxonomy-term href=/docs>Developers</a>
<a class=taxonomy-term href=/docs>All</a></div></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.89265b21c8b4ed2231c4d9de9b8de8a1.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/extensions/others/gardener-extension-registry-cache/>Return to the regular view of this page</a>.</p></div><h1 class=title>Registry cache</h1><div class=lead>Gardener extension controller which deploys pull-through caches for container registries.</div><div class=content><h1 id=gardener-extension-for-registry-cachehttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Registry Cache</a><a class=td-heading-self-link href=#gardener-extension-for-registry-cachehttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-registry-cache><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-registry-cache alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-registry-cache-main/jobs/main-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-registry-cache-main/jobs/main-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-registry-cache><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-registry-cache alt="Go Report Card"></a></p><p>Gardener extension controller which deploys pull-through caches for container registries.</p><h2 id=usage>Usage<a class=td-heading-self-link href=#usage aria-label="Heading self-link"></a></h2><ul><li><a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/configuration/>Configuring the Registry Cache Extension</a> - learn what is the use-case for a pull-through cache, how to enable it and configure it</li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/upstream-credentials/>How to provide credentials for upstream repository?</a></li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/observability/>Registry Cache Observability</a> - learn what metrics and alerts are exposed and how to view the registry cache logs</li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/registry-mirror/configuration/>Configuring the Registry Mirror Extension</a> - learn what is the use-case for a registry mirror, how to enable and configure it</li></ul><h2 id=local-setup-and-development>Local Setup and Development<a class=td-heading-self-link href=#local-setup-and-development aria-label="Heading self-link"></a></h2><ul><li><a href=/docs/extensions/others/gardener-extension-registry-cache/getting-started-locally/>Deploying Registry Cache Extension Locally</a> - learn how to set up a local development environment</li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/getting-started-remotely/>Deploying Registry Cache Extension in Gardener&rsquo;s Local Setup with Provider Extensions</a> - learn how to set up a development environment using own Seed clusters on an existing Kubernetes cluster</li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/extension-registry-cache/>Developer Docs for Gardener Extension Registry Cache</a> - learn about the inner workings</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-b3f12d97b4af322636c2e0cc80685cc8>1 - Configuring the Registry Cache Extension</h1><div class=lead>Learn what is the use-case for a pull-through cache, how to enable it and configure it</div><h1 id=configuring-the-registry-cache-extension>Configuring the Registry Cache Extension<a class=td-heading-self-link href=#configuring-the-registry-cache-extension aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><h3 id=use-case>Use Case<a class=td-heading-self-link href=#use-case aria-label="Heading self-link"></a></h3><p>For a Shoot cluster, the containerd daemon of every Node goes to the internet and fetches an image that it doesn&rsquo;t have locally in the Node&rsquo;s image cache. New Nodes are often created due to events such as auto-scaling (scale up), rolling update, or replacement of unhealthy Node. Such a new Node would need to pull all of the images of the Pods running on it from the internet because the Node&rsquo;s cache is initially empty. Pulling an image from a registry produces network traffic and registry costs. To avoid these network traffic and registry costs, you can use the registry-cache extension to run a registry as pull-through cache.</p><p>The following diagram shows a rough outline of how an image pull looks like for a Shoot cluster <strong>without registry cache</strong>:
<img src=/__resources/shoot-cluster-without-registry-cache_e266ba.png alt=shoot-cluster-without-registry-cache></p><h3 id=solution>Solution<a class=td-heading-self-link href=#solution aria-label="Heading self-link"></a></h3><p>The registry-cache extension deploys and manages a registry in the Shoot cluster that runs as pull-through cache. The used registry implementation is <a href=https://github.com/distribution/distribution>distribution/distribution</a>.</p><h3 id=how-does-it-work>How does it work?<a class=td-heading-self-link href=#how-does-it-work aria-label="Heading self-link"></a></h3><p>When the extension is enabled, a registry cache for each configured upstream is deployed to the Shoot cluster. Along with this, the containerd daemon on the Shoot cluster Nodes gets configured to use as a mirror the Service IP address of the deployed registry cache. For example, if a registry cache for upstream <code>docker.io</code> is requested via the Shoot spec, then containerd gets configured to first pull the image from the deployed cache in the Shoot cluster. If this image pull operation fails, containerd falls back to the upstream itself (<code>docker.io</code> in that case).</p><p>The first time an image is requested from the pull-through cache, it pulls the image from the configured upstream registry and stores it locally, before handing it back to the client. On subsequent requests, the pull-through cache is able to serve the image from its own storage.</p><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>The used registry implementation (<a href=https://github.com/distribution/distribution>distribution/distribution</a>) supports mirroring of only one upstream registry.</p></blockquote><p>The following diagram shows a rough outline of how an image pull looks like for a Shoot cluster <strong>with registry cache</strong>:
<img src=/__resources/shoot-cluster-with-registry-cache_9e6b5f.png alt=shoot-cluster-with-registry-cache></p><h2 id=shoot-configuration>Shoot Configuration<a class=td-heading-self-link href=#shoot-configuration aria-label="Heading self-link"></a></h2><p>The extension is not globally enabled and must be configured per Shoot cluster. The Shoot specification has to be adapted to include the <code>registry-cache</code> extension configuration.</p><p>Below is an example of <code>registry-cache</code> extension configuration as part of the Shoot spec:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: crazy-botany
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: registry-cache
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: registry.extensions.gardener.cloud/v1alpha3
</span></span><span style=display:flex><span>      kind: RegistryConfig
</span></span><span style=display:flex><span>      caches:
</span></span><span style=display:flex><span>      - upstream: docker.io
</span></span><span style=display:flex><span>        volume:
</span></span><span style=display:flex><span>          size: 100Gi
</span></span><span style=display:flex><span>          <span style=color:green># storageClassName: premium</span>
</span></span><span style=display:flex><span>      - upstream: ghcr.io
</span></span><span style=display:flex><span>      - upstream: quay.io
</span></span><span style=display:flex><span>        garbageCollection:
</span></span><span style=display:flex><span>          ttl: 0s
</span></span><span style=display:flex><span>        secretReferenceName: quay-credentials
</span></span><span style=display:flex><span>      - upstream: my-registry.io:5000
</span></span><span style=display:flex><span>        remoteURL: http://my-registry.io:5000
</span></span><span style=display:flex><span>  <span style=color:green># ...</span>
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - name: quay-credentials
</span></span><span style=display:flex><span>    resourceRef:
</span></span><span style=display:flex><span>      apiVersion: v1
</span></span><span style=display:flex><span>      kind: Secret
</span></span><span style=display:flex><span>      name: quay-credentials-v1
</span></span></code></pre></div><p>The <code>providerConfig</code> field is required.</p><p>The <code>providerConfig.caches</code> field contains information about the registry caches to deploy. It is a required field. At least one cache has to be specified.</p><p>The <code>providerConfig.caches[].upstream</code> field is the remote registry host to cache. It is a required field.
The value must be a valid DNS subdomain (RFC 1123) and optionally a port (i.e. <code>&lt;host>[:&lt;port>]</code>). It must not include a scheme.</p><p>The <code>providerConfig.caches[].remoteURL</code> optional field is the remote registry URL. If configured, it must include an <code>https://</code> or <code>http://</code> scheme.
If the field is not configured, the remote registry URL defaults to <code>https://&lt;upstream></code>. In case the upstream is <code>docker.io</code>, it defaults to <code>https://registry-1.docker.io</code>.</p><p>The <code>providerConfig.caches[].volume</code> field contains settings for the registry cache volume.
The registry-cache extension deploys a StatefulSet with a volume claim template. A PersistentVolumeClaim is created with the configured size and StorageClass name.</p><p>The <code>providerConfig.caches[].volume.size</code> field is the size of the registry cache volume. Defaults to <code>10Gi</code>. The size must be a positive quantity (greater than 0).
This field is immutable. See <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/configuration/#increase-the-cache-disk-size>Increase the cache disk size</a> on how to resize the disk.
The extension defines alerts for the volume. More information about the registry cache alerts and how to enable notifications for them can be found in the <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/observability/#alerts>alerts documentation</a>.</p><p>The <code>providerConfig.caches[].volume.storageClassName</code> field is the name of the StorageClass used by the registry cache volume.
This field is immutable. If the field is not specified, then the <a href=https://kubernetes.io/docs/concepts/storage/storage-classes/#default-storageclass>default StorageClass</a> will be used.</p><p>The <code>providerConfig.caches[].garbageCollection.ttl</code> field is the time to live of a blob in the cache. If the field is set to <code>0s</code>, the garbage collection is disabled. Defaults to <code>168h</code> (7 days). See the <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/configuration/#garbage-collection>Garbage Collection section</a> for more details.</p><p>The <code>providerConfig.caches[].secretReferenceName</code> is the name of the reference for the Secret containing the upstream registry credentials. To cache images from a private registry, credentials to the upstream registry should be supplied. For more details, see <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/upstream-credentials/#how-to-provide-credentials-for-upstream-registry>How to provide credentials for upstream registry</a>.</p><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>It is only possible to provide one set of credentials for one private upstream registry.</p></blockquote><p>The <code>providerConfig.caches[].proxy.httpProxy</code> field represents the proxy server for HTTP connections which is used by the registry cache. It must include an <code>https://</code> or <code>http://</code> scheme.</p><p>The <code>providerConfig.caches[].proxy.httpsProxy</code> field represents the proxy server for HTTPS connections which is used by the registry cache. It must include an <code>https://</code> or <code>http://</code> scheme.</p><p>The <code>providerConfig.caches[].http.tls</code> field indicates whether TLS is enabled for the HTTP server of the registry cache. Defaults to <code>true</code>.</p><h2 id=garbage-collection>Garbage Collection<a class=td-heading-self-link href=#garbage-collection aria-label="Heading self-link"></a></h2><p>When the registry cache receives a request for an image that is not present in its local store, it fetches the image from the upstream, returns it to the client and stores the image in the local store. The registry cache runs a scheduler that deletes images when their time to live (ttl) expires. When adding an image to the local store, the registry cache also adds a time to live for the image. The ttl defaults to <code>168h</code> (7 days) and is configurable. The garbage collection can be disabled by setting the ttl to <code>0s</code>. Requesting an image from the registry cache does not extend the time to live of the image. Hence, an image is always garbage collected from the registry cache store when its ttl expires.
At the time of writing this document, there is no functionality for garbage collection based on disk size - e.g., garbage collecting images when a certain disk usage threshold is passed.
The garbage collection cannot be enabled once it is disabled. This constraint is added to mitigate <a href=https://github.com/distribution/distribution/issues/4249>distribution/distribution#4249</a>.</p><h2 id=increase-the-cache-disk-size>Increase the Cache Disk Size<a class=td-heading-self-link href=#increase-the-cache-disk-size aria-label="Heading self-link"></a></h2><p>When there is no available disk space, the registry cache continues to respond to requests. However, it cannot store the remotely fetched images locally because it has no free disk space. In such case, it is simply acting as a proxy without being able to cache the images in its local store. The disk has to be resized to ensure that the registry cache continues to cache images.</p><p>There are two alternatives to enlarge the cache&rsquo;s disk size:</p><h3 id=alternative-1-resize-the-pvc>[Alternative 1] Resize the PVC<a class=td-heading-self-link href=#alternative-1-resize-the-pvc aria-label="Heading self-link"></a></h3><p>To enlarge the PVC&rsquo;s size, perform the following steps:</p><ol><li><p>Make sure that the <code>KUBECONFIG</code> environment variable is targeting the correct Shoot cluster.</p></li><li><p>Find the PVC name to resize for the desired upstream. The below example fetches the PVC for the <code>docker.io</code> upstream:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n kube-system get pvc -l upstream-host=docker.io
</span></span></code></pre></div></li><li><p>Patch the PVC&rsquo;s size to the desired size. The below example patches the size of a PVC to <code>10Gi</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n kube-system patch pvc $PVC_NAME --type merge -p <span style=color:#a31515>&#39;{&#34;spec&#34;:{&#34;resources&#34;:{&#34;requests&#34;: {&#34;storage&#34;: &#34;10Gi&#34;}}}}&#39;</span>
</span></span></code></pre></div></li><li><p>Make sure that the PVC gets resized. Describe the PVC to check the resize operation result:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n kube-system describe pvc -l upstream-host=docker.io
</span></span></code></pre></div></li></ol><blockquote><p>Drawback of this approach: The cache&rsquo;s size in the Shoot spec (<code>providerConfig.caches[].size</code>) diverges from the PVC&rsquo;s size.</p></blockquote><h3 id=alternative-2-remove-and-readd-the-cache>[Alternative 2] Remove and Readd the Cache<a class=td-heading-self-link href=#alternative-2-remove-and-readd-the-cache aria-label="Heading self-link"></a></h3><p>There is always the option to remove the cache from the Shoot spec and to readd it again with the updated size.</p><blockquote><p>Drawback of this approach: The already cached images get lost and the cache starts with an empty disk.</p></blockquote><h2 id=high-availability>High Availability<a class=td-heading-self-link href=#high-availability aria-label="Heading self-link"></a></h2><p>The registry cache runs with a single replica. This fact may lead to concerns for the high availability such as &ldquo;What happens when the registry cache is down? Does containerd fail to pull the image?&rdquo;. As outlined in the <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/configuration/#how-does-it-work>How does it work? section</a>, containerd is configured to fall back to the upstream registry if it fails to pull the image from the registry cache. Hence, when the registry cache is unavailable, the containerd&rsquo;s image pull operations are not affected because containerd falls back to image pull from the upstream registry.</p><h2 id=possible-pitfalls>Possible Pitfalls<a class=td-heading-self-link href=#possible-pitfalls aria-label="Heading self-link"></a></h2><ul><li>The used registry implementation (the <a href=https://github.com/distribution/distribution>Distribution project</a>) supports mirroring of only one upstream registry. The extension deploys a pull-through cache for each configured upstream.</li><li><code>us-docker.pkg.dev</code>, <code>europe-docker.pkg.dev</code>, and <code>asia-docker.pkg.dev</code> are different upstreams. Hence, configuring <code>pkg.dev</code> as upstream won&rsquo;t cache images from <code>us-docker.pkg.dev</code>, <code>europe-docker.pkg.dev</code>, or <code>asia-docker.pkg.dev</code>.</li></ul><h2 id=limitations>Limitations<a class=td-heading-self-link href=#limitations aria-label="Heading self-link"></a></h2><ol><li><p>Images that are pulled before a registry cache Pod is running or before a registry cache Service is reachable from the corresponding Node won&rsquo;t be cached - containerd will pull these images directly from the upstream.</p><p>The reasoning behind this limitation is that a registry cache Pod is running in the Shoot cluster. To have a registry cache&rsquo;s Service cluster IP reachable from containerd running on the Node, the registry cache Pod has to be running and kube-proxy has to configure iptables/IPVS rules for the registry cache Service. If kube-proxy hasn&rsquo;t configured iptables/IPVS rules for the registry cache Service, then the image pull times (and new Node bootstrap times) will be increased significantly. For more detailed explanations, see point 2. and <a href=https://github.com/gardener/gardener-extension-registry-cache/pull/68>gardener/gardener-extension-registry-cache#68</a>.</p><p>That&rsquo;s why the registry configuration on a Node is applied only after the registry cache Service is reachable from the Node. The <code>gardener-node-agent.service</code> systemd unit sends requests to the registry cache&rsquo;s Service. Once the registry cache responds with <code>HTTP 200</code>, the unit creates the needed registry configuration file (<code>hosts.toml</code>).</p><p>As a result, for images from Shoot system components:</p><ul><li>On Shoot creation with the registry cache extension enabled, a registry cache is unable to cache all of the images from the Shoot system components. Usually, until the registry cache Pod is running, containerd pulls from upstream the images from Shoot system components (before the registry configuration gets applied).</li><li>On new Node creation for existing Shoot with the registry cache extension enabled, a registry cache is unable to cache most of the images from Shoot system components. The reachability of the registry cache Service requires the Service network to be set up, i.e., the kube-proxy for that new Node to be running and to have set up iptables/IPVS configuration for the registry cache Service.</li></ul></li><li><p>containerd requests will time out in 30s in case kube-proxy hasn&rsquo;t configured iptables/IPVS rules for the registry cache Service - the image pull times will increase significantly.</p><p>containerd is configured to fall back to the upstream itself if a request against the cache fails. However, if the cluster IP of the registry cache Service does not exist or if kube-proxy hasn&rsquo;t configured iptables/IPVS rules for the registry cache Service, then containerd requests against the registry cache time out in 30 seconds. This significantly increases the image pull times because containerd does multiple requests as part of the image pull (HEAD request to resolve the manifest by tag, GET request for the manifest by SHA, GET requests for blobs)</p><p>Example: If the Service of a registry cache is deleted, then a new Service will be created. containerd&rsquo;s registry config will still contain the old Service&rsquo;s cluster IP. containerd requests against the old Service&rsquo;s cluster IP will time out and containerd will fall back to upstream.</p><ul><li>Image pull of <code>docker.io/library/alpine:3.13.2</code> from the upstream takes ~2s while image pull of the same image with invalid registry cache cluster IP takes ~2m.2s.</li><li>Image pull of <code>eu.gcr.io/gardener-project/gardener/ops-toolbelt:0.18.0</code> from the upstream takes ~10s while image pull of the same image with invalid registry cache cluster IP takes ~3m.10s.</li></ul></li><li><p>Amazon Elastic Container Registry is currently not supported. For details see <a href=https://github.com/distribution/distribution/issues/4383>distribution/distribution#4383</a>.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-5d2cb16601b6838a4a67ba8b5a7ae2f4>2 - Configuring the Registry Mirror Extension</h1><div class=lead>Learn what is the use-case for a registry mirror, how to enable and configure it</div><h1 id=configuring-the-registry-mirror-extension>Configuring the Registry Mirror Extension<a class=td-heading-self-link href=#configuring-the-registry-mirror-extension aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><h3 id=use-case>Use Case<a class=td-heading-self-link href=#use-case aria-label="Heading self-link"></a></h3><p>containerd allows registry mirrors to be configured. Use cases are:</p><ul><li>Usage of public mirror(s) - for example, circumvent issues with the upstream registry such as rate limiting, outages, and others.</li><li>Usage of private mirror(s) - for example, reduce network costs by using a private mirror running in the same network.</li></ul><h3 id=solution>Solution<a class=td-heading-self-link href=#solution aria-label="Heading self-link"></a></h3><p>The registry-mirror extension allows the registry mirror configuration to be configured via the Shoot spec directly.</p><h3 id=how-does-it-work>How does it work?<a class=td-heading-self-link href=#how-does-it-work aria-label="Heading self-link"></a></h3><p>When the extension is enabled, the containerd daemon on the Shoot cluster Nodes gets configured to use the requested mirrors as a mirror. For example, if for the upstream <code>docker.io</code> the mirror <code>https://mirror.gcr.io</code> is configured in the Shoot spec, then containerd gets configured to first pull the image from the mirror (<code>https://mirror.gcr.io</code> in that case). If this image pull operation fails, containerd falls back to the upstream itself (<code>docker.io</code> in that case).</p><p>The extension is based on the contract described in <a href=/docs/gardener/advanced/containerd-registry-configuration/><code>containerd</code> Registry Configuration</a>. The corresponding upstream documentation in containerd is <a href=https://github.com/containerd/containerd/blob/v1.7.0/docs/hosts.md>Registry Configuration - Introduction</a>.</p><h2 id=shoot-configuration>Shoot Configuration<a class=td-heading-self-link href=#shoot-configuration aria-label="Heading self-link"></a></h2><p>The Shoot specification has to be adapted to include the <code>registry-mirror</code> extension configuration.</p><p>Below is an example of <code>registry-mirror</code> extension configuration as part of the Shoot spec:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: crazy-botany
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: registry-mirror
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: mirror.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: MirrorConfig
</span></span><span style=display:flex><span>      mirrors:
</span></span><span style=display:flex><span>      - upstream: docker.io
</span></span><span style=display:flex><span>        hosts:
</span></span><span style=display:flex><span>        - host: <span style=color:#a31515>&#34;https://mirror.gcr.io&#34;</span>
</span></span><span style=display:flex><span>          capabilities: [<span style=color:#a31515>&#34;pull&#34;</span>]
</span></span></code></pre></div><p>The <code>providerConfig</code> field is required.</p><p>The <code>providerConfig.mirrors</code> field contains information about the registry mirrors to configure. It is a required field. At least one mirror has to be specified.</p><p>The <code>providerConfig.mirror[].upstream</code> field is the remote registry host to mirror. It is a required field.
The value must be a valid DNS subdomain (RFC 1123) and optionally a port (i.e. <code>&lt;host>[:&lt;port>]</code>). It must not include a scheme.</p><p>The <code>providerConfig.mirror[].hosts</code> field represents the mirror hosts to be used for the upstream. At least one mirror host has to be specified.</p><p>The <code>providerConfig.mirror[].hosts[].host</code> field is the mirror host. It is a required field.
The value must include a scheme - <code>http://</code> or <code>https://</code>.</p><p>The <code>providerConfig.mirror[].hosts[].capabilities</code> field represents the operations a host is capable of performing. This also represents the set of operations for which the mirror host may be trusted to perform. Defaults to <code>["pull"]</code>. The supported values are <code>pull</code> and <code>resolve</code>.
See the <a href=https://github.com/containerd/containerd/blob/v1.7.0/docs/hosts.md#capabilities-field>capabilities field documentation</a> for more information on which operations are considered trusted ones against public/private mirrors.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-279dc2188cd014dd3864f373e1503c87>3 - Deploying Registry Cache Extension in Gardener's Local Setup with Provider Extensions</h1><div class=lead>Learn how to set up a development environment using own Seed clusters on an existing Kubernetes cluster</div><h1 id=deploying-registry-cache-extension-in-gardeners-local-setup-with-provider-extensions>Deploying Registry Cache Extension in Gardener&rsquo;s Local Setup with Provider Extensions<a class=td-heading-self-link href=#deploying-registry-cache-extension-in-gardeners-local-setup-with-provider-extensions aria-label="Heading self-link"></a></h1><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>Make sure that you have a running local Gardener setup with enabled provider extensions. The steps to complete this can be found in the <a href=/docs/gardener/deployment/getting_started_locally_with_extensions/>Deploying Gardener Locally and Enabling Provider-Extensions</a> guide.</li></ul><h2 id=setting-up-the-registry-cache-extension>Setting up the Registry Cache Extension<a class=td-heading-self-link href=#setting-up-the-registry-cache-extension aria-label="Heading self-link"></a></h2><p>Make sure that your <code>KUBECONFIG</code> environment variable is targeting the local Gardener cluster.</p><p>The location of the Gardener project from the Gardener setup step is expected to be under the same root (e.g. <code>~/go/src/github.com/gardener/</code>). If this is not the case, the location of Gardener project should be specified in <code>GARDENER_REPO_ROOT</code> environment variable:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export GARDENER_REPO_ROOT=<span style=color:#a31515>&#34;&lt;path_to_gardener_project&gt;&#34;</span>
</span></span></code></pre></div><p>Then you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-up
</span></span></code></pre></div><p>In case you have added additional Seeds you can specify the seed name:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-up SEED_NAME=&lt;seed-name&gt;
</span></span></code></pre></div><p>The corresponding make target will build the extension image, push it into the Seed cluster image registry, and deploy the registry-cache ControllerDeployment and ControllerRegistration resources into the kind cluster.
The container image in the ControllerDeployment will be the image that was build and pushed into the Seed cluster image registry.</p><p>The make target will then deploy the registry-cache admission component. It will build the admission image, push it into the kind cluster image registry, and finally install the admission component charts to the kind cluster.</p><h2 id=creating-a-shoot-cluster>Creating a Shoot Cluster<a class=td-heading-self-link href=#creating-a-shoot-cluster aria-label="Heading self-link"></a></h2><p>Once the above step is completed, you can create a Shoot cluster. In order to create a Shoot cluster, please create your own Shoot definition depending on providers on your Seed cluster.</p><h2 id=tearing-down-the-development-environment>Tearing Down the Development Environment<a class=td-heading-self-link href=#tearing-down-the-development-environment aria-label="Heading self-link"></a></h2><p>To tear down the development environment, delete the Shoot cluster or disable the <code>registry-cache</code> extension in the Shoot&rsquo;s specification. When the extension is not used by the Shoot anymore, you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-down
</span></span></code></pre></div><p>The make target will delete the ControllerDeployment and ControllerRegistration of the extension, and the registry-cache admission helm deployment.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6292d6e3adb445c003eb0156582838fc>4 - Deploying Registry Cache Extension Locally</h1><div class=lead>Learn how to set up a local development environment</div><h1 id=deploying-registry-cache-extension-locally>Deploying Registry Cache Extension Locally<a class=td-heading-self-link href=#deploying-registry-cache-extension-locally aria-label="Heading self-link"></a></h1><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>Make sure that you have a running local Gardener setup. The steps to complete this can be found in the <a href=/docs/gardener/deployment/getting_started_locally/>Deploying Gardener Locally guide</a>.</li></ul><h2 id=setting-up-the-registry-cache-extension>Setting up the Registry Cache Extension<a class=td-heading-self-link href=#setting-up-the-registry-cache-extension aria-label="Heading self-link"></a></h2><p>Make sure that your <code>KUBECONFIG</code> environment variable is targeting the local Gardener cluster. When this is ensured, run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-up
</span></span></code></pre></div><p>The corresponding make target will build the extension image, load it into the kind cluster Nodes, and deploy the registry-cache ControllerDeployment and ControllerRegistration resources. The container image in the ControllerDeployment will be the image that was build and loaded into the kind cluster Nodes.</p><p>The make target will then deploy the registry-cache admission component. It will build the admission image, load it into the kind cluster Nodes, and finally install the admission component charts to the kind cluster.</p><h2 id=creating-a-shoot-cluster>Creating a Shoot Cluster<a class=td-heading-self-link href=#creating-a-shoot-cluster aria-label="Heading self-link"></a></h2><p>Once the above step is completed, you can create a Shoot cluster.</p><p><a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/example/shoot-registry-cache.yaml><code>example/shoot-registry-cache.yaml</code></a> contains a Shoot specification with the <code>registry-cache</code> extension:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f example/shoot-registry-cache.yaml
</span></span></code></pre></div><p><a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/example/shoot-registry-mirror.yaml><code>example/shoot-registry-mirror.yaml</code></a> contains a Shoot specification with the <code>registry-mirror</code> extension:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f example/shoot-registry-mirror.yaml
</span></span></code></pre></div><h2 id=tearing-down-the-development-environment>Tearing Down the Development Environment<a class=td-heading-self-link href=#tearing-down-the-development-environment aria-label="Heading self-link"></a></h2><p>To tear down the development environment, delete the Shoot cluster or disable the <code>registry-cache</code> extension in the Shoot&rsquo;s specification. When the extension is not used by the Shoot anymore, you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-down
</span></span></code></pre></div><p>The make target will delete the ControllerDeployment and ControllerRegistration of the extension, and the registry-cache admission helm deployment.</p><h2 id=alternative-setup-using-the-gardener-operator-local-setup>Alternative Setup Using the <code>gardener-operator</code> Local Setup<a class=td-heading-self-link href=#alternative-setup-using-the-gardener-operator-local-setup aria-label="Heading self-link"></a></h2><p>Alternatively, you can deploy the registry-cache extension in the <code>gardener-operator</code> local setup. To do this, make sure you are have a running local setup based on <a href=/docs/gardener/deployment/getting_started_locally/#alternative-way-to-set-up-garden-and-seed-leveraging-gardener-operator>Alternative Way to Set Up Garden and Seed Leveraging <code>gardener-operator</code></a>. The <code>KUBECONFIG</code> environment variable should target the operator local KinD cluster (i.e. <code>&lt;path_to_gardener_project>/example/gardener-local/kind/operator/kubeconfig</code>).</p><h4 id=creating-the-registry-cache-extensionoperatorgardenercloud-resource>Creating the registry-cache <code>Extension.operator.gardener.cloud</code> resource:<a class=td-heading-self-link href=#creating-the-registry-cache-extensionoperatorgardenercloud-resource aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-operator-up
</span></span></code></pre></div><p>The corresponding make target will build the registry-cache admission and extension container images, OCI artifacts for the admission runtime and application charts, and the extension chart. Then, the container images and the OCI artifacts are pushed into the default skaffold registry (i.e. <code>garden.local.gardener.cloud:5001</code>). Next, the registry-cache <code>Extension.operator.gardener.cloud</code> resource is deployed into the KinD cluster. Based on this resource the gardener-operator will deploy the registry-cache admission component, as well as the registry-cache ControllerDeployment and ControllerRegistration resources.</p><h4 id=creating-a-shoot-cluster-1>Creating a Shoot Cluster<a class=td-heading-self-link href=#creating-a-shoot-cluster-1 aria-label="Heading self-link"></a></h4><p>To create a Shoot cluster the <code>KUBECONFIG</code> environment variable should target virtual garden cluster (i.e. <code>&lt;path_to_gardener_project>/example/operator/virtual-garden/kubeconfig</code>) and then execute:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f example/shoot-registry-cache.yaml
</span></span></code></pre></div><h4 id=delete-the-registry-cache-extensionoperatorgardenercloud-resource>Delete the registry-cache <code>Extension.operator.gardener.cloud</code> resource<a class=td-heading-self-link href=#delete-the-registry-cache-extensionoperatorgardenercloud-resource aria-label="Heading self-link"></a></h4><p>Make sure the environment variable <code>KUBECONFIG</code> points to the operator&rsquo;s local KinD cluster and then run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-operator-down
</span></span></code></pre></div><p>The corresponding make target will delete the <code>Extension.operator.gardener.cloud</code> resource. Consequently, the gardener-operator will delete the registry-cache admission component and registry-cache ControllerDeployment and ControllerRegistration resources.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c7f55909c55d9671db41105c674d8223>5 - Developer Docs for Gardener Extension Registry Cache</h1><div class=lead>Learn about the inner workings</div><h1 id=developer-docs-for-gardener-extension-registry-cache>Developer Docs for Gardener Extension Registry Cache<a class=td-heading-self-link href=#developer-docs-for-gardener-extension-registry-cache aria-label="Heading self-link"></a></h1><p>This document outlines how Shoot reconciliation and deletion works for a Shoot with the registry-cache extension enabled.</p><h2 id=shoot-reconciliation>Shoot Reconciliation<a class=td-heading-self-link href=#shoot-reconciliation aria-label="Heading self-link"></a></h2><p>This section outlines how the reconciliation works for a Shoot with the registry-cache extension enabled.</p><h3 id=extension-enablement--reconciliation>Extension Enablement / Reconciliation<a class=td-heading-self-link href=#extension-enablement--reconciliation aria-label="Heading self-link"></a></h3><p>This section outlines how the extension enablement/reconciliation works, e.g., the extension has been added to the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, the gardenlet deploys the <a href=/docs/gardener/extensions/resources/extension/>Extension</a> resource.</li><li>The registry-cache extension reconciles the Extension resource. <a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/pkg/controller/cache/actuator.go>pkg/controller/cache/actuator.go</a> contains the implementation of the <a href=https://github.com/gardener/gardener/blob/v1.88.0/extensions/pkg/controller/extension/actuator.go>extension.Actuator</a> interface. The reconciliation of an Extension of type <code>registry-cache</code> consists of the following steps:<ol><li>The registry-cache extension deploys resources to the Shoot cluster via ManagedResource. For every configured upstream, it creates a StatefulSet (with PVC), Service, and other resources.</li><li>It lists all Services from the <code>kube-system</code> namespace that have the <code>upstream-host</code> label. It will return an error (and retry in exponential backoff) until the Services count matches the configured registries count.</li><li>When there is a Service created for each configured upstream registry, the registry-cache extension populates the Extension resource status. In the Extension status, for each upstream, it maintains an endpoint (in the format <code>http://&lt;cluster-ip>:5000</code>) which can be used to access the registry cache from within the Shoot cluster. <code>&lt;cluster-ip></code> is the cluster IP of the registry cache Service. The cluster IP of a Service is assigned by the Kubernetes API server on Service creation.</li></ol></li><li>As part of the Shoot reconciliation flow, the gardenlet deploys the <a href=/docs/gardener/extensions/resources/operatingsystemconfig/>OperatingSystemConfig</a> resource.</li><li>The registry-cache extension serves a webhook that mutates the OperatingSystemConfig resource for Shoots having the registry-cache extension enabled (the corresponding namespace gets labeled by the gardenlet with <code>extensions.gardener.cloud/registry-cache=true</code>). <a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/pkg/webhook/cache/ensurer.go>pkg/webhook/cache/ensurer.go</a> contains an implementation of the <a href=https://github.com/gardener/gardener/blob/v1.88.0/extensions/pkg/webhook/controlplane/genericmutator/mutator.go>genericmutator.Ensurer</a> interface.<ol><li>The webhook appends or updates <code>RegistryConfig</code> entries in the <a href=/docs/gardener/extensions/resources/operatingsystemconfig/#cri-support>OperatingSystemConfig CRI</a> configuration that corresponds to configured registry caches in the Shoot. The <code>RegistryConfig</code> readiness probe is enabled so that <a href=/docs/gardener/concepts/node-agent/>gardener-node-agent</a> creates a <code>hosts.toml</code> containerd registry configuration file when all <code>RegistryConfig</code> hosts are reachable.</li></ol></li></ol><h3 id=extension-disablement>Extension Disablement<a class=td-heading-self-link href=#extension-disablement aria-label="Heading self-link"></a></h3><p>This section outlines how the extension disablement works, i.e., the extension has to be removed from the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, the gardenlet destroys the <a href=/docs/gardener/extensions/resources/extension/>Extension</a> resource because it is no longer needed.<ol><li>The extension deletes the ManagedResource containing the registry cache resources.</li><li>The OperatingSystemConfig resource will not be mutated and no <code>RegistryConfig</code> entries will be added or updated. The <a href=/docs/gardener/concepts/node-agent/>gardener-node-agent</a> detects that <code>RegistryConfig</code> entries have been removed or changed and deletes or updates corresponding <code>hosts.toml</code> configuration files under <code>/etc/containerd/certs.d</code> folder.</li></ol></li></ol><h2 id=shoot-deletion>Shoot Deletion<a class=td-heading-self-link href=#shoot-deletion aria-label="Heading self-link"></a></h2><p>This section outlines how the deletion works for a Shoot with the registry-cache extension enabled.</p><ol><li>As part of the Shoot deletion flow, the gardenlet destroys the <a href=/docs/gardener/extensions/resources/extension/>Extension</a> resource.<ol><li>The extension deletes the ManagedResource containing the registry cache resources.</li></ol></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-ec03b3bb47b090a3cb2f8a348465d050>6 - How to provide credentials for upstream registry?</h1><h1 id=how-to-provide-credentials-for-upstream-registry>How to provide credentials for upstream registry?<a class=td-heading-self-link href=#how-to-provide-credentials-for-upstream-registry aria-label="Heading self-link"></a></h1><p>In Kubernetes, to pull images from private container image registries you either have to specify an image pull Secret (see <a href=https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/>Pull an Image from a Private Registry</a>) or you have to configure the kubelet to dynamically retrieve credentials using a credential provider plugin (see <a href=https://kubernetes.io/docs/tasks/administer-cluster/kubelet-credential-provider/>Configure a kubelet image credential provider</a>). When pulling an image, the kubelet is providing the credentials to the CRI implementation. The CRI implementation uses the provided credentials against the upstream registry to pull the image.</p><p>The registry-cache extension is using the <a href=https://github.com/distribution/distribution>Distribution project</a> as pull through cache implementation. The Distribution project does not use the provided credentials from the CRI implementation while fetching an image from the upstream. Hence, the above-described scenarios such as configuring image pull Secret for a Pod or configuring kubelet credential provider plugins don&rsquo;t work out of the box with the pull through cache provided by the registry-cache extension.
Instead, the Distribution project supports configuring only one set of credentials for a given pull through cache instance (for a given upstream).</p><p>This document describe how to supply credentials for the private upstream registry in order to pull private image with the registry cache.</p><h2 id=how-to-configure-the-registry-cache-to-use-upstream-registry-credentials>How to configure the registry cache to use upstream registry credentials?<a class=td-heading-self-link href=#how-to-configure-the-registry-cache-to-use-upstream-registry-credentials aria-label="Heading self-link"></a></h2><ol><li><p>Create an immutable Secret with the upstream registry credentials in the Garden cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f - <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: ro-docker-secret-v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: garden-dev
</span></span></span><span style=display:flex><span><span style=color:#a31515>type: Opaque
</span></span></span><span style=display:flex><span><span style=color:#a31515>immutable: true
</span></span></span><span style=display:flex><span><span style=color:#a31515>data:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  username: $(echo -n $USERNAME | base64 -w0)
</span></span></span><span style=display:flex><span><span style=color:#a31515>  password: $(echo -n $PASSWORD | base64 -w0)
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>For Artifact Registry, the username is <code>_json_key</code> and the password is the service account key in JSON format. To base64 encode the service account key, copy it and run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo -n $SERVICE_ACCOUNT_KEY_JSON | base64 -w0
</span></span></code></pre></div></li><li><p>Add the newly created Secret as a reference to the Shoot spec, and then to the registry-cache extension configuration.</p><p>In the registry-cache configuration, set the <code>secretReferenceName</code> field. It should point to a resource reference under <code>spec.resources</code>. The resource reference itself points to the Secret in project namespace.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span><span style=color:green># ...</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: registry-cache
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: registry.extensions.gardener.cloud/v1alpha3
</span></span><span style=display:flex><span>      kind: RegistryConfig
</span></span><span style=display:flex><span>      caches:
</span></span><span style=display:flex><span>      - upstream: docker.io
</span></span><span style=display:flex><span>        secretReferenceName: docker-secret
</span></span><span style=display:flex><span>  <span style=color:green># ...</span>
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - name: docker-secret
</span></span><span style=display:flex><span>    resourceRef:
</span></span><span style=display:flex><span>      apiVersion: v1
</span></span><span style=display:flex><span>      kind: Secret
</span></span><span style=display:flex><span>      name: ro-docker-secret-v1
</span></span><span style=display:flex><span><span style=color:green># ...</span>
</span></span></code></pre></div></li></ol><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>Do not delete the referenced Secret when there is a Shoot still using it.</p></blockquote><h2 id=how-to-rotate-the-registry-credentials>How to rotate the registry credentials?<a class=td-heading-self-link href=#how-to-rotate-the-registry-credentials aria-label="Heading self-link"></a></h2><p>To rotate registry credentials perform the following steps:</p><ol><li>Generate a new pair of credentials in the cloud provider account. Do not invalidate the old ones.</li><li>Create a new Secret (e.g., <code>ro-docker-secret-v2</code>) with the newly generated credentials as described in step 1. in <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/upstream-credentials/#how-to-configure-the-registry-cache-to-use-upstream-registry-credentials>How to configure the registry cache to use upstream registry credentials?</a>.</li><li>Update the Shoot spec with newly created Secret as described in step 2. in <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/upstream-credentials/#how-to-configure-the-registry-cache-to-use-upstream-registry-credentials>How to configure the registry cache to use upstream registry credentials?</a>.</li><li>The above step will trigger a Shoot reconciliation. Wait for it to complete.</li><li>Make sure that the old Secret is no longer referenced by any Shoot cluster. Finally, delete the Secret containing the old credentials (e.g., <code>ro-docker-secret-v1</code>).</li><li>Delete the corresponding old credentials from the cloud provider account.</li></ol><h2 id=possible-pitfalls>Possible Pitfalls<a class=td-heading-self-link href=#possible-pitfalls aria-label="Heading self-link"></a></h2><ul><li>The registry cache is not protected by any authentication/authorization mechanism. The cached images (incl. private images) can be fetched from the registry cache without authentication/authorization. Note that the registry cache itself is not exposed publicly.</li><li>The registry cache provides the credentials for every request against the corresponding upstream. In some cases, misconfigured credentials can prevent the registry cache to pull even public images from the upstream (for example: invalid service account key for Artifact Registry). However, this behaviour is controlled by the server-side logic of the upstream registry.</li><li>Do not remove the image pull Secrets when configuring credentials for the registry cache. When the registry-cache is not available, containerd falls back to the upstream registry. containerd still needs the image pull Secret to pull the image and in this way to have the fallback mechanism working.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4343922c3fe104128e4a9eecfb15c364>7 - Observability</h1><h1 id=registry-cache-observability>Registry Cache Observability<a class=td-heading-self-link href=#registry-cache-observability aria-label="Heading self-link"></a></h1><p>The <code>registry-cache</code> extension exposes metrics for the registry caches running in the Shoot cluster so that they can be easily viewed by cluster owners and operators in the Shoot&rsquo;s Prometheus and Plutono instances. The exposed monitoring data provides an overview of the performance of the pull-through caches, including hit rate and network traffic data.</p><h2 id=metrics>Metrics<a class=td-heading-self-link href=#metrics aria-label="Heading self-link"></a></h2><p>A registry cache serves <a href=https://github.com/distribution/distribution/blob/v3.0.0-rc.4/registry/proxy/proxymetrics.go#L12-L21>several metrics</a>. The metrics are scraped by the <a href=/docs/gardener/monitoring/#shoot-prometheus>Shoot&rsquo;s Prometheus instance</a>.</p><p>The <code>Registry Caches</code> dashboard in the Shoot&rsquo;s Plutono instance contains several panels which are built using the registry cache metrics. From the <code>Registry</code> dropdown menu you can select the upstream for which you wish the metrics to be displayed (by default, metrics are summed for all upstream registries).</p><p>Following is a list of all exposed registry cache metrics. The <code>upstream_host</code> label can be used to determine the upstream host to which the metrics are related, while the <code>type</code> label can be used to determine weather the metric is for an image <code>blob</code> or an image <code>manifest</code>:</p><h4 id=registry_proxy_requests_total>registry_proxy_requests_total<a class=td-heading-self-link href=#registry_proxy_requests_total aria-label="Heading self-link"></a></h4><p>The number of total incoming request received.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id=registry_proxy_hits_total>registry_proxy_hits_total<a class=td-heading-self-link href=#registry_proxy_hits_total aria-label="Heading self-link"></a></h4><p>The number of total cache hits; i.e. the requested content exists in the registry cache&rsquo;s image store and it is served from there (upstream is not contacted at all for serving the requested content).</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id=registry_proxy_misses_total>registry_proxy_misses_total<a class=td-heading-self-link href=#registry_proxy_misses_total aria-label="Heading self-link"></a></h4><p>The number of total cache misses; i.e. the requested content does not exist in the registry cache&rsquo;s image store and it is fetched from the upstream.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id=registry_proxy_pulled_bytes_total>registry_proxy_pulled_bytes_total<a class=td-heading-self-link href=#registry_proxy_pulled_bytes_total aria-label="Heading self-link"></a></h4><p>The size of total bytes that the registry cache has pulled from the upstream.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id=registry_proxy_pushed_bytes_total>registry_proxy_pushed_bytes_total<a class=td-heading-self-link href=#registry_proxy_pushed_bytes_total aria-label="Heading self-link"></a></h4><p>The size of total bytes pushed to the registry cache&rsquo;s clients.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h2 id=alerts>Alerts<a class=td-heading-self-link href=#alerts aria-label="Heading self-link"></a></h2><p>There are two alerts defined for the registry cache <code>PersistentVolume</code> in the Shoot&rsquo;s Prometheus instance:</p><h4 id=registrycachepersistentvolumeusagecritical>RegistryCachePersistentVolumeUsageCritical<a class=td-heading-self-link href=#registrycachepersistentvolumeusagecritical aria-label="Heading self-link"></a></h4><p>This indicates that the registry cache <code>PersistentVolume</code> is almost full and less than 5% is free. When there is no available disk space, no new images will be cached. However, image pull operations are not affected. An alert is fired when the following expression evaluates to true:</p><pre tabindex=0><code>100 * (
 kubelet_volume_stats_available_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}
   /
 kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}
) &lt; 5
</code></pre><h4 id=registrycachepersistentvolumefullinfourdays>RegistryCachePersistentVolumeFullInFourDays<a class=td-heading-self-link href=#registrycachepersistentvolumefullinfourdays aria-label="Heading self-link"></a></h4><p>This indicates that the registry cache <code>PersistentVolume</code> is expected to fill up within four days based on recent sampling. An alert is fired when the following expression evaluates to true:</p><pre tabindex=0><code>100 * (
 kubelet_volume_stats_available_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}
   /
 kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}
) &lt; 15
and
predict_linear(kubelet_volume_stats_available_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}[30m], 4 * 24 * 3600) &lt;= 0
</code></pre><p>Users can subscribe to these alerts by following the Gardener <a href=/docs/gardener/monitoring/alerting/#alerting-for-users>alerting guide</a>.</p><h2 id=logging>Logging<a class=td-heading-self-link href=#logging aria-label="Heading self-link"></a></h2><p>To view the registry cache logs in Plutono, navigate to the <code>Explore</code> tab and select <code>vali</code> from the <code>Explore</code> dropdown menu. Afterwards enter the following <code>vali</code> query:</p><ul><li><code>{container_name="registry-cache"}</code> to view the logs for all registries.</li><li><code>{pod_name=~"registry-&lt;upstream_host>.+"}</code> to view the logs for specific upstream registry.</li></ul></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://x.com/GardenerProject><img src=/images/branding/x-logo-white.svg class=media-icon><div class=media-text>X</div></a></li></ul><span class=copyright>Copyright 2019-2025 Gardener project authors.
<a href=https://www.sap.com/about/legal/terms-of-use.html>Terms of Use
<i class="fa fa-external-link" aria-hidden=true></i>
</a>|
<a href=https://www.sap.com/about/legal/terms-of-use.html>Privacy Statement
<i class="fa fa-external-link" aria-hidden=true></i>
</a>|
<a href=https://www.sap.com/about/legal/terms-of-use.html>Legal Disclosure
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>