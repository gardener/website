<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://gardener.cloud/docs/extensions/others/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/extensions/others/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Others | Gardener</title>
<meta name=description content="Other Gardener extensions"><meta property="og:url" content="https://gardener.cloud/docs/extensions/others/"><meta property="og:site_name" content="Gardener"><meta property="og:title" content="Others"><meta property="og:description" content="Other Gardener extensions"><meta property="og:locale" content="en_US"><meta property="og:type" content="website"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Others"><meta itemprop=description content="Other Gardener extensions"><meta itemprop=datePublished content="2023-07-20T00:00:00+00:00"><meta itemprop=dateModified content="2023-07-20T00:00:00+00:00"><meta itemprop=image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Others"><meta name=twitter:description content="Other Gardener extensions"><link rel=preload href=/scss/main.min.f9205a304d86fd1d0ef000d1cb21c925d738e657b996f5e93313149c174e86d5.css as=style integrity="sha256-+SBaME2G/R0O8ADRyyHJJdc45le5lvXpMxMUnBdOhtU=" crossorigin=anonymous><link href=/scss/main.min.f9205a304d86fd1d0ef000d1cb21c925d738e657b996f5e93313149c174e86d5.css rel=stylesheet integrity="sha256-+SBaME2G/R0O8ADRyyHJJdc45le5lvXpMxMUnBdOhtU=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><style>.nav-link:hover{text-decoration:none}.ml-md-auto{margin-left:auto!important}.td-search__icon{color:#fff!important}.td-search__input.form-control::placeholder{color:#fff;border:1px;border-radius:20px}.td-search__input.form-control{border:1px;border-radius:20px}.td-search__input{max-width:90%}.td-search:not(:focus-within){color:#fff!important}</style><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://demo.gardener.cloud target=_blank><span>Demo</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><div class=dropdown><a href=/docs class=nav-link>Documentation</a><div class=dropdown-content><a class=taxonomy-term href=/docs>Users</a>
<a class=taxonomy-term href=/docs>Operators</a>
<a class=taxonomy-term href=/docs>Developers</a>
<a class=taxonomy-term href=/docs>All</a></div></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.a06b9f505b75487ef5d6ede8651ed7a0.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/extensions/others/>Return to the regular view of this page</a>.</p></div><h1 class=title>Others</h1><div class=lead>Other Gardener extensions</div><div class=content></div></div><div class=td-content><h1 id=pg-ed74ceaa562b93985c3d5ce5042a7a22>1 - Certificate services</h1><div class=lead>Gardener extension controller for certificate services for shoot clusters</div><h1 id=gardener-extension-for-certificate-serviceshttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for certificate services</a><a class=td-heading-self-link href=#gardener-extension-for-certificate-serviceshttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-cert-service><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-cert-service alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-shoot-cert-service-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-shoot-cert-service-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-shoot-cert-service><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-shoot-cert-service alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service. Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>. However, the project has grown to a size where it is very hard to extend, maintain, and test. With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics. This way, we can keep Gardener core clean and independent.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>Example configuration for this extension controller:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: shoot-cert-service.extensions.config.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Configuration
</span></span><span style=display:flex><span>issuerName: gardener
</span></span><span style=display:flex><span>restrictIssuer: <span style=color:#00f>true</span> <span style=color:green># restrict issuer to any sub-domain of shoot.spec.dns.domain (default)</span>
</span></span><span style=display:flex><span>acme:
</span></span><span style=display:flex><span>  email: john.doe@example.com
</span></span><span style=display:flex><span>  server: https://acme-v02.api.letsencrypt.org/directory
</span></span><span style=display:flex><span><span style=color:green># privateKey: | # Optional key for Let&#39;s Encrypt account.</span>
</span></span><span style=display:flex><span><span style=color:green>#   -----BEGIN BEGIN RSA PRIVATE KEY-----</span>
</span></span><span style=display:flex><span><span style=color:green>#   ...</span>
</span></span><span style=display:flex><span><span style=color:green>#   -----END RSA PRIVATE KEY-----</span>
</span></span></code></pre></div><h2 id=extension-resources>Extension-Resources<a class=td-heading-self-link href=#extension-resources aria-label="Heading self-link"></a></h2><p>Example extension resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Extension
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: <span style=color:#a31515>&#34;extension-certificate-service&#34;</span>
</span></span><span style=display:flex><span>  namespace: shoot--project--abc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: shoot-cert-service
</span></span></code></pre></div><p>When an extension resource is reconciled, the extension controller will create an instance of <a href=https://github.com/gardener/cert-management>Cert-Management</a> as well as an <code>Issuer</code> with the ACME information provided in the <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/#Configuration>configuration</a> above. These resources are placed inside the shoot namespace on the seed. Also, the controller takes care about generating necessary <code>RBAC</code> resources for the seed as well as for the shoot.</p><p>Please note, this extension controller relies on the <a href=https://github.com/gardener/gardener-resource-manager>Gardener-Resource-Manager</a> to deploy k8s resources to seed and shoot clusters, i.e. it never deploys them directly.</p><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the kubeconfig to the cluster you want to connect to ready in the <code>./dev/kubeconfig</code> file.
Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-cert-service/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a7493d3f6af5f7614666d700176dc331>1.1 - Changing alerting settings</h1><div class=lead>How to change the alerting on expiring certificates</div><h1 id=changing-alerting-settings>Changing alerting settings<a class=td-heading-self-link href=#changing-alerting-settings aria-label="Heading self-link"></a></h1><p>Certificates are normally renewed automatically 30 days before they expire.
As a second line of defense, there is an alerting in Prometheus activated if the certificate is a few days
before expiration. By default, the alert is triggered 15 days before expiration.</p><p>You can configure the days in the <code>providerConfig</code> of the extension.
Setting it to 0 disables the alerting.</p><p>In this example, the days are changed to 3 days before expiration.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-cert-service
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: CertConfig
</span></span><span style=display:flex><span>      alerting:
</span></span><span style=display:flex><span>        certExpirationAlertDays: 3
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-938a1eb564207b1aa0e30daeca7ffeda>1.2 - Manage certificates with Gardener for default domain</h1><div class=lead>Use the Gardener cert-management to get fully managed, publicly trusted TLS certificates</div><h1 id=manage-certificates-with-gardener-for-default-domain>Manage certificates with Gardener for default domain<a class=td-heading-self-link href=#manage-certificates-with-gardener-for-default-domain aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Dealing with applications on Kubernetes which offer a secure service endpoints (e.g. HTTPS) also require you to enable a
secured communication via SSL/TLS. With the <a href=https://github.com/gardener/gardener-extension-shoot-cert-service>certificate extension</a> enabled, Gardener can manage commonly trusted X.509 certificate for your application
endpoint. From initially requesting certificate, it also handeles their renewal in time using the free Let&rsquo;s Encrypt API.</p><p><strong>There are two senarios with which you can use the certificate extension</strong></p><ul><li>You want to use a certificate for a subdomain the shoot&rsquo;s default DNS (see <code>.spec.dns.domain</code> of your shoot resource, e.g. <code>short.ingress.shoot.project.default-domain.gardener.cloud</code>). If this is your case, please keep reading this article.</li><li>You want to use a certificate for a custom domain. If this is your case, please see <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/>Manage certificates with Gardener for public domain</a></li></ul><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Before you start this guide there are a few requirements you need to fulfill:</p><ul><li>You have an existing shoot cluster</li></ul><p>Since you are using the default DNS name, all DNS configuration should already be done and ready.</p><h2 id=issue-a-certificate>Issue a certificate<a class=td-heading-self-link href=#issue-a-certificate aria-label="Heading self-link"></a></h2><p>Every X.509 certificate is represented by a Kubernetes custom resource <code>certificate.cert.gardener.cloud</code> in your cluster. A <code>Certificate</code> resource may be used to initiate a new certificate request as well as to manage its lifecycle. Gardener&rsquo;s certificate service regularly checks the expiration timestamp of Certificates, triggers a renewal process if necessary and replaces the existing X.509 certificate with a new one.</p><blockquote><p>Your application should be able to reload replaced certificates in a timely manner to avoid service disruptions.</p></blockquote><p>Certificates can be requested via 3 resources type</p><ul><li>Ingress</li><li>Service (type LoadBalancer)</li><li>certificate (Gardener CRD)</li></ul><p>If either of the first 2 are used, a corresponding <code>Certificate</code> resource will automatically be created.</p><h3 id=using-an-ingress-resource>Using an ingress Resource<a class=td-heading-self-link href=#using-an-ingress-resource aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/purpose: managed
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/issuer: custom-issuer                    # optional to specify custom issuer (use namespace/name for shoot issuers)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/follow-cname: &#34;true&#34;                     # optional, same as spec.followCNAME in certificates</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/secret-labels: &#34;key1=value1,key2=value2&#34; # optional labels for the certificate secret</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/preferred-chain: &#34;chain name&#34;            # optional to specify preferred-chain (value is the Subject Common Name of the root issuer)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-algorithm: ECDSA             # optional to specify algorithm for private key, allowed values are &#39;RSA&#39; or &#39;ECDSA&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-size: &#34;384&#34;                  # optional to specify size of private key, allowed values for RSA are &#34;2048&#34;, &#34;3072&#34;, &#34;4096&#34; and for ECDSA &#34;256&#34; and &#34;384&#34;spec:</span>
</span></span><span style=display:flex><span>  tls:
</span></span><span style=display:flex><span>  - hosts:
</span></span><span style=display:flex><span>    <span style=color:green># Must not exceed 64 characters.</span>
</span></span><span style=display:flex><span>    - short.ingress.shoot.project.default-domain.gardener.cloud
</span></span><span style=display:flex><span>    <span style=color:green># Certificate and private key reside in this secret.</span>
</span></span><span style=display:flex><span>    secretName: tls-secret
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  - host: short.ingress.shoot.project.default-domain.gardener.cloud
</span></span><span style=display:flex><span>    http:
</span></span><span style=display:flex><span>      paths:
</span></span><span style=display:flex><span>      - pathType: Prefix
</span></span><span style=display:flex><span>        path: <span style=color:#a31515>&#34;/&#34;</span>
</span></span><span style=display:flex><span>        backend:
</span></span><span style=display:flex><span>          service:
</span></span><span style=display:flex><span>            name: amazing-svc
</span></span><span style=display:flex><span>            port:
</span></span><span style=display:flex><span>              number: 8080
</span></span></code></pre></div><h3 id=using-a-service-type-loadbalancer>Using a service type LoadBalancer<a class=td-heading-self-link href=#using-a-service-type-loadbalancer aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/purpose: managed
</span></span><span style=display:flex><span>    <span style=color:green># Certificate and private key reside in this secret.</span>
</span></span><span style=display:flex><span>    cert.gardener.cloud/secretname: tls-secret
</span></span><span style=display:flex><span>    <span style=color:green># You may add more domains separated by commas (e.g. &#34;service.shoot.project.default-domain.gardener.cloud, amazing.shoot.project.default-domain.gardener.cloud&#34;)</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: <span style=color:#a31515>&#34;service.shoot.project.default-domain.gardener.cloud&#34;</span> 
</span></span><span style=display:flex><span>    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;600&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/issuer: custom-issuer                    # optional to specify custom issuer (use namespace/name for shoot issuers)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/follow-cname: &#34;true&#34;                     # optional, same as spec.followCNAME in certificates</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/secret-labels: &#34;key1=value1,key2=value2&#34; # optional labels for the certificate secret</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/preferred-chain: &#34;chain name&#34;            # optional to specify preferred-chain (value is the Subject Common Name of the root issuer)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-algorithm: ECDSA             # optional to specify algorithm for private key, allowed values are &#39;RSA&#39; or &#39;ECDSA&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-size: &#34;384&#34;                  # optional to specify size of private key, allowed values for RSA are &#34;2048&#34;, &#34;3072&#34;, &#34;4096&#34; and for ECDSA &#34;256&#34; and &#34;384&#34;  name: test-service</span>
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>    - name: http
</span></span><span style=display:flex><span>      port: 80
</span></span><span style=display:flex><span>      protocol: TCP
</span></span><span style=display:flex><span>      targetPort: 8080
</span></span><span style=display:flex><span>  type: LoadBalancer
</span></span></code></pre></div><h3 id=using-the-custom-certificate-resource>Using the custom Certificate resource<a class=td-heading-self-link href=#using-the-custom-certificate-resource aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Certificate
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: cert-example
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  commonName: short.ingress.shoot.project.default-domain.gardener.cloud
</span></span><span style=display:flex><span>  secretRef:
</span></span><span style=display:flex><span>    name: tls-secret
</span></span><span style=display:flex><span>    namespace: default
</span></span><span style=display:flex><span>  <span style=color:green># Optionnal if using the default issuer</span>
</span></span><span style=display:flex><span>  issuerRef:
</span></span><span style=display:flex><span>    name: garden
</span></span></code></pre></div><p>If you&rsquo;re interested in the current progress of your request, you&rsquo;re advised to consult the description, more specifically the <code>status</code> attribute in case the issuance failed.</p><h2 id=request-a-wildcard-certificate>Request a wildcard certificate<a class=td-heading-self-link href=#request-a-wildcard-certificate aria-label="Heading self-link"></a></h2><p>In order to avoid the creation of multiples certificates for every single endpoints, you may want to create a wildcard certificate for your shoot&rsquo;s default cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/purpose: managed
</span></span><span style=display:flex><span>    cert.gardener.cloud/commonName: <span style=color:#a31515>&#34;*.ingress.shoot.project.default-domain.gardener.cloud&#34;</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  tls:
</span></span><span style=display:flex><span>  - hosts:
</span></span><span style=display:flex><span>    - amazing.ingress.shoot.project.default-domain.gardener.cloud
</span></span><span style=display:flex><span>    secretName: tls-secret
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  - host: amazing.ingress.shoot.project.default-domain.gardener.cloud
</span></span><span style=display:flex><span>    http:
</span></span><span style=display:flex><span>      paths:
</span></span><span style=display:flex><span>      - pathType: Prefix
</span></span><span style=display:flex><span>        path: <span style=color:#a31515>&#34;/&#34;</span>
</span></span><span style=display:flex><span>        backend:
</span></span><span style=display:flex><span>          service:
</span></span><span style=display:flex><span>            name: amazing-svc
</span></span><span style=display:flex><span>            port:
</span></span><span style=display:flex><span>              number: 8080
</span></span></code></pre></div><p>Please note that this can also be achived by directly adding an annotation to a Service type LoadBalancer. You could also create a Certificate object with a wildcard domain.</p><h2 id=more-information>More information<a class=td-heading-self-link href=#more-information aria-label="Heading self-link"></a></h2><p>For more information and more examples about using the certificate extension, please see <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/>Manage certificates with Gardener for public domain</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-37cf7e12cfd0a0c8e335a954d4e324a1>1.3 - Manage certificates with Gardener for public domain</h1><div class=lead>Use the Gardener cert-management to get fully managed, publicly trusted TLS certificates</div><h1 id=manage-certificates-with-gardener-for-public-domain>Manage certificates with Gardener for public domain<a class=td-heading-self-link href=#manage-certificates-with-gardener-for-public-domain aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Dealing with applications on Kubernetes which offer a secure service endpoints (e.g. HTTPS) also require you to enable a
secured communication via SSL/TLS. With the <a href=https://github.com/gardener/gardener-extension-shoot-cert-service>certificate extension</a> enabled, Gardener can manage commonly trusted X.509 certificate for your application
endpoint. From initially requesting certificate, it also handeles their renewal in time using the free Let&rsquo;s Encrypt API.</p><p><strong>There are two senarios with which you can use the certificate extension</strong></p><ul><li>You want to use a certificate for a subdomain the shoot&rsquo;s default DNS (see <code>.spec.dns.domain</code> of your shoot resource, e.g. <code>short.ingress.shoot.project.default-domain.gardener.cloud</code>). If this is your case, please see <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_default_domain_cert/>Manage certificates with Gardener for default domain</a></li><li>You want to use a certificate for a custom domain. If this is your case, please keep reading this article.</li></ul><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Before you start this guide there are a few requirements you need to fulfill:</p><ul><li>You have an existing shoot cluster</li><li>Your custom domain is under a <a href=https://www.iana.org/domains/root/db>public top level domain</a> (e.g. <code>.com</code>)</li><li>Your custom zone is resolvable with a public resolver via the internet (e.g. <code>8.8.8.8</code>)</li><li>You have a custom DNS provider configured and working (see <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_providers/>&ldquo;DNS Providers&rdquo;</a>)</li></ul><p>As part of the <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a> <a href=https://tools.ietf.org/html/rfc8555>ACME</a> challenge validation process, Gardener sets a DNS TXT entry and Let&rsquo;s Encrypt checks if it can both resolve and authenticate it. Therefore, it&rsquo;s important that your DNS-entries are publicly resolvable. You can check this by querying e.g. Googles public DNS server and if it returns an entry your DNS is publicly visible:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:green># returns the A record for cert-example.example.com using Googles DNS server (8.8.8.8)</span>
</span></span><span style=display:flex><span>dig cert-example.example.com @8.8.8.8 A
</span></span></code></pre></div><h3 id=dns-provider>DNS provider<a class=td-heading-self-link href=#dns-provider aria-label="Heading self-link"></a></h3><p>In order to issue certificates for a custom domain you need to specify a DNS provider which is permitted to create DNS records for subdomains of your requested domain in the certificate. For example, if you request a certificate for <code>host.example.com</code> your DNS provider must be capable of managing subdomains of <code>host.example.com</code>.</p><p>DNS providers are normally specified in the shoot manifest. To learn more on how to configure one, please see the <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_providers/>DNS provider</a> documentation.</p><h2 id=issue-a-certificate>Issue a certificate<a class=td-heading-self-link href=#issue-a-certificate aria-label="Heading self-link"></a></h2><p>Every X.509 certificate is represented by a Kubernetes custom resource <code>certificate.cert.gardener.cloud</code> in your cluster. A <code>Certificate</code> resource may be used to initiate a new certificate request as well as to manage its lifecycle. Gardener&rsquo;s certificate service regularly checks the expiration timestamp of Certificates, triggers a renewal process if necessary and replaces the existing X.509 certificate with a new one.</p><blockquote><p>Your application should be able to reload replaced certificates in a timely manner to avoid service disruptions.</p></blockquote><p>Certificates can be requested via 3 resources type</p><ul><li>Ingress</li><li>Service (type LoadBalancer)</li><li>Gateways (both Istio gateways and from the Gateway API)</li><li>Certificate (Gardener CRD)</li></ul><p>If either of the first 2 are used, a corresponding <code>Certificate</code> resource will be created automatically.</p><h3 id=using-an-ingress-resource>Using an Ingress Resource<a class=td-heading-self-link href=#using-an-ingress-resource aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/purpose: managed
</span></span><span style=display:flex><span>    <span style=color:green># Optional but recommended, this is going to create the DNS entry at the same time</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;600&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/commonname: &#34;*.example.com&#34;              # optional, if not specified the first name from spec.tls[].hosts is used as common name</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/dnsnames: &#34;&#34;                             # optional, if not specified the names from spec.tls[].hosts are used</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/follow-cname: &#34;true&#34;                     # optional, same as spec.followCNAME in certificates</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/secret-labels: &#34;key1=value1,key2=value2&#34; # optional labels for the certificate secret</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/issuer: custom-issuer                    # optional to specify custom issuer (use namespace/name for shoot issuers)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/preferred-chain: &#34;chain name&#34;            # optional to specify preferred-chain (value is the Subject Common Name of the root issuer)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-algorithm: ECDSA             # optional to specify algorithm for private key, allowed values are &#39;RSA&#39; or &#39;ECDSA&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-size: &#34;384&#34;                  # optional to specify size of private key, allowed values for RSA are &#34;2048&#34;, &#34;3072&#34;, &#34;4096&#34; and for ECDSA &#34;256&#34; and &#34;384&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  tls:
</span></span><span style=display:flex><span>  - hosts:
</span></span><span style=display:flex><span>    <span style=color:green># Must not exceed 64 characters.</span>
</span></span><span style=display:flex><span>    - amazing.example.com
</span></span><span style=display:flex><span>    <span style=color:green># Certificate and private key reside in this secret.</span>
</span></span><span style=display:flex><span>    secretName: tls-secret
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  - host: amazing.example.com
</span></span><span style=display:flex><span>    http:
</span></span><span style=display:flex><span>      paths:
</span></span><span style=display:flex><span>      - pathType: Prefix
</span></span><span style=display:flex><span>        path: <span style=color:#a31515>&#34;/&#34;</span>
</span></span><span style=display:flex><span>        backend:
</span></span><span style=display:flex><span>          service:
</span></span><span style=display:flex><span>            name: amazing-svc
</span></span><span style=display:flex><span>            port:
</span></span><span style=display:flex><span>              number: 8080
</span></span></code></pre></div><p>Replace the <code>hosts</code> and <code>rules[].host</code> value again with your own domain and adjust the remaining Ingress attributes in accordance with your deployment (e.g. the above is for an <code>istio</code> Ingress controller and forwards traffic to a <code>service1</code> on port 80).</p><h3 id=using-a-service-of-type-loadbalancer>Using a Service of type LoadBalancer<a class=td-heading-self-link href=#using-a-service-of-type-loadbalancer aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/secretname: tls-secret
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: example.example.com
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>    <span style=color:green># Optional</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;600&#34;</span>
</span></span><span style=display:flex><span>    cert.gardener.cloud/commonname: <span style=color:#a31515>&#34;*.example.example.com&#34;</span>
</span></span><span style=display:flex><span>    cert.gardener.cloud/dnsnames: <span style=color:#a31515>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/follow-cname: &#34;true&#34;                     # optional, same as spec.followCNAME in certificates</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/secret-labels: &#34;key1=value1,key2=value2&#34; # optional labels for the certificate secret</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/issuer: custom-issuer                    # optional to specify custom issuer (use namespace/name for shoot issuers)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/preferred-chain: &#34;chain name&#34;            # optional to specify preferred-chain (value is the Subject Common Name of the root issuer)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-algorithm: ECDSA             # optional to specify algorithm for private key, allowed values are &#39;RSA&#39; or &#39;ECDSA&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-size: &#34;384&#34;                  # optional to specify size of private key, allowed values for RSA are &#34;2048&#34;, &#34;3072&#34;, &#34;4096&#34; and for ECDSA &#34;256&#34; and &#34;384&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  name: test-service
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>    - name: http
</span></span><span style=display:flex><span>      port: 80
</span></span><span style=display:flex><span>      protocol: TCP
</span></span><span style=display:flex><span>      targetPort: 8080
</span></span><span style=display:flex><span>  type: LoadBalancer
</span></span></code></pre></div><h3 id=using-a-gateway-resource>Using a Gateway resource<a class=td-heading-self-link href=#using-a-gateway-resource aria-label="Heading self-link"></a></h3><p>Please see <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/tutorials/istio-gateways/>Istio Gateways</a> or <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/tutorials/gateway-api-gateways/>Gateway API</a> for details.</p><h3 id=using-the-custom-certificate-resource>Using the custom Certificate resource<a class=td-heading-self-link href=#using-the-custom-certificate-resource aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Certificate
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: cert-example
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  commonName: amazing.example.com
</span></span><span style=display:flex><span>  secretRef:
</span></span><span style=display:flex><span>    name: tls-secret
</span></span><span style=display:flex><span>    namespace: default
</span></span><span style=display:flex><span>  <span style=color:green># Optionnal if using the default issuer</span>
</span></span><span style=display:flex><span>  issuerRef:
</span></span><span style=display:flex><span>    name: garden
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># If delegated domain for DNS01 challenge should be used. This has only an effect if a CNAME record is set for</span>
</span></span><span style=display:flex><span>  <span style=color:green># &#39;_acme-challenge.amazing.example.com&#39;.</span>
</span></span><span style=display:flex><span>  <span style=color:green># For example: If a CNAME record exists &#39;_acme-challenge.amazing.example.com&#39; =&gt; &#39;_acme-challenge.writable.domain.com&#39;,</span>
</span></span><span style=display:flex><span>  <span style=color:green># the DNS challenge will be written to &#39;_acme-challenge.writable.domain.com&#39;.</span>
</span></span><span style=display:flex><span>  <span style=color:green>#followCNAME: true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># optionally set labels for the secret</span>
</span></span><span style=display:flex><span>  <span style=color:green>#secretLabels:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#  key1: value1</span>
</span></span><span style=display:flex><span>  <span style=color:green>#  key2: value2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># Optionally specify the preferred certificate chain: if the CA offers multiple certificate chains, prefer the chain with an issuer matching this Subject Common Name. If no match, the default offered chain will be used.</span>
</span></span><span style=display:flex><span>  <span style=color:green>#preferredChain: &#34;ISRG Root X1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># Optionally specify algorithm and key size for private key. Allowed algorithms: &#34;RSA&#34; (allowed sizes: 2048, 3072, 4096) and &#34;ECDSA&#34; (allowed sizes: 256, 384)</span>
</span></span><span style=display:flex><span>  <span style=color:green># If not specified, RSA with 2048 is used.</span>
</span></span><span style=display:flex><span>  <span style=color:green>#privateKey:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#  algorithm: ECDSA</span>
</span></span><span style=display:flex><span>  <span style=color:green>#  size: 384</span>
</span></span></code></pre></div><h2 id=supported-attributes>Supported attributes<a class=td-heading-self-link href=#supported-attributes aria-label="Heading self-link"></a></h2><p>Here is a list of all supported annotations regarding the certificate extension:</p><table><thead><tr><th>Path</th><th>Annotation</th><th>Value</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td>N/A</td><td><code>cert.gardener.cloud/purpose:</code></td><td><code>managed</code></td><td>Yes when using annotations</td><td>Flag for Gardener that this specific Ingress or Service requires a certificate</td></tr><tr><td><code>spec.commonName</code></td><td><code>cert.gardener.cloud/commonname:</code></td><td>E.g. &ldquo;*.demo.example.com&rdquo; or<br>&ldquo;special.example.com&rdquo;</td><td>Certificate and Ingress : No<br>Service: Yes, if DNS names unset</td><td>Specifies for which domain the certificate request will be created. If not specified, the names from spec.tls[].hosts are used. This entry must comply with the <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/#Character-Restrictions>64 character</a> limit.</td></tr><tr><td><code>spec.dnsNames</code></td><td><code>cert.gardener.cloud/dnsnames:</code></td><td>E.g. &ldquo;special.example.com&rdquo;</td><td>Certificate and Ingress : No<br>Service: Yes, if common name unset</td><td>Additional domains the certificate should be valid for (Subject Alternative Name). If not specified, the names from spec.tls[].hosts are used. Entries in this list can be longer than 64 characters.</td></tr><tr><td><code>spec.secretRef.name</code></td><td><code>cert.gardener.cloud/secretname:</code></td><td><code>any-name</code></td><td>Yes for certificate and Service</td><td>Specifies the secret which contains the certificate/key pair. If the secret is not available yet, it&rsquo;ll be created automatically as soon as the certificate has been issued.</td></tr><tr><td><code>spec.issuerRef.name</code></td><td><code>cert.gardener.cloud/issuer:</code></td><td>E.g. <code>gardener</code></td><td>No</td><td>Specifies the issuer you want to use. Only necessary if you request certificates for <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/#Custom-Domains>custom domains</a>.</td></tr><tr><td>N/A</td><td><code>cert.gardener.cloud/revoked:</code></td><td><code>true</code> otherwise always false</td><td>No</td><td>Use only to revoke a certificate, see <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/#references>reference</a> for more details</td></tr><tr><td><code>spec.followCNAME</code></td><td><code>cert.gardener.cloud/follow-cname</code></td><td>E.g. <code>true</code></td><td>No</td><td>Specifies that the usage of a delegated domain for DNS challenges is allowed. Details see <a href=https://github.com/gardener/cert-management#follow-cname>Follow CNAME</a>.</td></tr><tr><td><code>spec.preferredChain</code></td><td><code>cert.gardener.cloud/preferred-chain</code></td><td>E.g. <code>ISRG Root X1</code></td><td>No</td><td>Specifies the Common Name of the issuer for selecting the certificate chain. Details see <a href=https://github.com/gardener/cert-management#preferred-chain>Preferred Chain</a>.</td></tr><tr><td><code>spec.secretLabels</code></td><td><code>cert.gardener.cloud/secret-labels</code></td><td>for annotation use e.g. <code>key1=value1,key2=value2</code></td><td>No</td><td>Specifies labels for the certificate secret.</td></tr><tr><td><code>spec.privateKey.algorithm</code></td><td><code>cert.gardener.cloud/private-key-algorithm</code></td><td><code>RSA</code>, <code>ECDSA</code></td><td>No</td><td>Specifies algorithm for private key generation. The default value is depending on configuration of the extension (default of the default is <code>RSA</code>). You may request a new certificate without privateKey settings to find out the concrete defaults in your Gardener.</td></tr><tr><td><code>spec.privateKey.size</code></td><td><code>cert.gardener.cloud/private-key-size</code></td><td><code>"256"</code>, <code>"384"</code>, <code>"2048"</code>, <code>"3072"</code>, <code>"4096"</code></td><td>No</td><td>Specifies size for private key generation. Allowed values for <code>RSA</code> are <code>2048</code>, <code>3072</code>, and <code>4096</code>. For <code>ECDSA</code> allowed values are <code>256</code> and <code>384</code>. The default values are depending on the configuration of the extension (defaults of the default values are <code>3072</code> for <code>RSA</code> and <code>384</code> for <code>ECDSA</code> respectively).</td></tr></tbody></table><h2 id=request-a-wildcard-certificate>Request a wildcard certificate<a class=td-heading-self-link href=#request-a-wildcard-certificate aria-label="Heading self-link"></a></h2><p>In order to avoid the creation of multiples certificates for every single endpoints, you may want to create a wildcard certificate for your shoot&rsquo;s default cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/purpose: managed
</span></span><span style=display:flex><span>    cert.gardener.cloud/commonName: <span style=color:#a31515>&#34;*.example.com&#34;</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  tls:
</span></span><span style=display:flex><span>  - hosts:
</span></span><span style=display:flex><span>    - amazing.example.com
</span></span><span style=display:flex><span>    secretName: tls-secret
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  - host: amazing.example.com
</span></span><span style=display:flex><span>    http:
</span></span><span style=display:flex><span>      paths:
</span></span><span style=display:flex><span>      - pathType: Prefix
</span></span><span style=display:flex><span>        path: <span style=color:#a31515>&#34;/&#34;</span>
</span></span><span style=display:flex><span>        backend:
</span></span><span style=display:flex><span>          service:
</span></span><span style=display:flex><span>            name: amazing-svc
</span></span><span style=display:flex><span>            port:
</span></span><span style=display:flex><span>              number: 8080
</span></span></code></pre></div><p>Please note that this can also be achived by directly adding an annotation to a Service type LoadBalancer. You could also create a Certificate object with a wildcard domain.</p><h2 id=using-a-custom-issuer>Using a custom Issuer<a class=td-heading-self-link href=#using-a-custom-issuer aria-label="Heading self-link"></a></h2><p>Most Gardener deployment with the certification extension enabled have a preconfigured <code>garden</code> issuer. It is also usually configured to use Let&rsquo;s Encrypt as the certificate provider.</p><p>If you need a custom issuer for a specific cluster, please see <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/custom_shoot_issuer/>Using a custom Issuer</a></p><h2 id=quotas>Quotas<a class=td-heading-self-link href=#quotas aria-label="Heading self-link"></a></h2><p>For security reasons there may be a default quota on the certificate requests per day set globally in the controller
registration of the shoot-cert-service.</p><p>The default quota only applies if there is no explicit quota defined for the issuer itself with the field
<code>requestsPerDayQuota</code>, e.g.:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-cert-service
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: CertConfig
</span></span><span style=display:flex><span>      issuers:
</span></span><span style=display:flex><span>        - email: your-email@example.com
</span></span><span style=display:flex><span>          name: custom-issuer <span style=color:green># issuer name must be specified in every custom issuer request, must not be &#34;garden&#34;</span>
</span></span><span style=display:flex><span>          server: <span style=color:#a31515>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span>
</span></span><span style=display:flex><span>          requestsPerDayQuota: 10
</span></span></code></pre></div><h2 id=dns-propagation>DNS Propagation<a class=td-heading-self-link href=#dns-propagation aria-label="Heading self-link"></a></h2><p>As stated before, cert-manager uses the ACME challenge protocol to authenticate that you are the DNS owner for the domain&rsquo;s certificate you are requesting.
This works by creating a DNS TXT record in your DNS provider under <code>_acme-challenge.example.example.com</code> containing a token to compare with. The TXT record is only applied during the domain validation.
Typically, the record is propagated within a few minutes. But if the record is not visible to the ACME server for any reasons, the certificate request is retried again after several minutes.
This means you may have to wait up to one hour after the propagation problem has been resolved before the certificate request is retried. Take a look in the events with <code>kubectl describe ingress example</code> for troubleshooting.</p><h2 id=character-restrictions>Character Restrictions<a class=td-heading-self-link href=#character-restrictions aria-label="Heading self-link"></a></h2><p>Due to restriction of the common name to 64 characters, you may to leave the common name unset in such cases.</p><p>For example, the following request is invalid:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Certificate
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: cert-invalid
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  commonName: morethan64characters.ingress.shoot.project.default-domain.gardener.cloud
</span></span></code></pre></div><p>But it is valid to request a certificate for this domain if you have left the common name unset:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Certificate
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: cert-example
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  dnsNames:
</span></span><span style=display:flex><span>  - morethan64characters.ingress.shoot.project.default-domain.gardener.cloud
</span></span></code></pre></div><h2 id=references>References<a class=td-heading-self-link href=#references aria-label="Heading self-link"></a></h2><ul><li><a href=https://github.com/gardener/cert-management>Gardener cert-management</a></li><li><a href=https://github.com/gardener/gardener-extension-shoot-dns-service>Managing DNS with Gardener</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-3402884b4c1c0b3f1b0c817d7375a826>1.4 - Using a custom Issuer</h1><div class=lead>How to define a custom issuer forma shoot cluster</div><h1 id=using-a-custom-issuer>Using a custom Issuer<a class=td-heading-self-link href=#using-a-custom-issuer aria-label="Heading self-link"></a></h1><p>Another possibility to request certificates for custom domains is a dedicated issuer.</p><blockquote><p>Note: This is only needed if the default issuer provided by Gardener is restricted to shoot related domains or you are using domain names not visible to public DNS servers. <strong>Which means that your senario most likely doesn&rsquo;t require your to add an issuer</strong>.</p></blockquote><p>The custom issuers are specified normally in the shoot manifest. If the <code>shootIssuers</code> feature is enabled, it can alternatively be defined in the shoot cluster.</p><h2 id=custom-issuer-in-the-shoot-manifest>Custom issuer in the shoot manifest<a class=td-heading-self-link href=#custom-issuer-in-the-shoot-manifest aria-label="Heading self-link"></a></h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-cert-service
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: CertConfig
</span></span><span style=display:flex><span>      issuers:
</span></span><span style=display:flex><span>        - email: your-email@example.com
</span></span><span style=display:flex><span>          name: custom-issuer <span style=color:green># issuer name must be specified in every custom issuer request, must not be &#34;garden&#34;</span>
</span></span><span style=display:flex><span>          server: <span style=color:#a31515>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span>
</span></span><span style=display:flex><span>          privateKeySecretName: my-privatekey <span style=color:green># referenced resource, the private key must be stored in the secret at `data.privateKey` (optionally, only needed as alternative to auto registration) </span>
</span></span><span style=display:flex><span>          <span style=color:green>#precheckNameservers: # to provide special set of nameservers to be used for prechecking DNSChallenges for an issuer</span>
</span></span><span style=display:flex><span>          <span style=color:green>#- dns1.private.company-net:53</span>
</span></span><span style=display:flex><span>          <span style=color:green>#- dns2.private.company-net:53&#34; </span>
</span></span><span style=display:flex><span>      <span style=color:green>#shootIssuers:</span>
</span></span><span style=display:flex><span>        <span style=color:green># if true, allows to specify issuers in the shoot cluster</span>
</span></span><span style=display:flex><span>        <span style=color:green>#enabled: true </span>
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - name: my-privatekey
</span></span><span style=display:flex><span>    resourceRef:
</span></span><span style=display:flex><span>      apiVersion: v1
</span></span><span style=display:flex><span>      kind: Secret
</span></span><span style=display:flex><span>      name: custom-issuer-privatekey <span style=color:green># name of secret in Gardener project</span>
</span></span></code></pre></div><p>If you are using an ACME provider for private domains, you may need to change the nameservers used for
checking the availability of the DNS challenge&rsquo;s TXT record before the certificate is requested from the ACME provider.
By default, only public DNS servers may be used for this purpose.
At least one of the <code>precheckNameservers</code> must be able to resolve the private domain names.</p><h3 id=using-the-custom-issuer>Using the custom issuer<a class=td-heading-self-link href=#using-the-custom-issuer aria-label="Heading self-link"></a></h3><p>To use the custom issuer in a certificate, just specify its name in the spec.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Certificate
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  issuerRef:
</span></span><span style=display:flex><span>    name: custom-issuer
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>For source resources like <code>Ingress</code> or <code>Service</code> use the <code>cert.gardener.cloud/issuer</code> annotation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/purpose: managed
</span></span><span style=display:flex><span>    cert.gardener.cloud/issuer: custom-issuer
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=custom-issuer-in-the-shoot-cluster>Custom issuer in the shoot cluster<a class=td-heading-self-link href=#custom-issuer-in-the-shoot-cluster aria-label="Heading self-link"></a></h2><p><em>Prerequiste</em>: The <code>shootIssuers</code> feature has to be enabled.
It is either enabled globally in the <code>ControllerDeployment</code> or in the shoot manifest
with:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-cert-service
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: CertConfig
</span></span><span style=display:flex><span>      shootIssuers:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span> <span style=color:green># if true, allows to specify issuers in the shoot cluster</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Example for specifying an <code>Issuer</code> resource and its <code>Secret</code> directly in any
namespace of the shoot cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Issuer
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-own-issuer
</span></span><span style=display:flex><span>  namespace: my-namespace
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  acme:
</span></span><span style=display:flex><span>    domains:
</span></span><span style=display:flex><span>      include:
</span></span><span style=display:flex><span>      - my.own.domain.com
</span></span><span style=display:flex><span>    email: some.user@my.own.domain.com
</span></span><span style=display:flex><span>    privateKeySecretRef:
</span></span><span style=display:flex><span>      name: my-own-issuer-secret
</span></span><span style=display:flex><span>      namespace: my-namespace
</span></span><span style=display:flex><span>    server: https://acme-v02.api.letsencrypt.org/directory
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-own-issuer-secret
</span></span><span style=display:flex><span>  namespace: my-namespace
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  privateKey: ... <span style=color:green># replace &#39;...&#39; with valus encoded as base64</span>
</span></span></code></pre></div><h3 id=using-the-custom-shoot-issuer>Using the custom shoot issuer<a class=td-heading-self-link href=#using-the-custom-shoot-issuer aria-label="Heading self-link"></a></h3><p>To use the custom issuer in a certificate, just specify its name and namespace in the spec.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Certificate
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  issuerRef:
</span></span><span style=display:flex><span>    name: my-own-issuer
</span></span><span style=display:flex><span>    namespace: my-namespace
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>For source resources like <code>Ingress</code> or <code>Service</code> use the <code>cert.gardener.cloud/issuer</code> annotation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/purpose: managed
</span></span><span style=display:flex><span>    cert.gardener.cloud/issuer: my-namespace/my-own-issuer
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-2b9b78037572abda5ff1054023909c78>1.5 - Deployment</h1><h1 id=gardener-certificate-management>Gardener Certificate Management<a class=td-heading-self-link href=#gardener-certificate-management aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener comes with an extension that enables shoot owners to request X.509 compliant certificates for shoot domains.</p><h2 id=extension-installation>Extension Installation<a class=td-heading-self-link href=#extension-installation aria-label="Heading self-link"></a></h2><p>The <code>Shoot-Cert-Service</code> extension can be deployed and configured via Gardener&rsquo;s native resource <a href=/docs/gardener/extensions/controllerregistration/>ControllerRegistration</a>.</p><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><p>To let the <code>Shoot-Cert-Service</code> operate properly, you need to have:</p><ul><li>a <a href=https://github.com/gardener/external-dns-management>DNS service</a> in your seed</li><li>contact details and optionally a private key for a pre-existing <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a> account</li></ul><h3 id=controllerregistration>ControllerRegistration<a class=td-heading-self-link href=#controllerregistration aria-label="Heading self-link"></a></h3><p>An example of a <code>ControllerRegistration</code> for the <code>Shoot-Cert-Service</code> can be found at <a href=https://github.com/gardener/gardener-extension-shoot-cert-service/blob/master/example/controller-registration.yaml>controller-registration.yaml</a>.</p><p>The <code>ControllerRegistration</code> contains a Helm chart which eventually deploy the <code>Shoot-Cert-Service</code> to seed clusters. It offers some configuration options, mainly to set up a default issuer for shoot clusters. With a default issuer, pre-existing Let&rsquo;s Encrypt accounts can be used and shared with shoot clusters (See &ldquo;One Account or Many?&rdquo; of the <a href=https://letsencrypt.org/docs/integration-guide/>Integration Guide</a>).</p><blockquote><p>Please keep the Let&rsquo;s Encrypt <a href=https://letsencrypt.org/docs/rate-limits/>Rate Limits</a> in mind when using this shared account model. Depending on the amount of shoots and domains it is recommended to use an account with increased rate limits.</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerRegistration
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  values:
</span></span><span style=display:flex><span>    certificateConfig:
</span></span><span style=display:flex><span>      defaultIssuer:
</span></span><span style=display:flex><span>        acme:
</span></span><span style=display:flex><span>            email: foo@example.com
</span></span><span style=display:flex><span>            privateKey: |-<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>            -----BEGIN RSA PRIVATE KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>            ...
</span></span></span><span style=display:flex><span><span style=color:#a31515>            -----END RSA PRIVATE KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>            server: https://acme-v02.api.letsencrypt.org/directory</span>            
</span></span><span style=display:flex><span>        name: default-issuer
</span></span><span style=display:flex><span><span style=color:green>#       restricted: true # restrict default issuer to any sub-domain of shoot.spec.dns.domain</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green>#     defaultRequestsPerDayQuota: 50</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green>#     precheckNameservers: 8.8.8.8,8.8.4.4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green>#     caCertificates: | # optional custom CA certificates when using private ACME provider</span>
</span></span><span style=display:flex><span><span style=color:green>#     -----BEGIN CERTIFICATE-----</span>
</span></span><span style=display:flex><span><span style=color:green>#     ...</span>
</span></span><span style=display:flex><span><span style=color:green>#     -----END CERTIFICATE-----</span>
</span></span><span style=display:flex><span><span style=color:green>#</span>
</span></span><span style=display:flex><span><span style=color:green>#     -----BEGIN CERTIFICATE-----</span>
</span></span><span style=display:flex><span><span style=color:green>#     ...</span>
</span></span><span style=display:flex><span><span style=color:green>#     -----END CERTIFICATE-----</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      shootIssuers:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>false</span> <span style=color:green># if true, allows to specify issuers in the shoot clusters</span>
</span></span></code></pre></div><h4 id=enablement>Enablement<a class=td-heading-self-link href=#enablement aria-label="Heading self-link"></a></h4><p>If the <code>Shoot-Cert-Service</code> should be enabled for every shoot cluster in your Gardener managed environment, you need to globally enable it in the <code>ControllerRegistration</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerRegistration
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - globallyEnabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    kind: Extension
</span></span><span style=display:flex><span>    type: shoot-cert-service
</span></span></code></pre></div><p>Alternatively, you&rsquo;re given the option to only enable the service for certain shoots:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-cert-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6d9e639c54740cffc4077bf1de9de8a1>1.6 - Gardener yourself a Shoot with Istio, custom Domains, and Certificates</h1><p>As we ramp up more and more friends of Gardener, I thought it worthwhile to explore and write a tutorial about how to simply:</p><ul><li>create a Gardener managed Kubernetes Cluster (Shoot) via kubectl</li><li>install Istio as a preferred, production ready Ingress/Service Mesh (instead of the Nginx Ingress addon)</li><li>attach your own custom domain to be managed by Gardener</li><li>combine everything with certificates from Let&rsquo;s Encrypt</li></ul><p>Here are some pre-pointers that you will need to go deeper:</p><ul><li><a href=/docs/guides/administer-shoots/create-delete-shoot/>CRUD Gardener Shoot</a></li><li><a href=https://github.com/gardener/external-dns-management/blob/master/README.md>DNS Management</a></li><li><a href=https://github.com/gardener/cert-management/blob/master/README.md>Certificate Management</a></li><li><a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_names/>Tutorial Domain Names</a></li><li><a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/>Tutorial Certificates</a></li></ul><div class="alert alert-primary" role=alert><h4 class=alert-heading>Tip</h4>If you try my instructions and fail, then read the alternative title of this tutorial as &ldquo;Shoot yourself in the foot with Gardener, custom Domains, Istio and Certificates&rdquo;.</div><h2 id=first-things-first>First Things First<a class=td-heading-self-link href=#first-things-first aria-label="Heading self-link"></a></h2><p>Login to your Gardener landscape, setup a project with adequate infrastructure credentials and then navigate to your account. Note down the name of your secret. I chose the GCP infrastructure from the vast possible options that my Gardener provides me with, so i had named the secret as <code>shoot-operator-gcp</code>.</p><p>From the Access widget (leave the default settings) download your personalized <code>kubeconfig</code> into <code>~/.kube/kubeconfig-garden-myproject</code>. Follow the instructions to setup <code>kubelogin</code>:</p><p><img src=/__resources/access_0ffd66.png alt=access></p><p>For convinience, let us set an alias command with</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>alias kgarden=<span style=color:#a31515>&#34;kubectl --kubeconfig ~/.kube/kubeconfig-garden-myproject.yaml&#34;</span>
</span></span></code></pre></div><p><code>kgarden</code> now gives you all botanical powers and connects you directly with your Gardener.</p><p>You should now be able to run <code>kgarden get shoots</code>, automatically get an oidc token, and list already running clusters/shoots.</p><h2 id=prepare-your-custom-domain>Prepare your Custom Domain<a class=td-heading-self-link href=#prepare-your-custom-domain aria-label="Heading self-link"></a></h2><p>I am going to use <a href=https://www.cloudflare.com/>Cloud Flare</a> as programmatic DNS of my custom domain <code>mydomain.io</code>. Please follow detailed instructions from Cloud Flare on how to delegate your domain (the free account does not support delegating subdomains). Alternatively, AWS Route53 (and most others) support <a href=https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/CreatingNewSubdomain.html>delegating subdomains</a>.</p><p>I needed to follow these <a href=https://github.com/gardener/external-dns-management/blob/master/docs/cloudflare/README.md>instructions</a> and created the following secret:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: cloudflare-mydomain-io
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  CLOUDFLARE_API_TOKEN: useYOURownDAMITzNDU2Nzg5MDEyMzQ1Njc4OQ==
</span></span></code></pre></div><p>Apply this secret into your project with <code>kgarden create -f cloudflare-mydomain-io.yaml</code>.</p><p>Our <a href=https://github.com/gardener/external-dns-management/>External DNS Manager</a> also supports Amazon Route53, Google CloudDNS, AliCloud DNS, Azure DNS, or OpenStack Designate. Check it out.</p><h2 id=prepare-gardener-extensions>Prepare Gardener Extensions<a class=td-heading-self-link href=#prepare-gardener-extensions aria-label="Heading self-link"></a></h2><p>I now need to prepare the Gardener extensions <code>shoot-dns-service</code> and <code>shoot-cert-service</code> and set the parameters accordingly.</p><div class="alert alert-info" role=alert>Please note, that the availability of Gardener Extensions depends on how your administrator has configured the Gardener landscape. Please contact your Gardener administrator in case you experience any issues during activation.</div><p>The following snippet allows Gardener to manage my entire custom domain, whereas with the <code>include:</code> attribute I restrict all dynamic entries under the subdomain <code>gsicdc.mydomain.io</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  dns:
</span></span><span style=display:flex><span>    providers:
</span></span><span style=display:flex><span>      - domains:
</span></span><span style=display:flex><span>          include:
</span></span><span style=display:flex><span>            - gsicdc.mydomain.io
</span></span><span style=display:flex><span>        primary: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>        secretName: cloudflare-mydomain-io
</span></span><span style=display:flex><span>        type: cloudflare-dns
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-dns-service
</span></span></code></pre></div><p>The next snipplet allows Gardener to manage certificates automatically from <em><a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a></em> on <code>mydomain.io</code> for me:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-cert-service
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>        issuers:
</span></span><span style=display:flex><span>          - email: me@mail.com
</span></span><span style=display:flex><span>            name: mydomain
</span></span><span style=display:flex><span>            server: <span style=color:#a31515>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span>
</span></span><span style=display:flex><span>          - email: me@mail.com
</span></span><span style=display:flex><span>            name: mydomain-staging
</span></span><span style=display:flex><span>            server: <span style=color:#a31515>&#39;https://acme-staging-v02.api.letsencrypt.org/directory&#39;</span>
</span></span></code></pre></div><div class="alert alert-info" role=alert>Adjust the snipplets with your parameters (don&rsquo;t forget your email). And please use the mydomain-staging issuer while you are testing and learning. Otherwise, Let&rsquo;s Encrypt will rate limit your frequent requests and you can wait a week until you can continue.</div><p>References for <a href=https://letsencrypt.org>Let&rsquo;s Encrypt</a>:</p><ul><li><a href=https://letsencrypt.org/docs/rate-limits/>Rate limit</a></li><li><a href=https://letsencrypt.org/docs/staging-environment/>Staging environment</a></li><li><a href=https://letsencrypt.org/docs/challenge-types/>Challenge Types</a></li><li><a href=https://community.letsencrypt.org/t/acme-v2-production-environment-wildcards/55578>Wildcard Certificates</a></li></ul><h2 id=create-the-gardener-shoot-cluster>Create the Gardener Shoot Cluster<a class=td-heading-self-link href=#create-the-gardener-shoot-cluster aria-label="Heading self-link"></a></h2><p>Remember I chose to create the Shoot on GCP, so below is the simplest declarative shoot or cluster order document. Notice that I am referring to the infrastructure credentials with <code>shoot-operator-gcp</code> and I combined the above snippets into the yaml file:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: gsicdc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  dns:
</span></span><span style=display:flex><span>    providers:
</span></span><span style=display:flex><span>    - domains:
</span></span><span style=display:flex><span>        include:
</span></span><span style=display:flex><span>          - gsicdc.mydomain.io
</span></span><span style=display:flex><span>      primary: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>      secretName: cloudflare-mydomain-io
</span></span><span style=display:flex><span>      type: cloudflare-dns
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-dns-service
</span></span><span style=display:flex><span>  - type: shoot-cert-service
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      issuers:
</span></span><span style=display:flex><span>        - email: me@mail.com
</span></span><span style=display:flex><span>          name: mydomain
</span></span><span style=display:flex><span>          server: <span style=color:#a31515>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span>
</span></span><span style=display:flex><span>        - email: me@mail.com
</span></span><span style=display:flex><span>          name: mydomain-staging
</span></span><span style=display:flex><span>          server: <span style=color:#a31515>&#39;https://acme-staging-v02.api.letsencrypt.org/directory&#39;</span>
</span></span><span style=display:flex><span>  cloudProfileName: gcp
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    allowPrivilegedContainers: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    version: 1.24.8
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    pods: 100.96.0.0/11
</span></span><span style=display:flex><span>    services: 100.64.0.0/13
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>      zone: europe-west1-d
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        workers: 10.250.0.0/16
</span></span><span style=display:flex><span>    type: gcp
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - machine:
</span></span><span style=display:flex><span>        image:
</span></span><span style=display:flex><span>          name: gardenlinux
</span></span><span style=display:flex><span>          version: 576.9.0
</span></span><span style=display:flex><span>        type: n1-standard-2
</span></span><span style=display:flex><span>      maxSurge: 1
</span></span><span style=display:flex><span>      maxUnavailable: 0
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      minimum: 1
</span></span><span style=display:flex><span>      name: my-workerpool
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: pd-standard
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - europe-west1-d
</span></span><span style=display:flex><span>  purpose: testing
</span></span><span style=display:flex><span>  region: europe-west1
</span></span><span style=display:flex><span>  secretBindingName: shoot-operator-gcp
</span></span></code></pre></div><p>Create your cluster and wait for it to be ready (about 5 to 7min).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kgarden create -f gsicdc.yaml
</span></span><span style=display:flex><span>shoot.core.gardener.cloud/gsicdc created
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kgarden get shoot gsicdc --watch
</span></span><span style=display:flex><span>NAME     CLOUDPROFILE   VERSION   SEED   DOMAIN                                        HIBERNATION   OPERATION    PROGRESS   APISERVER     CONTROL       NODES     SYSTEM    AGE
</span></span><span style=display:flex><span>gsicdc   gcp            1.24.8    gcp    gsicdc.myproject.shoot.devgarden.cloud   Awake         Processing   38         Progressing   Progressing   Unknown   Unknown   83s
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>gsicdc   gcp            1.24.8    gcp    gsicdc.myproject.shoot.devgarden.cloud   Awake         Succeeded    100        True          True          True          False         6m7s
</span></span></code></pre></div><p>Get access to your freshly baked cluster and set your <code>KUBECONFIG</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kgarden get secrets gsicdc.kubeconfig -o jsonpath={.data.kubeconfig} | base64 -d &gt;kubeconfig-gsicdc.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ export KUBECONFIG=<span style=color:#00f>$(</span>pwd<span style=color:#00f>)</span>/kubeconfig-gsicdc.yaml
</span></span><span style=display:flex><span>$ kubectl get all
</span></span><span style=display:flex><span>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
</span></span><span style=display:flex><span>service/kubernetes   ClusterIP   100.64.0.1   &lt;none&gt;        443/TCP   89m
</span></span></code></pre></div><h2 id=install-istio>Install Istio<a class=td-heading-self-link href=#install-istio aria-label="Heading self-link"></a></h2><p>Please follow the Istio installation <a href=https://istio.io/docs/setup/getting-started/>instructions</a> and download <code>istioctl</code>. If you are on a Mac, I recommend:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install istioctl
</span></span></code></pre></div><p>I want to install Istio with a default profile and SDS enabled. Furthermore I pass the following annotations to the service object <code>istio-ingressgateway</code> in the <code>istio-system</code> namespace.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/issuer: mydomain-staging
</span></span><span style=display:flex><span>    cert.gardener.cloud/secretname: wildcard-tls
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: <span style=color:#a31515>&#34;*.gsicdc.mydomain.io&#34;</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;120&#34;</span>
</span></span></code></pre></div><p>With these annotations three things now happen automatically:</p><ol><li>The <a href=https://github.com/gardener/external-dns-management/blob/master/README.md>External DNS Manager</a>, provided to you as a service (<code>dns.gardener.cloud/class: garden</code>), picks up the request and creates the wildcard DNS entry <code>*.gsicdc.mydomain.io</code> with a time to live of 120sec at your DNS provider. My provider Cloud Flare is very very quick (as opposed to some other services). You should be able to verify the entry with <code>dig lovemygardener.gsicdc.mydomain.io</code> within seconds.</li><li>The <a href=https://github.com/gardener/cert-management/blob/master/README.md>Certificate Management</a> picks up the request as well and initiates a DNS01 protocol exchange with Let&rsquo;s Encrypt; using the staging environment referred to with the issuer behind <code>mydomain-staging</code>.</li><li>After aproximately 70sec (give and take) you will receive the wildcard certificate in the <code>wildcard-tls</code> secret in the namespace <code>istio-system</code>.</li></ol><div class="alert alert-info" role=alert>Notice, that the namespace for the certificate secret is often the cause of many troubleshooting sessions: the secret must reside in the same namespace of the gateway.</div><p>Here is the istio-install script:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ export domainname=<span style=color:#a31515>&#34;*.gsicdc.mydomain.io&#34;</span>
</span></span><span style=display:flex><span>$ export issuer=<span style=color:#a31515>&#34;mydomain-staging&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | istioctl install -y -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: install.istio.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: IstioOperator
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  profile: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>  components:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    ingressGateways:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - name: istio-ingressgateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>      enabled: true
</span></span></span><span style=display:flex><span><span style=color:#a31515>      k8s:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        serviceAnnotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>          cert.gardener.cloud/issuer: &#34;${issuer}&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>          cert.gardener.cloud/secretname: wildcard-tls
</span></span></span><span style=display:flex><span><span style=color:#a31515>          dns.gardener.cloud/class: garden
</span></span></span><span style=display:flex><span><span style=color:#a31515>          dns.gardener.cloud/dnsnames: &#34;${domainname}&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>          dns.gardener.cloud/ttl: &#34;120&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>Verify that setup is working and that DNS and certificates have been created/delivered:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system describe service istio-ingressgateway
</span></span><span style=display:flex><span>&lt;snip&gt;
</span></span><span style=display:flex><span>Events:
</span></span><span style=display:flex><span>  Type    Reason                Age                From                     Message
</span></span><span style=display:flex><span>  ----    ------                ----               ----                     -------
</span></span><span style=display:flex><span>  Normal  EnsuringLoadBalancer  58s                service-controller       Ensuring load balancer
</span></span><span style=display:flex><span>  Normal  reconcile             58s                cert-controller-manager  created certificate object istio-system/istio-ingressgateway-service-pwqdm
</span></span><span style=display:flex><span>  Normal  cert-annotation       58s                cert-controller-manager  wildcard-tls: cert request is pending
</span></span><span style=display:flex><span>  Normal  cert-annotation       54s                cert-controller-manager  wildcard-tls: certificate pending: certificate requested, preparing/waiting <span style=color:#00f>for</span> successful DNS01 challenge
</span></span><span style=display:flex><span>  Normal  cert-annotation       28s                cert-controller-manager  wildcard-tls: certificate ready
</span></span><span style=display:flex><span>  Normal  EnsuredLoadBalancer   26s                service-controller       Ensured load balancer
</span></span><span style=display:flex><span>  Normal  reconcile             26s                dns-controller-manager   created dns entry object shoot--core--gsicdc/istio-ingressgateway-service-p9qqb
</span></span><span style=display:flex><span>  Normal  dns-annotation        26s                dns-controller-manager   *.gsicdc.mydomain.io: dns entry is pending
</span></span><span style=display:flex><span>  Normal  dns-annotation        21s (x3 over 21s)  dns-controller-manager   *.gsicdc.mydomain.io: dns entry active
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ dig lovemygardener.gsicdc.mydomain.io
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; lovemygardener.gsicdc.mydomain.io
</span></span><span style=display:flex><span>&lt;snip&gt;
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>lovemygardener.gsicdc.mydomain.io. 120 IN A	35.195.120.62
</span></span><span style=display:flex><span>&lt;snip&gt;
</span></span></code></pre></div><p>There you have it, the wildcard-tls certificate is ready and the *.gsicdc.mydomain.io dns entry is active. Traffic will be going your way.</p><h2 id=handy-tools-to-install>Handy Tools to Install<a class=td-heading-self-link href=#handy-tools-to-install aria-label="Heading self-link"></a></h2><p>Another set of fine tools to use are <a href=https://carvel.dev/kapp/>kapp</a> (formerly known as k14s), <a href=https://k9scli.io/>k9s</a> and <a href=https://httpie.org/>HTTPie</a>. While we are at it, let&rsquo;s install them all. If you are on a Mac, I recommend:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew tap vmware-tanzu/carvel
</span></span><span style=display:flex><span>brew install ytt kbld kapp kwt imgpkg vendir
</span></span><span style=display:flex><span>brew install derailed/k9s/k9s
</span></span><span style=display:flex><span>brew install httpie
</span></span></code></pre></div><h2 id=ingress-at-your-service>Ingress at Your Service<a class=td-heading-self-link href=#ingress-at-your-service aria-label="Heading self-link"></a></h2><div class="alert alert-info" role=alert>Networking is a central part of Kubernetes, but it can be challenging to understand exactly how it is expected to work. You should learn about Kubernetes networking, and first try to debug problems yourself. With a solid managed cluster from Gardener, it is always PEBCAK!</div><p>Kubernetes Ingress is a subject that is evolving to much broader standard. Please watch <a href="https://www.youtube.com/watch?v=cduG0FrjdJA">Evolving the Kubernetes Ingress APIs to GA and Beyond</a> for a good introduction. In this example, I did not want to use the Kubernetes <code>Ingress</code> compatibility option of Istio. Instead, I used <code>VirtualService</code> and <code>Gateway</code> from the Istio&rsquo;s API group <code>networking.istio.io/v1</code> directly, and enabled istio-injection generically for the namespace.</p><p>I use <a href=https://httpbin.org/>httpbin</a> as service that I want to expose to the internet, or where my ingress should be routed to (depends on your point of view, I guess).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Namespace
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: production
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    istio-injection: enabled
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: httpbin
</span></span><span style=display:flex><span>  namespace: production
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    app: httpbin
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>  - name: http
</span></span><span style=display:flex><span>    port: 8000
</span></span><span style=display:flex><span>    targetPort: 80
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    app: httpbin
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: apps/v1
</span></span><span style=display:flex><span>kind: Deployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: httpbin
</span></span><span style=display:flex><span>  namespace: production
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  replicas: 1
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      app: httpbin
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        app: httpbin
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>      - image: docker.io/kennethreitz/httpbin
</span></span><span style=display:flex><span>        imagePullPolicy: IfNotPresent
</span></span><span style=display:flex><span>        name: httpbin
</span></span><span style=display:flex><span>        ports:
</span></span><span style=display:flex><span>        - containerPort: 80
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: networking.istio.io/v1
</span></span><span style=display:flex><span>kind: Gateway
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: httpbin-gw
</span></span><span style=display:flex><span>  namespace: production
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    istio: ingressgateway <span style=color:green>#! use istio default ingress gateway</span>
</span></span><span style=display:flex><span>  servers:
</span></span><span style=display:flex><span>  - port:
</span></span><span style=display:flex><span>      number: 80
</span></span><span style=display:flex><span>      name: http
</span></span><span style=display:flex><span>      protocol: HTTP
</span></span><span style=display:flex><span>    tls:
</span></span><span style=display:flex><span>      httpsRedirect: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    hosts:
</span></span><span style=display:flex><span>    - <span style=color:#a31515>&#34;httpbin.gsicdc.mydomain.io&#34;</span>
</span></span><span style=display:flex><span>  - port:
</span></span><span style=display:flex><span>      number: 443
</span></span><span style=display:flex><span>      name: https
</span></span><span style=display:flex><span>      protocol: HTTPS
</span></span><span style=display:flex><span>    tls:
</span></span><span style=display:flex><span>      mode: SIMPLE
</span></span><span style=display:flex><span>      credentialName: wildcard-tls
</span></span><span style=display:flex><span>    hosts:
</span></span><span style=display:flex><span>    - <span style=color:#a31515>&#34;httpbin.gsicdc.mydomain.io&#34;</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: networking.istio.io/v1
</span></span><span style=display:flex><span>kind: VirtualService
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: httpbin-vs
</span></span><span style=display:flex><span>  namespace: production
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  hosts:
</span></span><span style=display:flex><span>  - <span style=color:#a31515>&#34;httpbin.gsicdc.mydomain.io&#34;</span>
</span></span><span style=display:flex><span>  gateways:
</span></span><span style=display:flex><span>  - httpbin-gw
</span></span><span style=display:flex><span>  http:
</span></span><span style=display:flex><span>  - match:
</span></span><span style=display:flex><span>    - uri:
</span></span><span style=display:flex><span>        regex: /.*
</span></span><span style=display:flex><span>    route:
</span></span><span style=display:flex><span>    - destination:
</span></span><span style=display:flex><span>        port:
</span></span><span style=display:flex><span>          number: 8000
</span></span><span style=display:flex><span>        host: httpbin
</span></span><span style=display:flex><span>---
</span></span></code></pre></div><p>Let us now deploy the whole package of Kubernetes primitives using <code>kapp</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kapp deploy -a httpbin -f httpbin-kapp.yaml
</span></span><span style=display:flex><span>Target cluster <span style=color:#a31515>&#39;https://api.gsicdc.myproject.shoot.devgarden.cloud&#39;</span> (nodes: shoot--myproject--gsicdc-my-workerpool-z1-6586c8f6cb-x24kh)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Changes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Namespace   Name        Kind            Conds.  Age  Op      Wait to    Rs  Ri
</span></span><span style=display:flex><span>(cluster)   production  Namespace       -       -    create  reconcile  -   -
</span></span><span style=display:flex><span>production  httpbin     Deployment      -       -    create  reconcile  -   -
</span></span><span style=display:flex><span>^           httpbin     Service         -       -    create  reconcile  -   -
</span></span><span style=display:flex><span>^           httpbin-gw  Gateway         -       -    create  reconcile  -   -
</span></span><span style=display:flex><span>^           httpbin-vs  VirtualService  -       -    create  reconcile  -   -
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Op:      5 create, 0 delete, 0 update, 0 noop
</span></span><span style=display:flex><span>Wait to: 5 reconcile, 0 delete, 0 noop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Continue? [yN]: y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>5:36:31PM: ---- applying 1 changes [0/5 <span style=color:#00f>done</span>] ----
</span></span><span style=display:flex><span>&lt;snip&gt;
</span></span><span style=display:flex><span>5:37:00PM: ok: reconcile deployment/httpbin (apps/v1) namespace: production
</span></span><span style=display:flex><span>5:37:00PM: ---- applying complete [5/5 <span style=color:#00f>done</span>] ----
</span></span><span style=display:flex><span>5:37:00PM: ---- waiting complete [5/5 <span style=color:#00f>done</span>] ----
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Succeeded
</span></span></code></pre></div><p>Let&rsquo;s finally test the service (Of course you can use the browser as well):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ http httpbin.gsicdc.mydomain.io
</span></span><span style=display:flex><span>HTTP/1.1 301 Moved Permanently
</span></span><span style=display:flex><span>content-length: 0
</span></span><span style=display:flex><span>date: Wed, 13 May 2020 21:29:13 GMT
</span></span><span style=display:flex><span>location: https://httpbin.gsicdc.mydomain.io/
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ curl -k https://httpbin.gsicdc.mydomain.io/ip
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#34;origin&#34;</span>: <span style=color:#a31515>&#34;10.250.0.2&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Quod erat demonstrandum.
The proof of exchanging the issuer is now left to the reader.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Tip</h4>Remember that the certificate is actually not valid because it is issued from the Let&rsquo;s encrypt staging environment. Thus, we needed &ldquo;curl -k&rdquo; or &ldquo;http &ndash;verify no&rdquo;.</div><p>Hint: use the interactive k9s tool.
<img src=/__resources/k9s_97660c.png alt=k9s></p><h2 id=cleanup>Cleanup<a class=td-heading-self-link href=#cleanup aria-label="Heading self-link"></a></h2><p>Remove the cloud native application:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kapp ls
</span></span><span style=display:flex><span>Apps in namespace <span style=color:#a31515>&#39;default&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Name     Namespaces            Lcs   Lca
</span></span><span style=display:flex><span>httpbin  (cluster),production  true  17m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kapp delete -a httpbin
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Continue? [yN]: y
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>11:47:47PM: ---- waiting complete [8/8 <span style=color:#00f>done</span>] ----
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Succeeded
</span></span></code></pre></div><p>Remove Istio:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ istioctl x uninstall --purge
</span></span><span style=display:flex><span>clusterrole.rbac.authorization.k8s.io <span style=color:#a31515>&#34;prometheus-istio-system&#34;</span> deleted
</span></span><span style=display:flex><span>clusterrolebinding.rbac.authorization.k8s.io <span style=color:#a31515>&#34;prometheus-istio-system&#34;</span> deleted
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Delete your Shoot:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kgarden annotate shoot gsicdc confirmation.gardener.cloud/deletion=true --overwrite
</span></span><span style=display:flex><span>kgarden delete shoot gsicdc --wait=false
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-a2a5f0d146f804e6007c05aca45d155f>1.7 - Gateway Api Gateways</h1><h1 id=using-annotated-gateway-api-gateway-andor-httproutes-as-source>Using annotated Gateway API Gateway and/or HTTPRoutes as Source<a class=td-heading-self-link href=#using-annotated-gateway-api-gateway-andor-httproutes-as-source aria-label="Heading self-link"></a></h1><p>This tutorial describes how to use annotated Gateway API resources as source for <code>Certificate</code>.</p><h2 id=install-istio-on-your-cluster>Install Istio on your cluster<a class=td-heading-self-link href=#install-istio-on-your-cluster aria-label="Heading self-link"></a></h2><p>Follow the Istio <a href=https://istio.io/latest/docs/tasks/traffic-management/ingress/gateway-api/>Kubernetes Gateway API</a> to
install the Gateway API and to install Istio.</p><p>These are the typical commands for the Istio installation with the Kubernetes Gateway API:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export KUEBCONFIG=...
</span></span><span style=display:flex><span>curl -L https://istio.io/downloadIstio | sh -
</span></span><span style=display:flex><span>kubectl get crd gateways.gateway.networking.k8s.io &amp;&gt; /dev/null || <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  { kubectl kustomize <span style=color:#a31515>&#34;github.com/kubernetes-sigs/gateway-api/config/crd?ref=v1.0.0&#34;</span> | kubectl apply -f -; }
</span></span><span style=display:flex><span>istioctl install --set profile=minimal -y
</span></span><span style=display:flex><span>kubectl label namespace default istio-injection=enabled
</span></span></code></pre></div><h2 id=verify-that-gateway-source-works>Verify that Gateway Source works<a class=td-heading-self-link href=#verify-that-gateway-source-works aria-label="Heading self-link"></a></h2><h3 id=install-a-sample-service>Install a sample service<a class=td-heading-self-link href=#install-a-sample-service aria-label="Heading self-link"></a></h3><p>With automatic sidecar injection:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/httpbin/httpbin.yaml
</span></span></code></pre></div><p>Note: The sample service is not used in the following steps. It is deployed for illustration purposes only.
To use it with certificates, you have to add an HTTPS port for it.</p><h3 id=using-a-gateway-as-a-source>Using a Gateway as a source<a class=td-heading-self-link href=#using-a-gateway-as-a-source aria-label="Heading self-link"></a></h3><p>Deploy the Gateway API configuration including a single exposed route (i.e., /get):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace istio-ingress
</span></span><span style=display:flex><span>kubectl apply -f - <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    #cert.gardener.cloud/dnsnames: &#34;*.example.com&#34; # alternative if you want to control the dns names explicitly.
</span></span></span><span style=display:flex><span><span style=color:#a31515>    cert.gardener.cloud/purpose: managed
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gatewayClassName: istio
</span></span></span><span style=display:flex><span><span style=color:#a31515>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hostname: &#34;*.example.com&#34;  # this is used by cert-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>    port: 443
</span></span></span><span style=display:flex><span><span style=color:#a31515>    protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#a31515>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      namespaces:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        from: All
</span></span></span><span style=display:flex><span><span style=color:#a31515>    tls:                       # important: tls section must be defined with exactly one certificateRefs item
</span></span></span><span style=display:flex><span><span style=color:#a31515>      certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        - name: foo-example-com
</span></span></span><span style=display:flex><span><span style=color:#a31515>---
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>    namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hostnames: [&#34;httpbin.example.com&#34;]  # this is used by cert-controller-manager to extract DNS names too
</span></span></span><span style=display:flex><span><span style=color:#a31515>  rules:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - path:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#a31515>        value: /get
</span></span></span><span style=display:flex><span><span style=color:#a31515>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>      port: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>You should now see a created <code>Certificate</code> resource similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-ingress get cert -oyaml
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>items:
</span></span><span style=display:flex><span>- apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: Certificate
</span></span><span style=display:flex><span>  metadata:
</span></span><span style=display:flex><span>    generateName: gateway-gateway-
</span></span><span style=display:flex><span>    name: gateway-gateway-kdw6h
</span></span><span style=display:flex><span>    namespace: istio-ingress
</span></span><span style=display:flex><span>    ownerReferences:
</span></span><span style=display:flex><span>    - apiVersion: gateway.networking.k8s.io/v1
</span></span><span style=display:flex><span>      blockOwnerDeletion: true
</span></span><span style=display:flex><span>      controller: true
</span></span><span style=display:flex><span>      kind: Gateway
</span></span><span style=display:flex><span>      name: gateway
</span></span><span style=display:flex><span>  spec:
</span></span><span style=display:flex><span>    commonName: <span style=color:#a31515>&#39;*.example.com&#39;</span>
</span></span><span style=display:flex><span>    secretName: foo-example-com
</span></span><span style=display:flex><span>  status:
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>kind: List
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  resourceVersion: <span style=color:#a31515>&#34;&#34;</span>
</span></span></code></pre></div><h4 id=using-a-httproute-as-a-source>Using a HTTPRoute as a source<a class=td-heading-self-link href=#using-a-httproute-as-a-source aria-label="Heading self-link"></a></h4><p>If the <code>Gateway</code> resource is annotated with <code>cert.gardener.cloud/purpose: managed</code>,
hostnames from all referencing <code>HTTPRoute</code> resources are automatically extracted.
These resources don&rsquo;t need an additional annotation.</p><p>Deploy the Gateway API configuration including a single exposed route (i.e., /get):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace istio-ingress
</span></span><span style=display:flex><span>kubectl apply -f - <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    cert.gardener.cloud/purpose: managed
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gatewayClassName: istio
</span></span></span><span style=display:flex><span><span style=color:#a31515>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hostname: null  # not set 
</span></span></span><span style=display:flex><span><span style=color:#a31515>    port: 443
</span></span></span><span style=display:flex><span><span style=color:#a31515>    protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#a31515>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      namespaces:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        from: All
</span></span></span><span style=display:flex><span><span style=color:#a31515>    tls:                            # important: tls section must be defined with exactly one certificateRefs item
</span></span></span><span style=display:flex><span><span style=color:#a31515>      certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        - name: foo-example-com
</span></span></span><span style=display:flex><span><span style=color:#a31515>---
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>    namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hostnames: [&#34;httpbin.example.com&#34;]  # this is used by dns-controller-manager to extract DNS names too
</span></span></span><span style=display:flex><span><span style=color:#a31515>  rules:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - path:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#a31515>        value: /get
</span></span></span><span style=display:flex><span><span style=color:#a31515>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>      port: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>This should show a similar <code>Certificate</code> resource as above.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-614605ecfea245fcd8cabc692b978938>1.8 - Istio Gateways</h1><h1 id=using-annotated-istio-gateway-andor-istio-virtual-service-as-source>Using annotated Istio Gateway and/or Istio Virtual Service as Source<a class=td-heading-self-link href=#using-annotated-istio-gateway-andor-istio-virtual-service-as-source aria-label="Heading self-link"></a></h1><p>This tutorial describes how to use annotated Istio Gateway resources as source for <code>Certificate</code> resources.</p><h2 id=install-istio-on-your-cluster>Install Istio on your cluster<a class=td-heading-self-link href=#install-istio-on-your-cluster aria-label="Heading self-link"></a></h2><p>Follow the <a href=https://istio.io/latest/docs/setup/getting-started/>Istio Getting Started</a> to download and install Istio.</p><p>These are the typical commands for the istio demo installation</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export KUEBCONFIG=...
</span></span><span style=display:flex><span>curl -L https://istio.io/downloadIstio | sh -
</span></span><span style=display:flex><span>istioctl install --set profile=demo -y
</span></span><span style=display:flex><span>kubectl label namespace default istio-injection=enabled
</span></span></code></pre></div><p><em>Note: If you are using a KinD cluster, the istio-ingressgateway service may be pending forever.</em></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system get svc istio-ingressgateway
</span></span><span style=display:flex><span>NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                                                                      AGE
</span></span><span style=display:flex><span>istio-ingressgateway   LoadBalancer   10.96.88.189   &lt;pending&gt;     15021:30590/TCP,80:30185/TCP,443:30075/TCP,31400:30129/TCP,15443:30956/TCP   13m
</span></span></code></pre></div><p>In this case, you may patch the status for demo purposes (of course it still would not accept connections)</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n istio-system patch svc istio-ingressgateway --type=merge --subresource status --patch <span style=color:#a31515>&#39;{&#34;status&#34;:{&#34;loadBalancer&#34;:{&#34;ingress&#34;:[{&#34;ip&#34;:&#34;1.2.3.4&#34;}]}}}&#39;</span>
</span></span></code></pre></div><h2 id=verify-that-istio-gatewayvirtualservice-source-works>Verify that Istio Gateway/VirtualService Source works<a class=td-heading-self-link href=#verify-that-istio-gatewayvirtualservice-source-works aria-label="Heading self-link"></a></h2><h3 id=install-a-sample-service>Install a sample service<a class=td-heading-self-link href=#install-a-sample-service aria-label="Heading self-link"></a></h3><p>With automatic sidecar injection:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/httpbin/httpbin.yaml
</span></span></code></pre></div><h3 id=using-a-gateway-as-a-source>Using a Gateway as a source<a class=td-heading-self-link href=#using-a-gateway-as-a-source aria-label="Heading self-link"></a></h3><h4 id=create-an-istio-gateway>Create an Istio Gateway:<a class=td-heading-self-link href=#create-an-istio-gateway aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-system
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    #cert.gardener.cloud/dnsnames: &#34;*.example.com&#34; # alternative if you want to control the dns names explicitly.
</span></span></span><span style=display:flex><span><span style=color:#a31515>    cert.gardener.cloud/purpose: managed
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  selector:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    istio: ingressgateway # use Istio default gateway implementation
</span></span></span><span style=display:flex><span><span style=color:#a31515>  servers:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      number: 443
</span></span></span><span style=display:flex><span><span style=color:#a31515>      name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>      protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - &#34;httpbin.example.com&#34; # this is used by the dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>    tls:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      credentialName: my-tls-secret
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>You should now see a created <code>Certificate</code> resource similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system get cert -oyaml
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>items:
</span></span><span style=display:flex><span>- apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: Certificate
</span></span><span style=display:flex><span>  metadata:
</span></span><span style=display:flex><span>    generateName: httpbin-gateway-gateway-
</span></span><span style=display:flex><span>    name: httpbin-gateway-gateway-hdbjb
</span></span><span style=display:flex><span>    namespace: istio-system
</span></span><span style=display:flex><span>    ownerReferences:
</span></span><span style=display:flex><span>    - apiVersion: networking.istio.io/v1
</span></span><span style=display:flex><span>      blockOwnerDeletion: true
</span></span><span style=display:flex><span>      controller: true
</span></span><span style=display:flex><span>      kind: Gateway
</span></span><span style=display:flex><span>      name: httpbin-gateway
</span></span><span style=display:flex><span>  spec:
</span></span><span style=display:flex><span>    commonName: httpbin.example.com
</span></span><span style=display:flex><span>    secretName: my-tls-secret
</span></span><span style=display:flex><span>  status:
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>kind: List
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  resourceVersion: <span style=color:#a31515>&#34;&#34;</span>
</span></span></code></pre></div><h3 id=using-a-virtualservice-as-a-source>Using a VirtualService as a source<a class=td-heading-self-link href=#using-a-virtualservice-as-a-source aria-label="Heading self-link"></a></h3><p>If the <code>Gateway</code> resource is annotated with <code>cert.gardener.cloud/purpose: managed</code>,
hosts from all referencing <code>VirtualServices</code> resources are automatically extracted.
These resources don&rsquo;t need an additional annotation.</p><h4 id=create-an-istio-gateway-1>Create an Istio Gateway:<a class=td-heading-self-link href=#create-an-istio-gateway-1 aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-system
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    cert.gardener.cloud/purpose: managed
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  selector:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    istio: ingressgateway # use Istio default gateway implementation
</span></span></span><span style=display:flex><span><span style=color:#a31515>  servers:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      number: 443
</span></span></span><span style=display:flex><span><span style=color:#a31515>      name: https
</span></span></span><span style=display:flex><span><span style=color:#a31515>      protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    tls:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      credentialName: my-tls-secret    
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><h4 id=configure-routes-for-traffic-entering-via-the-gateway>Configure routes for traffic entering via the Gateway:<a class=td-heading-self-link href=#configure-routes-for-traffic-entering-via-the-gateway aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: VirtualService
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default  
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - &#34;httpbin.example.com&#34; # this is used by dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gateways:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - istio-system/httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  http:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - match:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /status
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /delay
</span></span></span><span style=display:flex><span><span style=color:#a31515>    route:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - destination:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>          number: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>        host: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>This should show a similar <code>Certificate</code> resource as above.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4773e80fa0a0952ed75e41786df93e8c>2 - DNS services</h1><div class=lead>Gardener extension controller for DNS services for shoot clusters</div><h1 id=gardener-extension-for-dns-serviceshttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for DNS services</a><a class=td-heading-self-link href=#gardener-extension-for-dns-serviceshttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-dns-service><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-dns-service alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-shoot-dns-service-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-shoot-dns-service-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-shoot-dns-service><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-shoot-dns-service alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service. Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>. However, the project has grown to a size where it is very hard to extend, maintain, and test. With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics. This way, we can keep Gardener core clean and independent.</p><h2 id=extension-resources>Extension-Resources<a class=td-heading-self-link href=#extension-resources aria-label="Heading self-link"></a></h2><p>Example extension resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Extension
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: <span style=color:#a31515>&#34;extension-dns-service&#34;</span>
</span></span><span style=display:flex><span>  namespace: shoot--project--abc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: shoot-dns-service
</span></span></code></pre></div><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the kubeconfig to the cluster you want to connect to ready in the <code>./dev/kubeconfig</code> file.
Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-dns-service/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-28d1868bb81c37360bc1080f4bd76d56>2.1 - Configuration</h1><h1 id=deployment-of-the-shoot-dns-service-extension>Deployment of the shoot DNS service extension<a class=td-heading-self-link href=#deployment-of-the-shoot-dns-service-extension aria-label="Heading self-link"></a></h1><p><strong>Disclaimer:</strong> This document is NOT a step by step deployment guide for the shoot DNS service extension and only contains some configuration specifics regarding the deployment of different components via the helm charts residing in the shoot DNS service extension <a href=https://github.com/gardener/gardener-extension-shoot-dns-service>repository</a>.</p><h2 id=gardener-extension-admission-shoot-dns-service>gardener-extension-admission-shoot-dns-service<a class=td-heading-self-link href=#gardener-extension-admission-shoot-dns-service aria-label="Heading self-link"></a></h2><h3 id=authentication-against-the-garden-cluster>Authentication against the Garden cluster<a class=td-heading-self-link href=#authentication-against-the-garden-cluster aria-label="Heading self-link"></a></h3><p>There are several authentication possibilities depending on whether or not <a href=https://github.com/gardener/garden-setup#concept-the-virtual-cluster>the concept of Virtual Garden</a> is used.</p><h4 id=virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster>Virtual Garden is not used, i.e., the <code>runtime</code> Garden cluster is also the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster aria-label="Heading self-link"></a></h4><h5 id=automounted-service-account-token>Automounted Service Account Token<a class=td-heading-self-link href=#automounted-service-account-token aria-label="Heading self-link"></a></h5><p>The easiest way to deploy the <code>gardener-extension-admission-shoot-dns-service</code> component will be to not provide <code>kubeconfig</code> at all. This way in-cluster configuration and an automounted service account token will be used. The drawback of this approach is that the automounted token will not be automatically rotated.</p><h5 id=service-account-token-volume-projection>Service Account Token Volume Projection<a class=td-heading-self-link href=#service-account-token-volume-projection aria-label="Heading self-link"></a></h5><p>Another solution will be to use <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>Service Account Token Volume Projection</a> combined with a <code>kubeconfig</code> referencing a token file (see example below).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://default.kubernetes.svc.cluster.local
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: garden
</span></span><span style=display:flex><span>    user: garden
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>current-context: garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div><p>This will allow for automatic rotation of the service account token by the <code>kubelet</code>. The configuration can be achieved by setting both <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.kubeconfig</code> in the respective chart&rsquo;s <code>values.yaml</code> file.</p><h4 id=virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster>Virtual Garden is used, i.e., the <code>runtime</code> Garden cluster is different from the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster aria-label="Heading self-link"></a></h4><h5 id=service-account>Service Account<a class=td-heading-self-link href=#service-account aria-label="Heading self-link"></a></h5><p>The easiest way to setup the authentication will be to create a service account and the respective roles will be bound to this service account in the <code>target</code> cluster. Then use the generated service account token and craft a <code>kubeconfig</code> which will be used by the workload in the <code>runtime</code> cluster. This approach does not provide a solution for the rotation of the service account token. However, this setup can be achieved by setting <code>.Values.global.virtualGarden.enabled: true</code> and following these steps:</p><ol><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Get the service account token and craft the <code>kubeconfig</code>.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><h5 id=client-certificate>Client Certificate<a class=td-heading-self-link href=#client-certificate aria-label="Heading self-link"></a></h5><p>Another solution will be to bind the roles in the <code>target</code> cluster to a <code>User</code> subject instead of a service account and use a client certificate for authentication. This approach does not provide a solution for the client certificate rotation. However, this setup can be achieved by setting both <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>, then following these steps:</p><ol><li>Generate a client certificate for the <code>target</code> cluster for the respective user.</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Craft a <code>kubeconfig</code> using the already generated client certificate.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><h5 id=projected-service-account-token>Projected Service Account Token<a class=td-heading-self-link href=#projected-service-account-token aria-label="Heading self-link"></a></h5><p>This approach requires an already deployed and configured <a href=https://github.com/gardener/oidc-webhook-authenticator>oidc-webhook-authenticator</a> for the <code>target</code> cluster. Also the <code>runtime</code> cluster should be registered as a trusted identity provider in the <code>target</code> cluster. Then projected service accounts tokens from the <code>runtime</code> cluster can be used to authenticate against the <code>target</code> cluster. The needed steps are as follows:</p><ol><li>Deploy <a href=https://github.com/gardener/oidc-webhook-authenticator>OWA</a> and establish the needed trust.</li><li>Set <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>. <strong>Note:</strong> username value will depend on the trust configuration, e.g., <code>&lt;prefix>:system:serviceaccount:&lt;namespace>:&lt;serviceaccount></code></li><li>Set <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.serviceAccountTokenVolumeProjection.audience</code>. <strong>Note:</strong> audience value will depend on the trust configuration, e.g., <code>&lt;cliend-id-from-trust-config></code>.</li><li>Craft a kubeconfig (see example below).</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://virtual-garden.api
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: virtual-garden
</span></span><span style=display:flex><span>    user: virtual-garden
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>current-context: virtual-garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: virtual-garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-12a6b686a7df4d2160d67befee1ebdfa>2.2 - Deployment</h1><h1 id=gardener-dns-management-for-shoots>Gardener DNS Management for Shoots<a class=td-heading-self-link href=#gardener-dns-management-for-shoots aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener allows Shoot clusters to request DNS names for Ingresses and Services out of the box.
To support this the gardener must be installed with the <code>shoot-dns-service</code>
extension.
This extension uses the seed&rsquo;s dns management infrastructure to maintain DNS
names for shoot clusters. So, far only the external DNS domain of a shoot
(already used for the kubernetes api server and ingress DNS names) can be used
for managed DNS names.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>To generally enable the DNS management for shoot objects the
<code>shoot-dns-service</code> extension must be registered by providing an
appropriate <a href=https://github.com/gardener/gardener-extension-shoot-dns-service/blob/master/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available
for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots, the registration must set the <em>globallyEnabled</em> flag to <code>true</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - kind: Extension
</span></span><span style=display:flex><span>      type: shoot-dns-service
</span></span><span style=display:flex><span>      globallyEnabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=deployment-of-dns-controller-manager>Deployment of DNS controller manager<a class=td-heading-self-link href=#deployment-of-dns-controller-manager aria-label="Heading self-link"></a></h3><p>If you are using Gardener version >= <code>1.54</code>, please make sure to deploy the DNS controller manager by
adding the <code>dnsControllerManager</code> section to the <code>providerConfig.values</code> section.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerDeployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-dns-service
</span></span><span style=display:flex><span>type: helm
</span></span><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  chart: ...
</span></span><span style=display:flex><span>  values:
</span></span><span style=display:flex><span>    image:
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>    dnsControllerManager:
</span></span><span style=display:flex><span>      image:
</span></span><span style=display:flex><span>        repository: europe-docker.pkg.dev/gardener-project/releases/dns-controller-manager
</span></span><span style=display:flex><span>        tag: v0.16.0
</span></span><span style=display:flex><span>      configuration:
</span></span><span style=display:flex><span>        cacheTtl: 300
</span></span><span style=display:flex><span>        controllers: dnscontrollers,dnssources
</span></span><span style=display:flex><span>        dnsPoolResyncPeriod: 30m
</span></span><span style=display:flex><span>        <span style=color:green>#poolSize: 20</span>
</span></span><span style=display:flex><span>        <span style=color:green>#providersPoolResyncPeriod: 24h</span>
</span></span><span style=display:flex><span>        serverPortHttp: 8080
</span></span><span style=display:flex><span>      createCRDs: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>      deploy: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      replicaCount: 1
</span></span><span style=display:flex><span>      <span style=color:green>#resources:</span>
</span></span><span style=display:flex><span>      <span style=color:green>#  requests:</span>
</span></span><span style=display:flex><span>      <span style=color:green>#    cpu: 50m</span>
</span></span><span style=display:flex><span>      <span style=color:green>#    memory: 500Mi</span>
</span></span><span style=display:flex><span>    dnsProviderManagement:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=providing-base-domains-usable-for-a-shoot>Providing Base Domains usable for a Shoot<a class=td-heading-self-link href=#providing-base-domains-usable-for-a-shoot aria-label="Heading self-link"></a></h3><p>So, far only the external DNS domain of a shoot already used
for the kubernetes api server and ingress DNS names can be used for managed
DNS names. This is either the shoot domain as subdomain of the default domain
configured for the gardener installation, or a dedicated domain with dedicated
access credentials configured for a dedicated shoot via the shoot manifest.</p><p>Alternatively, you can specify <code>DNSProviders</code> and its credentials
<code>Secret</code> directly in the shoot, if this feature is enabled.
By default, <code>DNSProvider</code> replication is disabled, but it can be enabled globally in the <code>ControllerDeployment</code>
or for a shoot cluster in the shoot manifest (details see further below).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerDeployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-dns-service
</span></span><span style=display:flex><span>type: helm
</span></span><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  chart: ...
</span></span><span style=display:flex><span>  values:
</span></span><span style=display:flex><span>    image:
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>    dnsProviderReplication:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>See <a href=https://github.com/gardener/external-dns-management/tree/master/examples>example files (20-* and 30-*)</a>
for details for the various provider types.</p><h3 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h3><p>If the shoot DNS feature is not globally enabled by default (depends on the
extension registration on the garden cluster), it must be enabled per shoot.</p><p>To enable the feature for a shoot, the shoot manifest must explicitly add the
<code>shoot-dns-service</code> extension.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-dns-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h4 id=enabledisable-dns-provider-replication-for-a-shoot>Enable/disable DNS provider replication for a shoot<a class=td-heading-self-link href=#enabledisable-dns-provider-replication-for-a-shoot aria-label="Heading self-link"></a></h4><p>The DNSProvider` replication feature enablement can be overwritten in the
shoot manifest, e.g.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>Kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-dns-service
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        apiVersion: service.dns.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>        kind: DNSConfig
</span></span><span style=display:flex><span>        dnsProviderReplication:
</span></span><span style=display:flex><span>          enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-25999a79f656efd317f31f09d85cb4cf>2.3 - DNS Names</h1><h1 id=request-dns-names-in-shoot-clusters>Request DNS Names in Shoot Clusters<a class=td-heading-self-link href=#request-dns-names-in-shoot-clusters aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Within a shoot cluster, it is possible to request DNS records via the following resource types:</p><ul><li><a href=https://kubernetes.io/docs/concepts/services-networking/ingress/>Ingress</a></li><li><a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a></li><li><a href=https://github.com/gardener/external-dns-management/blob/master/README.md#the-model>DNSEntry</a></li></ul><p>It is necessary that the Gardener installation your shoot cluster runs in is equipped with a <code>shoot-dns-service</code> extension. This extension uses the seed&rsquo;s dns management infrastructure to maintain DNS names for shoot clusters. Please ask your Gardener operator if the extension is available in your environment.</p><h2 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h2><p>In some Gardener setups the <code>shoot-dns-service</code> extension is not enabled globally and thus must be configured per shoot cluster. Please adapt the shoot specification by the configuration shown below to activate the extension individually.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-dns-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=before-you-start>Before you start<a class=td-heading-self-link href=#before-you-start aria-label="Heading self-link"></a></h2><p>You should :</p><ul><li>Have created a shoot cluster</li><li>Have created and correctly configured a DNS Provider (Please consult <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_providers/>this page</a> for more information)</li><li>Have a basic understanding of DNS (see link under <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_names/#references>References</a>)</li></ul><p>There are 2 types of DNS that you can use within Kubernetes :</p><ul><li>internal (usually managed by coreDNS)</li><li>external (managed by a public DNS provider).</li></ul><p>This page, and the extension, exclusively works for external DNS handling.</p><p>Gardener allows 2 way of managing your external DNS:</p><ul><li>Manually, which means you are in charge of creating / maintaining your Kubernetes related DNS entries</li><li>Via the Gardener DNS extension</li></ul><h2 id=gardener-dns-extension>Gardener DNS extension<a class=td-heading-self-link href=#gardener-dns-extension aria-label="Heading self-link"></a></h2><p>The managed external DNS records feature of the Gardener clusters makes all this easier. You do not need DNS service provider specific knowledge, and in fact you do not need to leave your cluster at all to achieve that. You simply annotate the Ingress / Service that needs its DNS records managed and it will be automatically created / managed by Gardener.</p><p>Managed external DNS records are supported with the following DNS provider types:</p><ul><li>aws-route53</li><li>azure-dns</li><li>azure-private-dns</li><li>google-clouddns</li><li>openstack-designate</li><li>alicloud-dns</li><li>cloudflare-dns</li></ul><h3 id=request-dns-records-for-ingress-resources>Request DNS records for Ingress resources<a class=td-heading-self-link href=#request-dns-records-for-ingress-resources aria-label="Heading self-link"></a></h3><p>To request a DNS name for <code>Ingress</code>, <code>Service</code> or <code>Gateway</code> (Istio or Gateway API) objects in the shoot cluster it must be annotated with the DNS class <code>garden</code> and an annotation denoting the desired DNS names.</p><p>Example for an annotated Ingress resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    <span style=color:green># Let Gardener manage external DNS records for this Ingress.</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: special.example.com <span style=color:green># Use &#34;*&#34; to collects domains names from .spec.rules[].host</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;600&#34;</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>    <span style=color:green># If you are delegating the certificate management to Gardener, uncomment the following line</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/purpose: managed</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  - host: special.example.com
</span></span><span style=display:flex><span>    http:
</span></span><span style=display:flex><span>      paths:
</span></span><span style=display:flex><span>      - pathType: Prefix
</span></span><span style=display:flex><span>        path: <span style=color:#a31515>&#34;/&#34;</span>
</span></span><span style=display:flex><span>        backend:
</span></span><span style=display:flex><span>          service:
</span></span><span style=display:flex><span>            name: amazing-svc
</span></span><span style=display:flex><span>            port:
</span></span><span style=display:flex><span>              number: 8080
</span></span><span style=display:flex><span>  <span style=color:green># Uncomment the following part if you are delegating the certificate management to Gardener</span>
</span></span><span style=display:flex><span>  <span style=color:green>#tls:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#  - hosts:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#      - special.example.com</span>
</span></span><span style=display:flex><span>  <span style=color:green>#    secretName: my-cert-secret-name</span>
</span></span></code></pre></div><p>For an Ingress, the DNS names are already declared in the specification. Nevertheless the <em>dnsnames</em> annotation must be present. Here a subset of the DNS names of the ingress can be specified. If DNS names for all names are desired, the value <code>all</code> can be used.</p><p>Keep in mind that ingress resources are ignored unless an ingress controller is set up. Gardener does not provide an ingress controller by default. For more details, see <a href=https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/>Ingress Controllers</a> and <a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a> in the Kubernetes documentation.</p><h3 id=request-dns-records-for-service-type-loadbalancer>Request DNS records for service type LoadBalancer<a class=td-heading-self-link href=#request-dns-records-for-service-type-loadbalancer aria-label="Heading self-link"></a></h3><p>Example for an annotated Service (it must have the type <code>LoadBalancer</code>) resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-svc
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    <span style=color:green># Let Gardener manage external DNS records for this Service.</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: special.example.com
</span></span><span style=display:flex><span>    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;600&#34;</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    app: amazing-app
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>    - protocol: TCP
</span></span><span style=display:flex><span>      port: 80
</span></span><span style=display:flex><span>      targetPort: 8080
</span></span><span style=display:flex><span>  type: LoadBalancer
</span></span></code></pre></div><h3 id=request-dns-records-for-gateway-resources>Request DNS records for Gateway resources<a class=td-heading-self-link href=#request-dns-records-for-gateway-resources aria-label="Heading self-link"></a></h3><p>Please see <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/tutorials/istio-gateways/>Istio Gateways</a> or <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/tutorials/gateway-api-gateways/>Gateway API</a> for details.</p><h3 id=creating-a-dnsentry-resource-explicitly>Creating a DNSEntry resource explicitly<a class=td-heading-self-link href=#creating-a-dnsentry-resource-explicitly aria-label="Heading self-link"></a></h3><p>It is also possible to create a DNS entry via the Kubernetes resource called <code>DNSEntry</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: dns.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: DNSEntry
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    <span style=color:green># Let Gardener manage this DNS entry.</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>  name: special-dnsentry
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  dnsName: special.example.com
</span></span><span style=display:flex><span>  ttl: 600
</span></span><span style=display:flex><span>  targets:
</span></span><span style=display:flex><span>  - 1.2.3.4
</span></span></code></pre></div><p>If one of the accepted DNS names is a direct subname of the shoot&rsquo;s ingress domain, this is already handled by the standard wildcard entry for the ingress domain. Therefore this name should be excluded from the <em>dnsnames</em> list in the annotation. If only this DNS name is configured in the ingress, no explicit DNS entry is required, and the DNS annotations should be omitted at all.</p><p>You can check the status of the <code>DNSEntry</code> with</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get dnsentry
</span></span><span style=display:flex><span>NAME          DNS                                                            TYPE          PROVIDER      STATUS    AGE
</span></span><span style=display:flex><span>mydnsentry    special.example.com     aws-route53   default/aws   Ready     24s
</span></span></code></pre></div><p>As soon as the status of the entry is <code>Ready</code>, the provider has accepted the new DNS record. Depending on the provider and your DNS settings and cache, <strong>it may take up to 24 hours for the new entry to be propagated over all internet</strong>.</p><p>More examples can be found <a href=https://github.com/gardener/external-dns-management/blob/master/examples/>here</a></p><h3 id=request-dns-records-for-serviceingress-resources-using-a-dnsannotation-resource>Request DNS records for Service/Ingress resources using a DNSAnnotation resource<a class=td-heading-self-link href=#request-dns-records-for-serviceingress-resources-using-a-dnsannotation-resource aria-label="Heading self-link"></a></h3><p>In rare cases it may not be possible to add annotations to a <code>Service</code> or <code>Ingress</code> resource object.</p><p>E.g.: the helm chart used to deploy the resource may not be adaptable for some reasons or some automation is used, which always restores the original content of the resource object by dropping any additional annotations.</p><p>In these cases, it is recommended to use an additional <code>DNSAnnotation</code> resource in order to have more flexibility that <code>DNSentry resources</code>. The <code>DNSAnnotation</code> resource makes the DNS shoot service behave as if annotations have been added to the referenced resource.</p><p>For the Ingress example shown above, you can create a <code>DNSAnnotation</code> resource alternatively to provide the annotations.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: dns.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: DNSAnnotation
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>  name: test-ingress-annotation
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resourceRef:
</span></span><span style=display:flex><span>    kind: Ingress
</span></span><span style=display:flex><span>    apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>    name: test-ingress
</span></span><span style=display:flex><span>    namespace: default
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: <span style=color:#a31515>&#39;*&#39;</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden    
</span></span></code></pre></div><p>Note that the DNSAnnotation resource itself needs the <code>dns.gardener.cloud/class=garden</code> annotation. This also only works for annotations known to the DNS shoot service (see <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_names/#accepted-external-dns-records-annotations>Accepted External DNS Records Annotations</a>).</p><p>For more details, see also <a href=https://github.com/gardener/external-dns-management#dnsannotation-objects>DNSAnnotation objects</a></p><h3 id=accepted-external-dns-records-annotations>Accepted External DNS Records Annotations<a class=td-heading-self-link href=#accepted-external-dns-records-annotations aria-label="Heading self-link"></a></h3><p>Here are all of the accepted annotation related to the DNS extension:</p><table><thead><tr><th>Annotation</th><th>Description</th></tr></thead><tbody><tr><td>dns.gardener.cloud/dnsnames</td><td>Mandatory for service and ingress resources, accepts a comma-separated list of DNS names if multiple names are required. For ingress you can use the special value <code>'*'</code>. In this case, the DNS names are collected from <code>.spec.rules[].host</code>.</td></tr><tr><td>dns.gardener.cloud/class</td><td>Mandatory, in the context of the shoot-dns-service it must always be set to <code>garden</code>.</td></tr><tr><td>dns.gardener.cloud/ttl</td><td>Recommended, overrides the default Time-To-Live of the DNS record.</td></tr><tr><td>dns.gardener.cloud/cname-lookup-interval</td><td>Only relevant if multiple domain name targets are specified. It specifies the lookup interval for CNAMEs to map them to IP addresses (in seconds)</td></tr><tr><td>dns.gardener.cloud/realms</td><td>Internal, for restricting provider access for shoot DNS entries. Typcially not set by users of the shoot-dns-service.</td></tr><tr><td>dns.gardener.cloud/ip-stack</td><td>Only relevant for provider type <code>aws-route53</code> if target is an AWS load balancer domain name. Can be set for service, ingress and DNSEntry resources. It specify which DNS records with alias targets are created instead of the usual <code>CNAME</code> records. If the annotation is not set (or has the value <code>ipv4</code>), only an <code>A</code> record is created. With value <code>dual-stack</code>, both <code>A</code> and <code>AAAA</code> records are created. With value <code>ipv6</code> only an <code>AAAA</code> record is created.</td></tr><tr><td>service.beta.kubernetes.io/aws-load-balancer-ip-address-type=dualstack</td><td>For services, behaves similar to <code>dns.gardener.cloud/ip-stack=dual-stack</code>.</td></tr><tr><td>loadbalancer.openstack.org/load-balancer-address</td><td>Internal, for services only: support for PROXY protocol on Openstack (which needs a hostname as ingress). Typcially not set by users of the shoot-dns-service.</td></tr></tbody></table><p>If one of the accepted DNS names is a direct subdomain of the shoot&rsquo;s ingress domain, this is already handled by the standard wildcard entry for the ingress domain. Therefore, this name should be excluded from the <em>dnsnames</em> list in the annotation. If only this DNS name is configured in the ingress, no explicit DNS entry is required, and the DNS annotations should be omitted at all.</p><h2 id=troubleshooting>Troubleshooting<a class=td-heading-self-link href=#troubleshooting aria-label="Heading self-link"></a></h2><h3 id=general-dns-tools>General DNS tools<a class=td-heading-self-link href=#general-dns-tools aria-label="Heading self-link"></a></h3><p>To check the DNS resolution, use the <code>nslookup</code> or <code>dig</code> command.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nslookup special.your-domain.com
</span></span></code></pre></div><p>or with dig</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ dig +short special.example.com
</span></span><span style=display:flex><span>Depending on your network settings, you may get a successful response faster using a public DNS server (e.g. 8.8.8.8, 8.8.4.4, or 1.1.1.1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dig @8.8.8.8 +short special.example.com
</span></span></code></pre></div><h3 id=dns-record-events>DNS record events<a class=td-heading-self-link href=#dns-record-events aria-label="Heading self-link"></a></h3><p>The DNS controller publishes Kubernetes events for the resource which requested the DNS record (Ingress, Service, DNSEntry). These events reveal more information about the DNS requests being processed and are especially useful to check any kind of misconfiguration, e.g. requests for a domain you don&rsquo;t own.</p><p>Events for a successfully created DNS record:</p><pre tabindex=0><code>$ kubectl describe service my-service

Events:
  Type    Reason          Age                From                    Message
  ----    ------          ----               ----                    -------
  Normal  dns-annotation  19s                dns-controller-manager  special.example.com: dns entry is pending
  Normal  dns-annotation  19s (x3 over 19s)  dns-controller-manager  special.example.com: dns entry pending: waiting for dns reconciliation
  Normal  dns-annotation  9s (x3 over 10s)   dns-controller-manager  special.example.com: dns entry active
</code></pre><p>Please note, events vanish after their retention period (usually <code>1h</code>).</p><h3 id=dnsentry-status>DNSEntry status<a class=td-heading-self-link href=#dnsentry-status aria-label="Heading self-link"></a></h3><p><code>DNSEntry</code> resources offer a <code>.status</code> sub-resource which can be used to check the current state of the object.</p><p>Status of a erroneous <code>DNSEntry</code>.</p><pre tabindex=0><code>  status:
    message: No responsible provider found
    observedGeneration: 3
    provider: remote
    state: Error
</code></pre><h2 id=references>References<a class=td-heading-self-link href=#references aria-label="Heading self-link"></a></h2><ul><li><a href=https://www.cloudflare.com/en-ca/learning/dns/what-is-dns>Understanding DNS</a></li><li><a href=https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/>Kubernetes Internal DNS</a></li><li><a href=https://github.com/gardener/external-dns-management/blob/master/pkg/apis/dns/v1alpha1/dnsentry.go>DNSEntry API (Golang)</a></li><li><a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/>Managing Certificates with Gardener</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ecf32a50f50533e421c6d743abdd9ee2>2.4 - DNS Providers</h1><h1 id=dns-providers>DNS Providers<a class=td-heading-self-link href=#dns-providers aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener can manage DNS records on your behalf, so that you can request them via different resource types (see <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_names/>here</a>) within the shoot cluster. The domains for which you are permitted to request records, are however restricted and depend on the DNS provider configuration.</p><h2 id=shoot-provider>Shoot provider<a class=td-heading-self-link href=#shoot-provider aria-label="Heading self-link"></a></h2><p>By default, every shoot cluster is equipped with a default provider. It is the very same provider that manages the shoot cluster&rsquo;s <code>kube-apiserver</code> public DNS record (DNS address in your Kubeconfig).</p><pre tabindex=0><code>kind: Shoot
...
dns:
  domain: shoot.project.default-domain.gardener.cloud
</code></pre><p>You are permitted to request any sub-domain of <code>.dns.domain</code> that is not already taken (e.g. <code>api.shoot.project.default-domain.gardener.cloud</code>, <code>*.ingress.shoot.project.default-domain.gardener.cloud</code>) with this provider.</p><h2 id=additional-providers>Additional providers<a class=td-heading-self-link href=#additional-providers aria-label="Heading self-link"></a></h2><p>If you need to request DNS records for domains not managed by the <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_providers/#Shoot-provider>default provider</a>, additional providers can
be configured in the shoot specification.
Alternatively, if it is enabled, it can be added as <code>DNSProvider</code> resources to the shoot cluster.</p><h3 id=additional-providers-in-the-shoot-specification>Additional providers in the shoot specification<a class=td-heading-self-link href=#additional-providers-in-the-shoot-specification aria-label="Heading self-link"></a></h3><p>To add a providers in the shoot spec, you need set them in the <code>spec.dns.providers</code> list.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  dns:
</span></span><span style=display:flex><span>    domain: shoot.project.default-domain.gardener.cloud
</span></span><span style=display:flex><span>    providers:
</span></span><span style=display:flex><span>    - secretName: my-aws-account
</span></span><span style=display:flex><span>      type: aws-route53
</span></span><span style=display:flex><span>    - secretName: my-gcp-account
</span></span><span style=display:flex><span>      type: google-clouddns
</span></span></code></pre></div><blockquote><p>Please consult the <a href=https://gardener.cloud/docs/gardener/api-reference/core/#core.gardener.cloud/v1beta1.DNSProvider>API-Reference</a> to get a complete list of supported fields and configuration options.</p></blockquote><p>Referenced secrets should exist in the project namespace in the Garden cluster and must comply with the provider specific credentials format. The <strong>External-DNS-Management</strong> project provides corresponding examples (<a href=https://github.com/gardener/external-dns-management/tree/master/examples>20-secret-&lt;provider-name>-credentials.yaml</a>) for known providers.</p><h3 id=additional-providers-as-resources-in-the-shoot-cluster>Additional providers as resources in the shoot cluster<a class=td-heading-self-link href=#additional-providers-as-resources-in-the-shoot-cluster aria-label="Heading self-link"></a></h3><p>If it is not enabled globally, you have to enable the feature in the shoot manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>Kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-dns-service
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        apiVersion: service.dns.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>        kind: DNSConfig
</span></span><span style=display:flex><span>        dnsProviderReplication:
</span></span><span style=display:flex><span>          enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>To add a provider directly in the shoot cluster, provide a <code>DNSProvider</code> in any namespace together
with <code>Secret</code> containing the credentials.</p><p>For example if the domain is hosted with AWS Route 53 (provider type <code>aws-route53</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: dns.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: DNSProvider
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>  name: my-own-domain
</span></span><span style=display:flex><span>  namespace: my-namespace
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: aws-route53
</span></span><span style=display:flex><span>  secretRef:
</span></span><span style=display:flex><span>    name: my-own-domain-credentials
</span></span><span style=display:flex><span>  domains:
</span></span><span style=display:flex><span>    include:
</span></span><span style=display:flex><span>    - my.own.domain.com
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-own-domain-credentials
</span></span><span style=display:flex><span>  namespace: my-namespace
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  <span style=color:green># replace &#39;...&#39; with values encoded as base64</span>
</span></span><span style=display:flex><span>  AWS_ACCESS_KEY_ID: ...
</span></span><span style=display:flex><span>  AWS_SECRET_ACCESS_KEY: ...
</span></span></code></pre></div><p>The <strong>External-DNS-Management</strong> project provides examples with more details for <code>DNSProviders</code> (30-provider-&lt;provider-name>.yaml)
and credential <code>Secrets</code> (20-secret-&lt;provider-name>.yaml) at <a href=https://github.com/gardener/external-dns-management/tree/master/examples>https://github.com/gardener/external-dns-management//examples</a>
for all supported provider types.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ea762d41ff072075554bb0c27bbc83d5>2.5 - Gateway Api Gateways</h1><h1 id=using-annotated-gateway-api-gateway-andor-httproutes-as-source>Using annotated Gateway API Gateway and/or HTTPRoutes as Source<a class=td-heading-self-link href=#using-annotated-gateway-api-gateway-andor-httproutes-as-source aria-label="Heading self-link"></a></h1><p>This tutorial describes how to use annotated Gateway API resources as source for DNSEntries with the Gardener shoot-dns-service extension.</p><p>The dns-controller-manager supports the resources <code>Gateway</code> and <code>HTTPRoute</code>.</p><h2 id=install-istio-on-your-cluster>Install Istio on your cluster<a class=td-heading-self-link href=#install-istio-on-your-cluster aria-label="Heading self-link"></a></h2><p>Using a new or existing shoot cluster, follow the Istio <a href=https://istio.io/latest/docs/tasks/traffic-management/ingress/gateway-api/>Kubernetes Gateway API</a> to
install the Gateway API and to install Istio.</p><p>These are the typical commands for the Istio installation with the Kubernetes Gateway API:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export KUEBCONFIG=...
</span></span><span style=display:flex><span>curl -L https://istio.io/downloadIstio | sh -
</span></span><span style=display:flex><span>kubectl get crd gateways.gateway.networking.k8s.io &amp;&gt; /dev/null || <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  { kubectl kustomize <span style=color:#a31515>&#34;github.com/kubernetes-sigs/gateway-api/config/crd?ref=v1.0.0&#34;</span> | kubectl apply -f -; }
</span></span><span style=display:flex><span>istioctl install --set profile=minimal -y
</span></span><span style=display:flex><span>kubectl label namespace default istio-injection=enabled
</span></span></code></pre></div><h2 id=verify-that-gateway-source-works>Verify that Gateway Source works<a class=td-heading-self-link href=#verify-that-gateway-source-works aria-label="Heading self-link"></a></h2><h3 id=install-a-sample-service>Install a sample service<a class=td-heading-self-link href=#install-a-sample-service aria-label="Heading self-link"></a></h3><p>With automatic sidecar injection:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/httpbin/httpbin.yaml
</span></span></code></pre></div><h3 id=using-a-gateway-as-a-source>Using a Gateway as a source<a class=td-heading-self-link href=#using-a-gateway-as-a-source aria-label="Heading self-link"></a></h3><p>Deploy the Gateway API configuration including a single exposed route (i.e., /get):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace istio-ingress
</span></span><span style=display:flex><span>kubectl apply -f - <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/dnsnames: &#34;*.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/class: garden
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gatewayClassName: istio
</span></span></span><span style=display:flex><span><span style=color:#a31515>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hostname: &#34;*.example.com&#34;  # this is used by dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>    port: 80
</span></span></span><span style=display:flex><span><span style=color:#a31515>    protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#a31515>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      namespaces:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        from: All
</span></span></span><span style=display:flex><span><span style=color:#a31515>---
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>    namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hostnames: [&#34;httpbin.example.com&#34;]  # this is used by dns-controller-manager to extract DNS names too
</span></span></span><span style=display:flex><span><span style=color:#a31515>  rules:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - path:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#a31515>        value: /get
</span></span></span><span style=display:flex><span><span style=color:#a31515>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>      port: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>You should now see events in the namespace of the gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system get events --sort-by={.metadata.creationTimestamp}
</span></span><span style=display:flex><span>LAST SEEN   TYPE      REASON                 OBJECT                                       MESSAGE
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         service/gateway-istio                      httpbin.example.com: created dns entry object shoot--foo--bar/gateway-istio-service-zpf8n
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         service/gateway-istio                      httpbin.example.com: dns entry pending: waiting <span style=color:#00f>for</span> dns reconciliation
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         service/gateway-istio                      httpbin.example.com: dns entry is pending
</span></span><span style=display:flex><span>36s         Normal    dns-annotation         service/gateway-istio                      httpbin.example.com: dns entry active
</span></span></code></pre></div><h4 id=using-a-httproute-as-a-source>Using a HTTPRoute as a source<a class=td-heading-self-link href=#using-a-httproute-as-a-source aria-label="Heading self-link"></a></h4><p>If the <code>Gateway</code> resource is annotated with <code>dns.gardener.cloud/dnsnames: "*"</code>, hostnames from all referencing <code>HTTPRoute</code> resources
are automatically extracted. These resources don&rsquo;t need an additional annotation.</p><p>Deploy the Gateway API configuration including a single exposed route (i.e., /get):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace istio-ingress
</span></span><span style=display:flex><span>kubectl apply -f - <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/dnsnames: &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/class: garden
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gatewayClassName: istio
</span></span></span><span style=display:flex><span><span style=color:#a31515>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hostname: null  # not set 
</span></span></span><span style=display:flex><span><span style=color:#a31515>    port: 80
</span></span></span><span style=display:flex><span><span style=color:#a31515>    protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#a31515>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      namespaces:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        from: All
</span></span></span><span style=display:flex><span><span style=color:#a31515>---
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>    namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hostnames: [&#34;httpbin.example.com&#34;]  # this is used by dns-controller-manager to extract DNS names too
</span></span></span><span style=display:flex><span><span style=color:#a31515>  rules:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - path:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#a31515>        value: /get
</span></span></span><span style=display:flex><span><span style=color:#a31515>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>      port: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>This should show a similar events as above.</p><h4 id=access-the-sample-service-using-curl>Access the sample service using <code>curl</code><a class=td-heading-self-link href=#access-the-sample-service-using-curl aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I http://httpbin.example.com/get
</span></span><span style=display:flex><span>HTTP/1.1 200 OK
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>date: Tue, 13 Feb 2024 08:09:41 GMT
</span></span><span style=display:flex><span>content-type: application/json
</span></span><span style=display:flex><span>content-length: 701
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>access-control-allow-credentials: true
</span></span><span style=display:flex><span>x-envoy-upstream-service-time: 19
</span></span></code></pre></div><p>Accessing any other URL that has not been explicitly exposed should return an HTTP 404 error:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I http://httpbin.example.com/headers
</span></span><span style=display:flex><span>HTTP/1.1 404 Not Found
</span></span><span style=display:flex><span>date: Tue, 13 Feb 2024 08:09:41 GMT
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>transfer-encoding: chunked
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-003ade58dc4b08afb6f7278172caaaf8>2.6 - Istio Gateways</h1><h1 id=using-annotated-istio-gateway-andor-istio-virtual-service-as-source>Using annotated Istio Gateway and/or Istio Virtual Service as Source<a class=td-heading-self-link href=#using-annotated-istio-gateway-andor-istio-virtual-service-as-source aria-label="Heading self-link"></a></h1><p>This tutorial describes how to use annotated Istio Gateway resources as source for DNSEntries with the Gardener shoot-dns-service extension.</p><h2 id=install-istio-on-your-cluster>Install Istio on your cluster<a class=td-heading-self-link href=#install-istio-on-your-cluster aria-label="Heading self-link"></a></h2><p>Using a new or existing shoot cluster, follow the <a href=https://istio.io/latest/docs/setup/getting-started/>Istio Getting Started</a> to download and install Istio.</p><p>These are the typical commands for the istio demo installation</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export KUEBCONFIG=...
</span></span><span style=display:flex><span>curl -L https://istio.io/downloadIstio | sh -
</span></span><span style=display:flex><span>istioctl install --set profile=demo -y
</span></span><span style=display:flex><span>kubectl label namespace default istio-injection=enabled
</span></span></code></pre></div><h2 id=verify-that-istio-gatewayvirtualservice-source-works>Verify that Istio Gateway/VirtualService Source works<a class=td-heading-self-link href=#verify-that-istio-gatewayvirtualservice-source-works aria-label="Heading self-link"></a></h2><h3 id=install-a-sample-service>Install a sample service<a class=td-heading-self-link href=#install-a-sample-service aria-label="Heading self-link"></a></h3><p>With automatic sidecar injection:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/httpbin/httpbin.yaml
</span></span></code></pre></div><h3 id=using-a-gateway-as-a-source>Using a Gateway as a source<a class=td-heading-self-link href=#using-a-gateway-as-a-source aria-label="Heading self-link"></a></h3><h4 id=create-an-istio-gateway>Create an Istio Gateway:<a class=td-heading-self-link href=#create-an-istio-gateway aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-system
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/dnsnames: &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/class: garden
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  selector:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    istio: ingressgateway # use Istio default gateway implementation
</span></span></span><span style=display:flex><span><span style=color:#a31515>  servers:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      number: 80
</span></span></span><span style=display:flex><span><span style=color:#a31515>      name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - &#34;httpbin.example.com&#34; # this is used by the dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><h4 id=configure-routes-for-traffic-entering-via-the-gateway>Configure routes for traffic entering via the Gateway:<a class=td-heading-self-link href=#configure-routes-for-traffic-entering-via-the-gateway aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: VirtualService
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - &#34;httpbin.example.com&#34; # this is also used by the dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gateways:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - istio-system/httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  http:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - match:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /status
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /delay
</span></span></span><span style=display:flex><span><span style=color:#a31515>    route:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - destination:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>          number: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>        host: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>You should now see events in the namespace of the gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system get events --sort-by={.metadata.creationTimestamp}
</span></span><span style=display:flex><span>LAST SEEN   TYPE      REASON                 OBJECT                                       MESSAGE
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         gateway/httpbin-gateway                      httpbin.example.com: created dns entry object shoot--foo--bar/httpbin-gateway-gateway-zpf8n
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         gateway/httpbin-gateway                      httpbin.example.com: dns entry pending: waiting <span style=color:#00f>for</span> dns reconciliation
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         gateway/httpbin-gateway                      httpbin.example.com: dns entry is pending
</span></span><span style=display:flex><span>36s         Normal    dns-annotation         gateway/httpbin-gateway                      httpbin.example.com: dns entry active
</span></span></code></pre></div><h3 id=using-a-virtualservice-as-a-source>Using a VirtualService as a source<a class=td-heading-self-link href=#using-a-virtualservice-as-a-source aria-label="Heading self-link"></a></h3><p>If the <code>Gateway</code> resource is annotated with <code>dns.gardener.cloud/dnsnames: "*"</code>, hosts from all referencing <code>VirtualServices</code> resources
are automatically extracted. These resources don&rsquo;t need an additional annotation.</p><h4 id=create-an-istio-gateway-1>Create an Istio Gateway:<a class=td-heading-self-link href=#create-an-istio-gateway-1 aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-system
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/dnsnames: &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/class: garden
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  selector:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    istio: ingressgateway # use Istio default gateway implementation
</span></span></span><span style=display:flex><span><span style=color:#a31515>  servers:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      number: 80
</span></span></span><span style=display:flex><span><span style=color:#a31515>      name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><h4 id=configure-routes-for-traffic-entering-via-the-gateway-1>Configure routes for traffic entering via the Gateway:<a class=td-heading-self-link href=#configure-routes-for-traffic-entering-via-the-gateway-1 aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: VirtualService
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default  
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - &#34;httpbin.example.com&#34; # this is used by dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gateways:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - istio-system/httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  http:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - match:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /status
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /delay
</span></span></span><span style=display:flex><span><span style=color:#a31515>    route:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - destination:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>          number: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>        host: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>This should show a similar events as above.</p><p>To get the targets to the extracted DNS names, the shoot-dns-service controller is able to gather information from the kubernetes service of the Istio Ingress Gateway.</p><p><strong>Note</strong>: It is also possible to set the targets my specifying an Ingress resource using the <code>dns.gardener.cloud/ingress</code> annotation on the Istio Ingress Gateway resource.</p><p><strong>Note</strong>: It is also possible to set the targets manually by using the <code>dns.gardener.cloud/targets</code> annotation on the Istio Ingress Gateway resource.</p><h3 id=access-the-sample-service-using-curl>Access the sample service using <code>curl</code><a class=td-heading-self-link href=#access-the-sample-service-using-curl aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I http://httpbin.example.com/status/200
</span></span><span style=display:flex><span>HTTP/1.1 200 OK
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>date: Tue, 13 Feb 2024 07:49:37 GMT
</span></span><span style=display:flex><span>content-type: text/html; charset=utf-8
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>access-control-allow-credentials: true
</span></span><span style=display:flex><span>content-length: 0
</span></span><span style=display:flex><span>x-envoy-upstream-service-time: 15
</span></span></code></pre></div><p>Accessing any other URL that has not been explicitly exposed should return an HTTP 404 error:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I http://httpbin.example.com/headers
</span></span><span style=display:flex><span>HTTP/1.1 404 Not Found
</span></span><span style=display:flex><span>date: Tue, 13 Feb 2024 08:09:41 GMT
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>transfer-encoding: chunked
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-26c3d61f82c9dd9b0643835430f275f6>3 - Egress filtering</h1><div class=lead>Gardener extension controller for egress filtering for shoot clusters</div><h1 id=gardener-extension-for-networking-filterhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Networking Filter</a><a class=td-heading-self-link href=#gardener-extension-for-networking-filterhttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-networking-filter><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-networking-filter alt="REUSE status"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the <code>shoot-networking-filter</code> extension.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-shoot-networking-filter/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=extension-resources>Extension Resources<a class=td-heading-self-link href=#extension-resources aria-label="Heading self-link"></a></h2><p>Example extension resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Extension
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-networking-filter
</span></span><span style=display:flex><span>  namespace: shoot--project--abc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    egressFilter:
</span></span><span style=display:flex><span>      blackholingEnabled: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>      staticFilterList:
</span></span><span style=display:flex><span>      - network: 1.2.3.4/31
</span></span><span style=display:flex><span>        policy: BLOCK_ACCESS
</span></span><span style=display:flex><span>      workers:
</span></span><span style=display:flex><span>        blackholingEnabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        names:
</span></span><span style=display:flex><span>        - external-api
</span></span></code></pre></div><p>When an extension resource is reconciled, if the optional <code>workers</code> field is not used, the extension controller will create a daemonset <code>egress-filter-applier</code> on the shoot containing a <a href=https://github.com/gardener/egress-filter-refresher/blob/master/Dockerfile>Dockerfile</a> container.</p><p>If the optional <code>workers</code> field is used, the extension controller will create one daemonset <code>egress-filter-applier-&lt;worker name></code> per <strong>each worker group</strong> on the shoot.</p><p>See the <a href=/docs/extensions/others/gardener-extension-shoot-networking-filter/shoot-networking-filter/>usage documentation</a> for more details on how to configure the extension on a shoot cluster.</p><p>Please note, this extension controller relies on the <a href=/docs/gardener/concepts/resource-manager/>Gardener-Resource-Manager</a> to deploy k8s resources to seed and shoot clusters.</p><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>.</p><p>We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-networking-filter/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-0d6e87b50dd76f1d75b01b3bb7cc698f>3.1 - Deployment</h1><h1 id=gardener-networking-policy-filter-for-shoots>Gardener Networking Policy Filter for Shoots<a class=td-heading-self-link href=#gardener-networking-policy-filter-for-shoots aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener allows shoot clusters to filter egress traffic on node level. To support this the Gardener must be installed with the <code>shoot-networking-filter</code> extension.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>To generally enable the networking filter for shoot objects the <code>shoot-networking-filter</code> extension must be registered by providing an appropriate <a href=https://github.com/gardener/gardener-extension-shoot-networking-filter/blob/master/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots the <code>globallyEnabled</code> flag should be set to <code>true</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerRegistration
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - kind: Extension
</span></span><span style=display:flex><span>      type: shoot-networking-filter
</span></span><span style=display:flex><span>      globallyEnabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=controllerregistration>ControllerRegistration<a class=td-heading-self-link href=#controllerregistration aria-label="Heading self-link"></a></h3><p>An example of a <code>ControllerRegistration</code> for the <code>shoot-networking-filter</code> can be found at <a href=https://github.com/gardener/gardener-extension-shoot-networking-filter/blob/master/example/controller-registration.yaml>controller-registration.yaml</a>.</p><p>The <code>ControllerRegistration</code> contains a Helm chart which eventually deploys the <code>shoot-networking-filter</code> to seed clusters. It offers some configuration options, mainly to set up a static filter list or provide the configuration for downloading the filter list from a service endpoint.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerDeployment
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  values:
</span></span><span style=display:flex><span>    egressFilter:
</span></span><span style=display:flex><span>      blackholingEnabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      filterListProviderType: static
</span></span><span style=display:flex><span>      staticFilterList:
</span></span><span style=display:flex><span>        - network: 1.2.3.4/31
</span></span><span style=display:flex><span>          policy: BLOCK_ACCESS
</span></span><span style=display:flex><span>        - network: 5.6.7.8/32
</span></span><span style=display:flex><span>          policy: BLOCK_ACCESS
</span></span><span style=display:flex><span>        - network: ::2/128
</span></span><span style=display:flex><span>          policy: BLOCK_ACCESS
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:green>#filterListProviderType: download</span>
</span></span><span style=display:flex><span>      <span style=color:green>#downloaderConfig:</span>
</span></span><span style=display:flex><span>      <span style=color:green>#  endpoint: https://my.filter.list.server/lists/policy</span>
</span></span><span style=display:flex><span>      <span style=color:green>#  oauth2Endpoint: https://my.auth.server/oauth2/token</span>
</span></span><span style=display:flex><span>      <span style=color:green>#  refreshPeriod: 1h</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:green>## if the downloader needs an OAuth2 access token, client credentials can be provided with oauth2Secret</span>
</span></span><span style=display:flex><span>      <span style=color:green>#oauth2Secret:</span>
</span></span><span style=display:flex><span>      <span style=color:green># clientID: 1-2-3-4</span>
</span></span><span style=display:flex><span>      <span style=color:green># clientSecret: secret!!</span>
</span></span><span style=display:flex><span>      <span style=color:green>## either clientSecret of client certificate is required</span>
</span></span><span style=display:flex><span>      <span style=color:green># client.crt.pem: |</span>
</span></span><span style=display:flex><span>      <span style=color:green>#   -----BEGIN CERTIFICATE-----</span>
</span></span><span style=display:flex><span>      <span style=color:green>#   ...</span>
</span></span><span style=display:flex><span>      <span style=color:green>#   -----END CERTIFICATE-----</span>
</span></span><span style=display:flex><span>      <span style=color:green># client.key.pem: |</span>
</span></span><span style=display:flex><span>      <span style=color:green>#   -----BEGIN PRIVATE KEY-----</span>
</span></span><span style=display:flex><span>      <span style=color:green>#   ...</span>
</span></span><span style=display:flex><span>      <span style=color:green>#   -----END PRIVATE KEY-----</span>
</span></span></code></pre></div><h3 id=enablement-for-a-shoot>Enablement for a Shoot<a class=td-heading-self-link href=#enablement-for-a-shoot aria-label="Heading self-link"></a></h3><p>If the shoot networking filter is not globally enabled by default (depends on the extension registration on the garden cluster), it can be enabled per shoot. To enable the service for a shoot, the shoot manifest must explicitly add the <code>shoot-networking-filter</code> extension.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-filter
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>If the shoot networking filter is globally enabled by default, it can be disabled per shoot. To disable the service for a shoot, the shoot manifest must explicitly state it.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-filter
</span></span><span style=display:flex><span>      disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-51bc5860c666351f02b783c6f9331d81>3.2 - Shoot Networking Filter</h1><h1 id=register-shoot-networking-filter-extension-in-shoot-clusters>Register Shoot Networking Filter Extension in Shoot Clusters<a class=td-heading-self-link href=#register-shoot-networking-filter-extension-in-shoot-clusters aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Within a shoot cluster, it is possible to enable the networking filter. It is necessary that the Gardener installation your shoot cluster runs in is equipped with a <code>shoot-networking-filter</code> extension. Please ask your Gardener operator if the extension is available in your environment.</p><h2 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h2><p>In most of the Gardener setups the <code>shoot-networking-filter</code> extension is not enabled globally and thus must be configured per shoot cluster. Please adapt the shoot specification by the configuration shown below to activate the extension individually.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-filter
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=opt-out>Opt-out<a class=td-heading-self-link href=#opt-out aria-label="Heading self-link"></a></h2><p>If the shoot networking filter is globally enabled by default, it can be disabled per shoot. To disable the service for a shoot, the shoot manifest must explicitly state it.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-filter
</span></span><span style=display:flex><span>      disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=ingress-filtering>Ingress Filtering<a class=td-heading-self-link href=#ingress-filtering aria-label="Heading self-link"></a></h2><p>By default, the networking filter only filters egress traffic. However, if you enable blackholing, incoming traffic will also be blocked.
You can enable blackholing on a per-shoot basis.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-filter
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        egressFilter:
</span></span><span style=display:flex><span>          blackholingEnabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Ingress traffic can only be blocked by blackhole routing, if the source IP address is preserved. On Azure, GCP and AliCloud this works by default.
The default on AWS is a classic load balancer that replaces the source IP by it&rsquo;s own IP address. Here, a network load balancer has to be
configured adding the annotation <code>service.beta.kubernetes.io/aws-load-balancer-type: "nlb"</code> to the service.
On OpenStack, load balancers don&rsquo;t preserve the source address.</p><p>When you disable <code>blackholing</code> in an existing shoot, the associated blackhole routes will be removed automatically.
Conversely, when you re-enable <code>blackholing</code> again, the iptables-based filter rules will be removed and replaced by blackhole routes.</p><h2 id=ingress-filtering-per-worker-group>Ingress Filtering per Worker Group<a class=td-heading-self-link href=#ingress-filtering-per-worker-group aria-label="Heading self-link"></a></h2><p>You can optionally enable or disable ingress filtering for specified worker groups.
For example, you may want to disable blackholing in general but enable it for a worker group hosting an external API.
You can do so by using an optional <code>workers</code> field:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-filter
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        egressFilter:
</span></span><span style=display:flex><span>          blackholingEnabled: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>          workers:
</span></span><span style=display:flex><span>            blackholingEnabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>            names:
</span></span><span style=display:flex><span>              - external-api
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Please note that only blackholing can be changed per worker group. You may not define different IPs to block or
disable blocking altogether.</p><h2 id=custom-ip>Custom IP<a class=td-heading-self-link href=#custom-ip aria-label="Heading self-link"></a></h2><p>It is possible to add custom IP addresses to the network filter. This can be useful for testing purposes.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-filter
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        egressFilter:
</span></span><span style=display:flex><span>          staticFilterList:
</span></span><span style=display:flex><span>          - network: 1.2.3.4/31
</span></span><span style=display:flex><span>            policy: BLOCK_ACCESS
</span></span><span style=display:flex><span>          - network: 5.6.7.8/32
</span></span><span style=display:flex><span>            policy: BLOCK_ACCESS
</span></span><span style=display:flex><span>          - network: ::2/128
</span></span><span style=display:flex><span>            policy: BLOCK_ACCESS
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ccc7f4f683b2c7803e99873d2bc4a42a>4 - Lakom service</h1><div class=lead>A k8s admission controller verifying pods are using signed images (cosign signatures) and a gardener extension to install it for shoots and seeds.</div><h1 id=gardener-extension-for-lakom-serviceshttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for lakom services</a><a class=td-heading-self-link href=#gardener-extension-for-lakom-serviceshttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-lakom-service><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-lakom-service alt="REUSE status"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the <code>shoot-lakom-service</code> extension.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-shoot-lakom-service/blob/main/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=lakom-admission-controller>Lakom Admission Controller<a class=td-heading-self-link href=#lakom-admission-controller aria-label="Heading self-link"></a></h2><p>Lakom is kubernetes admission controller which purpose is to implement <a href=https://github.com/sigstore/cosign>cosign</a> image signature verification against public cosign key. It also takes care to resolve image tags to sha256 digests. It also caches all OCI artifacts to reduce the load toward the OCI registry.</p><h2 id=extension-resources>Extension Resources<a class=td-heading-self-link href=#extension-resources aria-label="Heading self-link"></a></h2><p>Example extension resource:</p><blockquote></blockquote><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Extension
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-lakom-service
</span></span><span style=display:flex><span>  namespace: shoot--project--abc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: shoot-lakom-service
</span></span></code></pre></div><p>When an extension resource is reconciled, the extension controller will create an instance of <code>lakom</code> admission controller. These resources are placed inside the shoot namespace on the seed. Also, the controller takes care about generating necessary <code>RBAC</code> resources for the seed as well as for the shoot.</p><p>Please note, this extension controller relies on the <a href=/docs/gardener/concepts/resource-manager/>Gardener-Resource-Manager</a> to deploy k8s resources to seed and shoot clusters.</p><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>The <code>Lakom</code> admission controller can be configured with <code>make dev-setup</code> and started with <code>make start-lakom</code>.
You can run the lakom extension controller locally on your machine by executing <code>make start</code>.</p><p>If you&rsquo;d like to develop Lakom using a local cluster such as KinD, make sure your KUBECONFIG environment variable is targeting the local Garden cluster.
Add <code>127.0.0.1 garden.local.gardener.cloud</code> to your <code>/etc/hosts</code>. You can then run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-up
</span></span></code></pre></div><p>This will trigger a skaffold deployment that builds the images, pushes them to the registry and installs the helm charts from <code>/charts</code>.</p><p>We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-lakom-service/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c0e9837a0c6f3e6821df938a89b541e1>4.1 - Deployment</h1><h1 id=gardener-lakom-service-for-shoots>Gardener Lakom Service for Shoots<a class=td-heading-self-link href=#gardener-lakom-service-for-shoots aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener allows Shoot clusters to use <code>Lakom</code> admission controller for cosign image signing verification. To support this the Gardener must be installed with the <code>shoot-lakom-service</code> extension.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>To generally enable the Lakom service for shoot objects the <code>shoot-lakom-service</code> extension must be registered by providing an appropriate <a href=https://github.com/gardener/gardener-extension-shoot-lakom-service/blob/main/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots the <code>globallyEnabled</code> flag should be set to <code>true</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - kind: Extension
</span></span><span style=display:flex><span>      type: shoot-lakom-service
</span></span><span style=display:flex><span>      globallyEnabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h3><p>If the shoot Lakom service is not globally enabled by default (depends on the extension registration on the garden cluster), it can be enabled per shoot. To enable the service for a shoot, the shoot manifest must explicitly add the <code>shoot-lakom-service</code> extension.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-lakom-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>If the shoot Lakom service is globally enabled by default, it can be disabled per shoot. To disable the service for a shoot, the shoot manifest must explicitly state it.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-lakom-service
</span></span><span style=display:flex><span>      disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-baad6af6b7a83fa2c3b395ecc1578177>4.2 - Lakom</h1><h1 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h1><p>Lakom is kubernetes admission controller which purpose is to implement
<a href=https://github.com/sigstore/cosign>cosign</a> image signature verification with
public cosign key. It also takes care to resolve image tags to sha256 digests. A
built-in cache mechanism can be enabled to reduce the load toward the OCI
registry.</p><h2 id=flags>Flags<a class=td-heading-self-link href=#flags aria-label="Heading self-link"></a></h2><p>Lakom admission controller is configurable via command line flags. The trusted
cosign public keys and the associated algorithms associated with them are set
viq configuration file provided with the flag <code>--lakom-config-path</code>.</p><table><thead><tr><th>Flag Name</th><th>Description</th><th>Default Value</th></tr></thead><tbody><tr><td><code>--bind-address</code></td><td>Address to bind to</td><td>&ldquo;0.0.0.0&rdquo;</td></tr><tr><td><code>--cache-refresh-interval</code></td><td>Refresh interval for the cached objects</td><td>30s</td></tr><tr><td><code>--cache-ttl</code></td><td>TTL for the cached objects. Set to 0, if cache has to be disabled</td><td>10m0s</td></tr><tr><td><code>--contention-profiling</code></td><td>Enable lock contention profiling, if profiling is enabled</td><td>false</td></tr><tr><td><code>--health-bind-address</code></td><td>Bind address for the health server</td><td>&ldquo;:8081&rdquo;</td></tr><tr><td><code>-h</code>, <code>--help</code></td><td>help for lakom</td><td></td></tr><tr><td><code>--insecure-allow-insecure-registries</code></td><td>If set, communication via HTTP with registries will be allowed.</td><td>false</td></tr><tr><td><code>--insecure-allow-untrusted-images</code></td><td>If set, the webhook will just return warning for the images without trusted signatures.</td><td>false</td></tr><tr><td><code>--kubeconfig</code></td><td>Paths to a kubeconfig. Only required if out-of-cluster.</td><td></td></tr><tr><td><code>--lakom-config-path</code></td><td>Path to file with lakom configuration containing cosign public keys used to verify the image signatures</td><td></td></tr><tr><td><code>--metrics-bind-address</code></td><td>Bind address for the metrics server</td><td>&ldquo;:8080&rdquo;</td></tr><tr><td><code>--port</code></td><td>Webhook server port</td><td>9443</td></tr><tr><td><code>--profiling</code></td><td>Enable profiling via web interface host:port/debug/pprof/</td><td>false</td></tr><tr><td><code>--tls-cert-dir</code></td><td>Directory with server TLS certificate and key (must contain a tls.crt and tls.key file</td><td></td></tr><tr><td><code>--use-only-image-pull-secrets</code></td><td>If set, only the credentials from the image pull secrets of the pod are used to access the OCI registry. Otherwise, the node identity and docker config are also used.</td><td>false</td></tr><tr><td><code>--version</code></td><td>prints version information and quits; &ndash;version=vX.Y.Z&mldr; sets the reported version</td><td></td></tr></tbody></table><h2 id=lakom-cosign-public-keys-configuration-file>Lakom Cosign Public Keys Configuration File<a class=td-heading-self-link href=#lakom-cosign-public-keys-configuration-file aria-label="Heading self-link"></a></h2><p>Lakom cosign public keys configuration file should be YAML or JSON formatted. It
can set multiple trusted keys, as each key must be given a name. The supported
types of public keys are <code>RSA</code>, <code>ECDSA</code> and <code>Ed25519</code>. The <code>RSA</code> keys can be
additionally configured with a signature verification algorithm specifying the
scheme and hash function used during signature verification. As of now <code>ECDSA</code>
and <code>Ed25519</code> keys cannot be configured with specific algorithm.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>publicKeys:
</span></span><span style=display:flex><span>- name: example-public-key
</span></span><span style=display:flex><span>  algorithm: RSASSA-PSS-SHA256
</span></span><span style=display:flex><span>  key: |-<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----BEGIN PUBLIC KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>    MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAPeQXbIWMMXYV+9+j9b4jXTflnpfwn4E
</span></span></span><span style=display:flex><span><span style=color:#a31515>    GMrmqYVhm0sclXb2FPP5aV/NFH6SZdHDZcT8LCNsNgxzxV4N+UE/JIsCAwEAAQ==
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----END PUBLIC KEY-----</span>    
</span></span></code></pre></div><p>Here:</p><ul><li><code>name</code> is logical human friendly name of the key.</li><li><code>algorithm</code> is the algorithm that has to be used to verify the signature, see <a href=/docs/extensions/others/gardener-extension-shoot-lakom-service/lakom/#supported-rsa-signature-verification-algorithms>Supported RSA Signature Verification Algorithms</a> for the list of supported algorithms.</li><li><code>key</code> is the cryptographic public key that will be used for image signature validation.</li></ul><h3 id=supported-rsa-signature-verification-algorithms>Supported RSA Signature Verification Algorithms<a class=td-heading-self-link href=#supported-rsa-signature-verification-algorithms aria-label="Heading self-link"></a></h3><ul><li><code>RSASSA-PKCS1-v1_5-SHA256</code>: uses <code>RSASSA-PKCS1-v1_5</code> scheme with <code>SHA256</code> hash func</li><li><code>RSASSA-PKCS1-v1_5-SHA384</code>: uses <code>RSASSA-PKCS1-v1_5</code> scheme with <code>SHA384</code> hash func</li><li><code>RSASSA-PKCS1-v1_5-SHA512</code>: uses <code>RSASSA-PKCS1-v1_5</code> scheme with <code>SHA512</code> hash func</li><li><code>RSASSA-PSS-SHA256</code>: uses <code>RSASSA-PSS</code> scheme with <code>SHA256</code> hash func</li><li><code>RSASSA-PSS-SHA384</code>: uses <code>RSASSA-PSS</code> scheme with <code>SHA384</code> hash func</li><li><code>RSASSA-PSS-SHA512</code>: uses <code>RSASSA-PSS</code> scheme with <code>SHA512</code> hash func</li></ul><h3 id=supported-resources-for-verification>Supported Resources for Verification<a class=td-heading-self-link href=#supported-resources-for-verification aria-label="Heading self-link"></a></h3><p>By default, Lakom validates only <code>Pod</code> resources in the clusters that it covers.
However, it also has the capabilities to validate the following Gardener specific resources:</p><ul><li><code>controllerdeployments.core.gardener.cloud/v1</code></li><li><code>gardenlets.seedmanagement.gardener.cloud/v1alpha1</code></li><li><code>extensions.operator.gardener.cloud/v1alpha1</code></li></ul><blockquote class="alert alert-important"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>message-outline</title><path d="M20 2H4C2.9 2 2 2.9 2 4V22l4-4H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2m0 14H5.2L4 17.2V4H20V16z"/></svg><p>Important</p></div><p>When deploying Lakom via the helm chart in <code>/charts/lakom</code>, the <code>admissionConfig.rules</code> key
can be fully customized to include any of the listed resources above.
Make sure that they are registered with the same group & versions as the ones listed above.
Any difference will cause Lakom to skip validation and approve the request,
making it a security risk.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-8acb7c19c8c9dff4f5cb1f6e453dc1dd>4.3 - Oci Registries</h1><h1 id=oci-registries>OCI Registries<a class=td-heading-self-link href=#oci-registries aria-label="Heading self-link"></a></h1><p>This document aims to introduce the reader to the general architecture of OCI
Registries, their history and jargon that might be encountered.</p><h2 id=history-of-container-registries>History of Container Registries<a class=td-heading-self-link href=#history-of-container-registries aria-label="Heading self-link"></a></h2><p>Most readers might be familiar with the container registry that was introduced
by Docker. It aims to provide a way for developers to store and distribute
container images that can be used for running applications in containers.</p><p>In the beginning, the registry was meant to only host images in a way that the
different layers of the image could be downloaded in parallel, while being
assembled on the client side.</p><p>In June 2015, multiple companies agreed to standardize the container image format,
including its distribution and runtime. This was the birth of the Open Container
Initiative (OCI).</p><h2 id=understanding-oci-registries>Understanding OCI Registries<a class=td-heading-self-link href=#understanding-oci-registries aria-label="Heading self-link"></a></h2><p>The most important document that pertains to OCI Registries in the case of Lakom is the <a href=https://github.com/opencontainers/distribution-spec/blob/main/spec.md>OCI
distribution spec</a>.
It outlines the way that artifacts shall be stored and fetched from a registry
that adheres to the OCI standard.</p><p>OCI Registries are meant to store <em>content</em>. While in the beginning the main
problem that they were trying to solve was image storage, during the evolution
of the image registry concept, a decision was made to make it more general
for storage of any form of objects, sometimes called <em>artifacts</em>.</p><p>An artifact is an abstract idea of multiple components that together describe
how an object is built along with storing metadata about the object.</p><p>To implement this, every OCI registry has to expose an API for creating
3 types of objects:</p><ul><li>Blobs</li><li>Manifests</li><li>Tags</li></ul><h3 id=blobs>Blobs<a class=td-heading-self-link href=#blobs aria-label="Heading self-link"></a></h3><p>A blob is just a set of bytes. Nothing more. The important part about blobs
is that they are <em>content addressable</em>. <a href=https://en.wikipedia.org/wiki/Content-addressable_storage>Content Addressable Storage (CAS)</a>
is a method of storing data in such a way that the address of the data is derived
from the data itself. This means that if you store the same blob twice, it will
be stored only once, and the address of the blob will be the same. This is achieved
by using the <a href=https://en.wikipedia.org/wiki/Cryptographic_hash_function>digest</a> of the blob as the address.</p><p>This is the actual mechanism for allowing images to be optimal in terms of storage.
Since most images begin by depending on the same base image, this means that
it can be stored only once and referenced by multiple images.</p><h3 id=manifests>Manifests<a class=td-heading-self-link href=#manifests aria-label="Heading self-link"></a></h3><p>A manifest is just a JSON document. It is stored separately from the blobs.
But similarly to the blobs, it is also content addressable. The manifest gets
formatted to a canonical form and then hashed. The hash becomes the address of
the manifest.</p><p>Where manifests become powerful is when they are used to reference to other
manifests or blobs. These references are called <a href=https://github.com/opencontainers/image-spec/blob/v1.0.1/descriptor.md>OCI Content Descriptors</a>.
For example, the Image Manifest that most readers would be familiar with contains
a list of layers that are used to build the image. Each layer is a reference to
a blob.</p><p>An additional reference outside the layer references is used for storing
additional configuration. More info can be found in the official <a href=https://github.com/opencontainers/image-spec/blob/v1.0.1/manifest.md>OCI Image Manifest spec</a>.</p><p>The term <em>artifact</em> is just a generalization over the Image Manifest idea.
The Image Manifest has a specific format that can be found in the aforementioned <a href=https://github.com/opencontainers/image-spec/blob/v1.0.1/manifest.md>OCI Image Manifest spec</a>.
The important field is the <code>.config.mediaType</code> field. Based on the official guidelines,
it can be used for defining types other than an image. More info can be found <a href=https://github.com/opencontainers/image-spec/blob/main/manifest.md#guidelines-for-artifact-usage>here</a>.</p><p>Combining all of these ideas, we can see that artifacts can be represented by 1
specific object - a manifest. That manifest, based on the media type in the config, can be
interpreted by different programs for their specific use case. Eg. a Helm chart.
Helm charts specifically have a mediaType of <code>application/vnd.cncf.helm.config.v1+json</code>.
Layers, too, have a media type. The media type of a layer when the artifact
is a helm chart is one of:</p><ul><li>application/vnd.cncf.helm.config.v1+json</li><li>application/vnd.cncf.helm.chart.content.v1.tar+gzip</li><li>application/vnd.cncf.helm.chart.provenance.v1.prov</li></ul><p>More info specifically on Helm charts as OCI Artifacts can be found here: <a href=https://helm.sh/blog/helm-oci-mediatypes/>Helm OCI MediaTypes</a>.</p><h3 id=tags>Tags<a class=td-heading-self-link href=#tags aria-label="Heading self-link"></a></h3><p>While manifests and blobs being content addressable is nice, it becomes hard
to address them in a human-readable format. Tags allow us to add a reference
to a given manifest that differs from the digest of the object.</p><p>Normally, whenever we push an image to a registry, if we don&rsquo;t give it an
explicit tag, the registry would most likely give it the tag <code>latest</code>. This,
actually is not mandatory based on the distribution spec. Manifests don&rsquo;t
require that they have a tag.</p><p>Multiple tags can point to the same manifest.</p><h3 id=cosign>Cosign<a class=td-heading-self-link href=#cosign aria-label="Heading self-link"></a></h3><p>Cosign is generally a part of the bigger project called <a href=https://sigstore.dev/>sigstore</a>.
Sigstore is an &ldquo;open-source project for improving software supply chain security&rdquo;.
It aims for developers to have a hassle-free way to sign their artifacts while
leveraging other components that add additional layers of security to the
signature process. Eg. Rekor and Fulcio.</p><p>Cosign is a CLI tool aiming to tie all the components of sigstore together.
In our specific case, we use it only as a format for creating signatures and
then verifying them. In theory, we wouldn&rsquo;t need to use Cosign for this, but
it uses a popular format for the signatures and the libraries help us
save work.</p><p>In the context of Lakom, what interests us is how Cosign signs OCI artifacts
and how it stores them.
The signing process in a nutshell is the following &ndash; <code>Sign(sha256(SimpleSigningPayload(sha256(Image Manifest))))</code>, where:</p><ul><li>Image Manifest is what it says. Just the manifest of the image (artifact).</li><li>sha256 is the hashing algorithm used.</li><li>SimpleSigningPayload is the interesting part here. Instead of just signing the
hash of the manifest itself, the hash itself is packed into a JSON doc that
is called the <code>SimpleSigningPayload</code>. Example payload:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    &#34;critical&#34;: {
</span></span><span style=display:flex><span>           &#34;identity&#34;: {
</span></span><span style=display:flex><span>               &#34;docker-reference&#34;: <span style=color:#a31515>&#34;testing/manifest&#34;</span>
</span></span><span style=display:flex><span>           },
</span></span><span style=display:flex><span>           &#34;image&#34;: {
</span></span><span style=display:flex><span>               &#34;Docker-manifest-digest&#34;: <span style=color:#a31515>&#34;sha256:20be...fe55&#34;</span>
</span></span><span style=display:flex><span>           },
</span></span><span style=display:flex><span>           &#34;type&#34;: <span style=color:#a31515>&#34;cosign container image signature&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    &#34;optional&#34;: {
</span></span><span style=display:flex><span>           &#34;creator&#34;: <span style=color:#a31515>&#34;atomic&#34;</span>,
</span></span><span style=display:flex><span>           &#34;timestamp&#34;: 1458239713
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can see that the hash of the manifest is stored in the <code>Docker-manifest-digest</code>.
Now this object is the one that gets signed using our private key. The signed
version of this objest is the one that gets stored and gets used for
verification.</p><p>Storage of the signature is done via an image manifest that gets uploaded
in the same repo as the image, but tagged with <code>sha256-&lt;container-image-digest>.sig</code>.
Thus, the signature discovery mechanism is to just fetch the image digest
that is tagged with the aforementioned tag.</p><p>More info on this whole process can be found <a href=https://github.com/sigstore/cosign/blob/main/specs/SIGNATURE_SPEC.md>here</a>.</p><p>Lakom relies on the cosign libraries to automate this whole process. When
validating an artifact, if we know its digest, we can fetch the signature and
verify it. If the signature is valid, we can be sure that the artifact has not
been tampered with.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f2dfab902de56f28952cebcd9108225f>4.4 - Shoot Extension</h1><h1 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h1><p>This extension implements <a href=https://github.com/sigstore/cosign>cosign</a> image verification. It is strictly limited only to the kubernetes system components deployed by Gardener and other Gardener Extensions in the <code>kube-system</code> namespace of a shoot cluster.</p><h2 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h2><p>In most of the Gardener setups the <code>shoot-lakom-service</code> extension is enabled globally and thus can be configured per shoot cluster. Please adapt the shoot specification by the configuration shown below to disable the extension individually.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - name: lakom-ref
</span></span><span style=display:flex><span>    resourceRef:
</span></span><span style=display:flex><span>      apiVersion: v1
</span></span><span style=display:flex><span>      kind: Secret
</span></span><span style=display:flex><span>      name: lakom-secret
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-lakom-service
</span></span><span style=display:flex><span>    disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: lakom.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: LakomConfig
</span></span><span style=display:flex><span>      scope: KubeSystem
</span></span><span style=display:flex><span>      trustedKeysResourceName: lakom-ref
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h3 id=scope>Scope<a class=td-heading-self-link href=#scope aria-label="Heading self-link"></a></h3><p>The <code>scope</code> field instruct lakom which pods to validate. The possible values are:</p><ul><li><code>KubeSystem</code>
Lakom will validate all pods in the <code>kube-system</code> namespace.</li><li><code>KubeSystemManagedByGardener</code>
Lakom will validate all pods in the <code>kube-system</code> namespace that are annotated with &ldquo;managed-by/gardener&rdquo;. This is the default value.</li><li><code>Cluster</code>
Lakom will validate all pods in all namespaces.</li></ul><h3 id=trustedkeysresourcename>TrustedKeysResourceName<a class=td-heading-self-link href=#trustedkeysresourcename aria-label="Heading self-link"></a></h3><p>Lakom, by default, tries to verify only workloads that belong to Gardener. Because of this, the only public keys that it uses to do its job are the ones for the Gardener workload.</p><p>If you&rsquo;d like to use Lakom as a tool for verifying your own workload, you&rsquo;ll need to add your own public keys to the ones that Lakom is already using. This can be achieved using Gardener <a href=/docs/gardener/extensions/referenced-resources/>referenced resources</a>. More information about the keys and their format can be found <a href=/docs/extensions/others/gardener-extension-shoot-lakom-service/lakom/#lakom-cosign-public-keys-configuration-file>here</a>.</p><p>Simply:</p><ol><li>Create a secret in your project namespace that contains a field <code>keys</code> with your keys as a value. Example keys:</li></ol><pre tabindex=0><code>- name: example-client-key1
  algorithm: RSASSA-PSS-SHA256
  key: |-
    -----BEGIN PUBLIC KEY-----
    MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAPeQXbIWMMXYV+9+j9b4jXTflnpfwn4E
    GMrmqYVhm0sclXb2FPP5aV/NFH6SZdHDZcT8LCNsNgxzxV4N+UE/JIsCAwEAAQ==
    -----END PUBLIC KEY-----
- name: example-client-key2
  algorithm: RSASSA-PSS-SHA256
  key: |-
    -----BEGIN PUBLIC KEY-----
    MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAPeQXbIWMMXYV+9+j9b4jXTflnpfwn4E
    GMrmqYVhm0sclXb2FPP5aV/NFH6SZdHDZcT8LCNsNgxzxV4N+UE/JIsCAwEAAQ==
    -----END PUBLIC KEY-----
</code></pre><ol start=2><li>Add a reference to your secret via the <code>resources</code> field in the shoot spec as shown above.</li><li>Add the name of your referenece in <code>trustedKeysResourceName </code>in the provider config as shown above.</li></ol><p>Now, whenever Lakom tries to verify a Pod, it will make sure to use your public keys as well.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d21abe30553ea86e1f5973d8484fc9d1>5 - Networking problemdetector</h1><div class=lead>Gardener extension for deploying network problem detector</div><h1 id=gardener-extension-for-network-problem-detectorhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Network Problem Detector</a><a class=td-heading-self-link href=#gardener-extension-for-network-problem-detectorhttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-networking-problemdetector><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-networking-problemdetector alt="REUSE status"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the <code>shoot-networking-problemdetector</code> extension.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-shoot-networking-problemdetector/blob/main/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=extension-resources>Extension Resources<a class=td-heading-self-link href=#extension-resources aria-label="Heading self-link"></a></h2><p>Currently there is nothing to specify in the extension spec.</p><p>Example extension resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Extension
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-networking-problemdetector
</span></span><span style=display:flex><span>  namespace: shoot--project--abc
</span></span><span style=display:flex><span>spec:
</span></span></code></pre></div><p>When an extension resource is reconciled, the extension controller will create two daemonsets <code>nwpd-agent-pod-net</code> and <code>nwpd-agent-node-net</code> deploying
the &ldquo;network problem detector agent&rdquo;.
These daemon sets perform and collect various checks between all nodes of the Kubernetes cluster, to its Kube API server and/or external endpoints.
Checks are performed using TCP connections, PING (ICMP) or mDNS (UDP).
More details about the network problem detector agent can be found in its repository <a href=https://github.com/gardener/network-problem-detector>gardener/network-problem-detector</a>.</p><p>Please note, this extension controller relies on the <a href=/docs/gardener/concepts/resource-manager/>Gardener-Resource-Manager</a> to deploy k8s resources to seed and shoot clusters.</p><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>.</p><p>We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-networking-problemdetector/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-bebb19906236a4aead1990c60039a112>5.1 - Deployment</h1><h1 id=gardener-networking-policy-filter-for-shoots>Gardener Networking Policy Filter for Shoots<a class=td-heading-self-link href=#gardener-networking-policy-filter-for-shoots aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener allows shoot clusters to add network problem observability using the network problem detector.
To support this the Gardener must be installed with the <code>shoot-networking-problemdetector</code> extension.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>To generally enable the networking problem detector for shoot objects the <code>shoot-networking-problemdetector</code> extension must be registered by providing an appropriate <a href=https://github.com/gardener/gardener-extension-shoot-networking-problemdetector/blob/main/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots the <code>globallyEnabled</code> flag should be set to <code>true</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerRegistration
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - kind: Extension
</span></span><span style=display:flex><span>      type: shoot-networking-problemdetector
</span></span><span style=display:flex><span>      globallyEnabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=controllerregistration>ControllerRegistration<a class=td-heading-self-link href=#controllerregistration aria-label="Heading self-link"></a></h3><p>An example of a <code>ControllerRegistration</code> for the <code>shoot-networking-problemdetector</code> can be found at <a href=https://github.com/gardener/gardener-extension-shoot-networking-problemdetector/blob/master/example/controller-registration.yaml>controller-registration.yaml</a>.</p><p>The <code>ControllerRegistration</code> contains a Helm chart which eventually deploys the <code>shoot-networking-problemdetector</code> to seed clusters. It offers some configuration options, mainly to set up a static filter list or provide the configuration for downloading the filter list from a service endpoint.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerDeployment
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  values:
</span></span><span style=display:flex><span>    <span style=color:green>#networkProblemDetector:</span>
</span></span><span style=display:flex><span>    <span style=color:green>#  defaultPeriod: 30s</span>
</span></span></code></pre></div><h3 id=enablement-for-a-shoot>Enablement for a Shoot<a class=td-heading-self-link href=#enablement-for-a-shoot aria-label="Heading self-link"></a></h3><p>If the shoot network problem detector is not globally enabled by default (depends on the extension registration on the garden cluster), it can be enabled per shoot. To enable the service for a shoot, the shoot manifest must explicitly add the <code>shoot-networking-problemdetector</code> extension.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-problemdetector
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>If the shoot network problem detector is globally enabled by default, it can be disabled per shoot. To disable the service for a shoot, the shoot manifest must explicitly state it.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-problemdetector
</span></span><span style=display:flex><span>      disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c9d138e16c74e4d2eff97bab16571286>5.2 - Shoot Networking Problemdetector</h1><h1 id=register-shoot-networking-filter-extension-in-shoot-clusters>Register Shoot Networking Filter Extension in Shoot Clusters<a class=td-heading-self-link href=#register-shoot-networking-filter-extension-in-shoot-clusters aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Within a shoot cluster, it is possible to enable the network problem detector. It is necessary that the Gardener installation your shoot cluster runs in is equipped with a <code>shoot-networking-problemdetector</code> extension. Please ask your Gardener operator if the extension is available in your environment.</p><h2 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h2><p>In most of the Gardener setups the <code>shoot-networking-problemdetector</code> extension is not enabled globally and thus must be configured per shoot cluster. Please adapt the shoot specification by the configuration shown below to activate the extension individually.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-problemdetector
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=opt-out>Opt-out<a class=td-heading-self-link href=#opt-out aria-label="Heading self-link"></a></h2><p>If the shoot network problem detector is globally enabled by default, it can be disabled per shoot. To disable the service for a shoot, the shoot manifest must explicitly state it.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-problemdetector
</span></span><span style=display:flex><span>      disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6889f213566c4acb69ba72feddc07601>6 - Node Audit Logging</h1><div class=lead>Gardener extension controller which configures the rsyslog and auditd services installed on shoot nodes.</div><h1 id=gardener-extension-to-configure-rsyslog-with-relp-modulehttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension to configure rsyslog with relp module</a><a class=td-heading-self-link href=#gardener-extension-to-configure-rsyslog-with-relp-modulehttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-rsyslog-relp><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-rsyslog-relp alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-shoot-rsyslog-relp-main/jobs/main-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-shoot-rsyslog-relp-main/jobs/main-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-shoot-rsyslog-relp><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-shoot-rsyslog-relp alt="Go Report Card"></a></p><p>Gardener extension controller which configures the rsyslog and auditd services installed on shoot nodes.</p><h2 id=usage>Usage<a class=td-heading-self-link href=#usage aria-label="Heading self-link"></a></h2><ul><li><a href=/docs/extensions/others/gardener-extension-shoot-rsyslog-relp/configuration/>Configuring the Rsyslog Relp Extension</a> - learn what is the use-case for rsyslog-relp, how to enable it and configure it</li></ul><h2 id=local-setup-and-development>Local Setup and Development<a class=td-heading-self-link href=#local-setup-and-development aria-label="Heading self-link"></a></h2><ul><li><a href=/docs/extensions/others/gardener-extension-shoot-rsyslog-relp/getting-started/>Deploying the Rsyslog Relp Extension Locally</a> - learn how to set up a local development environment</li><li><a href=/docs/extensions/others/gardener-extension-shoot-rsyslog-relp/shoot-rsyslog-relp/>Developer Docs for Gardener Shoot Rsyslog Relp Extension</a> - learn about the inner workings</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-5ebc3f99478b6244b628fb0367c1bbaa>6.1 - Configuration</h1><h1 id=configuring-the-rsyslog-relp-extension>Configuring the Rsyslog Relp Extension<a class=td-heading-self-link href=#configuring-the-rsyslog-relp-extension aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>As a cluster owner, you might need audit logs on a Shoot node level. With these audit logs you can track actions on your nodes like privilege escalation, file integrity, process executions, and who is the user that performed these actions. Such information is essential for the security of your Shoot cluster. Linux operating systems collect such logs via the <code>auditd</code> and <code>journald</code> daemons. However, these logs can be lost if they are only kept locally on the operating system. You need a reliable way to send them to a remote server where they can be stored for longer time periods and retrieved when necessary.</p><p><a href=https://www.rsyslog.com/>Rsyslog</a> offers a solution for that. It gathers and processes logs from <code>auditd</code> and <code>journald</code> and then forwards them to a remote server. Moreover, <code>rsyslog</code> can make use of the RELP protocol so that logs are sent reliably and no messages are lost.</p><p>The <code>shoot-rsyslog-relp</code> extension is used to configure <code>rsyslog</code> on each Shoot node so that the following can take place:</p><ol><li><code>Rsyslog</code> reads logs from the <code>auditd</code> and <code>journald</code> sockets.</li><li>The logs are filtered based on the program name and syslog severity of the message.</li><li>The logs are enriched with metadata containing the name of the Project in which the Shoot is created, the name of the Shoot, the UID of the Shoot, and the hostname of the node on which the log event occurred.</li><li>The enriched logs are sent to the target remote server via the RELP protocol.</li></ol><p>The following graph shows a rough outline of how that looks in a Shoot cluster:
<img src=/__resources/rsyslog-logging-architecture_a57f91.png alt=rsyslog-logging-architecture></p><h2 id=shoot-configuration>Shoot Configuration<a class=td-heading-self-link href=#shoot-configuration aria-label="Heading self-link"></a></h2><p>The extension is not globally enabled and must be configured per Shoot cluster. The Shoot specification has to be adapted to include the <code>shoot-rsyslog-relp</code> extension configuration, which specifies the target server to which logs are forwarded, its port, and some optional rsyslog settings described in the examples below.</p><p>Below is an example <code>shoot-rsyslog-relp</code> extension configuration as part of the Shoot spec:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: bar
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-rsyslog-relp
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>      <span style=color:green># Set the target server to which logs are sent. The server must support the RELP protocol.</span>
</span></span><span style=display:flex><span>      target: some.rsyslog-relp.server
</span></span><span style=display:flex><span>      <span style=color:green># Set the port of the target server.</span>
</span></span><span style=display:flex><span>      port: 10250
</span></span><span style=display:flex><span>      <span style=color:green># Define rules to select logs from which programs and with what syslog severity</span>
</span></span><span style=display:flex><span>      <span style=color:green># are forwarded to the target server.</span>
</span></span><span style=display:flex><span>      loggingRules:
</span></span><span style=display:flex><span>      - severity: 4
</span></span><span style=display:flex><span>        programNames: [<span style=color:#a31515>&#34;kubelet&#34;</span>, <span style=color:#a31515>&#34;audisp-syslog&#34;</span>]
</span></span><span style=display:flex><span>      - severity: 1
</span></span><span style=display:flex><span>        programNames: [<span style=color:#a31515>&#34;audisp-syslog&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:green># Define an interval of 90 seconds at which the current connection is broken and re-established.</span>
</span></span><span style=display:flex><span>      <span style=color:green># By default this value is 0 which means that the connection is never broken and re-established.</span>
</span></span><span style=display:flex><span>      rebindInterval: 90
</span></span><span style=display:flex><span>      <span style=color:green># Set the timeout for relp sessions to 90 seconds. If set too low, valid sessions may be considered</span>
</span></span><span style=display:flex><span>      <span style=color:green># dead and tried to recover.</span>
</span></span><span style=display:flex><span>      timeout: 90
</span></span><span style=display:flex><span>      <span style=color:green># Set how often an action is retried before it is considered to have failed.</span>
</span></span><span style=display:flex><span>      <span style=color:green># Failed actions discard log messages. Setting `-1` here means that messages are never discarded.</span>
</span></span><span style=display:flex><span>      resumeRetryCount: -1
</span></span><span style=display:flex><span>      <span style=color:green># Configures rsyslog to report continuation of action suspension, e.g. when the connection to the target</span>
</span></span><span style=display:flex><span>      <span style=color:green># server is broken.</span>
</span></span><span style=display:flex><span>      reportSuspensionContinuation: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      <span style=color:green># Add tls settings if tls should be used to encrypt the connection to the target server.</span>
</span></span><span style=display:flex><span>      tls:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        <span style=color:green># Use `name` authentication mode for the tls connection.</span>
</span></span><span style=display:flex><span>        authMode: name
</span></span><span style=display:flex><span>        <span style=color:green># Only allow connections if the server&#39;s name is `some.rsyslog-relp.server`</span>
</span></span><span style=display:flex><span>        permittedPeer:
</span></span><span style=display:flex><span>        - <span style=color:#a31515>&#34;some.rsyslog-relp.server&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:green># Reference to the resource which contains certificates used for the tls connection.</span>
</span></span><span style=display:flex><span>        <span style=color:green># It must be added to the `.spec.resources` field of the Shoot.</span>
</span></span><span style=display:flex><span>        secretReferenceName: rsyslog-relp-tls
</span></span><span style=display:flex><span>        <span style=color:green># Instruct librelp on the Shoot nodes to use the gnutls tls library.</span>
</span></span><span style=display:flex><span>        tlsLib: gnutls
</span></span><span style=display:flex><span>      <span style=color:green># Add auditConfig settings if you want to customize node level auditing.</span>
</span></span><span style=display:flex><span>      auditConfig:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        <span style=color:green># Reference to the resource which contains the audit configuration.</span>
</span></span><span style=display:flex><span>        <span style=color:green># It must be added to the `.spec.resources` field of the Shoot.</span>
</span></span><span style=display:flex><span>        configMapReferenceName: audit-config
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    <span style=color:green># Add the rsyslog-relp-tls secret in the resources field of the Shoot spec.</span>
</span></span><span style=display:flex><span>    - name: rsyslog-relp-tls
</span></span><span style=display:flex><span>      resourceRef:
</span></span><span style=display:flex><span>        apiVersion: v1
</span></span><span style=display:flex><span>        kind: Secret
</span></span><span style=display:flex><span>        name: rsyslog-relp-tls-v1
</span></span><span style=display:flex><span>    - name: audit-config
</span></span><span style=display:flex><span>      resourceRef:
</span></span><span style=display:flex><span>        apiVersion: v1
</span></span><span style=display:flex><span>        kind: ConfigMap
</span></span><span style=display:flex><span>        name: audit-config-v1
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h3 id=choosing-which-log-messages-to-send-to-the-target-server>Choosing Which Log Messages to Send to the Target Server<a class=td-heading-self-link href=#choosing-which-log-messages-to-send-to-the-target-server aria-label="Heading self-link"></a></h3><p>The <code>.loggingRules</code> field defines rules about which logs should be sent to the target server. When a log is processed by rsyslog, it is compared against the list of rules in order. If the program name and the syslog severity of the log messages matches the rule, the message is forwarded to the target server. The following table describes the syslog severity and their corresponding codes:</p><pre tabindex=0><code>Numerical         Severity
  Code

  0               Emergency: system is unusable
  1               Alert: action must be taken immediately
  2               Critical: critical conditions
  3               Error: error conditions
  4               Warning: warning conditions
  5               Notice: normal but significant condition
  6               Informational: informational messages
  7               Debug: debug-level messages
</code></pre><p>Below is an example with a <code>.loggingRules</code> section that will only forward logs from the <code>kubelet</code> program with syslog severity of 6 or lower and any other program with syslog severity of 2 or lower:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>target: localhost
</span></span><span style=display:flex><span>port: 1520
</span></span><span style=display:flex><span>loggingRules:
</span></span><span style=display:flex><span>- severity: 6
</span></span><span style=display:flex><span>  programNames: [<span style=color:#a31515>&#34;kubelet&#34;</span>]
</span></span><span style=display:flex><span>- severity: 2
</span></span></code></pre></div><p>You can use a minimal <code>shoot-rsyslog-relp</code> extension configuration to forward all logs to the target server:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>target: some.rsyslog-relp.server
</span></span><span style=display:flex><span>port: 10250
</span></span><span style=display:flex><span>loggingRules:
</span></span><span style=display:flex><span>- severity: 7
</span></span></code></pre></div><h3 id=securing-the-communication-to-the-target-server-with-tls>Securing the Communication to the Target Server with TLS<a class=td-heading-self-link href=#securing-the-communication-to-the-target-server-with-tls aria-label="Heading self-link"></a></h3><p>The communication to the target server is not encrypted by default. To enable encryption, set the <code>.tls.enabled</code> field in the <code>shoot-rsyslog-relp</code> extension configuration to <code>true</code>. In this case, an immutable secret which contains the TLS certificates used to establish the TLS connection to the server must be created in the same project namespace as your Shoot.</p><p>An example Secret is given below:</p><blockquote><p><strong>Note:</strong> The secret must be immutable</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: rsyslog-relp-tls-v1
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>immutable: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  ca: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----BEGIN BEGIN RSA PRIVATE KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>    ...
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----END RSA PRIVATE KEY-----</span>    
</span></span><span style=display:flex><span>  crt: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----BEGIN BEGIN RSA PRIVATE KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>    ...
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----END RSA PRIVATE KEY-----</span>    
</span></span><span style=display:flex><span>  key: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----BEGIN BEGIN RSA PRIVATE KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>    ...
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----END RSA PRIVATE KEY-----</span>    
</span></span></code></pre></div><p>The Secret must be referenced in the Shoot&rsquo;s <code>.spec.resources</code> field and the corresponding resource entry must be referenced in the <code>.tls.secretReferenceName</code> of the <code>shoot-rsyslog-relp</code> extension configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: bar
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-rsyslog-relp
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>      target: some.rsyslog-relp.server
</span></span><span style=display:flex><span>      port: 10250
</span></span><span style=display:flex><span>      loggingRules:
</span></span><span style=display:flex><span>      - severity: 7
</span></span><span style=display:flex><span>      tls:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        secretReferenceName: rsyslog-relp-tls
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - name: rsyslog-relp-tls
</span></span><span style=display:flex><span>      resourceRef:
</span></span><span style=display:flex><span>        apiVersion: v1
</span></span><span style=display:flex><span>        kind: Secret
</span></span><span style=display:flex><span>        name: rsyslog-relp-tls-v1
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>You can set a few additional parameters for the TLS connection: <code>.tls.authMode</code>, <code>tls.permittedPeer</code>, and <code>tls.tlsLib</code>. Refer to the rsyslog documentation for more information on these parameters:</p><ul><li><a href=https://www.rsyslog.com/doc/v8-stable/configuration/modules/omrelp.html#tls-authmode><code>.tls.authMode</code></a></li><li><a href=https://www.rsyslog.com/doc/v8-stable/configuration/modules/omrelp.html#tls-permittedpeer><code>.tls.permittedPeer</code></a></li><li><a href=https://www.rsyslog.com/doc/v8-stable/configuration/modules/imrelp.html#tls-tlslib><code>.tls.tlsLib</code></a></li></ul><h3 id=configuring-the-audit-daemon-on-the-shoot-nodes>Configuring the Audit Daemon on the Shoot Nodes<a class=td-heading-self-link href=#configuring-the-audit-daemon-on-the-shoot-nodes aria-label="Heading self-link"></a></h3><p>The <code>shoot-rsyslog-relp</code> extension also allows you to configure the Audit Daemon (<code>auditd</code>) on the Shoot nodes.</p><p>By default, the audit rules located under the <code>/etc/audit/rules.d</code> directory on your Shoot&rsquo;s nodes will be moved to <code>/etc/audit/rules.d.original</code> and the following rules will be placed under the <code>/etc/audit/rules.d</code> directory: <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/auditrules/00-base-config.rules>00-base-config.rules</a>, <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/auditrules/10-privilege-escalation.rules>10-privilege-escalation.rules</a>, <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/auditrules/11-privileged-special.rules>11-privilege-special.rules</a>, <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/auditrules/12-system-integrity.rules>12-system-integrity.rules</a>. Next, <code>augerules --load</code> will be called and the audit daemon (<code>auditd</code>) restarted so that the new rules can take effect.</p><p>Alternatively, you can define your own <code>auditd</code> rules to be placed on your Shoot&rsquo;s nodes by using the following configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Auditd
</span></span><span style=display:flex><span>auditRules: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>  ## First rule - delete all existing rules
</span></span></span><span style=display:flex><span><span style=color:#a31515>  -D
</span></span></span><span style=display:flex><span><span style=color:#a31515>  ## Now define some custom rules
</span></span></span><span style=display:flex><span><span style=color:#a31515>  -a exit,always -F arch=b64 -S setuid -S setreuid -S setgid -S setregid -F auid&gt;0 -F auid!=-1 -F key=privilege_escalation
</span></span></span><span style=display:flex><span><span style=color:#a31515>  -a exit,always -F arch=b64 -S execve -S execveat -F euid=0 -F auid&gt;0 -F auid!=-1 -F key=privilege_escalation</span>  
</span></span></code></pre></div><p>In this case the original rules are also backed up in the <code>/etc/audit/rules.d.original</code> directory.</p><p>To deploy this configuration, it must be embedded in an immutable ConfigMap.</p><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>The data key storing this configuration must be named <code>auditd</code>.</p></blockquote><p>An example <code>ConfigMap</code> is given below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: ConfigMap
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: audit-config-v1
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>immutable: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  auditd: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#a31515>    kind: Auditd
</span></span></span><span style=display:flex><span><span style=color:#a31515>    auditRules: |
</span></span></span><span style=display:flex><span><span style=color:#a31515>      ## First rule - delete all existing rules
</span></span></span><span style=display:flex><span><span style=color:#a31515>      -D
</span></span></span><span style=display:flex><span><span style=color:#a31515>      ## Now define some custom rules
</span></span></span><span style=display:flex><span><span style=color:#a31515>      -a exit,always -F arch=b64 -S setuid -S setreuid -S setgid -S setregid -F auid&gt;0 -F auid!=-1 -F key=privilege_escalation
</span></span></span><span style=display:flex><span><span style=color:#a31515>      -a exit,always -F arch=b64 -S execve -S execveat -F euid=0 -F auid&gt;0 -F auid!=-1 -F key=privilege_escalation</span>    
</span></span></code></pre></div><p>After creating such a <code>ConfigMap</code>, it must be included in the Shoot&rsquo;s <code>spec.resources</code> array and then referenced from the <code>providerConfig.auditConfig.configMapReferenceName</code> field in the <code>shoot-rsyslog-relp</code> extension configuration.</p><p>An example configuration is given below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: bar
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-rsyslog-relp
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>      target: some.rsyslog-relp.server
</span></span><span style=display:flex><span>      port: 10250
</span></span><span style=display:flex><span>      loggingRules:
</span></span><span style=display:flex><span>      - severity: 7
</span></span><span style=display:flex><span>      auditConfig:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        configMapReferenceName: audit-config
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - name: audit-config
</span></span><span style=display:flex><span>      resourceRef:
</span></span><span style=display:flex><span>        apiVersion: v1
</span></span><span style=display:flex><span>        kind: ConfigMap
</span></span><span style=display:flex><span>        name: audit-config-v1
</span></span></code></pre></div><p>Finally, by setting <code>providerConfig.auditConfig.enabled</code> to <code>false</code> in the <code>shoot-rsyslog-relp</code> extension configuration, the original audit rules on your Shoot&rsquo;s nodes will not be modified and <code>auditd</code> will not be restarted.</p><p>Examples on how the <code>providerConfig.auditConfig.enabled</code> field functions are given below:</p><ul><li>The following deploys the extension default audit rules as of today:<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  auditConfig:
</span></span><span style=display:flex><span>    enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div></li><li>The following deploys only the rules specified in the referenced ConfigMap:<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  auditConfig:
</span></span><span style=display:flex><span>    enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    configMapReferenceName: audit-config
</span></span></code></pre></div></li><li>Both of the following do not deploy any audit rules:<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  auditConfig:
</span></span><span style=display:flex><span>    enabled: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>    configMapReferenceName: audit-config
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  auditConfig:
</span></span><span style=display:flex><span>    enabled: <span style=color:#00f>false</span>
</span></span></code></pre></div></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d98ae8d67f017fd530967ee60a540c5c>6.2 - Deploying Rsyslog Relp Extension Remotely</h1><div class=lead>Learn how to set up a development environment using own Seed clusters on an existing Kubernetes cluster</div><h1 id=deploying-rsyslog-relp-extension-remotely>Deploying Rsyslog Relp Extension Remotely<a class=td-heading-self-link href=#deploying-rsyslog-relp-extension-remotely aria-label="Heading self-link"></a></h1><p>This document will walk you through running the Rsyslog Relp extension controller on a remote seed cluster and the rsyslog relp admission component in your local garden cluster for development purposes. This guide uses Gardener&rsquo;s <a href=/docs/gardener/deployment/getting_started_locally_with_extensions/>setup with provider extensions</a> and builds on top of it.</p><p>If you encounter difficulties, please open an issue so that we can make this process easier.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>Make sure that you have a running Gardener setup with provider extensions. The steps to complete this can be found in the <a href=/docs/gardener/deployment/getting_started_locally_with_extensions/>Deploying Gardener Locally and Enabling Provider-Extensions</a> guide.</li><li>Make sure you are running Gardener version <code>>= 1.95.0</code> or the latest version of the master branch.</li></ul><h2 id=setting-up-the-rsyslog-relp-extension>Setting up the Rsyslog Relp Extension<a class=td-heading-self-link href=#setting-up-the-rsyslog-relp-extension aria-label="Heading self-link"></a></h2><p><strong>Important:</strong> Make sure that your <code>KUBECONFIG</code> env variable is targeting the local Gardener cluster!</p><p>The location of the Gardener project from the Gardener setup is expected to be under the same root as this repository (e.g. ~/go/src/github.com/gardener/). If this is not the case, the location of Gardener project should be specified in <code>GARDENER_REPO_ROOT</code> environment variable:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export GARDENER_REPO_ROOT=<span style=color:#a31515>&#34;&lt;path_to_gardener_project&gt;&#34;</span>
</span></span></code></pre></div><p>Then you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-up
</span></span></code></pre></div><p>In case you have added additional Seeds you can specify the seed name:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-up SEED_NAME=&lt;seed-name&gt;
</span></span></code></pre></div><h2 id=creating-a-shoot-cluster>Creating a Shoot Cluster<a class=td-heading-self-link href=#creating-a-shoot-cluster aria-label="Heading self-link"></a></h2><p>Once the above step is completed, you can create a Shoot cluster. In order to create a Shoot cluster, please create your own <code>Shoot</code> definition depending on providers on your <code>Seed</code> cluster.</p><h2 id=configuring-the-shoot-cluster-and-deploying-the-rsyslog-relp-echo-server>Configuring the Shoot Cluster and deploying the Rsyslog Relp Echo Server<a class=td-heading-self-link href=#configuring-the-shoot-cluster-and-deploying-the-rsyslog-relp-echo-server aria-label="Heading self-link"></a></h2><p>To be able to properly test the rsyslog relp extension you need a running rsyslog relp echo server to which logs from the Shoot nodes can be sent. To deploy the server and configure the rsyslog relp extension on your Shoot cluster you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make configure-shoot SHOOT_NAME=&lt;shoot-name&gt; SHOOT_NAMESPACE=&lt;shoot-namespace&gt;
</span></span></code></pre></div><p>This command will deploy an rsyslog relp echo server in your Shoot cluster in the <code>rsyslog-relp-echo-server</code> namespace.
It will also add configuration for the <code>shoot-rsyslog-relp</code> extension to your <code>Shoot</code> spec by patching it with <code>./example/extension/&lt;shoot-name>--&lt;shoot-namespace>--extension-config-patch.yaml</code>. This file is automatically copied from <code>extension-config-patch.yaml.tmpl</code> in the same directory when you run <code>make configure-shoot</code> for the first time. The file also includes explanations of the properties you should set or change.
The command will also deploy the <code>rsyslog-relp-tls</code> secret in case you wish to enable tls.</p><h2 id=tearing-down-the-development-environment>Tearing Down the Development Environment<a class=td-heading-self-link href=#tearing-down-the-development-environment aria-label="Heading self-link"></a></h2><p>To tear down the development environment, delete the Shoot cluster or disable the <code>shoot-rsyslog-relp</code> extension in the Shoot&rsquo;s specification. When the extension is not used by the Shoot anymore, you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-down
</span></span></code></pre></div><p>The make target will delete the ControllerDeployment and ControllerRegistration of the extension, and the <code>shoot-rsyslog-relp</code> admission helm deployment.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5931a564b136d80a746006d8ebc0311b>6.3 - Getting Started</h1><h1 id=deploying-rsyslog-relp-extension-locally>Deploying Rsyslog Relp Extension Locally<a class=td-heading-self-link href=#deploying-rsyslog-relp-extension-locally aria-label="Heading self-link"></a></h1><p>This document will walk you through running the Rsyslog Relp extension and a fake rsyslog relp service on your local machine for development purposes. This guide uses Gardener&rsquo;s local development setup and builds on top of it.</p><p>If you encounter difficulties, please open an issue so that we can make this process easier.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>Make sure that you have a running local Gardener setup. The steps to complete this can be found <a href=/docs/gardener/deployment/getting_started_locally/>here</a>.</li><li>Make sure you are running Gardener version <code>>= 1.74.0</code> or the latest version of the master branch.</li></ul><h2 id=setting-up-the-rsyslog-relp-extension>Setting up the Rsyslog Relp Extension<a class=td-heading-self-link href=#setting-up-the-rsyslog-relp-extension aria-label="Heading self-link"></a></h2><p><strong>Important:</strong> Make sure that your <code>KUBECONFIG</code> env variable is targeting the local Gardener cluster!</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-up
</span></span></code></pre></div><p>This will build the <code>shoot-rsyslog-relp</code>, <code>shoot-rsyslog-relp-admission</code>, and <code>shoot-rsyslog-relp-echo-server</code> images and deploy the needed resources and configurations in the garden cluster. The <code>shoot-rsyslog-relp-echo-server</code> will act as development replacement of a real rsyslog relp server.</p><h2 id=creating-a-shoot-cluster>Creating a Shoot Cluster<a class=td-heading-self-link href=#creating-a-shoot-cluster aria-label="Heading self-link"></a></h2><p>Once the above step is completed, we can deploy and configure a Shoot cluster with default rsyslog relp settings.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f ./example/shoot.yaml
</span></span></code></pre></div><p>Once the Shoot&rsquo;s namespace is created, we can create a <code>networkpolicy</code> that will allow egress traffic from the <code>rsyslog</code> on the Shoot&rsquo;s nodes to the <code>rsyslog-relp-echo-server</code> that serves as a fake rsyslog target server.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f ./example/local/allow-machine-to-rsyslog-relp-echo-server-netpol.yaml
</span></span></code></pre></div><p>Currently, the Shoot&rsquo;s nodes run Ubuntu, which does not have the <code>rsyslog-relp</code> and <code>auditd</code> packages installed, so the configuration done by the extension has no effect.
Once the Shoot is created, we have to manually install the <code>rsyslog-relp</code> and <code>auditd</code> packages:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n shoot--local--local exec -it <span style=color:#00f>$(</span>kubectl -n shoot--local--local get po -l app=machine,machine-provider=local -o name<span style=color:#00f>)</span> -- bash -c <span style=color:#a31515>&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>   apt-get update &amp;&amp; \
</span></span></span><span style=display:flex><span><span style=color:#a31515>   apt-get install -y rsyslog-relp auditd &amp;&amp; \
</span></span></span><span style=display:flex><span><span style=color:#a31515>   systemctl enable rsyslog.service &amp;&amp; \
</span></span></span><span style=display:flex><span><span style=color:#a31515>   systemctl start rsyslog.service&#34;</span>
</span></span></code></pre></div><p>Once that is done we can verify that log messages are forwarded to the <code>rsyslog-relp-echo-server</code> by checking its logs.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n rsyslog-relp-echo-server logs deployment/rsyslog-relp-echo-server
</span></span></code></pre></div><h2 id=making-changes-to-the-rsyslog-relp-extension>Making Changes to the Rsyslog Relp Extension<a class=td-heading-self-link href=#making-changes-to-the-rsyslog-relp-extension aria-label="Heading self-link"></a></h2><p>Changes to the rsyslog relp extension can be applied to the local environment by repeatedly running the <code>make</code> recipe.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-up
</span></span></code></pre></div><h2 id=tearing-down-the-development-environment>Tearing Down the Development Environment<a class=td-heading-self-link href=#tearing-down-the-development-environment aria-label="Heading self-link"></a></h2><p>To tear down the development environment, delete the Shoot cluster or disable the <code>shoot-rsyslog-relp</code> extension in the Shoot&rsquo;s spec. When the extension is not used by the Shoot anymore, you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-down
</span></span></code></pre></div><p>This will delete the <code>ControllerRegistration</code> and <code>ControllerDeployment</code> of the extension, the <code>shoot-rsyslog-relp-admission</code> deployment, and the <code>rsyslog-relp-echo-server</code> deployment.</p><h1 id=maintaining-the-publicly-available-image-for-the-rsyslog-relp-echo-server>Maintaining the Publicly Available Image for the rsyslog-relp Echo Server<a class=td-heading-self-link href=#maintaining-the-publicly-available-image-for-the-rsyslog-relp-echo-server aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/tree/main/test/testmachinery/shoot>testmachinery tests</a> use an <code>rsyslog-relp-echo-server</code> image from a publicly available repository. The one which is currently used is <code>eu.gcr.io/gardener-project/gardener/extensions/shoot-rsyslog-relp-echo-server:v0.1.0</code>.</p><p>Sometimes it might be necessary to update the image and publish it, e.g. when updating the <code>alpine</code> base image version specified in the repository&rsquo;s <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/Dockerfile#L34>Dokerfile</a>.</p><p>To do that:</p><ol><li><p>Bump the version with which the image is built in the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/Makefile#L17>Makefile</a>.</p></li><li><p>Build the <code>shoot-rsyslog-relp-echo-server</code> image:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make echo-server-docker-image
</span></span></code></pre></div></li><li><p>Once the image is built, push it to <code>gcr</code> with:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make push-echo-server-image
</span></span></code></pre></div></li><li><p>Finally, bump the version of the image used by the <code>testmachinery</code> tests <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/test/testmachinery/shoot/common_test.go>here</a>.</p></li><li><p>Create a PR with the changes.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-1841124a2d14ff1da23f3b3ac50c5742>6.4 - Monitoring</h1><h1 id=monitoring>Monitoring<a class=td-heading-self-link href=#monitoring aria-label="Heading self-link"></a></h1><p>The <code>shoot-rsyslog-relp</code> extension exposes metrics for the <code>rsyslog</code> service running on a Shoot&rsquo;s nodes so that they can be easily viewed by cluster owners and operators in the Shoot&rsquo;s Prometheus and Plutono instances. The exposed monitoring data offers valuable insights into the operation of the <code>rsyslog</code> service and can be used to detect and debug ongoing issues. This guide describes the various metrics, alerts and logs available to cluster owners and operators.</p><h2 id=metrics>Metrics<a class=td-heading-self-link href=#metrics aria-label="Heading self-link"></a></h2><p>Metrics for the <code>rsyslog</code> service originate from its <code>impstats</code> module. These include the number of messages in the various queues, the number of ingested messages, the number of processed messages by configured actions, system resources used by the <code>rsyslog</code> service, and others. More information about them can be found in the <a href=https://www.rsyslog.com/doc/configuration/modules/impstats.html><code>impstats</code> documentation</a> and the <a href=https://www.rsyslog.com/doc/configuration/rsyslog_statistic_counter.html>statistics counter documentation</a>. They are exposed via the <a href="https://github.com/prometheus/node_exporter?tab=readme-ov-file#node-exporter"><code>node-exporter</code></a> running on each Shoot node and are scraped by the Shoot&rsquo;s <a href=https://github.com/gardener/gardener/blob/release-v1.99/docs/monitoring/README.md#shoot-prometheus>Prometheus instance</a>.</p><p>These metrics can also be viewed in a dedicated dashboard named <code>Rsyslog Stats</code> in the Shoot&rsquo;s Plutono instance. You can select the node for which you wish the metrics to be displayed from the <code>Node</code> dropdown menu (by default metrics are summed over all nodes).</p><p>Following is a list of all exposed <code>rsyslog</code> metrics. The <code>name</code> and <code>origin</code> labels can be used to determine wether the metric is for: a <a href=https://www.rsyslog.com/doc/configuration/rsyslog_statistic_counter.html#queue>queue</a>, an <a href=https://www.rsyslog.com/doc/configuration/rsyslog_statistic_counter.html#queue>action</a>, <a href=https://www.rsyslog.com/doc/configuration/rsyslog_statistic_counter.html#plugins>plugins</a> or <a href=https://www.rsyslog.com/doc/configuration/modules/impstats.html#statistic-counter>system stats</a>; the <code>node</code> label can be used to determine the node the metric originates from:</p><h4 id=rsyslog_pstat_submitted>rsyslog_pstat_submitted<a class=td-heading-self-link href=#rsyslog_pstat_submitted aria-label="Heading self-link"></a></h4><p>Number of messages that were submitted to the <code>rsyslog</code> service from its input. Currently <code>rsyslog</code> uses the <code>/run/systemd/journal/syslog</code> socket as input.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_processed>rsyslog_pstat_processed<a class=td-heading-self-link href=#rsyslog_pstat_processed aria-label="Heading self-link"></a></h4><p>Number of messages that are successfully processed by an action and sent to the target server.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_failed>rsyslog_pstat_failed<a class=td-heading-self-link href=#rsyslog_pstat_failed aria-label="Heading self-link"></a></h4><p>Number of messages that could not be processed by an action nor sent to the target server.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_suspended>rsyslog_pstat_suspended<a class=td-heading-self-link href=#rsyslog_pstat_suspended aria-label="Heading self-link"></a></h4><p>Total number of times an action suspended itself. Note that this counts the number of times the action transitioned from active to suspended state. The counter is no indication of how long the action was suspended or how often it was retried.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_suspended_duration>rsyslog_pstat_suspended_duration<a class=td-heading-self-link href=#rsyslog_pstat_suspended_duration aria-label="Heading self-link"></a></h4><p>The total number of seconds this action was disabled.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_resumed>rsyslog_pstat_resumed<a class=td-heading-self-link href=#rsyslog_pstat_resumed aria-label="Heading self-link"></a></h4><p>The total number of times this action resumed itself. A resumption occurs after the action has detected that a failure condition does no longer exist.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_utime>rsyslog_pstat_utime<a class=td-heading-self-link href=#rsyslog_pstat_utime aria-label="Heading self-link"></a></h4><p>User time used in microseconds.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_stime>rsyslog_pstat_stime<a class=td-heading-self-link href=#rsyslog_pstat_stime aria-label="Heading self-link"></a></h4><p>System time used in microsends.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_maxrss>rsyslog_pstat_maxrss<a class=td-heading-self-link href=#rsyslog_pstat_maxrss aria-label="Heading self-link"></a></h4><p>Maximum resident set size</p><ul><li>Type: Gauge</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_minflt>rsyslog_pstat_minflt<a class=td-heading-self-link href=#rsyslog_pstat_minflt aria-label="Heading self-link"></a></h4><p>Total number of minor faults the task has made per second, those which have not required loading a memory page from disk.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_majflt>rsyslog_pstat_majflt<a class=td-heading-self-link href=#rsyslog_pstat_majflt aria-label="Heading self-link"></a></h4><p>Total number of major faults the task has made per second, those which have required loading a memory page from disk.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_inblock>rsyslog_pstat_inblock<a class=td-heading-self-link href=#rsyslog_pstat_inblock aria-label="Heading self-link"></a></h4><p>Filesystem input operations.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_oublock>rsyslog_pstat_oublock<a class=td-heading-self-link href=#rsyslog_pstat_oublock aria-label="Heading self-link"></a></h4><p>Filesystem output operations.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_nvcsw>rsyslog_pstat_nvcsw<a class=td-heading-self-link href=#rsyslog_pstat_nvcsw aria-label="Heading self-link"></a></h4><p>Voluntary context switches.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_nivcsw>rsyslog_pstat_nivcsw<a class=td-heading-self-link href=#rsyslog_pstat_nivcsw aria-label="Heading self-link"></a></h4><p>Involuntary context switches.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_openfiles>rsyslog_pstat_openfiles<a class=td-heading-self-link href=#rsyslog_pstat_openfiles aria-label="Heading self-link"></a></h4><p>Number of open files.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_size>rsyslog_pstat_size<a class=td-heading-self-link href=#rsyslog_pstat_size aria-label="Heading self-link"></a></h4><p>Messages currently in queue.</p><ul><li>Type: Gauge</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_enqueued>rsyslog_pstat_enqueued<a class=td-heading-self-link href=#rsyslog_pstat_enqueued aria-label="Heading self-link"></a></h4><p>Total messages enqueued.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_full>rsyslog_pstat_full<a class=td-heading-self-link href=#rsyslog_pstat_full aria-label="Heading self-link"></a></h4><p>Times queue was full.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_discarded_full>rsyslog_pstat_discarded_full<a class=td-heading-self-link href=#rsyslog_pstat_discarded_full aria-label="Heading self-link"></a></h4><p>Messages discarded due to queue being full.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_discarded_nf>rsyslog_pstat_discarded_nf<a class=td-heading-self-link href=#rsyslog_pstat_discarded_nf aria-label="Heading self-link"></a></h4><p>Messages discarded when queue not full.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_maxqsize>rsyslog_pstat_maxqsize<a class=td-heading-self-link href=#rsyslog_pstat_maxqsize aria-label="Heading self-link"></a></h4><p>Maximum size queue has reached.</p><ul><li>Type: Gauge</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_augenrules_load_success>rsyslog_augenrules_load_success<a class=td-heading-self-link href=#rsyslog_augenrules_load_success aria-label="Heading self-link"></a></h4><p>Shows whether the <code>augenrules --load</code> command was executed successfully or not on the node.</p><ul><li>Type: Gauge</li><li>Labels: <code>node</code></li></ul><h2 id=alerts>Alerts<a class=td-heading-self-link href=#alerts aria-label="Heading self-link"></a></h2><p>There are three alerts defined for the <code>rsyslog</code> service in the Shoot&rsquo;s Prometheus instance:</p><h4 id=rsyslogtoomanyrelpactionfailures>RsyslogTooManyRelpActionFailures<a class=td-heading-self-link href=#rsyslogtoomanyrelpactionfailures aria-label="Heading self-link"></a></h4><p>This indicates that the cumulative failure rate in processing <code>relp</code> action messages is greater than 2%. In other words, it compares the rate of processed <code>relp</code> action messages to the rate of failed <code>relp</code> action messages and fires an alert when the following expression evaluates to true:</p><pre tabindex=0><code>sum(rate(rsyslog_pstat_failed{origin=&#34;core.action&#34;,name=&#34;rsyslg-relp&#34;}[5m])) / sum(rate(rsyslog_pstat_processed{origin=&#34;core.action&#34;,name=&#34;rsyslog-relp&#34;}[5m])) &gt; bool 0.02`
</code></pre><h4 id=rsyslogrelpactionprocessingrateiszero>RsyslogRelpActionProcessingRateIsZero<a class=td-heading-self-link href=#rsyslogrelpactionprocessingrateiszero aria-label="Heading self-link"></a></h4><p>This indicates that no messages are being sent to the upstream rsyslog target by the <code>relp</code> action. An alert is fired when the following expression evaluates to true:</p><pre tabindex=0><code>rate(rsyslog_pstat_processed{origin=&#34;core.action&#34;,name=&#34;rsyslog-relp&#34;}[5m]) == 0
</code></pre><h4 id=rsyslogrelpauditrulesnotloadedsuccessfully>RsyslogRelpAuditRulesNotLoadedSuccessfully<a class=td-heading-self-link href=#rsyslogrelpauditrulesnotloadedsuccessfully aria-label="Heading self-link"></a></h4><p>This indicates that <code>augenrules --load</code> was not executed successfully when called to load the configured audit rules. You should check if the <code>auditd</code> configuration you provided is valid. An alert is fired when the following expression evaluates to true:</p><pre tabindex=0><code>absent(rsyslog_augenrules_load_success == 1)
</code></pre><p>Users can subscribe to these alerts by following the Gardener <a href=/docs/gardener/monitoring/alerting/#alerting-for-users>alerting guide</a>.</p><h2 id=logging>Logging<a class=td-heading-self-link href=#logging aria-label="Heading self-link"></a></h2><p>There are two ways to view the logs of the <code>rsyslog</code> service running on the Shoot&rsquo;s nodes - either using the <code>Explore</code> tab of the Shoot&rsquo;s Plutono instance, or <code>ssh</code>-ing directly to a node.</p><p>To view logs in Plutono, navigate to the <code>Explore</code> tab and select <code>vali</code> from the <code>Explore</code> dropdown menu. Afterwards enter the following <code>vali</code> query:</p><p><code>{nodename="&lt;name-of-node>"} |~ "\"unit\":\"rsyslog.service\""</code></p><p>Notice that you cannot use the <code>unit</code> label to filter for the <code>rsyslog.service</code> unit logs. Instead, you have to <code>grep</code> for the service as displayed in the example above.</p><p>To view logs when directly <code>ssh</code>-ing to a node in the Shoot cluster, use either of the following commands on the node:</p><p><code>systemctl status rsyslog</code></p><p><code>journalctl -u rsyslog</code></p></div><div class=td-content style=page-break-before:always><h1 id=pg-9de2fab25f87ab9a7ba8bb94aa9858b9>6.5 - Shoot Rsyslog Relp</h1><h1 id=developer-docs-for-gardener-shoot-rsyslog-relp-extension>Developer Docs for Gardener Shoot Rsyslog Relp Extension<a class=td-heading-self-link href=#developer-docs-for-gardener-shoot-rsyslog-relp-extension aria-label="Heading self-link"></a></h1><p>This document outlines how Shoot reconciliation and deletion works for a Shoot with the shoot-rsyslog-relp extension enabled.</p><h2 id=shoot-reconciliation>Shoot Reconciliation<a class=td-heading-self-link href=#shoot-reconciliation aria-label="Heading self-link"></a></h2><p>This section outlines how the reconciliation works for a Shoot with the shoot-rsyslog-relp extension enabled.</p><h3 id=extension-enablement--reconciliation>Extension Enablement / Reconciliation<a class=td-heading-self-link href=#extension-enablement--reconciliation aria-label="Heading self-link"></a></h3><p>This section outlines how the extension enablement/reconciliation works, e.g., the extension has been added to the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, the gardenlet deploys the <a href=https://github.com/gardener/gardener/blob/v1.82.0/docs/extensions/extension.md>Extension</a> resource.</li><li>The shoot-rsyslog-relp extension reconciles the Extension resource. <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/controller/lifecycle/actuator.go>pkg/controller/lifecycle/actuator.go</a> contains the implementation of the <a href=https://github.com/gardener/gardener/blob/v1.82.0/extensions/pkg/controller/extension/actuator.go>extension.Actuator</a> interface. The reconciliation of an Extension of type <code>shoot-rsyslog-relp</code> only deploys the necessary monitoring configuration - the <code>shoot-rsyslog-relp-dashboards</code> ConfigMap which contains the definitions for: Plutono dashboard for the Rsyslog component, and the <code>shoot-shoot-rsyslog-relp</code> <code>ServiceMonitor</code> and <code>PrometheusRule</code> resources which contains the definitions for: scraping metrics by prometheus, alerting rules.</li><li>As part of the Shoot reconciliation flow, the gardenlet deploys the OperatingSystemConfig resource.</li><li>The shoot-rsyslog-relp extension serves a webhook that mutates the OperatingSystemConfig resource for Shoots having the shoot-rsyslog-relp extension enabled (the corresponding namespace gets labeled by the gardenlet with <code>extensions.gardener.cloud/shoot-rsyslog-relp=true</code>). <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/ensurer.go>pkg/webhook/operatingsystemconfig/ensurer.go</a> contains implementation of the <a href=https://github.com/gardener/gardener/blob/v1.82.0/extensions/pkg/webhook/controlplane/genericmutator/mutator.go>genericmutator.Ensurer</a> interface.<ol><li>The webhook renders the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/templates/scripts/configure-rsyslog.tpl.sh>60-audit.conf.tpl</a> template script and appends it to the OperatingSystemConfig files. When rendering the template, the configuration of the shoot-rsyslog-relp extension is used to fill in the required template values. The file is installed as <code>/var/lib/rsyslog-relp-configurator/rsyslog.d/60-audit.conf</code> on the host OS.</li><li>The webhook appends the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/tree/main/pkg/webhook/operatingsystemconfig/resources/auditrules>audit rules</a> to the OperatingSystemConfig. The files are installed under <code>/var/lib/rsyslog-relp-configurator/rules.d</code> on the host OS.</li><li>If the user has specified alternative audit rules in a config map reference, the webhook fetches the referenced <code>ConfigMap</code> from the Shoot&rsquo;s control plane namespace and decodes the value of its <code>auditd</code> data key into an object of type <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/apis/rsyslog/types_auditd.go><code>Auditd</code></a>. It then takes the <code>auditRules</code> defined in the object and places those under the <code>/var/lib/rsyslog-relp-configurator/rules.d</code> directory in a single file.</li><li>The webhook renders the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/templates/scripts/configure-rsyslog.tpl.sh>configure-rsyslog.tpl.sh</a> script and appends it to the OperatingSystemConfig files. This script is installed as <code>/var/lib/rsyslog-relp-configurator/configure-rsyslog.sh</code> on the host OS. It keeps the configuration of the <code>rsyslog</code> systemd service up-to-date by copying <code>/var/lib/rsyslog-relp-configurator/rsyslog.d/60-audit.conf</code> to <code>/etc/rsyslog.d/60-audit.conf</code>, if <code>/etc/rsyslog.d/60-audit.conf</code> does not exist or the files differ. The script also takes care of syncing the audit rules in <code>/etc/audit/rules.d</code> with the ones installed in <code>/var/lib/rsyslog-relp-configurator/rules.d</code> and restarts the auditd systemd service if necessary.</li><li>The webhook renders the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/templates/scripts/process-rsyslog-pstats.tpl.sh>process-rsyslog-pstats.tpl.sh</a> and appends it to the OperatingSystemConfig files. This script receives metrics from the <code>rsyslog</code> process, transforms them, and writes them to <code>/var/lib/node-exporter/textfile-collector/rsyslog_pstats.prom</code> so that they can be collected by the <code>node-exporter</code>.</li><li>As part of the Shoot reconciliation, before the shoot-rsyslog-relp extension is deployed, the gardenlet copies all Secret and ConfigMap resources referenced in <code>.spec.resources[]</code> to the Shoot&rsquo;s control plane namespace on the Seed.
When the <code>.tls.enabled</code> field is <code>true</code> in the shoot-rsyslog-relp extension configuration, a value for <code>.tls.secretReferenceName</code> must also be specified so that it references a <a href=https://github.com/gardener/gardener/blob/v1.82.0/pkg/apis/core/v1beta1/types_shoot.go#L487>named resource reference</a> in the Shoot&rsquo;s <code>.spec.resources[]</code> array.
The webhook appends the data of the referenced Secret in the Shoot&rsquo;s control plane namespace to the OperatingSystemConfig files.</li><li>The webhook appends the <code>rsyslog-configurator.service</code> unit to the OperatingSystemConfig units. The unit invokes the <code>configure-rsyslog.sh</code> script every 15 seconds.</li></ol></li></ol><h3 id=extension-disablement>Extension Disablement<a class=td-heading-self-link href=#extension-disablement aria-label="Heading self-link"></a></h3><p>This section outlines how the extension disablement works, i.e., the extension has to be removed from the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, the gardenlet destroys the <a href=https://github.com/gardener/gardener/blob/v1.82.0/docs/extensions/extension.md>Extension</a> resource because it is no longer needed.<ol><li>As part of the deletion flow, the shoot-rsyslog-relp extension deploys the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/component/rsyslogrelpconfigcleaner/rsyslog_relp_config_cleaner.go><code>rsyslog-relp-configuration-cleaner</code> DaemonSet</a> to the Shoot cluster to clean up the existing rsyslog configuration and revert the audit rules.</li></ol></li></ol><h2 id=shoot-deletion>Shoot Deletion<a class=td-heading-self-link href=#shoot-deletion aria-label="Heading self-link"></a></h2><p>This section outlines how the deletion works for a Shoot with the shoot-rsyslog-relp extension enabled.</p><ol><li>As part of the Shoot deletion flow, the gardenlet destroys the <a href=https://github.com/gardener/gardener/blob/v1.82.0/docs/extensions/extension.md>Extension</a> resource.<ol><li>In the Shoot deletion flow, the Extension resource is deleted after the Worker resource. Hence, there is no need to deploy the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/component/rsyslogrelpconfigcleaner/rsyslog_relp_config_cleaner.go><code>rsyslog-relp-configuration-cleaner</code> DaemonSet</a> to the Shoot cluster to clean up the existing rsyslog configuration and revert the audit rules.</li></ol></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-4872a011abb88ad2166ddf01e06b0631>7 - OpenID Connect services</h1><div class=lead>Gardener extension controller for OpenID Connect services for shoot clusters</div><h1 id=gardener-extension-for-openid-connect-serviceshttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for openid connect services</a><a class=td-heading-self-link href=#gardener-extension-for-openid-connect-serviceshttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-oidc-service><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-oidc-service alt="REUSE status"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the <code>shoot-oidc-service</code> extension.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-shoot-oidc-service/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=compatibility>Compatibility<a class=td-heading-self-link href=#compatibility aria-label="Heading self-link"></a></h2><p>The following lists compatibility requirements of this extension controller with regards to other Gardener components.</p><table><thead><tr><th>OIDC Extension</th><th>Gardener</th><th>Notes</th></tr></thead><tbody><tr><td><code>== v0.15.0</code></td><td><code>>= 1.60.0 &lt;= v1.64.0</code></td><td>A typical side-effect when running Gardener &lt; v1.63.0 is an unexpected scale-down of the OIDC webhook from <code>2 -> 1</code>.</td></tr><tr><td><code>== v0.16.0</code></td><td><code>>= 1.65.0</code></td><td></td></tr></tbody></table><hr><h2 id=extension-resources>Extension Resources<a class=td-heading-self-link href=#extension-resources aria-label="Heading self-link"></a></h2><p>Example extension resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Extension
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-oidc-service
</span></span><span style=display:flex><span>  namespace: shoot--project--abc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: shoot-oidc-service
</span></span></code></pre></div><p>When an extension resource is reconciled, the extension controller will create an instance of <a href=https://github.com/gardener/oidc-webhook-authenticator>OIDC Webhook Authenticator</a>. These resources are placed inside the shoot namespace on the seed. Also, the controller takes care about generating necessary <code>RBAC</code> resources for the seed as well as for the shoot.</p><p>Please note, this extension controller relies on the <a href=/docs/gardener/concepts/resource-manager/>Gardener-Resource-Manager</a> to deploy k8s resources to seed and shoot clusters.</p><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>.</p><p>We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-oidc-service/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-486a89ff012d57a06dd34631cf82838a>7.1 - Deployment</h1><h1 id=gardener-oidc-service-for-shoots>Gardener OIDC Service for Shoots<a class=td-heading-self-link href=#gardener-oidc-service-for-shoots aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener allows Shoot clusters to dynamically register OpenID Connect providers. To support this the Gardener must be installed with the <code>shoot-oidc-service</code> extension.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>To generally enable the OIDC service for shoot objects the <code>shoot-oidc-service</code> extension must be registered by providing an appropriate <a href=https://github.com/gardener/gardener-extension-shoot-oidc-service/blob/master/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots the <code>globallyEnabled</code> flag should be set to <code>true</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - kind: Extension
</span></span><span style=display:flex><span>      type: shoot-oidc-service
</span></span><span style=display:flex><span>      globallyEnabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h3><p>If the shoot OIDC service is not globally enabled by default (depends on the extension registration on the garden cluster), it can be enabled per shoot. To enable the service for a shoot, the shoot manifest must explicitly add the <code>shoot-oidc-service</code> extension.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-oidc-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>If the shoot OIDC service is globally enabled by default, it can be disabled per shoot. To disable the service for a shoot, the shoot manifest must explicitly state it.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-oidc-service
</span></span><span style=display:flex><span>      disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-22a2de35d1bea1230de182b1da4a55fc>7.2 - Openidconnects</h1><h1 id=register-openid-connect-provider-in-shoot-clusters>Register OpenID Connect provider in Shoot Clusters<a class=td-heading-self-link href=#register-openid-connect-provider-in-shoot-clusters aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Within a shoot cluster, it is possible to dynamically register OpenID Connect providers. It is necessary that the Gardener installation your shoot cluster runs in is equipped with a <code>shoot-oidc-service</code> extension. Please ask your Gardener operator if the extension is available in your environment.</p><blockquote class="alert alert-important"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>message-outline</title><path d="M20 2H4C2.9 2 2 2.9 2 4V22l4-4H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2m0 14H5.2L4 17.2V4H20V16z"/></svg><p>Important</p></div><p>Kubernetes v1.29 introduced support for <a href=https://kubernetes.io/blog/2024/04/25/structured-authentication-moves-to-beta/>Structured Authentication</a>.
Gardener allows the use of this feature for shoot clusters with Kubernetes version >= 1.30.</p><p>Structured Authentication should be preferred over the Gardener OIDC Extension in case:</p><ul><li>you do not need more than 64 authenticators (a limitation that is tracked in <a href=https://github.com/kubernetes/kubernetes/issues/122809>https://github.com/kubernetes/kubernetes/issues/122809</a>)</li><li>you do not need to register an issuer twice (anyways not recommended since it can lead to misconfiguration and user impersonation if done poorly)</li><li>you need the ability to write custom expressions to map and validate claims</li><li>you need support for multiple audiences per authenticator</li><li>you need support for providers that don&rsquo;t support OpenID connect discovery</li></ul><p>See how to make use of <a href=https://gardener.cloud/docs/gardener/shoot/shoot_access/#structured-authentication>Structured Authentication in Gardener</a>.</p></blockquote><h2 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h2><p>In most of the Gardener setups the <code>shoot-oidc-service</code> extension is not enabled globally and thus must be configured per shoot cluster. Please adapt the shoot specification by the configuration shown below to activate the extension individually.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-oidc-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=openid-connect-provider>OpenID Connect provider<a class=td-heading-self-link href=#openid-connect-provider aria-label="Heading self-link"></a></h2><p>In order to register an OpenID Connect provider an <code>openidconnect</code> resource should be deployed in the shoot cluster.</p><blockquote class="alert alert-caution"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-octagon-outline</title><path d="M8.27 3 3 8.27v7.46L8.27 21h7.46C17.5 19.24 21 15.73 21 15.73V8.27L15.73 3M9.1 5h5.8L19 9.1v5.8L14.9 19H9.1L5 14.9V9.1M11 15h2v2H11V15m0-8h2v6H11V7"/></svg><p>Caution</p></div><p>It is <strong>strongly</strong> recommended to <strong>NOT</strong> disable prefixing since it may result in unwanted impersonations.
The rule of thumb is to always use meaningful and unique prefixes for both <code>username</code> and <code>groups</code>.
A good way to ensure this is to use the name of the <code>openidconnect</code> resource as shown in the example below.</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: authentication.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: OpenIDConnect
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: abc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  <span style=color:green># issuerURL is the URL the provider signs ID Tokens as.</span>
</span></span><span style=display:flex><span>  <span style=color:green># This will be the &#34;iss&#34; field of all tokens produced by the provider and is used for configuration discovery.</span>
</span></span><span style=display:flex><span>  issuerURL: https://abc-oidc-provider.example
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># clientID is the audience for which the JWT must be issued for, the &#34;aud&#34; field.</span>
</span></span><span style=display:flex><span>  clientID: my-shoot-cluster
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># usernameClaim is the JWT field to use as the user&#39;s username.</span>
</span></span><span style=display:flex><span>  usernameClaim: sub
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># usernamePrefix, if specified, causes claims mapping to username to be prefix with the provided value.</span>
</span></span><span style=display:flex><span>  <span style=color:green># A value &#34;oidc:&#34; would result in usernames like &#34;oidc:john&#34;.</span>
</span></span><span style=display:flex><span>  <span style=color:green># If not provided, the prefix defaults to &#34;( .metadata.name )/&#34;. The value &#34;-&#34; can be used to disable all prefixing.</span>
</span></span><span style=display:flex><span>  usernamePrefix: <span style=color:#a31515>&#34;abc:&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># groupsClaim, if specified, causes the OIDCAuthenticator to try to populate the user&#39;s groups with an ID Token field.</span>
</span></span><span style=display:flex><span>  <span style=color:green># If the groupsClaim field is present in an ID Token the value must be a string or list of strings.</span>
</span></span><span style=display:flex><span>  <span style=color:green># groupsClaim: groups</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># groupsPrefix, if specified, causes claims mapping to group names to be prefixed with the value.</span>
</span></span><span style=display:flex><span>  <span style=color:green># A value &#34;oidc:&#34; would result in groups like &#34;oidc:engineering&#34; and &#34;oidc:marketing&#34;.</span>
</span></span><span style=display:flex><span>  <span style=color:green># If not provided, the prefix defaults to &#34;( .metadata.name )/&#34;.</span>
</span></span><span style=display:flex><span>  <span style=color:green># The value &#34;-&#34; can be used to disable all prefixing.</span>
</span></span><span style=display:flex><span>  <span style=color:green># groupsPrefix: &#34;abc:&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># caBundle is a PEM encoded CA bundle which will be used to validate the OpenID server&#39;s certificate. If unspecified, system&#39;s trusted certificates are used.</span>
</span></span><span style=display:flex><span>  <span style=color:green># caBundle: &lt;base64 encoded bundle&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># supportedSigningAlgs sets the accepted set of JOSE signing algorithms that can be used by the provider to sign tokens.</span>
</span></span><span style=display:flex><span>  <span style=color:green># The default value is RS256.</span>
</span></span><span style=display:flex><span>  <span style=color:green># supportedSigningAlgs:</span>
</span></span><span style=display:flex><span>  <span style=color:green># - RS256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># requiredClaims, if specified, causes the OIDCAuthenticator to verify that all the</span>
</span></span><span style=display:flex><span>  <span style=color:green># required claims key value pairs are present in the ID Token.</span>
</span></span><span style=display:flex><span>  <span style=color:green># requiredClaims:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   customclaim: requiredvalue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># maxTokenExpirationSeconds if specified, sets a limit in seconds to the maximum validity duration of a token.</span>
</span></span><span style=display:flex><span>  <span style=color:green># Tokens issued with validity greater that this value will not be verified.</span>
</span></span><span style=display:flex><span>  <span style=color:green># Setting this will require that the tokens have the &#34;iat&#34; and &#34;exp&#34; claims.</span>
</span></span><span style=display:flex><span>  <span style=color:green># maxTokenExpirationSeconds: 3600</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># jwks if specified, provides an option to specify JWKS keys offline.</span>
</span></span><span style=display:flex><span>  <span style=color:green># jwks:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   keys is a base64 encoded JSON webkey Set. If specified, the OIDCAuthenticator skips the request to the issuer&#39;s jwks_uri endpoint to retrieve the keys.</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   keys: &lt;base64 encoded jwks&gt;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-a725bc0c0d89baaccba25cbb56b86675>8 - Registry cache</h1><div class=lead>Gardener extension controller which deploys pull-through caches for container registries.</div><h1 id=gardener-extension-for-registry-cachehttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Registry Cache</a><a class=td-heading-self-link href=#gardener-extension-for-registry-cachehttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-registry-cache><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-registry-cache alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-registry-cache-main/jobs/main-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-registry-cache-main/jobs/main-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-registry-cache><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-registry-cache alt="Go Report Card"></a></p><p>Gardener extension controller which deploys pull-through caches for container registries.</p><h2 id=usage>Usage<a class=td-heading-self-link href=#usage aria-label="Heading self-link"></a></h2><ul><li><a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/configuration/>Configuring the Registry Cache Extension</a> - learn what is the use-case for a pull-through cache, how to enable it and configure it</li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/upstream-credentials/>How to provide credentials for upstream repository?</a></li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/observability/>Registry Cache Observability</a> - learn what metrics and alerts are exposed and how to view the registry cache logs</li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/registry-mirror/configuration/>Configuring the Registry Mirror Extension</a> - learn what is the use-case for a registry mirror, how to enable and configure it</li></ul><h2 id=local-setup-and-development>Local Setup and Development<a class=td-heading-self-link href=#local-setup-and-development aria-label="Heading self-link"></a></h2><ul><li><a href=/docs/extensions/others/gardener-extension-registry-cache/getting-started-locally/>Deploying Registry Cache Extension Locally</a> - learn how to set up a local development environment</li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/getting-started-remotely/>Deploying Registry Cache Extension in Gardener&rsquo;s Local Setup with Provider Extensions</a> - learn how to set up a development environment using own Seed clusters on an existing Kubernetes cluster</li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/extension-registry-cache/>Developer Docs for Gardener Extension Registry Cache</a> - learn about the inner workings</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b3f12d97b4af322636c2e0cc80685cc8>8.1 - Configuring the Registry Cache Extension</h1><div class=lead>Learn what is the use-case for a pull-through cache, how to enable it and configure it</div><h1 id=configuring-the-registry-cache-extension>Configuring the Registry Cache Extension<a class=td-heading-self-link href=#configuring-the-registry-cache-extension aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><h3 id=use-case>Use Case<a class=td-heading-self-link href=#use-case aria-label="Heading self-link"></a></h3><p>For a Shoot cluster, the containerd daemon of every Node goes to the internet and fetches an image that it doesn&rsquo;t have locally in the Node&rsquo;s image cache. New Nodes are often created due to events such as auto-scaling (scale up), rolling update, or replacement of unhealthy Node. Such a new Node would need to pull all of the images of the Pods running on it from the internet because the Node&rsquo;s cache is initially empty. Pulling an image from a registry produces network traffic and registry costs. To avoid these network traffic and registry costs, you can use the registry-cache extension to run a registry as pull-through cache.</p><p>The following diagram shows a rough outline of how an image pull looks like for a Shoot cluster <strong>without registry cache</strong>:
<img src=/__resources/shoot-cluster-without-registry-cache_e266ba.png alt=shoot-cluster-without-registry-cache></p><h3 id=solution>Solution<a class=td-heading-self-link href=#solution aria-label="Heading self-link"></a></h3><p>The registry-cache extension deploys and manages a registry in the Shoot cluster that runs as pull-through cache. The used registry implementation is <a href=https://github.com/distribution/distribution>distribution/distribution</a>.</p><h3 id=how-does-it-work>How does it work?<a class=td-heading-self-link href=#how-does-it-work aria-label="Heading self-link"></a></h3><p>When the extension is enabled, a registry cache for each configured upstream is deployed to the Shoot cluster. Along with this, the containerd daemon on the Shoot cluster Nodes gets configured to use as a mirror the Service IP address of the deployed registry cache. For example, if a registry cache for upstream <code>docker.io</code> is requested via the Shoot spec, then containerd gets configured to first pull the image from the deployed cache in the Shoot cluster. If this image pull operation fails, containerd falls back to the upstream itself (<code>docker.io</code> in that case).</p><p>The first time an image is requested from the pull-through cache, it pulls the image from the configured upstream registry and stores it locally, before handing it back to the client. On subsequent requests, the pull-through cache is able to serve the image from its own storage.</p><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>The used registry implementation (<a href=https://github.com/distribution/distribution>distribution/distribution</a>) supports mirroring of only one upstream registry.</p></blockquote><p>The following diagram shows a rough outline of how an image pull looks like for a Shoot cluster <strong>with registry cache</strong>:
<img src=/__resources/shoot-cluster-with-registry-cache_9e6b5f.png alt=shoot-cluster-with-registry-cache></p><h2 id=shoot-configuration>Shoot Configuration<a class=td-heading-self-link href=#shoot-configuration aria-label="Heading self-link"></a></h2><p>The extension is not globally enabled and must be configured per Shoot cluster. The Shoot specification has to be adapted to include the <code>registry-cache</code> extension configuration.</p><p>Below is an example of <code>registry-cache</code> extension configuration as part of the Shoot spec:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: crazy-botany
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: registry-cache
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: registry.extensions.gardener.cloud/v1alpha3
</span></span><span style=display:flex><span>      kind: RegistryConfig
</span></span><span style=display:flex><span>      caches:
</span></span><span style=display:flex><span>      - upstream: docker.io
</span></span><span style=display:flex><span>        volume:
</span></span><span style=display:flex><span>          size: 100Gi
</span></span><span style=display:flex><span>          <span style=color:green># storageClassName: premium</span>
</span></span><span style=display:flex><span>      - upstream: ghcr.io
</span></span><span style=display:flex><span>      - upstream: quay.io
</span></span><span style=display:flex><span>        garbageCollection:
</span></span><span style=display:flex><span>          ttl: 0s
</span></span><span style=display:flex><span>        secretReferenceName: quay-credentials
</span></span><span style=display:flex><span>      - upstream: my-registry.io:5000
</span></span><span style=display:flex><span>        remoteURL: http://my-registry.io:5000
</span></span><span style=display:flex><span>  <span style=color:green># ...</span>
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - name: quay-credentials
</span></span><span style=display:flex><span>    resourceRef:
</span></span><span style=display:flex><span>      apiVersion: v1
</span></span><span style=display:flex><span>      kind: Secret
</span></span><span style=display:flex><span>      name: quay-credentials-v1
</span></span></code></pre></div><p>The <code>providerConfig</code> field is required.</p><p>The <code>providerConfig.caches</code> field contains information about the registry caches to deploy. It is a required field. At least one cache has to be specified.</p><p>The <code>providerConfig.caches[].upstream</code> field is the remote registry host to cache. It is a required field.
The value must be a valid DNS subdomain (RFC 1123) and optionally a port (i.e. <code>&lt;host>[:&lt;port>]</code>). It must not include a scheme.</p><p>The <code>providerConfig.caches[].remoteURL</code> optional field is the remote registry URL. If configured, it must include an <code>https://</code> or <code>http://</code> scheme.
If the field is not configured, the remote registry URL defaults to <code>https://&lt;upstream></code>. In case the upstream is <code>docker.io</code>, it defaults to <code>https://registry-1.docker.io</code>.</p><p>The <code>providerConfig.caches[].volume</code> field contains settings for the registry cache volume.
The registry-cache extension deploys a StatefulSet with a volume claim template. A PersistentVolumeClaim is created with the configured size and StorageClass name.</p><p>The <code>providerConfig.caches[].volume.size</code> field is the size of the registry cache volume. Defaults to <code>10Gi</code>. The size must be a positive quantity (greater than 0).
This field is immutable. See <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/configuration/#increase-the-cache-disk-size>Increase the cache disk size</a> on how to resize the disk.
The extension defines alerts for the volume. More information about the registry cache alerts and how to enable notifications for them can be found in the <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/observability/#alerts>alerts documentation</a>.</p><p>The <code>providerConfig.caches[].volume.storageClassName</code> field is the name of the StorageClass used by the registry cache volume.
This field is immutable. If the field is not specified, then the <a href=https://kubernetes.io/docs/concepts/storage/storage-classes/#default-storageclass>default StorageClass</a> will be used.</p><p>The <code>providerConfig.caches[].garbageCollection.ttl</code> field is the time to live of a blob in the cache. If the field is set to <code>0s</code>, the garbage collection is disabled. Defaults to <code>168h</code> (7 days). See the <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/configuration/#garbage-collection>Garbage Collection section</a> for more details.</p><p>The <code>providerConfig.caches[].secretReferenceName</code> is the name of the reference for the Secret containing the upstream registry credentials. To cache images from a private registry, credentials to the upstream registry should be supplied. For more details, see <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/upstream-credentials/#how-to-provide-credentials-for-upstream-registry>How to provide credentials for upstream registry</a>.</p><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>It is only possible to provide one set of credentials for one private upstream registry.</p></blockquote><p>The <code>providerConfig.caches[].proxy.httpProxy</code> field represents the proxy server for HTTP connections which is used by the registry cache. It must include an <code>https://</code> or <code>http://</code> scheme.</p><p>The <code>providerConfig.caches[].proxy.httpsProxy</code> field represents the proxy server for HTTPS connections which is used by the registry cache. It must include an <code>https://</code> or <code>http://</code> scheme.</p><p>The <code>providerConfig.caches[].http.tls</code> field indicates whether TLS is enabled for the HTTP server of the registry cache. Defaults to <code>true</code>.</p><h2 id=garbage-collection>Garbage Collection<a class=td-heading-self-link href=#garbage-collection aria-label="Heading self-link"></a></h2><p>When the registry cache receives a request for an image that is not present in its local store, it fetches the image from the upstream, returns it to the client and stores the image in the local store. The registry cache runs a scheduler that deletes images when their time to live (ttl) expires. When adding an image to the local store, the registry cache also adds a time to live for the image. The ttl defaults to <code>168h</code> (7 days) and is configurable. The garbage collection can be disabled by setting the ttl to <code>0s</code>. Requesting an image from the registry cache does not extend the time to live of the image. Hence, an image is always garbage collected from the registry cache store when its ttl expires.
At the time of writing this document, there is no functionality for garbage collection based on disk size - e.g., garbage collecting images when a certain disk usage threshold is passed.
The garbage collection cannot be enabled once it is disabled. This constraint is added to mitigate <a href=https://github.com/distribution/distribution/issues/4249>distribution/distribution#4249</a>.</p><h2 id=increase-the-cache-disk-size>Increase the Cache Disk Size<a class=td-heading-self-link href=#increase-the-cache-disk-size aria-label="Heading self-link"></a></h2><p>When there is no available disk space, the registry cache continues to respond to requests. However, it cannot store the remotely fetched images locally because it has no free disk space. In such case, it is simply acting as a proxy without being able to cache the images in its local store. The disk has to be resized to ensure that the registry cache continues to cache images.</p><p>There are two alternatives to enlarge the cache&rsquo;s disk size:</p><h3 id=alternative-1-resize-the-pvc>[Alternative 1] Resize the PVC<a class=td-heading-self-link href=#alternative-1-resize-the-pvc aria-label="Heading self-link"></a></h3><p>To enlarge the PVC&rsquo;s size, perform the following steps:</p><ol><li><p>Make sure that the <code>KUBECONFIG</code> environment variable is targeting the correct Shoot cluster.</p></li><li><p>Find the PVC name to resize for the desired upstream. The below example fetches the PVC for the <code>docker.io</code> upstream:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n kube-system get pvc -l upstream-host=docker.io
</span></span></code></pre></div></li><li><p>Patch the PVC&rsquo;s size to the desired size. The below example patches the size of a PVC to <code>10Gi</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n kube-system patch pvc $PVC_NAME --type merge -p <span style=color:#a31515>&#39;{&#34;spec&#34;:{&#34;resources&#34;:{&#34;requests&#34;: {&#34;storage&#34;: &#34;10Gi&#34;}}}}&#39;</span>
</span></span></code></pre></div></li><li><p>Make sure that the PVC gets resized. Describe the PVC to check the resize operation result:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n kube-system describe pvc -l upstream-host=docker.io
</span></span></code></pre></div></li></ol><blockquote><p>Drawback of this approach: The cache&rsquo;s size in the Shoot spec (<code>providerConfig.caches[].size</code>) diverges from the PVC&rsquo;s size.</p></blockquote><h3 id=alternative-2-remove-and-readd-the-cache>[Alternative 2] Remove and Readd the Cache<a class=td-heading-self-link href=#alternative-2-remove-and-readd-the-cache aria-label="Heading self-link"></a></h3><p>There is always the option to remove the cache from the Shoot spec and to readd it again with the updated size.</p><blockquote><p>Drawback of this approach: The already cached images get lost and the cache starts with an empty disk.</p></blockquote><h2 id=high-availability>High Availability<a class=td-heading-self-link href=#high-availability aria-label="Heading self-link"></a></h2><p>The registry cache runs with a single replica. This fact may lead to concerns for the high availability such as &ldquo;What happens when the registry cache is down? Does containerd fail to pull the image?&rdquo;. As outlined in the <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/configuration/#how-does-it-work>How does it work? section</a>, containerd is configured to fall back to the upstream registry if it fails to pull the image from the registry cache. Hence, when the registry cache is unavailable, the containerd&rsquo;s image pull operations are not affected because containerd falls back to image pull from the upstream registry.</p><h2 id=possible-pitfalls>Possible Pitfalls<a class=td-heading-self-link href=#possible-pitfalls aria-label="Heading self-link"></a></h2><ul><li>The used registry implementation (the <a href=https://github.com/distribution/distribution>Distribution project</a>) supports mirroring of only one upstream registry. The extension deploys a pull-through cache for each configured upstream.</li><li><code>us-docker.pkg.dev</code>, <code>europe-docker.pkg.dev</code>, and <code>asia-docker.pkg.dev</code> are different upstreams. Hence, configuring <code>pkg.dev</code> as upstream won&rsquo;t cache images from <code>us-docker.pkg.dev</code>, <code>europe-docker.pkg.dev</code>, or <code>asia-docker.pkg.dev</code>.</li></ul><h2 id=limitations>Limitations<a class=td-heading-self-link href=#limitations aria-label="Heading self-link"></a></h2><ol><li><p>Images that are pulled before a registry cache Pod is running or before a registry cache Service is reachable from the corresponding Node won&rsquo;t be cached - containerd will pull these images directly from the upstream.</p><p>The reasoning behind this limitation is that a registry cache Pod is running in the Shoot cluster. To have a registry cache&rsquo;s Service cluster IP reachable from containerd running on the Node, the registry cache Pod has to be running and kube-proxy has to configure iptables/IPVS rules for the registry cache Service. If kube-proxy hasn&rsquo;t configured iptables/IPVS rules for the registry cache Service, then the image pull times (and new Node bootstrap times) will be increased significantly. For more detailed explanations, see point 2. and <a href=https://github.com/gardener/gardener-extension-registry-cache/pull/68>gardener/gardener-extension-registry-cache#68</a>.</p><p>That&rsquo;s why the registry configuration on a Node is applied only after the registry cache Service is reachable from the Node. The <code>gardener-node-agent.service</code> systemd unit sends requests to the registry cache&rsquo;s Service. Once the registry cache responds with <code>HTTP 200</code>, the unit creates the needed registry configuration file (<code>hosts.toml</code>).</p><p>As a result, for images from Shoot system components:</p><ul><li>On Shoot creation with the registry cache extension enabled, a registry cache is unable to cache all of the images from the Shoot system components. Usually, until the registry cache Pod is running, containerd pulls from upstream the images from Shoot system components (before the registry configuration gets applied).</li><li>On new Node creation for existing Shoot with the registry cache extension enabled, a registry cache is unable to cache most of the images from Shoot system components. The reachability of the registry cache Service requires the Service network to be set up, i.e., the kube-proxy for that new Node to be running and to have set up iptables/IPVS configuration for the registry cache Service.</li></ul></li><li><p>containerd requests will time out in 30s in case kube-proxy hasn&rsquo;t configured iptables/IPVS rules for the registry cache Service - the image pull times will increase significantly.</p><p>containerd is configured to fall back to the upstream itself if a request against the cache fails. However, if the cluster IP of the registry cache Service does not exist or if kube-proxy hasn&rsquo;t configured iptables/IPVS rules for the registry cache Service, then containerd requests against the registry cache time out in 30 seconds. This significantly increases the image pull times because containerd does multiple requests as part of the image pull (HEAD request to resolve the manifest by tag, GET request for the manifest by SHA, GET requests for blobs)</p><p>Example: If the Service of a registry cache is deleted, then a new Service will be created. containerd&rsquo;s registry config will still contain the old Service&rsquo;s cluster IP. containerd requests against the old Service&rsquo;s cluster IP will time out and containerd will fall back to upstream.</p><ul><li>Image pull of <code>docker.io/library/alpine:3.13.2</code> from the upstream takes ~2s while image pull of the same image with invalid registry cache cluster IP takes ~2m.2s.</li><li>Image pull of <code>eu.gcr.io/gardener-project/gardener/ops-toolbelt:0.18.0</code> from the upstream takes ~10s while image pull of the same image with invalid registry cache cluster IP takes ~3m.10s.</li></ul></li><li><p>Amazon Elastic Container Registry is currently not supported. For details see <a href=https://github.com/distribution/distribution/issues/4383>distribution/distribution#4383</a>.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-5d2cb16601b6838a4a67ba8b5a7ae2f4>8.2 - Configuring the Registry Mirror Extension</h1><div class=lead>Learn what is the use-case for a registry mirror, how to enable and configure it</div><h1 id=configuring-the-registry-mirror-extension>Configuring the Registry Mirror Extension<a class=td-heading-self-link href=#configuring-the-registry-mirror-extension aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><h3 id=use-case>Use Case<a class=td-heading-self-link href=#use-case aria-label="Heading self-link"></a></h3><p>containerd allows registry mirrors to be configured. Use cases are:</p><ul><li>Usage of public mirror(s) - for example, circumvent issues with the upstream registry such as rate limiting, outages, and others.</li><li>Usage of private mirror(s) - for example, reduce network costs by using a private mirror running in the same network.</li></ul><h3 id=solution>Solution<a class=td-heading-self-link href=#solution aria-label="Heading self-link"></a></h3><p>The registry-mirror extension allows the registry mirror configuration to be configured via the Shoot spec directly.</p><h3 id=how-does-it-work>How does it work?<a class=td-heading-self-link href=#how-does-it-work aria-label="Heading self-link"></a></h3><p>When the extension is enabled, the containerd daemon on the Shoot cluster Nodes gets configured to use the requested mirrors as a mirror. For example, if for the upstream <code>docker.io</code> the mirror <code>https://mirror.gcr.io</code> is configured in the Shoot spec, then containerd gets configured to first pull the image from the mirror (<code>https://mirror.gcr.io</code> in that case). If this image pull operation fails, containerd falls back to the upstream itself (<code>docker.io</code> in that case).</p><p>The extension is based on the contract described in <a href=/docs/gardener/advanced/containerd-registry-configuration/><code>containerd</code> Registry Configuration</a>. The corresponding upstream documentation in containerd is <a href=https://github.com/containerd/containerd/blob/v1.7.0/docs/hosts.md>Registry Configuration - Introduction</a>.</p><h2 id=shoot-configuration>Shoot Configuration<a class=td-heading-self-link href=#shoot-configuration aria-label="Heading self-link"></a></h2><p>The Shoot specification has to be adapted to include the <code>registry-mirror</code> extension configuration.</p><p>Below is an example of <code>registry-mirror</code> extension configuration as part of the Shoot spec:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: crazy-botany
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: registry-mirror
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: mirror.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: MirrorConfig
</span></span><span style=display:flex><span>      mirrors:
</span></span><span style=display:flex><span>      - upstream: docker.io
</span></span><span style=display:flex><span>        hosts:
</span></span><span style=display:flex><span>        - host: <span style=color:#a31515>&#34;https://mirror.gcr.io&#34;</span>
</span></span><span style=display:flex><span>          capabilities: [<span style=color:#a31515>&#34;pull&#34;</span>]
</span></span></code></pre></div><p>The <code>providerConfig</code> field is required.</p><p>The <code>providerConfig.mirrors</code> field contains information about the registry mirrors to configure. It is a required field. At least one mirror has to be specified.</p><p>The <code>providerConfig.mirror[].upstream</code> field is the remote registry host to mirror. It is a required field.
The value must be a valid DNS subdomain (RFC 1123) and optionally a port (i.e. <code>&lt;host>[:&lt;port>]</code>). It must not include a scheme.</p><p>The <code>providerConfig.mirror[].hosts</code> field represents the mirror hosts to be used for the upstream. At least one mirror host has to be specified.</p><p>The <code>providerConfig.mirror[].hosts[].host</code> field is the mirror host. It is a required field.
The value must include a scheme - <code>http://</code> or <code>https://</code>.</p><p>The <code>providerConfig.mirror[].hosts[].capabilities</code> field represents the operations a host is capable of performing. This also represents the set of operations for which the mirror host may be trusted to perform. Defaults to <code>["pull"]</code>. The supported values are <code>pull</code> and <code>resolve</code>.
See the <a href=https://github.com/containerd/containerd/blob/v1.7.0/docs/hosts.md#capabilities-field>capabilities field documentation</a> for more information on which operations are considered trusted ones against public/private mirrors.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-279dc2188cd014dd3864f373e1503c87>8.3 - Deploying Registry Cache Extension in Gardener's Local Setup with Provider Extensions</h1><div class=lead>Learn how to set up a development environment using own Seed clusters on an existing Kubernetes cluster</div><h1 id=deploying-registry-cache-extension-in-gardeners-local-setup-with-provider-extensions>Deploying Registry Cache Extension in Gardener&rsquo;s Local Setup with Provider Extensions<a class=td-heading-self-link href=#deploying-registry-cache-extension-in-gardeners-local-setup-with-provider-extensions aria-label="Heading self-link"></a></h1><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>Make sure that you have a running local Gardener setup with enabled provider extensions. The steps to complete this can be found in the <a href=/docs/gardener/deployment/getting_started_locally_with_extensions/>Deploying Gardener Locally and Enabling Provider-Extensions</a> guide.</li></ul><h2 id=setting-up-the-registry-cache-extension>Setting up the Registry Cache Extension<a class=td-heading-self-link href=#setting-up-the-registry-cache-extension aria-label="Heading self-link"></a></h2><p>Make sure that your <code>KUBECONFIG</code> environment variable is targeting the local Gardener cluster.</p><p>The location of the Gardener project from the Gardener setup step is expected to be under the same root (e.g. <code>~/go/src/github.com/gardener/</code>). If this is not the case, the location of Gardener project should be specified in <code>GARDENER_REPO_ROOT</code> environment variable:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export GARDENER_REPO_ROOT=<span style=color:#a31515>&#34;&lt;path_to_gardener_project&gt;&#34;</span>
</span></span></code></pre></div><p>Then you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-up
</span></span></code></pre></div><p>In case you have added additional Seeds you can specify the seed name:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-up SEED_NAME=&lt;seed-name&gt;
</span></span></code></pre></div><p>The corresponding make target will build the extension image, push it into the Seed cluster image registry, and deploy the registry-cache ControllerDeployment and ControllerRegistration resources into the kind cluster.
The container image in the ControllerDeployment will be the image that was build and pushed into the Seed cluster image registry.</p><p>The make target will then deploy the registry-cache admission component. It will build the admission image, push it into the kind cluster image registry, and finally install the admission component charts to the kind cluster.</p><h2 id=creating-a-shoot-cluster>Creating a Shoot Cluster<a class=td-heading-self-link href=#creating-a-shoot-cluster aria-label="Heading self-link"></a></h2><p>Once the above step is completed, you can create a Shoot cluster. In order to create a Shoot cluster, please create your own Shoot definition depending on providers on your Seed cluster.</p><h2 id=tearing-down-the-development-environment>Tearing Down the Development Environment<a class=td-heading-self-link href=#tearing-down-the-development-environment aria-label="Heading self-link"></a></h2><p>To tear down the development environment, delete the Shoot cluster or disable the <code>registry-cache</code> extension in the Shoot&rsquo;s specification. When the extension is not used by the Shoot anymore, you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-down
</span></span></code></pre></div><p>The make target will delete the ControllerDeployment and ControllerRegistration of the extension, and the registry-cache admission helm deployment.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6292d6e3adb445c003eb0156582838fc>8.4 - Deploying Registry Cache Extension Locally</h1><div class=lead>Learn how to set up a local development environment</div><h1 id=deploying-registry-cache-extension-locally>Deploying Registry Cache Extension Locally<a class=td-heading-self-link href=#deploying-registry-cache-extension-locally aria-label="Heading self-link"></a></h1><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>Make sure that you have a running local Gardener setup. The steps to complete this can be found in the <a href=/docs/gardener/deployment/getting_started_locally/>Deploying Gardener Locally guide</a>.</li></ul><h2 id=setting-up-the-registry-cache-extension>Setting up the Registry Cache Extension<a class=td-heading-self-link href=#setting-up-the-registry-cache-extension aria-label="Heading self-link"></a></h2><p>Make sure that your <code>KUBECONFIG</code> environment variable is targeting the local Gardener cluster. When this is ensured, run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-up
</span></span></code></pre></div><p>The corresponding make target will build the extension image, load it into the kind cluster Nodes, and deploy the registry-cache ControllerDeployment and ControllerRegistration resources. The container image in the ControllerDeployment will be the image that was build and loaded into the kind cluster Nodes.</p><p>The make target will then deploy the registry-cache admission component. It will build the admission image, load it into the kind cluster Nodes, and finally install the admission component charts to the kind cluster.</p><h2 id=creating-a-shoot-cluster>Creating a Shoot Cluster<a class=td-heading-self-link href=#creating-a-shoot-cluster aria-label="Heading self-link"></a></h2><p>Once the above step is completed, you can create a Shoot cluster.</p><p><a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/example/shoot-registry-cache.yaml><code>example/shoot-registry-cache.yaml</code></a> contains a Shoot specification with the <code>registry-cache</code> extension:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f example/shoot-registry-cache.yaml
</span></span></code></pre></div><p><a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/example/shoot-registry-mirror.yaml><code>example/shoot-registry-mirror.yaml</code></a> contains a Shoot specification with the <code>registry-mirror</code> extension:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f example/shoot-registry-mirror.yaml
</span></span></code></pre></div><h2 id=tearing-down-the-development-environment>Tearing Down the Development Environment<a class=td-heading-self-link href=#tearing-down-the-development-environment aria-label="Heading self-link"></a></h2><p>To tear down the development environment, delete the Shoot cluster or disable the <code>registry-cache</code> extension in the Shoot&rsquo;s specification. When the extension is not used by the Shoot anymore, you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-down
</span></span></code></pre></div><p>The make target will delete the ControllerDeployment and ControllerRegistration of the extension, and the registry-cache admission helm deployment.</p><h2 id=alternative-setup-using-the-gardener-operator-local-setup>Alternative Setup Using the <code>gardener-operator</code> Local Setup<a class=td-heading-self-link href=#alternative-setup-using-the-gardener-operator-local-setup aria-label="Heading self-link"></a></h2><p>Alternatively, you can deploy the registry-cache extension in the <code>gardener-operator</code> local setup. To do this, make sure you are have a running local setup based on <a href=/docs/gardener/deployment/getting_started_locally/#alternative-way-to-set-up-garden-and-seed-leveraging-gardener-operator>Alternative Way to Set Up Garden and Seed Leveraging <code>gardener-operator</code></a>. The <code>KUBECONFIG</code> environment variable should target the operator local KinD cluster (i.e. <code>&lt;path_to_gardener_project>/example/gardener-local/kind/operator/kubeconfig</code>).</p><h4 id=creating-the-registry-cache-extensionoperatorgardenercloud-resource>Creating the registry-cache <code>Extension.operator.gardener.cloud</code> resource:<a class=td-heading-self-link href=#creating-the-registry-cache-extensionoperatorgardenercloud-resource aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-operator-up
</span></span></code></pre></div><p>The corresponding make target will build the registry-cache admission and extension container images, OCI artifacts for the admission runtime and application charts, and the extension chart. Then, the container images and the OCI artifacts are pushed into the default skaffold registry (i.e. <code>garden.local.gardener.cloud:5001</code>). Next, the registry-cache <code>Extension.operator.gardener.cloud</code> resource is deployed into the KinD cluster. Based on this resource the gardener-operator will deploy the registry-cache admission component, as well as the registry-cache ControllerDeployment and ControllerRegistration resources.</p><h4 id=creating-a-shoot-cluster-1>Creating a Shoot Cluster<a class=td-heading-self-link href=#creating-a-shoot-cluster-1 aria-label="Heading self-link"></a></h4><p>To create a Shoot cluster the <code>KUBECONFIG</code> environment variable should target virtual garden cluster (i.e. <code>&lt;path_to_gardener_project>/example/operator/virtual-garden/kubeconfig</code>) and then execute:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f example/shoot-registry-cache.yaml
</span></span></code></pre></div><h4 id=delete-the-registry-cache-extensionoperatorgardenercloud-resource>Delete the registry-cache <code>Extension.operator.gardener.cloud</code> resource<a class=td-heading-self-link href=#delete-the-registry-cache-extensionoperatorgardenercloud-resource aria-label="Heading self-link"></a></h4><p>Make sure the environment variable <code>KUBECONFIG</code> points to the operator&rsquo;s local KinD cluster and then run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-operator-down
</span></span></code></pre></div><p>The corresponding make target will delete the <code>Extension.operator.gardener.cloud</code> resource. Consequently, the gardener-operator will delete the registry-cache admission component and registry-cache ControllerDeployment and ControllerRegistration resources.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c7f55909c55d9671db41105c674d8223>8.5 - Developer Docs for Gardener Extension Registry Cache</h1><div class=lead>Learn about the inner workings</div><h1 id=developer-docs-for-gardener-extension-registry-cache>Developer Docs for Gardener Extension Registry Cache<a class=td-heading-self-link href=#developer-docs-for-gardener-extension-registry-cache aria-label="Heading self-link"></a></h1><p>This document outlines how Shoot reconciliation and deletion works for a Shoot with the registry-cache extension enabled.</p><h2 id=shoot-reconciliation>Shoot Reconciliation<a class=td-heading-self-link href=#shoot-reconciliation aria-label="Heading self-link"></a></h2><p>This section outlines how the reconciliation works for a Shoot with the registry-cache extension enabled.</p><h3 id=extension-enablement--reconciliation>Extension Enablement / Reconciliation<a class=td-heading-self-link href=#extension-enablement--reconciliation aria-label="Heading self-link"></a></h3><p>This section outlines how the extension enablement/reconciliation works, e.g., the extension has been added to the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, the gardenlet deploys the <a href=/docs/gardener/extensions/resources/extension/>Extension</a> resource.</li><li>The registry-cache extension reconciles the Extension resource. <a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/pkg/controller/cache/actuator.go>pkg/controller/cache/actuator.go</a> contains the implementation of the <a href=https://github.com/gardener/gardener/blob/v1.88.0/extensions/pkg/controller/extension/actuator.go>extension.Actuator</a> interface. The reconciliation of an Extension of type <code>registry-cache</code> consists of the following steps:<ol><li>The registry-cache extension deploys resources to the Shoot cluster via ManagedResource. For every configured upstream, it creates a StatefulSet (with PVC), Service, and other resources.</li><li>It lists all Services from the <code>kube-system</code> namespace that have the <code>upstream-host</code> label. It will return an error (and retry in exponential backoff) until the Services count matches the configured registries count.</li><li>When there is a Service created for each configured upstream registry, the registry-cache extension populates the Extension resource status. In the Extension status, for each upstream, it maintains an endpoint (in the format <code>http://&lt;cluster-ip>:5000</code>) which can be used to access the registry cache from within the Shoot cluster. <code>&lt;cluster-ip></code> is the cluster IP of the registry cache Service. The cluster IP of a Service is assigned by the Kubernetes API server on Service creation.</li></ol></li><li>As part of the Shoot reconciliation flow, the gardenlet deploys the <a href=/docs/gardener/extensions/resources/operatingsystemconfig/>OperatingSystemConfig</a> resource.</li><li>The registry-cache extension serves a webhook that mutates the OperatingSystemConfig resource for Shoots having the registry-cache extension enabled (the corresponding namespace gets labeled by the gardenlet with <code>extensions.gardener.cloud/registry-cache=true</code>). <a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/pkg/webhook/cache/ensurer.go>pkg/webhook/cache/ensurer.go</a> contains an implementation of the <a href=https://github.com/gardener/gardener/blob/v1.88.0/extensions/pkg/webhook/controlplane/genericmutator/mutator.go>genericmutator.Ensurer</a> interface.<ol><li>The webhook appends or updates <code>RegistryConfig</code> entries in the <a href=/docs/gardener/extensions/resources/operatingsystemconfig/#cri-support>OperatingSystemConfig CRI</a> configuration that corresponds to configured registry caches in the Shoot. The <code>RegistryConfig</code> readiness probe is enabled so that <a href=/docs/gardener/concepts/node-agent/>gardener-node-agent</a> creates a <code>hosts.toml</code> containerd registry configuration file when all <code>RegistryConfig</code> hosts are reachable.</li></ol></li></ol><h3 id=extension-disablement>Extension Disablement<a class=td-heading-self-link href=#extension-disablement aria-label="Heading self-link"></a></h3><p>This section outlines how the extension disablement works, i.e., the extension has to be removed from the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, the gardenlet destroys the <a href=/docs/gardener/extensions/resources/extension/>Extension</a> resource because it is no longer needed.<ol><li>The extension deletes the ManagedResource containing the registry cache resources.</li><li>The OperatingSystemConfig resource will not be mutated and no <code>RegistryConfig</code> entries will be added or updated. The <a href=/docs/gardener/concepts/node-agent/>gardener-node-agent</a> detects that <code>RegistryConfig</code> entries have been removed or changed and deletes or updates corresponding <code>hosts.toml</code> configuration files under <code>/etc/containerd/certs.d</code> folder.</li></ol></li></ol><h2 id=shoot-deletion>Shoot Deletion<a class=td-heading-self-link href=#shoot-deletion aria-label="Heading self-link"></a></h2><p>This section outlines how the deletion works for a Shoot with the registry-cache extension enabled.</p><ol><li>As part of the Shoot deletion flow, the gardenlet destroys the <a href=/docs/gardener/extensions/resources/extension/>Extension</a> resource.<ol><li>The extension deletes the ManagedResource containing the registry cache resources.</li></ol></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-ec03b3bb47b090a3cb2f8a348465d050>8.6 - How to provide credentials for upstream registry?</h1><h1 id=how-to-provide-credentials-for-upstream-registry>How to provide credentials for upstream registry?<a class=td-heading-self-link href=#how-to-provide-credentials-for-upstream-registry aria-label="Heading self-link"></a></h1><p>In Kubernetes, to pull images from private container image registries you either have to specify an image pull Secret (see <a href=https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/>Pull an Image from a Private Registry</a>) or you have to configure the kubelet to dynamically retrieve credentials using a credential provider plugin (see <a href=https://kubernetes.io/docs/tasks/administer-cluster/kubelet-credential-provider/>Configure a kubelet image credential provider</a>). When pulling an image, the kubelet is providing the credentials to the CRI implementation. The CRI implementation uses the provided credentials against the upstream registry to pull the image.</p><p>The registry-cache extension is using the <a href=https://github.com/distribution/distribution>Distribution project</a> as pull through cache implementation. The Distribution project does not use the provided credentials from the CRI implementation while fetching an image from the upstream. Hence, the above-described scenarios such as configuring image pull Secret for a Pod or configuring kubelet credential provider plugins don&rsquo;t work out of the box with the pull through cache provided by the registry-cache extension.
Instead, the Distribution project supports configuring only one set of credentials for a given pull through cache instance (for a given upstream).</p><p>This document describe how to supply credentials for the private upstream registry in order to pull private image with the registry cache.</p><h2 id=how-to-configure-the-registry-cache-to-use-upstream-registry-credentials>How to configure the registry cache to use upstream registry credentials?<a class=td-heading-self-link href=#how-to-configure-the-registry-cache-to-use-upstream-registry-credentials aria-label="Heading self-link"></a></h2><ol><li><p>Create an immutable Secret with the upstream registry credentials in the Garden cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f - <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: ro-docker-secret-v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: garden-dev
</span></span></span><span style=display:flex><span><span style=color:#a31515>type: Opaque
</span></span></span><span style=display:flex><span><span style=color:#a31515>immutable: true
</span></span></span><span style=display:flex><span><span style=color:#a31515>data:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  username: $(echo -n $USERNAME | base64 -w0)
</span></span></span><span style=display:flex><span><span style=color:#a31515>  password: $(echo -n $PASSWORD | base64 -w0)
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>For Artifact Registry, the username is <code>_json_key</code> and the password is the service account key in JSON format. To base64 encode the service account key, copy it and run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo -n $SERVICE_ACCOUNT_KEY_JSON | base64 -w0
</span></span></code></pre></div></li><li><p>Add the newly created Secret as a reference to the Shoot spec, and then to the registry-cache extension configuration.</p><p>In the registry-cache configuration, set the <code>secretReferenceName</code> field. It should point to a resource reference under <code>spec.resources</code>. The resource reference itself points to the Secret in project namespace.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span><span style=color:green># ...</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: registry-cache
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: registry.extensions.gardener.cloud/v1alpha3
</span></span><span style=display:flex><span>      kind: RegistryConfig
</span></span><span style=display:flex><span>      caches:
</span></span><span style=display:flex><span>      - upstream: docker.io
</span></span><span style=display:flex><span>        secretReferenceName: docker-secret
</span></span><span style=display:flex><span>  <span style=color:green># ...</span>
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - name: docker-secret
</span></span><span style=display:flex><span>    resourceRef:
</span></span><span style=display:flex><span>      apiVersion: v1
</span></span><span style=display:flex><span>      kind: Secret
</span></span><span style=display:flex><span>      name: ro-docker-secret-v1
</span></span><span style=display:flex><span><span style=color:green># ...</span>
</span></span></code></pre></div></li></ol><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>Do not delete the referenced Secret when there is a Shoot still using it.</p></blockquote><h2 id=how-to-rotate-the-registry-credentials>How to rotate the registry credentials?<a class=td-heading-self-link href=#how-to-rotate-the-registry-credentials aria-label="Heading self-link"></a></h2><p>To rotate registry credentials perform the following steps:</p><ol><li>Generate a new pair of credentials in the cloud provider account. Do not invalidate the old ones.</li><li>Create a new Secret (e.g., <code>ro-docker-secret-v2</code>) with the newly generated credentials as described in step 1. in <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/upstream-credentials/#how-to-configure-the-registry-cache-to-use-upstream-registry-credentials>How to configure the registry cache to use upstream registry credentials?</a>.</li><li>Update the Shoot spec with newly created Secret as described in step 2. in <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/upstream-credentials/#how-to-configure-the-registry-cache-to-use-upstream-registry-credentials>How to configure the registry cache to use upstream registry credentials?</a>.</li><li>The above step will trigger a Shoot reconciliation. Wait for it to complete.</li><li>Make sure that the old Secret is no longer referenced by any Shoot cluster. Finally, delete the Secret containing the old credentials (e.g., <code>ro-docker-secret-v1</code>).</li><li>Delete the corresponding old credentials from the cloud provider account.</li></ol><h2 id=possible-pitfalls>Possible Pitfalls<a class=td-heading-self-link href=#possible-pitfalls aria-label="Heading self-link"></a></h2><ul><li>The registry cache is not protected by any authentication/authorization mechanism. The cached images (incl. private images) can be fetched from the registry cache without authentication/authorization. Note that the registry cache itself is not exposed publicly.</li><li>The registry cache provides the credentials for every request against the corresponding upstream. In some cases, misconfigured credentials can prevent the registry cache to pull even public images from the upstream (for example: invalid service account key for Artifact Registry). However, this behaviour is controlled by the server-side logic of the upstream registry.</li><li>Do not remove the image pull Secrets when configuring credentials for the registry cache. When the registry-cache is not available, containerd falls back to the upstream registry. containerd still needs the image pull Secret to pull the image and in this way to have the fallback mechanism working.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4343922c3fe104128e4a9eecfb15c364>8.7 - Observability</h1><h1 id=registry-cache-observability>Registry Cache Observability<a class=td-heading-self-link href=#registry-cache-observability aria-label="Heading self-link"></a></h1><p>The <code>registry-cache</code> extension exposes metrics for the registry caches running in the Shoot cluster so that they can be easily viewed by cluster owners and operators in the Shoot&rsquo;s Prometheus and Plutono instances. The exposed monitoring data provides an overview of the performance of the pull-through caches, including hit rate and network traffic data.</p><h2 id=metrics>Metrics<a class=td-heading-self-link href=#metrics aria-label="Heading self-link"></a></h2><p>A registry cache serves <a href=https://github.com/distribution/distribution/blob/v3.0.0-rc.3/registry/proxy/proxymetrics.go#L12-L21>several metrics</a>. The metrics are scraped by the <a href=/docs/gardener/monitoring/#shoot-prometheus>Shoot&rsquo;s Prometheus instance</a>.</p><p>The <code>Registry Caches</code> dashboard in the Shoot&rsquo;s Plutono instance contains several panels which are built using the registry cache metrics. From the <code>Registry</code> dropdown menu you can select the upstream for which you wish the metrics to be displayed (by default, metrics are summed for all upstream registries).</p><p>Following is a list of all exposed registry cache metrics. The <code>upstream_host</code> label can be used to determine the upstream host to which the metrics are related, while the <code>type</code> label can be used to determine weather the metric is for an image <code>blob</code> or an image <code>manifest</code>:</p><h4 id=registry_proxy_requests_total>registry_proxy_requests_total<a class=td-heading-self-link href=#registry_proxy_requests_total aria-label="Heading self-link"></a></h4><p>The number of total incoming request received.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id=registry_proxy_hits_total>registry_proxy_hits_total<a class=td-heading-self-link href=#registry_proxy_hits_total aria-label="Heading self-link"></a></h4><p>The number of total cache hits; i.e. the requested content exists in the registry cache&rsquo;s image store and it is served from there (upstream is not contacted at all for serving the requested content).</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id=registry_proxy_misses_total>registry_proxy_misses_total<a class=td-heading-self-link href=#registry_proxy_misses_total aria-label="Heading self-link"></a></h4><p>The number of total cache misses; i.e. the requested content does not exist in the registry cache&rsquo;s image store and it is fetched from the upstream.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id=registry_proxy_pulled_bytes_total>registry_proxy_pulled_bytes_total<a class=td-heading-self-link href=#registry_proxy_pulled_bytes_total aria-label="Heading self-link"></a></h4><p>The size of total bytes that the registry cache has pulled from the upstream.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id=registry_proxy_pushed_bytes_total>registry_proxy_pushed_bytes_total<a class=td-heading-self-link href=#registry_proxy_pushed_bytes_total aria-label="Heading self-link"></a></h4><p>The size of total bytes pushed to the registry cache&rsquo;s clients.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h2 id=alerts>Alerts<a class=td-heading-self-link href=#alerts aria-label="Heading self-link"></a></h2><p>There are two alerts defined for the registry cache <code>PersistentVolume</code> in the Shoot&rsquo;s Prometheus instance:</p><h4 id=registrycachepersistentvolumeusagecritical>RegistryCachePersistentVolumeUsageCritical<a class=td-heading-self-link href=#registrycachepersistentvolumeusagecritical aria-label="Heading self-link"></a></h4><p>This indicates that the registry cache <code>PersistentVolume</code> is almost full and less than 5% is free. When there is no available disk space, no new images will be cached. However, image pull operations are not affected. An alert is fired when the following expression evaluates to true:</p><pre tabindex=0><code>100 * (
 kubelet_volume_stats_available_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}
   /
 kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}
) &lt; 5
</code></pre><h4 id=registrycachepersistentvolumefullinfourdays>RegistryCachePersistentVolumeFullInFourDays<a class=td-heading-self-link href=#registrycachepersistentvolumefullinfourdays aria-label="Heading self-link"></a></h4><p>This indicates that the registry cache <code>PersistentVolume</code> is expected to fill up within four days based on recent sampling. An alert is fired when the following expression evaluates to true:</p><pre tabindex=0><code>100 * (
 kubelet_volume_stats_available_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}
   /
 kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}
) &lt; 15
and
predict_linear(kubelet_volume_stats_available_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}[30m], 4 * 24 * 3600) &lt;= 0
</code></pre><p>Users can subscribe to these alerts by following the Gardener <a href=/docs/gardener/monitoring/alerting/#alerting-for-users>alerting guide</a>.</p><h2 id=logging>Logging<a class=td-heading-self-link href=#logging aria-label="Heading self-link"></a></h2><p>To view the registry cache logs in Plutono, navigate to the <code>Explore</code> tab and select <code>vali</code> from the <code>Explore</code> dropdown menu. Afterwards enter the following <code>vali</code> query:</p><ul><li><code>{container_name="registry-cache"}</code> to view the logs for all registries.</li><li><code>{pod_name=~"registry-&lt;upstream_host>.+"}</code> to view the logs for specific upstream registry.</li></ul></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://x.com/GardenerProject><img src=/images/branding/x-logo-white.svg class=media-icon><div class=media-text>X</div></a></li></ul><span class=copyright>Copyright 2019-2025 Gardener project authors.
<a href=https://www.sap.com/about/legal/terms-of-use.html>Terms of Use
<i class="fa fa-external-link" aria-hidden=true></i>
</a>|
<a href=https://www.sap.com/about/legal/terms-of-use.html>Privacy Statement
<i class="fa fa-external-link" aria-hidden=true></i>
</a>|
<a href=https://www.sap.com/about/legal/terms-of-use.html>Legal Disclosure
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>