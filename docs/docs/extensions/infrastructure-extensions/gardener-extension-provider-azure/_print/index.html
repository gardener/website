<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://gardener.cloud/docs/extensions/infrastructure-extensions/gardener-extension-provider-azure/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/extensions/infrastructure-extensions/gardener-extension-provider-azure/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Provider Azure | Gardener</title>
<meta name=description content="Gardener extension controller for the Azure cloud provider"><meta property="og:url" content="https://gardener.cloud/docs/extensions/infrastructure-extensions/gardener-extension-provider-azure/"><meta property="og:site_name" content="Gardener"><meta property="og:title" content="Provider Azure"><meta property="og:description" content="Gardener extension controller for the Azure cloud provider"><meta property="og:locale" content="en_US"><meta property="og:type" content="website"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Provider Azure"><meta itemprop=description content="Gardener extension controller for the Azure cloud provider"><meta itemprop=wordCount content="318"><meta itemprop=image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Provider Azure"><meta name=twitter:description content="Gardener extension controller for the Azure cloud provider"><link rel=preload href=/scss/main.min.3b9ac919481029e416df474ad35607ec3f5f04f6de0c49ea2f1af3ab95c8363e.css as=style integrity="sha256-O5rJGUgQKeQW30dK01YH7D9fBPbeDEnqLxrzq5XINj4=" crossorigin=anonymous><link href=/scss/main.min.3b9ac919481029e416df474ad35607ec3f5f04f6de0c49ea2f1af3ab95c8363e.css rel=stylesheet integrity="sha256-O5rJGUgQKeQW30dK01YH7D9fBPbeDEnqLxrzq5XINj4=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://demo.gardener.cloud target=_blank><span>Demo</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><div class=dropdown><a href=/docs class=nav-link>Documentation</a><div class=dropdown-content><a class=taxonomy-term href=/docs>Users</a>
<a class=taxonomy-term href=/docs>Operators</a>
<a class=taxonomy-term href=/docs>Developers</a>
<a class=taxonomy-term href=/docs>All</a></div></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.775364b2614e0d659170543a9487a574.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-azure/>Return to the regular view of this page</a>.</p></div><h1 class=title>Provider Azure</h1><div class=lead>Gardener extension controller for the Azure cloud provider</div><div class=content><h1 id=gardener-extension-for-azure-providerhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Azure provider</a><a class=td-heading-self-link href=#gardener-extension-for-azure-providerhttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-provider-azure><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-provider-azure alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-provider-azure-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-provider-azure-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-provider-azure><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-provider-azure alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the Azure provider.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-provider-azure/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=supported-kubernetes-versions>Supported Kubernetes versions<a class=td-heading-self-link href=#supported-kubernetes-versions aria-label="Heading self-link"></a></h2><p>This extension controller supports the following Kubernetes versions:</p><table><thead><tr><th>Version</th><th>Support</th><th>Conformance test results</th></tr></thead><tbody><tr><td>Kubernetes 1.32</td><td>1.32.0+</td><td>N/A</td></tr><tr><td>Kubernetes 1.31</td><td>1.31.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.31%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.31%20Azure/tests_status?style=svg" alt="Gardener v1.31 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.30</td><td>1.30.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.30%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.30%20Azure/tests_status?style=svg" alt="Gardener v1.30 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.29</td><td>1.29.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.29%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.29%20Azure/tests_status?style=svg" alt="Gardener v1.29 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.28</td><td>1.28.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.28%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.28%20Azure/tests_status?style=svg" alt="Gardener v1.28 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.27</td><td>1.27.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.27%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.27%20Azure/tests_status?style=svg" alt="Gardener v1.27 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.26</td><td>1.26.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.26%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.26%20Azure/tests_status?style=svg" alt="Gardener v1.26 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.25</td><td>1.25.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.25%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.25%20Azure/tests_status?style=svg" alt="Gardener v1.25 Conformance Tests"></a></td></tr></tbody></table><p>Please take a look <a href=/docs/gardener/shoot-operations/supported_k8s_versions/>here</a> to see which versions are supported by Gardener in general.</p><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>.</p><p>Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-provider-azure/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/04-new-core-gardener-cloud-apis.md>GEP-4 (New <code>core.gardener.cloud/v1beta1</code> API)</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5e517440813fb72278dc8f9748dee579>1 - Tutorials</h1></div><div class=td-content><h1 id=pg-3c4c1c240f4879d50d22eaff0e08ebbe>1.1 - Create a Kubernetes Cluster on Azure with Gardener</h1><h3 id=overview>Overview<a class=td-heading-self-link href=#overview aria-label="Heading self-link"></a></h3><p>Gardener allows you to create a Kubernetes cluster on different infrastructure providers. This tutorial will guide you through the process of creating a cluster on Azure.</p><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><ul><li>You have created an <a href=https://azure.microsoft.com/en-us/>Azure account</a>.</li><li>You have access to the Gardener dashboard and have permissions to create projects.</li><li>You have an Azure Service Principal assigned to your subscription.</li></ul><h3 id=steps>Steps<a class=td-heading-self-link href=#steps aria-label="Heading self-link"></a></h3><ol><li><p>Go to the Gardener dashboard and create a <em>Project</em>.</p><img src=/__resources/new-gardener-project_524827.png></li><li><p>Get the properties of your Azure AD tenant, Subscription and Service Principal.</p><p>Before you can provision and access a Kubernetes cluster on Azure, you need to add the Azure service principal, AD tenant and subscription credentials in Gardener.
Gardener needs the credentials to provision and operate the Azure infrastructure for your Kubernetes cluster.</p><p><strong>Ensure that the Azure service principal has the actions defined within the <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-azure/azure-permissions/>Azure Permissions</a> within your Subscription assigned.
If no fine-grained permission/actions are required, then simply the built-in <code>Contributor</code> role can be assigned.</strong></p><ul><li><p>Tenant ID</p><p>To find your <code>TenantID</code>, follow this <a href=https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/how-to-find-tenant>guide</a>.</p></li><li><p>SubscriptionID</p><p>To find your <code>SubscriptionID</code>, search for and select <em>Subscriptions</em>.
<img src=/__resources/azure-select-subscription_e138b6.png></p><p>After that, copy the <code>SubscriptionID</code> from your subscription of choice.
<img src=/__resources/azure-choose-subscription_d79d28.png></p></li><li><p>Service Principal (SPN)</p><p>A service principal consist of a <code>ClientID</code> (also called <code>ApplicationID</code>) and a Client Secret. For more information, see <a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals>Application and service principal objects in Azure Active Directory</a>. You need to obtain the:</p><ul><li><p>Client ID</p><p>Access the <a href=https://portal.azure.com>Azure Portal</a> and navigate to the <em>Active Directory</em> service.
Within the service navigate to <em>App registrations</em> and select your service principal. Copy the <code>ClientID</code> you see there.</p></li><li><p>Client Secret</p><p>Secrets for the Azure Account/Service Principal can be generated/rotated via the Azure Portal.
After copying your <code>ClientID</code>, in the <em>Detail</em> view of your Service Principal navigate to <em>Certificates & secrets</em>. In the section, you can generate a new secret.</p></li></ul></li></ul></li><li><p>Choose <em>Secrets</em>, then the plus icon <img src=/__resources/plus-icon_df44c3.png> and select <em>Azure</em>.</p><img src=/__resources/create-secret-azure_cd3c81.png></li><li><p>Create your secret.</p><ol><li>Type the name of your secret.</li><li>Copy and paste the <code>TenantID</code>, <code>SubscriptionID</code> and the Service Principal credentials (<code>ClientID</code> and <code>ClientSecret</code>).</li><li>Choose <em>Add secret</em>.
<img src=/__resources/add-azure-secret_d9b7cf.png></li></ol><blockquote><p>After completing these steps, you should see your newly created secret in the <em>Infrastructure Secrets</em> section.</p></blockquote><img src=/__resources/secret-stored_6863bb.png></li><li><p>Register resource providers for your subscription.</p><ol><li>Go to your Azure dashboard</li><li>Navigate to <em>Subscriptions</em> -> &lt;your_subscription></li><li>Pick resource providers from the sidebar</li><li>Register microsoft.Network</li><li>Register microsoft.Compute</li></ol></li><li><p>To create a new cluster, choose <em>Clusters</em> and then the plus sign in the upper right corner.</p><img src=/__resources/new-cluster_88ec0e.png></li><li><p>In the <em>Create Cluster</em> section:</p><ol><li>Select <em>Azure</em> in the <em>Infrastructure</em> tab.</li><li>Type the name of your cluster in the <em>Cluster Details</em> tab.</li><li>Choose the secret you created before in the <em>Infrastructure Details</em> tab.</li><li>Choose <em>Create</em>.</li></ol><img src=/__resources/create-cluster_55c4a1.png></li><li><p>Wait for your cluster to get created.</p><img src=/__resources/processing-cluster_19a7da.png></li></ol><h3 id=result>Result<a class=td-heading-self-link href=#result aria-label="Heading self-link"></a></h3><p>After completing the steps in this tutorial, you will be able to see and download the kubeconfig of your cluster.</p><img src=/__resources/copy-kubeconfig_9889da.png></div><div class=td-content style=page-break-before:always><h1 id=pg-202c2224b11eca2eaad739b137e4db73>2 - Azure Permissions</h1><h1 id=azure-permissions>Azure Permissions<a class=td-heading-self-link href=#azure-permissions aria-label="Heading self-link"></a></h1><p>The following document describes the required Azure actions manage a Shoot cluster on Azure split by the different Azure provider/services.</p><p>Be aware some actions are just required if particular deployment scenarios or features e.g. bring your own vNet, use Azure-file, let the Shoot act as Seed, immutable buckets, etc. should be used.</p><h2 id=microsoftcompute><code>Microsoft.Compute</code><a class=td-heading-self-link href=#microsoftcompute aria-label="Heading self-link"></a></h2><pre tabindex=0><code># Required if a non zonal cluster based on Availability Set should be used.
Microsoft.Compute/availabilitySets/delete
Microsoft.Compute/availabilitySets/read
Microsoft.Compute/availabilitySets/write

# Required to let Kubernetes manage Azure disks.
Microsoft.Compute/disks/delete
Microsoft.Compute/disks/read
Microsoft.Compute/disks/write

# Required for to fetch meta information about disk and virtual machines sizes.
Microsoft.Compute/locations/diskOperations/read
Microsoft.Compute/locations/operations/read
Microsoft.Compute/locations/vmSizes/read

# Required if csi snapshot capabilities should be used and/or the Shoot should act as a Seed.
Microsoft.Compute/snapshots/delete
Microsoft.Compute/snapshots/read
Microsoft.Compute/snapshots/write

# Required to let Gardener/Machine-Controller-Manager manage the cluster nodes/machines.
Microsoft.Compute/virtualMachines/delete
Microsoft.Compute/virtualMachines/read
Microsoft.Compute/virtualMachines/start/action
Microsoft.Compute/virtualMachines/write

# Required if a non zonal cluster based on VMSS Flex (VMO) should be used.
Microsoft.Compute/virtualMachineScaleSets/delete
Microsoft.Compute/virtualMachineScaleSets/read
Microsoft.Compute/virtualMachineScaleSets/write
</code></pre><h2 id=microsoftmanagedidentity><code>Microsoft.ManagedIdentity</code><a class=td-heading-self-link href=#microsoftmanagedidentity aria-label="Heading self-link"></a></h2><pre tabindex=0><code># Required if a user provided Azure managed identity should attached to the cluster nodes.
Microsoft.ManagedIdentity/userAssignedIdentities/assign/action
Microsoft.ManagedIdentity/userAssignedIdentities/read
</code></pre><h2 id=microsoftmarketplaceordering><code>Microsoft.MarketplaceOrdering</code><a class=td-heading-self-link href=#microsoftmarketplaceordering aria-label="Heading self-link"></a></h2><pre tabindex=0><code># Required if nodes/machines should be created with images hosted on the Azure Marketplace.
Microsoft.MarketplaceOrdering/offertypes/publishers/offers/plans/agreements/read
Microsoft.MarketplaceOrdering/offertypes/publishers/offers/plans/agreements/write
</code></pre><h2 id=microsoftnetwork><code>Microsoft.Network</code><a class=td-heading-self-link href=#microsoftnetwork aria-label="Heading self-link"></a></h2><pre tabindex=0><code># Required to let Kubernetes manage services of type &#39;LoadBalancer&#39;.
Microsoft.Network/loadBalancers/backendAddressPools/join/action
Microsoft.Network/loadBalancers/delete
Microsoft.Network/loadBalancers/read
Microsoft.Network/loadBalancers/write

# Required in case the Shoot should use NatGateway(s).
Microsoft.Network/natGateways/delete
Microsoft.Network/natGateways/join/action
Microsoft.Network/natGateways/read
Microsoft.Network/natGateways/write

# Required to let Gardener/Machine-Controller-Manager manage the cluster nodes/machines.
Microsoft.Network/networkInterfaces/delete
Microsoft.Network/networkInterfaces/ipconfigurations/join/action
Microsoft.Network/networkInterfaces/ipconfigurations/read
Microsoft.Network/networkInterfaces/join/action
Microsoft.Network/networkInterfaces/read
Microsoft.Network/networkInterfaces/write

# Required to let Gardener maintain the basic infrastructure of the Shoot cluster and maintaing LoadBalancer services.
Microsoft.Network/networkSecurityGroups/delete
Microsoft.Network/networkSecurityGroups/join/action
Microsoft.Network/networkSecurityGroups/read
Microsoft.Network/networkSecurityGroups/write

# Required for managing LoadBalancers and NatGateways.
Microsoft.Network/publicIPAddresses/delete
Microsoft.Network/publicIPAddresses/join/action
Microsoft.Network/publicIPAddresses/read
Microsoft.Network/publicIPAddresses/write

# Required for managing the basic infrastructure of a cluster and maintaing LoadBalancer services.
Microsoft.Network/routeTables/delete
Microsoft.Network/routeTables/join/action
Microsoft.Network/routeTables/read
Microsoft.Network/routeTables/routes/delete
Microsoft.Network/routeTables/routes/read
Microsoft.Network/routeTables/routes/write
Microsoft.Network/routeTables/write

# Required to let Gardener maintain the basic infrastructure of the Shoot cluster.
# Only a subset is required for the bring your own vNet scenario.
Microsoft.Network/virtualNetworks/delete # not required for bring your own vnet
Microsoft.Network/virtualNetworks/read
Microsoft.Network/virtualNetworks/subnets/delete
Microsoft.Network/virtualNetworks/subnets/join/action
Microsoft.Network/virtualNetworks/subnets/read
Microsoft.Network/virtualNetworks/subnets/write
Microsoft.Network/virtualNetworks/write # not required for bring your own vnet
</code></pre><h2 id=microsoftresources><code>Microsoft.Resources</code><a class=td-heading-self-link href=#microsoftresources aria-label="Heading self-link"></a></h2><pre tabindex=0><code># Required to let Gardener maintain the basic infrastructure of the Shoot cluster.
Microsoft.Resources/subscriptions/resourceGroups/delete
Microsoft.Resources/subscriptions/resourceGroups/read
Microsoft.Resources/subscriptions/resourceGroups/write
</code></pre><h2 id=microsoftstorage><code>Microsoft.Storage</code><a class=td-heading-self-link href=#microsoftstorage aria-label="Heading self-link"></a></h2><pre tabindex=0><code># Required if Azure File should be used and/or if the Shoot should act as Seed.
Microsoft.Storage/operations/read
Microsoft.Storage/storageAccounts/blobServices/containers/delete
Microsoft.Storage/storageAccounts/blobServices/containers/read
Microsoft.Storage/storageAccounts/blobServices/containers/write
Microsoft.Storage/storageAccounts/blobServices/read
Microsoft.Storage/storageAccounts/delete
Microsoft.Storage/storageAccounts/listkeys/action
Microsoft.Storage/storageAccounts/read
Microsoft.Storage/storageAccounts/write

# Required if Shoot should act as Seed with immutable ABS containers.
Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/extend/action
Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/delete
Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/write
Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/lock/action
Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/read
Microsoft.Storage/storageAccounts/managementPolicies/delete
Microsoft.Storage/storageAccounts/managementPolicies/read
Microsoft.Storage/storageAccounts/managementPolicies/write
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-6e41468eb3f4f7e8baad8ac7246ce13a>3 - Deployment</h1><h1 id=deployment-of-the-azure-provider-extension>Deployment of the Azure provider extension<a class=td-heading-self-link href=#deployment-of-the-azure-provider-extension aria-label="Heading self-link"></a></h1><p><strong>Disclaimer:</strong> This document is NOT a step by step installation guide for the Azure provider extension and only contains some configuration specifics regarding the installation of different components via the helm charts residing in the Azure provider extension <a href=https://github.com/gardener/gardener-extension-provider-azure>repository</a>.</p><h2 id=gardener-extension-admission-azure>gardener-extension-admission-azure<a class=td-heading-self-link href=#gardener-extension-admission-azure aria-label="Heading self-link"></a></h2><h3 id=authentication-against-the-garden-cluster>Authentication against the Garden cluster<a class=td-heading-self-link href=#authentication-against-the-garden-cluster aria-label="Heading self-link"></a></h3><p>There are several authentication possibilities depending on whether or not <a href=https://github.com/gardener/garden-setup#concept-the-virtual-cluster>the concept of <em>Virtual Garden</em></a> is used.</p><h4 id=virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster><em>Virtual Garden</em> is not used, i.e., the <code>runtime</code> Garden cluster is also the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster aria-label="Heading self-link"></a></h4><p><strong>Automounted Service Account Token</strong>
The easiest way to deploy the <code>gardener-extension-admission-azure</code> component will be to not provide <code>kubeconfig</code> at all. This way in-cluster configuration and an automounted service account token will be used. The drawback of this approach is that the automounted token will not be automatically rotated.</p><h4 id=virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster><em>Virtual Garden</em> is used, i.e., the <code>runtime</code> Garden cluster is different from the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster aria-label="Heading self-link"></a></h4><p><strong>Service Account</strong>
The easiest way to setup the authentication will be to create a service account and the respective roles will be bound to this service account in the <code>target</code> cluster. Then use the generated service account token and craft a <code>kubeconfig</code> which will be used by the workload in the <code>runtime</code> cluster. This approach does not provide a solution for the rotation of the service account token. However, this setup can be achieved by setting <code>.Values.global.virtualGarden.enabled: true</code> and following these steps:</p><ol><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Get the service account token and craft the <code>kubeconfig</code>.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><p><strong>Client Certificate</strong>
Another solution will be to bind the roles in the <code>target</code> cluster to a <code>User</code> subject instead of a service account and use a client certificate for authentication. This approach does not provide a solution for the client certificate rotation. However, this setup can be achieved by setting both <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>, then following these steps:</p><ol><li>Generate a client certificate for the <code>target</code> cluster for the respective user.</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Craft a <code>kubeconfig</code> using the already generated client certificate.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-c8c8cf7fad861c906c48766068d4d640>4 - Local Setup</h1><h3 id=admission-azure>admission-azure<a class=td-heading-self-link href=#admission-azure aria-label="Heading self-link"></a></h3><p><code>admission-azure</code> is an admission webhook server which is responsible for the validation of the cloud provider (Azure in this case) specific fields and resources. The Gardener API server is cloud provider agnostic and it wouldn&rsquo;t be able to perform similar validation.</p><p>Follow the steps below to run the admission webhook server locally.</p><ol><li><p>Start the Gardener API server.</p><p>For details, check the Gardener <a href=/docs/gardener/local_setup/>local setup</a>.</p></li><li><p>Start the webhook server</p><p>Make sure that the <code>KUBECONFIG</code> environment variable is pointing to the local garden cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make start-admission
</span></span></code></pre></div></li><li><p>Setup the <code>ValidatingWebhookConfiguration</code>.</p><p><code>hack/dev-setup-admission-azure.sh</code> will configure the webhook Service which will allow the kube-apiserver of your local cluster to reach the webhook server. It will also apply the <code>ValidatingWebhookConfiguration</code> manifest.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./hack/dev-setup-admission-azure.sh
</span></span></code></pre></div></li></ol><p>You are now ready to experiment with the <code>admission-azure</code> webhook server locally.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a9331c43e98d69a160078331d2ea1788>5 - Operations</h1><h1 id=using-the-azure-provider-extension-with-gardener-as-an-operator>Using the Azure provider extension with Gardener as an operator<a class=td-heading-self-link href=#using-the-azure-provider-extension-with-gardener-as-an-operator aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/30-cloudprofile.yaml><code>core.gardener.cloud/v1beta1.CloudProfile</code> resource</a> declares a <code>providerConfig</code> field that is meant to contain provider-specific configuration.
The <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml><code>core.gardener.cloud/v1beta1.Seed</code> resource</a> is structured similarly.
Additionally, it allows configuring settings for the backups of the main etcds&rsquo; data of shoot clusters control planes running in this seed cluster.</p><p>This document explains the necessary configuration for the Azure provider extension.</p><h2 id=cloudprofile-resource><code>CloudProfile</code> resource<a class=td-heading-self-link href=#cloudprofile-resource aria-label="Heading self-link"></a></h2><p>This section describes, how the configuration for <code>CloudProfile</code>s looks like for Azure by providing an example <code>CloudProfile</code> manifest with minimal configuration that can be used to allow the creation of Azure shoot clusters.</p><h3 id=cloudprofileconfig><code>CloudProfileConfig</code><a class=td-heading-self-link href=#cloudprofileconfig aria-label="Heading self-link"></a></h3><p>The cloud profile configuration contains information about the real machine image IDs in the Azure environment (image <code>urn</code>, <code>id</code>, <code>communityGalleryImageID</code> or <code>sharedGalleryImageID</code>).
You have to map every version that you specify in <code>.spec.machineImages[].versions</code> to an available VM image in your subscription.
The VM image can be either from the <a href="https://azuremarketplace.microsoft.com/en-us/marketplace/apps?filters=virtual-machine-images">Azure Marketplace</a> and will then get identified via a <code>urn</code>, it can be a custom VM image from a shared image gallery and is then identified <code>sharedGalleryImageID</code>, or it can be from a community image gallery and is then identified by its <code>communityGalleryImageID</code>. You can use <code>id</code> field also to specifiy the image location in the azure compute gallery (in which case it would have a different kind of path) but it is not recommended as it sometimes faces problems in cross subscription image sharing.
For each machine image version an <code>architecture</code> field can be specified which specifies the CPU architecture of the machine on which given machine image can be used.</p><p>An example <code>CloudProfileConfig</code> for the Azure extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: CloudProfileConfig
</span></span><span style=display:flex><span>countUpdateDomains:
</span></span><span style=display:flex><span>- region: westeurope
</span></span><span style=display:flex><span>  count: 5
</span></span><span style=display:flex><span>countFaultDomains:
</span></span><span style=display:flex><span>- region: westeurope
</span></span><span style=display:flex><span>  count: 3
</span></span><span style=display:flex><span>machineTypes:
</span></span><span style=display:flex><span>- name: Standard_D3_v2
</span></span><span style=display:flex><span>  acceleratedNetworking: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>- name: Standard_X
</span></span><span style=display:flex><span>machineImages:
</span></span><span style=display:flex><span>- name: coreos
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>  - version: 2135.6.0
</span></span><span style=display:flex><span>    urn: <span style=color:#a31515>&#34;CoreOS:CoreOS:Stable:2135.6.0&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:green># architecture: amd64 # optional</span>
</span></span><span style=display:flex><span>    acceleratedNetworking: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>- name: myimage
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>  - version: 1.0.0
</span></span><span style=display:flex><span>    id: <span style=color:#a31515>&#34;/subscriptions/&lt;subscription ID where the gallery is located&gt;/resourceGroups/myGalleryRG/providers/Microsoft.Compute/galleries/myGallery/images/myImageDefinition/versions/1.0.0&#34;</span>
</span></span><span style=display:flex><span>- name: GardenLinuxCommunityImage
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>  - version: 1.0.0
</span></span><span style=display:flex><span>    communityGalleryImageID: <span style=color:#a31515>&#34;/CommunityGalleries/gardenlinux-567905d8-921f-4a85-b423-1fbf4e249d90/Images/gardenlinux/Versions/576.1.1&#34;</span>
</span></span><span style=display:flex><span>- name: SharedGalleryImageName
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>    - version: 1.0.0
</span></span><span style=display:flex><span>      sharedGalleryImageID: <span style=color:#a31515>&#34;/SharedGalleries/sharedGalleryName/Images/sharedGalleryImageName/Versions/sharedGalleryImageVersionName&#34;</span>
</span></span></code></pre></div><p>The cloud profile configuration contains information about the update via <code>.countUpdateDomains[]</code> and failure domain via <code>.countFaultDomains[]</code> counts in the Azure regions you want to offer.</p><p>The <code>.machineTypes[]</code> list contain provider specific information to the machine types e.g. if the machine type support <a href=https://docs.microsoft.com/en-us/azure/virtual-network/create-vm-accelerated-networking-cli>Azure Accelerated Networking</a>, see <code>.machineTypes[].acceleratedNetworking</code>.</p><p>Additionally, it contains the real machine image identifiers in the Azure environment. You can provide either URN for Azure Market Place images or id of <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/linux/shared-image-galleries>Shared Image Gallery</a> images.
When Shared Image Gallery is used, you have to ensure that the image is available in the desired regions and the end-user subscriptions have access to the image or to the whole gallery.
You have to map every version that you specify in <code>.spec.machineImages[].versions</code> here such that the Azure extension knows the machine image identifiers for every version you want to offer.
Furthermore, you can specify for each image version via <code>.machineImages[].versions[].acceleratedNetworking</code> if Azure Accelerated Networking is supported.</p><h3 id=example-cloudprofile-manifest>Example <code>CloudProfile</code> manifest<a class=td-heading-self-link href=#example-cloudprofile-manifest aria-label="Heading self-link"></a></h3><p>The possible values for <code>.spec.volumeTypes[].name</code> on Azure are <code>Standard_LRS</code>, <code>StandardSSD_LRS</code> and <code>Premium_LRS</code>. There is another volume type called <code>UltraSSD_LRS</code> but this type is not supported to use as os disk. If an end user select a volume type whose name is not equal to one of the valid values then the machine will be created with the default volume type which belong to the selected machine type. Therefore it is recommended to configure only the valid values for the <code>.spec.volumeType[].name</code> in the <code>CloudProfile</code>.</p><p>Please find below an example <code>CloudProfile</code> manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: CloudProfile
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: azure
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: azure
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 1.28.2
</span></span><span style=display:flex><span>    - version: 1.23.8
</span></span><span style=display:flex><span>      expirationDate: <span style=color:#a31515>&#34;2022-10-31T23:59:59Z&#34;</span>
</span></span><span style=display:flex><span>  machineImages:
</span></span><span style=display:flex><span>  - name: coreos
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 2135.6.0
</span></span><span style=display:flex><span>  machineTypes:
</span></span><span style=display:flex><span>  - name: Standard_D3_v2
</span></span><span style=display:flex><span>    cpu: <span style=color:#a31515>&#34;4&#34;</span>
</span></span><span style=display:flex><span>    gpu: <span style=color:#a31515>&#34;0&#34;</span>
</span></span><span style=display:flex><span>    memory: 14Gi
</span></span><span style=display:flex><span>  - name: Standard_D4_v3
</span></span><span style=display:flex><span>    cpu: <span style=color:#a31515>&#34;4&#34;</span>
</span></span><span style=display:flex><span>    gpu: <span style=color:#a31515>&#34;0&#34;</span>
</span></span><span style=display:flex><span>    memory: 16Gi
</span></span><span style=display:flex><span>  volumeTypes:
</span></span><span style=display:flex><span>  - name: Standard_LRS
</span></span><span style=display:flex><span>    class: standard
</span></span><span style=display:flex><span>    usable: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  - name: StandardSSD_LRS
</span></span><span style=display:flex><span>    class: premium
</span></span><span style=display:flex><span>    usable: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>  - name: Premium_LRS
</span></span><span style=display:flex><span>    class: premium
</span></span><span style=display:flex><span>    usable: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>  regions:
</span></span><span style=display:flex><span>  - name: westeurope
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: CloudProfileConfig
</span></span><span style=display:flex><span>    machineTypes:
</span></span><span style=display:flex><span>    - name: Standard_D3_v2
</span></span><span style=display:flex><span>      acceleratedNetworking: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    - name: Standard_D4_v3
</span></span><span style=display:flex><span>    countUpdateDomains:
</span></span><span style=display:flex><span>    - region: westeurope
</span></span><span style=display:flex><span>      count: 5
</span></span><span style=display:flex><span>    countFaultDomains:
</span></span><span style=display:flex><span>    - region: westeurope
</span></span><span style=display:flex><span>      count: 3
</span></span><span style=display:flex><span>    machineImages:
</span></span><span style=display:flex><span>    - name: coreos
</span></span><span style=display:flex><span>      versions:
</span></span><span style=display:flex><span>      - version: 2303.3.0
</span></span><span style=display:flex><span>        urn: CoreOS:CoreOS:Stable:2303.3.0
</span></span><span style=display:flex><span>        <span style=color:green># architecture: amd64 # optional</span>
</span></span><span style=display:flex><span>        acceleratedNetworking: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      - version: 2135.6.0
</span></span><span style=display:flex><span>        urn: <span style=color:#a31515>&#34;CoreOS:CoreOS:Stable:2135.6.0&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:green># architecture: amd64 # optional</span>
</span></span></code></pre></div><h2 id=seed-resource><code>Seed</code> resource<a class=td-heading-self-link href=#seed-resource aria-label="Heading self-link"></a></h2><p>This provider extension does not support any provider configuration for the <code>Seed</code>&rsquo;s <code>.spec.provider.providerConfig</code> field.
However, it supports managing of backup infrastructure, i.e., you can specify a configuration for the <code>.spec.backup</code> field.</p><h3 id=backup-configuration>Backup configuration<a class=td-heading-self-link href=#backup-configuration aria-label="Heading self-link"></a></h3><p>A Seed of type <code>azure</code> can be configured to perform backups for the main etcds&rsquo; of the shoot clusters control planes using Azure Blob storage.</p><p>The location/region where the backups will be stored defaults to the region of the Seed (<code>spec.provider.region</code>), but can also be explicitly configured via the field <code>spec.backup.region</code>.
The region of the backup can be different from where the Seed cluster is running.
However, usually it makes sense to pick the same region for the backup bucket as used for the Seed cluster.</p><p>Please find below an example <code>Seed</code> manifest (partly) that configures backups using Azure Blob storage.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Seed
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-seed
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: azure
</span></span><span style=display:flex><span>    region: westeurope
</span></span><span style=display:flex><span>  backup:
</span></span><span style=display:flex><span>    provider: azure
</span></span><span style=display:flex><span>    region: westeurope <span style=color:green># default region</span>
</span></span><span style=display:flex><span>    secretRef:
</span></span><span style=display:flex><span>      name: backup-credentials
</span></span><span style=display:flex><span>      namespace: garden
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>The referenced secret has to contain the provider credentials of the Azure subscription.
Please take a look <a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal>here</a> on how to create an Azure Application, Service Principle and how to obtain credentials.
The example below demonstrates how the secret has to look like.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: core-azure
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  clientID: base64(client-id)
</span></span><span style=display:flex><span>  clientSecret: base64(client-secret)
</span></span><span style=display:flex><span>  subscriptionID: base64(subscription-id)
</span></span><span style=display:flex><span>  tenantID: base64(tenant-id)
</span></span></code></pre></div><h4 id=permissions-for-azure-blob-storage>Permissions for Azure Blob storage<a class=td-heading-self-link href=#permissions-for-azure-blob-storage aria-label="Heading self-link"></a></h4><p>Please make sure the Azure application has the following IAM roles.</p><ul><li><a href=https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#contributor>Contributor</a></li></ul><h2 id=miscellaneous>Miscellaneous<a class=td-heading-self-link href=#miscellaneous aria-label="Heading self-link"></a></h2><h3 id=gardener-managed-service-principals>Gardener managed Service Principals<a class=td-heading-self-link href=#gardener-managed-service-principals aria-label="Heading self-link"></a></h3><p>The operators of the Gardener Azure extension can provide a list of managed service principals (technical users) that can be used for Azure Shoots.
This eliminates the need for users to provide own service principals for their clusters.</p><p>The user would need to grant the managed service principal access to their subscription with proper permissions.</p><p>As service principals are managed in an Azure Active Directory for each supported Active Directory, an own service principal needs to be provided.</p><p>In case the user provides an own service principal in the Shoot secret, this one will be used instead of the managed one provided by the operator.</p><p>Each managed service principal will be maintained in a <code>Secret</code> like that:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: service-principal-my-tenant
</span></span><span style=display:flex><span>  namespace: extension-provider-azure
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    azure.provider.extensions.gardener.cloud/purpose: tenant-service-principal-secret
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  tenantID: base64(my-tenant)
</span></span><span style=display:flex><span>  clientID: base64(my-service-princiapl-id)
</span></span><span style=display:flex><span>  clientSecret: base64(my-service-princiapl-secret)
</span></span><span style=display:flex><span>type: Opaque
</span></span></code></pre></div><p>The user needs to provide in its Shoot secret a <code>tenantID</code> and <code>subscriptionID</code>.</p><p>The managed service principal will be assigned based on the <code>tenantID</code>.
In case there is a managed service principal secret with a matching <code>tenantID</code>, this one will be used for the Shoot.
If there is no matching managed service principal secret then the next Shoot operation will fail.</p><p>One of the benefits of having managed service principals is that the operator controls the lifecycle of the service principal and can rotate its secrets.</p><p>After the service principal secret has been rotated and the corresponding secret is updated, all Shoot clusters using it need to be reconciled or the last operation to be retried.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-600730bb439495112133b52f5c68b64d>6 - Usage</h1><h1 id=using-the-azure-provider-extension-with-gardener-as-end-user>Using the Azure provider extension with Gardener as end-user<a class=td-heading-self-link href=#using-the-azure-provider-extension-with-gardener-as-end-user aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a few fields that are meant to contain provider-specific configuration.</p><p>This document describes the configurable options for Azure and provides an example <code>Shoot</code> manifest with minimal configuration that can be used to create an Azure cluster (modulo the landscape-specific information like cloud profile names, secret binding names, etc.).</p><h2 id=azure-provider-credentials>Azure Provider Credentials<a class=td-heading-self-link href=#azure-provider-credentials aria-label="Heading self-link"></a></h2><p>In order for Gardener to create a Kubernetes cluster using Azure infrastructure components, a Shoot has to provide credentials with sufficient permissions to the desired Azure subscription.
Every shoot cluster references a <code>SecretBinding</code> or a <code>CredentialsBinding</code> which itself references a <code>Secret</code>, and this <code>Secret</code> contains the provider credentials of the Azure subscription.
The <code>SecretBinding</code>/<code>CredentialsBinding</code> is configurable in the <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml>Shoot cluster</a> with the field <code>secretBindingName</code>/<code>credentialsBindingName</code>.</p><p>Create an <a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal>Azure Application and Service Principle</a> and obtain its credentials.</p><p>Please ensure that the Azure application (spn) has the IAM actions defined <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-azure/azure-permissions/>here</a> assigned.
If no fine-grained permissions/actions required then simply assign the <a href=https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#contributor>Contributor</a> role.</p><p>The example below demonstrates how the secret containing the client credentials of the Azure Application has to look like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: core-azure
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  clientID: base64(client-id)
</span></span><span style=display:flex><span>  clientSecret: base64(client-secret)
</span></span><span style=display:flex><span>  subscriptionID: base64(subscription-id)
</span></span><span style=display:flex><span>  tenantID: base64(tenant-id)
</span></span></code></pre></div><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>Depending on your API usage it can be problematic to reuse the same Service Principal for different Shoot clusters due to rate limits.
Please consider spreading your Shoots over Service Principals from different Azure subscriptions if you are hitting those limits.</p></blockquote><h3 id=managed-service-principals>Managed Service Principals<a class=td-heading-self-link href=#managed-service-principals aria-label="Heading self-link"></a></h3><p>The operators of the Gardener Azure extension can provide managed service principals.
This eliminates the need for users to provide an own service principal for a Shoot.</p><p>To make use of a managed service principal, the Azure secret of a Shoot cluster must contain only a <code>subscriptionID</code> and a <code>tenantID</code> field, but no <code>clientID</code> and <code>clientSecret</code>.
Removing those fields from the secret of an existing Shoot will also let it adopt the managed service principal.</p><p>Based on the <code>tenantID</code> field, the Gardener extension will try to assign the managed service principal to the Shoot.
If no managed service principal can be assigned then the next operation on the Shoot will fail.</p><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>The managed service principal need to be assigned to the users Azure subscription with proper permissions before using it.</p></blockquote><h3 id=azure-workload-identity-federation>Azure Workload Identity Federation<a class=td-heading-self-link href=#azure-workload-identity-federation aria-label="Heading self-link"></a></h3><p>Users can choose to trust Gardener&rsquo;s Workload Identity Issuer and eliminate the need for providing Azure credentials.</p><p>As a first step a resource of type <code>WorkloadIdentity</code> should be created in the Garden cluster and configured with the required Azure information.
This identity will be used by infrastructure components to authenticate against Azure APIs.
A sample of such resource is shown below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: security.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: WorkloadIdentity
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: azure
</span></span><span style=display:flex><span>  namespace: garden-myproj
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  audiences:
</span></span><span style=display:flex><span>  <span style=color:green># This is the audience that you configure during the creation of a federated credential</span>
</span></span><span style=display:flex><span>  - api://AzureADTokenExchange-my-application
</span></span><span style=display:flex><span>  targetSystem:
</span></span><span style=display:flex><span>    type: azure
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: WorkloadIdentityConfig
</span></span><span style=display:flex><span>      clientID: 00000000-0000-0000-0000-000000000001 <span style=color:green># This is the id of the application (client)</span>
</span></span><span style=display:flex><span>      tenantID: 00000000-0000-0000-0000-000000000002 <span style=color:green># This is the id of the directory (tenant)</span>
</span></span><span style=display:flex><span>      subscriptionID: 00000000-0000-0000-0000-000000000003 <span style=color:green># This is the id of the Azure subscription</span>
</span></span></code></pre></div><p>Once created the <code>WorkloadIdentity</code> will get its own id which will be used to form the subject of the said <code>WorkloadIdentity</code>.
The subject can be obtained by running the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n garden-myproj get wi azure -o=jsonpath={.status.sub}
</span></span></code></pre></div><p>As a second step users should configure <a href="https://learn.microsoft.com/en-us/entra/workload-id/workload-identity-federation-create-trust?pivots=identity-wif-apps-methods-azp#other-identity-providers">Workload Identity Federation</a> so that their application trusts Gardener&rsquo;s Workload Identity Issuer.
In the shown example a <code>WorkloadIdentity</code> with name <code>azure</code> with id <code>00000000-0000-0000-0000-000000000000</code> from the <code>garden-myproj</code> namespace will be trusted by the Azure application.</p><blockquote class="alert alert-important"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>message-outline</title><path d="M20 2H4C2.9 2 2 2.9 2 4V22l4-4H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2m0 14H5.2L4 17.2V4H20V16z"/></svg><p>Important</p></div><p>You should replace the subject indentifier in the example below with the subject that is populated in the status of the <code>WorkloadIdentity</code>, obtained in a previous step.</p></blockquote><p><img src=/__resources/federated_credential_a0d5bd.png alt="Federated Credential"></p><p>Please ensure that the Azure application (spn) has the proper <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-azure/azure-permissions/>IAM actions</a> assigned.
If no fine-grained permissions/actions required then simply assign the <a href=https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#contributor>Contributor</a> role.</p><h2 id=infrastructureconfig><code>InfrastructureConfig</code><a class=td-heading-self-link href=#infrastructureconfig aria-label="Heading self-link"></a></h2><p>The infrastructure configuration mainly describes how the network layout looks like in order to create the shoot worker nodes in a later step, thus, prepares everything relevant to create VMs, load balancers, volumes, etc.</p><p>An example <code>InfrastructureConfig</code> for the Azure extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: InfrastructureConfig
</span></span><span style=display:flex><span>networks:
</span></span><span style=display:flex><span>  vnet: <span style=color:green># specify either &#39;name&#39; and &#39;resourceGroup&#39; or &#39;cidr&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:green># name: my-vnet</span>
</span></span><span style=display:flex><span>    <span style=color:green># resourceGroup: my-vnet-resource-group</span>
</span></span><span style=display:flex><span>    cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>    <span style=color:green># ddosProtectionPlanID: /subscriptions/test/resourceGroups/test/providers/Microsoft.Network/ddosProtectionPlans/test-ddos-protection-plan</span>
</span></span><span style=display:flex><span>  workers: 10.250.0.0/19
</span></span><span style=display:flex><span>  <span style=color:green># natGateway:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   enabled: false</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   idleConnectionTimeoutMinutes: 4</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   zone: 1</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   ipAddresses:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   - name: my-public-ip-name</span>
</span></span><span style=display:flex><span>  <span style=color:green>#     resourceGroup: my-public-ip-resource-group</span>
</span></span><span style=display:flex><span>  <span style=color:green>#     zone: 1</span>
</span></span><span style=display:flex><span>  <span style=color:green># serviceEndpoints:</span>
</span></span><span style=display:flex><span>  <span style=color:green># - Microsoft.Test</span>
</span></span><span style=display:flex><span>  <span style=color:green># zones:</span>
</span></span><span style=display:flex><span>  <span style=color:green># - name: 1</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   cidr: &#34;10.250.0.0/24</span>
</span></span><span style=display:flex><span>  <span style=color:green># - name: 2</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   cidr: &#34;10.250.0.0/24&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   natGateway:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#     enabled: false</span>
</span></span><span style=display:flex><span>zoned: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span><span style=color:green># resourceGroup:</span>
</span></span><span style=display:flex><span><span style=color:green>#   name: mygroup</span>
</span></span><span style=display:flex><span><span style=color:green>#identity:</span>
</span></span><span style=display:flex><span><span style=color:green>#  name: my-identity-name</span>
</span></span><span style=display:flex><span><span style=color:green>#  resourceGroup: my-identity-resource-group</span>
</span></span><span style=display:flex><span><span style=color:green>#  acrAccess: true</span>
</span></span></code></pre></div><p>Currently, it&rsquo;s not yet possible to deploy into existing resource groups.
The <code>.resourceGroup.name</code> field will allow specifying the name of an already existing resource group that the shoot cluster and all infrastructure resources will be deployed to.</p><p>Via the <code>.zoned</code> boolean you can tell whether you want to use Azure availability zones or not.
If you didn&rsquo;t use zones in the past then an availability set was created and only basic load balancers were used.
Now VMSS-FLex (VMO) has become the default also for non-zonal clusters and only standard load balancers are used.</p><p>The <code>networks.vnet</code> section describes whether you want to create the shoot cluster in an already existing VNet or whether to create a new one:</p><ul><li>If <code>networks.vnet.name</code> and <code>networks.vnet.resourceGroup</code> are given then you have to specify the VNet name and VNet resource group name of the existing VNet that was created by other means (manually, other tooling, &mldr;).</li><li>If <code>networks.vnet.cidr</code> is given then you have to specify the VNet CIDR of a new VNet that will be created during shoot creation.
You can freely choose a private CIDR range.</li><li>Either <code>networks.vnet.name</code> and <code>neworks.vnet.resourceGroup</code> or <code>networks.vnet.cidr</code> must be present, but not both at the same time.</li><li>The <code>networks.vnet.ddosProtectionPlanID</code> field can be used to specify the id of a ddos protection plan which should be assigned to the VNet. This will only work for a VNet managed by Gardener. For externally managed VNets the ddos protection plan must be assigned by other means.</li><li>If a vnet name is given and cilium shoot clusters are created without a network overlay within one vnet make sure that the pod CIDR specified in <code>shoot.spec.networking.pods</code> is not overlapping with any other pod CIDR used in that vnet.
Overlapping pod CIDRs will lead to disfunctional shoot clusters.</li><li>It&rsquo;s possible to place multiple shoot cluster into the same vnet</li></ul><p>The <code>networks.workers</code> section describes the CIDR for a subnet that is used for all shoot worker nodes, i.e., VMs which later run your applications.
The specified CIDR range must be contained in the VNet CIDR specified above, or the VNet CIDR of your already existing VNet.
You can freely choose this CIDR and it is your responsibility to properly design the network layout to suit your needs.</p><p>In the <code>networks.serviceEndpoints[]</code> list you can specify the list of Azure service endpoints which shall be associated with the worker subnet. All available service endpoints and their technical names can be found in the (Azure Service Endpoint documentation](<a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview>https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview</a>).</p><p>The <code>networks.natGateway</code> section contains configuration for the Azure NatGateway which can be attached to the worker subnet of a Shoot cluster. Here are some key information about the usage of the NatGateway for a Shoot cluster:</p><ul><li>NatGateway usage is optional and can be enabled or disabled via <code>.networks.natGateway.enabled</code>.</li><li>If the NatGateway is not used then the egress connections initiated within the Shoot cluster will be nated via the LoadBalancer of the clusters (default Azure behaviour, see <a href=https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-outbound-connections#scenarios>here</a>).</li><li>NatGateway is only available for zonal clusters <code>.zoned=true</code>.</li><li>The NatGateway is currently <strong>not</strong> zone redundantly deployed. That mean the NatGateway of a Shoot cluster will always be in just one zone. This zone can be optionally selected via <code>.networks.natGateway.zone</code>.</li><li><strong>Caution:</strong> Modifying the <code>.networks.natGateway.zone</code> setting requires a recreation of the NatGateway and the managed public ip (automatically used if no own public ip is specified, see below). That mean you will most likely get a different public ip for egress connections.</li><li>It is possible to bring own zonal public ip(s) via <code>networks.natGateway.ipAddresses</code>. Those public ip(s) need to be in the same zone as the NatGateway (see <code>networks.natGateway.zone</code>) and be of SKU <code>standard</code>. For each public ip the <code>name</code>, the <code>resourceGroup</code> and the <code>zone</code> need to be specified.</li><li>The field <code>networks.natGateway.idleConnectionTimeoutMinutes</code> allows the configuration of NAT Gateway&rsquo;s idle connection timeout property. The idle timeout value can be adjusted from 4 minutes, up to 120 minutes. Omitting this property will set the idle timeout to its default value according to <a href=https://docs.microsoft.com/en-us/azure/virtual-network/nat-gateway-resource#timers>NAT Gateway&rsquo;s documentation</a>.</li></ul><p>In the <code>identity</code> section you can specify an <a href=https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview#how-does-the-managed-identities-for-azure-resources-work>Azure user-assigned managed identity</a> which should be attached to all cluster worker machines. With <code>identity.name</code> you can specify the name of the identity and with <code>identity.resourceGroup</code> you can specify the resource group which contains the identity resource on Azure. The identity need to be created by the user upfront (manually, other tooling, &mldr;). Gardener/Azure Extension will only use the referenced one and won&rsquo;t create an identity. Furthermore the identity have to be in the same subscription as the Shoot cluster. Via the <code>identity.acrAccess</code> you can configure the worker machines to use the passed identity for pulling from an <a href=https://docs.microsoft.com/en-us/azure/container-registry/container-registry-intro>Azure Container Registry (ACR)</a>.
<strong>Caution:</strong> Adding, exchanging or removing the identity will require a rolling update of all worker machines in the Shoot cluster.</p><p>Apart from the VNet and the worker subnet the Azure extension will also create a dedicated resource group, route tables, security groups, and an availability set (if not using zoned clusters).</p><h3 id=infrastructureconfig-with-dedicated-subnets-per-zone>InfrastructureConfig with dedicated subnets per zone<a class=td-heading-self-link href=#infrastructureconfig-with-dedicated-subnets-per-zone aria-label="Heading self-link"></a></h3><p>Another deployment option <strong>for zonal clusters only</strong>, is to create and configure a separate subnet per availability zone. This network layout is recommended to users that require fine-grained control over their network setup. One prevalent usecase is to create a zone-redundant NAT Gateway deployment by taking advantage of the ability to deploy separate NAT Gateways for each subnet.</p><p>To use this configuration the following requirements must be met:</p><ul><li>the <code>zoned</code> field must be set to <code>true</code>.</li><li>the <code>networks.vnet</code> section must not be empty and must contain a valid configuration. For existing clusters that were not using the <code>networks.vnet</code> section, it is enough if <code>networks.vnet.cidr</code> field is set to the current <code>networks.worker</code> value.</li></ul><p>For each of the target zones a subnet CIDR range must be specified. The specified CIDR range must be contained in the VNet CIDR specified above, or the VNet CIDR of your already existing VNet. In addition, the CIDR ranges must not overlap with the ranges of the other subnets.</p><p><em>ServiceEndpoints</em> and <em>NatGateways</em> can be configured per subnet. Respectively, when <code>networks.zones</code> is specified, the fields <code>networks.workers</code>, <code>networks.serviceEndpoints</code> and <code>networks.natGateway</code> cannot be set. All the configuration for the subnets must be done inside the respective zone&rsquo;s configuration.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: InfrastructureConfig
</span></span><span style=display:flex><span>networks:
</span></span><span style=display:flex><span>  zoned: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  vnet: <span style=color:green># specify either &#39;name&#39; and &#39;resourceGroup&#39; or &#39;cidr&#39;</span>
</span></span><span style=display:flex><span>    cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>  zones:
</span></span><span style=display:flex><span>  - name: 1
</span></span><span style=display:flex><span>    cidr: <span style=color:#a31515>&#34;10.250.0.0/24&#34;</span>
</span></span><span style=display:flex><span>  - name: 2
</span></span><span style=display:flex><span>    cidr: <span style=color:#a31515>&#34;10.250.0.0/24&#34;</span>
</span></span><span style=display:flex><span>    natGateway:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>false</span>
</span></span></code></pre></div><h3 id=migrating-to-zonal-shoots-with-dedicated-subnets-per-zone>Migrating to zonal shoots with dedicated subnets per zone<a class=td-heading-self-link href=#migrating-to-zonal-shoots-with-dedicated-subnets-per-zone aria-label="Heading self-link"></a></h3><p>For existing zonal clusters it is possible to migrate to a network layout with dedicated subnets per zone. The migration works by creating additional network resources as specified in the configuration and progressively roll part of your existing nodes to use the new resources. To achieve the controlled rollout of your nodes, parts of the existing infrastructure must be preserved which is why the following constraint is imposed:</p><p>One of your specified zones must have the exact same CIDR range as the current <code>network.workers</code> field. Here is an example of such migration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>infrastructureConfig:
</span></span><span style=display:flex><span>  apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: InfrastructureConfig
</span></span><span style=display:flex><span>  networks:
</span></span><span style=display:flex><span>    vnet:
</span></span><span style=display:flex><span>      cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>    workers: 10.250.0.0/19
</span></span><span style=display:flex><span>  zoned: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>to</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>infrastructureConfig:
</span></span><span style=display:flex><span>  apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: InfrastructureConfig
</span></span><span style=display:flex><span>  networks:
</span></span><span style=display:flex><span>    vnet:
</span></span><span style=display:flex><span>      cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>    zones:
</span></span><span style=display:flex><span>      - name: 3
</span></span><span style=display:flex><span>        cidr: 10.250.0.0/19 <span style=color:green># note the preservation of the &#39;workers&#39; CIDR</span>
</span></span><span style=display:flex><span><span style=color:green># optionally add other zones</span>
</span></span><span style=display:flex><span>    <span style=color:green># - name: 2</span>
</span></span><span style=display:flex><span>    <span style=color:green>#   cidr: 10.250.32.0/19</span>
</span></span><span style=display:flex><span>    <span style=color:green>#   natGateway:</span>
</span></span><span style=display:flex><span>    <span style=color:green>#     enabled: true</span>
</span></span><span style=display:flex><span>  zoned: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>Another more advanced example with user-provided public IP addresses for the NAT Gateway and how it can be migrated:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>infrastructureConfig:
</span></span><span style=display:flex><span>  apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: InfrastructureConfig
</span></span><span style=display:flex><span>  networks:
</span></span><span style=display:flex><span>    vnet:
</span></span><span style=display:flex><span>      cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>    workers: 10.250.0.0/19
</span></span><span style=display:flex><span>    natGateway:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      zone: 1
</span></span><span style=display:flex><span>      ipAddresses:
</span></span><span style=display:flex><span>        - name: pip1
</span></span><span style=display:flex><span>          resourceGroup: group
</span></span><span style=display:flex><span>          zone: 1
</span></span><span style=display:flex><span>        - name: pip2
</span></span><span style=display:flex><span>          resourceGroup: group
</span></span><span style=display:flex><span>          zone: 1
</span></span><span style=display:flex><span>  zoned: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>to</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>infrastructureConfig:
</span></span><span style=display:flex><span>  apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: InfrastructureConfig
</span></span><span style=display:flex><span>  zoned: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  networks:
</span></span><span style=display:flex><span>    vnet:
</span></span><span style=display:flex><span>      cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>    zones:
</span></span><span style=display:flex><span>      - name: 1
</span></span><span style=display:flex><span>        cidr: 10.250.0.0/19 <span style=color:green># note the preservation of the &#39;workers&#39; CIDR</span>
</span></span><span style=display:flex><span>        natGateway:
</span></span><span style=display:flex><span>          enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>          ipAddresses:
</span></span><span style=display:flex><span>            - name: pip1
</span></span><span style=display:flex><span>              resourceGroup: group
</span></span><span style=display:flex><span>              zone: 1
</span></span><span style=display:flex><span>            - name: pip2
</span></span><span style=display:flex><span>              resourceGroup: group
</span></span><span style=display:flex><span>              zone: 1
</span></span><span style=display:flex><span><span style=color:green># optionally add other zones</span>
</span></span><span style=display:flex><span><span style=color:green>#     - name: 2</span>
</span></span><span style=display:flex><span><span style=color:green>#       cidr: 10.250.32.0/19</span>
</span></span><span style=display:flex><span><span style=color:green>#       natGateway:</span>
</span></span><span style=display:flex><span><span style=color:green>#         enabled: true</span>
</span></span><span style=display:flex><span><span style=color:green>#         ipAddresses:</span>
</span></span><span style=display:flex><span><span style=color:green>#           - name: pip3</span>
</span></span><span style=display:flex><span><span style=color:green>#             resourceGroup: group</span>
</span></span></code></pre></div><p>You can apply such change to your shoot by issuing a <code>kubectl patch</code> command to replace your current <code>.spec.provider.infrastructureConfig</code> section:</p><pre tabindex=0><code>$ cat new-infra.json

[
  {
    &#34;op&#34;: &#34;replace&#34;,
    &#34;path&#34;: &#34;/spec/provider/infrastructureConfig&#34;,
    &#34;value&#34;: {
      &#34;apiVersion&#34;: &#34;azure.provider.extensions.gardener.cloud/v1alpha1&#34;,
      &#34;kind&#34;: &#34;InfrastructureConfig&#34;,
      &#34;networks&#34;: {
        &#34;vnet&#34;: {
          &#34;cidr&#34;: &#34;&lt;your-vnet-cidr&gt;&#34;
        },
        &#34;zones&#34;: [
          {
            &#34;name&#34;: 1,
            &#34;cidr&#34;: &#34;10.250.0.0/24&#34;,
            &#34;natGateway&#34;: {
              &#34;enabled&#34;: true
            }
          },
          {
            &#34;name&#34;: 1,
            &#34;cidr&#34;: &#34;10.250.1.0/24&#34;,
            &#34;natGateway&#34;: {
              &#34;enabled&#34;: true
            }
          },
        ]
      },
      &#34;zoned&#34;: true
    }
  }
]

kubectl patch --type=&#34;json&#34; --patch-file new-infra.json shoot &lt;my-shoot&gt;
</code></pre><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>The migration to shoots with dedicated subnets per zone is a one-way process. Reverting the shoot to the previous configuration is not supported.
During the migration a subset of the nodes will be rolled to the new subnets.</p></blockquote><h2 id=controlplaneconfig><code>ControlPlaneConfig</code><a class=td-heading-self-link href=#controlplaneconfig aria-label="Heading self-link"></a></h2><p>The control plane configuration mainly contains values for the Azure-specific control plane components.
Today, the only component deployed by the Azure extension is the <code>cloud-controller-manager</code>.</p><p>An example <code>ControlPlaneConfig</code> for the Azure extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: ControlPlaneConfig
</span></span><span style=display:flex><span>cloudControllerManager:
</span></span><span style=display:flex><span><span style=color:green># featureGates:</span>
</span></span><span style=display:flex><span><span style=color:green>#   SomeKubernetesFeature: true</span>
</span></span></code></pre></div><p>The <code>cloudControllerManager.featureGates</code> contains a map of explicitly enabled or disabled feature gates.
For production usage it&rsquo;s not recommend to use this field at all as you can enable alpha features or disable beta/stable features, potentially impacting the cluster stability.
If you don&rsquo;t want to configure anything for the <code>cloudControllerManager</code> simply omit the key in the YAML specification.</p><p><code>storage</code> contains options for storage-related control plane component.
<code>storage.managedDefaultStorageClass</code> is enabled by default and will deploy a <code>storageClass</code> and mark it as a default (via the <code>storageclass.kubernetes.io/is-default-class</code> annotation)
<code>storage.managedDefaultVolumeSnapshotClass</code> is enabled by default and will deploy a <code>volumeSnapshotClass</code> and mark it as a default (via the <code>snapshot.storage.kubernetes.io/is-default-classs</code> annotation)
In case you want to manage your own default <code>storageClass</code> or <code>volumeSnapshotClass</code> you need to disable the respective options above, otherwise reconciliation of the controlplane may fail.</p><h2 id=workerconfig><code>WorkerConfig</code><a class=td-heading-self-link href=#workerconfig aria-label="Heading self-link"></a></h2><p>The Azure extension supports encryption for volumes plus support for additional data volumes per machine.
Please note that you cannot specify the <code>encrypted</code> flag for Azure disks as they are encrypted by default/out-of-the-box.
For each data volume, you have to specify a name.
The following YAML is a snippet of a <code>Shoot</code> resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: cpu-worker
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        type: Standard_LRS
</span></span><span style=display:flex><span>        size: 20Gi
</span></span><span style=display:flex><span>      dataVolumes:
</span></span><span style=display:flex><span>      - name: kubelet-dir
</span></span><span style=display:flex><span>        type: Standard_LRS
</span></span><span style=display:flex><span>        size: 25Gi
</span></span></code></pre></div><p>Additionally, it supports for other Azure-specific values and could be configured under <code>.spec.provider.workers[].providerConfig</code></p><p>An example <code>WorkerConfig</code> for the Azure extension looks like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: WorkerConfig
</span></span><span style=display:flex><span>nodeTemplate: <span style=color:green># (to be specified only if the node capacity would be different from cloudprofile info during runtime)</span>
</span></span><span style=display:flex><span>  capacity:
</span></span><span style=display:flex><span>    cpu: 2
</span></span><span style=display:flex><span>    gpu: 1
</span></span><span style=display:flex><span>    memory: 50Gi
</span></span><span style=display:flex><span>diagnosticsProfile:
</span></span><span style=display:flex><span>  enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  <span style=color:green># storageURI: https://&lt;storage-account-name&gt;.blob.core.windows.net/</span>
</span></span><span style=display:flex><span>dataVolumes:
</span></span><span style=display:flex><span>  - name: test-image
</span></span><span style=display:flex><span>    imageRef:
</span></span><span style=display:flex><span>      communityGalleryImageID: /CommunityGalleries/gardenlinux-13e998fe-534d-4b0a-8a27-f16a73aef620/Images/gardenlinux/Versions/1443.10.0
</span></span><span style=display:flex><span>      <span style=color:green># sharedGalleryImageID: /SharedGalleries/82fc46df-cc38-4306-9880-504e872cee18-VSMP_MEMORYONE_GALLERY/Images/vSMP_MemoryONE/Versions/1062800168.0.0</span>
</span></span><span style=display:flex><span>      <span style=color:green># id: /Subscriptions/2ebd38b6-270b-48a2-8e0b-2077106dc615/Providers/Microsoft.Compute/Locations/westeurope/Publishers/sap/ArtifactTypes/VMImage/Offers/gardenlinux/Skus/greatest/Versions/1443.10.0</span>
</span></span><span style=display:flex><span>      <span style=color:green># urn: sap:gardenlinux:greatest:1443.10.0</span>
</span></span></code></pre></div><p>The <code>.nodeTemplate</code> is used to specify resource information of the machine during runtime. This then helps in Scale-from-Zero.
Some points to note for this field:</p><ul><li>Currently only cpu, gpu and memory are configurable.</li><li>a change in the value lead to a rolling update of the machine in the worker pool</li><li>all the resources needs to be specified</li></ul><p>The <code>.diagnosticsProfile</code> is used to enable <a href=https://learn.microsoft.com/en-us/azure/virtual-machines/boot-diagnostics>machine boot diagnostics</a> (disabled per default).
A storage account is used for storing vm&rsquo;s boot console output and screenshots.
If <code>.diagnosticsProfile.StorageURI</code> is not specified azure managed storage will be used (recommended way).</p><p>The <code>.dataVolumes</code> field is used to add provider specific configurations for dataVolumes.
<code>.dataVolumes[].name</code> must match with one of the names in <code>workers.dataVolumes[].name</code>.
To specify an image source for the dataVolume either use <code>communityGalleryImageID</code>, <code>sharedGalleryImageID</code>, <code>id</code> or <code>urn</code> as <code>imageRef</code>.
However, users have to make sure that the image really exists, there&rsquo;s yet no check in place.
If the image does not exist the machine will get stuck in creation.</p><h2 id=example-shoot-manifest-non-zoned>Example <code>Shoot</code> manifest (non-zoned)<a class=td-heading-self-link href=#example-shoot-manifest-non-zoned aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest for a non-zoned cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-azure
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfile:
</span></span><span style=display:flex><span>    name: azure
</span></span><span style=display:flex><span>  region: westeurope
</span></span><span style=display:flex><span>  secretBindingName: core-azure
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: azure
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vnet:
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>        workers: 10.250.0.0/19
</span></span><span style=display:flex><span>      zoned: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: Standard_D4_v3
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: Standard_LRS
</span></span><span style=display:flex><span><span style=color:green>#      providerConfig:</span>
</span></span><span style=display:flex><span><span style=color:green>#        apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:green>#        kind: WorkerConfig</span>
</span></span><span style=display:flex><span><span style=color:green>#        nodeTemplate: # (to be specified only if the node capacity would be different from cloudprofile info during runtime)</span>
</span></span><span style=display:flex><span><span style=color:green>#          capacity:</span>
</span></span><span style=display:flex><span><span style=color:green>#            cpu: 2</span>
</span></span><span style=display:flex><span><span style=color:green>#            gpu: 1</span>
</span></span><span style=display:flex><span><span style=color:green>#            memory: 50Gi</span>
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>    pods: 100.96.0.0/11
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    services: 100.64.0.0/13
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.2
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=example-shoot-manifest-zoned>Example <code>Shoot</code> manifest (zoned)<a class=td-heading-self-link href=#example-shoot-manifest-zoned aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest for a zoned cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-azure
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfile:
</span></span><span style=display:flex><span>    name: azure
</span></span><span style=display:flex><span>  region: westeurope
</span></span><span style=display:flex><span>  secretBindingName: core-azure
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: azure
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vnet:
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>        workers: 10.250.0.0/19
</span></span><span style=display:flex><span>      zoned: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: Standard_D4_v3
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: Standard_LRS
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - <span style=color:#a31515>&#34;1&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#a31515>&#34;2&#34;</span>
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>    pods: 100.96.0.0/11
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    services: 100.64.0.0/13
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.2
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=example-shoot-manifest-zoned-with-nat-gateways-per-zone>Example <code>Shoot</code> manifest (zoned with NAT Gateways per zone)<a class=td-heading-self-link href=#example-shoot-manifest-zoned-with-nat-gateways-per-zone aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest for a zoned cluster using NAT Gateways per zone:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-azure
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfile:
</span></span><span style=display:flex><span>    name: azure
</span></span><span style=display:flex><span>  region: westeurope
</span></span><span style=display:flex><span>  secretBindingName: core-azure
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: azure
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vnet:
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>        zones:
</span></span><span style=display:flex><span>        - name: 1
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/24
</span></span><span style=display:flex><span>          serviceEndpoints:
</span></span><span style=display:flex><span>          - Microsoft.Storage
</span></span><span style=display:flex><span>          - Microsoft.Sql
</span></span><span style=display:flex><span>          natGateway:
</span></span><span style=display:flex><span>            enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>            idleConnectionTimeoutMinutes: 4
</span></span><span style=display:flex><span>        - name: 2
</span></span><span style=display:flex><span>          cidr: 10.250.1.0/24
</span></span><span style=display:flex><span>          serviceEndpoints:
</span></span><span style=display:flex><span>          - Microsoft.Storage
</span></span><span style=display:flex><span>          - Microsoft.Sql
</span></span><span style=display:flex><span>          natGateway:
</span></span><span style=display:flex><span>            enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      zoned: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: Standard_D4_v3
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: Standard_LRS
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - <span style=color:#a31515>&#34;1&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#a31515>&#34;2&#34;</span>
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>    pods: 100.96.0.0/11
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    services: 100.64.0.0/13
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.2
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=csi-volume-provisioners>CSI volume provisioners<a class=td-heading-self-link href=#csi-volume-provisioners aria-label="Heading self-link"></a></h2><p>Every Azure shoot cluster will be deployed with the Azure Disk CSI driver and the Azure File CSI driver.</p><h2 id=kubernetes-versions-per-worker-pool>Kubernetes Versions per Worker Pool<a class=td-heading-self-link href=#kubernetes-versions-per-worker-pool aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>WorkerPoolKubernetesVersion</code> feature gate, i.e., having <a href=https://github.com/gardener/gardener/blob/8a9c88866ec5fce59b5acf57d4227eeeb73669d7/example/90-shoot.yaml#L69-L70>worker pools with overridden Kubernetes versions</a> since <code>gardener-extension-provider-azure@v1.25</code>.</p><h2 id=shoot-ca-certificate-and-serviceaccount-signing-key-rotation>Shoot CA Certificate and <code>ServiceAccount</code> Signing Key Rotation<a class=td-heading-self-link href=#shoot-ca-certificate-and-serviceaccount-signing-key-rotation aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>ShootCARotation</code> and <code>ShootSARotation</code> feature gates since <code>gardener-extension-provider-azure@v1.28</code>.</p><h2 id=miscellaneous>Miscellaneous<a class=td-heading-self-link href=#miscellaneous aria-label="Heading self-link"></a></h2><h3 id=azure-accelerated-networking>Azure Accelerated Networking<a class=td-heading-self-link href=#azure-accelerated-networking aria-label="Heading self-link"></a></h3><p>All worker machines of the cluster will be automatically configured to use <a href=https://docs.microsoft.com/en-us/azure/virtual-network/create-vm-accelerated-networking-cli>Azure Accelerated Networking</a> if the prerequisites are fulfilled.
The prerequisites are that the cluster must be zoned, and the used machine type and operating system image version are compatible for Accelerated Networking.
<code>Availability Set</code> based shoot clusters will not be enabled for accelerated networking even if the machine type and operating system support it, this is necessary because all machines from the availability set must be scheduled on special hardware, more details can be found <a href=https://github.com/MicrosoftDocs/azure-docs/issues/10536>here</a>.
Supported machine types are listed in the CloudProfile in <code>.spec.providerConfig.machineTypes[].acceleratedNetworking</code> and the supported operating system image versions are defined in <code>.spec.providerConfig.machineImages[].versions[].acceleratedNetworking</code>.</p><h3 id=support-for-other-azure-instances>Support for other Azure instances<a class=td-heading-self-link href=#support-for-other-azure-instances aria-label="Heading self-link"></a></h3><p>The provider extension can be configured to connect to Azure instances other than the public one by providing additional configuration in the CloudProfile:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  …
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: CloudProfileConfig
</span></span><span style=display:flex><span>    cloudConfiguration:
</span></span><span style=display:flex><span>      name: AzurePublic <span style=color:green># AzurePublic | AzureGovernment | AzureChina</span>
</span></span><span style=display:flex><span>    machineTypes:
</span></span><span style=display:flex><span>      …
</span></span><span style=display:flex><span>    …
</span></span><span style=display:flex><span>  …
</span></span></code></pre></div><p>If no configuration is specified the extension will default to the public instance.
Azure instances other than <code>AzurePublic</code>, <code>AzureGovernment</code>, or <code>AzureChina</code> are not supported at this time.</p><h3 id=disabling-the-automatic-deployment-of-allow-tcpudp-loadbalancer-services>Disabling the automatic deployment of <code>allow-{tcp,udp} loadbalancer services</code><a class=td-heading-self-link href=#disabling-the-automatic-deployment-of-allow-tcpudp-loadbalancer-services aria-label="Heading self-link"></a></h3><p>Using the <code>azure-cloud-controller-manager</code> when a user first creates a loadbalancer service in the cluster, a new Load Balancer is created in Azure and all nodes of the cluster are registered as backend.
When a NAT Gateway is not used, then this Load Balancer is used as a NAT device for outbound traffic by using one of the registered FrontendIPs assigned to the k8s LB service.
In cases where a NATGateway is not used, <code>provider-azure</code> will deploy by default a set of 2 Load Balancer services in the <code>kube-system</code>.
These are responsible for allowing outbound traffic in all cases for UDP and TCP.</p><p>There is a way for users to disable the deployment of these additional LBs by using the <code>azure.provider.extensions.gardener.cloud/skip-allow-egress="true"</code> annotation on their shoot.
[!WARNING]
Disabling the system Load Balancers may affect the outbound of your shoot.
Before disabling them, users are highly advised to have created at least one Load Balancer for <strong>TCP and UDP</strong> or forward outbound traffic via a different route.</p><h3 id=support-for-volumeattributesclasses-beta-in-k8s-131>Support for VolumeAttributesClasses (Beta in k8s 1.31)<a class=td-heading-self-link href=#support-for-volumeattributesclasses-beta-in-k8s-131 aria-label="Heading self-link"></a></h3><p>To have the CSI-driver configured to support the necessary features for <a href=https://kubernetes.io/docs/concepts/storage/volume-attributes-classes/>VolumeAttributesClasses</a> on Azure for shoots with a k8s-version greater than 1.31, use the <code>azure.provider.extensions.gardener.cloud/enable-volume-attributes-class</code> annotation on the shoot. Keep in mind to also enable the required feature flags and runtime-config on the common kubernetes controllers (as outlined in the link above) in the shoot-spec.</p><p>For more information and examples on how to configure the volume attributes class, see <a href=https://github.com/kubernetes-sigs/azuredisk-csi-driver/blob/release-1.31/deploy/example/modifyvolume/README.md>example</a> provided in the the azuredisk-csi-driver repository.</p><h3 id=preview-shoot-clusters-with-vmss-flexible-orchestration-vmss-flexvmo>Preview: Shoot clusters with VMSS Flexible Orchestration (VMSS Flex/VMO)<a class=td-heading-self-link href=#preview-shoot-clusters-with-vmss-flexible-orchestration-vmss-flexvmo aria-label="Heading self-link"></a></h3><p>The machines of an Azure cluster can be created while being attached to an <a href=https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-orchestration-modes#scale-sets-with-flexible-orchestration>Azure Virtual Machine ScaleSet with flexible orchestraion</a>.
The Virtual Machine ScaleSet with flexible orchestration feature is currently in preview and not yet general available on Azure.
Subscriptions need to <a href=https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-orchestration-modes#register-for-flexible-orchestration-mode>join the preview</a> to make use of the feature.</p><p>Azure VMSS Flex is the replacement of Azure AvailabilitySet for non-zoned Azure Shoot clusters as VMSS Flex come with less disadvantages like no blocking machine operations or compatibility with <code>Standard</code> SKU loadbalancer etc.</p><p>Now, Azure Shoot clusters are using VMSS Flex by default for non-zoned clusters.
In the past you used to need to do the following:</p><ul><li>The <code>InfrastructureConfig</code> of the Shoot configuration need to contain <code>.zoned=false</code></li><li>Shoot resource need to have the following annotation assigned: <code>alpha.azure.provider.extensions.gardener.cloud/vmo=true</code></li></ul><p>Some key facts about VMSS Flex based clusters:</p><ul><li>Unlike regular non-zonal Azure Shoot clusters, which have a primary AvailabilitySet which is shared between all machines in all worker pools of a Shoot cluster, a VMSS Flex based cluster has an own VMSS for each workerpool</li><li>In case the configuration of the VMSS will change (e.g. amount of fault domains in a region change; configured in the CloudProfile) all machines of the worker pool need to be rolled</li><li>It is not possible to migrate an existing primary AvailabilitySet based Shoot cluster to VMSS Flex based Shoot cluster and vice versa</li><li>VMSS Flex based clusters are using <code>Standard</code> SKU LoadBalancers instead of <code>Basic</code> SKU LoadBalancers for AvailabilitySet based Shoot clusters</li></ul><h2 id=backupbucketconfig>BackupBucketConfig<a class=td-heading-self-link href=#backupbucketconfig aria-label="Heading self-link"></a></h2><p>The extension provides a gated feature currently in alpha called <code>enableImmutableBuckets</code>.
To make use of this feature, and enable the extension to react to the configuration below, you will need to set <code>config.featureGates.enableImmutableBuckets: true</code> in your helm charts&rsquo; <code>values.yaml</code>. See <a href=https://github.com/gardener/gardener-extension-provider-azure/blob/master/charts/gardener-extension-provider-azure/values.yaml>values.yaml</a> for an example.
Before enabling this feature, you will need to add additional permissions to your Azure credential. Please check the linked section in <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-azure/azure-permissions/#microsoftstorage>docs/usage/azure-permissions.md</a>.</p><p><code>BackupBucketConfig</code> describes the configuration that needs to be passed over for creation of the backup bucket infrastructure. Configuration like immutability (WORM, i.e. write-once-read-many) that can be set on the bucket are specified here. Objects in the bucket will inherit the immutability duration which is set on the bucket, and they can not be modified or deleted for that duration.</p><p>This extension supports creating (and migrating already existing buckets if enabled) to use <a href=https://learn.microsoft.com/en-us/azure/storage/blobs/immutable-container-level-worm-policies>container-level WORM policies</a>.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: BackupBucketConfig
</span></span><span style=display:flex><span>immutability:
</span></span><span style=display:flex><span>  retentionType: <span style=color:#a31515>&#34;bucket&#34;</span>
</span></span><span style=display:flex><span>  retentionPeriod: 24h
</span></span><span style=display:flex><span>  locked: <span style=color:#00f>false</span>
</span></span></code></pre></div><ul><li><strong><code>retentionType</code></strong>: Specifies the type of retention policy. The allowed value is <code>bucket</code>, which applies the retention policy to the entire bucket. See the <a href=https://learn.microsoft.com/en-us/azure/storage/blobs/immutable-container-level-worm-policies>documentation</a>.</li><li><strong><code>retentionPeriod</code></strong>: Defines the duration for which objects in the bucket will remain immutable. Azure Blob Storage only supports immutability durations in days, therefore this field must be set as multiples of 24h.</li><li><strong><code>locked</code></strong>: A boolean indicating whether the retention policy is locked. Once locked, the policy cannot be removed or shortened, ensuring immutability. Learn more about locking policies <a href="https://learn.microsoft.com/en-us/azure/storage/blobs/immutable-policy-configure-container-scope?tabs=azure-portal#lock-a-time-based-retention-policy">here</a>.</li></ul><p>To configure a <code>BackupBucket</code> with immutability, include the <code>BackupBucketConfig</code> in the <code>providerConfig</code> of the <code>BackupBucket</code> resource. If the <code>locked</code> field is set to <code>true</code>, the retention policy will be locked, preventing further changes.</p><p>Here is an example of configuring a <code>BackupBucket</code> with immutability:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: BackupBucket
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-backup-bucket
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  region: westeurope
</span></span><span style=display:flex><span>  secretRef:
</span></span><span style=display:flex><span>    name: my-azure-secret
</span></span><span style=display:flex><span>    namespace: my-namespace
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: BackupBucketConfig
</span></span><span style=display:flex><span>    immutability:
</span></span><span style=display:flex><span>      retentionType: <span style=color:#a31515>&#34;bucket&#34;</span>
</span></span><span style=display:flex><span>      retentionPeriod: 24h
</span></span><span style=display:flex><span>      locked: <span style=color:#00f>true</span>
</span></span></code></pre></div></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://x.com/GardenerProject><img src=/images/branding/x-logo-white.svg class=media-icon><div class=media-text>X</div></a></li></ul><span class=copyright>Copyright 2019-2025 Gardener project authors.
<a href=https://www.sap.com/about/legal/terms-of-use.html>Terms of Use
<i class="fa fa-external-link" aria-hidden=true></i>
</a>|
<a href=https://www.sap.com/about/legal/terms-of-use.html>Privacy Statement
<i class="fa fa-external-link" aria-hidden=true></i>
</a>|
<a href=https://www.sap.com/about/legal/terms-of-use.html>Legal Disclosure
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>