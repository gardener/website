<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://gardener.cloud/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Provider GCP | Gardener</title>
<meta name=description content="Gardener extension controller for the GCP cloud provider"><meta property="og:url" content="https://gardener.cloud/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/"><meta property="og:site_name" content="Gardener"><meta property="og:title" content="Provider GCP"><meta property="og:description" content="Gardener extension controller for the GCP cloud provider"><meta property="og:locale" content="en_US"><meta property="og:type" content="website"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Provider GCP"><meta itemprop=description content="Gardener extension controller for the GCP cloud provider"><meta itemprop=wordCount content="312"><meta itemprop=image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Provider GCP"><meta name=twitter:description content="Gardener extension controller for the GCP cloud provider"><link rel=preload href=/scss/main.min.3b9ac919481029e416df474ad35607ec3f5f04f6de0c49ea2f1af3ab95c8363e.css as=style integrity="sha256-O5rJGUgQKeQW30dK01YH7D9fBPbeDEnqLxrzq5XINj4=" crossorigin=anonymous><link href=/scss/main.min.3b9ac919481029e416df474ad35607ec3f5f04f6de0c49ea2f1af3ab95c8363e.css rel=stylesheet integrity="sha256-O5rJGUgQKeQW30dK01YH7D9fBPbeDEnqLxrzq5XINj4=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://demo.gardener.cloud target=_blank><span>Demo</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><div class=dropdown><a href=/docs class=nav-link>Documentation</a><div class=dropdown-content><a class=taxonomy-term href=/docs>Users</a>
<a class=taxonomy-term href=/docs>Operators</a>
<a class=taxonomy-term href=/docs>Developers</a>
<a class=taxonomy-term href=/docs>All</a></div></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.775364b2614e0d659170543a9487a574.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/>Return to the regular view of this page</a>.</p></div><h1 class=title>Provider GCP</h1><div class=lead>Gardener extension controller for the GCP cloud provider</div><div class=content><h1 id=gardener-extension-for-gcp-providerhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for GCP provider</a><a class=td-heading-self-link href=#gardener-extension-for-gcp-providerhttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-provider-gcp><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-provider-gcp alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-provider-gcp-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-provider-gcp-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-provider-gcp><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-provider-gcp alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the GCP provider.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-provider-gcp/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=supported-kubernetes-versions>Supported Kubernetes versions<a class=td-heading-self-link href=#supported-kubernetes-versions aria-label="Heading self-link"></a></h2><p>This extension controller supports the following Kubernetes versions:</p><table><thead><tr><th>Version</th><th>Support</th><th>Conformance test results</th></tr></thead><tbody><tr><td>Kubernetes 1.32</td><td>1.32.0+</td><td>N/A</td></tr><tr><td>Kubernetes 1.31</td><td>1.31.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.31%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.31%20GCE/tests_status?style=svg" alt="Gardener v1.31 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.30</td><td>1.30.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.30%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.30%20GCE/tests_status?style=svg" alt="Gardener v1.30 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.29</td><td>1.29.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.29%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.29%20GCE/tests_status?style=svg" alt="Gardener v1.29 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.28</td><td>1.28.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.28%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.28%20GCE/tests_status?style=svg" alt="Gardener v1.28 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.27</td><td>1.27.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.27%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.27%20GCE/tests_status?style=svg" alt="Gardener v1.27 Conformance Tests"></a></td></tr></tbody></table><p>Please take a look <a href=/docs/gardener/shoot-operations/supported_k8s_versions/>here</a> to see which versions are supported by Gardener in general.</p><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>.</p><p>Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-provider-gcp/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/04-new-core-gardener-cloud-apis.md>GEP-4 (New <code>core.gardener.cloud/v1beta1</code> API)</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-43bc49392a4264d2b4f9a208d1e2eaaa>1 - Tutorials</h1></div><div class=td-content><h1 id=pg-7d967b4e7be2e449fb9198a8ea60881e>1.1 - Create a Кubernetes Cluster on GCP with Gardener</h1><h3 id=overview>Overview<a class=td-heading-self-link href=#overview aria-label="Heading self-link"></a></h3><p>Gardener allows you to create a Kubernetes cluster on different infrastructure providers. This tutorial will guide you through the process of creating a cluster on GCP.</p><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><ul><li>You have created a <a href=https://console.cloud.google.com/>GCP account</a>.</li><li>You have access to the Gardener dashboard and have permissions to create projects.</li></ul><h3 id=steps>Steps<a class=td-heading-self-link href=#steps aria-label="Heading self-link"></a></h3><ol><li><p>Go to the Gardener dashboard and create a <em>Project</em>.</p><img src=/__resources/new-gardener-project_077542.png></li><li><p>Check which roles are required by Gardener.</p><ol><li><p>Choose <em>Secrets</em>, then the plus icon <img src=/__resources/plus-icon_9d16d6.png> and select <em>GCP</em>.</p><img src=/__resources/create-secret-gcp_9b8911.png></li><li><p>Click on the help button <img src=/__resources/help-icon_1fcfd3.png>.</p><img src=/__resources/gardener-gcp-secret-1_3a2741.png>
<img src=/__resources/gardener-gcp-secret-2_fcc008.png></li></ol></li><li><p>Create a service account with the correct roles in GCP:</p><ol><li><p><a href=https://console.cloud.google.com/iam-admin/serviceaccounts>Create a new service account in GCP</a>.</p><img src=/__resources/gcp-create-service-account-0_0a398e.png></li><li><p>Enter the name and description of your service account.</p></li><li><p>Assign the roles required by Gardener.</p></li><li><p>Choose <em>Done</em>.</p><img src=/__resources/gcp-create-service-account-1_c55fe5.png></li></ol></li><li><p>Create a key for your service:</p><ol><li><p>Locate your service account, then choose <em>Actions</em> and <em>Manage keys</em>.</p><img src=/__resources/gcp-create-key-0_b97786.png></li><li><p>Choose <em>Add Key</em>, then <em>Create new key</em>.</p><img src=/__resources/gcp-create-key-1_83ef08.png></li><li><p>Save the private key of the service account in JSON format.</p><img src=/__resources/gcp-create-key-2_a661a1.png>
<img src=/__resources/gcp-create-key-3_ad2cf4.png></li></ol><blockquote class="alert alert-tip"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>lightbulb-on-outline</title><path d="M20 11h3v2H20V11M1 11H4v2H1V11M13 1V4H11V1h2M4.92 3.5 7.05 5.64 5.63 7.05 3.5 4.93 4.92 3.5M16.95 5.63 19.07 3.5 20.5 4.93 18.37 7.05 16.95 5.63M12 6a6 6 0 016 6c0 2.22-1.21 4.16-3 5.2V19a1 1 0 01-1 1H10A1 1 0 019 19V17.2C7.21 16.16 6 14.22 6 12a6 6 0 016-6m2 15v1a1 1 0 01-1 1H11a1 1 0 01-1-1V21h4m-3-3h2V15.87c1.73-.44 3-2.01 3-3.87A4 4 0 0012 8 4 4 0 008 12c0 1.86 1.27 3.43 3 3.87V18z"/></svg><p>Tip</p></div><p>Save the key of the user, it’s used later to create secrets for Gardener.</p></blockquote></li><li><p>Enable the <a href=https://console.developers.google.com/apis/library/compute.googleapis.com>Google Compute API</a> by following <a href=https://cloud.google.com/endpoints/docs/openapi/enable-api>these steps</a>.</p><blockquote><p>When you are finished, you should see the following page:</p></blockquote><img src=/__resources/gcp-compute-engine-api_e4a22b.png></li><li><p>Enable the <a href=https://console.developers.google.com/apis/library/iam.googleapis.com>Google IAM API</a> by following <a href=https://cloud.google.com/endpoints/docs/openapi/enable-api>these steps</a>.</p><blockquote><p>When you are finished, you should see the following page:</p></blockquote><img src=/__resources/gcp-iam-api_8faa7c.png></li><li><p>On the Gardener dashboard, choose <em>Secrets</em> and then the plus sign <img src=/__resources/plus-icon_9d16d6.png>. Select <em>GCP</em> from the drop down menu to add a new GCP secret.</p></li><li><p>Create your secret.</p><ol><li>Type the name of your secret.</li><li>Select your <em>Cloud Profile</em>.</li><li>Copy and paste the contents of the <em>.JSON</em> file you saved when you created the secret key on GCP.</li><li>Choose <em>Add secret</em>.
<img src=/__resources/add-gcp-secret_84ec33.png></li></ol><blockquote><p>After completing these steps, you should see your newly created secret in the <em>Infrastructure Secrets</em> section.</p></blockquote><img src=/__resources/secret-stored_2be4fd.png></li><li><p>To create a new cluster, choose <em>Clusters</em> and then the plus sign in the upper right corner.</p><img src=/__resources/new-cluster_581df0.png></li><li><p>In the <em>Create Cluster</em> section:</p><ol><li>Select <em>GCP</em> in the <em>Infrastructure</em> tab.</li><li>Type the name of your cluster in the <em>Cluster Details</em> tab.</li><li>Choose the secret you created before in the <em>Infrastructure Details</em> tab.</li><li>Choose <em>Create</em>.</li></ol><img src=/__resources/create-cluster_66c946.png></li><li><p>Wait for your cluster to get created.</p><img src=/__resources/processing-cluster_309fda.png></li></ol><h3 id=result>Result<a class=td-heading-self-link href=#result aria-label="Heading self-link"></a></h3><p>After completing the steps in this tutorial, you will be able to see and download the kubeconfig of your cluster.</p><img src=/__resources/copy-kubeconfig_3d13a9.png></div><div class=td-content style=page-break-before:always><h1 id=pg-33b6455211f26cf2f73c830998869efe>2 - Data Disk Restore From Image</h1><h1 id=data-disk-restore-from-image>Data Disk Restore From Image<a class=td-heading-self-link href=#data-disk-restore-from-image aria-label="Heading self-link"></a></h1><h2 id=table-of-contents>Table of Contents<a class=td-heading-self-link href=#table-of-contents aria-label="Heading self-link"></a></h2><ul><li><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/proposals/datadisk-image-restore/#summary>Summary</a></li><li><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/proposals/datadisk-image-restore/#motivation>Motivation</a><ul><li><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/proposals/datadisk-image-restore/#goals>Goals</a></li><li><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/proposals/datadisk-image-restore/#non-goals>Non-Goals</a></li></ul></li><li><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/proposals/datadisk-image-restore/#proposal>Proposal</a></li><li><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/proposals/datadisk-image-restore/#alternatives>Alternatives</a></li></ul><h2 id=summary>Summary<a class=td-heading-self-link href=#summary aria-label="Heading self-link"></a></h2><p>Currently, we have no support either in the shoot spec or in the <a href=https://github.com/gardener/machine-controller-manager-provider-gcp>MCM GCP Provider</a> for restoring GCP Data Disks from images.</p><h2 id=motivation>Motivation<a class=td-heading-self-link href=#motivation aria-label="Heading self-link"></a></h2><p>The primary motivation is to support <a href=https://github.com/gardener/gardener-extension-provider-azure/issues/788>Integration of vSMP MemeoryOne in Azure</a>.
We implemented support for this in AWS via <a href=https://github.com/gardener/gardener-extension-provider-aws/pull/112>Support for data volume snapshot ID </a>.
In GCP we have the option to restore data disk from a custom image which is more convenient and flexible.</p><h3 id=goals>Goals<a class=td-heading-self-link href=#goals aria-label="Heading self-link"></a></h3><ol><li>Extend the GCP provider specific <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/usage/>WorkerConfig</a> section in the shoot YAML and support provider configuration for
data-disks to support data-disk creation from an image name by supplying an image name.</li></ol><h2 id=proposal>Proposal<a class=td-heading-self-link href=#proposal aria-label="Heading self-link"></a></h2><h3 id=shoot-specification>Shoot Specification<a class=td-heading-self-link href=#shoot-specification aria-label="Heading self-link"></a></h3><p>At this current time, there is no support for provider specific configuration of data disks in an GCP shoot spec.
The below shows an example configuration at the time of this proposal:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: WorkerConfig
</span></span><span style=display:flex><span>  volume:
</span></span><span style=display:flex><span>    interface: NVME
</span></span><span style=display:flex><span>    encryption: <span style=color:green># optional, skipped detail here</span>
</span></span><span style=display:flex><span>  serviceAccount:
</span></span><span style=display:flex><span>    email: foo@bar.com
</span></span><span style=display:flex><span>    scopes:
</span></span><span style=display:flex><span>      - https://www.googleapis.com/auth/cloud-platform
</span></span><span style=display:flex><span>  gpu:
</span></span><span style=display:flex><span>    acceleratorType: nvidia-tesla-t4
</span></span><span style=display:flex><span>    count: 1
</span></span></code></pre></div><p>We propose that the worker config section be enahnced to support data disk configuration</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: WorkerConfig
</span></span><span style=display:flex><span>  volume:
</span></span><span style=display:flex><span>    interface: NVME
</span></span><span style=display:flex><span>    encryption: <span style=color:green># optional, skipped detail here</span>
</span></span><span style=display:flex><span>  dataVolumes: <span style=color:green># &lt;-- NEW SUB_SECTION</span>
</span></span><span style=display:flex><span>    - name: vsmp1
</span></span><span style=display:flex><span>      image: imgName
</span></span><span style=display:flex><span>  serviceAccount:
</span></span><span style=display:flex><span>    email: foo@bar.com
</span></span><span style=display:flex><span>    scopes:
</span></span><span style=display:flex><span>      - https://www.googleapis.com/auth/cloud-platform
</span></span><span style=display:flex><span>  gpu:
</span></span><span style=display:flex><span>    acceleratorType: nvidia-tesla-t4
</span></span><span style=display:flex><span>    count: 1
</span></span></code></pre></div><p>In the above <code>imgName</code> specified in <code>providerConfig.dataVolumes.image</code> represents the image name of a previously created image created by a tool or process.
See <a href=https://cloud.google.com/sdk/gcloud/reference/compute/images/create>Google Cloud Create Image</a>.</p><p>The <a href=https://github.com/gardener/machine-controller-manager-provider-gcp>MCM GCP Provider</a> will ensure when a VM instance is instantiated, that the data
disk(s) for the VM are created with the <em>source image</em> set to the provided <code>imgName</code>.
The mechanics of this is left to MCM GCP provider. See <code>image</code> param to <code>--create-disk</code> flag in
<a href=https://cloud.google.com/sdk/gcloud/reference/compute/instances/create>Google Cloud Instance Creation</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c3de24169ff0acf606ae8522686249a7>3 - Deployment</h1><h1 id=deployment-of-the-gcp-provider-extension>Deployment of the GCP provider extension<a class=td-heading-self-link href=#deployment-of-the-gcp-provider-extension aria-label="Heading self-link"></a></h1><p><strong>Disclaimer:</strong> This document is NOT a step-by-step installation guide for the GCP provider extension and only contains some configuration specifics regarding the installation of different components via the helm charts residing in the GCP provider extension <a href=https://github.com/gardener/gardener-extension-provider-gcp>repository</a>.</p><h2 id=gardener-extension-admission-gcp>gardener-extension-admission-gcp<a class=td-heading-self-link href=#gardener-extension-admission-gcp aria-label="Heading self-link"></a></h2><h3 id=authentication-against-the-garden-cluster>Authentication against the Garden cluster<a class=td-heading-self-link href=#authentication-against-the-garden-cluster aria-label="Heading self-link"></a></h3><p>There are several authentication possibilities depending on whether or not <a href=https://github.com/gardener/garden-setup#concept-the-virtual-cluster>the concept of <em>Virtual Garden</em></a> is used.</p><h4 id=virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster><em>Virtual Garden</em> is not used, i.e., the <code>runtime</code> Garden cluster is also the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster aria-label="Heading self-link"></a></h4><p><strong>Automounted Service Account Token</strong>
The easiest way to deploy the <code>gardener-extension-admission-gcp</code> component will be to not provide <code>kubeconfig</code> at all. This way in-cluster configuration and an automounted service account token will be used. The drawback of this approach is that the automounted token will not be automatically rotated.</p><p><strong>Service Account Token Volume Projection</strong>
Another solution will be to use <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>Service Account Token Volume Projection</a> combined with a <code>kubeconfig</code> referencing a token file (see example below).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://default.kubernetes.svc.cluster.local
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: garden
</span></span><span style=display:flex><span>    user: garden
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>current-context: garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div><p>This will allow for automatic rotation of the service account token by the <code>kubelet</code>. The configuration can be achieved by setting both <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.kubeconfig</code> in the respective chart&rsquo;s <code>values.yaml</code> file.</p><h4 id=virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster><em>Virtual Garden</em> is used, i.e., the <code>runtime</code> Garden cluster is different from the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster aria-label="Heading self-link"></a></h4><p><strong>Service Account</strong>
The easiest way to setup the authentication will be to create a service account and the respective roles will be bound to this service account in the <code>target</code> cluster. Then use the generated service account token and craft a <code>kubeconfig</code> which will be used by the workload in the <code>runtime</code> cluster. This approach does not provide a solution for the rotation of the service account token. However, this setup can be achieved by setting <code>.Values.global.virtualGarden.enabled: true</code> and following these steps:</p><ol><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Get the service account token and craft the <code>kubeconfig</code>.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><p><strong>Client Certificate</strong>
Another solution will be to bind the roles in the <code>target</code> cluster to a <code>User</code> subject instead of a service account and use a client certificate for authentication. This approach does not provide a solution for the client certificate rotation. However, this setup can be achieved by setting both <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>, then following these steps:</p><ol><li>Generate a client certificate for the <code>target</code> cluster for the respective user.</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Craft a <code>kubeconfig</code> using the already generated client certificate.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><p><strong>Projected Service Account Token</strong>
This approach requires an already deployed and configured <a href=https://github.com/gardener/oidc-webhook-authenticator>oidc-webhook-authenticator</a> for the <code>target</code> cluster. Also the <code>runtime</code> cluster should be registered as a trusted identity provider in the <code>target</code> cluster. Then projected service accounts tokens from the <code>runtime</code> cluster can be used to authenticate against the <code>target</code> cluster. The needed steps are as follows:</p><ol><li>Deploy <a href=https://github.com/gardener/oidc-webhook-authenticator>OWA</a> and establish the needed trust.</li><li>Set <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>. <strong>Note:</strong> username value will depend on the trust configuration, e.g., <code>&lt;prefix>:system:serviceaccount:&lt;namespace>:&lt;serviceaccount></code></li><li>Set <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.serviceAccountTokenVolumeProjection.audience</code>. <strong>Note:</strong> audience value will depend on the trust configuration, e.g., <code>&lt;cliend-id-from-trust-config></code>.</li><li>Craft a kubeconfig (see example below).</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://virtual-garden.api
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: virtual-garden
</span></span><span style=display:flex><span>    user: virtual-garden
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>current-context: virtual-garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: virtual-garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-78795010602569c55b8cd7f07ced45ee>4 - Ipv6</h1><h1 id=dualstack-support-for-gardener-gcp-extension>DualStack Support for Gardener GCP Extension<a class=td-heading-self-link href=#dualstack-support-for-gardener-gcp-extension aria-label="Heading self-link"></a></h1><p>This document provides an overview of DualStack support for the Gardener GCP extension, detailing its functionality, requirements, and implementation specifics. The document also clarifies the differences between provisioning methods and the unique components required for DualStack clusters.</p><hr><h2 id=overview>Overview<a class=td-heading-self-link href=#overview aria-label="Heading self-link"></a></h2><p>DualStack support allows Gardener GCP shoot clusters to leverage both IPv4 and IPv6 addresses. It is supported exclusively when using the <strong>InfraFlow Controller</strong>. The legacy Terraform reconciler does not support DualStack provisioning.</p><h3 id=key-features>Key Features<a class=td-heading-self-link href=#key-features aria-label="Heading self-link"></a></h3><ul><li><strong>DualStack Subnets</strong>: Separate subnets are created for nodes and services, with explicit IPv4 and IPv6 ranges.</li><li><strong>Ingress-GCE Component</strong>: Responsible for creating IPv6 Load Balancers.</li><li><strong>Cloud Allocator for IPAM</strong>: Manages the assignment of IPv4 and IPv6 ranges to nodes and pods.</li></ul><hr><h2 id=provisioning-options>Provisioning Options<a class=td-heading-self-link href=#provisioning-options aria-label="Heading self-link"></a></h2><h3 id=1-terraform-reconciler>1. Terraform Reconciler<a class=td-heading-self-link href=#1-terraform-reconciler aria-label="Heading self-link"></a></h3><ul><li>Legacy approach.</li><li>Does <strong>not support DualStack provisioning</strong>.</li></ul><h3 id=2-infraflow-controller>2. InfraFlow Controller<a class=td-heading-self-link href=#2-infraflow-controller aria-label="Heading self-link"></a></h3><ul><li>Supports DualStack clusters.</li><li>Requires the annotation <code>provider.extensions.gardener.cloud/use-flow: "true"</code> to be added to the shoot object.</li><li>This annotation is <strong>mandatory</strong> for:<ul><li>Creating a new DualStack shoot.</li><li>Migrating an existing IPv4-only shoot to DualStack.</li></ul></li></ul><hr><h2 id=subnet-configuration-for-dualstack>Subnet Configuration for DualStack<a class=td-heading-self-link href=#subnet-configuration-for-dualstack aria-label="Heading self-link"></a></h2><p>When provisioning a DualStack cluster, the GCP provider creates distinct subnets:</p><h3 id=1-node-subnet>1. <strong>Node Subnet</strong><a class=td-heading-self-link href=#1-node-subnet aria-label="Heading self-link"></a></h3><ul><li><strong>Primary IPv4 Range</strong>: Used for IPv4 nodes.</li><li><strong>Secondary IPv4 Range</strong>: Used for IPv4 pods.</li><li><strong>External IPv6 Range</strong>: Auto-assigned with a <code>/64</code> prefix. Each VM gets an interface with a <code>/96</code> prefix.</li><li><strong>Customization</strong>:<ul><li>IPv4 ranges (pods and nodes) can be defined in the shoot object.</li><li>IPv6 ranges are automatically filled by the GCP provider.</li></ul></li></ul><h3 id=2-service-subnet>2. <strong>Service Subnet</strong><a class=td-heading-self-link href=#2-service-subnet aria-label="Heading self-link"></a></h3><ul><li>This subnet is dedicated to IPv6 services. It is created due to GCP&rsquo;s limitation of not supporting IPv6 reservation for services.</li></ul><hr><h2 id=additional-components>Additional Components<a class=td-heading-self-link href=#additional-components aria-label="Heading self-link"></a></h2><h3 id=1-ingress-gce>1. <strong>Ingress-GCE</strong><a class=td-heading-self-link href=#1-ingress-gce aria-label="Heading self-link"></a></h3><ul><li>The ingress-gce is a mandatory component for DualStack clusters. It is responsible for creating IPv6 Load Balancers. This is necessary because the GCP Cloud Controller Manager (CCM) does not support IPv6 Load Balancer creation.</li></ul><hr><h2 id=cloud-allocator-ipam>Cloud Allocator (IPAM)<a class=td-heading-self-link href=#cloud-allocator-ipam aria-label="Heading self-link"></a></h2><p>The Cloud Allocator is part of the GCP Cloud Controller Manager (CCM) and plays a critical role in managing IPAM (IP Address Management) for DualStack clusters.</p><h3 id=responsibilities>Responsibilities<a class=td-heading-self-link href=#responsibilities aria-label="Heading self-link"></a></h3><ul><li><strong>Assigning PODCIDRs to Node Objects</strong>: Ensures that both IPv4 and IPv6 pod ranges are correctly assigned to the node objects.</li><li><strong>Leveraging Secondary IPv4 Range</strong>:<ul><li>Uses the secondary IPv4 range in the node subnet to allocate pod IP ranges.</li><li>Assigns both IPv4 and IPv6 pod ranges in compliance with GCP’s networking model.</li></ul></li></ul><h3 id=operational-details>Operational Details<a class=td-heading-self-link href=#operational-details aria-label="Heading self-link"></a></h3><ul><li>The Cloud Allocator uses a <code>/119</code> prefix from the external IPv6 range assigned to each VM.</li><li>This ensures efficient utilization of IPv6 address space while maintaining compatibility with Kubernetes networking requirements.</li></ul><h4 id=why-use-a-secondary-ipv4-range-for-pods>Why Use a Secondary IPv4 Range for Pods?<a class=td-heading-self-link href=#why-use-a-secondary-ipv4-range-for-pods aria-label="Heading self-link"></a></h4><p>The secondary IPv4 range is essential for:</p><ul><li>Enabling the Cloud Allocator to function correctly in assigning IP ranges.</li><li>Supporting both IPv4 and IPv6 pods in DualStack clusters.</li><li>Aligning with GCP CCM’s requirement to separate pod IP ranges within the node subnet.</li></ul><hr><h2 id=creating-a-dualstack-cluster>Creating a DualStack Cluster<a class=td-heading-self-link href=#creating-a-dualstack-cluster aria-label="Heading self-link"></a></h2><p>To create a DualStack cluster, rely on the <code>spec.networking.ipFamilies</code> field to specify the desired stack. Below is an example of a DualStack shoot configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span> annotations:
</span></span><span style=display:flex><span>   provider.extensions.gardener.cloud/use-flow: <span style=color:#a31515>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: gcp
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        workers: 10.250.0.0/16
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: ...
</span></span><span style=display:flex><span>    ipFamilies:
</span></span><span style=display:flex><span>    - IPv4
</span></span><span style=display:flex><span>    - IPv6
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><h3 id=explanation>Explanation<a class=td-heading-self-link href=#explanation aria-label="Heading self-link"></a></h3><ul><li><strong><code>spec.networking.ipFamilies</code></strong>: Specifies the stack (IPv4, IPv6, or both). In this example, both IPv4 and IPv6 are defined for a DualStack cluster.</li><li><strong>Annotation</strong>: <code>provider.extensions.gardener.cloud/use-flow: "true"</code> is mandatory for DualStack support.</li></ul><hr><h2 id=migration-of-ipv4-only-shoot-clusters-to-dual-stack>Migration of IPv4-only Shoot Clusters to Dual-Stack<a class=td-heading-self-link href=#migration-of-ipv4-only-shoot-clusters-to-dual-stack aria-label="Heading self-link"></a></h2><p>Eventually, migration should be as easy as changing the <code>.spec.networking.ipFamilies</code> field in the <code>Shoot</code> resource from <code>IPv4</code> to <code>IPv4, IPv6</code>.
However, as of now, this is not supported.</p><p>It is worth recognizing that the migration from an IPv4-only shoot cluster to a dual-stack shoot cluster involves rolling of the nodes/workload as well.
Nodes will not get a new IPv6 address assigned automatically.
The same is true for pods as well.
Once the migration is supported, the detailed caveats will be documented here.</p><hr><h2 id=load-balancer-service-configuration>Load Balancer Service Configuration<a class=td-heading-self-link href=#load-balancer-service-configuration aria-label="Heading self-link"></a></h2><p>When creating LoadBalancer services in a DualStack cluster, you must include specific annotations to enable proper reconciliation by the <code>ingress-gce</code> component for IPv6 support.</p><h3 id=required-annotation-for-ipv6-loadbalancers>Required Annotation for IPv6 LoadBalancers<a class=td-heading-self-link href=#required-annotation-for-ipv6-loadbalancers aria-label="Heading self-link"></a></h3><p>Add the following annotation to the service:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>cloud.google.com/l4-rbs: enabled
</span></span></code></pre></div><h3 id=internal-load-balancer-considerations>Internal Load Balancer Considerations<a class=td-heading-self-link href=#internal-load-balancer-considerations aria-label="Heading self-link"></a></h3><ul><li>Internal IPv6 LoadBalancers are <strong>not supported</strong>.</li><li>For internal IPv4 LoadBalancers, you can use:<ul><li><code>"networking.gke.io/load-balancer-type=Internal"</code></li><li><code>"cloud.google.com/load-balancer-type=internal"</code> (deprecated).
They are created by cloud-controller-manger and get an an IPv4 address from the internal subnet.</li></ul></li></ul><h3 id=example-configuration>Example Configuration<a class=td-heading-self-link href=#example-configuration aria-label="Heading self-link"></a></h3><p>Here is an example of a DualStack LoadBalancer service configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cloud.google.com/l4-rbs: enabled
</span></span><span style=display:flex><span>  name: webapp2
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ipFamilyPolicy: RequireDualStack
</span></span><span style=display:flex><span>  ipFamilies:
</span></span><span style=display:flex><span>  - IPv4
</span></span><span style=display:flex><span>  - IPv6
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>  - port: 80
</span></span><span style=display:flex><span>    targetPort: 80
</span></span><span style=display:flex><span>    protocol: TCP
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    run: webapp2
</span></span><span style=display:flex><span>  type: LoadBalancer
</span></span></code></pre></div><h3 id=explanation-1>Explanation<a class=td-heading-self-link href=#explanation-1 aria-label="Heading self-link"></a></h3><ul><li><strong><code>cloud.google.com/l4-rbs: enabled</code></strong>: Ensures that <code>ingress-gce</code> properly reconciles the LoadBalancer service with IPv6 support.</li><li><strong><code>ipFamilyPolicy</code> and <code>ipFamilies</code></strong>: Specify the DualStack configuration.</li><li><strong>Internal LoadBalancer</strong>: Use the specific annotations for internal IPv4-only LoadBalancers.</li></ul><hr><h2 id=key-benefits-of-dualstack-support>Key Benefits of DualStack Support<a class=td-heading-self-link href=#key-benefits-of-dualstack-support aria-label="Heading self-link"></a></h2><ol><li><strong>Improved Network Compatibility</strong>: DualStack enables seamless communication across both IPv4 and IPv6 environments.</li><li><strong>Enhanced Scalability</strong>: IPv6 significantly expands the available address space.</li><li><strong>Future-Proofing</strong>: DualStack readiness ensures compliance with modern networking standards.</li></ol><hr><h2 id=summary>Summary<a class=td-heading-self-link href=#summary aria-label="Heading self-link"></a></h2><ul><li>DualStack is supported only with the <strong>InfraFlow Controller</strong>.</li><li>The annotation <code>provider.extensions.gardener.cloud/use-flow: "true"</code> is mandatory for enabling DualStack.</li><li>Dedicated subnets for nodes and services are created to manage IPv4 and IPv6 ranges.</li><li>Components like <strong>Ingress-GCE</strong> and the <strong>Cloud Allocator</strong> ensure proper functionality and Load Balancer creation.</li><li>Existing IPv4 clusters must have been created with InfraFlow or been migrated to it to be eligible for dual-stack migration once available.</li></ul><p>DualStack support in Gardener GCP extension represents a significant advancement in networking capabilities, catering to modern cloud-native requirements.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-83937afb9b7b37ebb4a6752a7fcdef44>5 - Local Setup</h1><h3 id=admission-gcp>admission-gcp<a class=td-heading-self-link href=#admission-gcp aria-label="Heading self-link"></a></h3><p><code>admission-gcp</code> is an admission webhook server which is responsible for the validation of the cloud provider (GCP in this case) specific fields and resources. The Gardener API server is cloud provider agnostic and it wouldn&rsquo;t be able to perform similar validation.</p><p>Follow the steps below to run the admission webhook server locally.</p><ol><li><p>Start the Gardener API server.</p><p>For details, check the Gardener <a href=/docs/gardener/local_setup/>local setup</a>.</p></li><li><p>Start the webhook server</p><p>Make sure that the <code>KUBECONFIG</code> environment variable is pointing to the local garden cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make start-admission
</span></span></code></pre></div></li><li><p>Setup the <code>ValidatingWebhookConfiguration</code>.</p><p><code>hack/dev-setup-admission-gcp.sh</code> will configure the webhook Service which will allow the kube-apiserver of your local cluster to reach the webhook server. It will also apply the <code>ValidatingWebhookConfiguration</code> manifest.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./hack/dev-setup-admission-gcp.sh
</span></span></code></pre></div></li></ol><p>You are now ready to experiment with the <code>admission-gcp</code> webhook server locally.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-76376d0613ae014a2d188d92ecff4a5d>6 - Operations</h1><h1 id=using-the-gcp-provider-extension-with-gardener-as-operator>Using the GCP provider extension with Gardener as operator<a class=td-heading-self-link href=#using-the-gcp-provider-extension-with-gardener-as-operator aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/30-cloudprofile.yaml><code>core.gardener.cloud/v1beta1.CloudProfile</code> resource</a> declares a <code>providerConfig</code> field that is meant to contain provider-specific configuration.
The <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml><code>core.gardener.cloud/v1beta1.Seed</code> resource</a> is structured similarly.
Additionally, it allows configuring settings for the backups of the main etcds&rsquo; data of shoot clusters control planes running in this seed cluster.</p><p>This document explains the necessary configuration for this provider extension.</p><h2 id=cloudprofile-resource><code>CloudProfile</code> resource<a class=td-heading-self-link href=#cloudprofile-resource aria-label="Heading self-link"></a></h2><p>This section describes, how the configuration for <code>CloudProfile</code>s looks like for GCP by providing an example <code>CloudProfile</code> manifest with minimal configuration that can be used to allow the creation of GCP shoot clusters.</p><h3 id=cloudprofileconfig><code>CloudProfileConfig</code><a class=td-heading-self-link href=#cloudprofileconfig aria-label="Heading self-link"></a></h3><p>The cloud profile configuration contains information about the real machine image IDs in the GCP environment (image URLs).
You have to map every version that you specify in <code>.spec.machineImages[].versions</code> here such that the GCP extension knows the image URL for every version you want to offer.
For each machine image version an <code>architecture</code> field can be specified which specifies the CPU architecture of the machine on which given machine image can be used.</p><p>An example <code>CloudProfileConfig</code> for the GCP extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: CloudProfileConfig
</span></span><span style=display:flex><span>machineImages:
</span></span><span style=display:flex><span>- name: coreos
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>  - version: 2135.6.0
</span></span><span style=display:flex><span>    image: projects/coreos-cloud/global/images/coreos-stable-2135-6-0-v20190801
</span></span><span style=display:flex><span>    <span style=color:green># architecture: amd64 # optional</span>
</span></span></code></pre></div><h3 id=example-cloudprofile-manifest>Example <code>CloudProfile</code> manifest<a class=td-heading-self-link href=#example-cloudprofile-manifest aria-label="Heading self-link"></a></h3><p>If you want to allow that shoots can create VMs with local SSDs volumes then you have to specify the type of the disk with <code>SCRATCH</code> in the <code>.spec.volumeTypes[]</code> list.
Please find below an example <code>CloudProfile</code> manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: CloudProfile
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: gcp
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: gcp
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 1.32.0
</span></span><span style=display:flex><span>    - version: 1.31.2
</span></span><span style=display:flex><span>      expirationDate: <span style=color:#a31515>&#34;2026-03-31T23:59:59Z&#34;</span>
</span></span><span style=display:flex><span>  machineImages:
</span></span><span style=display:flex><span>  - name: coreos
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 2135.6.0
</span></span><span style=display:flex><span>  machineTypes:
</span></span><span style=display:flex><span>  - name: n1-standard-4
</span></span><span style=display:flex><span>    cpu: <span style=color:#a31515>&#34;4&#34;</span>
</span></span><span style=display:flex><span>    gpu: <span style=color:#a31515>&#34;0&#34;</span>
</span></span><span style=display:flex><span>    memory: 15Gi
</span></span><span style=display:flex><span>  volumeTypes:
</span></span><span style=display:flex><span>  - name: pd-standard
</span></span><span style=display:flex><span>    class: standard
</span></span><span style=display:flex><span>  - name: pd-ssd
</span></span><span style=display:flex><span>    class: premium
</span></span><span style=display:flex><span>  - name: SCRATCH
</span></span><span style=display:flex><span>    class: standard
</span></span><span style=display:flex><span>  regions:
</span></span><span style=display:flex><span>  - region: europe-west1
</span></span><span style=display:flex><span>    names:
</span></span><span style=display:flex><span>    - europe-west1-b
</span></span><span style=display:flex><span>    - europe-west1-c
</span></span><span style=display:flex><span>    - europe-west1-d
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: CloudProfileConfig
</span></span><span style=display:flex><span>    machineImages:
</span></span><span style=display:flex><span>    - name: coreos
</span></span><span style=display:flex><span>      versions:
</span></span><span style=display:flex><span>      - version: 2135.6.0
</span></span><span style=display:flex><span>        image: projects/coreos-cloud/global/images/coreos-stable-2135-6-0-v20190801
</span></span><span style=display:flex><span>        <span style=color:green># architecture: amd64 # optional</span>
</span></span></code></pre></div><h2 id=seed-resource><code>Seed</code> resource<a class=td-heading-self-link href=#seed-resource aria-label="Heading self-link"></a></h2><p>This provider extension does not support any provider configuration for the <code>Seed</code>&rsquo;s <code>.spec.provider.providerConfig</code> field.
However, it supports to managing of backup infrastructure, i.e., you can specify a configuration for the <code>.spec.backup</code> field.</p><h3 id=backup-configuration>Backup configuration<a class=td-heading-self-link href=#backup-configuration aria-label="Heading self-link"></a></h3><p>A Seed of type <code>gcp</code> can be configured to perform backups for the main etcds&rsquo; of the shoot clusters control planes using Google Cloud Storage buckets.</p><p>The location/region where the backups will be stored defaults to the region of the Seed (<code>spec.provider.region</code>), but can also be explicitly configured via the field <code>spec.backup.region</code>.
The region of the backup can be different from where the seed cluster is running.
However, usually it makes sense to pick the same region for the backup bucket as used for the Seed cluster.</p><p>Please find below an example <code>Seed</code> manifest (partly) that configures backups using Google Cloud Storage buckets.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Seed
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-seed
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: gcp
</span></span><span style=display:flex><span>    region: europe-west1
</span></span><span style=display:flex><span>  backup:
</span></span><span style=display:flex><span>    provider: gcp
</span></span><span style=display:flex><span>    region: europe-west1 <span style=color:green># default region</span>
</span></span><span style=display:flex><span>    secretRef:
</span></span><span style=display:flex><span>      name: backup-credentials
</span></span><span style=display:flex><span>      namespace: garden
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>An example of the referenced secret containing the credentials for the GCP Cloud storage can be found in the <a href=https://github.com/gardener/gardener-extension-provider-gcp/blob/master/example/30-etcd-backup-secret.yaml>example folder</a>.</p><h4 id=permissions-for-gcp-cloud-storage>Permissions for GCP Cloud Storage<a class=td-heading-self-link href=#permissions-for-gcp-cloud-storage aria-label="Heading self-link"></a></h4><p>Please make sure the service account associated with the provided credentials has the following IAM roles.</p><ul><li><a href=https://cloud.google.com/storage/docs/access-control/iam-roles>Storage Admin</a></li></ul><h3 id=rolling-update-triggers>Rolling Update Triggers<a class=td-heading-self-link href=#rolling-update-triggers aria-label="Heading self-link"></a></h3><p>Changes to the <code>Shoot</code> worker-pools are applied in-place where possible. In case this is not possible a rolling update of the workers will be performed to apply the new configuration, as outlined in <a href=/docs/gardener/shoot-operations/shoot_updates/#in-place-vs-rolling-updates>the Gardener documentation</a>. The exact fields that trigger this behaviour depend on whether the feature gate <code>NewWorkerPoolHash</code> is enabled. If it is not enabled, only the fields mentioned in the <a href=/docs/gardener/shoot-operations/shoot_updates/#rolling-update-triggers>Gardener doc</a> are used.
If the feature gate <em>is</em> enabled, instead of the complete provider config only the following fields are used:</p><ul><li><code>.spec.provider.workers[].dataVolumes[].name</code></li><li><code>.spec.provider.workers[].dataVolumes[].size</code></li><li><code>.spec.provider.workers[].dataVolumes[].type</code></li><li><code>.spec.provider.workers[].dataVolumes[].encrypted</code></li><li><code>.spec.provider.workers[].providerConfig.volume.encryption</code></li><li><code>.spec.provider.workers[].providerConfig.volume.localSsdInterface</code></li><li><code>.spec.provider.workers[].providerConfig.dataVolumes[].name</code></li><li><code>.spec.provider.workers[].providerConfig.dataVolumes[].sourceImage</code></li><li><code>.spec.provider.workers[].providerConfig.dataVolumes[].provisionedIops</code></li><li><code>.spec.provider.workers[].providerConfig.minCpuPlatform</code></li><li><code>.spec.provider.workers[].providerConfig.gpu</code></li><li><code>.spec.provider.workers[].providerConfig.serviceAccount</code></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a567aa2cf222ff4f19466b657fa42f04>7 - Usage</h1><h1 id=using-the-gcp-provider-extension-with-gardener-as-end-user>Using the GCP provider extension with Gardener as end-user<a class=td-heading-self-link href=#using-the-gcp-provider-extension-with-gardener-as-end-user aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a few fields that are meant to contain provider-specific configuration.</p><p>This document describes the configurable options for GCP and provides an example <code>Shoot</code> manifest with minimal configuration that can be used to create a GCP cluster (modulo the landscape-specific information like cloud profile names, secret binding names, etc.).</p><h2 id=accessing-gcp-apis>Accessing GCP APIs<a class=td-heading-self-link href=#accessing-gcp-apis aria-label="Heading self-link"></a></h2><p>In order for Gardener to create a Kubernetes cluster using GCP infrastructure components, a Shoot has to provide an authentication mechanism giving sufficient permissions to the desired GCP project.
Every shoot cluster references a <code>SecretBinding</code> or a <code>CredentialsBinding</code> which itself references a <code>Secret</code> which contains the provider credentials of the GCP project.</p><blockquote class="alert alert-important"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>message-outline</title><path d="M20 2H4C2.9 2 2 2.9 2 4V22l4-4H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2m0 14H5.2L4 17.2V4H20V16z"/></svg><p>Important</p></div><p>While <code>SecretBinding</code>s can only reference <code>Secret</code>s, <code>CredentialsBinding</code>s can also reference <code>WorkloadIdentity</code>s which provide an alternative authentication method.
<code>WorkloadIdentity</code>s do not directly contain credentials but are rather a representation of the workload that is going to access the user&rsquo;s account.
If the user has configured <a href=https://cloud.google.com/iam/docs/workload-identity-federation>Workload Identity Federation</a> with Gardener&rsquo;s Workload Identity Issuer then the GCP infrastructure components can access the user&rsquo;s account without the need of preliminary exchange of credentials.</p></blockquote><p>The <code>SecretBinding</code>/<code>CredentialsBinding</code> is configurable in the <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml>Shoot cluster</a> with the field <code>secretBindingName</code>/<code>credentialsBindingName</code>.</p><h3 id=gcp-service-account-credentials>GCP Service Account Credentials<a class=td-heading-self-link href=#gcp-service-account-credentials aria-label="Heading self-link"></a></h3><p>The required credentials for the GCP project are a <a href=https://cloud.google.com/iam/docs/service-accounts#service_account_keys>Service Account Key</a> to authenticate as a <a href=https://cloud.google.com/compute/docs/access/service-accounts>GCP Service Account</a>.
A service account is a special account that can be used by services and applications to interact with Google Cloud Platform APIs.
Applications can use service account credentials to authorize themselves to a set of APIs and perform actions within the permissions granted to the service account.</p><p>Make sure to <a href=https://cloud.google.com/service-usage/docs/enable-disable>enable the Google Identity and Access Management (IAM) API</a>.
<a href=https://cloud.google.com/iam/docs/creating-managing-service-accounts>Create a Service Account</a> that shall be used for the Shoot cluster.
<a href=https://cloud.google.com/iam/docs/granting-changing-revoking-access>Grant at least the following IAM roles</a> to the Service Account.</p><ul><li>Service Account Admin</li><li>Service Account Token Creator</li><li>Service Account User</li><li>Compute Admin</li></ul><p>Create a <a href=https://cloud.google.com/iam/docs/creating-managing-service-account-keys#creating_service_account_keys>JSON Service Account key</a> for the Service Account.
Provide it in the <code>Secret</code> (base64 encoded for field <code>serviceaccount.json</code>), that is being referenced by the <code>SecretBinding</code> in the Shoot cluster configuration.</p><p>This <code>Secret</code> must look as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: core-gcp
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  serviceaccount.json: base64(serviceaccount-json)
</span></span></code></pre></div><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>Depending on your API usage it can be problematic to reuse the same Service Account Key for different Shoot clusters due to rate limits.
Please consider spreading your Shoots over multiple Service Accounts on different GCP projects if you are hitting those limits, see <a href=https://cloud.google.com/compute/docs/api-rate-limits>https://cloud.google.com/compute/docs/api-rate-limits</a>.</p></blockquote><h3 id=gcp-workload-identity-federation>GCP Workload Identity Federation<a class=td-heading-self-link href=#gcp-workload-identity-federation aria-label="Heading self-link"></a></h3><p>Users can choose to trust Gardener&rsquo;s Workload Identity Issuer and eliminate the need for providing GCP Service Account credentials.</p><p>As a first step users should configure <a href=https://cloud.google.com/iam/docs/workload-identity-federation-with-kubernetes#kubernetes>Workload Identity Federation</a> with Gardener&rsquo;s Workload Identity Issuer.
In the example attribute mapping shown below all <code>WorkloadIdentity</code>s that are created in the <code>garden-myproj</code> namespace will be authenticated.
Now that the Workload Identity Federation is configured the user should download the credential configuration file.</p><blockquote class="alert alert-important"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>message-outline</title><path d="M20 2H4C2.9 2 2 2.9 2 4V22l4-4H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2m0 14H5.2L4 17.2V4H20V16z"/></svg><p>Important</p></div><p>If required, users can use a stricter mapping to authenticate only certain <code>WorkloadIdentity</code>s.
Please, refer to the <a href=https://cloud.google.com/iam/docs/workload-identity-federation#mapping>attribute mappings documentation</a> for more information.</p></blockquote><p><img src=/__resources/attribute_mapping_75bcec.png alt="Attribute Mapping"></p><p>Users should now create a Service Account that is going to be impersonated by the federated identity.
Make sure to <a href=https://cloud.google.com/service-usage/docs/enable-disable>enable the Google Identity and Access Management (IAM) API</a>.
<a href=https://cloud.google.com/iam/docs/creating-managing-service-accounts>Create a Service Account</a> that shall be used for the Shoot cluster.
<a href=https://cloud.google.com/iam/docs/granting-changing-revoking-access>Grant at least the following IAM roles</a> to the Service Account.</p><ul><li>Service Account Token Creator</li><li>Service Account User</li><li>Compute Admin</li></ul><p>As a next step a resource of type <code>WorkloadIdentity</code> should be created in the Garden cluster and configured with the information from the already downloaded credential configuration file.
This identity will be used to impersonate the Service Account in order to call GCP APIs.</p><p>Mind that the <code>service_account_impersonation_url</code> is probably not present in the downloaded credential configuration file.
You can use the example template or download a new credential configuration file once we grant the permission to the federated identity to impersonate the Service Account.</p><p>A sample of such resource is shown below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: security.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: WorkloadIdentity
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: gcp
</span></span><span style=display:flex><span>  namespace: garden-myproj
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  audiences:
</span></span><span style=display:flex><span>  <span style=color:green># This is the audience that you configure during workload identity pool creation</span>
</span></span><span style=display:flex><span>  - https://iam.googleapis.com/projects/&lt;project_number&gt;/locations/global/workloadIdentityPools/&lt;pool_name&gt;/providers/&lt;provider_name&gt;
</span></span><span style=display:flex><span>  targetSystem:
</span></span><span style=display:flex><span>    type: gcp
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: WorkloadIdentityConfig
</span></span><span style=display:flex><span>      projectID: gcp-project-name <span style=color:green># This is the name of the project which the workload identity will access</span>
</span></span><span style=display:flex><span>      <span style=color:green># Use the downloaded credential configuration file to set this field. The credential_source field is not important to Gardener and can be omitted.</span>
</span></span><span style=display:flex><span>      credentialsConfig:
</span></span><span style=display:flex><span>        universe_domain: <span style=color:#a31515>&#34;googleapis.com&#34;</span>
</span></span><span style=display:flex><span>        type: <span style=color:#a31515>&#34;external_account&#34;</span>
</span></span><span style=display:flex><span>        audience: <span style=color:#a31515>&#34;//iam.googleapis.com/projects/&lt;project_number&gt;/locations/global/workloadIdentityPools/&lt;pool_name&gt;/providers/&lt;provider_name&gt;&#34;</span>
</span></span><span style=display:flex><span>        subject_token_type: <span style=color:#a31515>&#34;urn:ietf:params:oauth:token-type:jwt&#34;</span>
</span></span><span style=display:flex><span>        service_account_impersonation_url: <span style=color:#a31515>&#34;https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/&lt;service_account_email&gt;:generateAccessToken&#34;</span>
</span></span><span style=display:flex><span>        token_url: <span style=color:#a31515>&#34;https://sts.googleapis.com/v1/token&#34;</span>
</span></span></code></pre></div><p>Now users should give permissions to the <code>WorkloadIdentity</code> to impersonate the Service Account.
In order to construct the principal that will be used for impersonation retrieve the subject of the created <code>WorkloadIdentity</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SUBJECT=<span style=color:#00f>$(</span>kubectl -n garden-myproj get workloadidentity gcp -o=jsonpath=<span style=color:#a31515>&#39;{.status.sub}&#39;</span><span style=color:#00f>)</span>
</span></span><span style=display:flex><span>echo <span style=color:#a31515>&#34;principal://iam.googleapis.com/projects/&lt;project_number&gt;/locations/global/workloadIdentityPools/&lt;pool_name&gt;/subject/</span>$SUBJECT<span style=color:#a31515>&#34;</span>
</span></span></code></pre></div><p>The principal template is also shown in the Google Console Workload Identity Pool UI.</p><p>Users should give this principal the Role <code>Workload Identity User</code> so that it can impersonate the Service Account.
One can do this through the Service Account <code>Permissions</code> tab, through the Google Console Workload Identity Pool UI or by using the <a href=https://cloud.google.com/iam/docs/workload-identity-federation-with-kubernetes#use-service-account-impersonation>gcloud cli</a>.</p><p>As a final step create a <code>CredentialsBinding</code> referencing the GCP <code>WorkloadIdentity</code> and use it in your <code>Shoot</code> definitions.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: security.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: CredentialsBinding
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: gcp
</span></span><span style=display:flex><span>  namespace: garden-myproj
</span></span><span style=display:flex><span>credentialsRef:
</span></span><span style=display:flex><span>  apiVersion: security.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: WorkloadIdentity
</span></span><span style=display:flex><span>  name: gcp
</span></span><span style=display:flex><span>  namespace: garden-myproj
</span></span><span style=display:flex><span>provider:
</span></span><span style=display:flex><span>  type: gcp
</span></span></code></pre></div><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>One can omit the creation of Service Account and directly grant access to the federated identity&rsquo;s principal, skipping the Service Account impersonation.
This although recommended, will not always work because federated identities do not fall under the <a href=https://cloud.google.com/iam/docs/principals-overview#all-authenticated-users><code>allAuthenticatedUsers</code></a> category and cannot access machine images that are not made available to <a href=https://cloud.google.com/iam/docs/principals-overview#all-users><code>allUsers</code></a>.
This means that machine images should be made available to <code>allUsers</code> or permissions should be explicitly given to the federated identity in order for this to work.</p><p>GCP imposes some restrictions on which images can be accessible to <code>allUsers</code>.
As of now, <a href=https://github.com/gardenlinux/gardenlinux>Gardenlinux</a> images are not published in a way that they can be accessed by <code>allUsers</code>.
See the following issue for more details <a href=https://github.com/gardenlinux/glci/issues/148>https://github.com/gardenlinux/glci/issues/148</a>.</p></blockquote><h2 id=infrastructureconfig><code>InfrastructureConfig</code><a class=td-heading-self-link href=#infrastructureconfig aria-label="Heading self-link"></a></h2><p>The infrastructure configuration mainly describes how the network layout looks like in order to create the shoot worker nodes in a later step, thus, prepares everything relevant to create VMs, load balancers, volumes, etc.</p><p>An example <code>InfrastructureConfig</code> for the GCP extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: InfrastructureConfig
</span></span><span style=display:flex><span>networks:
</span></span><span style=display:flex><span><span style=color:green># vpc:</span>
</span></span><span style=display:flex><span><span style=color:green>#   name: my-vpc</span>
</span></span><span style=display:flex><span><span style=color:green>#   cloudRouter:</span>
</span></span><span style=display:flex><span><span style=color:green>#     name: my-cloudrouter</span>
</span></span><span style=display:flex><span>  workers: 10.250.0.0/16
</span></span><span style=display:flex><span><span style=color:green># internal: 10.251.0.0/16</span>
</span></span><span style=display:flex><span><span style=color:green># cloudNAT:</span>
</span></span><span style=display:flex><span><span style=color:green>#   minPortsPerVM: 2048</span>
</span></span><span style=display:flex><span><span style=color:green>#   maxPortsPerVM: 65536</span>
</span></span><span style=display:flex><span><span style=color:green>#   endpointIndependentMapping:</span>
</span></span><span style=display:flex><span><span style=color:green>#     enabled: false</span>
</span></span><span style=display:flex><span><span style=color:green>#   enableDynamicPortAllocation: false</span>
</span></span><span style=display:flex><span><span style=color:green>#   natIPNames:</span>
</span></span><span style=display:flex><span><span style=color:green>#   - name: manualnat1</span>
</span></span><span style=display:flex><span><span style=color:green>#   - name: manualnat2</span>
</span></span><span style=display:flex><span><span style=color:green>#   udpIdleTimeoutSec: 30</span>
</span></span><span style=display:flex><span><span style=color:green>#   icmpIdleTimeoutSec: 30</span>
</span></span><span style=display:flex><span><span style=color:green>#   tcpEstablishedIdleTimeoutSec: 1200</span>
</span></span><span style=display:flex><span><span style=color:green>#   tcpTransitoryIdleTimeoutSec: 30</span>
</span></span><span style=display:flex><span><span style=color:green>#   tcpTimeWaitTimeoutSec: 120</span>
</span></span><span style=display:flex><span><span style=color:green># flowLogs:</span>
</span></span><span style=display:flex><span><span style=color:green>#   aggregationInterval: INTERVAL_5_SEC</span>
</span></span><span style=display:flex><span><span style=color:green>#   flowSampling: 0.2</span>
</span></span><span style=display:flex><span><span style=color:green>#   metadata: INCLUDE_ALL_METADATA</span>
</span></span></code></pre></div><p>The <code>networks.vpc</code> section describes whether you want to create the shoot cluster in an already existing VPC or whether to create a new one:</p><ul><li><p>If <code>networks.vpc.name</code> is given then you have to specify the VPC name of the existing VPC that was created by other means (manually, other tooling, &mldr;).
If you want to get a fresh VPC for the shoot then just omit the <code>networks.vpc</code> field.</p></li><li><p>If a VPC name is not given then we will create the cloud router + NAT gateway to ensure that worker nodes don&rsquo;t get external IPs.</p></li><li><p>If a VPC name is given then a cloud router name must also be given, failure to do so would result in validation errors
and possibly clusters without egress connectivity.</p></li><li><p>If a VPC name is given and calico shoot clusters are created without a network overlay within one VPC make sure that the pod CIDR specified in <code>shoot.spec.networking.pods</code> is not overlapping with any other pod CIDR used in that VPC.
Overlapping pod CIDRs will lead to disfunctional shoot clusters.</p></li></ul><p>The <code>networks.workers</code> section describes the CIDR for a subnet that is used for all shoot worker nodes, i.e., VMs which later run your applications.</p><p>The <code>networks.internal</code> section is optional and can describe a CIDR for a subnet that is used for <a href=https://cloud.google.com/load-balancing/docs/internal/>internal load balancers</a>,</p><p>The <code>networks.cloudNAT.minPortsPerVM</code> is optional and is used to define the <a href=https://cloud.google.com/nat/docs/overview#number_of_nat_ports_and_connections>minimum number of ports allocated to a VM for the CloudNAT</a></p><p>The <code>networks.cloudNAT.natIPNames</code> is optional and is used to specify the names of the manual ip addresses which should be used by the nat gateway</p><p>The <code>networks.cloudNAT.endpointIndependentMapping</code> is optional and is used to define the <a href=https://cloud.google.com/nat/docs/ports-and-addresses#ports-reuse-endpoints>endpoint mapping behavior</a>. You can enable it or disable it at any point by toggling <code>networks.cloudNAT.endpointIndependentMapping.enabled</code>. By default, it is disabled.</p><p><code>networks.cloudNAT.enableDynamicPortAllocation</code> is optional (default: <code>false</code>) and allows one to enable dynamic port allocation (<a href=https://cloud.google.com/nat/docs/ports-and-addresses#dynamic-port>https://cloud.google.com/nat/docs/ports-and-addresses#dynamic-port</a>). Note that enabling this puts additional restrictions on the permitted values for <code>networks.cloudNAT.minPortsPerVM</code> and <code>networks.cloudNAT.minPortsPerVM</code>, namely that they now both are required to be powers of two. Also, <code>maxPortsPerVM</code> may not be given if dynamic port allocation is <em>disabled</em>.</p><p><code>networks.cloudNAT.udpIdleTimeoutSec</code>, <code>networks.cloudNAT.icmpIdleTimeoutSec</code>, <code>networks.cloudNAT.tcpEstablishedIdleTimeoutSec</code>, <code>networks.cloudNAT.tcpTransitoryIdleTimeoutSec</code>, and <code>networks.cloudNAT.tcpTimeWaitTimeoutSec</code> give more fine-granular control over various timeout-values. For more details see <a href=https://cloud.google.com/nat/docs/public-nat#specs-timeouts>https://cloud.google.com/nat/docs/public-nat#specs-timeouts</a>.</p><p>The specified CIDR ranges must be contained in the VPC CIDR specified above, or the VPC CIDR of your already existing VPC.
You can freely choose these CIDRs and it is your responsibility to properly design the network layout to suit your needs.</p><p>The <code>networks.flowLogs</code> section describes the configuration for the VPC flow logs. In order to enable the VPC flow logs at least one of the following parameters needs to be specified in the flow log section:</p><ul><li><p><code>networks.flowLogs.aggregationInterval</code> an optional parameter describing the aggregation interval for collecting flow logs. For more details, see <a href=https://www.terraform.io/docs/providers/google/r/compute_subnetwork.html#aggregation_interval>aggregation_interval reference</a>.</p></li><li><p><code>networks.flowLogs.flowSampling</code> an optional parameter describing the sampling rate of VPC flow logs within the subnetwork where 1.0 means all collected logs are reported and 0.0 means no logs are reported. For more details, see <a href=https://www.terraform.io/docs/providers/google/r/compute_subnetwork.html#flow_sampling>flow_sampling reference</a>.</p></li><li><p><code>networks.flowLogs.metadata</code> an optional parameter describing whether metadata fields should be added to the reported VPC flow logs. For more details, see <a href=https://www.terraform.io/docs/providers/google/r/compute_subnetwork.html#metadata>metadata reference</a>.</p></li></ul><p>Apart from the VPC and the subnets the GCP extension will also create a dedicated service account for this shoot, and firewall rules.</p><h2 id=controlplaneconfig><code>ControlPlaneConfig</code><a class=td-heading-self-link href=#controlplaneconfig aria-label="Heading self-link"></a></h2><p>The control plane configuration mainly contains values for the GCP-specific control plane components.
Today, the only component deployed by the GCP extension is the <code>cloud-controller-manager</code>.</p><p>An example <code>ControlPlaneConfig</code> for the GCP extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: ControlPlaneConfig
</span></span><span style=display:flex><span>zone: europe-west1-b
</span></span><span style=display:flex><span>cloudControllerManager:
</span></span><span style=display:flex><span><span style=color:green># featureGates:</span>
</span></span><span style=display:flex><span><span style=color:green>#   SomeKubernetesFeature: true</span>
</span></span><span style=display:flex><span>storage:
</span></span><span style=display:flex><span>  managedDefaultStorageClass: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  managedDefaultVolumeSnapshotClass: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>The <code>zone</code> field tells the cloud-controller-manager in which zone it should mainly operate.
You can still create clusters in multiple availability zones, however, the cloud-controller-manager requires one &ldquo;main&rdquo; zone.
&#9888;&#xfe0f; You always have to specify this field!</p><p>The <code>cloudControllerManager.featureGates</code> contains a map of explicitly enabled or disabled feature gates.
For production usage it&rsquo;s not recommend to use this field at all as you can enable alpha features or disable beta/stable features, potentially impacting the cluster stability.
If you don&rsquo;t want to configure anything for the <code>cloudControllerManager</code> simply omit the key in the YAML specification.</p><p>The members of the <code>storage</code> allows to configure the provided storage classes further. If <code>storage.managedDefaultStorageClass</code> is enabled (the default), the <code>default</code> StorageClass deployed will be marked as default (via <code>storageclass.kubernetes.io/is-default-class</code> annotation). Similarly, if <code>storage.managedDefaultVolumeSnapshotClass</code> is enabled (the default), the <code>default</code> VolumeSnapshotClass deployed will be marked as default.
In case you want to set a different StorageClass or VolumeSnapshotClass as default you need to set the corresponding option to <code>false</code> as at most one class should be marked as default in each case and the ResourceManager will prevent any changes from the Gardener managed classes to take effect.</p><h2 id=workerconfig>WorkerConfig<a class=td-heading-self-link href=#workerconfig aria-label="Heading self-link"></a></h2><p>The worker configuration contains:</p><ul><li><p>Local SSD interface for the additional volumes attached to GCP worker machines.</p><p>If you attach the disk with <code>SCRATCH</code> type, either an <code>NVMe</code> interface or a <code>SCSI</code> interface must be specified.
It is only meaningful to provide this volume interface if only <code>SCRATCH</code> data volumes are used.</p></li><li><p>Volume Encryption config that specifies values for <code>kmsKeyName</code> and <code>kmsKeyServiceAccountName</code>.</p><ul><li>The <code>kmsKeyName</code> is the
key name of the cloud kms disk encryption key and must be specified if CMEK disk encryption is needed.</li><li>The <code>kmsKeyServiceAccount</code> is the service account granted the <code>roles/cloudkms.cryptoKeyEncrypterDecrypter</code> on the <code>kmsKeyName</code>
If empty, then the role should be given to the Compute Engine Service Agent Account. This CESA account usually has the name:
<code>service-PROJECT_NUMBER@compute-system.iam.gserviceaccount.com</code>. See: <a href=https://cloud.google.com/iam/docs/service-agents#compute-engine-service-agent>https://cloud.google.com/iam/docs/service-agents#compute-engine-service-agent</a></li><li>Prior to use, the operator should add IAM policy binding using the gcloud CLI:<pre tabindex=0><code>gcloud projects add-iam-policy-binding projectId --member
serviceAccount:name@projectIdgserviceaccount.com --role roles/cloudkms.cryptoKeyEncrypterDecrypter
</code></pre></li></ul></li><li><p>Setting a volume image with <code>dataVolumes.sourceImage</code>.
However, this parameter should only be used with particular caution.
For example Gardenlinux works with filesystem LABELs only and creating another disk form the very same image causes the LABELs to be duplicated.
See: <a href=https://github.com/gardener/gardener-extension-provider-gcp/issues/323>https://github.com/gardener/gardener-extension-provider-gcp/issues/323</a></p></li><li><p>Some hyperdisks allow adjustment of their default values for <code>provisionedIops</code> and <code>provisionedThroughput</code>.
Keep in mind though that Hyperdisk Extreme and Hyperdisk Throughput volumes can&rsquo;t be used as boot disks.</p></li><li><p>Service Account with their specified scopes, authorized for this worker.</p><p>Service accounts created in advance that generate access tokens that can be accessed through the metadata server and used to authenticate applications on the instance.</p><p><strong>Note</strong>: If you do not provide service accounts for your workers, the Compute Engine default service account will be used. For more details on the default account, see <a href=https://cloud.google.com/compute/docs/access/service-accounts#default_service_account>https://cloud.google.com/compute/docs/access/service-accounts#default_service_account</a>.
If the <code>DisableGardenerServiceAccountCreation</code> feature gate is disabled, Gardener will create a shared service accounts to use for all instances. This feature gate is currently in beta and it will no longer be possible to re-enable the service account creation via feature gate flag.</p></li><li><p>GPU with its type and count per node. This will attach that GPU to all the machines in the worker grp</p><p><strong>Note</strong>:</p><ul><li><p>A rolling upgrade of the worker group would be triggered in case the <code>acceleratorType</code> or <code>count</code> is updated.</p></li><li><p>Some machineTypes like <a href=https://cloud.google.com/blog/products/compute/announcing-google-cloud-a2-vm-family-based-on-nvidia-a100-gpu>a2 family</a> come with already attached gpu of <code>a100</code> type and pre-defined count. If your workerPool consists of such machineTypes, please specify exact GPU configuration for the machine type as specified in Google cloud documentation. <code>acceleratorType</code> to use for families with attached gpu are stated below:</p><ol><li><em>a2 family</em> -> <code>nvidia-tesla-a100</code></li><li><em>g2 family</em> -> <code>nvidia-l4</code></li></ol></li><li><p>Sufficient quota of gpu is needed in the GCP project. This includes quota to support autoscaling if enabled.</p></li><li><p>GPU-attached machines can&rsquo;t be live migrated during host maintenance events. Find out how to handle that in your application <a href=https://cloud.google.com/compute/docs/gpus/gpu-host-maintenance>here</a></p></li><li><p>GPU count specified here is considered for forming node template during scale-from-zero in Cluster Autoscaler</p></li></ul></li><li><p>The <code>.nodeTemplate</code> is used to specify resource information of the machine during runtime. This then helps in Scale-from-Zero.
Some points to note for this field:</p><ul><li>Currently only cpu, gpu and memory are configurable.</li><li>a change in the value lead to a rolling update of the machine in the workerpool</li><li>all the resources needs to be specified</li></ul><p>An example <code>WorkerConfig</code> for the GCP looks as follows:</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: WorkerConfig
</span></span><span style=display:flex><span>volume:
</span></span><span style=display:flex><span>  interface: NVME
</span></span><span style=display:flex><span>  encryption:
</span></span><span style=display:flex><span>    kmsKeyName: <span style=color:#a31515>&#34;projects/projectId/locations/&lt;zoneName&gt;/keyRings/&lt;keyRingName&gt;/cryptoKeys/alpha&#34;</span>
</span></span><span style=display:flex><span>    kmsKeyServiceAccount: <span style=color:#a31515>&#34;user@projectId.iam.gserviceaccount.com&#34;</span>
</span></span><span style=display:flex><span>dataVolumes:
</span></span><span style=display:flex><span>  - name: test
</span></span><span style=display:flex><span>    sourceImage: projects/sap-se-gcp-gardenlinux/global/images/gardenlinux-gcp-gardener-prod-amd64-1443-3-c261f887
</span></span><span style=display:flex><span>    provisionedIops: 3000
</span></span><span style=display:flex><span>    provisionedThroughput: 140
</span></span><span style=display:flex><span>serviceAccount:
</span></span><span style=display:flex><span>  email: foo@bar.com
</span></span><span style=display:flex><span>  scopes:
</span></span><span style=display:flex><span>  - https://www.googleapis.com/auth/cloud-platform
</span></span><span style=display:flex><span>gpu:
</span></span><span style=display:flex><span>  acceleratorType: nvidia-tesla-t4
</span></span><span style=display:flex><span>  count: 1
</span></span><span style=display:flex><span>nodeTemplate: <span style=color:green># (to be specified only if the node capacity would be different from cloudprofile info during runtime)</span>
</span></span><span style=display:flex><span>  capacity:
</span></span><span style=display:flex><span>    cpu: 2
</span></span><span style=display:flex><span>    gpu: 1
</span></span><span style=display:flex><span>    memory: 50Gi
</span></span></code></pre></div><h2 id=example-shoot-manifest>Example <code>Shoot</code> manifest<a class=td-heading-self-link href=#example-shoot-manifest aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-gcp
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfile:
</span></span><span style=display:flex><span>    name: gcp
</span></span><span style=display:flex><span>  region: europe-west1
</span></span><span style=display:flex><span>  secretBindingName: core-gcp
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: gcp
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        workers: 10.250.0.0/16
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>      zone: europe-west1-b
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: n1-standard-4
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: pd-standard
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - europe-west1-b
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.2
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=csi-volume-provisioners>CSI volume provisioners<a class=td-heading-self-link href=#csi-volume-provisioners aria-label="Heading self-link"></a></h2><p>Every GCP shoot cluster will be deployed with the GCP PD CSI driver.
It is compatible with the legacy in-tree volume provisioner that was deprecated by the Kubernetes community and will be removed in future versions of Kubernetes.
End-users might want to update their custom <code>StorageClass</code>es to the new <code>pd.csi.storage.gke.io</code> provisioner.</p><h2 id=support-for-volumeattributesclasses-beta-in-k8s-131>Support for VolumeAttributesClasses (Beta in k8s 1.31)<a class=td-heading-self-link href=#support-for-volumeattributesclasses-beta-in-k8s-131 aria-label="Heading self-link"></a></h2><p>To have the CSI-driver configured to support the necessary features for <a href=https://kubernetes.io/docs/concepts/storage/volume-attributes-classes/>VolumeAttributesClasses</a> on GCP for shoots with a k8s-version greater than 1.31, use the <code>gcp.provider.extensions.gardener.cloud/enable-volume-attributes-class</code> annotation on the shoot. Keep in mind to also enable the required feature flags and runtime-config on the common kubernetes controllers (as outlined in the link above) in the shoot-spec.</p><h2 id=kubernetes-versions-per-worker-pool>Kubernetes Versions per Worker Pool<a class=td-heading-self-link href=#kubernetes-versions-per-worker-pool aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>WorkerPoolKubernetesVersion</code> feature gate, i.e., having <a href=https://github.com/gardener/gardener/blob/8a9c88866ec5fce59b5acf57d4227eeeb73669d7/example/90-shoot.yaml#L69-L70>worker pools with overridden Kubernetes versions</a> since <code>gardener-extension-provider-gcp@v1.21</code>.</p><h2 id=shoot-ca-certificate-and-serviceaccount-signing-key-rotation>Shoot CA Certificate and <code>ServiceAccount</code> Signing Key Rotation<a class=td-heading-self-link href=#shoot-ca-certificate-and-serviceaccount-signing-key-rotation aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>ShootCARotation</code> and <code>ShootSARotation</code> feature gates since <code>gardener-extension-provider-gcp@v1.23</code>.</p><h2 id=backupbucket>BackupBucket<a class=td-heading-self-link href=#backupbucket aria-label="Heading self-link"></a></h2><p>Gardener manages <code>etcd</code> backups for Shoot clusters using provider-specific backup storage solutions. On GCP, this storage is implemented through <a href=https://cloud.google.com/storage/docs/buckets#buckets>Google Cloud Storage (GCS) buckets</a>, which store snapshots of the cluster’s <code>etcd</code> data.</p><p>The <code>BackupBucket</code> resource abstracts the backup infrastructure, enabling Gardener and its extension controllers to manage it seamlessly. This abstraction allows Gardener to create, delete, and maintain backup buckets across various cloud providers in a standardized manner.</p><p>The <code>BackupBucket</code> resource includes a <code>spec</code> field, which defines the configuration details for the backup bucket. These details include:</p><ul><li>The region where the bucket should be created.</li><li>A reference to the secret containing credentials for accessing the cloud provider.</li><li>A <code>ProviderConfig</code> field for provider-specific configurations.</li></ul><h3 id=backupbucketconfig>BackupBucketConfig<a class=td-heading-self-link href=#backupbucketconfig aria-label="Heading self-link"></a></h3><p>The <code>BackupBucketConfig</code> represents the configuration for a backup bucket. It includes an optional immutability configuration that enforces retention policies on the backup bucket.</p><p>The Gardener extension provider for GCP supports creating and managing immutable backup buckets by leveraging the <a href=https://cloud.google.com/storage/docs/bucket-lock>bucket lock</a> feature. Immutability ensures that once data is written to the bucket, it cannot be modified or deleted for a specified period. This feature is crucial for protecting backups from accidental or malicious deletion, ensuring data safety and availability for restoration.</p><p>Here is an example configuration for <code>BackupBucketConfig</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: BackupBucketConfig
</span></span><span style=display:flex><span>immutability:
</span></span><span style=display:flex><span>  retentionType: bucket
</span></span><span style=display:flex><span>  retentionPeriod: <span style=color:#a31515>&#34;24h&#34;</span>
</span></span><span style=display:flex><span>  locked: <span style=color:#00f>false</span>
</span></span></code></pre></div><ul><li><strong><code>retentionType</code></strong>: Specifies the type of retention policy. The allowed value is <code>bucket</code>, which applies the retention policy to the entire bucket. For more details, refer to the <a href=https://cloud.google.com/storage/docs/bucket-lock>documentation</a>.</li><li><strong><code>retentionPeriod</code></strong>: Defines the duration for which objects in the bucket will remain immutable. The value should follow GCP-supported formats, such as <code>"24h"</code> for 24 hours. Refer to <a href=https://cloud.google.com/storage/docs/bucket-lock#retention-periods>retention period formats</a> for more information. The minimum retention period is <strong>24 hours</strong>.</li><li><strong><code>locked</code></strong>: A boolean indicating whether the retention policy is locked. Once locked, the policy cannot be removed or shortened, ensuring immutability. Learn more about locking policies <a href=https://cloud.google.com/storage/docs/bucket-lock#policy-locks>here</a>.</li></ul><p>To configure a <code>BackupBucket</code> with immutability, include the <code>BackupBucketConfig</code> in the <code>ProviderConfig</code> of the <code>BackupBucket</code> resource. If the <code>locked</code> field is set to <code>true</code>, the retention policy will be locked, preventing further changes.</p><p>Here is an example of configuring a <code>BackupBucket</code> with immutability:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: BackupBucket
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-backup-bucket
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    region: europe-west1
</span></span><span style=display:flex><span>  secretRef:
</span></span><span style=display:flex><span>    name: my-gcp-secret
</span></span><span style=display:flex><span>    namespace: my-namespace
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: BackupBucketConfig
</span></span><span style=display:flex><span>    immutability:
</span></span><span style=display:flex><span>      retentionType: bucket
</span></span><span style=display:flex><span>      retentionPeriod: 24h
</span></span><span style=display:flex><span>      locked: <span style=color:#00f>true</span>
</span></span></code></pre></div></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://x.com/GardenerProject><img src=/images/branding/x-logo-white.svg class=media-icon><div class=media-text>X</div></a></li></ul><span class=copyright>Copyright 2019-2025 Gardener project authors.
<a href=https://www.sap.com/about/legal/terms-of-use.html>Terms of Use
<i class="fa fa-external-link" aria-hidden=true></i>
</a>|
<a href=https://www.sap.com/about/legal/terms-of-use.html>Privacy Statement
<i class="fa fa-external-link" aria-hidden=true></i>
</a>|
<a href=https://www.sap.com/about/legal/terms-of-use.html>Legal Disclosure
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>