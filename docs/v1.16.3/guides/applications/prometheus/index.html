<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta name=copyright content="Copyright 2019-2021 Gardener project authors."><meta name=google-site-verification content="9EoGiMwk2aq0E_tVh16iJgJbp7fbyqkfWH9b5sGybl0"><title>Using Prometheus and Grafana to monitor K8s :: Gardener</title><link rel=icon type=image/x-icon href=https://gardener.cloud/images/favicon.ico><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-16x16.png sizes=16x16><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-W2FGNSX');</script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-165447164-1');</script><link href=/css/font-awesome.min.css?1619285172 rel=stylesheet><link href=/css/skeleton.css?1619285172 rel=stylesheet><link rel=preload href=/fonts/sap-icofonts/sap-icofonts.woff as=font type=font/woff crossorigin=anonymous><link rel=preload href=/fonts/sapcom-icons/sapcom-icons.woff as=font type=font/woff crossorigin=anonymous><link rel=stylesheet href=/css/sapcom-icons.css><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/gardener.b459b7f22c26be8e2f608a181d5372c6e44f06cf007c350346ccf5fadbe04a74.css><script src=/js/moment.js?1619285172></script><script src=/js/inlineSVG.js?1619285172></script><script src=/js/jquery.min.js?1619285172></script><script src=/jquery-ui-1.12.1/jquery-ui.min.js?1619285172></script><script src=/js/fixed.js?1619285172></script><script src=/js/clipboard.min.js?1619285172></script><script src=https://platform.linkedin.com/in.js type=text/javascript>lang:en_US</script></head><body data-url=/v1.16.3/guides/applications/prometheus/ class=has-sticky-navigation><script>$(document).ready(function(){function initStickyNav(){var stickyPoint;var tln=document.querySelector(".tln");if(!tln){return;}
var stickyPointEl=document.querySelector(".sticky-nav-point");if(stickyPointEl==null){stickyPointEl=document.querySelector("body");stickyPoint=0;}else{stickyPoint=stickyPointEl.clientHeight+stickyPointEl.offsetTop;}
var bodySelector=document.getElementsByTagName("body")[0];var tlnHeight=tln.clientHeight;var stickyNavigation=function(){if(window.pageYOffset+tlnHeight>=stickyPoint){bodySelector.classList.add("has-sticky-navigation");tln.classList.add("sticky-top");}else{bodySelector.classList.remove("has-sticky-navigation");tln.classList.remove("sticky-top");}}
window.onscroll=function(){stickyNavigation();};}
initStickyNav();function closeAllSelect(){document.getElementById("docOptions").classList.remove("show");}
function show(e){e.stopPropagation();document.getElementById("docOptions").classList.add("show");}
document.addEventListener("click",closeAllSelect);document.getElementById("docSelector").addEventListener("click",show);});</script><div class="tln fixedsticky sticky-top"><header class=navigation><div class=container><div class=navigation-wrapper><a href=/ class=logo><img src=/images/gardener-logo.svg>
<span class=title>Gardener</span></a>
<a class="nav-button navbar-toggler" href=#><i class="fa fa-bars"></i></a><div class=navbar-collapse><ul class=links><li class=link><a href=/blog/>Blogs</a></li><li class=link><a href=/community/>Community</a></li><li class=link><a href=/adopter/>Adopters</a></li><li class="link has-child active"><a id=docSelector>Documentation v1.16.3</a><div id=docOptions class=doc-options><ul><li><a href=/documentation/guides/applications/prometheus/>Documentation
v1.17.1</a></li><li><a href=/v1.16.3/home class=activeVersion>Documentation
v1.16.3</a></li><li><a href=/v1.15.5/guides/applications/prometheus/>Documentation
v1.15.5</a></li></ul></div></li></ul></div></div></div></header></div><script>$(".navigation .navbar-toggler").click(function(evt){$(".navigation .navbar-collapse").toggle();$(".navigation").toggleClass("collapsed");$(".navigation .search-box").toggle();})</script><style>#docSelector{cursor:pointer}.doc-options{position:fixed;background-color:#0b8062;text-align:left;display:none}.doc-options ul li{margin-bottom:0}.doc-options ul li a:hover{background-color:#0c694f}.doc-options ul{list-style:none;padding:0;margin:0;text-align:left}.doc-options ul li a{padding:10px;margin:0}.doc-options .activeVersion{background-color:#ec682a}.show{display:block}</style><div class=sln><div class=overlay-band><ul class="nav-list container"><li title=Home><a class=navbar-link href=/v1.16.3/home/>Home</a></li><li title=Concepts><a class=navbar-link href=/v1.16.3/concepts/>Concepts</a></li><li title="How-To Guides"><a class="navbar-link is-active" href=/v1.16.3/guides/>How-To Guides</a></li><li title=Tutorials><a class=navbar-link href=/v1.16.3/tutorials/>Tutorials</a></li><li title="API Reference"><a class=navbar-link href=/v1.16.3/references/>API Reference</a></li><li title=Contribute><a class=navbar-link href=/v1.16.3/contribute/>Contribute</a></li></ul></div></div><div class="main container"><nav id=sidebar class="collapsed container menu"><div class=highlightable><ul class=topics><li data-nav-id=/v1.16.3/guides/ title="How-To Guides" class="dd-item parent root collapsible" data-depth=0><a href=/v1.16.3/guides/><span class=menu-item-text>How-To Guides</span></a><ul><li data-nav-id=/v1.16.3/guides/client_tools/ title="Set Up Client Tools" class="dd-item top-level collapsible collapsed" data-depth=1><a href=/v1.16.3/guides/client_tools/><span class="toggle fa fa-angle-right"></span><span class=menu-item-text>Set Up Client Tools</span></a><ul><li data-nav-id=/v1.16.3/guides/client_tools/kubectl-apiserver/ title="Automated deployment" class=dd-item data-depth=2><a href=/v1.16.3/guides/client_tools/kubectl-apiserver/><span class=toggle></span><span class=menu-item-text>Automated deployment</span></a></li><li data-nav-id=/v1.16.3/guides/client_tools/bash_kubeconfig/ title="Kubeconfig context as bash prompt" class=dd-item data-depth=2><a href=/v1.16.3/guides/client_tools/bash_kubeconfig/><span class=toggle></span><span class=menu-item-text>Kubeconfig context as bash prompt</span></a></li><li data-nav-id=/v1.16.3/guides/client_tools/working-with-kubeconfig/ title="Organizing Access Using kubeconfig Files" class=dd-item data-depth=2><a href=/v1.16.3/guides/client_tools/working-with-kubeconfig/><span class=toggle></span><span class=menu-item-text>Organizing Access Using kubeconfig Files</span></a></li><li data-nav-id=/v1.16.3/guides/client_tools/helm/ title="Use a Helm chart to deploy some application or service" class=dd-item data-depth=2><a href=/v1.16.3/guides/client_tools/helm/><span class=toggle></span><span class=menu-item-text>Use a Helm chart to deploy some application or service</span></a></li></ul></li><li data-nav-id=/v1.16.3/guides/install_gardener/ title="Install Gardener" class="dd-item top-level collapsible collapsed" data-depth=1><a href=/v1.16.3/guides/install_gardener/><span class="toggle fa fa-angle-right"></span><span class=menu-item-text>Install Gardener</span></a><ul><li data-nav-id=/v1.16.3/guides/install_gardener/setup/ title="Gardener Certificate Management" class=dd-item data-depth=2><a href=/v1.16.3/guides/install_gardener/setup/><span class=toggle></span><span class=menu-item-text></span>Gardener Certificate Management</span></a></a></li><li data-nav-id=/v1.16.3/guides/install_gardener/secure-setup/ title="Hardening the Gardener Community Setup" class=dd-item data-depth=2><a href=/v1.16.3/guides/install_gardener/secure-setup/><span class=toggle></span><span class=menu-item-text>Hardening the Gardener Community Setup</span></a></li><li data-nav-id=/v1.16.3/guides/install_gardener/landscape-setup/ title="Landscape Setup" class=dd-item data-depth=2><a href=/v1.16.3/guides/install_gardener/landscape-setup/><span class=toggle></span><span class=menu-item-text>Landscape Setup</span></a></li><li data-nav-id=/v1.16.3/guides/install_gardener/add-node-to-cluster/ title="Manually adding a node to an existing cluster" class=dd-item data-depth=2><a href=/v1.16.3/guides/install_gardener/add-node-to-cluster/><span class=toggle></span><span class=menu-item-text>Manually adding a node to an existing cluster</span></a></li><li data-nav-id=/v1.16.3/guides/install_gardener/setup-seed/ title="Setting up a Seed Cluster" class=dd-item data-depth=2><a href=/v1.16.3/guides/install_gardener/setup-seed/><span class=toggle></span><span class=menu-item-text>Setting up a Seed Cluster</span></a></li></ul></li><li data-nav-id=/v1.16.3/guides/administer_shoots/ title="Administer Client (Shoot) Clusters" class="dd-item top-level collapsible collapsed" data-depth=1><a href=/v1.16.3/guides/administer_shoots/><span class="toggle fa fa-angle-right"></span><span class=menu-item-text>Administer Client (Shoot) Clusters</span></a><ul><li data-nav-id=/v1.16.3/guides/administer_shoots/hibernate-cluster/ title="Hibernate a Cluster" class=dd-item data-depth=2><a href=/v1.16.3/guides/administer_shoots/hibernate-cluster/><span class=toggle></span><span class=menu-item-text>Hibernate a Cluster</span></a></li><li data-nav-id=/v1.16.3/guides/administer_shoots/create-delete-shoot/ title="Create / Delete a Shoot cluster" class=dd-item data-depth=2><a href=/v1.16.3/guides/administer_shoots/create-delete-shoot/><span class=toggle></span><span class=menu-item-text>Create / Delete a Shoot cluster</span></a></li><li data-nav-id=/v1.16.3/guides/administer_shoots/gardener_aws/ title="Create a kubernetes cluster in AWS with Gardener" class=dd-item data-depth=2><a href=/v1.16.3/guides/administer_shoots/gardener_aws/><span class=toggle></span><span class=menu-item-text>Create a kubernetes cluster in AWS with Gardener</span></a></li><li data-nav-id=/v1.16.3/guides/administer_shoots/gardener_gcp/ title="Create a kubernetes cluster on GCP with Gardener" class=dd-item data-depth=2><a href=/v1.16.3/guides/administer_shoots/gardener_gcp/><span class=toggle></span><span class=menu-item-text>Create a kubernetes cluster on GCP with Gardener</span></a></li><li data-nav-id=/v1.16.3/guides/administer_shoots/create-shoot-into-existing-aws-vpc/ title="Create a Shoot cluster into existing AWS VPC" class=dd-item data-depth=2><a href=/v1.16.3/guides/administer_shoots/create-shoot-into-existing-aws-vpc/><span class=toggle></span><span class=menu-item-text>Create a Shoot cluster into existing AWS VPC</span></a></li><li data-nav-id=/v1.16.3/guides/administer_shoots/gardener-alibaba/ title="Create Shoot Clusters in Alibaba Cloud" class=dd-item data-depth=2><a href=/v1.16.3/guides/administer_shoots/gardener-alibaba/><span class=toggle></span><span class=menu-item-text>Create Shoot Clusters in Alibaba Cloud</span></a></li><li data-nav-id=/v1.16.3/guides/administer_shoots/gardener_azure/ title=Index class=dd-item data-depth=2><a href=/v1.16.3/guides/administer_shoots/gardener_azure/><span class=toggle></span><span class=menu-item-text></span>Index</span></a></a></li><li data-nav-id=/v1.16.3/guides/administer_shoots/dns_providers/ title="Manage DNS Providers" class=dd-item data-depth=2><a href=/v1.16.3/guides/administer_shoots/dns_providers/><span class=toggle></span><span class=menu-item-text></span>Manage DNS Providers</span></a></a></li><li data-nav-id=/v1.16.3/guides/administer_shoots/dns_names/ title="Request DNS Names" class=dd-item data-depth=2><a href=/v1.16.3/guides/administer_shoots/dns_names/><span class=toggle></span><span class=menu-item-text></span>Request DNS Names</span></a></a></li><li data-nav-id=/v1.16.3/guides/administer_shoots/request_cert/ title="Request X.509 Certificates" class=dd-item data-depth=2><a href=/v1.16.3/guides/administer_shoots/request_cert/><span class=toggle></span><span class=menu-item-text></span>Request X.509 Certificates</span></a></a></li><li data-nav-id=/v1.16.3/guides/administer_shoots/maintain-shoot/ title="Shoot Cluster Maintenance" class=dd-item data-depth=2><a href=/v1.16.3/guides/administer_shoots/maintain-shoot/><span class=toggle></span><span class=menu-item-text>Shoot Cluster Maintenance</span></a></li><li data-nav-id=/v1.16.3/guides/administer_shoots/trigger-shoot-operations/ title="Trigger Shoot operations" class=dd-item data-depth=2><a href=/v1.16.3/guides/administer_shoots/trigger-shoot-operations/><span class=toggle></span><span class=menu-item-text></span>Trigger Shoot operations</span></a></a></li><li data-nav-id=/v1.16.3/guides/administer_shoots/trigger-shoot-operations/ title="Trigger Shoot operations" class=dd-item data-depth=2><a href=/v1.16.3/guides/administer_shoots/trigger-shoot-operations/><span class=toggle></span><span class=menu-item-text>Trigger Shoot operations</span></a></li></ul></li><li data-nav-id=/v1.16.3/guides/monitoring_and_troubleshooting/ title="Monitor and Troubleshoot" class="dd-item top-level collapsible collapsed" data-depth=1><a href=/v1.16.3/guides/monitoring_and_troubleshooting/><span class="toggle fa fa-angle-right"></span><span class=menu-item-text>Monitor and Troubleshoot</span></a><ul><li data-nav-id=/v1.16.3/guides/monitoring_and_troubleshooting/shell-to-node/ title="Get a Shell to a Gardener Shoot Worker Node" class=dd-item data-depth=2><a href=/v1.16.3/guides/monitoring_and_troubleshooting/shell-to-node/><span class=toggle></span><span class=menu-item-text>Get a Shell to a Gardener Shoot Worker Node</span></a></li><li data-nav-id=/v1.16.3/guides/monitoring_and_troubleshooting/debug-a-pod/ title="How to debug a pod" class=dd-item data-depth=2><a href=/v1.16.3/guides/monitoring_and_troubleshooting/debug-a-pod/><span class=toggle></span><span class=menu-item-text>How to debug a pod</span></a></li><li data-nav-id=/v1.16.3/guides/monitoring_and_troubleshooting/tail-logfile/ title="tail -f /var/log/my-application.log" class=dd-item data-depth=2><a href=/v1.16.3/guides/monitoring_and_troubleshooting/tail-logfile/><span class=toggle></span><span class=menu-item-text>tail -f /var/log/my-application.log</span></a></li></ul></li><li data-nav-id=/v1.16.3/guides/applications/ title=Applications class="dd-item parent top-level collapsible" data-depth=1><a href=/v1.16.3/guides/applications/><span class="toggle fa fa-angle-down"></span><span class=menu-item-text>Applications</span></a><ul><li data-nav-id=/v1.16.3/guides/applications/access_pod_from_local/ title="Access a port of a pod locally" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/access_pod_from_local/><span class=toggle></span><span class=menu-item-text>Access a port of a pod locally</span></a></li><li data-nav-id=/v1.16.3/guides/applications/service-access/ title="Access service from outside Kubernetes cluster" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/service-access/><span class=toggle></span><span class=menu-item-text>Access service from outside Kubernetes cluster</span></a></li><li data-nav-id=/v1.16.3/guides/applications/insecure-configuration/ title="Auditing Kubernetes for Secure Setup" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/insecure-configuration/><span class=toggle></span><span class=menu-item-text>Auditing Kubernetes for Secure Setup</span></a></li><li data-nav-id=/v1.16.3/guides/applications/missing-registry-permission/ title="Container image not pulled" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/missing-registry-permission/><span class=toggle></span><span class=menu-item-text>Container image not pulled</span></a></li><li data-nav-id=/v1.16.3/guides/applications/image-pull-policy/ title="Container image not updating" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/image-pull-policy/><span class=toggle></span><span class=menu-item-text>Container image not updating</span></a></li><li data-nav-id=/v1.16.3/guides/applications/secure-seccomp/ title="Custom Seccomp profile" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/secure-seccomp/><span class=toggle></span><span class=menu-item-text>Custom Seccomp profile</span></a></li><li data-nav-id=/v1.16.3/guides/applications/dockerfile_pitfall/ title="Dockerfile pitfalls" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/dockerfile_pitfall/><span class=toggle></span><span class=menu-item-text>Dockerfile pitfalls</span></a></li><li data-nav-id=/v1.16.3/guides/applications/https/ title="HTTPS with self Signed Certificate" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/https/><span class=toggle></span><span class=menu-item-text></span>HTTPS with self Signed Certificate</span></a></a></li><li data-nav-id=/v1.16.3/guides/applications/https/ title="HTTPS with self Signed Certificate" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/https/><span class=toggle></span><span class=menu-item-text>HTTPS with self Signed Certificate</span></a></li><li data-nav-id=/v1.16.3/guides/applications/content_trust/ title="Integrity and Immutability" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/content_trust/><span class=toggle></span><span class=menu-item-text>Integrity and Immutability</span></a></li><li data-nav-id=/v1.16.3/guides/applications/antipattern/ title="Kubernetes Antipatterns" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/antipattern/><span class=toggle></span><span class=menu-item-text>Kubernetes Antipatterns</span></a></li><li data-nav-id=/v1.16.3/guides/applications/network-isolation/ title="Namespace Isolation" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/network-isolation/><span class=toggle></span><span class=menu-item-text>Namespace Isolation</span></a></li><li data-nav-id=/v1.16.3/guides/applications/container-startup/ title="Orchestration of container startup" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/container-startup/><span class=toggle></span><span class=menu-item-text>Orchestration of container startup</span></a></li><li data-nav-id=/v1.16.3/guides/applications/service-cache-control/ title="Out-Dated HTML and JS files delivered" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/service-cache-control/><span class=toggle></span><span class=menu-item-text>Out-Dated HTML and JS files delivered</span></a></li><li data-nav-id=/v1.16.3/guides/applications/commit_secret_fail/ title="Storing secrets in git ðŸ’€" class=dd-item data-depth=2><a href=/v1.16.3/guides/applications/commit_secret_fail/><span class=toggle></span><span class=menu-item-text>Storing secrets in git ðŸ’€</span></a></li><li data-nav-id=/v1.16.3/guides/applications/prometheus/ title="Using Prometheus and Grafana to monitor K8s" class="dd-item parent active" data-depth=2><a href=/v1.16.3/guides/applications/prometheus/><span class=toggle></span><span class=menu-item-text>Using Prometheus and Grafana to monitor K8s</span></a></li></ul></li><li data-nav-id=/v1.16.3/guides/gardener-cookies/ title="Gardener Cookies" class="dd-item top-level" data-depth=1><a href=/v1.16.3/guides/gardener-cookies/><span class=toggle></span><span class=menu-item-text>Gardener Cookies</span></a></li><li data-nav-id=/v1.16.3/guides/landscape-setup/ title="Landscape Setup" class="dd-item top-level" data-depth=1><a href=/v1.16.3/guides/landscape-setup/><span class=toggle></span><span class=menu-item-text></span>Landscape Setup</span></a></a></li></ul></li></ul></div></nav><a href=# class=menu-toggler><i class="fa fa-angle-double-left"></i></a><script>$(document).ready(function(){$("#sidebar .dd-item:not(.top-level):not(.parent)").hide();$("#sidebar .dd-item.parent").siblings(".dd-item").show();$('.dd-item',"#sidebar .dd-item.parent").show();$(".menu-toggler").click(function(evt){$("#sidebar").toggleClass("collapsed");$(".menu-toggler span").toggleClass("fa-angle-double-left");$(".menu-toggler span").toggleClass("fa-angle-double-right");});})</script><section><div class="highlightable body-inner-wrapper"><div id=body-inner><div class="docs page"><div class=git-wr><div class=origin-tools><div class=page-edit><span class=last-update>Last update:
<span data-publishdate="2020-06-17 19:34:37"></span></span><div id=top-github-link><a class=github-link title="Edit page" href=https://github.com/gardener/documentation/edit/master/website/documentation/guides/applications/prometheus/_index.md target=blank><i class="fa fa-edit"></i><span id=top-github-link-text title="Edit page"></span></a></div></div></div></div><h1>Using Prometheus and Grafana to monitor K8s</h1><div class=properties><div class=expertise-level><span class=label title="Expertse level">Expertise</span><svg class="icon level" aria-hidden="true" focusable="false" title="advanced"><use xlink:href="/images/icons/icons.svg#level-3"/></svg></div></div><h2 id=disclaimer>Disclaimer</h2><p>This post is meant to give a basic end-to-end description for deploying and using Prometheus and Grafana. Both
applications offer a wide range of flexibility which needs to be considered in case you have specific requirenments.
Such advanced details are not in the scope of this post.</p><h2 id=introduction>Introduction</h2><p><a href=https://prometheus.io/>Prometheus</a> is an open-source systems monitoring and alerting toolkit for recording numeric
time series. It fits both machine-centric monitoring as well as monitoring of highly dynamic service-oriented
architectures. In a world of microservices, its support for multi-dimensional data collection and querying is a
particular strength.</p><p>Prometheus graduates within CNCF <a href=https://prometheus.io/blog/2018/08/09/prometheus-graduates-within-cncf/>second hosted project</a>.</p><p>The following characteristics make Prometheus a good match for monitoring Kubernetes clusters:</p><ul><li><p>Pull-based monitoring<br>Prometheus is a <a href=https://prometheus.io/blog/2016/07/23/pull-does-not-scale-or-does-it/>pull-based</a> monitoring system,
which means that the Prometheus server dynamically discovers and pulls metrics from your services running in
Kubernetes.</p></li><li><p>Labels
Prometheus and Kubernetes share the same label (key-value) concept that can be used to select objects in the system.<br>Labels are used to identify time series and sets of label matchers can be used in the query language
( <a href=https://prometheus.io/docs/prometheus/latest/querying/basics/>PromQL</a> ) to select the time series to be aggregated..</p></li><li><p>Exporters<br>There are many <a href=https://prometheus.io/docs/instrumenting/exporters/>exporters</a> available which enable integration of
databases or even other monitoring systems not already providing a way to export metrics to Prometheus.
One prominent exporter is the so called <a href=https://github.com/prometheus/node_exporter>node-exporter</a>, which allows to
monitor hardware and OS related metrics of Unix systems.</p></li><li><p>Powerful query language<br>The Prometheus query language <a href=https://prometheus.io/docs/prometheus/latest/querying/basics/>PromQL</a> lets the user
select and aggregate time series data in real time. Results can either be shown as a graph, viewed
as tabular data in the Prometheus expression browser, or consumed by external systems via the <a href=https://prometheus.io/docs/prometheus/latest/querying/api/>HTTP API</a>.</p></li></ul><p>Find query examples on <a href=https://github.com/infinityworks/prometheus-example-queries/blob/master/README.md>Prometheus Query Examples</a>.</p><p>One very popular open-source visualization tool not only for Prometheus is <a href=https://grafana.com>Grafana</a>. Grafana is a
metric analytics and visualization suite. It is popular for for visualizing time series data for infrastructure
and application analytics but many use it in other domains including industrial sensors, home automation, weather, and
process control [see <a href=http://docs.grafana.org/>Grafana Documentation</a>].</p><p>Grafana accesses data via <a href=http://docs.grafana.org/guides/basic_concepts/>Data Sources</a>. The continuously growing
list of supported backends includes Prometheus.</p><p>Dashboards are created by combining panels, e.g. <a href=http://docs.grafana.org/reference/graph/>Graph</a> and <a href=http://docs.grafana.org/reference/dashlist/>Dashlist</a>.</p><p>In this example we describe an End-To-End scenario including the deployment of Prometheus and a basic monitoring
configuration as the one provided for Kubernetes clusters created by Gardener.</p><p>If you miss elements on the Prometheus web page when accessing it via its service URL <code>https://&lt;your K8s FQN>/api/v1/namespaces/&lt;your-prometheus-namespace>/services/prometheus-prometheus-server:80/proxy</code>
this is probably caused by Prometheus issue <a href=https://github.com/prometheus/prometheus/issues/1583>#1583</a>
To workaround this issue setup a port forward <code>kubectl port-forward -n &lt;your-prometheus-namespace> &lt;prometheus-pod> 9090:9090</code>
on your client and access the Prometheus UI from there with your locally installed web browser. This issue is not relevant
in case you use the service type <code>LoadBalancer</code>.</p><h2 id=preparation>Preparation</h2><p>The deployment of <a href=https://github.com/kubernetes/charts/tree/master/stable/prometheus>Prometheus</a> and <a href=https://github.com/kubernetes/charts/tree/master/stable/grafana>Grafana</a> is based on Helm charts.<br>Make sure to implement the <a href=/v1.16.3/guides/client_tools/helm>Helm settings</a> before deploying the Helm charts.</p><p>The Kubernetes clusters provided by <a href=https://github.com/gardener>Gardener</a> use role based
access control (<a href=https://kubernetes.io/docs/admin/authorization/rbac/>RBAC</a>). To authorize the Prometheus
node-exporter to access hardware and OS relevant metrics of your cluster&rsquo;s worker nodes specific artifacts need to be
deployed.</p><p>Bind the prometheus service account to the <code>garden.sapcloud.io:monitoring:prometheus</code> cluster role by running the command
<code>kubectl apply -f crbinding.yaml</code>.</p><p>Content of <code>crbinding.yaml</code></p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;your-prometheus-name&gt;-server</span><span class=w>
</span><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>garden.sapcloud.io:monitoring:prometheus</span><span class=w>
</span><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;your-prometheus-name&gt;-server</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>&lt;your-prometheus-namespace&gt;</span><span class=w>
</span></code></pre></div><h2 id=deployment-of-prometheus-and-grafana>Deployment of Prometheus and Grafana</h2><p>Only minor changes are needed to deploy <a href=https://github.com/kubernetes/charts/tree/master/stable/prometheus>Prometheus</a>
and <a href=https://github.com/kubernetes/charts/tree/master/stable/grafana>Grafana</a> based on Helm charts.</p><p>Copy the following configuration into a file called values.yaml and deploy Prometheus: <code>helm install &lt;your-prometheus-name> --namespace &lt;your-prometheus-namespace> stable/prometheus -f values.yaml</code></p><p>Typically, Prometheus and Grafana are deployed into the same namespace. There is no technical reason behind this so feel
free to choose different namespaces.</p><p>Content of <code>values.yaml</code> for Prometheus:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>rbac</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>create</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># Already created in Preparation step</span><span class=w>
</span><span class=w></span><span class=nt>nodeExporter</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># The node-exporter is already deployed by default</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>server</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>global</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span><span class=w>    </span><span class=nt>scrape_timeout</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>serverFiles</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>prometheus.yml</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>rule_files</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>/etc/config/rules</span><span class=w>
</span><span class=w>      </span>- <span class=l>/etc/config/alerts      </span><span class=w>
</span><span class=w>    </span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kube-kubelet&#39;</span><span class=w>
</span><span class=w>      </span><span class=nt>honor_labels</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>      </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>https</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>tls_config</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=c># This is needed because the kubelets&#39; certificates are not generated</span><span class=w>
</span><span class=w>      </span><span class=c># for a specific pod IP</span><span class=w>
</span><span class=w>        </span><span class=nt>insecure_skip_verify</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>bearer_token_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>node</span><span class=w>
</span><span class=w>      </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span><span class=w>        </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>/metrics</span><span class=w>
</span><span class=w>      </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_node_address_InternalIP]</span><span class=w>
</span><span class=w>        </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>instance</span><span class=w>
</span><span class=w>      </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span><span class=w>        </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_node_label_(.+)</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kube-kubelet-cadvisor&#39;</span><span class=w>
</span><span class=w>      </span><span class=nt>honor_labels</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>      </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>https</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>tls_config</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=c># This is needed because the kubelets&#39; certificates are not generated</span><span class=w>
</span><span class=w>      </span><span class=c># for a specific pod IP</span><span class=w>
</span><span class=w>        </span><span class=nt>insecure_skip_verify</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>bearer_token_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>node</span><span class=w>
</span><span class=w>      </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span><span class=w>        </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>/metrics/cadvisor</span><span class=w>
</span><span class=w>      </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_node_address_InternalIP]</span><span class=w>
</span><span class=w>        </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>instance</span><span class=w>
</span><span class=w>      </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span><span class=w>        </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_node_label_(.+)</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=c># Example scrape config for probing services via the Blackbox Exporter.</span><span class=w>
</span><span class=w>    </span><span class=c>#</span><span class=w>
</span><span class=w>    </span><span class=c># Relabelling allows to configure the actual service scrape endpoint using the following annotations:</span><span class=w>
</span><span class=w>    </span><span class=c>#</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/probe`: Only probe services that have a value of `true`</span><span class=w>
</span><span class=w>    </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubernetes-services&#39;</span><span class=w>
</span><span class=w>      </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=l>/probe</span><span class=w>
</span><span class=w>      </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>module</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>http_2xx]</span><span class=w>
</span><span class=w>      </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>service</span><span class=w>
</span><span class=w>      </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_prometheus_io_probe]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__address__]</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__param_target</span><span class=w>
</span><span class=w>        </span>- <span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span><span class=w>          </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>blackbox</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__param_target]</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>instance</span><span class=w>
</span><span class=w>        </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_service_label_(.+)</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_namespace]</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_namespace</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_name]</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_name</span><span class=w>
</span><span class=w>    </span><span class=c># Example scrape config for pods</span><span class=w>
</span><span class=w>    </span><span class=c>#</span><span class=w>
</span><span class=w>    </span><span class=c># Relabelling allows to configure the actual service scrape endpoint using the following annotations:</span><span class=w>
</span><span class=w>    </span><span class=c>#</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/scrape`: Only scrape pods that have a value of `true`</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/path`: If the metrics path is not `/metrics` override this.</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/port`: Scrape the pod on the indicated port instead of the default of `9102`.</span><span class=w>
</span><span class=w>    </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubernetes-pods&#39;</span><span class=w>
</span><span class=w>      </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>pod</span><span class=w>
</span><span class=w>      </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_pod_annotation_prometheus_io_path]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+):(?:\d+);(\d+)</span><span class=w>
</span><span class=w>          </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>${1}:${2}</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span><span class=w>        </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_pod_label_(.+)</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_namespace]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_namespace</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_pod_name]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_pod_name</span><span class=w>
</span><span class=w>    </span><span class=c># Scrape config for service endpoints.</span><span class=w>
</span><span class=w>    </span><span class=c>#</span><span class=w>
</span><span class=w>    </span><span class=c># The relabeling allows the actual service scrape endpoint to be configured</span><span class=w>
</span><span class=w>    </span><span class=c># via the following annotations:</span><span class=w>
</span><span class=w>    </span><span class=c>#</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/scrape`: Only scrape services that have a value of `true`</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/scheme`: If the metrics endpoint is secured then you will need</span><span class=w>
</span><span class=w>    </span><span class=c># to set this to `https` &amp; most likely set the `tls_config` of the scrape config.</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/path`: If the metrics path is not `/metrics` override this.</span><span class=w>
</span><span class=w>    </span><span class=c># * `prometheus.io/port`: If the metrics are exposed on a different port to the</span><span class=w>
</span><span class=w>    </span><span class=c># service then set this appropriately.</span><span class=w>
</span><span class=w>    </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubernetes-service-endpoints&#39;</span><span class=w>
</span><span class=w>      </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>endpoints</span><span class=w>
</span><span class=w>      </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_prometheus_io_scrape]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__scheme__</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(https?)</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_prometheus_io_path]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)(?::\d+);(\d+)</span><span class=w>
</span><span class=w>          </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>$1:$2</span><span class=w>
</span><span class=w>        </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span><span class=w>          </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_service_label_(.+)</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_namespace]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_namespace</span><span class=w>
</span><span class=w>        </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_name]</span><span class=w>
</span><span class=w>          </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>          </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes_name</span><span class=w> </span><span class=c># Add your additional configuration here...</span><span class=w>
</span></code></pre></div><p>Next, deploy Grafana. Since the deployment in this post is based on the Helm default values, the settings below are set
explicitly in case the default changed.
Deploy Grafana via <code>helm install grafana --namespace &lt;your-prometheus-namespace> stable/grafana -f values.yaml</code>. Here, the same namespace is chosen for Prometheus and for Grafana.</p><p>Content of <code>values.yaml</code> for Grafana:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>server</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>  </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></code></pre></div><p>Check the running state of the pods on the Kubernetes Dashboard or by running <code>kubectl get pods -n &lt;your-prometheus-namespace></code>.
In case of errors check the log files of the pod(s) in question.</p><p>The text output of Helm after the deployment of Prometheus and Grafana contains very useful information, e.g. the user
and password of the Grafana Admin user. The credentials are stored as secrets in the namespace <code>&lt;your-prometheus-namespace></code>
and could be decoded via <code>kubectl get secret --namespace &lt;my-grafana-namespace> grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo</code>.</p><h2 id=basic-functional-tests>Basic functional tests</h2><p>To access the web UI of both applications use port forwarding of port 9090.</p><p>Setup port forwarding for port 9090:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl port-forward -n &lt;your-prometheus-namespace&gt; &lt;your-prometheus-server-pod&gt; 9090:9090
</code></pre></div><p>Open <code>http://localhost:9090</code> in your web browser. Select Graph from the top tab and enter the following expressing to show the overall CPU usage for a server
(see <a href=https://github.com/infinityworks/prometheus-example-queries/blob/master/README.md>Prometheus Query Examples</a>)</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>100 * (1 - avg by(instance)(irate(node_cpu{mode=&#39;idle&#39;}[5m])))
</code></pre></div><p>This should show some data in a graph.</p><p>To show the same data in Grafana setup port forwarding for port 3000 for the
Grafana pod and open the Grafana Web UI by opening http://localhost:3000 in a browser.
Enter the credentials of the admin user.</p><p>Next, you need to enter the server name of your Prometheus deployment. This name is shown directly after the
installation via helm.</p><p>Run</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>helm status &lt;your-prometheus-name&gt;
</code></pre></div><p>to find this name. Below this server name is referenced by <code>&lt;your-prometheus-server-name></code>.</p><p>First, you need to add your Prometheus server as data source.</p><ul><li>select <em>Dashboards â†’ Data Sources</em></li><li>select <em>Add data source</em></li><li>enter
<em>Name</em>: <code>&lt;your-prometheus-datasource-name></code><br><em>Type</em>: Prometheus<br><em>URL</em>: <code>http://&lt;your-prometheus-server-name></code><br>_Access: <code>proxy</code></li><li>select <em>Save & Test</em></li></ul><p>In case of failure check the Prometheus URL in the Kubernetes Dashboard.</p><p>To add a Graph follow these steps:</p><ul><li>in the left corner, select <em>Dashboards â†’ New</em> to create a new dashboard</li><li>select <em>Graph</em> to create a new graph</li><li>next, select the <em>Panel Title â†’ Edit</em></li><li>select your Prometheus Data Source in the drop down list</li><li>enter the expression <code>100 * (1 - avg by(instance)(irate(node_cpu{mode='idle'}[5m])))</code> in the entry field A</li><li>select the floppy disk symbol (Save) on top</li></ul><p>Now you should have a very basic Prometheus and Grafana setup for your Kubernetes cluster.</p><p>As a next step you can implement monitoring for your applications by implementing the <a href=https://prometheus.io/docs/instrumenting/clientlibs/>Prometheus client API</a>.</p><h2 id=links>Links</h2><ul><li><a href=https://prometheus.io/>Prometheus</a></li><li><a href=https://github.com/kubernetes/charts/tree/master/stable/prometheus>Prometheus Helm Chart</a></li><li><a href=https://www.weave.works/blog/prometheus-kubernetes-perfect-match/>Prometheus and Kubernetes: A Perfect Match</a></li><li><a href=https://grafana.com>Grafana</a></li><li><a href=https://github.com/kubernetes/charts/tree/master/stable/grafana>Grafana Helm Chart</a></li></ul></div></div></div><div class=howto_tickets><a href=https://github.com/gardener/documentation/issues/new/choose target=_blank><span>Let us know how can we improve.</span>
<span>Open<img src=https://gardener.cloud/images/branding/github-mark-logo-green.svg title=GitHub>issue <i class="fa fa-external-link" aria-hidden=true></i></span></a></div></section></div><style></style><footer class=footer><div class="container footer-wrapper"><ul class=nav><li><a href=/blog/>Blogs</a></li><li><a href=/community/>Community</a></li><li><a href=/adopter/>Adopters</a></li><li><a href=/documentation/home>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2021 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer><script src=/js/jquery.sticky.js?1619285172></script><script src=/js/modernizr.custom.min.js?1619285172></script><script src=/js/code-snippets.js?1619285172></script><script>$(document).ready(function(){inlineSVG.init();$("[data-publishdate]").each(function(){$(this).text(moment($(this,"YYYY-MM-DD","YYYY-MM-DD hh:mm:ss").attr("data-publishdate")).fromNow());});new ClipboardJS('.clipboard-copy');$("body").codeSnippets();});</script><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W2FGNSX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript></body></html>