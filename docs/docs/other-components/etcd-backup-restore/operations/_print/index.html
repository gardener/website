<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.95.0"><link rel=canonical type=text/html href=https://gardener.cloud/docs/other-components/etcd-backup-restore/operations/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/other-components/etcd-backup-restore/operations/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Operations | Gardener</title><meta name=description content><meta property="og:title" content="Operations"><meta property="og:description" content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:type" content="website"><meta property="og:url" content="https://gardener.cloud/docs/other-components/etcd-backup-restore/operations/"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Operations"><meta itemprop=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Operations"><meta name=twitter:description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><link rel=preload href=/scss/main.min.b5b806bb2cd9fe9ed809539377398aa9df0eb8ca0c983a6eae0b413d528d8f0e.css as=style><link href=/scss/main.min.b5b806bb2cd9fe9ed809539377398aa9df0eb8ca0c983a6eae0b413d528d8f0e.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7N3XF5XLGV"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7N3XF5XLGV",{anonymize_ip:!1})}</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.15b8f4883563c1160acbe18db803f92c.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/other-components/etcd-backup-restore/operations/>Return to the regular view of this page</a>.</p></div><h1 class=title>Operations</h1><div class=content></div></div><div class=td-content><h1 id=pg-d95aebbed89863cd72eaf98bf0cae846>1 - Generating Ssl Certificates</h1><h1 id=generating-certificates>Generating certificates</h1><p>If you wish to enable TLS authentication for either etcd or etcdbr server or both, please follow this guide. The SSL certificate configurations given here are meant to facilitate smooth deployment of the etcd setup via the provided <a href=https://github.com/gardener/etcd-backup-restore/tree/master/chart/etcd-backup-restore>helm chart</a>.</p><h2 id=certificates-structure>Certificates structure</h2><p>While deploying the etcd setup via the provided helm chart, TLS can be enabled for the etcd server and/or etcd-backup-restore server by adding the certificate data to the <code>values.yaml</code> file as necessary. This data is converted into the respective secrets and mounted onto the pod&rsquo;s containers according to the following directory structure:</p><ul><li><code>etcd</code> container</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>/
</span></span><span style=display:flex><span>└── var
</span></span><span style=display:flex><span>    ├── etcd                      Contains the CA and server TLS certs for etcd server
</span></span><span style=display:flex><span>    |   └── ssl
</span></span><span style=display:flex><span>    |       ├── ca
</span></span><span style=display:flex><span>    |       |   └── ca.crt
</span></span><span style=display:flex><span>    |       └── tls
</span></span><span style=display:flex><span>    |           ├── tls.crt
</span></span><span style=display:flex><span>    |           └── tls.key
</span></span><span style=display:flex><span>    └── etcdbr                    Contains the CA and server TLS certs for etcd backup-restore server
</span></span><span style=display:flex><span>        └── ssl
</span></span><span style=display:flex><span>            ├── ca
</span></span><span style=display:flex><span>            |   └── ca.crt
</span></span><span style=display:flex><span>            └── tls
</span></span><span style=display:flex><span>                ├── tls.crt
</span></span><span style=display:flex><span>                └── tls.key
</span></span></code></pre></div><br><ul><li><code>backup-restore</code> container</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>/
</span></span><span style=display:flex><span>└── var
</span></span><span style=display:flex><span>    ├── etcd                      Contains the CA and server certs for etcd server
</span></span><span style=display:flex><span>    |   └── ssl
</span></span><span style=display:flex><span>    |       ├── ca
</span></span><span style=display:flex><span>    |       |   └── ca.crt
</span></span><span style=display:flex><span>    |       └── tls
</span></span><span style=display:flex><span>    |           ├── tls.crt
</span></span><span style=display:flex><span>    |           └── tls.key
</span></span><span style=display:flex><span>    └── etcdbr                    Contains the CA cert for etcd backup-restore server
</span></span><span style=display:flex><span>        └── ssl
</span></span><span style=display:flex><span>            └── ca
</span></span><span style=display:flex><span>                └── ca.crt
</span></span></code></pre></div><h2 id=generating-the-certificates>Generating the certificates</h2><h3 id=installing-openssl>Installing openssl</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=font-weight:700>#</span> For Mac users
</span></span><span style=display:flex><span>brew install openssl
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=font-weight:700>#</span> For other flavours of Unix
</span></span><span style=display:flex><span>apk install openssl
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span>mkdir openssl &amp;&amp; cd openssl
</span></span></code></pre></div><h3 id=generating-certs-for-etcd-server-authentication>Generating certs for etcd server authentication</h3><h4 id=generating-ca-cert-bundle>Generating CA cert bundle</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>openssl genrsa -out ca.key 2048
</span></span><span style=display:flex><span>openssl req -new -key ca.key -subj &#34;/CN=etcd&#34; -out ca.csr
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span>cat &gt; ca.csr.conf &lt;&lt;EOF
</span></span><span style=display:flex><span>[ v3_ext ]
</span></span><span style=display:flex><span>keyUsage=critical,digitalSignature,keyEncipherment,keyCertSign,cRLSign
</span></span><span style=display:flex><span>basicConstraints=critical,CA:TRUE
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span>openssl x509 -req -in ca.csr -signkey ca.key -out ca.crt -sha256 -days 3653 -extensions v3_ext -extfile ca.csr.conf
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=font-weight:700>#</span> view contents of the generated certificate
</span></span><span style=display:flex><span>openssl x509 -in ca.crt -noout -text
</span></span></code></pre></div><h4 id=generating-tls-key-pair>Generating TLS key-pair</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>openssl genrsa -out server.key 2048
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=font-weight:700>#</span> In the <span style=color:#a31515>`</span>alt_names<span style=color:#a31515>`</span> section of server.csr.conf, replace all occurrences of <span style=color:#a31515>`</span>mynamespace<span style=color:#a31515>`</span> with the namespace into which you<span>&#39;</span>ll deploy the helm chart
</span></span><span style=display:flex><span>cat &gt; server.csr.conf &lt;&lt;EOF
</span></span><span style=display:flex><span>[ req ]
</span></span><span style=display:flex><span>default_bits = 2048
</span></span><span style=display:flex><span>prompt = no
</span></span><span style=display:flex><span>default_md = sha256
</span></span><span style=display:flex><span>req_extensions = req_ext
</span></span><span style=display:flex><span>distinguished_name = dn
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span>[ dn ]
</span></span><span style=display:flex><span>CN = etcd-server
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span>[ req_ext ]
</span></span><span style=display:flex><span>subjectAltName = @alt_names
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span>[ alt_names ]
</span></span><span style=display:flex><span>DNS.1 = main-etcd-0
</span></span><span style=display:flex><span>DNS.2 = main-etcd-local
</span></span><span style=display:flex><span>DNS.3 = main-etcd-client
</span></span><span style=display:flex><span>DNS.4 = main-etcd-client.mynamespace
</span></span><span style=display:flex><span>DNS.5 = main-etcd-client.mynamespace.svc
</span></span><span style=display:flex><span>DNS.6 = main-etcd-client.mynamespace.svc.cluster.local
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span>[ v3_ext ]
</span></span><span style=display:flex><span>keyUsage=critical,digitalSignature,keyEncipherment
</span></span><span style=display:flex><span>extendedKeyUsage=serverAuth,clientAuth
</span></span><span style=display:flex><span>basicConstraints=critical,CA:FALSE
</span></span><span style=display:flex><span>subjectAltName=@alt_names
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span>openssl req -new -key server.key -out server.csr -config server.csr.conf
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span>openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -sha256 -days 3653 -extensions v3_ext -extfile server.csr.conf
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=font-weight:700>#</span> view contents of the generated certificate
</span></span><span style=display:flex><span>openssl x509 -in server.crt -noout -text
</span></span></code></pre></div><h3 id=generating-certs-for-etcdbr-server-authentication>Generating certs for etcdbr server authentication</h3><p>Follow the same steps as <a href=#generating-certs-for-etcd-server-authentication>generating certs for etcd</a>, but replace all occurrences of <code>etcd</code> with <code>etcdbr</code> for the <code>CN</code> fields and replace <code>main-etcd-client</code> with <code>main-backup-client</code> in the DNS names if you want to access the TLS-enabled backup-restore server via service. You will also need to add <code>localhost</code> to the SAN DNS list if you&rsquo;re deploying the etcd setup via the provided helm chart. If deploying by any other means, or if testing locally, please tweak the config accordingly.</p><h4 id=generating-ca-cert-bundle-1>Generating CA cert bundle</h4><p>Follow the same steps as <a href=#generating-CA-cert-bundle>generating CA cert for etcd</a>, but replace<code>CN=etcd</code> by <code>CN=etcdbr</code> while creating the <code>ca.csr</code>.</p><h4 id=generating-tls-key-pair-1>Generating TLS key-pair</h4><p>Follow the same steps as <a href=#generating-tls-key-pair>generating TLS key-pair for etcd</a>, but modify the <code>[ dn ]</code> section in <code>server.csr.conf</code> from <code>CN = etcd</code> by <code>CN = etcdbr</code>. Also change the <code>[ alt_names ]</code> section to the following:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>[ alt_names ]
</span></span><span style=display:flex><span>DNS.1 = localhost
</span></span><span style=display:flex><span>DNS.2 = main-backup-0
</span></span><span style=display:flex><span>DNS.3 = main-backup-local
</span></span><span style=display:flex><span>DNS.4 = main-backup-client
</span></span><span style=display:flex><span>DNS.5 = main-backup-client.mynamespace
</span></span><span style=display:flex><span>DNS.6 = main-backup-client.mynamespace.svc
</span></span><span style=display:flex><span>DNS.7 = main-backup-client.mynamespace.svc.cluster.local
</span></span></code></pre></div><p>Here, we add <code>localhost</code> to the DNS entries so that the etcd bootstrap script may be allowed to trigger data initialization on the backup sidecar via HTTPS.</p><h2 id=running-etcdbrctl-server-with-tls-enabled>Running <code>etcdbrctl server</code> with TLS enabled</h2><p>If you wish to develop/test <code>etcdbrctl</code> locally with TLS enabled, you can follow the steps to create the certs and pass them to the <code>etcdbrctl server</code> via the following flags.</p><h3 id=for-etcd-tls>For etcd TLS</h3><p>Pass the CA certificate file via <code>--cacert</code> flag, and etcd server TLS certificate and key via <code>--cert</code> and <code>--key</code> flags respectively.</p><h3 id=for-etcdbr-tls>For etcdbr TLS</h3><p>Pass the etcd backup-restore server TLS certificate and key via <code>--server-cert</code> and <code>--server-key</code> respectively.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2be463cd712869bb3bc79f07adfad44d>2 - Leader Election</h1><h3 id=leading-etcd-main-containers-sidecar-is-the-backup-leader>Leading ETCD main container’s sidecar is the backup leader</h3><ul><li><p>The <code>backup-restore sidecar</code> poll its corresponding etcd main container to see if it is the leading member in the etcd cluster. This information is used by the backup-restore sidecars to decide that sidecar of the leading etcd main container is the <code>backup leader</code>.</p></li><li><p>Only <code>backup leader</code> sidecar among the members have the responsibility to take/upload the snapshots(full as well as incremental) for a given Etcd cluster as well as to <a href=https://github.com/gardener/etcd-druid/tree/master/docs/proposals/multi-node#defragmentation>trigger the defragmentation</a> for each Etcd cluster member.</p></li></ul><h3 id=work-flow>Work flow</h3><p>Backup-restore can be in following 3 states:</p><ol><li>Follower:<ul><li>When the corresponding etcd main container is a <code>Follower</code> etcd.</li><li>The default state for every backup-restore member is the <code>Follower</code> State.</li></ul></li><li>Leader:<ul><li>When the corresponding etcd main container becomes the <code>leader</code> then sidecar will also become <code>leading sidecar</code>.</li></ul></li><li>Unknown:<ul><li>When there is no etcd leader present in the cluster or in the case of a quorum loss.</li><li>When corresponding etcd main container is down and <a href=https://github.com/etcd-io/etcd/blob/f82b5cb7768dacad9fb310232c1383b4e6718378/client/v3/maintenance.go#L53>endpoint status</a> api call fails.</li></ul></li></ol><h3 id=backup>Backup</h3><ul><li>Only <code>backup leader</code> among the backup-restore members have the responsibility to take/upload the snapshots(full as well as incremental) for a given Etcd cluster.</li><li>The <code>backup leader</code> also has the responsibility to <a href=https://github.com/gardener/etcd-backup-restore/blob/master/docs/operations/getting_started.md#taking-scheduled-snapshot>garbage-collect</a> the backups from the object storage bucket according to a configured garbage collection policy.</li></ul><h3 id=member-lease>Member-lease</h3><p>Each backup-restore member has the responsibility to renew its member lease periodically. This is intended to simulate as heartbeat which indicate that the backup-restore cluster members are in <code>Healthy</code> State.</p><h3 id=defragmentation>Defragmentation</h3><p>Defragmentation for all etcd cluster members is triggered by the <code>leading backup-restore</code> sidecar. The defragmentation is performed only when etcd cluster is in full health and it is done in a rolling manner for each member to avoid disruption.At first, <code>leading backup-restore</code> sidecar triggers defragmentation on all etcd follower members one by one and at last, on itself.</p><h3 id=complete-work-flow-leader-election-state-diagram>Complete work flow leader-election state diagram.</h3><p><img src=/__resources/leaderElection_stateDiagram_c49851.png alt=leader-election></p></div><div class=td-content style=page-break-before:always><h1 id=pg-b6d19d320b69db38b3a0312860680c40>3 - Manual Restoration</h1><h1 id=manual-restoration-of-etcd-data>Manual restoration of etcd data</h1><p>Please make sure that you have read through the <a href=/docs/other-components/etcd-backup-restore/proposals/restoration/>documentation on etcd data restoration</a> before reading this document and attempting to perform a manual restoration of etcd data.</p><p>As mentioned in previously, automatic restoration will be triggered if the etcd data gets corrupted, as the etcd process will crash. But if for some reason, restoration is not automatically triggered when it should have, you may choose to manually restore the etcd data.</p><h2 id=steps-to-perform-restoration>Steps to perform restoration</h2><p>You may choose to follow different methods of restoration, based on your etcd + backup sidecar setup:</p><ol><li><p>Deploying the <a href=https://github.com/gardener/etcd-backup-restore/tree/master/chart/etcd-backup-restore>provided helm chart</a>, in which etcdbrctl is started in <code>server</code> mode</p><ol><li><p>Exec into the <code>etcd</code> container of the <code>main-etcd-0</code> pod and delete the <code>member</code> directory under the data directory in order to invalidate it</p><ul><li><code>rm -rf /var/etcd/data/new.etcd/member</code></li><li>You may choose to rename the <code>member</code> directory instead of deleting it, if you wish to retain the old data for debugging</li></ul></li><li><p>This will crash the etcd container and when it restarts, the backup sidecar will perform a validation of the data directory, and seeing that the data is corrupt, it will restore the data from the latest backup</p><ul><li>⚠️ Keep in mind that the latest backup in the object storage bucket might not be up-to-date with the latest etcd data, and you could see a maximum data loss corresponding to the delta snapshot interval. For instance, setting <code>delta-snapshot-interval=5m</code> could result in a maximum data loss worth 5 minutes.</li></ul></li><li><p>If for some reason, automatic restoration isn&rsquo;t getting triggered even after removing the <code>member</code> directory, it may be required to temporarily modify the etcdbrctl command to <code>restore</code> mode to force a manual restoration of data, and then change the container spec back to its original form once the restoration is successful. Do not change any field in the container spec other than the <code>command</code> field, which is detailed below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>command:
</span></span><span style=display:flex><span>- etcdbrctl
</span></span><span style=display:flex><span>- restore
</span></span><span style=display:flex><span>- --data-dir=&lt;same as previous value&gt;
</span></span><span style=display:flex><span>- --storage-provider=&lt;same as previous value&gt;
</span></span><span style=display:flex><span>- --store-prefix=&lt;same as previous value&gt;
</span></span><span style=display:flex><span>- --embedded-etcd-quota-bytes=&lt;same as previous value&gt;
</span></span><span style=display:flex><span>- --snapstore-temp-directory=&lt;same as previous value&gt;
</span></span></code></pre></div><p>⚠️ Edit etcd-main statefulset to change command field. After saving it, ideally statefulset controller will recreate the etcd-main-0 pod itself. But, since it doesn&rsquo;t handle the case of unhealthy pod, delete etcd-main-0 pod maually using commnad <code>kubectl -n &lt;namespace> delete etcd-main-0</code>. Now, check etcd and backup-restore sidecar logs for successful restoration.</p><p>Once the spec is changed, monitor the logs to make sure restoration occurs. Once restoration is complete, change the container spec back to its previous state and restart the pod. This should purge any previous issues with etcd or backup sidecar, and start snapshotting successfully.</p></li></ol></li><li><p>Deploying etcd and etcdbrctl separately, where etcdbrctl is started in <code>server</code> mode</p><ol><li>If using <a href=https://github.com/gardener/etcd-custom-image/blob/master/etcd_bootstrap_script.sh>this bootstrap script</a> for starting etcd, then deleting the <code>member</code> directory under the etcd data directory should kill the etcd process, and subsequently the script finishes execution and exits. You will have to re-run the script and allow it to trigger data validation anf restoration by etcdbrctl.</li><li>If not using the bootstrap script, then:<ol><li>Delete the <code>member</code> directory and wait for etcd to crash</li><li><code>curl http://localhost:8080/initialization/status</code>, assuming etcdbrctl is running on port 8080</li><li><code>curl http://localhost:8080/initialization/start</code></li><li>Wait for the restoration to finish, by observing the logs from etcdbrctl</li><li>Again, <code>curl http://localhost:8080/initialization/status</code> to complete the initialization process, and etcdbrctl will resume regular snapshotting after this</li></ol></li></ol></li><li><p>Deploying etcd and etcdbrctl separately, where etcdbrctl is started in <code>snapshot</code> mode</p><ol><li>Delete the <code>member</code> directory and wait for etcd to crash</li><li>Kill the etcdbrctl process</li><li>Run etcdbrctl in <code>restore</code> mode to perform a restoration of the data<ul><li>It is highly recommended to run etcdbrctl in <code>initialize</code> mode rather than <code>restore</code> mode, as this performs the necessary validation checks on the data directory taking the decision to trigger a restoration.</li></ul></li><li>Start etcd again</li><li>Restart etcdbrctl in <code>snapshot</code> mode</li></ol><ul><li>⚠️ If running etcdbrctl in <code>snapshot</code> mode, it is necessary to stop this snapshotter process before triggering a restoration, to avoid data inconsistency.</li></ul></li></ol><p>⚠️ If in doubt about the validity of the etcd data, operators must first visually confirm any inconsistency in revision numbers between the latest snapshot-set in the object store and the running etcd instance using the <code>etcdctl</code> tool before deciding to perform a manual restoration.</p><p>⚠️ In order to successfully perform a restoration, the data directory must NOT contain the <code>member</code> directory, else the restoration will fail.</p><p>⚠️ <strong>Do not tamper with the object store in any way.</strong> Data once lost from the object store, cannot be recovered. The object store is considered as the source of truth for the restorer.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d2a063b23374ff2f7fa06ba3a896fa90>4 - Metrics</h1><h1 id=monitoring>Monitoring</h1><p>etcd-backup-restore uses <a href=http://prometheus.io/>Prometheus</a> for metrics reporting. The metrics can be used for real-time monitoring and debugging. It won&rsquo;t persist its metrics; if a member restarts, the metrics will be reset.</p><p>The simplest way to see the available metrics is to cURL the metrics endpoint <code>/metrics</code>. The format is described <a href=http://prometheus.io/docs/instrumenting/exposition_formats/>here</a>.</p><p>Follow the <a href=http://prometheus.io/docs/introduction/getting_started/>Prometheus getting started doc</a> to spin up a Prometheus server to collect etcd metrics.</p><p>The naming of metrics follows the suggested <a href=http://prometheus.io/docs/practices/naming/>Prometheus best practices</a>. All etcd-backup-restore related metrics are put under namespace <code>etcdbr</code>.</p><h2 id=etcd-metrics>ETCD metrics</h2><p>The metrics under the <code>etcd</code> prefix/namespace are carried forward from etcd library that we use. These metrics do not include details of the <code>etcd</code> deployment on which <code>etcd-backup-restore</code> utility operates. Instead, it helps in monitoring the <code>embedded etcd</code> we spawn during restoration process.</p><h3 id=snapshot>Snapshot</h3><p>These metrics describe the status of the snapshotter. In order to detect outages or problems for troubleshooting, these metrics should be closely monitored. The below mentioned metrics are listed as collection of series using prometheus labels <code>kind</code> and <code>succeeded</code>. <code>Kind</code> label indicates the snapshot kind i.e. full snapshot or incremental/delta snapshot in the context. And succeeded indicates whether the metrics is for successful operation or erroneous operation.</p><table><thead><tr><th>Name</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>etcdbr_snapshot_duration_seconds</td><td>Total latency distribution of saving snapshot to object store.</td><td>Histogram</td></tr><tr><td>etcdbr_snapshot_gc_total</td><td>Total number of garbage collected snapshots.</td><td>Counter</td></tr><tr><td>etcdbr_snapshot_latest_revision</td><td>Revision number of latest snapshot taken.</td><td>Gauge</td></tr><tr><td>etcdbr_snapshot_latest_timestamp</td><td>Timestamp of latest snapshot taken.</td><td>Gauge</td></tr><tr><td>etcdbr_snapshot_required</td><td>Indicates whether a new snapshot is required to be taken.</td><td>Gauge</td></tr></tbody></table><p>Abnormally high snapshot duration (<code>etcdbr_snapshot_duration_seconds</code>) indicates disk issues and low network bandwidth.</p><p><code>etcdbr_snapshot_latest_timestamp</code> indicates the time when last snapshot was taken. If it has been a long time since a snapshot has been taken, then it indicates either the snapshots are being skipped because of no updates on etcd or ⚠️ something fishy is going on and a possible data loss might occur on the next restoration.</p><p><code>etcdbr_snapshot_gc_total</code> gives the total number of snapshots garbage collected since bootstrap. You can use this in coordination with <code>etcdbr_snapshot_duration_seconds_count</code> to get number of snapshots in object store.</p><p><code>etcdbr_snapshot_required</code> indicates whether a new snapshot is required to be taken. Acts as a boolean flag where zero value implies &lsquo;false&rsquo; and non-zero values imply &rsquo;true&rsquo;. ⚠️ This metric does not work as expected for the case where delta snapshots are disabled (by setting the etcdbrctl flag <code>delta-snapshot-period</code> to 0).</p><h3 id=defragmentation>Defragmentation</h3><p>The metrics for defragmentation is of type histogram, which gives the number of times defragmentation was triggered. ⚠️ The defragmentation latency should be as low as possible, since
defragmentation is indeed a costly operation, which results in unavailability of etcd for the period.</p><table><thead><tr><th>Name</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>etcdbr_defragmentation_duration_seconds</td><td>Total latency distribution of defragmentation of etcd data directory.</td><td>Histogram</td></tr></tbody></table><h3 id=validation-and-restoration>Validation and Restoration</h3><p>Two major steps in initialization of etcd data directory are validation and restoration. It is necessary to monitor the count and time duration of these calls, from a high availability perspective.</p><table><thead><tr><th>Name</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>etcdbr_validation_duration_seconds</td><td>Total latency distribution of validating data directory.</td><td>Histogram</td></tr><tr><td>etcdbr_restoration_duration_seconds</td><td>Total latency distribution of restoring from snapshot.</td><td>Histogram</td></tr></tbody></table><h3 id=snapstore>Snapstore</h3><p>These bucket-related metrics provide information about the latest set of delta snapshots stored in the snapstore. They provide a rough estimation of the amount of time required to perform a restoration from the latest set of snapshots.</p><table><thead><tr><th>Name</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>etcdbr_snapstore_latest_deltas_total</td><td>Total number of delta snapshots taken since the latest full snapshot.</td><td>Gauge</td></tr><tr><td>etcdbr_snapstore_latest_deltas_revisions_total</td><td>Total number of revisions stored in delta snapshots taken since the latest full snapshot.</td><td>Gauge</td></tr></tbody></table><p><code>etcdbr_snapstore_latest_deltas_revisions_total</code> indicates the total number of etcd revisions (events) stored in the latest set of delta snapshots. The amount of time it would take to perform an etcd data restoration with the latest set of snapshots is directly proportional to this value.</p><h3 id=network>Network</h3><p>These metrics describe the status of the network usage. We use <code>/proc/&lt;etcdbr-pid>/net/dev</code> to get network usage details for the etcdbr process. Currently these metrics are only supported on linux-based distributions.</p><p>All these metrics are under subsystem <code>network</code>.</p><table><thead><tr><th>Name</th><th>Description</th><th>Type</th></tr></thead><tbody><tr><td>etcdbr_network_transmitted_bytes</td><td>The total number of bytes received over network.</td><td>Counter</td></tr><tr><td>etcdbr_network_received_bytes</td><td>The total number of bytes received over network.</td><td>Counter</td></tr></tbody></table><p><code>etcdbr_network_transmitted_bytes</code> counts the total number of bytes transmitted. Usually this reflects the data uploaded to object store as part of snapshot uploads.</p><p><code>etcdbr_network_received_bytes</code> counts the total number of bytes received. Usually this reflects the data received as part of snapshots from actual <code>etcd</code>. There could be a sudden spike in this at the time of restoration as well.</p><h2 id=grpc-requests>gRPC requests</h2><p>These metrics are exposed via <a href=https://github.com/grpc-ecosystem/go-grpc-prometheus>go-grpc-prometheus</a>.</p><h2 id=prometheus-supplied-metrics>Prometheus supplied metrics</h2><p>The Prometheus client library provides a number of metrics under the <code>go</code> and <code>process</code> namespaces.</p></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2023 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid@8.13.4/dist/mermaid.min.js integrity="sha512-JERecFUBbsm75UpkVheAuDOE8NdHjQBrPACfEQYPwvPG+fjgCpHAz1Jw2ci9EXmd3DdfiWth3O3CQvcfEg8gsA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.7b24c0fb082ffb2de6cb14d6c95e9f8053053709ffcf8c761ef8e9ad2f8021e4.js integrity="sha256-eyTA+wgv+y3myxTWyV6fgFMFNwn/z4x2HvjprS+AIeQ=" crossorigin=anonymous></script></body></html>