<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=https://gardener.cloud/docs/dashboard/concepts/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/dashboard/concepts/index.xml><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=icon type=image/x-icon href=https://gardener.cloud/images/favicon.ico><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-16x16.png sizes=16x16><title>Concepts | Gardener</title><meta name=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:title" content="Concepts"><meta property="og:description" content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:type" content="website"><meta property="og:url" content="https://gardener.cloud/docs/dashboard/concepts/"><meta itemprop=name content="Concepts"><meta itemprop=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta name=twitter:card content="summary"><meta name=twitter:title content="Concepts"><meta name=twitter:description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><link rel=preload href=/scss/main.min.ca2e9ddee7809848b536632b41e4e4df665800778ffe11b75edde5bdd6c78963.css as=style><link href=/scss/main.min.ca2e9ddee7809848b536632b41e4e4df665800778ffe11b75edde5bdd6c78963.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.2035d9813dafac83fe2a48b18d50f237.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/dashboard/concepts/>Return to the regular view of this page</a>.</p></div><h1 class=title>Concepts</h1><div class=content></div></div><div class=td-content><h1 id=pg-c7dc017ae3b409ab334a5c29414fd5a6>1 - Webterminals</h1><h1 id=webterminals>Webterminals</h1><img width=180 alt=gardener-terminal-ascii src=https://user-images.githubusercontent.com/5526658/66032047-ecfacc80-e504-11e9-9864-57d4f0bbaf5d.png><h2 id=architecture-overview>Architecture Overview</h2><img src=/__resources/webterminals-1_a34bff.png><h2 id=motivation>Motivation</h2><p>We want to give garden operators and &ldquo;regular&rdquo; users of the Gardener dashboard an easy way to have a preconfigured shell directly in the browser.</p><p>This has several advantages:</p><ul><li>no need to set up any tools locally</li><li>no need to download / store kubeconfigs locally</li><li>Each terminal session will have its own &ldquo;access&rdquo; service account created. This makes it easier to see &ldquo;who&rdquo; did &ldquo;what&rdquo; when using the web terminals.</li><li>The &ldquo;access&rdquo; service account is deleted when the terminal session expires</li><li>Easy &ldquo;privileged&rdquo; access to a node (privileged container, hostPID, and hostNetwork enabled, mounted host root fs) in case of troubleshooting node. If allowed by PSP.</li></ul><h2 id=how-its-done---tldr>How it&rsquo;s done - TL;DR</h2><p>On the host cluster, we schedule a pod to which the dashboard frontend client attaches to (similar to <code>kubectl attach</code>). Usually the <a href=https://github.com/gardener/ops-toolbelt/><code>ops-toolbelt</code></a> image is used, containing all relevant tools like <code>kubectl</code>. The Pod has a kubeconfig secret mounted with the necessary privileges for the target cluster - usually <code>cluster-admin</code>.</p><h2 id=target-types>Target types</h2><p>There are currently three targets, where a user can open a terminal session to:</p><ul><li>The (virtual) garden cluster - Currently operator only</li><li>The shoot cluster</li><li>The control plane of the shoot cluster - operator only</li></ul><h2 id=host>Host</h2><p>There are different factors on where the host cluster (and namespace) is chosen by the dashboard:</p><ul><li>Depending on, the selected target and the role of the user (operator or &ldquo;regular&rdquo; user) the host is chosen.</li><li>For performance / low latency reasons, we want to place the &ldquo;terminal&rdquo; pods as near as possible to the target kube-apiserver.</li></ul><p>For example, the user wants to have a terminal for a shoot cluster. The kube-apiserver of the shoot is running in the seed-shoot-ns on the seed.</p><ul><li>If the user is an operator, we place the &ldquo;terminal&rdquo; pod directly in the seed-shoot-ns on the seed.</li><li>However, if the user is a &ldquo;regular&rdquo; user, we don’t want to have &ldquo;untrusted&rdquo; workload scheduled on the seeds, that&rsquo;s why the &ldquo;terminal&rdquo; pod is scheduled on the shoot itself, in a temporary namespace that is deleted afterwards.</li></ul><h2 id=lifecycle-of-a-web-terminal-session>Lifecycle of a Web Terminal Session</h2><h3 id=1-browser--dashboard-frontend---open-terminal>1. Browser / Dashboard Frontend - Open Terminal</h3><p>User chooses the target and clicks in the browser on <code>Open terminal</code> button. A POST request is made to the dashboard backend to request a new terminal session.</p><h3 id=2-dashboard-backend---create-terminal-resource>2. Dashboard Backend - Create Terminal Resource</h3><p>According to the privileges of the user (operator / enduser) and the selected target, the dashboard backend creates a <code>terminal</code> resource <strong>on behalf of the user</strong> in the (virtual) garden and responds with a handle to the terminal session.</p><h3 id=3-browser--dashboard-frontend>3. Browser / Dashboard Frontend</h3><p>The frontend makes another POST request to the dashboard backend to fetch the terminal session. The Backend waits until the <code>terminal</code> resource is in a &ldquo;ready&rdquo; state (timeout 10s) before sending a response to the frontend. More to that later.</p><h3 id=4-terminal-resource>4. Terminal Resource</h3><p>The <code>terminal</code> resource, among other things, holds the information of the desired host and target cluster. The credentials to these clusters are declared as references (secretRef / serviceAccountRef). The <code>terminal</code> resource itself doesn’t contain sensitive information.</p><h3 id=5-admission>5. Admission</h3><p>A validating webhook is in place to ensure that the user, that created the <code>terminal</code> resource, has the <strong>permission to read the referenced credentials</strong>. There is also a mutating webhook in place. Both admission configurations have <strong><code>failurePolicy: Fail</code></strong>.</p><h3 id=6-terminal-controller-manager---apply-resources-on-host--target-cluster>6. Terminal-Controller-Manager - Apply Resources on Host & Target Cluster</h3><p><em>Sidenote: The terminal-controller-manager has no knowledge about the gardener, its shoots, and seeds. In that sense it can be considered as independent from the gardener.</em></p><p>The <a href=https://github.com/gardener/terminal-controller-manager>terminal-controller-manager</a> watches <code>terminal</code> resources and ensures the desired state on the host and target cluster. The terminal-controller-manager needs the permission to read all secrets / service accounts in the virtual garden.
As additional safety net, the <strong>terminal-controller-manager</strong> ensures that the <code>terminal</code> resource was not created before the admission configurations were created.</p><p>The terminal-controller-manager then creates the necessary resources in the host and target cluster.</p><ul><li>Target Cluster:<ul><li>&ldquo;Access&rdquo; service account + (cluster)rolebinding usually to <code>cluster-admin</code> cluster role<ul><li>used from within the &ldquo;terminal&rdquo; pod</li></ul></li></ul></li><li>Host Cluster:<ul><li>&ldquo;Attach&rdquo; service Account + rolebinding to &ldquo;attach&rdquo; cluster role (privilege to attach and get pod)<ul><li>will be used by the browser to attach to the pod</li></ul></li><li>Kubeconfig secret, containing the &ldquo;access&rdquo; token from the target cluster</li><li>The &ldquo;terminal&rdquo; pod itself, having the kubeconfig secret mounted</li></ul></li></ul><h3 id=7-dashboard-backend---responds-to-frontend>7. Dashboard Backend - Responds to Frontend</h3><p>As mentioned in step 3, the dashboard backend waits until the <code>terminal</code> resource is &ldquo;ready&rdquo;. It then reads the &ldquo;attach&rdquo; token from the host cluster <strong>on behalf of the user</strong>.
It responds with:</p><ul><li>attach token</li><li>hostname of the host cluster&rsquo;s api server</li><li>name of the pod and namespace</li></ul><h3 id=8-browser--dashboard-frontend---attach-to-pod>8. Browser / Dashboard Frontend - Attach to Pod</h3><p>Dashboard frontend attaches to the pod located on the host cluster by opening a WebSocket connection using the provided parameter and credentials.
As long as the terminal window is open, the dashboard regularly annotates the <code>terminal</code> resource (heartbeat) to keep it alive.</p><h3 id=9-terminal-controller-manager---cleanup>9. Terminal-Controller-Manager - Cleanup</h3><p>When there is no heartbeat on the <code>terminal</code> resource for a certain amount of time (default is <code>5m</code>) the created resources in the host and target cluster are cleaned up again and the <code>terminal</code> resource will be deleted.</p><h2 id=browser-trusted-certificates-for-kube-apiservers>Browser Trusted Certificates for Kube-Apiservers</h2><h3 id=motivation-1>Motivation</h3><p>The dashboard frontend opens up a secure WebSocket connection to the kube-apiserver. The certificate presented by the kube-apiserver must be browser trusted, otherwise the connection can&rsquo;t be established (rejected by browser policy).
Most kube-apiservers have self-signed certificates from a custom Root CA.</p><h3 id=bootstrapping>Bootstrapping</h3><h4 id=preferred-solution>Preferred Solution</h4><p>There is an <a href=https://github.com/gardener/gardener/issues/1413>issue</a> on the gardener component, to have browser trusted certificates for shoot kube-apiservers using SNI and certmanager.
However, this would solve the issue for shoots and shooted-seeds, but not for soil and plant kube-apiservers and potentially others.</p><h4 id=current-solution>Current Solution</h4><p>We had to &ldquo;workaround&rdquo; it by creating ingress resources for the kube-apiservers and letting the certmanager (or the new <a href=https://github.com/gardener/gardener-extension-shoot-cert-service>shoot cert service</a>) request browser trusted certificates.</p></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2022 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity=sha384-uQikAXnCAqsMb3ygtdqBYvcwvHUkzGIpjdGyy9owhURXHUxLC5LgTcSxJQH/RzjK crossorigin=anonymous></script><script src=/js/main.min.ef8e0714aff556fd5a9768ed6ecabd2964dd962cd9f89762a373947bb53bc742.js integrity="sha256-744HFK/1Vv1al2jtbsq9KWTdlizZ+Jdio3OUe7U7x0I=" crossorigin=anonymous></script></body></html>