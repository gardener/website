<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=https://gardener.cloud/docs/guides/install_gardener/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/guides/install_gardener/index.xml><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=icon type=image/x-icon href=https://gardener.cloud/images/favicon.ico><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-16x16.png sizes=16x16><title>Install Gardener | Gardener</title><meta name=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:title" content="Install Gardener"><meta property="og:description" content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:type" content="website"><meta property="og:url" content="https://gardener.cloud/docs/guides/install_gardener/"><meta itemprop=name content="Install Gardener"><meta itemprop=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta name=twitter:card content="summary"><meta name=twitter:title content="Install Gardener"><meta name=twitter:description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><link rel=preload href=/scss/main.min.122f9effc36493edf1f25030c2ce7965b16b3b0eaeb02528b9a50e0fa9110c15.css as=style><link href=/scss/main.min.122f9effc36493edf1f25030c2ce7965b16b3b0eaeb02528b9a50e0fa9110c15.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.adf0a3a4b902720bbe1d65c39d6aabec.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/guides/install_gardener/>Return to the regular view of this page</a>.</p></div><h1 class=title>Install Gardener</h1><div class=content></div></div><div class=td-content><h1 id=pg-4a6edad7465b310290cca71408b4247c>1 - Gardener DNS Management for Shoots</h1><div class=lead>Configure DNS Management For Shoot Clusters</div><h1 id=gardener-dns-management-for-shoots>Gardener DNS Management for Shoots</h1><h2 id=introduction>Introduction</h2><p>Gardener allows Shoot clusters to request DNS names for Ingresses and Services out of the box.
To support this the gardener must be installed with the <code>shoot-dns-service</code>
extension.
This extension uses the seed&rsquo;s dns management infrastructure to maintain DNS
names for shoot clusters. So, far only the external DNS domain of a shoot
(already used for the kubernetes api server and ingress DNS names) can be used
for managed DNS names.</p><h2 id=configuration>Configuration</h2><p>A general description for configuring the DNS management of the
gardener can be found <a href=/docs/concepts/extensions/dns>here</a>.</p><p>To generally enable the DNS management for shoot objects the
<code>shoot-dns-service</code> extension must be registered by providing an
appropriate <a href=https://github.com/gardener/gardener-extension-shoot-dns-service/blob/master/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available
for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots the registration must set the <em>globallyEnabled</em> flag to <code>true</code>.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Extension</span><span class=w>
</span><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-dns-service</span><span class=w>
</span><span class=w>      </span><span class=nt>globallyEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></code></pre></div><h3 id=providing-base-domains-usable-for-a-shoot>Providing Base Domains usable for a Shoot</h3><p>So, far only the external DNS domain of a shoot already used
for the kubernetes api server and ingress DNS names can be used for managed
DNS names. This is either the shoot domain as subdomain of the default domain
configured for the gardener installation, or a dedicated domain with dedicated
access credentials configured for a dedicated shoot via the shoot manifest.</p><p>Alternatively, you can specify <code>DNSProviders</code> and its credentials
<code>Secret</code> directly in the shoot, if this feature is enabled.
By default, <code>DNSProvider</code> replication is disabled, but it can be enabled globally in the <code>ControllerDeployment</code>
or for a shoot cluster in the shoot manifest (details see further below).</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ControllerDeployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>extension-shoot-dns-service</span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>helm</span><span class=w>
</span><span class=w></span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span><span class=w>  </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=l>...</span><span class=w>
</span><span class=w>    </span><span class=nt>dnsProviderReplication</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></code></pre></div><p>See <a href=https://github.com/gardener/external-dns-management/tree/master/examples>example files (20-* and 30-*)</a>
for details for the various provider types.</p><h3 id=shoot-feature-gate>Shoot Feature Gate</h3><p>If the shoot DNS feature is not globally enabled by default (depends on the
extension registration on the garden cluster), it must be enabled per shoot.</p><p>To enable the feature for a shoot, the shoot manifest must explicitly add the
<code>shoot-dns-service</code> extension.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-dns-service</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div><h4 id=enabledisable-dns-provider-replication-for-a-shoot>Enable/disable DNS provider replication for a shoot</h4><p>The DNSProvider` replication feature enablement can be overwritten in the
shoot manifest, e.g.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>Kind</span><span class=p>:</span><span class=w> </span><span class=l>Shoot</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>shoot-dns-service</span><span class=w>
</span><span class=w>      </span><span class=nt>providerConfig</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>service.dns.extensions.gardener.cloud/v1alpha1</span><span class=w>
</span><span class=w>        </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DNSConfig</span><span class=w>
</span><span class=w>        </span><span class=nt>dnsProviderReplication</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-009818d3feade374ae615681087e6434>2 - Hardening the Gardener Community Setup</h1><h1 id=hardening-the-gardener-community-setup>Hardening the Gardener Community Setup</h1><h2 id=context>Context</h2><p>Gardener stakeholders in the Open Source community usually use the <a href=https://github.com/gardener/landscape-setup>Gardener Setup Scripts</a>, to create a Garden cluster based on Kubernetes v1.9 which then can be used to create Shoot clusters based on Kubernetes v1.10, v1.11 and v1.12. Shoot clusters can play the following roles in a Gardener landscape:</p><ul><li>Seed cluster</li><li>Shoot cluster</li></ul><p>As Alban Crequy from Kinvolk has recommended in his recent Gardener blog <a href=/docs/guides/applications/insecure-configuration>Auditing Kubernetes for Secure Setup</a> the Gardener Team at SAP has applied several means to harden the Gardener landscapes at SAP.</p><h2 id=recommendations>Recommendations</h2><h3 id=mitigation-for-gardener-cve-2018-2475>Mitigation for Gardener CVE-2018-2475</h3><p>The following recommendations describe how you can harden your Gardener Community Setup by adding a Seed cluster hardened with network policies.</p><ul><li>Use the Gardener Setup Scripts to create a Garden cluster in a dedicated IaaS account</li><li>Create a Shoot cluster in a different IaaS account</li><li>As a precaution you should not deploy the Kubernetes dashboard on this Shoot cluster</li><li>Register this newly created Shoot cluster as a Seed cluster in the Gardener</li><li>End user Shoot clusters can then be created using this newly created Seed cluster (which in turn is a Shoot cluster).</li></ul><p>A tutorial on how to create a shooted seed cluster can be found <a href=/docs/guides/install_gardener/setup-seed>here</a>.</p><p>The rational behind this activity is, that Calico network policies harden this Seed cluster but the community installer uses Flannel which does not offer these features for the Garden cluster.</p><p>When you have added a hardened Seed cluster you are expected not be vulnerable to the Gardener <a href=https://groups.google.com/forum/#!topic/gardener/Pom2Y70cDpw>CVE-2018-2475</a> anymore.</p><h3 id=mitigation-for-kubernetes-cve-2018-1002105>Mitigation for Kubernetes CVE-2018-1002105</h3><p>In addition when you follow the recommendations in the <a href=https://groups.google.com/forum/#!topic/gardener/2icxEz0RAK4>recent Gardener Security Announcement</a> you are expected not be vulnerable to the Kubernetes CVE-2018-1002105 with your hardened Gardener Community Setup.</p><h2 id=alternative-approach>Alternative Approach</h2><p>For this alternative approach there is no Gardener blog available, it is not part of the Gardener Setup Scripts, but it was tested by the Gardener Team at SAP. Use GKE to host a Garden cluster based on Kubernetes v1.10, v1.11 and v1.12 (without the Kubernetes dashboard) in a dedicated GCP account. If you do this by your own, please ensure that the network policies are turned on, which might not be the case by default. Then you can apply the security configuration which Alban Crequy from Kinvolk has recommended in his <a href=/docs/guides/applications/insecure-configuration>blog</a> directly in the Garden cluster and create Shoot clusters from there in a different IaaS account.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-867ade3d960e2003b35a223af7b58a46>3 - Landscape Setup</h1><h1 id=---deprecated--->&mdash;DEPRECATED&mdash;</h1><p><strong>This project is outdated and won&rsquo;t be updated anymore. Please use <a href=https://github.com/gardener/garden-setup>https://github.com/gardener/garden-setup</a> instead!</strong></p><h1 id=gardener-setup-scripts>Gardener Setup Scripts</h1><p>This README is the installation manual for a simple Gardener setup. The installation scripts in this repo are embedded in a configuration template in the <a href=https://github.com/gardener/landscape-setup-template>landscape-setup-template</a> project. You can find further information there.</p><p>We do recommend this simplified setup for demonstration purposes only. For productive workloads we do recommend that all components (Gardener/Seed/Shoot) run in their own IaaS accounts and that network policies are enabled and properly tested on the seed clusters. A documentation on how to do this is currently work in progress.</p><ul><li><a href=#---deprecated--->&mdash;DEPRECATED&mdash;</a></li><li><a href=#gardener-setup-scripts>Gardener Setup Scripts</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#gardener-installation>Gardener Installation</a><ul><li><a href=#tldr>TL;DR</a><ul><li><a href=#kubectl-aliases>Kubectl Aliases</a></li></ul></li><li><a href=#step-1-clone-the-repositories-and-get-dependencies>Step 1: Clone the Repositories and get Dependencies</a><ul><li><a href=#submodule-management>Submodule Management</a></li></ul></li><li><a href=#step-2-configure-the-landscape>Step 2: Configure the Landscape</a><ul><li><a href=#building-the-landscapeyaml-file>Building the &lsquo;landscape.yaml&rsquo; File</a></li><li><a href=#the-base-cluster>The Base Cluster</a><ul><li><a href=#kubify>Kubify</a></li><li><a href=#shoot-cluster>Shoot Cluster</a></li><li><a href=#using-an-arbitrary-base-cluster>Using an Arbitrary Base Cluster</a></li></ul></li></ul></li><li><a href=#step-3-build-and-run-docker-container>Step 3: Build and Run Docker Container</a></li><li><a href=#step-4-10-deploying-components>Step 4-10: Deploying Components</a><ul><li><a href=#undeploying-components>Undeploying Components</a></li><li><a href=#the-all-component>The &lsquo;all&rsquo; Component</a></li></ul></li><li><a href=#step-4-10-deploying-components-detailed>Step 4-10: Deploying Components (detailed)</a><ul><li><a href=#step-4-kubify--etcd>Step 4: Kubify / etcd</a></li><li><a href=#step-5-generate-certificates>Step 5: Generate Certificates</a></li><li><a href=#step-6-deploy-tiller>Step 6: Deploy tiller</a></li><li><a href=#step-7-deploy-gardener>Step 7: Deploy Gardener</a></li><li><a href=#step-8-register-garden-cluster-as-seed-cluster>Step 8: Register Garden Cluster as Seed Cluster</a><ul><li><a href=#configuring-additional-seeds>Configuring Additional Seeds</a></li><li><a href=#creating-a-shoot>Creating a Shoot</a></li></ul></li><li><a href=#step-9-install-identity-and-dashboard>Step 9: Install Identity and Dashboard</a><ul><li><a href=#create-cname-entry>Create CNAME Entry</a></li></ul></li><li><a href=#step-10-apply-valid-certificates>Step 10: Apply Valid Certificates</a></li><li><a href=#letsencrypt-quota-limits>Letsencrypt Quota Limits</a><ul><li><a href=#accessing-the-dashboard>Accessing the Dashboard</a></li></ul></li></ul></li></ul></li><li><a href=#tearing-down-the-landscape>Tearing Down the Landscape</a></li><li><a href=#cleanup>Cleanup</a></li></ul><h1 id=prerequisites>Prerequisites</h1><p>Before getting started make sure you have the following at hand:</p><ul><li>You need a cloud account with sufficient quota to set up a Kubernetes cluster with a couple of VMs. <strong>The Gardener supports AWS, Azure, GCP, and Openstack, but this simplified setup currently only supports AWS and Openstack.</strong></li><li>A Linux machine (virtual machine is fine) or a Mac with basic tools such as a git client and the Docker runtime installed.</li></ul><h1 id=gardener-installation>Gardener Installation</h1><p>Follow these steps to install Gardener. Do not proceed to the next step in case of errors.</p><h2 id=tldr>TL;DR</h2><p>If you are already familiar with the installation procedure and just want a short summary of the commands you have to use, here it is:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># setup</span>
git clone  --recursive https://github.com/gardener/landscape-setup-template.git landscape
<span class=c1># fill in landscape/landscape_config.yaml now</span>
<span class=nb>cd</span> landscape/setup
./docker_run.sh
deploy all

<span class=c1># -------------------------------------------------------------------</span>

<span class=c1># teardown</span>
undeploy all
./cleanup.sh
</code></pre></div><p>Otherwise, follow the detailed guide below.</p><h3 id=kubectl-aliases>Kubectl Aliases</h3><p>The following aliases can be used within the docker container:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>k =&gt; kubectl
ks =&gt; kubectl -n kube-system
kg =&gt; kubectl -n garden
kn =&gt; kubectl -n
ka =&gt; kubectl get --all-namespaces
</code></pre></div><p>Bash completion works for all of them except for <code>ka</code>.</p><h2 id=step-1-clone-the-repositories-and-get-dependencies>Step 1: Clone the Repositories and get Dependencies</h2><p>Get the <code>landscape-setup-template</code> from GitHub and initialize the submodules:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>git clone  --recursive https://github.com/gardener/landscape-setup-template.git landscape
<span class=nb>cd</span> landscape
</code></pre></div><p>After step 2, this repository will contain all passwords and keys for your landscape. You will be in trouble if you loose them so we recommend that you store this landscape configuration in a private repository. It might be a good idea to change the origin so you do not accidentally publish your secrets to the public template repository.</p><h3 id=submodule-management>Submodule Management</h3><p>This project needs the <a href=https://github.com/gardener/gardener>Gardener</a> and <a href=https://github.com/gardener/dashboard>dashboard</a> as submodules. To avoid conflicts between the checked out versions and the ones specified in the <code>landscape_base.yaml</code> file, automatic version management has been added. As long as the <code>managed</code> field in the chart area of each submodule is set to <code>true</code>, the version specified in the <code>tag</code> field will be checked out before deploying.</p><p>To check vor the correct version, the <code>VERSION</code> file in the submodule&rsquo;s main folder is read and compared to the tag in the config file. If the <code>VERSION</code> file doesn&rsquo;t exist, the component is added as a submodule. If it exists, but the versions differ, the fitting version will be checked out. If it exists and the versions are identical, nothing is done. The automatic version management will fail if a) the component is already added as a submodule, but the <code>VERSION</code> file is missing or b) the landscape folder is not a git repo.</p><p>It is also possible to trigger the version update manually: call the <code>manage_submodule</code> function with <code>gardener</code> or <code>dashboard</code> as an argument, or run the <code>manage_submodules.sh</code> script which will update Gardener and dashboard. Both will only work from inside the docker container / with sourced <code>init.sh</code> file.</p><h2 id=step-2-configure-the-landscape>Step 2: Configure the Landscape</h2><p>There is a <code>landscape_config.yaml</code> file in the landscape project. This is the only file that you need to modify - all other configuration files will be derived from this and the <code>landscape_base.yaml</code> file. The latter one contains the merging instructions as well as technical configurations and it shouldn&rsquo;t be touched unless you know what you are doing.</p><h4 id=building-the-landscapeyaml-file>Building the &lsquo;landscape.yaml&rsquo; File</h4><p>Both config files - <code>landscape_config.yaml</code> and <code>landscape_base.yaml</code> - are merged into one <code>landscape.yaml</code> file which is then used as configuration for the scripts. Sourcing the <code>init.sh</code> file (which happens automatically when entering the docker image) will perform this merge <strong>unless the file already exists.</strong> This means if you change something in one of the original config files after the <code>landscape.yaml</code> file has already been created, you need to manually rebuild it in order for the changes to take effect.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>./build_landscape_yaml.sh
</code></pre></div><p>This script will recreate the <code>landscape.yaml</code> file. It will also source the <code>init.sh</code> file again, as some of the environment variables are extracted from this file.</p><h4 id=the-base-cluster>The Base Cluster</h4><p>Gardener extends the Kubernetes apiserver, so in order to deploy it, you need a Kubernetes cluster first. This setup gives you two options for this:</p><h5 id=kubify>Kubify</h5><p>You can use <a href=https://github.com/gardener/kubify>Kubify</a> to create the initial cluster. Kubify uses Terraform to create the cluster and it is integrated into this project - you don&rsquo;t need to create the cluster yourself, just make sure you fill out all relevant parts of the config file.</p><h5 id=shoot-cluster>Shoot Cluster</h5><p>A shoot cluster is a cluster created by a Gardener instance and it can be used as a base cluster for this project. These flags have to be set for the kube-apiserver (if not set, the Gardener will still work, but the dashboard won&rsquo;t):</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml>--<span class=l>oidc-issuer-url=https://identity.ingress.&lt;your cluster domain&gt;</span><span class=w>
</span><span class=w></span>--<span class=l>oidc-client-id=kube-kubectl</span><span class=w>
</span><span class=w></span>--<span class=l>oidc-username-claim=email</span><span class=w>
</span><span class=w></span>--<span class=l>oidc-groups-claim=groups</span><span class=w>
</span></code></pre></div><p>For a shoot this can be done by setting <code>issuerUrl</code>, <code>clientID</code>, <code>usernameClaim</code>, and <code>groupsClaim</code> in <code>spec.kubernetes.kubeAPIServer.oidcConfig</code> in the shoot manifest.</p><p>Also make sure that the CIDRs of your base cluster and the from your Gardener spawned shoots don&rsquo;t overlap - if you want to be able to create shoots from the Gardener dashboard later, then don&rsquo;t use the default CIDRs for this base cluster.</p><p>Some fields in the <code>landscape_config.yaml</code> are marked with <code># kubify only</code>, they can be ignored when using a shoot as the base cluster. The etcd server address defaults to the address for Kubify and needs to be changed for the shoot setup (see the comments in the config file).</p><p>The <em>kubeconfig</em> for the base cluster is expected to be named <code>kubeconfig</code> and reside in the directory containing this project&rsquo;s directory (next to the <code>landscape_config.yaml</code> file).</p><h5 id=using-an-arbitrary-base-cluster>Using an Arbitrary Base Cluster</h5><p>While this setup has only been tested for clusters created by Kubify or the Gardener (shoot clusters), it is theoretically possible to use the shoot setup method to deploy the Gardener to an arbitrary kubernetes cluster.</p><h2 id=step-3-build-and-run-docker-container>Step 3: Build and Run Docker Container</h2><p>First, <code>cd</code> into the folder containing this project.</p><p>Then run the container:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>./docker_run.sh
</code></pre></div><p>After this,</p><ul><li>you will be connected to the container via an interactive shell</li><li>the landscape folder will be mounted in that container</li><li>your current working directory will be <code>setup</code> folder</li><li><code>setup/init.sh</code> is sourced, meaning<ul><li>the environment variables will be set</li><li>kubectl will be configured to communicate with your cluster</li><li><code>landscape.yaml</code> file will have been created if it didn&rsquo;t exist before</li></ul></li></ul><p>The <code>docker_run.sh</code> script searches for the image locally and pulls it from an image repository, if it isn&rsquo;t found.
If pulling the image doesn&rsquo;t work for whatever reason, you can use the <code>docker_build.sh</code> script to build the image locally.</p><h2 id=step-4-10-deploying-components>Step 4-10: Deploying Components</h2><p>The Gardener deployment is splitted into components. A single component can be easily deployed using</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy &lt;component name&gt;
</code></pre></div><p>Please take care that most of the components depend on each other and therefore have to be deployed in the order given below.</p><p>The <code>deploy</code> command is added to the <code>PATH</code> environment variable and can thus be called from anywhere. Bash auto-completion can be used for the component names.</p><h4 id=undeploying-components>Undeploying Components</h4><p>It is also possible to &ldquo;undeploy&rdquo; a component using</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>undeploy &lt;component name&gt;
</code></pre></div><p>Components need to be undeployed in the inverse order. Do not undeploy components without undeploying their successors in the component order first. Take care to delete all shoots before undeploying the <code>gardener</code> or <code>seed-config</code> components (although both undeploy scripts will check for that and trigger a deletion themselves).</p><h4 id=the-all-component>The &lsquo;all&rsquo; Component</h4><p>The <code>all</code> component is a special component: it serves as a dummy to deploy several components in one go. Usually, manual intervention between deploying components is not necessary and most of them are deployed directly one after the other, so the <code>all</code> component makes the &ldquo;normal&rdquo; use-case easier.</p><p>For better control which components are deployed, a component range can be given as an argument. The argument should have the form <code>&lt;start component name>:&lt;end component name></code> and then the start component, the end component, and all components in between will be deployed. The order of the arguments is taken from the environment variables with the <code>$COMPONENT_ORDER_</code> prefix. The variable with the suffix that matches the <code>clusters.base_cluster</code> entry in the config file will be used.</p><p>It is also possible to drop one part of the range or to drop the whole argument. For missing parts the defaults will be used, which are the first and the last component of the active component order, respectively.</p><p>The <code>undeploy</code> command can also be used with the <code>all</code> component, but take care that the component order is inverted.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># Examples</span>
<span class=c1># (start and end component are always inclusive)</span>
deploy all                          <span class=c1># deploys all components</span>
deploy all gardener:dashboard       <span class=c1># deploys &#39;gardener&#39; through &#39;dashboard&#39; </span>
deploy all gardener:                <span class=c1># deploys all components starting from &#39;gardener&#39;</span>
deploy all :gardener                <span class=c1># deploys all components up to &#39;gardener&#39;</span>

<span class=c1># (all undeploy commands use the inverse component order)</span>
undeploy all                        <span class=c1># undeploys all components</span>
undeploy all :helm-tiller           <span class=c1># undeploys all components up to &#39;helm-tiller&#39;</span>
undeploy all dashboard:cert         <span class=c1># undeploys &#39;dashboard&#39; through &#39;cert&#39;</span>
</code></pre></div><h2 id=step-4-10-deploying-components-detailed>Step 4-10: Deploying Components (detailed)</h2><h3 id=step-4-kubify--etcd>Step 4: Kubify / etcd</h3><p>If you want to create a Kubify cluster, deploy the component:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy kubify
</code></pre></div><p>The script will wait some time for the cluster to come up and then partly validate that the cluster is ready.</p><p>If you get errors during the cluster setup, just try to run the command again.</p><p>Once completed the following command should show all deployed pods:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>root@c41327633d6d:/landscape# kubectl get pods --all-namespaces
NAMESPACE       NAME                                                                  READY     STATUS    RESTARTS   AGE
kube-system     etcd-operator-75dcfcf4f7-xkm4h                                        1/1       Running   0          6m
kube-system     heapster-c8fb4f746-tvts6                                              2/2       Running   0          2m
kube-system     kube-apiserver-hcdnc                                                  1/1       Running   0          6m
[...]
</code></pre></div><hr><p>If you already have a cluster, you don&rsquo;t need Kubify. To deploy an etcd in your cluster, run</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy etcd
</code></pre></div><p>This component is not meant to be used in combination with Kubify and might require manual steps to make it work.</p><p>It should also be possible to plug in your own etcd - check the deploy scripts for the <code>etcd</code> and <code>gardener</code> components for information on where to put the certificates, etc.</p><h3 id=step-5-generate-certificates>Step 5: Generate Certificates</h3><p>This step will generate a self-signed cluster CA and sign some certificates with it.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy cert
</code></pre></div><h3 id=step-6-deploy-tiller>Step 6: Deploy tiller</h3><p>Tiller is needed to deploy the Helm charts of Gardener and other components.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy helm-tiller
</code></pre></div><h3 id=step-7-deploy-gardener>Step 7: Deploy Gardener</h3><p>Now we can deploy Gardener. If the previous steps were executed successfully this should be completed in a couple of seconds.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy gardener
</code></pre></div><p>You might see a couple of messages like these:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>Gardener API server not yet reachable. Waiting...
</code></pre></div><p>while the script waits for the Gardener to start. Once Gardener is up when the deployment script finished you can verify the correct setup by running the following command:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl get shoots
No resources found. 
</code></pre></div><p>As we do not have a seed cluster yet we cannot create any shoot clusters.
The Gardener itself is installed in the <code>garden</code> namespace:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl get po -n garden
NAME                                          READY     STATUS    RESTARTS   AGE
gardener-apiserver-56cc665667-nvrjl           1/1       Running   0          6m
gardener-controller-manager-5c9f8db55-hfcts   1/1       Running   0          6m
</code></pre></div><h3 id=step-8-register-garden-cluster-as-seed-cluster>Step 8: Register Garden Cluster as Seed Cluster</h3><p>In heterogeneous productive environments one would run Gardener and seed in separate clusters but for simplicity and resource consumption reasons we will register the Gardener cluster that we have just created also as the seed cluster. Make sure that the <code>seed_config</code> in the landscape file is correct and matches the region that you are using. Keep in mind that image ids differ between regions as well. Also, valid credentials for the seed provider have to be specified in the <code>authentication</code> part of the <code>landscape_config.yaml</code> file (the etcd backups of the shoot clusters are stored on the seed).</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy seed-config
</code></pre></div><h4 id=configuring-additional-seeds>Configuring Additional Seeds</h4><p>By default, this step will create a seed for the cloud provider the Gardener has been deployed on and thus creating shoots on this provider will be possible. If you want to create shoots on other cloud providers, you will have to configure additional seeds. There are two options for that:</p><p>If the seed-config deploy script is called without any arguments (as shown above), it will create seeds for all providers specified in the <code>seed_config.seeds</code> section in the <code>landscape_config.yaml</code> file. By default, the only entry in that list is the cloud provider chosen for the Gardener cluster, but you can extend the list.</p><p>It is also possible to provide the seed-config deploy script with additional arguments specifying which seeds should be created. Multiple arguments can be given and the script will ignore the list in the <code>landscape_config.yaml</code> file when called with arguments. Only the specified seeds will be created, already existing seeds are not affected. If a given seed already exists, it will be updated to the current configuration.</p><p>In both cases, the corresponding variant nodes in <code>authentication</code> and <code>seed_config</code> have to be filled out in the config file.</p><p>Valid values for seeds are <code>aws</code>, <code>az</code> (for Azure), <code>gcp</code>, and <code>openstack</code>. Please note, that while it is possible to create seeds for any cloud provider on any cloud provider, shoot creation may not work across cloud providers for every combination. It should always work if seed (Gardener cluster in this setup) and shoot are on the same provider, though.</p><h4 id=creating-a-shoot>Creating a Shoot</h4><p>That&rsquo;s it! If everything went fine you should now be able to create shoot clusters.
You can start with a sample <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot-aws.yaml>manifest</a> and create a shoot cluster by standard Kubernetes means:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f shoot-aws.yaml
</code></pre></div><h3 id=step-9-install-identity-and-dashboard>Step 9: Install Identity and Dashboard</h3><p>Creating clusters based on a shoot manifest is quite nice but also a little complex. While almost all aspects of a shoot cluster can be configured, it can be quite difficult for beginners, so go on and install the dashboard:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy identity
<span class=o>[</span>...<span class=o>]</span>
deploy dashboard
<span class=o>[</span>...<span class=o>]</span>
</code></pre></div><h4 id=create-cname-entry>Create CNAME Entry</h4><p>Dashboard and identity need a CNAME entry pointing the domain <code>*.ingress.&lt;your cluster domain></code> to your cluster&rsquo;s nginx ingress ip/hostname. Kubify creates this entry automatically. If you are not using kubify to create your base cluster, you can create the CNAME entry with the corresponding component:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy cname
</code></pre></div><p>The script uses the AWS CLI to create the entry, so it will only work for route53.</p><h3 id=step-10-apply-valid-certificates>Step 10: Apply Valid Certificates</h3><p>The following command will install the <a href=https://github.com/jetstack/cert-manager>cert-manager</a> and request valid letsencrypt certificates for both the identity and dashboard ingresses:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>deploy certmanager
</code></pre></div><p>After a few minutes valid certificates should be installed.</p><h3 id=letsencrypt-quota-limits>Letsencrypt Quota Limits</h3><p>Letsencrypt <a href=https://letsencrypt.org/docs/rate-limits/>limits</a> how many certificates you can get for the same host within a short time. To avoid hitting these limits, you can use the letsencrypt staging server for testing, which has a significantly higher rate limit but produces untrusted certificates.<br>The <code>charts.[certmanager].live</code> field in the config file allows to switch between live and staging server (remember to rebuild the <code>landscape.yaml</code> file after you changed something in the <code>landscape_config.yaml</code> file).</p><h4 id=accessing-the-dashboard>Accessing the Dashboard</h4><p>After step 9 you will be able to access the Gardener dashboard. There is a difference in how you access it depending on whether you used the letsencrypt live server or the staging one (and thus have untrusted credentials in the latter case).</p><p>The <code>print_dashboard_urls.sh</code> script constructs two URLs from the domain name given in the <code>landscape.yaml</code> file and prints them.</p><p>If you have trusted certificates, just use the second one (the one for the dashboard) and everything will be fine.</p><p>If you used the letsencrypt staging server, you will need to visit the first link first. Your browser will show a warning regarding untrusted certificates, you need to ignore that warning. You will then see a nearly blank page with some 404 message. After that, you can open the dashboard link, ignore the certificate warning again and should be able to login.
If you skip the first link, you will still be able to see the dashboard, but the login button probably won&rsquo;t work.
While you will be able to login and create projects with the untrusted certificates from the letsencrypt staging server, creating secrets or shoots won&rsquo;t be possible. You&rsquo;ll need trusted certificates for that.</p><p>To log into the dashboard, use the options you have specified in the identity chart part of the <code>landscape_config.yaml</code>.</p><h1 id=tearing-down-the-landscape>Tearing Down the Landscape</h1><p>Make sure that you delete all shoot clusters prior to tearing down the cluster. Not deleting <code>project</code> resources before deleting the Gardener can also cause troubles, because the namespaces associated with the projects have a finalizer which can&rsquo;t be handled anymore when the Gardener is gone. Both, shoots and projects, can be deleted using the <code>delete_all.sh</code> script (give &lsquo;shoots&rsquo; or &lsquo;projects&rsquo; as an argument). To delete a single shoot/project, use <a href=https://github.com/gardener/gardener/blob/master/hack/delete>this</a> script.</p><p>The following command should not return any shoot clusters:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>kubectl get shoots --all-namespaces
No resources found.
</code></pre></div><p>If you created your base cluster with the Kubify component, you can destroy it using the undeploy command:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>undeploy kubify
</code></pre></div><h1 id=cleanup>Cleanup</h1><p>After destroying the Kubify cluster, there will be some files left that prevent you from simply starting the project up again.</p><p><strong>ATTENTION: Only do this if you are sure the cluster has been completely destroyed!</strong>
Since this removes the terraform state, an automated deletion of resources won&rsquo;t be possible anymore - you will have to clean up any leftovers manually.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>./cleanup.sh
</code></pre></div><p>This will reset your landscape folder to its initial state (including the deletion of <code>landscape.yaml</code>).</p><p>The script takes an optional &ldquo;-y&rdquo; argument to skip the confirmation.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d7002605ea6dad33b86146a592a09963>4 - Manually adding a node to an existing cluster</h1><div class=lead>How to add a node to an existing cluster without the support of Gardener</div><h1 id=manually-adding-a-node-to-an-existing-cluster>Manually adding a node to an existing cluster</h1><p>Gardener has an excellent ability to <a href=https://github.com/components/mcm/>automatically scale machines</a> for the cluster. From the point of view
of scalability, there is no need for manual intervention.</p><p>This tutorial is useful for those end-users who need specifically configured nodes, which are not yet supported
by Gardener. For example: an end-user who wants some workload that requires <code>runnc</code> instead of <code>runc</code> as container
runtime.</p><p><img src=/__resources/teaser_bdea32.svg alt=teaser></p><h2 id=disclaimer>Disclaimer</h2><blockquote><p>Here we will look at the steps on how to add a node to an existing cluster without the support of Gardener.
Such a node will not be managed by Gardener, and if it goes down for any reason, Gardener will not be
responsible to replace it.</p></blockquote><h2 id=how>How</h2><ol><li><p>Create a new instance in the same VPC/network as other machines in the cluster. You should be able to ssh into the machine. So save its private key, and assign a public IP to it. If adding a public IP is not preferred, then ssh into any other machine in the cluster, and then ssh from there into the new machine using its private key.</p><p>To ssh into a machine which is already in the cluster, use the steps defined <a href=/docs/guides/monitoring_and_troubleshooting/shell-to-node title=ssh-into-node>here</a>.</p><p>Attach the same IAM role to the new machine which is attached to the existing machines in the cluster. This is required by kubelet in the new machine so that it can contact the cloud provider to query the node&rsquo;s name.</p></li><li><p>On the new machine, create file <code>/var/lib/kubelet/kubeconfig-bootstrap</code> with the following content:</p></li></ol><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>kubelet-bootstrap@default</span><span class=w>
</span><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>certificate-authority-data</span><span class=p>:</span><span class=w> </span><span class=l>&lt;CA Certificate&gt;</span><span class=w>
</span><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Server&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>kubelet-bootstrap</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubelet-bootstrap@default</span><span class=w>
</span><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubelet-bootstrap</span><span class=w>
</span><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>as-user-extra</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span><span class=w>    </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Token&gt;</span><span class=w>
</span></code></pre></div><ol start=3><li>ssh into an existing node, and run these commands to get the values of <ca certificate>and <server>to be replaced in above file:</li></ol><ul><li>&lt;Servr></li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash> /opt/bin/hyperkube kubectl <span class=se>\
</span><span class=se></span>   --kubeconfig /var/lib/kubelet/kubeconfig-real <span class=se>\
</span><span class=se></span>   config view <span class=se>\
</span><span class=se></span>   -o go-template<span class=o>=</span><span class=s1>&#39;{{index .clusters 0 &#34;cluster&#34; &#34;server&#34;}}&#39;</span> <span class=se>\
</span><span class=se></span>   --raw
</code></pre></div><ul><li>&lt;CA Certificate></li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>/opt/bin/hyperkube kubectl <span class=se>\
</span><span class=se></span>   --kubeconfig /var/lib/kubelet/kubeconfig-real <span class=se>\
</span><span class=se></span>   config view <span class=se>\
</span><span class=se></span>   -o go-template<span class=o>=</span><span class=s1>&#39;{{index .clusters 0 &#34;cluster&#34; &#34;certificate-authority-data&#34;}}&#39;</span> <span class=se>\
</span><span class=se></span>   --raw
</code></pre></div><ol start=4><li><p>&lt;Token><br>The kubelet on the new machine needs a bootstrap token to authenticate with the kube-apiserver when adding itself to the cluster. Kube-apiserver uses a secret in the <code>kube-system</code> namespace to authenticate this token. This token is valid for 90 minutes from the time of creation, and the corresponding secret captures this detail in its <code>.data.expiration</code> field. The name of this secret is of the format <code>bootstrap-token-*</code>. Gardener takes care of creating new bootstrap tokens, and the corresponding secrets.
To get an unexpired token, find the secrets with the name format <code>bootstrap-token-*</code> in the <code>kube-system</code> namespace in the cluster, and pick the one with minimum age. Eg. <code>bootstrap-token-abcdef</code>.<br>Run these commands to get the token:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash> <span class=nv>tokenid</span><span class=o>=</span><span class=k>$(</span>kubectl get secret bootstrap-token-abcdef -n kube-system -o go-template<span class=o>=</span><span class=s1>&#39;{{index .data &#34;token-id&#34;}}&#39;</span> <span class=p>|</span> base64 --decode<span class=k>)</span>

 <span class=nv>tokensecret</span><span class=o>=</span><span class=k>$(</span>kubectl get secret bootstrap-token-abcdef -n kube-system -o go-template<span class=o>=</span><span class=s1>&#39;{{index .data &#34;token-secret&#34;}}&#39;</span> <span class=p>|</span> base64 --decode<span class=k>)</span>

 <span class=nb>echo</span> <span class=nv>$tokenid</span>.<span class=nv>$tokensecret</span>
</code></pre></div><p>The value of $TOKEN will be <code>tokenid.tokensecret</code>. Replace $TOKEN in above file with this value</p></li><li><p>Copy contents of the files - <code>/var/lib/kubelet/config/kubelet</code>, <code>/var/lib/kubelet/ca.crt</code> and <code>/etc/systemd/system/kubelet.service</code> - from an existing node to the new node</p></li><li><p>Run the following command in the new node to start the kubelet:</p></li></ol><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>systemctl <span class=nb>enable</span> kubelet <span class=o>&amp;&amp;</span> systemctl start kubelet
</code></pre></div><p>The new node should be added to the existing cluster within a couple of minutes.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b226b144fd3cd9bed81a4429318310db>5 - Setting up a Seed Cluster</h1><div class=lead>How to configure a Kubernetes cluster as a Gardener seed</div><h1 id=the-seed-cluster>The Seed Cluster</h1><p>The <a href=https://github.com/gardener/landscape-setup-template>landscape-setup-template</a> is meant to provide an as-simple-as-possible Gardener installation. Therefore it just registers the cluster where the Gardener is deployed on as a seed cluster. While this is easy, it might be insecure. Clusters created with Kubify don&rsquo;t have network policies, for example. See <a href=https://github.com/gardener/documentation/website/documentation/guides/install_gardener/secure-setup/_index.md>Hardening the Gardener Community Setup</a> for more information.</p><p>To have network policies on the seed cluster and avoid having the seed on the same cluster as the Gardener, the easiest option is probably to simply create a shoot and then register that shoot as seed. This way you can also leverage other advantages of shooted clusters for your seed, e.g. autoscaling.</p><h2 id=setting-up-the-shoot>Setting up the Shoot</h2><p>The first step is to create a shoot cluster. Unfortunately, the Gardener dashboard currently does not allow to change the CIDRs for the created shoot clusters, and your shoots won&rsquo;t work if they have overlapping CIDR ranges with their corresponding seed cluster. So either your seed cluster is deployed with different CIDRs - not using the dashboard, but <code>kubectl apply</code> and a yaml file - or all of your shoots on that seed need to be created this way. In order to be able to use the dashboard for the shoots, it makes sense to create the seed with different CIDRs.</p><p>So, create yourself a shoot with modified CIDRs. You can find templates for the shoot manifest <a href=https://github.com/gardener/gardener/tree/master/example>here</a>. You could, for example, change the CIDRs to this:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>      </span><span class=l>...</span><span class=w>
</span><span class=w>      </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>internal</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=m>10.254.112.0</span><span class=l>/22</span><span class=w>
</span><span class=w>        </span><span class=nt>nodes</span><span class=p>:</span><span class=w> </span><span class=m>10.254.0.0</span><span class=l>/19</span><span class=w>
</span><span class=w>        </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=m>10.255.0.0</span><span class=l>/17</span><span class=w>
</span><span class=w>        </span><span class=nt>public</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=m>10.254.96.0</span><span class=l>/22</span><span class=w>
</span><span class=w>        </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=m>10.255.128.0</span><span class=l>/17</span><span class=w>
</span><span class=w>        </span><span class=nt>vpc</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>10.254.0.0</span><span class=l>/16</span><span class=w>
</span><span class=w>        </span><span class=nt>workers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=m>10.254.0.0</span><span class=l>/19</span><span class=w>
</span><span class=w>      </span><span class=l>...</span><span class=w>
</span></code></pre></div><p>Also make sure that your new seed cluster has enough resources for the expected number of shoots.</p><h2 id=registering-the-shoot-as-seed>Registering the Shoot as Seed</h2><p>The seed itself is a Kubernetes resource that can be deployed via a yaml file, but it has some dependencies. You can find templated versions of these files in the <a href=https://github.com/gardener/landscape-setup/tree/0.5.0/components/seed-config>seed-config component</a> of the landscape-setup-template project. If you have set up your Gardener using this project, there should also be rendered versions of these files in the <code>state/seed-config/</code> directory of your landscape folder (they are probably easier to work with). Examples for all these files can also be found in the aforementioned example folder in the Gardener repo.</p><h3 id=1-seed-namespace>1. Seed Namespace</h3><p>First, you should create a namespace for your new seed and everything that belongs to it. This is not necessary, but it will keep your cluster organized. For this example, the namespace will be called <code>seed-test</code>.</p><h3 id=2-cloud-provider-secret>2. Cloud Provider Secret</h3><p>The Gardener needs to create resources on the seed and thus needs a kubeconfig for it. It is provided with the cloud provider secret (below is an example for AWS).</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-seed-secret</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>seed-test</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cloudprofile.garden.sapcloud.io/name</span><span class=p>:</span><span class=w> </span><span class=l>aws </span><span class=w>
</span><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>accessKeyID</span><span class=p>:</span><span class=w> </span><span class=l>&lt;base64-encoded AWS access key&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>secretAccessKey</span><span class=p>:</span><span class=w> </span><span class=l>&lt;base64-encoded AWS secret key&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>kubeconfig</span><span class=p>:</span><span class=w> </span><span class=l>&lt;base64-encoded kubeconfig&gt;</span><span class=w>
</span></code></pre></div><p>Deploy the secret into your seed namespace. Apart from the kubeconfig, also infrastructure credentials are required. They will only be used for the etcd backup, so in case for AWS, S3 privileges should be sufficient.</p><h3 id=3-secretbinding-for-cloud-provider-secret>3. Secretbinding for Cloud Provider Secret</h3><p>Create a secretbinding for your cloud provider secret:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>SecretBinding</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-seed-secret</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>seed-test</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cloudprofile.garden.sapcloud.io/name</span><span class=p>:</span><span class=w> </span><span class=l>aws</span><span class=w>
</span><span class=w></span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-seed-secret</span><span class=w>
</span><span class=w></span><span class=c># namespace: only required if in different namespace than referenced secret</span><span class=w>
</span><span class=w></span><span class=nt>quotas</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></code></pre></div><p>You can give it the same name as the referenced secret.</p><h3 id=4-cloudprofile>4. Cloudprofile</h3><p>The cloudprofile contains the information which shoots can be created with this seed. You could create a new cloudprofile, but you can also just reference the existing cloudprofile if you don&rsquo;t want to change anything.</p><h3 id=5-seed>5. Seed</h3><p>Now the seed resource can be created. Choose a name, reference cloudprofile and secretbinding, fill in your ingress domain, and set the CIDRs to the same values as in the underlying shoot cluster.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.gardener.cloud/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Seed</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>aws-secure</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>provider</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>aws</span><span class=w>
</span><span class=w>    </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>eu-west-1</span><span class=w>
</span><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-seed-secret</span><span class=w>
</span><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>seed-test</span><span class=w>
</span><span class=w>  </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>ingressDomain</span><span class=p>:</span><span class=w> </span><span class=l>ingress.&lt;your cluster domain&gt;</span><span class=w>
</span><span class=w>  </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>nodes</span><span class=p>:</span><span class=w> </span><span class=m>10.254.0.0</span><span class=l>/19</span><span class=w>
</span><span class=w>    </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=m>10.255.0.0</span><span class=l>/17</span><span class=w>
</span><span class=w>    </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=m>10.255.128.0</span><span class=l>/17</span><span class=w>
</span></code></pre></div><h3 id=6-hide-original-seed>6. Hide Original Seed</h3><p>In the dashboard, it is not possible to select the seed for a shoot (it is possible when deploying the shoot using a yaml file, however). Since both seeds probably reference the same cloudprofile, the Gardener will try to distribute the shoots equally among both seeds.</p><p>To solve this problem, edit the original seed and set its <code>spec.visible</code> field to <code>false</code>. This will prevent the Gardener from choosing this seed, so now all shoots created via the dashboard should have their control plane on the new, more secure seed.</p></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=/blog/>Blogs</a></li><li><a href=/community/>Community</a></li><li><a href=/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2021 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script></body></html>