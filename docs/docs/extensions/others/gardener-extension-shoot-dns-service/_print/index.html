<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://gardener.cloud/docs/extensions/others/gardener-extension-shoot-dns-service/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/extensions/others/gardener-extension-shoot-dns-service/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>DNS services | Gardener</title>
<meta name=description content="Gardener extension controller for DNS services for shoot clusters"><meta property="og:url" content="https://gardener.cloud/docs/extensions/others/gardener-extension-shoot-dns-service/"><meta property="og:site_name" content="Gardener"><meta property="og:title" content="DNS services"><meta property="og:description" content="Gardener extension controller for DNS services for shoot clusters"><meta property="og:locale" content="en_US"><meta property="og:type" content="website"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="DNS services"><meta itemprop=description content="Gardener extension controller for DNS services for shoot clusters"><meta itemprop=wordCount content="252"><meta itemprop=image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="DNS services"><meta name=twitter:description content="Gardener extension controller for DNS services for shoot clusters"><link rel=preload href=/scss/main.min.1d5ea92d936c3f696a972447493d291f3b21bcba71aba5c7967af37ea482eba6.css as=style integrity="sha256-HV6pLZNsP2lqlyRHST0pHzshvLpxq6XHlnrzfqSC66Y=" crossorigin=anonymous><link href=/scss/main.min.1d5ea92d936c3f696a972447493d291f3b21bcba71aba5c7967af37ea482eba6.css rel=stylesheet integrity="sha256-HV6pLZNsP2lqlyRHST0pHzshvLpxq6XHlnrzfqSC66Y=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><style>.nav-link:hover{text-decoration:none}.ml-md-auto{margin-left:auto!important}.td-search__icon{color:#fff!important}.td-search__input.form-control::placeholder{color:#fff;border:1px;border-radius:20px}.td-search__input.form-control{border:1px;border-radius:20px}.td-search__input{max-width:90%}.td-search:not(:focus-within){color:#fff!important}</style><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://demo.gardener.cloud target=_blank><span>Demo</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><div class=dropdown><a href=/docs class=nav-link>Documentation</a><div class=dropdown-content><a class=taxonomy-term href=/docs>Users</a>
<a class=taxonomy-term href=/docs>Operators</a>
<a class=taxonomy-term href=/docs>Developers</a>
<a class=taxonomy-term href=/docs>All</a></div></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.080e494772bc09467b645f4393c6841d.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/extensions/others/gardener-extension-shoot-dns-service/>Return to the regular view of this page</a>.</p></div><h1 class=title>DNS services</h1><div class=lead>Gardener extension controller for DNS services for shoot clusters</div><div class=content><h1 id=gardener-extension-for-dns-serviceshttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for DNS services</a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-dns-service><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-dns-service alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-shoot-dns-service-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-shoot-dns-service-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-shoot-dns-service><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-shoot-dns-service alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service. Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>. However, the project has grown to a size where it is very hard to extend, maintain, and test. With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics. This way, we can keep Gardener core clean and independent.</p><h2 id=extension-resources>Extension-Resources</h2><p>Example extension resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Extension
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: <span style=color:#a31515>&#34;extension-dns-service&#34;</span>
</span></span><span style=display:flex><span>  namespace: shoot--project--abc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: shoot-dns-service
</span></span></code></pre></div><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally</h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the kubeconfig to the cluster you want to connect to ready in the <code>./dev/kubeconfig</code> file.
Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support</h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-dns-service/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!</h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-28d1868bb81c37360bc1080f4bd76d56>1 - Configuration</h1><h1 id=deployment-of-the-shoot-dns-service-extension>Deployment of the shoot DNS service extension</h1><p><strong>Disclaimer:</strong> This document is NOT a step by step deployment guide for the shoot DNS service extension and only contains some configuration specifics regarding the deployment of different components via the helm charts residing in the shoot DNS service extension <a href=https://github.com/gardener/gardener-extension-shoot-dns-service>repository</a>.</p><h2 id=gardener-extension-admission-shoot-dns-service>gardener-extension-admission-shoot-dns-service</h2><h3 id=authentication-against-the-garden-cluster>Authentication against the Garden cluster</h3><p>There are several authentication possibilities depending on whether or not <a href=https://github.com/gardener/garden-setup#concept-the-virtual-cluster>the concept of Virtual Garden</a> is used.</p><h4 id=virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster>Virtual Garden is not used, i.e., the <code>runtime</code> Garden cluster is also the <code>target</code> Garden cluster.</h4><h5 id=automounted-service-account-token>Automounted Service Account Token</h5><p>The easiest way to deploy the <code>gardener-extension-admission-shoot-dns-service</code> component will be to not provide <code>kubeconfig</code> at all. This way in-cluster configuration and an automounted service account token will be used. The drawback of this approach is that the automounted token will not be automatically rotated.</p><h5 id=service-account-token-volume-projection>Service Account Token Volume Projection</h5><p>Another solution will be to use <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>Service Account Token Volume Projection</a> combined with a <code>kubeconfig</code> referencing a token file (see example below).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://default.kubernetes.svc.cluster.local
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: garden
</span></span><span style=display:flex><span>    user: garden
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>current-context: garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div><p>This will allow for automatic rotation of the service account token by the <code>kubelet</code>. The configuration can be achieved by setting both <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.kubeconfig</code> in the respective chart&rsquo;s <code>values.yaml</code> file.</p><h4 id=virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster>Virtual Garden is used, i.e., the <code>runtime</code> Garden cluster is different from the <code>target</code> Garden cluster.</h4><h5 id=service-account>Service Account</h5><p>The easiest way to setup the authentication will be to create a service account and the respective roles will be bound to this service account in the <code>target</code> cluster. Then use the generated service account token and craft a <code>kubeconfig</code> which will be used by the workload in the <code>runtime</code> cluster. This approach does not provide a solution for the rotation of the service account token. However, this setup can be achieved by setting <code>.Values.global.virtualGarden.enabled: true</code> and following these steps:</p><ol><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Get the service account token and craft the <code>kubeconfig</code>.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><h5 id=client-certificate>Client Certificate</h5><p>Another solution will be to bind the roles in the <code>target</code> cluster to a <code>User</code> subject instead of a service account and use a client certificate for authentication. This approach does not provide a solution for the client certificate rotation. However, this setup can be achieved by setting both <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>, then following these steps:</p><ol><li>Generate a client certificate for the <code>target</code> cluster for the respective user.</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Craft a <code>kubeconfig</code> using the already generated client certificate.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><h5 id=projected-service-account-token>Projected Service Account Token</h5><p>This approach requires an already deployed and configured <a href=https://github.com/gardener/oidc-webhook-authenticator>oidc-webhook-authenticator</a> for the <code>target</code> cluster. Also the <code>runtime</code> cluster should be registered as a trusted identity provider in the <code>target</code> cluster. Then projected service accounts tokens from the <code>runtime</code> cluster can be used to authenticate against the <code>target</code> cluster. The needed steps are as follows:</p><ol><li>Deploy <a href=https://github.com/gardener/oidc-webhook-authenticator>OWA</a> and establish the needed trust.</li><li>Set <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>. <strong>Note:</strong> username value will depend on the trust configuration, e.g., <code>&lt;prefix>:system:serviceaccount:&lt;namespace>:&lt;serviceaccount></code></li><li>Set <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.serviceAccountTokenVolumeProjection.audience</code>. <strong>Note:</strong> audience value will depend on the trust configuration, e.g., <code>&lt;cliend-id-from-trust-config></code>.</li><li>Craft a kubeconfig (see example below).</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://virtual-garden.api
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: virtual-garden
</span></span><span style=display:flex><span>    user: virtual-garden
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>current-context: virtual-garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: virtual-garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-12a6b686a7df4d2160d67befee1ebdfa>2 - Deployment</h1><h1 id=gardener-dns-management-for-shoots>Gardener DNS Management for Shoots</h1><h2 id=introduction>Introduction</h2><p>Gardener allows Shoot clusters to request DNS names for Ingresses and Services out of the box.
To support this the gardener must be installed with the <code>shoot-dns-service</code>
extension.
This extension uses the seed&rsquo;s dns management infrastructure to maintain DNS
names for shoot clusters. So, far only the external DNS domain of a shoot
(already used for the kubernetes api server and ingress DNS names) can be used
for managed DNS names.</p><h2 id=configuration>Configuration</h2><p>To generally enable the DNS management for shoot objects the
<code>shoot-dns-service</code> extension must be registered by providing an
appropriate <a href=https://github.com/gardener/gardener-extension-shoot-dns-service/blob/master/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available
for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots, the registration must set the <em>globallyEnabled</em> flag to <code>true</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - kind: Extension
</span></span><span style=display:flex><span>      type: shoot-dns-service
</span></span><span style=display:flex><span>      globallyEnabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=deployment-of-dns-controller-manager>Deployment of DNS controller manager</h3><p>If you are using Gardener version >= <code>1.54</code>, please make sure to deploy the DNS controller manager by
adding the <code>dnsControllerManager</code> section to the <code>providerConfig.values</code> section.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerDeployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-dns-service
</span></span><span style=display:flex><span>type: helm
</span></span><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  chart: ...
</span></span><span style=display:flex><span>  values:
</span></span><span style=display:flex><span>    image:
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>    dnsControllerManager:
</span></span><span style=display:flex><span>      image:
</span></span><span style=display:flex><span>        repository: europe-docker.pkg.dev/gardener-project/releases/dns-controller-manager
</span></span><span style=display:flex><span>        tag: v0.16.0
</span></span><span style=display:flex><span>      configuration:
</span></span><span style=display:flex><span>        cacheTtl: 300
</span></span><span style=display:flex><span>        controllers: dnscontrollers,dnssources
</span></span><span style=display:flex><span>        dnsPoolResyncPeriod: 30m
</span></span><span style=display:flex><span>        <span style=color:green>#poolSize: 20</span>
</span></span><span style=display:flex><span>        <span style=color:green>#providersPoolResyncPeriod: 24h</span>
</span></span><span style=display:flex><span>        serverPortHttp: 8080
</span></span><span style=display:flex><span>      createCRDs: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>      deploy: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      replicaCount: 1
</span></span><span style=display:flex><span>      <span style=color:green>#resources:</span>
</span></span><span style=display:flex><span>      <span style=color:green>#  requests:</span>
</span></span><span style=display:flex><span>      <span style=color:green>#    cpu: 50m</span>
</span></span><span style=display:flex><span>      <span style=color:green>#    memory: 500Mi</span>
</span></span><span style=display:flex><span>    dnsProviderManagement:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=providing-base-domains-usable-for-a-shoot>Providing Base Domains usable for a Shoot</h3><p>So, far only the external DNS domain of a shoot already used
for the kubernetes api server and ingress DNS names can be used for managed
DNS names. This is either the shoot domain as subdomain of the default domain
configured for the gardener installation, or a dedicated domain with dedicated
access credentials configured for a dedicated shoot via the shoot manifest.</p><p>Alternatively, you can specify <code>DNSProviders</code> and its credentials
<code>Secret</code> directly in the shoot, if this feature is enabled.
By default, <code>DNSProvider</code> replication is disabled, but it can be enabled globally in the <code>ControllerDeployment</code>
or for a shoot cluster in the shoot manifest (details see further below).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerDeployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-dns-service
</span></span><span style=display:flex><span>type: helm
</span></span><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  chart: ...
</span></span><span style=display:flex><span>  values:
</span></span><span style=display:flex><span>    image:
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>    dnsProviderReplication:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>See <a href=https://github.com/gardener/external-dns-management/tree/master/examples>example files (20-* and 30-*)</a>
for details for the various provider types.</p><h3 id=shoot-feature-gate>Shoot Feature Gate</h3><p>If the shoot DNS feature is not globally enabled by default (depends on the
extension registration on the garden cluster), it must be enabled per shoot.</p><p>To enable the feature for a shoot, the shoot manifest must explicitly add the
<code>shoot-dns-service</code> extension.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-dns-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h4 id=enabledisable-dns-provider-replication-for-a-shoot>Enable/disable DNS provider replication for a shoot</h4><p>The DNSProvider` replication feature enablement can be overwritten in the
shoot manifest, e.g.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>Kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-dns-service
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        apiVersion: service.dns.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>        kind: DNSConfig
</span></span><span style=display:flex><span>        dnsProviderReplication:
</span></span><span style=display:flex><span>          enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-25999a79f656efd317f31f09d85cb4cf>3 - DNS Names</h1><h1 id=request-dns-names-in-shoot-clusters>Request DNS Names in Shoot Clusters</h1><h2 id=introduction>Introduction</h2><p>Within a shoot cluster, it is possible to request DNS records via the following resource types:</p><ul><li><a href=https://kubernetes.io/docs/concepts/services-networking/ingress/>Ingress</a></li><li><a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a></li><li><a href=https://github.com/gardener/external-dns-management/blob/master/README.md#the-model>DNSEntry</a></li></ul><p>It is necessary that the Gardener installation your shoot cluster runs in is equipped with a <code>shoot-dns-service</code> extension. This extension uses the seed&rsquo;s dns management infrastructure to maintain DNS names for shoot clusters. Please ask your Gardener operator if the extension is available in your environment.</p><h2 id=shoot-feature-gate>Shoot Feature Gate</h2><p>In some Gardener setups the <code>shoot-dns-service</code> extension is not enabled globally and thus must be configured per shoot cluster. Please adapt the shoot specification by the configuration shown below to activate the extension individually.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-dns-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=before-you-start>Before you start</h2><p>You should :</p><ul><li>Have created a shoot cluster</li><li>Have created and correctly configured a DNS Provider (Please consult <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_providers/>this page</a> for more information)</li><li>Have a basic understanding of DNS (see link under <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_names/#references>References</a>)</li></ul><p>There are 2 types of DNS that you can use within Kubernetes :</p><ul><li>internal (usually managed by coreDNS)</li><li>external (managed by a public DNS provider).</li></ul><p>This page, and the extension, exclusively works for external DNS handling.</p><p>Gardener allows 2 way of managing your external DNS:</p><ul><li>Manually, which means you are in charge of creating / maintaining your Kubernetes related DNS entries</li><li>Via the Gardener DNS extension</li></ul><h2 id=gardener-dns-extension>Gardener DNS extension</h2><p>The managed external DNS records feature of the Gardener clusters makes all this easier. You do not need DNS service provider specific knowledge, and in fact you do not need to leave your cluster at all to achieve that. You simply annotate the Ingress / Service that needs its DNS records managed and it will be automatically created / managed by Gardener.</p><p>Managed external DNS records are supported with the following DNS provider types:</p><ul><li>aws-route53</li><li>azure-dns</li><li>azure-private-dns</li><li>google-clouddns</li><li>openstack-designate</li><li>alicloud-dns</li><li>cloudflare-dns</li></ul><h3 id=request-dns-records-for-ingress-resources>Request DNS records for Ingress resources</h3><p>To request a DNS name for <code>Ingress</code>, <code>Service</code> or <code>Gateway</code> (Istio or Gateway API) objects in the shoot cluster it must be annotated with the DNS class <code>garden</code> and an annotation denoting the desired DNS names.</p><p>Example for an annotated Ingress resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    <span style=color:green># Let Gardener manage external DNS records for this Ingress.</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: special.example.com <span style=color:green># Use &#34;*&#34; to collects domains names from .spec.rules[].host</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;600&#34;</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>    <span style=color:green># If you are delegating the certificate management to Gardener, uncomment the following line</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/purpose: managed</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  - host: special.example.com
</span></span><span style=display:flex><span>    http:
</span></span><span style=display:flex><span>      paths:
</span></span><span style=display:flex><span>      - pathType: Prefix
</span></span><span style=display:flex><span>        path: <span style=color:#a31515>&#34;/&#34;</span>
</span></span><span style=display:flex><span>        backend:
</span></span><span style=display:flex><span>          service:
</span></span><span style=display:flex><span>            name: amazing-svc
</span></span><span style=display:flex><span>            port:
</span></span><span style=display:flex><span>              number: 8080
</span></span><span style=display:flex><span>  <span style=color:green># Uncomment the following part if you are delegating the certificate management to Gardener</span>
</span></span><span style=display:flex><span>  <span style=color:green>#tls:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#  - hosts:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#      - special.example.com</span>
</span></span><span style=display:flex><span>  <span style=color:green>#    secretName: my-cert-secret-name</span>
</span></span></code></pre></div><p>For an Ingress, the DNS names are already declared in the specification. Nevertheless the <em>dnsnames</em> annotation must be present. Here a subset of the DNS names of the ingress can be specified. If DNS names for all names are desired, the value <code>all</code> can be used.</p><p>Keep in mind that ingress resources are ignored unless an ingress controller is set up. Gardener does not provide an ingress controller by default. For more details, see <a href=https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/>Ingress Controllers</a> and <a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a> in the Kubernetes documentation.</p><h3 id=request-dns-records-for-service-type-loadbalancer>Request DNS records for service type LoadBalancer</h3><p>Example for an annotated Service (it must have the type <code>LoadBalancer</code>) resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-svc
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    <span style=color:green># Let Gardener manage external DNS records for this Service.</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: special.example.com
</span></span><span style=display:flex><span>    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;600&#34;</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    app: amazing-app
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>    - protocol: TCP
</span></span><span style=display:flex><span>      port: 80
</span></span><span style=display:flex><span>      targetPort: 8080
</span></span><span style=display:flex><span>  type: LoadBalancer
</span></span></code></pre></div><h3 id=request-dns-records-for-gateway-resources>Request DNS records for Gateway resources</h3><p>Please see <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/tutorials/istio-gateways/>Istio Gateways</a> or <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/tutorials/gateway-api-gateways/>Gateway API</a> for details.</p><h3 id=creating-a-dnsentry-resource-explicitly>Creating a DNSEntry resource explicitly</h3><p>It is also possible to create a DNS entry via the Kubernetes resource called <code>DNSEntry</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: dns.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: DNSEntry
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    <span style=color:green># Let Gardener manage this DNS entry.</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>  name: special-dnsentry
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  dnsName: special.example.com
</span></span><span style=display:flex><span>  ttl: 600
</span></span><span style=display:flex><span>  targets:
</span></span><span style=display:flex><span>  - 1.2.3.4
</span></span></code></pre></div><p>If one of the accepted DNS names is a direct subname of the shoot&rsquo;s ingress domain, this is already handled by the standard wildcard entry for the ingress domain. Therefore this name should be excluded from the <em>dnsnames</em> list in the annotation. If only this DNS name is configured in the ingress, no explicit DNS entry is required, and the DNS annotations should be omitted at all.</p><p>You can check the status of the <code>DNSEntry</code> with</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get dnsentry
</span></span><span style=display:flex><span>NAME          DNS                                                            TYPE          PROVIDER      STATUS    AGE
</span></span><span style=display:flex><span>mydnsentry    special.example.com     aws-route53   default/aws   Ready     24s
</span></span></code></pre></div><p>As soon as the status of the entry is <code>Ready</code>, the provider has accepted the new DNS record. Depending on the provider and your DNS settings and cache, <strong>it may take up to 24 hours for the new entry to be propagated over all internet</strong>.</p><p>More examples can be found <a href=https://github.com/gardener/external-dns-management/blob/master/examples/>here</a></p><h3 id=request-dns-records-for-serviceingress-resources-using-a-dnsannotation-resource>Request DNS records for Service/Ingress resources using a DNSAnnotation resource</h3><p>In rare cases it may not be possible to add annotations to a <code>Service</code> or <code>Ingress</code> resource object.</p><p>E.g.: the helm chart used to deploy the resource may not be adaptable for some reasons or some automation is used, which always restores the original content of the resource object by dropping any additional annotations.</p><p>In these cases, it is recommended to use an additional <code>DNSAnnotation</code> resource in order to have more flexibility that <code>DNSentry resources</code>. The <code>DNSAnnotation</code> resource makes the DNS shoot service behave as if annotations have been added to the referenced resource.</p><p>For the Ingress example shown above, you can create a <code>DNSAnnotation</code> resource alternatively to provide the annotations.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: dns.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: DNSAnnotation
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>  name: test-ingress-annotation
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resourceRef:
</span></span><span style=display:flex><span>    kind: Ingress
</span></span><span style=display:flex><span>    apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>    name: test-ingress
</span></span><span style=display:flex><span>    namespace: default
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: <span style=color:#a31515>&#39;*&#39;</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden    
</span></span></code></pre></div><p>Note that the DNSAnnotation resource itself needs the <code>dns.gardener.cloud/class=garden</code> annotation. This also only works for annotations known to the DNS shoot service (see <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_names/#accepted-external-dns-records-annotations>Accepted External DNS Records Annotations</a>).</p><p>For more details, see also <a href=https://github.com/gardener/external-dns-management#dnsannotation-objects>DNSAnnotation objects</a></p><h3 id=accepted-external-dns-records-annotations>Accepted External DNS Records Annotations</h3><p>Here are all of the accepted annotation related to the DNS extension:</p><table><thead><tr><th>Annotation</th><th>Description</th></tr></thead><tbody><tr><td>dns.gardener.cloud/dnsnames</td><td>Mandatory for service and ingress resources, accepts a comma-separated list of DNS names if multiple names are required. For ingress you can use the special value <code>'*'</code>. In this case, the DNS names are collected from <code>.spec.rules[].host</code>.</td></tr><tr><td>dns.gardener.cloud/class</td><td>Mandatory, in the context of the shoot-dns-service it must always be set to <code>garden</code>.</td></tr><tr><td>dns.gardener.cloud/ttl</td><td>Recommended, overrides the default Time-To-Live of the DNS record.</td></tr><tr><td>dns.gardener.cloud/cname-lookup-interval</td><td>Only relevant if multiple domain name targets are specified. It specifies the lookup interval for CNAMEs to map them to IP addresses (in seconds)</td></tr><tr><td>dns.gardener.cloud/realms</td><td>Internal, for restricting provider access for shoot DNS entries. Typcially not set by users of the shoot-dns-service.</td></tr><tr><td>dns.gardener.cloud/ip-stack</td><td>Only relevant for provider type <code>aws-route53</code> if target is an AWS load balancer domain name. Can be set for service, ingress and DNSEntry resources. It specify which DNS records with alias targets are created instead of the usual <code>CNAME</code> records. If the annotation is not set (or has the value <code>ipv4</code>), only an <code>A</code> record is created. With value <code>dual-stack</code>, both <code>A</code> and <code>AAAA</code> records are created. With value <code>ipv6</code> only an <code>AAAA</code> record is created.</td></tr><tr><td>service.beta.kubernetes.io/aws-load-balancer-ip-address-type=dualstack</td><td>For services, behaves similar to <code>dns.gardener.cloud/ip-stack=dual-stack</code>.</td></tr><tr><td>loadbalancer.openstack.org/load-balancer-address</td><td>Internal, for services only: support for PROXY protocol on Openstack (which needs a hostname as ingress). Typcially not set by users of the shoot-dns-service.</td></tr></tbody></table><p>If one of the accepted DNS names is a direct subdomain of the shoot&rsquo;s ingress domain, this is already handled by the standard wildcard entry for the ingress domain. Therefore, this name should be excluded from the <em>dnsnames</em> list in the annotation. If only this DNS name is configured in the ingress, no explicit DNS entry is required, and the DNS annotations should be omitted at all.</p><h2 id=troubleshooting>Troubleshooting</h2><h3 id=general-dns-tools>General DNS tools</h3><p>To check the DNS resolution, use the <code>nslookup</code> or <code>dig</code> command.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nslookup special.your-domain.com
</span></span></code></pre></div><p>or with dig</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ dig +short special.example.com
</span></span><span style=display:flex><span>Depending on your network settings, you may get a successful response faster using a public DNS server (e.g. 8.8.8.8, 8.8.4.4, or 1.1.1.1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dig @8.8.8.8 +short special.example.com
</span></span></code></pre></div><h3 id=dns-record-events>DNS record events</h3><p>The DNS controller publishes Kubernetes events for the resource which requested the DNS record (Ingress, Service, DNSEntry). These events reveal more information about the DNS requests being processed and are especially useful to check any kind of misconfiguration, e.g. requests for a domain you don&rsquo;t own.</p><p>Events for a successfully created DNS record:</p><pre tabindex=0><code>$ kubectl describe service my-service

Events:
  Type    Reason          Age                From                    Message
  ----    ------          ----               ----                    -------
  Normal  dns-annotation  19s                dns-controller-manager  special.example.com: dns entry is pending
  Normal  dns-annotation  19s (x3 over 19s)  dns-controller-manager  special.example.com: dns entry pending: waiting for dns reconciliation
  Normal  dns-annotation  9s (x3 over 10s)   dns-controller-manager  special.example.com: dns entry active
</code></pre><p>Please note, events vanish after their retention period (usually <code>1h</code>).</p><h3 id=dnsentry-status>DNSEntry status</h3><p><code>DNSEntry</code> resources offer a <code>.status</code> sub-resource which can be used to check the current state of the object.</p><p>Status of a erroneous <code>DNSEntry</code>.</p><pre tabindex=0><code>  status:
    message: No responsible provider found
    observedGeneration: 3
    provider: remote
    state: Error
</code></pre><h2 id=references>References</h2><ul><li><a href=https://www.cloudflare.com/en-ca/learning/dns/what-is-dns>Understanding DNS</a></li><li><a href=https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/>Kubernetes Internal DNS</a></li><li><a href=https://github.com/gardener/external-dns-management/blob/master/pkg/apis/dns/v1alpha1/dnsentry.go>DNSEntry API (Golang)</a></li><li><a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/>Managing Certificates with Gardener</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ecf32a50f50533e421c6d743abdd9ee2>4 - DNS Providers</h1><h1 id=dns-providers>DNS Providers</h1><h2 id=introduction>Introduction</h2><p>Gardener can manage DNS records on your behalf, so that you can request them via different resource types (see <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_names/>here</a>) within the shoot cluster. The domains for which you are permitted to request records, are however restricted and depend on the DNS provider configuration.</p><h2 id=shoot-provider>Shoot provider</h2><p>By default, every shoot cluster is equipped with a default provider. It is the very same provider that manages the shoot cluster&rsquo;s <code>kube-apiserver</code> public DNS record (DNS address in your Kubeconfig).</p><pre tabindex=0><code>kind: Shoot
...
dns:
  domain: shoot.project.default-domain.gardener.cloud
</code></pre><p>You are permitted to request any sub-domain of <code>.dns.domain</code> that is not already taken (e.g. <code>api.shoot.project.default-domain.gardener.cloud</code>, <code>*.ingress.shoot.project.default-domain.gardener.cloud</code>) with this provider.</p><h2 id=additional-providers>Additional providers</h2><p>If you need to request DNS records for domains not managed by the <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_providers/#Shoot-provider>default provider</a>, additional providers can
be configured in the shoot specification.
Alternatively, if it is enabled, it can be added as <code>DNSProvider</code> resources to the shoot cluster.</p><h3 id=additional-providers-in-the-shoot-specification>Additional providers in the shoot specification</h3><p>To add a providers in the shoot spec, you need set them in the <code>spec.dns.providers</code> list.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  dns:
</span></span><span style=display:flex><span>    domain: shoot.project.default-domain.gardener.cloud
</span></span><span style=display:flex><span>    providers:
</span></span><span style=display:flex><span>    - secretName: my-aws-account
</span></span><span style=display:flex><span>      type: aws-route53
</span></span><span style=display:flex><span>    - secretName: my-gcp-account
</span></span><span style=display:flex><span>      type: google-clouddns
</span></span></code></pre></div><blockquote><p>Please consult the <a href=https://gardener.cloud/docs/gardener/api-reference/core/#core.gardener.cloud/v1beta1.DNSProvider>API-Reference</a> to get a complete list of supported fields and configuration options.</p></blockquote><p>Referenced secrets should exist in the project namespace in the Garden cluster and must comply with the provider specific credentials format. The <strong>External-DNS-Management</strong> project provides corresponding examples (<a href=https://github.com/gardener/external-dns-management/tree/master/examples>20-secret-&lt;provider-name>-credentials.yaml</a>) for known providers.</p><h3 id=additional-providers-as-resources-in-the-shoot-cluster>Additional providers as resources in the shoot cluster</h3><p>If it is not enabled globally, you have to enable the feature in the shoot manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>Kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-dns-service
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        apiVersion: service.dns.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>        kind: DNSConfig
</span></span><span style=display:flex><span>        dnsProviderReplication:
</span></span><span style=display:flex><span>          enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>To add a provider directly in the shoot cluster, provide a <code>DNSProvider</code> in any namespace together
with <code>Secret</code> containing the credentials.</p><p>For example if the domain is hosted with AWS Route 53 (provider type <code>aws-route53</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: dns.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: DNSProvider
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>  name: my-own-domain
</span></span><span style=display:flex><span>  namespace: my-namespace
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: aws-route53
</span></span><span style=display:flex><span>  secretRef:
</span></span><span style=display:flex><span>    name: my-own-domain-credentials
</span></span><span style=display:flex><span>  domains:
</span></span><span style=display:flex><span>    include:
</span></span><span style=display:flex><span>    - my.own.domain.com
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-own-domain-credentials
</span></span><span style=display:flex><span>  namespace: my-namespace
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  <span style=color:green># replace &#39;...&#39; with values encoded as base64</span>
</span></span><span style=display:flex><span>  AWS_ACCESS_KEY_ID: ...
</span></span><span style=display:flex><span>  AWS_SECRET_ACCESS_KEY: ...
</span></span></code></pre></div><p>The <strong>External-DNS-Management</strong> project provides examples with more details for <code>DNSProviders</code> (30-provider-&lt;provider-name>.yaml)
and credential <code>Secrets</code> (20-secret-&lt;provider-name>.yaml) at <a href=https://github.com/gardener/external-dns-management/tree/master/examples>https://github.com/gardener/external-dns-management//examples</a>
for all supported provider types.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ea762d41ff072075554bb0c27bbc83d5>5 - Gateway Api Gateways</h1><h1 id=using-annotated-gateway-api-gateway-andor-httproutes-as-source>Using annotated Gateway API Gateway and/or HTTPRoutes as Source</h1><p>This tutorial describes how to use annotated Gateway API resources as source for DNSEntries with the Gardener shoot-dns-service extension.</p><p>The dns-controller-manager supports the resources <code>Gateway</code> and <code>HTTPRoute</code>.</p><h2 id=install-istio-on-your-cluster>Install Istio on your cluster</h2><p>Using a new or existing shoot cluster, follow the Istio <a href=https://istio.io/latest/docs/tasks/traffic-management/ingress/gateway-api/>Kubernetes Gateway API</a> to
install the Gateway API and to install Istio.</p><p>These are the typical commands for the Istio installation with the Kubernetes Gateway API:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export KUEBCONFIG=...
</span></span><span style=display:flex><span>curl -L https://istio.io/downloadIstio | sh -
</span></span><span style=display:flex><span>kubectl get crd gateways.gateway.networking.k8s.io &amp;&gt; /dev/null || <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  { kubectl kustomize <span style=color:#a31515>&#34;github.com/kubernetes-sigs/gateway-api/config/crd?ref=v1.0.0&#34;</span> | kubectl apply -f -; }
</span></span><span style=display:flex><span>istioctl install --set profile=minimal -y
</span></span><span style=display:flex><span>kubectl label namespace default istio-injection=enabled
</span></span></code></pre></div><h2 id=verify-that-gateway-source-works>Verify that Gateway Source works</h2><h3 id=install-a-sample-service>Install a sample service</h3><p>With automatic sidecar injection:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/httpbin/httpbin.yaml
</span></span></code></pre></div><h3 id=using-a-gateway-as-a-source>Using a Gateway as a source</h3><p>Deploy the Gateway API configuration including a single exposed route (i.e., /get):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace istio-ingress
</span></span><span style=display:flex><span>kubectl apply -f - <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/dnsnames: &#34;*.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/class: garden
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gatewayClassName: istio
</span></span></span><span style=display:flex><span><span style=color:#a31515>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hostname: &#34;*.example.com&#34;  # this is used by dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>    port: 80
</span></span></span><span style=display:flex><span><span style=color:#a31515>    protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#a31515>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      namespaces:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        from: All
</span></span></span><span style=display:flex><span><span style=color:#a31515>---
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>    namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hostnames: [&#34;httpbin.example.com&#34;]  # this is used by dns-controller-manager to extract DNS names too
</span></span></span><span style=display:flex><span><span style=color:#a31515>  rules:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - path:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#a31515>        value: /get
</span></span></span><span style=display:flex><span><span style=color:#a31515>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>      port: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>You should now see events in the namespace of the gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system get events --sort-by={.metadata.creationTimestamp}
</span></span><span style=display:flex><span>LAST SEEN   TYPE      REASON                 OBJECT                                       MESSAGE
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         service/gateway-istio                      httpbin.example.com: created dns entry object shoot--foo--bar/gateway-istio-service-zpf8n
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         service/gateway-istio                      httpbin.example.com: dns entry pending: waiting <span style=color:#00f>for</span> dns reconciliation
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         service/gateway-istio                      httpbin.example.com: dns entry is pending
</span></span><span style=display:flex><span>36s         Normal    dns-annotation         service/gateway-istio                      httpbin.example.com: dns entry active
</span></span></code></pre></div><h4 id=using-a-httproute-as-a-source>Using a HTTPRoute as a source</h4><p>If the <code>Gateway</code> resource is annotated with <code>dns.gardener.cloud/dnsnames: "*"</code>, hostnames from all referencing <code>HTTPRoute</code> resources
are automatically extracted. These resources don&rsquo;t need an additional annotation.</p><p>Deploy the Gateway API configuration including a single exposed route (i.e., /get):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace istio-ingress
</span></span><span style=display:flex><span>kubectl apply -f - <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/dnsnames: &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/class: garden
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gatewayClassName: istio
</span></span></span><span style=display:flex><span><span style=color:#a31515>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hostname: null  # not set 
</span></span></span><span style=display:flex><span><span style=color:#a31515>    port: 80
</span></span></span><span style=display:flex><span><span style=color:#a31515>    protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#a31515>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      namespaces:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        from: All
</span></span></span><span style=display:flex><span><span style=color:#a31515>---
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>    namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hostnames: [&#34;httpbin.example.com&#34;]  # this is used by dns-controller-manager to extract DNS names too
</span></span></span><span style=display:flex><span><span style=color:#a31515>  rules:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - path:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#a31515>        value: /get
</span></span></span><span style=display:flex><span><span style=color:#a31515>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>      port: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>This should show a similar events as above.</p><h4 id=access-the-sample-service-using-curl>Access the sample service using <code>curl</code></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I http://httpbin.example.com/get
</span></span><span style=display:flex><span>HTTP/1.1 200 OK
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>date: Tue, 13 Feb 2024 08:09:41 GMT
</span></span><span style=display:flex><span>content-type: application/json
</span></span><span style=display:flex><span>content-length: 701
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>access-control-allow-credentials: true
</span></span><span style=display:flex><span>x-envoy-upstream-service-time: 19
</span></span></code></pre></div><p>Accessing any other URL that has not been explicitly exposed should return an HTTP 404 error:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I http://httpbin.example.com/headers
</span></span><span style=display:flex><span>HTTP/1.1 404 Not Found
</span></span><span style=display:flex><span>date: Tue, 13 Feb 2024 08:09:41 GMT
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>transfer-encoding: chunked
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-003ade58dc4b08afb6f7278172caaaf8>6 - Istio Gateways</h1><h1 id=using-annotated-istio-gateway-andor-istio-virtual-service-as-source>Using annotated Istio Gateway and/or Istio Virtual Service as Source</h1><p>This tutorial describes how to use annotated Istio Gateway resources as source for DNSEntries with the Gardener shoot-dns-service extension.</p><h2 id=install-istio-on-your-cluster>Install Istio on your cluster</h2><p>Using a new or existing shoot cluster, follow the <a href=https://istio.io/latest/docs/setup/getting-started/>Istio Getting Started</a> to download and install Istio.</p><p>These are the typical commands for the istio demo installation</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export KUEBCONFIG=...
</span></span><span style=display:flex><span>curl -L https://istio.io/downloadIstio | sh -
</span></span><span style=display:flex><span>istioctl install --set profile=demo -y
</span></span><span style=display:flex><span>kubectl label namespace default istio-injection=enabled
</span></span></code></pre></div><h2 id=verify-that-istio-gatewayvirtualservice-source-works>Verify that Istio Gateway/VirtualService Source works</h2><h3 id=install-a-sample-service>Install a sample service</h3><p>With automatic sidecar injection:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/httpbin/httpbin.yaml
</span></span></code></pre></div><h3 id=using-a-gateway-as-a-source>Using a Gateway as a source</h3><h4 id=create-an-istio-gateway>Create an Istio Gateway:</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-system
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/dnsnames: &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/class: garden
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  selector:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    istio: ingressgateway # use Istio default gateway implementation
</span></span></span><span style=display:flex><span><span style=color:#a31515>  servers:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      number: 80
</span></span></span><span style=display:flex><span><span style=color:#a31515>      name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - &#34;httpbin.example.com&#34; # this is used by the dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><h4 id=configure-routes-for-traffic-entering-via-the-gateway>Configure routes for traffic entering via the Gateway:</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: VirtualService
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - &#34;httpbin.example.com&#34; # this is also used by the dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gateways:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - istio-system/httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  http:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - match:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /status
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /delay
</span></span></span><span style=display:flex><span><span style=color:#a31515>    route:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - destination:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>          number: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>        host: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>You should now see events in the namespace of the gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system get events --sort-by={.metadata.creationTimestamp}
</span></span><span style=display:flex><span>LAST SEEN   TYPE      REASON                 OBJECT                                       MESSAGE
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         gateway/httpbin-gateway                      httpbin.example.com: created dns entry object shoot--foo--bar/httpbin-gateway-gateway-zpf8n
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         gateway/httpbin-gateway                      httpbin.example.com: dns entry pending: waiting <span style=color:#00f>for</span> dns reconciliation
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         gateway/httpbin-gateway                      httpbin.example.com: dns entry is pending
</span></span><span style=display:flex><span>36s         Normal    dns-annotation         gateway/httpbin-gateway                      httpbin.example.com: dns entry active
</span></span></code></pre></div><h3 id=using-a-virtualservice-as-a-source>Using a VirtualService as a source</h3><p>If the <code>Gateway</code> resource is annotated with <code>dns.gardener.cloud/dnsnames: "*"</code>, hosts from all referencing <code>VirtualServices</code> resources
are automatically extracted. These resources don&rsquo;t need an additional annotation.</p><h4 id=create-an-istio-gateway-1>Create an Istio Gateway:</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-system
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/dnsnames: &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/class: garden
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  selector:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    istio: ingressgateway # use Istio default gateway implementation
</span></span></span><span style=display:flex><span><span style=color:#a31515>  servers:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      number: 80
</span></span></span><span style=display:flex><span><span style=color:#a31515>      name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><h4 id=configure-routes-for-traffic-entering-via-the-gateway-1>Configure routes for traffic entering via the Gateway:</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: VirtualService
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default  
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - &#34;httpbin.example.com&#34; # this is used by dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gateways:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - istio-system/httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  http:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - match:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /status
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /delay
</span></span></span><span style=display:flex><span><span style=color:#a31515>    route:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - destination:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>          number: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>        host: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>This should show a similar events as above.</p><p>To get the targets to the extracted DNS names, the shoot-dns-service controller is able to gather information from the kubernetes service of the Istio Ingress Gateway.</p><p><strong>Note</strong>: It is also possible to set the targets my specifying an Ingress resource using the <code>dns.gardener.cloud/ingress</code> annotation on the Istio Ingress Gateway resource.</p><p><strong>Note</strong>: It is also possible to set the targets manually by using the <code>dns.gardener.cloud/targets</code> annotation on the Istio Ingress Gateway resource.</p><h3 id=access-the-sample-service-using-curl>Access the sample service using <code>curl</code></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I http://httpbin.example.com/status/200
</span></span><span style=display:flex><span>HTTP/1.1 200 OK
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>date: Tue, 13 Feb 2024 07:49:37 GMT
</span></span><span style=display:flex><span>content-type: text/html; charset=utf-8
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>access-control-allow-credentials: true
</span></span><span style=display:flex><span>content-length: 0
</span></span><span style=display:flex><span>x-envoy-upstream-service-time: 15
</span></span></code></pre></div><p>Accessing any other URL that has not been explicitly exposed should return an HTTP 404 error:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I http://httpbin.example.com/headers
</span></span><span style=display:flex><span>HTTP/1.1 404 Not Found
</span></span><span style=display:flex><span>date: Tue, 13 Feb 2024 08:09:41 GMT
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>transfer-encoding: chunked
</span></span></code></pre></div></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2025 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>