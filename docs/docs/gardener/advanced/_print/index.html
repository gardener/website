<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.95.0"><link rel=canonical type=text/html href=https://gardener.cloud/docs/gardener/advanced/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/gardener/advanced/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Advanced | Gardener</title><meta name=description content><meta property="og:title" content="Advanced"><meta property="og:description" content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:type" content="website"><meta property="og:url" content="https://gardener.cloud/docs/gardener/advanced/"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Advanced"><meta itemprop=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Advanced"><meta name=twitter:description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><link rel=preload href=/scss/main.min.52b703b92d167c14e82f904cd88f9dbe92798d607a8949235304e48c7cd0a116.css as=style><link href=/scss/main.min.52b703b92d167c14e82f904cd88f9dbe92798d607a8949235304e48c7cd0a116.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/><span>Demo (soon!)</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.c17f21d4650c3c204b0e31d761b5d423.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/gardener/advanced/>Return to the regular view of this page</a>.</p></div><h1 class=title>Advanced</h1><div class=content></div></div><div class=td-content><h1 id=pg-e394b175db20fef0415e29bedab14279>1 - Cleanup of Shoot Clusters in Deletion</h1><h1 id=cleanup-of-shoot-clusters-in-deletion>Cleanup of Shoot Clusters in Deletion</h1><p>When a shoot cluster is deleted then Gardener tries to gracefully remove most of the Kubernetes resources inside the cluster.
This is to prevent that any infrastructure or other artifacts remain after the shoot deletion.</p><p>The cleanup is performed in four steps.
Some resources are deleted with a grace period, and all resources are forcefully deleted (by removing blocking finalizers) after some time to not block the cluster deletion entirely.</p><p><strong>Cleanup steps:</strong></p><ol><li>All <code>ValidatingWebhookConfiguration</code>s and <code>MutatingWebhookConfiguration</code>s are deleted with a <code>5m</code> grace period. Forceful finalization happens after <code>5m</code>.</li><li>All <code>APIService</code>s and <code>CustomResourceDefinition</code>s are deleted with a <code>5m</code> grace period. Forceful finalization happens after <code>1h</code>.</li><li>All <code>CronJob</code>s, <code>DaemonSet</code>s, <code>Deployment</code>s, <code>Ingress</code>s, <code>Job</code>s, <code>Pod</code>s, <code>ReplicaSet</code>s, <code>ReplicationController</code>s, <code>Service</code>s, <code>StatefulSet</code>s, <code>PersistentVolumeClaim</code>s are deleted with a <code>5m</code> grace period. Forceful finalization happens after <code>5m</code>.<blockquote><p>If the <code>Shoot</code> is annotated with <code>shoot.gardener.cloud/skip-cleanup=true</code>, then only <code>Service</code>s and <code>PersistentVolumeClaim</code>s are considered.</p></blockquote></li><li>All <code>VolumeSnapshot</code>s and <code>VolumeSnapshotContent</code>s are deleted with a <code>5m</code> grace period. Forceful finalization happens after <code>1h</code>.</li></ol><p>It is possible to override the finalization grace periods via annotations on the <code>Shoot</code>:</p><ul><li><code>shoot.gardener.cloud/cleanup-webhooks-finalize-grace-period-seconds</code> (for the resources handled in step 1)</li><li><code>shoot.gardener.cloud/cleanup-extended-apis-finalize-grace-period-seconds</code> (for the resources handled in step 2)</li><li><code>shoot.gardener.cloud/cleanup-kubernetes-resources-finalize-grace-period-seconds</code> (for the resources handled in step 3)</li></ul><p>⚠️ If <code>"0"</code> is provided, then all resources are finalized immediately without waiting for any graceful deletion.
Please be aware that this might lead to orphaned infrastructure artifacts.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6b812b28c0ee3a526147b600aab3aee3>2 - containerd Registry Configuration</h1><h1 id=containerd-registry-configuration><code>containerd</code> Registry Configuration</h1><p>containerd supports configuring registries and mirrors. Using this native containerd feature, Shoot owners can configure containerd to use public or private mirrors for a given upstream registry. More details about the registry configuration can be found in the <a href=https://github.com/containerd/containerd/blob/main/docs/hosts.md>corresponding upstream documentation</a>.</p><h3 id=containerd-registry-configuration-patterns><code>containerd</code> Registry Configuration Patterns</h3><p>At the time of writing this document, containerd support two patterns for configuring registries/mirrors.</p><blockquote><p>Note: Trying to use both of the patterns at the same time is not supported by containerd. Only one of the configuration patterns has to be followed strictly.</p></blockquote><h5 id=old-and-deprecated-pattern>Old and Deprecated Pattern</h5><p>The old and deprecated pattern is specifying <code>registry.mirrors</code> and <code>registry.configs</code> in the containerd&rsquo;s config.toml file. See the <a href=https://github.com/containerd/containerd/blob/main/docs/cri/registry.md>upstream documentation</a>.
Example of the old and deprecated pattern:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>version = 2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[plugins.<span style=color:#a31515>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry]
</span></span><span style=display:flex><span>  [plugins.<span style=color:#a31515>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors]
</span></span><span style=display:flex><span>    [plugins.<span style=color:#a31515>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span style=color:#a31515>&#34;docker.io&#34;</span>]
</span></span><span style=display:flex><span>      endpoint = [<span style=color:#a31515>&#34;https://public-mirror.example.com&#34;</span>]
</span></span></code></pre></div><p>In the above example, containerd is configured to first try to pull <code>docker.io</code> images from a configured endpoint (<code>https://public-mirror.example.com</code>). If the image is not available in <code>https://public-mirror.example.com</code>, then containerd will fall back to the upstream registry (<code>docker.io</code>) and will pull the image from there.</p><h5 id=hosts-directory-pattern>Hosts Directory Pattern</h5><p>The hosts directory pattern is the new and recommended pattern for configuring registries. It is available starting <code>containerd@v1.5.0</code>. See the <a href=https://github.com/containerd/containerd/blob/main/docs/hosts.md>upstream documentation</a>.
The above example in the hosts directory pattern looks as follows.
The <code>/etc/containerd/config.toml</code> file has the following section:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>version = 2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[plugins.<span style=color:#a31515>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry]
</span></span><span style=display:flex><span>   config_path = <span style=color:#a31515>&#34;/etc/containerd/certs.d&#34;</span>
</span></span></code></pre></div><p>The following hosts directory structure has to be created:</p><pre tabindex=0><code>$ tree /etc/containerd/certs.d
/etc/containerd/certs.d
└── docker.io
    └── hosts.toml
</code></pre><p>Finally, for the <code>docker.io</code> upstream registry, we configure a <code>hosts.toml</code> file as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>server = <span style=color:#a31515>&#34;https://registry-1.docker.io&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[host.<span style=color:#a31515>&#34;http://public-mirror.example.com&#34;</span>]
</span></span><span style=display:flex><span>  capabilities = [<span style=color:#a31515>&#34;pull&#34;</span>, <span style=color:#a31515>&#34;resolve&#34;</span>]
</span></span></code></pre></div><h3 id=configuring-containerd-registries-for-a-shoot>Configuring <code>containerd</code> Registries for a Shoot</h3><p>Gardener supports configuring <code>containerd</code> registries on a Shoot using the new <a href=https://github.com/containerd/containerd/blob/main/docs/hosts.md>hosts directory pattern</a>. For each Shoot Node, Gardener creates the <code>/etc/containerd/certs.d</code> directory and adds the following section to the containerd&rsquo;s <code>/etc/containerd/config.toml</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[plugins.<span style=color:#a31515>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry] <span style=color:green># gardener-managed</span>
</span></span><span style=display:flex><span>   config_path = <span style=color:#a31515>&#34;/etc/containerd/certs.d&#34;</span>
</span></span></code></pre></div><p>This allows Shoot owners to use the <a href=https://github.com/containerd/containerd/blob/main/docs/hosts.md>hosts directory pattern</a> to configure registries for containerd. To do this, the Shoot owners need to create a directory under <code>/etc/containerd/certs.d</code> that is named with the upstream registry host name. In the newly created directory, a <code>hosts.toml</code> file needs to be created. For more details, see the <a href=/docs/gardener/advanced/containerd-registry-configuration/#hosts-directory-pattern>hosts directory pattern section</a> and the <a href=https://github.com/containerd/containerd/blob/main/docs/hosts.md>upstream documentation</a>.</p><h3 id=the-registry-cache-extension>The registry-cache Extension</h3><p>There is a Gardener-native extension named <a href=https://github.com/gardener/gardener-extension-registry-cache>registry-cache</a> that supports:</p><ul><li>Configuring containerd registry mirrors based on the above-described contract. The feature is added in <a href=https://github.com/gardener/gardener-extension-registry-cache/releases/tag/v0.6.0>registry-cache@v0.6.0</a>.</li><li>Running pull through cache(s) in the Shoot.</li></ul><p>For more details, see the <a href=/docs/extensions/others/gardener-extension-registry-cache/>registry-cache documentation</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-402066bfdcffddb99b02b095c73915b8>3 - Control Plane Endpoints And Ports</h1><h1 id=endpoints-and-ports-of-a-shoot-control-plane>Endpoints and Ports of a Shoot Control-Plane</h1><p>With the <a href=/docs/gardener/reversed-vpn-tunnel/>reversed VPN</a> tunnel, there are no endpoints with open ports in the shoot cluster required by Gardener.
In order to allow communication to the shoots control-plane in the seed cluster, there are endpoints shared by multiple shoots of a seed cluster.
Depending on the configured zones or <a href=/docs/gardener/networking/exposureclasses/>exposure classes</a>, there are different endpoints in a seed cluster. The IP address(es) can be determined by a DNS query for the API Server URL.
The main entry-point into the seed cluster is the load balancer of the Istio ingress-gateway service. Depending on the infrastructure provider, there can be one IP address per zone.</p><p>The load balancer of the Istio ingress-gateway service exposes the following TCP ports:</p><ul><li><strong>443</strong> for requests to the shoot API Server. The request is dispatched according to the set TLS SNI extension.</li><li><strong>8443</strong> for requests to the shoot API Server via <code>api-server-proxy</code>, dispatched based on the proxy protocol target, which is the IP address of <code>kubernetes.default.svc.cluster.local</code> in the shoot.</li><li><strong>8132</strong> to establish the reversed VPN connection. It&rsquo;s dispatched according to an HTTP header value.</li></ul><h2 id=kube-apiserver-via-sni><code>kube-apiserver</code> via SNI</h2><p><img src=/__resources/api-server-sni_b9424a.png alt="kube-apiserver via SNI"></p><p>DNS entries for <code>api.&lt;external-domain></code> and <code>api.&lt;shoot>.&lt;project>.&lt;internal-domain></code> point to the load balancer of an Istio ingress-gateway service.
The Kubernetes client sets the server name to <code>api.&lt;external-domain></code> or <code>api.&lt;shoot>.&lt;project>.&lt;internal-domain></code>.
Based on SNI, the connection is forwarded to the respective API Server at TCP layer. There is no TLS termination at the Istio ingress-gateway.
TLS termination happens on the shoots API Server. Traffic is end-to-end encrypted between the client and the API Server. The certificate authority and authentication are defined in the corresponding <code>kubeconfig</code>.
Details can be found in <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/08-shoot-apiserver-via-sni.md>GEP-08</a>.</p><h2 id=kube-apiserver-via-apiserver-proxy><code>kube-apiserver</code> via <code>apiserver-proxy</code></h2><p><img src=/__resources/api-server-proxy_5b1751.png alt=apiserver-proxy></p><p>Inside the shoot cluster, the API Server can also be reached by the cluster internal name <code>kubernetes.default.svc.cluster.local</code>.
The pods <code>apiserver-proxy</code> are deployed in the host network as daemonset and intercept connections to the Kubernetes service IP address.
The destination address is changed to the cluster IP address of the service <code>kube-apiserver.&lt;shoot-namespace>.svc.cluster.local</code> in the seed cluster.
The connections are forwarded via the <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/listener_filters/proxy_protocol>HaProxy Proxy Protocol</a> to the Istio ingress-gateway in the seed cluster.
The Istio ingress-gateway forwards the connection to the respective shoot API Server by it&rsquo;s cluster IP address.
As TLS termination happens at the API Server, the traffic is end-to-end encrypted the same way as with SNI.</p><p>Details can be found in <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/11-apiserver-network-proxy.md>GEP-11</a>.</p><h2 id=reversed-vpn-tunnel>Reversed VPN Tunnel</h2><p><img src=/__resources/reversed-vpn_ba3dfe.png alt="Reversed VPN"></p><p>As the API Server has to be able to connect to endpoints in the shoot cluster, a VPN connection is established.
This VPN connection is initiated from a VPN client in the shoot cluster.
The VPN client connects to the Istio ingress-gateway and is forwarded to the VPN server in the control-plane namespace of the shoot.
Once the VPN tunnel between the VPN client in the shoot and the VPN server in the seed cluster is established, the API Server can connect to nodes, services and pods in the shoot cluster.</p><p>More details can be found in the <a href=/docs/gardener/reversed-vpn-tunnel/>usage document</a> and <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/14-reversed-cluster-vpn.md>GEP-14</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-8e570081e30476d17222f23b3495235e>4 - Custom containerd Configuration</h1><h1 id=custom-containerd-configuration>Custom <code>containerd</code> Configuration</h1><p>In case a <code>Shoot</code> cluster uses <code>containerd</code>, it is possible to make the <code>containerd</code> process load custom configuration files.
Gardener initializes <code>containerd</code> with the following statement:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>imports = [<span style=color:#a31515>&#34;/etc/containerd/conf.d/*.toml&#34;</span>]
</span></span></code></pre></div><p>This means that all <code>*.toml</code> files in the <code>/etc/containerd/conf.d</code> directory will be imported and merged with the default configuration.
To prevent unintended configuration overwrites, please be aware that containerd merges config sections, not individual keys (see <a href=https://github.com/containerd/containerd/issues/5837#issuecomment-894840240>here</a> and <a href=https://github.com/gardener/gardener/pull/7316>here</a>).
Please consult the <a href=https://github.com/containerd/containerd/blob/main/docs/man/containerd-config.toml.5.md#format>upstream <code>containerd</code> documentation</a> for more information.</p><blockquote><p>⚠️ Note that this only applies to nodes which were newly created after <code>gardener/gardener@v1.51</code> was deployed. Existing nodes are not affected.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-2bd2c33cb50fe71582995f2680723d95>5 - Necessary Labeling for Custom CSI Components</h1><h1 id=necessary-labeling-for-custom-csi-components>Necessary Labeling for Custom CSI Components</h1><p>Some provider extensions for Gardener are using CSI components to manage persistent volumes in the shoot clusters.
Additionally, most of the provider extensions are deploying controllers for taking volume snapshots (CSI snapshotter).</p><p>End-users can deploy their own CSI components and controllers into shoot clusters.
In such situations, there are multiple controllers acting on the <code>VolumeSnapshot</code> custom resources (each responsible for those instances associated with their respective driver provisioner types).</p><p>However, this might lead to operational conflicts that cannot be overcome by Gardener alone.
Concretely, Gardener cannot know which custom CSI components were installed by end-users which can lead to issues, especially during shoot cluster deletion.
You can add a label to your custom CSI components indicating that Gardener should not try to remove them during shoot cluster deletion. This means you have to take care of the lifecycle for these components yourself!</p><h2 id=recommendations>Recommendations</h2><p>Custom CSI components are typically regular <code>Deployment</code>s running in the shoot clusters.</p><p><strong>Please label them with the <code>shoot.gardener.cloud/no-cleanup=true</code> label.</strong></p><h2 id=background-information>Background Information</h2><p>When a shoot cluster is deleted, Gardener deletes most Kubernetes resources (<code>Deployment</code>s, <code>DaemonSet</code>s, <code>StatefulSet</code>s, etc.). Gardener will also try to delete CSI components if they are not marked with the above mentioned label.</p><p>This can result in <code>VolumeSnapshot</code> resources still having finalizers that will never be cleaned up.
Consequently, manual intervention is required to clean them up before the cluster deletion can continue.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-87edf1b89cce73c9121210c7b62b0cdf>6 - Readiness of Shoot Worker Nodes</h1><div class=lead>Implementation in Gardener for readiness of Shoot worker Nodes. How to mark components as node-critical</div><h1 id=readiness-of-shoot-worker-nodes>Readiness of Shoot Worker Nodes</h1><h2 id=background>Background</h2><p>When registering new <code>Nodes</code>, kubelet adds the <code>node.kubernetes.io/not-ready</code> taint to prevent scheduling workload Pods to the <code>Node</code> until the <code>Ready</code> condition gets <code>True</code>.
However, the kubelet does not consider the readiness of node-critical Pods.
Hence, the <code>Ready</code> condition might get <code>True</code> and the <code>node.kubernetes.io/not-ready</code> taint might get removed, for example, before the CNI daemon Pod (e.g., <code>calico-node</code>) has successfully placed the CNI binaries on the machine.</p><p>This problem has been discussed extensively in kubernetes, e.g., in <a href=https://github.com/kubernetes/kubernetes/issues/75890>kubernetes/kubernetes#75890</a>.
However, several proposals have been rejected because the problem can be solved by using the <code>--register-with-taints</code> kubelet flag and dedicated controllers (<a href=https://github.com/kubernetes/enhancements/pull/1003#issuecomment-619087019>ref</a>).</p><h2 id=implementation-in-gardener>Implementation in Gardener</h2><p>Gardener makes sure that workload Pods are only scheduled to <code>Nodes</code> where all node-critical components required for running workload Pods are ready.
For this, Gardener follows the proposed solution by the Kubernetes community and registers new <code>Node</code> objects with the <code>node.gardener.cloud/critical-components-not-ready</code> taint (effect <code>NoSchedule</code>).
gardener-resource-manager&rsquo;s <a href=/docs/gardener/concepts/resource-manager/#node-controller><code>Node</code> controller</a> reacts on newly created <code>Node</code> objects that have this taint.
The controller removes the taint once all node-critical Pods are ready (determined by checking the Pods&rsquo; <code>Ready</code> conditions).</p><p>The <code>Node</code> controller considers all <code>DaemonSets</code> and <code>Pods</code> as node-critical which run in the <code>kube-system</code> namespace and are labeled with <code>node.gardener.cloud/critical-component=true</code>.
If there are <code>DaemonSets</code> that contain the <code>node.gardener.cloud/critical-component=true</code> label in their metadata and in their Pod template, the <code>Node</code> controller waits for corresponding daemon Pods to be scheduled and to get ready before removing the taint.</p><p>Additionally, the <code>Node</code> controller checks for the readiness of <code>csi-driver-node</code> components if a respective Pod indicates that it uses such a driver.
This is achieved through a well-defined annotation prefix (<code>node.gardener.cloud/wait-for-csi-node-</code>).
For example, the <code>csi-driver-node</code> Pod for Openstack Cinder is annotated with <code>node.gardener.cloud/wait-for-csi-node-cinder=cinder.csi.openstack.org</code>.
A key prefix is used instead of a &ldquo;regular&rdquo; annotation to allow for multiple CSI drivers being registered by one <code>csi-driver-node</code> Pod.
The annotation key&rsquo;s suffix can be chosen arbitrarily (in this case <code>cinder</code>) and the annotation value needs to match the actual driver name as specified in the <code>CSINode</code> object.
The <code>Node</code> controller will verify that the used driver is properly registered in this object before removing the <code>node.gardener.cloud/critical-components-not-ready</code> taint.
Note that the <code>csi-driver-node</code> Pod still needs to be labelled and tolerate the taint as described above to be considered in this additional check.</p><h2 id=marking-node-critical-components>Marking Node-Critical Components</h2><p>To make use of this feature, node-critical DaemonSets and Pods need to:</p><ul><li>Tolerate the <code>node.gardener.cloud/critical-components-not-ready</code> <code>NoSchedule</code> taint.</li><li>Be labelled with <code>node.gardener.cloud/critical-component=true</code>.</li><li>Be placed in the <code>kube-system</code> namespace.</li></ul><p><code>csi-driver-node</code> Pods additionally need to:</p><ul><li>Be annotated with <code>node.gardener.cloud/wait-for-csi-node-&lt;name>=&lt;full-driver-name></code>.
It&rsquo;s required that these Pods fulfill the above criteria (label and toleration) as well.</li></ul><p>Gardener already marks components like kube-proxy, apiserver-proxy and node-local-dns as node-critical.
Provider extensions mark components like csi-driver-node as node-critical and add the <code>wait-for-csi-node</code> annotation.
Network extensions mark components responsible for setting up CNI on worker Nodes (e.g., <code>calico-node</code>) as node-critical.
If shoot owners manage any additional node-critical components, they can make use of this feature as well.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-38e852364e9682d463dc2199d8178630>7 - Taints and Tolerations for Seeds and Shoots</h1><h1 id=taints-and-tolerations-for-seeds-and-shoots>Taints and Tolerations for <code>Seed</code>s and <code>Shoot</code>s</h1><p>Similar to <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/>taints and tolerations</a> for <code>Node</code>s and <code>Pod</code>s in Kubernetes, the <code>Seed</code> resource supports specifying taints (<code>.spec.taints</code>, see <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml#L48-L55>this example</a>) while the <code>Shoot</code> resource supports specifying tolerations (<code>.spec.tolerations</code>, see <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml#L268-L269>this example</a>).
The feature is used to control scheduling to seeds as well as decisions whether a shoot can use a certain seed.</p><p>Compared to Kubernetes, Gardener&rsquo;s taints and tolerations are very much down-stripped right now and have some behavioral differences.
Please read the following explanations carefully if you plan to use them.</p><h2 id=scheduling>Scheduling</h2><p>When scheduling a new shoot, the gardener-scheduler will filter all seed candidates whose taints are not tolerated by the shoot.
As Gardener&rsquo;s taints/tolerations don&rsquo;t support <code>effect</code>s yet, you can compare this behaviour with using a <code>NoSchedule</code> effect taint in Kubernetes.</p><p>Be reminded that taints/tolerations are no means to define any affinity or selection for seeds - please use <code>.spec.seedSelector</code> in the <code>Shoot</code> to state such desires.</p><p>⚠️ Please note that - unlike how it&rsquo;s implemented in Kubernetes - a certain seed cluster <strong>may</strong> only be used when the shoot tolerates <strong>all</strong> the seed&rsquo;s taints.
This means that specifying <code>.spec.seedName</code> for a seed whose taints are not tolerated will make the gardener-apiserver reject the request.</p><p>Consequently, the taints/tolerations feature can be used as means to restrict usage of certain seeds.</p><h2 id=toleration-defaults-and-whitelist>Toleration Defaults and Whitelist</h2><p>The <code>Project</code> resource features a <code>.spec.tolerations</code> object that may carry <code>defaults</code> and a <code>whitelist</code> (see <a href=https://github.com/gardener/gardener/blob/master/example/05-project-dev.yaml#L33-L37>this example</a>).
The corresponding <code>ShootTolerationRestriction</code> admission plugin (cf. Kubernetes&rsquo; <code>PodTolerationRestriction</code> admission plugin) is responsible for evaluating these settings during creation/update of <code>Shoot</code>s.</p><h3 id=whitelist>Whitelist</h3><p>If a shoot gets created or updated with tolerations, then it is validated that only those tolerations may be used that were added to either a) the <code>Project</code>&rsquo;s <code>.spec.tolerations.whitelist</code>, or b) to the global whitelist in the <code>ShootTolerationRestriction</code>&rsquo;s admission config (see <a href=https://github.com/gardener/gardener/blob/master/example/20-admissionconfig.yaml#L7-L14>this example</a>).</p><p>⚠️ Please note that the tolerations whitelist of <code>Project</code>s can only be changed if the user trying to change it is bound to the <code>modify-spec-tolerations-whitelist</code> custom RBAC role, e.g., via the following <code>ClusterRole</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span style=display:flex><span>kind: ClusterRole
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: full-project-modification-access
</span></span><span style=display:flex><span>rules:
</span></span><span style=display:flex><span>- apiGroups:
</span></span><span style=display:flex><span>  - core.gardener.cloud
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - projects
</span></span><span style=display:flex><span>  verbs:
</span></span><span style=display:flex><span>  - create
</span></span><span style=display:flex><span>  - patch
</span></span><span style=display:flex><span>  - update
</span></span><span style=display:flex><span>  - modify-spec-tolerations-whitelist
</span></span><span style=display:flex><span>  - delete
</span></span></code></pre></div><h3 id=defaults>Defaults</h3><p>If a shoot gets created, then the default tolerations specified in both the <code>Project</code>&rsquo;s <code>.spec.tolerations.defaults</code> and the global default list in the <code>ShootTolerationRestriction</code> admission plugin&rsquo;s configuration will be added to the <code>.spec.tolerations</code> of the <code>Shoot</code> (unless it already specifies a certain key).</p></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2023 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid@8.13.4/dist/mermaid.min.js integrity="sha512-JERecFUBbsm75UpkVheAuDOE8NdHjQBrPACfEQYPwvPG+fjgCpHAz1Jw2ci9EXmd3DdfiWth3O3CQvcfEg8gsA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.11dbee029dba1a98021fb7be4d7405a7392afb38ff5640a21ff4f4c4c5057b2f.js integrity="sha256-EdvuAp26GpgCH7e+TXQFpzkq+zj/VkCiH/T0xMUFey8=" crossorigin=anonymous></script></body></html>