<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://gardener.cloud/docs/extensions/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/extensions/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>List of Extensions | Gardener</title>
<meta name=description content="The infrastructure, networking, OS and other extension components for Gardener"><meta property="og:url" content="https://gardener.cloud/docs/extensions/"><meta property="og:site_name" content="Gardener"><meta property="og:title" content="List of Extensions"><meta property="og:description" content="The infrastructure, networking, OS and other extension components for Gardener"><meta property="og:locale" content="en_US"><meta property="og:type" content="website"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="List of Extensions"><meta itemprop=description content="The infrastructure, networking, OS and other extension components for Gardener"><meta itemprop=datePublished content="2023-07-20T00:00:00+00:00"><meta itemprop=dateModified content="2023-07-20T00:00:00+00:00"><meta itemprop=image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="List of Extensions"><meta name=twitter:description content="The infrastructure, networking, OS and other extension components for Gardener"><link rel=preload href=/scss/main.min.9be7e3558835315265c1fbaf504c28f9b719c045b5bed7bcc6a4c53d2d69d2fb.css as=style integrity="sha256-m+fjVYg1MVJlwfuvUEwo+bcZwEW1vte8xqTFPS1p0vs=" crossorigin=anonymous><link href=/scss/main.min.9be7e3558835315265c1fbaf504c28f9b719c045b5bed7bcc6a4c53d2d69d2fb.css rel=stylesheet integrity="sha256-m+fjVYg1MVJlwfuvUEwo+bcZwEW1vte8xqTFPS1p0vs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><style>.nav-link:hover{text-decoration:none}.ml-md-auto{margin-left:auto!important}.td-search__icon{color:#fff!important}.td-search__input.form-control::placeholder{color:#fff;border:1px;border-radius:20px}.td-search__input.form-control{border:1px;border-radius:20px}.td-search__input{max-width:90%}.td-search:not(:focus-within){color:#fff!important}</style><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://demo.gardener.cloud target=_blank><span>Demo</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><div class=dropdown><a href=/docs class=nav-link>Documentation</a><div class=dropdown-content><a class=taxonomy-term href=/docs>Users</a>
<a class=taxonomy-term href=/docs>Operators</a>
<a class=taxonomy-term href=/docs>Developers</a>
<a class=taxonomy-term href=/docs>All</a></div></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.c0bbc390d2b062e9ce30ea7ce1c7b3a9.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/extensions/>Return to the regular view of this page</a>.</p></div><h1 class=title>List of Extensions</h1><div class=lead>The infrastructure, networking, OS and other extension components for Gardener</div><div class=content></div></div><div class=td-content><h1 id=pg-55e13a93740d6c3c02354485eaf37722>1 - Infrastructure Extensions</h1><div class=lead>Gardener extension controllers for the different infrastructures</div></div><div class=td-content><h1 id=pg-936f45ed7bca2e441d2b1f9f2ad32c57>1.1 - Provider Alicloud</h1><div class=lead>Gardener extension controller for the Alibaba cloud provider</div><h1 id=gardener-extension-for-alicloud-providerhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Alicloud provider</a><a class=td-heading-self-link href=#gardener-extension-for-alicloud-providerhttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-provider-alicloud><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-provider-alicloud alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-provider-alicloud-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-provider-alicloud-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-provider-alicloud><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-provider-alicloud alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the Alicloud provider.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-provider-alicloud/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=supported-kubernetes-versions>Supported Kubernetes versions<a class=td-heading-self-link href=#supported-kubernetes-versions aria-label="Heading self-link"></a></h2><p>This extension controller supports the following Kubernetes versions:</p><table><thead><tr><th>Version</th><th>Support</th><th>Conformance test results</th></tr></thead><tbody><tr><td>Kubernetes 1.32</td><td>1.32.0+</td><td>N/A</td></tr><tr><td>Kubernetes 1.31</td><td>1.31.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.31%20Alibaba%20Cloud><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.31%20Alibaba%20Cloud/tests_status?style=svg" alt="Gardener v1.31 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.30</td><td>1.30.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.30%20Alibaba%20Cloud><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.30%20Alibaba%20Cloud/tests_status?style=svg" alt="Gardener v1.30 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.29</td><td>1.29.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.29%20Alibaba%20Cloud><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.29%20Alibaba%20Cloud/tests_status?style=svg" alt="Gardener v1.29 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.28</td><td>1.28.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.28%20Alibaba%20Cloud><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.28%20Alibaba%20Cloud/tests_status?style=svg" alt="Gardener v1.28 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.27</td><td>1.27.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.27%20Alibaba%20Cloud><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.27%20Alibaba%20Cloud/tests_status?style=svg" alt="Gardener v1.27 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.26</td><td>1.26.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.26%20Alibaba%20Cloud><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.26%20Alibaba%20Cloud/tests_status?style=svg" alt="Gardener v1.26 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.25</td><td>1.25.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.25%20Alibaba%20Cloud><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.25%20Alibaba%20Cloud/tests_status?style=svg" alt="Gardener v1.25 Conformance Tests"></a></td></tr></tbody></table><p>Please take a look <a href=/docs/gardener/shoot-operations/supported_k8s_versions/>here</a> to see which versions are supported by Gardener in general.</p><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>.</p><p>Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-provider-alicloud/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/04-new-core-gardener-cloud-apis.md>GEP-4 (New <code>core.gardener.cloud/v1beta1</code> API)</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4e551ed938a8801ec37062e140472bde>1.1.1 - Tutorials</h1></div><div class=td-content><h1 id=pg-f56d1ea5f743bb82423b209a4b67be4c>1.1.1.1 - Create a Kubernetes Cluster on Alibaba Cloud with Gardener</h1><h3 id=overview>Overview<a class=td-heading-self-link href=#overview aria-label="Heading self-link"></a></h3><p>Gardener allows you to create a Kubernetes cluster on different infrastructure providers. This tutorial will guide you through the process of creating a cluster on Alibaba Cloud.</p><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><ul><li>You have created an <a href=https://www.alibabacloud.com>Alibaba Cloud account</a>.</li><li>You have access to the Gardener dashboard and have permissions to create projects.</li></ul><h3 id=steps>Steps<a class=td-heading-self-link href=#steps aria-label="Heading self-link"></a></h3><ol><li><p>Go to the Gardener dashboard and create a project.</p><img src=/__resources/new-gardener-project_a2095b.png><blockquote><p>To be able to add shoot clusters to this project, you must first create a technical user on Alibaba Cloud with sufficient permissions.</p></blockquote></li><li><p>Choose <em>Secrets</em>, then the plus icon <img src=/__resources/plus-icon_99aabe.png> and select <em>AliCloud</em>.</p><img src=/__resources/alicloud-create-secret_fe594e.png></li><li><p>To copy the policy for Alibaba Cloud from the Gardener dashboard, click on the help icon <img src=/__resources/help-icon_57882f.png> for Alibaba Cloud secrets, and choose copy <img src=/__resources/copy-icon_276abc.png>.</p><img src=/__resources/alicloud-copy-policy_270ed2.png></li><li><p>Create a custom policy in Alibaba Cloud:</p><ol><li><p>Log on to your Alibaba account and choose <em>RAM</em> > <em>Permissions</em> > <em>Policies</em>.</p><img src=/__resources/alicloud-create-policy_c01478.png></li><li><p>Enter the name of your policy.</p></li><li><p>Select <code>Script</code>.</p></li><li><p>Paste the policy that you copied from the Gardener dashboard to this custom policy.</p></li><li><p>Choose <em>OK</em>.</p><img src=/__resources/alicloud-paste-policy_2c06ea.png></li></ol></li><li><p>In the Alibaba Cloud console, create a new technical user:</p><ol><li><p>Choose <em>RAM</em> > <em>Users</em>.</p></li><li><p>Choose <em>Create User</em>.</p><img src=/__resources/alicloud-create-user_1bcd01.png></li><li><p>Enter a logon and display name for your user.</p></li><li><p>Select <em>Open API Access</em>.</p></li><li><p>Choose <em>OK</em>.</p><img src=/__resources/alicloud-input-user_a2701c.png></li></ol><blockquote><p>After the user is created, <code>AccessKeyId</code> and <code>AccessKeySecret</code> are generated and displayed. Remember to save them. The <code>AccessKey</code> is used later to create secrets for Gardener.</p></blockquote><img src=/__resources/alicloud-user-created_e5639c.png></li><li><p>Assign the policy you created to the technical user:</p><ol><li><p>Choose <em>RAM</em> > <em>Permissions</em> > <em>Grants</em>.</p></li><li><p>Choose <em>Grant Permission</em>.</p><img src=/__resources/alicloud-grant-permission_e7c523.png></li><li><p>Select <em>Alibaba Cloud Account</em>.</p></li><li><p>Assign the policy you’ve created before to the technical user.</p><img src=/__resources/alicloud-assign-policy_8f5061.png></li></ol></li><li><p>Create your secret.</p><ol><li>Type the name of your secret.</li><li>Copy and paste the <code>Access Key ID</code> and <code>Secret Access Key</code> you saved when you created the technical user on Alibaba Cloud.</li><li>Choose <em>Add secret</em>.
<img src=/__resources/alicloud-create-secret-1_a0435c.png></li></ol><blockquote><p>After completing these steps, you should see your newly created secret in the <em>Infrastructure Secrets</em> section.</p></blockquote><img src=/__resources/alicloud-create-secret-2_5a025a.png></li><li><p>To create a new cluster, choose <em>Clusters</em> and then the plus sign in the upper right corner.</p><img src=/__resources/alicloud-new-cluster_5acfe8.png></li><li><p>In the <em>Create Cluster</em> section:</p><ol><li><p>Select <em>AliCloud</em> in the <em>Infrastructure</em> tab.</p></li><li><p>Type the name of your cluster in the <em>Cluster Details</em> tab.</p></li><li><p>Choose the secret you created before in the <em>Infrastructure Details</em> tab.</p></li><li><p>Choose <em>Create</em>.</p><img src=/__resources/alicloud-create-cluster_1acc19.png></li></ol></li><li><p>Wait for your cluster to get created.</p><img src=/__resources/alicloud-processing-cluster_e882c1.png></li></ol><h2 id=result>Result<a class=td-heading-self-link href=#result aria-label="Heading self-link"></a></h2><p>After completing the steps in this tutorial, you will be able to see and download the kubeconfig of your cluster. With it you can create shoot clusters on Alibaba Cloud.
<img src=/__resources/alicloud-kubeconfig_37fa38.png></p><blockquote><p>The size of persistent volumes in your shoot cluster must at least be 20 GiB large. If you choose smaller sizes in your Kubernetes PV definition, the allocation of cloud disk space on Alibaba Cloud fails.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-72073e0eaa6137b600c6b1d53aaa34b9>1.1.2 - Deployment</h1><h1 id=deployment-of-the-alicloud-provider-extension>Deployment of the AliCloud provider extension<a class=td-heading-self-link href=#deployment-of-the-alicloud-provider-extension aria-label="Heading self-link"></a></h1><p><strong>Disclaimer:</strong> This document is NOT a step by step installation guide for the AliCloud provider extension and only contains some configuration specifics regarding the installation of different components via the helm charts residing in the AliCloud provider extension <a href=https://github.com/gardener/gardener-extension-provider-alicloud>repository</a>.</p><h2 id=gardener-extension-admission-alicloud>gardener-extension-admission-alicloud<a class=td-heading-self-link href=#gardener-extension-admission-alicloud aria-label="Heading self-link"></a></h2><h3 id=authentication-against-the-garden-cluster>Authentication against the Garden cluster<a class=td-heading-self-link href=#authentication-against-the-garden-cluster aria-label="Heading self-link"></a></h3><p>There are several authentication possibilities depending on whether or not <a href=https://github.com/gardener/garden-setup#concept-the-virtual-cluster>the concept of <em>Virtual Garden</em></a> is used.</p><h4 id=virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster><em>Virtual Garden</em> is not used, i.e., the <code>runtime</code> Garden cluster is also the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster aria-label="Heading self-link"></a></h4><p><strong>Automounted Service Account Token</strong>
The easiest way to deploy the <code>gardener-extension-admission-alicloud</code> component will be to not provide <code>kubeconfig</code> at all. This way in-cluster configuration and an automounted service account token will be used. The drawback of this approach is that the automounted token will not be automatically rotated.</p><p>This will allow for automatic rotation of the service account token by the <code>kubelet</code>. The configuration can be achieved by setting both <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.kubeconfig</code> in the respective chart&rsquo;s <code>values.yaml</code> file.</p><h4 id=virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster><em>Virtual Garden</em> is used, i.e., the <code>runtime</code> Garden cluster is different from the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster aria-label="Heading self-link"></a></h4><p><strong>Service Account</strong>
The easiest way to setup the authentication will be to create a service account and the respective roles will be bound to this service account in the <code>target</code> cluster. Then use the generated service account token and craft a <code>kubeconfig</code> which will be used by the workload in the <code>runtime</code> cluster. This approach does not provide a solution for the rotation of the service account token. However, this setup can be achieved by setting <code>.Values.global.virtualGarden.enabled: true</code> and following these steps:</p><ol><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Get the service account token and craft the <code>kubeconfig</code>.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><p><strong>Client Certificate</strong>
Another solution will be to bind the roles in the <code>target</code> cluster to a <code>User</code> subject instead of a service account and use a client certificate for authentication. This approach does not provide a solution for the client certificate rotation. However, this setup can be achieved by setting both <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>, then following these steps:</p><ol><li>Generate a client certificate for the <code>target</code> cluster for the respective user.</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Craft a <code>kubeconfig</code> using the already generated client certificate.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-32bc5a106edddf7757a5b2ef31b5ba5e>1.1.3 - Local Setup</h1><h3 id=admission-alicloud>admission-alicloud<a class=td-heading-self-link href=#admission-alicloud aria-label="Heading self-link"></a></h3><p><code>admission-alicloud</code> is an admission webhook server which is responsible for the validation of the cloud provider (Alicloud in this case) specific fields and resources. The Gardener API server is cloud provider agnostic and it wouldn&rsquo;t be able to perform similar validation.</p><p>Follow the steps below to run the admission webhook server locally.</p><ol><li><p>Start the Gardener API server.</p><p>For details, check the Gardener <a href=/docs/gardener/local_setup/>local setup</a>.</p></li><li><p>Start the webhook server</p><p>Make sure that the <code>KUBECONFIG</code> environment variable is pointing to the local garden cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make start-admission
</span></span></code></pre></div></li><li><p>Setup the <code>ValidatingWebhookConfiguration</code>.</p><p><code>hack/dev-setup-admission-alicloud.sh</code> will configure the webhook Service which will allow the kube-apiserver of your local cluster to reach the webhook server. It will also apply the <code>ValidatingWebhookConfiguration</code> manifest.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./hack/dev-setup-admission-alicloud.sh
</span></span></code></pre></div></li></ol><p>You are now ready to experiment with the <code>admission-alicloud</code> webhook server locally.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5d077509bcc8f24bf91fd4b88929c2ff>1.1.4 - Operations</h1><h1 id=using-the-alicloud-provider-extension-with-gardener-as-operator>Using the Alicloud provider extension with Gardener as operator<a class=td-heading-self-link href=#using-the-alicloud-provider-extension-with-gardener-as-operator aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/30-cloudprofile.yaml><code>core.gardener.cloud/v1beta1.CloudProfile</code> resource</a> declares a <code>providerConfig</code> field that is meant to contain provider-specific configuration.
The <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml><code>core.gardener.cloud/v1beta1.Seed</code> resource</a> is structured similarly.
Additionally, it allows configuring settings for the backups of the main etcds&rsquo; data of shoot clusters control planes running in this seed cluster.</p><p>This document explains the necessary configuration for this provider extension. In addition, this document also describes how to enable the use of customized machine images for Alicloud.</p><h2 id=cloudprofile-resource><code>CloudProfile</code> resource<a class=td-heading-self-link href=#cloudprofile-resource aria-label="Heading self-link"></a></h2><p>This section describes, how the configuration for <code>CloudProfile</code> looks like for Alicloud by providing an example <code>CloudProfile</code> manifest with minimal configuration that can be used to allow the creation of Alicloud shoot clusters.</p><h3 id=cloudprofileconfig><code>CloudProfileConfig</code><a class=td-heading-self-link href=#cloudprofileconfig aria-label="Heading self-link"></a></h3><p>The cloud profile configuration contains information about the real machine image IDs in the Alicloud environment (AMIs).
You have to map every version that you specify in <code>.spec.machineImages[].versions</code> here such that the Alicloud extension knows the AMI for every version you want to offer.</p><p>An example <code>CloudProfileConfig</code> for the Alicloud extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: alicloud.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: CloudProfileConfig
</span></span><span style=display:flex><span>machineImages:
</span></span><span style=display:flex><span>- name: coreos
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>  - version: 2023.4.0
</span></span><span style=display:flex><span>    regions:
</span></span><span style=display:flex><span>    - name: eu-central-1
</span></span><span style=display:flex><span>      id: coreos_2023_4_0_64_30G_alibase_20190319.vhd
</span></span></code></pre></div><h3 id=example-cloudprofile-manifest>Example <code>CloudProfile</code> manifest<a class=td-heading-self-link href=#example-cloudprofile-manifest aria-label="Heading self-link"></a></h3><p>Please find below an example <code>CloudProfile</code> manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: CloudProfile
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: alicloud
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: alicloud
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 1.27.3
</span></span><span style=display:flex><span>    - version: 1.26.8
</span></span><span style=display:flex><span>      expirationDate: <span style=color:#a31515>&#34;2022-10-31T23:59:59Z&#34;</span>
</span></span><span style=display:flex><span>  machineImages:
</span></span><span style=display:flex><span>  - name: coreos
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 2023.4.0
</span></span><span style=display:flex><span>  machineTypes:
</span></span><span style=display:flex><span>  - name: ecs.sn2ne.large
</span></span><span style=display:flex><span>    cpu: <span style=color:#a31515>&#34;2&#34;</span>
</span></span><span style=display:flex><span>    gpu: <span style=color:#a31515>&#34;0&#34;</span>
</span></span><span style=display:flex><span>    memory: 8Gi
</span></span><span style=display:flex><span>  volumeTypes:
</span></span><span style=display:flex><span>  - name: cloud_efficiency
</span></span><span style=display:flex><span>    class: standard
</span></span><span style=display:flex><span>  - name: cloud_essd
</span></span><span style=display:flex><span>    class: premium
</span></span><span style=display:flex><span>  regions:
</span></span><span style=display:flex><span>  - name: eu-central-1
</span></span><span style=display:flex><span>    zones:
</span></span><span style=display:flex><span>    - name: eu-central-1a
</span></span><span style=display:flex><span>    - name: eu-central-1b
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: alicloud.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: CloudProfileConfig
</span></span><span style=display:flex><span>    machineImages:
</span></span><span style=display:flex><span>    - name: coreos
</span></span><span style=display:flex><span>      versions:
</span></span><span style=display:flex><span>      - version: 2023.4.0
</span></span><span style=display:flex><span>        regions:
</span></span><span style=display:flex><span>        - name: eu-central-1
</span></span><span style=display:flex><span>          id: coreos_2023_4_0_64_30G_alibase_20190319.vhd
</span></span></code></pre></div><h2 id=enable-customized-machine-images-for-the-alicloud-extension>Enable customized machine images for the Alicloud extension<a class=td-heading-self-link href=#enable-customized-machine-images-for-the-alicloud-extension aria-label="Heading self-link"></a></h2><p>Customized machine images can be created for an Alicloud account and shared with other Alicloud accounts.
The same customized machine image has different image ID in different regions on Alicloud.
If you need to enable <code>encrypted system disk</code>, you must provide customized machine images.
Administrators/Operators need to explicitly declare them per imageID per region as below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>machineImages:
</span></span><span style=display:flex><span>- name: customized_coreos
</span></span><span style=display:flex><span>  regions:
</span></span><span style=display:flex><span>  - imageID: &lt;image_id_in_eu_central_1&gt;
</span></span><span style=display:flex><span>    region: eu-central-1
</span></span><span style=display:flex><span>  - imageID: &lt;image_id_in_cn_shanghai&gt;
</span></span><span style=display:flex><span>    region: cn-shanghai
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  version: 2191.4.1
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>End-users have to have the permission to use the customized image from its creator Alicloud account. To enable end-users to use customized images, the images are shared from Alicloud account of Seed operator with end-users&rsquo; Alicloud accounts. Administrators/Operators need to explicitly provide Seed operator&rsquo;s Alicloud account access credentials (base64 encoded) as below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>machineImageOwnerSecret:
</span></span><span style=display:flex><span>  name: machine-image-owner
</span></span><span style=display:flex><span>  accessKeyID: &lt;base64_encoded_access_key_id&gt;
</span></span><span style=display:flex><span>  accessKeySecret: &lt;base64_encoded_access_key_secret&gt;
</span></span></code></pre></div><p>As a result, a Secret named <code>machine-image-owner</code> by default will be created in namespace of Alicloud provider extension.</p><p>Operators should also maintain custom image IDs which are to be shared with end-users as below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>toBeSharedImageIDs:
</span></span><span style=display:flex><span>- &lt;image_id_1&gt;
</span></span><span style=display:flex><span>- &lt;image_id_2&gt;
</span></span><span style=display:flex><span>- &lt;image_id_3&gt;
</span></span></code></pre></div><h3 id=example-controllerdeployment-manifest-for-enabling-customized-machine-images>Example <code>ControllerDeployment</code> manifest for enabling customized machine images<a class=td-heading-self-link href=#example-controllerdeployment-manifest-for-enabling-customized-machine-images aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerDeployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-provider-alicloud
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: helm
</span></span><span style=display:flex><span>   providerConfig:
</span></span><span style=display:flex><span>    chart: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>      H4sIFAAAAAAA/yk...</span>      
</span></span><span style=display:flex><span>    values:
</span></span><span style=display:flex><span>      config:
</span></span><span style=display:flex><span>        machineImageOwnerSecret:
</span></span><span style=display:flex><span>          accessKeyID: &lt;base64_encoded_access_key_id&gt;
</span></span><span style=display:flex><span>          accessKeySecret: &lt;base64_encoded_access_key_secret&gt;
</span></span><span style=display:flex><span>        toBeSharedImageIDs:
</span></span><span style=display:flex><span>        - &lt;image_id_1&gt;
</span></span><span style=display:flex><span>        - &lt;image_id_2&gt;
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>        machineImages:
</span></span><span style=display:flex><span>        - name: customized_coreos
</span></span><span style=display:flex><span>          regions:
</span></span><span style=display:flex><span>          - imageID: &lt;image_id_in_eu_central_1&gt;
</span></span><span style=display:flex><span>            region: eu-central-1
</span></span><span style=display:flex><span>          - imageID: &lt;image_id_in_cn_shanghai&gt;
</span></span><span style=display:flex><span>            region: cn-shanghai
</span></span><span style=display:flex><span>          ...
</span></span><span style=display:flex><span>          version: 2191.4.1
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>        csi:
</span></span><span style=display:flex><span>          enableADController: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      resources:
</span></span><span style=display:flex><span>        limits:
</span></span><span style=display:flex><span>          cpu: 500m
</span></span><span style=display:flex><span>          memory: 1Gi
</span></span><span style=display:flex><span>        requests:
</span></span><span style=display:flex><span>          memory: 128Mi
</span></span></code></pre></div><h2 id=seed-resource><code>Seed</code> resource<a class=td-heading-self-link href=#seed-resource aria-label="Heading self-link"></a></h2><p>This provider extension does not support any provider configuration for the <code>Seed</code>&rsquo;s <code>.spec.provider.providerConfig</code> field.
However, it supports to managing of backup infrastructure, i.e., you can specify a configuration for the <code>.spec.backup</code> field.</p><h3 id=backup-configuration>Backup configuration<a class=td-heading-self-link href=#backup-configuration aria-label="Heading self-link"></a></h3><p>A Seed of type <code>alicloud</code> can be configured to perform backups for the main etcds&rsquo; of the shoot clusters control planes using Alicloud <a href=https://www.alibabacloud.com/help/doc-detail/31817.htm>Object Storage Service</a>.</p><p>The location/region where the backups will be stored defaults to the region of the Seed (<code>spec.provider.region</code>).</p><p>Please find below an example <code>Seed</code> manifest (partly) that configures backups using Alicloud Object Storage Service.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Seed
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-seed
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: alicloud
</span></span><span style=display:flex><span>    region: cn-shanghai
</span></span><span style=display:flex><span>  backup:
</span></span><span style=display:flex><span>    provider: alicloud
</span></span><span style=display:flex><span>    secretRef:
</span></span><span style=display:flex><span>      name: backup-credentials
</span></span><span style=display:flex><span>      namespace: garden
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>An example of the referenced secret containing the credentials for the Alicloud Object Storage Service can be found in the <a href=https://github.com/gardener/gardener-extension-provider-alicloud/blob/master/example/30-etcd-backup-secret.yaml>example folder</a>.</p><h4 id=permissions-for-alicloud-object-storage-service>Permissions for Alicloud Object Storage Service<a class=td-heading-self-link href=#permissions-for-alicloud-object-storage-service aria-label="Heading self-link"></a></h4><p>Please make sure the RAM user associated with the provided AccessKey pair has the following permission.</p><ul><li>AliyunOSSFullAccess</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2c26ab12b01f167d535f38d6ca62d6a9>1.1.5 - Usage</h1><h1 id=using-the-alicloud-provider-extension-with-gardener-as-end-user>Using the Alicloud provider extension with Gardener as end-user<a class=td-heading-self-link href=#using-the-alicloud-provider-extension-with-gardener-as-end-user aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a few fields that are meant to contain provider-specific configuration.</p><p>This document describes the configurable options for Alicloud and provides an example <code>Shoot</code> manifest with minimal configuration that can be used to create an Alicloud cluster (modulo the landscape-specific information like cloud profile names, secret binding names, etc.).</p><h2 id=alicloud-provider-credentials>Alicloud Provider Credentials<a class=td-heading-self-link href=#alicloud-provider-credentials aria-label="Heading self-link"></a></h2><p>In order for Gardener to create a Kubernetes cluster using Alicloud infrastructure components, a Shoot has to provide credentials with sufficient permissions to the desired Alicloud project.
Every shoot cluster references a <code>SecretBinding</code> or a <code>CredentialsBinding</code> which itself references a <code>Secret</code>, and this <code>Secret</code> contains the provider credentials of the Alicloud project.</p><p>This <code>Secret</code> must look as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: core-alicloud
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  accessKeyID: base64(access-key-id)
</span></span><span style=display:flex><span>  accessKeySecret: base64(access-key-secret)
</span></span></code></pre></div><p>The <code>SecretBinding</code>/<code>CredentialsBinding</code> is configurable in the <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml>Shoot cluster</a> with the field <code>secretBindingName</code>/<code>credentialsBindingName</code>.</p><p>The required credentials for the Alicloud project are an <a href=https://www.alibabacloud.com/help/doc-detail/29009.htm>AccessKey Pair</a> associated with a <a href=https://www.alibabacloud.com/help/doc-detail/28627.htm>Resource Access Management (RAM) User</a>.
A RAM user is a special account that can be used by services and applications to interact with Alicloud Cloud Platform APIs.
Applications can use AccessKey pair to authorize themselves to a set of APIs and perform actions within the permissions granted to the RAM user.</p><p>Make sure to <a href=https://www.alibabacloud.com/help/doc-detail/93720.htm>create a Resource Access Management User</a>, and <a href=https://partners-intl.aliyun.com/help/doc-detail/116401.htm>create an AccessKey Pair</a> that shall be used for the Shoot cluster.</p><h3 id=permissions>Permissions<a class=td-heading-self-link href=#permissions aria-label="Heading self-link"></a></h3><p>Please make sure the provided credentials have the correct privileges. You can use the following Alicloud RAM policy document and attach it to the RAM user backed by the credentials you provided.</p><details><summary>Click to expand the Alicloud RAM policy document!</summary><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    &#34;Statement&#34;: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            &#34;Action&#34;: [
</span></span><span style=display:flex><span>                <span style=color:#a31515>&#34;vpc:*&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            &#34;Resource&#34;: [
</span></span><span style=display:flex><span>                <span style=color:#a31515>&#34;*&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            &#34;Action&#34;: [
</span></span><span style=display:flex><span>                <span style=color:#a31515>&#34;ecs:*&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            &#34;Resource&#34;: [
</span></span><span style=display:flex><span>                <span style=color:#a31515>&#34;*&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            &#34;Action&#34;: [
</span></span><span style=display:flex><span>                <span style=color:#a31515>&#34;slb:*&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            &#34;Resource&#34;: [
</span></span><span style=display:flex><span>                <span style=color:#a31515>&#34;*&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            &#34;Action&#34;: [
</span></span><span style=display:flex><span>                <span style=color:#a31515>&#34;ram:GetRole&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a31515>&#34;ram:CreateRole&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a31515>&#34;ram:CreateServiceLinkedRole&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            &#34;Resource&#34;: [
</span></span><span style=display:flex><span>                <span style=color:#a31515>&#34;*&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            &#34;Action&#34;: [
</span></span><span style=display:flex><span>                <span style=color:#a31515>&#34;ros:*&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            &#34;Resource&#34;: [
</span></span><span style=display:flex><span>                <span style=color:#a31515>&#34;*&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    &#34;Version&#34;: <span style=color:#a31515>&#34;1&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details><h2 id=infrastructureconfig><code>InfrastructureConfig</code><a class=td-heading-self-link href=#infrastructureconfig aria-label="Heading self-link"></a></h2><p>The infrastructure configuration mainly describes how the network layout looks like in order to create the shoot worker nodes in a later step, thus, prepares everything relevant to create VMs, load balancers, volumes, etc.</p><p>An example <code>InfrastructureConfig</code> for the Alicloud extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: alicloud.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: InfrastructureConfig
</span></span><span style=display:flex><span>networks:
</span></span><span style=display:flex><span>  vpc: <span style=color:green># specify either &#39;id&#39; or &#39;cidr&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:green># id: my-vpc</span>
</span></span><span style=display:flex><span>    cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>  <span style=color:green># gardenerManagedNATGateway: true</span>
</span></span><span style=display:flex><span>  zones:
</span></span><span style=display:flex><span>  - name: eu-central-1a
</span></span><span style=display:flex><span>    workers: 10.250.1.0/24
</span></span><span style=display:flex><span>  <span style=color:green># natGateway:</span>
</span></span><span style=display:flex><span>    <span style=color:green># eipAllocationID: eip-ufxsdg122elmszcg</span>
</span></span></code></pre></div><p>The <code>networks.vpc</code> section describes whether you want to create the shoot cluster in an already existing VPC or whether to create a new one:</p><ul><li>If <code>networks.vpc.id</code> is given then you have to specify the VPC ID of the existing VPC that was created by other means (manually, other tooling, &mldr;).</li><li>If <code>networks.vpc.cidr</code> is given then you have to specify the VPC CIDR of a new VPC that will be created during shoot creation.
You can freely choose a private CIDR range.</li><li>Either <code>networks.vpc.id</code> or <code>networks.vpc.cidr</code> must be present, but not both at the same time.</li><li>When <code>networks.vpc.id</code> is present, in addition, you can also choose to set <code>networks.vpc.gardenerManagedNATGateway</code>. It is by default <code>false</code>. When it is set to <code>true</code>,
Gardener will create an Enhanced NATGateway in the VPC and associate it with a VSwitch created in the first zone in the <code>networks.zones</code>.</li><li>Please note that when <code>networks.vpc.id</code> is present, and <code>networks.vpc.gardenerManagedNATGateway</code> is <code>false</code> or not set, you have to <strong>manually</strong> create an Enhance NATGateway
and associate it with a VSwitch that you <strong>manually</strong> created. In this case, make sure the worker CIDRs in <code>networks.zones</code> do not overlap with the one you created.
If a NATGateway is created manually and a shoot is created in the same VPC with <code>networks.vpc.gardenerManagedNATGateway</code> set <code>true</code>, you need to manually adjust the route rule accordingly.
You may refer to <a href=https://www.alibabacloud.com/help/en/doc-detail/121139.html>here</a>.</li></ul><p>The <code>networks.zones</code> section describes which subnets you want to create in availability zones.
For every zone, the Alicloud extension creates one subnet:</p><ul><li>The <code>workers</code> subnet is used for all shoot worker nodes, i.e., VMs which later run your applications.</li></ul><p>For every subnet, you have to specify a CIDR range contained in the VPC CIDR specified above, or the VPC CIDR of your already existing VPC.
You can freely choose these CIDR and it is your responsibility to properly design the network layout to suit your needs.</p><p>If you want to use multiple availability zones then add a second, third, &mldr; entry to the <code>networks.zones[]</code> list and properly specify the AZ name in <code>networks.zones[].name</code>.</p><p>Apart from the VPC and the subnets the Alicloud extension will also create a NAT gateway (only if a new VPC is created), a key pair, elastic IPs, VSwitches, a SNAT table entry, and security groups.</p><p>By default, the Alicloud extension will create a corresponding Elastic IP that it attaches to this NAT gateway and which is used for egress traffic.
The <code>networks.zones[].natGateway.eipAllocationID</code> field allows you to specify the Elastic IP Allocation ID of an existing Elastic IP allocation in case you want to bring your own.
If provided, no new Elastic IP will be created and, instead, the Elastic IP specified by you will be used.</p><p>⚠️ If you change this field for an already existing infrastructure then it will disrupt egress traffic while Alicloud applies this change, because the NAT gateway must be recreated with the new Elastic IP association.
Also, please note that the existing Elastic IP will be permanently deleted if it was earlier created by the Alicloud extension.</p><h2 id=controlplaneconfig><code>ControlPlaneConfig</code><a class=td-heading-self-link href=#controlplaneconfig aria-label="Heading self-link"></a></h2><p>The control plane configuration mainly contains values for the Alicloud-specific control plane components.
Today, the Alicloud extension deploys the <code>cloud-controller-manager</code> and the CSI controllers.</p><p>An example <code>ControlPlaneConfig</code> for the Alicloud extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: alicloud.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: ControlPlaneConfig
</span></span><span style=display:flex><span>csi:
</span></span><span style=display:flex><span>  enableADController: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span><span style=color:green># cloudControllerManager:</span>
</span></span><span style=display:flex><span><span style=color:green>#   featureGates:</span>
</span></span><span style=display:flex><span><span style=color:green>#     SomeKubernetesFeature: true</span>
</span></span></code></pre></div><p>The <code>csi.enableADController</code> is used as the value of environment <a href=https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/cd0788a0a440926d504d8f8fb7f6e738fe96f3ae/pkg/disk/nodeserver.go#L80>DISK_AD_CONTROLLER</a>, which is used for AliCloud csi-disk-plugin. This field is optional. When a new shoot is creatd, this field is automatically set true. For an existing shoot created in previous versions, it remains unchanged. If there are persistent volumes created before year 2021, please be cautious to set this field <em>true</em> because they may fail to mount to nodes.</p><p>The <code>cloudControllerManager.featureGates</code> contains a map of explicitly enabled or disabled feature gates.
For production usage it&rsquo;s not recommend to use this field at all as you can enable alpha features or disable beta/stable features, potentially impacting the cluster stability.
If you don&rsquo;t want to configure anything for the <code>cloudControllerManager</code> simply omit the key in the YAML specification.</p><h2 id=workerconfig><code>WorkerConfig</code><a class=td-heading-self-link href=#workerconfig aria-label="Heading self-link"></a></h2><p>The Alicloud extension does not support a specific <code>WorkerConfig</code>. However, it supports additional data volumes (plus encryption) per machine.
By default (if not stated otherwise), all the disks are unencrypted.
For each data volume, you have to specify a name.
It also supports encrypted system disk.
However, only <a href="https://www.alibabacloud.com/help/doc-detail/172789.htm?spm=a2c63.l28256.b99.244.5da67453bNBrCt">Customized image</a> is currently supported to be used as a basic image for encrypted system disk.
Please be noted that the change of system disk encryption flag will cause reconciliation of a shoot, and it will result in nodes rolling update within the worker group.</p><p>The following YAML is a snippet of a <code>Shoot</code> resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: cpu-worker
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        type: cloud_efficiency
</span></span><span style=display:flex><span>        size: 20Gi
</span></span><span style=display:flex><span>        encrypted: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      dataVolumes:
</span></span><span style=display:flex><span>      - name: kubelet-dir
</span></span><span style=display:flex><span>        type: cloud_efficiency
</span></span><span style=display:flex><span>        size: 25Gi
</span></span><span style=display:flex><span>        encrypted: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=example-shoot-manifest-one-availability-zone>Example <code>Shoot</code> manifest (one availability zone)<a class=td-heading-self-link href=#example-shoot-manifest-one-availability-zone aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest for one availability zone:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-alicloud
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfile:
</span></span><span style=display:flex><span>    name: alicloud
</span></span><span style=display:flex><span>  region: eu-central-1
</span></span><span style=display:flex><span>  secretBindingName: core-alicloud
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: alicloud
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: alicloud.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vpc:
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>        zones:
</span></span><span style=display:flex><span>        - name: eu-central-1a
</span></span><span style=display:flex><span>          workers: 10.250.0.0/19
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: alicloud.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: ecs.sn2ne.large
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: cloud_efficiency
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - eu-central-1a
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.2
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=example-shoot-manifest-two-availability-zones>Example <code>Shoot</code> manifest (two availability zones)<a class=td-heading-self-link href=#example-shoot-manifest-two-availability-zones aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest for two availability zones:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-alicloud
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfile:
</span></span><span style=display:flex><span>    name: alicloud
</span></span><span style=display:flex><span>  region: eu-central-1
</span></span><span style=display:flex><span>  secretBindingName: core-alicloud
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: alicloud
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: alicloud.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vpc:
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>        zones:
</span></span><span style=display:flex><span>        - name: eu-central-1a
</span></span><span style=display:flex><span>          workers: 10.250.0.0/26
</span></span><span style=display:flex><span>        - name: eu-central-1b
</span></span><span style=display:flex><span>          workers: 10.250.0.64/26
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: alicloud.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: ecs.sn2ne.large
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 4
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: cloud_efficiency
</span></span><span style=display:flex><span>        <span style=color:green># NOTE: Below comment is for the case when encrypted field of an existing shoot is updated from false to true.</span>
</span></span><span style=display:flex><span>        <span style=color:green># It will cause affected nodes to be rolling updated. Users must trigger a MAINTAIN operation of the shoot.</span>
</span></span><span style=display:flex><span>        <span style=color:green># Otherwise, the shoot will fail to reconcile.</span>
</span></span><span style=display:flex><span>        <span style=color:green># You could do it either via Dashboard or annotating the shoot with gardener.cloud/operation=maintain</span>
</span></span><span style=display:flex><span>        encrypted: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - eu-central-1a
</span></span><span style=display:flex><span>      - eu-central-1b
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.2
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=kubernetes-versions-per-worker-pool>Kubernetes Versions per Worker Pool<a class=td-heading-self-link href=#kubernetes-versions-per-worker-pool aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>WorkerPoolKubernetesVersion</code> feature gate, i.e., having <a href=https://github.com/gardener/gardener/blob/8a9c88866ec5fce59b5acf57d4227eeeb73669d7/example/90-shoot.yaml#L69-L70>worker pools with overridden Kubernetes versions</a> since <code>gardener-extension-provider-alicloud@v1.33</code>.</p><h2 id=shoot-ca-certificate-and-serviceaccount-signing-key-rotation>Shoot CA Certificate and <code>ServiceAccount</code> Signing Key Rotation<a class=td-heading-self-link href=#shoot-ca-certificate-and-serviceaccount-signing-key-rotation aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>ShootCARotation</code> feature gate since <code>gardener-extension-provider-alicloud@v1.36</code> and <code>ShootSARotation</code> feature gate since <code>gardener-extension-provider-alicloud@v1.37</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2fdc592b220f6647eac2d46161fce5c7>1.2 - Provider AWS</h1><div class=lead>Gardener extension controller for the AWS cloud provider</div><h1 id=gardener-extension-for-aws-providerhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for AWS provider</a><a class=td-heading-self-link href=#gardener-extension-for-aws-providerhttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-provider-aws><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-provider-aws alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-provider-aws-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-provider-aws-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-provider-aws><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-provider-aws alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the AWS provider.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-provider-aws/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=supported-kubernetes-versions>Supported Kubernetes versions<a class=td-heading-self-link href=#supported-kubernetes-versions aria-label="Heading self-link"></a></h2><p>This extension controller supports the following Kubernetes versions:</p><table><thead><tr><th>Version</th><th>Support</th><th>Conformance test results</th></tr></thead><tbody><tr><td>Kubernetes 1.32</td><td>1.32.0+</td><td>N/A</td></tr><tr><td>Kubernetes 1.31</td><td>1.31.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.31%20AWS><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.31%20AWS/tests_status?style=svg" alt="Gardener v1.31 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.30</td><td>1.30.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.30%20AWS><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.30%20AWS/tests_status?style=svg" alt="Gardener v1.30 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.29</td><td>1.29.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.29%20AWS><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.29%20AWS/tests_status?style=svg" alt="Gardener v1.29 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.28</td><td>1.28.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.28%20AWS><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.28%20AWS/tests_status?style=svg" alt="Gardener v1.28 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.27</td><td>1.27.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.27%20AWS><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.27%20AWS/tests_status?style=svg" alt="Gardener v1.27 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.26</td><td>1.26.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.26%20AWS><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.26%20AWS/tests_status?style=svg" alt="Gardener v1.26 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.25</td><td>1.25.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.25%20AWS><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.25%20AWS/tests_status?style=svg" alt="Gardener v1.25 Conformance Tests"></a></td></tr></tbody></table><p>Please take a look <a href=/docs/gardener/shoot-operations/supported_k8s_versions/>here</a> to see which versions are supported by Gardener in general.</p><h2 id=compatibility>Compatibility<a class=td-heading-self-link href=#compatibility aria-label="Heading self-link"></a></h2><p>The following lists known compatibility issues of this extension controller with other Gardener components.</p><table><thead><tr><th>AWS Extension</th><th>Gardener</th><th>Action</th><th>Notes</th></tr></thead><tbody><tr><td><code>&lt;= v1.15.0</code></td><td><code>>v1.10.0</code></td><td>Please update the provider version to <code>> v1.15.0</code> or disable the feature gate <code>MountHostCADirectories</code> in the Gardenlet.</td><td>Applies if feature flag <code>MountHostCADirectories</code> in the Gardenlet is enabled. Shoots with CSI enabled (Kubernetes version >= 1.18) miss a mount to the directory <code>/etc/ssl</code> in the Shoot API Server. This can lead to not trusting external Root CAs when the API Server makes requests via webhooks or OIDC.</td></tr></tbody></table><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>.</p><p>Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-provider-aws/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/04-new-core-gardener-cloud-apis.md>GEP-4 (New <code>core.gardener.cloud/v1beta1</code> API)</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-979df175ce45dca2d78e2698ba76c8c2>1.2.1 - Tutorials</h1><h3 id=overview>Overview<a class=td-heading-self-link href=#overview aria-label="Heading self-link"></a></h3><p>Gardener allows you to create a Kubernetes cluster on different infrastructure providers. This tutorial will guide you through the process of creating a cluster on AWS.</p><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><ul><li>You have created an <a href=https://aws.amazon.com/>AWS account</a>.</li><li>You have access to the Gardener dashboard and have permissions to create projects.</li></ul><h3 id=steps>Steps<a class=td-heading-self-link href=#steps aria-label="Heading self-link"></a></h3><ol><li><p>Go to the Gardener dashboard and create a <em>Project</em>.</p><img src=/__resources/new-gardener-project_ad03bc.png></li><li><p>Choose <em>Secrets</em>, then the plus icon <img src=/__resources/plus-icon_3b1f20.png> and select <em>AWS</em>.</p><img src=/__resources/create-secret-aws_79dc1a.png></li><li><p>To copy the policy for AWS from the Gardener dashboard, click on the help icon <img src=/__resources/help-icon_01486c.png> for AWS secrets, and choose copy <img src=/__resources/copy-icon_0f5ab8.png>.</p><img src=/__resources/gardener-copy-policy_a52965.png></li><li><p><a href=https://console.aws.amazon.com/iam/home?#/policies>Create a new policy</a> in AWS:</p><ol><li><p>Choose <em>Create policy</em>.</p><img src=/__resources/amazon-create-policy_5ef114.png></li><li><p>Paste the policy that you copied from the Gardener dashboard to this custom policy.</p><img src=/__resources/amazon-create-policy-json_7d6327.png></li><li><p>Choose <em>Next</em> until you reach the Review section.</p></li><li><p>Fill in the name and description, then choose <em>Create policy</em>.</p><img src=/__resources/amazon-review-policy_6fba71.png></li></ol></li><li><p><a href="https://console.aws.amazon.com/iam/home?#/users$new?step=details">Create a new technical user</a> in AWS:</p><ol><li><p>Type in a username and select the access key credential type.</p><img src=/__resources/add-user_775731.png></li><li><p>Choose <em>Attach an existing policy</em>.</p></li><li><p>Select <em>GardenerAccess</em> from the policy list.</p></li><li><p>Choose <em>Next</em> until you reach the Review section.</p></li></ol><img src=/__resources/attach-policy_a6a81f.png>
<img src=/__resources/finish-user_a9e956.png><div class="alert alert-info" role=alert><h4 class=alert-heading>Note</h4>Note: After the user is created, <code>Access key ID</code> and <code>Secret access key</code> are generated and displayed. Remember to save them. The <code>Access key ID</code> is used later to create secrets for Gardener.</div><img src=/__resources/save-keys_f23816.png></li><li><p>On the Gardener dashboard, choose <em>Secrets</em> and then the plus sign <img src=/__resources/plus-icon_3b1f20.png>. Select <em>AWS</em> from the drop down menu to add a new AWS secret.</p></li><li><p>Create your secret.</p><ol><li>Type the name of your secret.</li><li>Copy and paste the <code>Access Key ID</code> and <code>Secret Access Key</code> you saved when you created the technical user on AWS.</li><li>Choose <em>Add secret</em>.
<img src=/__resources/add-aws-secret_ed47ad.png></li></ol><blockquote><p>After completing these steps, you should see your newly created secret in the <em>Infrastructure Secrets</em> section.</p></blockquote><img src=/__resources/secret-stored_a4c7f9.png></li><li><p>To create a new cluster, choose <em>Clusters</em> and then the plus sign in the upper right corner.</p><img src=/__resources/new-cluster_353d7b.png></li><li><p>In the <em>Create Cluster</em> section:</p><ol><li>Select <em>AWS</em> in the <em>Infrastructure</em> tab.</li><li>Type the name of your cluster in the <em>Cluster Details</em> tab.</li><li>Choose the secret you created before in the <em>Infrastructure Details</em> tab.</li><li>Choose <em>Create</em>.</li></ol><img src=/__resources/create-cluster_7a45a2.png></li><li><p>Wait for your cluster to get created.</p><img src=/__resources/processing-cluster_522005.png></li></ol><h3 id=result>Result<a class=td-heading-self-link href=#result aria-label="Heading self-link"></a></h3><p>After completing the steps in this tutorial, you will be able to see and download the kubeconfig of your cluster.</p><img src=/__resources/copy-kubeconfig_752d59.png></div><div class=td-content style=page-break-before:always><h1 id=pg-3df8b1939d1f45daa8220886832c9751>1.2.2 - Deployment</h1><h1 id=deployment-of-the-aws-provider-extension>Deployment of the AWS provider extension<a class=td-heading-self-link href=#deployment-of-the-aws-provider-extension aria-label="Heading self-link"></a></h1><p><strong>Disclaimer:</strong> This document is NOT a step by step installation guide for the AWS provider extension and only contains some configuration specifics regarding the installation of different components via the helm charts residing in the AWS provider extension <a href=https://github.com/gardener/gardener-extension-provider-aws>repository</a>.</p><h2 id=gardener-extension-admission-aws>gardener-extension-admission-aws<a class=td-heading-self-link href=#gardener-extension-admission-aws aria-label="Heading self-link"></a></h2><h3 id=authentication-against-the-garden-cluster>Authentication against the Garden cluster<a class=td-heading-self-link href=#authentication-against-the-garden-cluster aria-label="Heading self-link"></a></h3><p>There are several authentication possibilities depending on whether or not <a href=https://github.com/gardener/garden-setup#concept-the-virtual-cluster>the concept of <em>Virtual Garden</em></a> is used.</p><h4 id=virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster><em>Virtual Garden</em> is not used, i.e., the <code>runtime</code> Garden cluster is also the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster aria-label="Heading self-link"></a></h4><p><strong>Automounted Service Account Token</strong>
The easiest way to deploy the <code>gardener-extension-admission-aws</code> component will be to not provide <code>kubeconfig</code> at all. This way in-cluster configuration and an automounted service account token will be used. The drawback of this approach is that the automounted token will not be automatically rotated.</p><p><strong>Service Account Token Volume Projection</strong>
Another solution will be to use <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>Service Account Token Volume Projection</a> combined with a <code>kubeconfig</code> referencing a token file (see example below).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://default.kubernetes.svc.cluster.local
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: garden
</span></span><span style=display:flex><span>    user: garden
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>current-context: garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div><p>This will allow for automatic rotation of the service account token by the <code>kubelet</code>. The configuration can be achieved by setting both <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.kubeconfig</code> in the respective chart&rsquo;s <code>values.yaml</code> file.</p><h4 id=virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster><em>Virtual Garden</em> is used, i.e., the <code>runtime</code> Garden cluster is different from the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster aria-label="Heading self-link"></a></h4><p><strong>Service Account</strong>
The easiest way to setup the authentication will be to create a service account and the respective roles will be bound to this service account in the <code>target</code> cluster. Then use the generated service account token and craft a <code>kubeconfig</code> which will be used by the workload in the <code>runtime</code> cluster. This approach does not provide a solution for the rotation of the service account token. However, this setup can be achieved by setting <code>.Values.global.virtualGarden.enabled: true</code> and following these steps:</p><ol><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Get the service account token and craft the <code>kubeconfig</code>.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><p><strong>Client Certificate</strong>
Another solution will be to bind the roles in the <code>target</code> cluster to a <code>User</code> subject instead of a service account and use a client certificate for authentication. This approach does not provide a solution for the client certificate rotation. However, this setup can be achieved by setting both <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>, then following these steps:</p><ol><li>Generate a client certificate for the <code>target</code> cluster for the respective user.</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Craft a <code>kubeconfig</code> using the already generated client certificate.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><p><strong>Projected Service Account Token</strong>
This approach requires an already deployed and configured <a href=https://github.com/gardener/oidc-webhook-authenticator>oidc-webhook-authenticator</a> for the <code>target</code> cluster. Also the <code>runtime</code> cluster should be registered as a trusted identity provider in the <code>target</code> cluster. Then projected service accounts tokens from the <code>runtime</code> cluster can be used to authenticate against the <code>target</code> cluster. The needed steps are as follows:</p><ol><li>Deploy <a href=https://github.com/gardener/oidc-webhook-authenticator>OWA</a> and establish the needed trust.</li><li>Set <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>. <strong>Note:</strong> username value will depend on the trust configuration, e.g., <code>&lt;prefix>:system:serviceaccount:&lt;namespace>:&lt;serviceaccount></code></li><li>Set <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.serviceAccountTokenVolumeProjection.audience</code>. <strong>Note:</strong> audience value will depend on the trust configuration, e.g., <code>&lt;cliend-id-from-trust-config></code>.</li><li>Craft a kubeconfig (see example below).</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://virtual-garden.api
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: virtual-garden
</span></span><span style=display:flex><span>    user: virtual-garden
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>current-context: virtual-garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: virtual-garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-60ce03f807554a2877fd8358d47eefca>1.2.3 - Dual Stack Ingress</h1><h1 id=using-ipv4ipv6-dual-stack-ingress-in-an-ipv4-single-stack-cluster>Using IPv4/IPv6 (dual-stack) Ingress in an IPv4 single-stack cluster<a class=td-heading-self-link href=#using-ipv4ipv6-dual-stack-ingress-in-an-ipv4-single-stack-cluster aria-label="Heading self-link"></a></h1><h2 id=motivation>Motivation<a class=td-heading-self-link href=#motivation aria-label="Heading self-link"></a></h2><p>IPv6 adoption is continuously growing, already overtaking IPv4 in certain regions, e.g. India, or scenarios, e.g. mobile.
Even though most IPv6 installations deploy means to reach IPv4, it might still be beneficial to expose services
natively via IPv4 and IPv6 instead of just relying on IPv4.</p><h2 id=disadvantages-of-full-ipv4ipv6-dual-stack-deployments>Disadvantages of full IPv4/IPv6 (dual-stack) Deployments<a class=td-heading-self-link href=#disadvantages-of-full-ipv4ipv6-dual-stack-deployments aria-label="Heading self-link"></a></h2><p>Enabling full IPv4/IPv6 (dual-stack) support in a kubernetes cluster is a major endeavor. It requires a lot of changes
and restarts of all pods so that all pods get addresses for both IP families. A side-effect of dual-stack networking
is that failures may be hidden as network traffic may take the other protocol to reach the target. For this reason and
also due to reduced operational complexity, service teams might lean towards staying in a single-stack environment as
much as possible. Luckily, this is possible with Gardener and IPv4/IPv6 (dual-stack) ingress on AWS.</p><h2 id=simplifying-ipv4ipv6-dual-stack-ingress-with-protocol-translation-on-aws>Simplifying IPv4/IPv6 (dual-stack) Ingress with Protocol Translation on AWS<a class=td-heading-self-link href=#simplifying-ipv4ipv6-dual-stack-ingress-with-protocol-translation-on-aws aria-label="Heading self-link"></a></h2><p>Fortunately, the network load balancer on AWS supports automatic protocol translation, i.e. it can expose both IPv4 and
IPv6 endpoints while communicating with just one protocol to the backends. Under the hood, automatic protocol translation
takes place. Client IP address preservation can be achieved by using proxy protocol.</p><p>This approach enables users to expose IPv4 workload to IPv6-only clients without having to change the workload/service.
Without requiring invasive changes, it allows a fairly simple first step into the IPv6 world for services just requiring
ingress (incoming) communication.</p><h2 id=necessary-shoot-cluster-configuration-changes-for-ipv4ipv6-dual-stack-ingress>Necessary Shoot Cluster Configuration Changes for IPv4/IPv6 (dual-stack) Ingress<a class=td-heading-self-link href=#necessary-shoot-cluster-configuration-changes-for-ipv4ipv6-dual-stack-ingress aria-label="Heading self-link"></a></h2><p>To be able to utilize IPv4/IPv6 (dual-stack) Ingress in an IPv4 shoot cluster, the cluster needs to meet two preconditions:</p><ol><li><code>dualStack.enabled</code> needs to be set to <code>true</code> to configure VPC/subnet for IPv6 and add a routing rule for IPv6.
(This does not add IPv6 addresses to kubernetes nodes.)</li><li><code>loadBalancerController.enabled</code> needs to be set to <code>true</code> as well to use the load balancer controller, which supports
dual-stack ingress.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: aws
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      dualStack:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>      loadBalancerController:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>When <code>infrastructureConfig.networks.vpc.id</code> is set to the ID of an existing VPC, please make sure that your VPC has an <a href=https://docs.aws.amazon.com/vpc/latest/userguide/modify-vpcs.html#vpc-associate-ipv6-cidr>Amazon-provided IPv6 CIDR block added</a>.</p><p>After adapting the shoot specification and reconciling the cluster, dual-stack load balancers can be created using
kubernetes services objects.</p><h2 id=creating-an-ipv4ipv6-dual-stack-ingress>Creating an IPv4/IPv6 (dual-stack) Ingress<a class=td-heading-self-link href=#creating-an-ipv4ipv6-dual-stack-ingress aria-label="Heading self-link"></a></h2><p>With the preconditions set, creating an IPv4/IPv6 load balancer is as easy as annotating a service with the correct
annotations:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    service.beta.kubernetes.io/aws-load-balancer-ip-address-type: dualstack
</span></span><span style=display:flex><span>    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
</span></span><span style=display:flex><span>    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: instance
</span></span><span style=display:flex><span>    service.beta.kubernetes.io/aws-load-balancer-type: external
</span></span><span style=display:flex><span>  name: ...
</span></span><span style=display:flex><span>  namespace: ...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  type: LoadBalancer
</span></span></code></pre></div><p>In case the client IP address should be preserved, the following annotation can be used to enable proxy protocol.
(The pod receiving the traffic needs to be configured for proxy protocol as well.)</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    service.beta.kubernetes.io/aws-load-balancer-proxy-protocol: <span style=color:#a31515>&#34;*&#34;</span>
</span></span></code></pre></div><p>Please note that changing an existing <code>Service</code> to dual-stack may cause the creation of a new load balancer without
deletion of the old AWS load balancer resource. While this helps in a seamless migration by not cutting existing
connections it may lead to wasted/forgotten resources. Therefore, the (manual) cleanup needs to be taken into account
when migrating an existing <code>Service</code> instance.</p><p>For more details see <a href=https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/guide/service/nlb/>AWS Load Balancer Documentation - Network Load Balancer</a>.</p><h2 id=dns-considerations-to-prevent-downtime-during-a-dual-stack-migration>DNS Considerations to Prevent Downtime During a Dual-Stack Migration<a class=td-heading-self-link href=#dns-considerations-to-prevent-downtime-during-a-dual-stack-migration aria-label="Heading self-link"></a></h2><p>In case the migration of an existing service is desired, please check if there are DNS entries directly linked to the
corresponding load balancer. The migrated load balancer will have a new domain name immediately, which will not be ready
in the beginning. Therefore, a direct migration of the domain name entries is not desired as it may cause a short
downtime, i.e. domain name entries without backing IP addresses.</p><p>If there are DNS entries directly linked to the corresponding load balancer and they are managed by the
<a href=https://github.com/gardener/gardener-extension-shoot-dns-service>shoot-dns-service</a>, you can identify this via
annotations with the prefix <code>dns.gardener.cloud/</code>. Those annotations can be linked to a <code>Service</code>, <code>Ingress</code> or
<code>Gateway</code> resources. Alternatively, they may also use <code>DNSEntry</code> or <code>DNSAnnotation</code> resources.</p><p>For a seamless migration without downtime use the following three step approach:</p><ol><li>Temporarily prevent direct DNS updates</li><li>Migrate the load balancer and wait until it is operational</li><li>Allow DNS updates again</li></ol><p>To prevent direct updates of the DNS entries when the load balancer is migrated add the annotation
<code>dns.gardener.cloud/ignore: 'true'</code> to all affected resources next to the other <code>dns.gardener.cloud/...</code> annotations
before starting the migration. For example, in case of a <code>Service</code> ensure that the service looks like the following:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    dns.gardener.cloud/ignore: <span style=color:#a31515>&#39;true&#39;</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: <span style=color:#a31515>&#39;...&#39;</span>
</span></span><span style=display:flex><span>    ...
</span></span></code></pre></div><p>Next, migrate the load balancer to be dual-stack enabled by adding/changing the corresponding annotations.</p><p>You have multiple options how to check that the load balancer has been provisioned successfully. It might be useful
to peek into <code>status.loadBalancer.ingress</code> of the corresponding <code>Service</code> to identify the load balancer:</p><ul><li>Check in the AWS console for the corresponding load balancer provisioning state</li><li>Perform domain name lookups with <code>nslookup</code>/<code>dig</code> to check whether the name resolves to an IP address.</li><li>Call your workload via the new load balancer, e.g. using
<code>curl --resolve &lt;my-domain-name>:&lt;port>:&lt;IP-address> https://&lt;my-domain-name>:&lt;port></code>, which allows you to call your
service with the &ldquo;correct&rdquo; domain name without using actual name resolution.</li><li>Wait a fixed period of time as load balancer creation is usually finished within 15 minutes</li></ul><p>Once the load balancer has been provisioned, you can remove the annotation <code>dns.gardener.cloud/ignore: 'true'</code> again
from the affected resources. It may take some additional time until the domain name change finally propagates
(up to one hour).</p></div><div class=td-content style=page-break-before:always><h1 id=pg-28a12e85fc80a44c9f68439847c31f5e>1.2.4 - Ipv6</h1><h1 id=support-for-ipv6>Support for IPv6<a class=td-heading-self-link href=#support-for-ipv6 aria-label="Heading self-link"></a></h1><h2 id=overview>Overview<a class=td-heading-self-link href=#overview aria-label="Heading self-link"></a></h2><p>Gardener supports different levels of IPv6 support in shoot clusters.
This document describes the differences between them and what to consider when using them.</p><p>In <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/ipv6/#ipv6-ingress-for-ipv4-shoot-clusters>IPv6 Ingress for IPv4 Shoot Clusters</a>, the focus is on how an existing IPv4-only shoot cluster can provide dual-stack services to clients.
Section <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/ipv6/#ipv6-only-shoot-clusters>IPv6-only Shoot Clusters</a> describes how to create a shoot cluster that only supports IPv6.
Finally, <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/ipv6/#dual-stack-shoot-clusters>Dual-Stack Shoot Clusters</a> explains how to create a shoot cluster that supports both IPv4 and IPv6.</p><h2 id=ipv6-ingress-for-ipv4-shoot-clusters>IPv6 Ingress for IPv4 Shoot Clusters<a class=td-heading-self-link href=#ipv6-ingress-for-ipv4-shoot-clusters aria-label="Heading self-link"></a></h2><p>Per default, Gardener shoot clusters use only IPv4.
Therefore, they also expose their services only via load balancers with IPv4 addresses.
To allow external clients to also use IPv6 to access services in an IPv4 shoot cluster, the cluster needs to be configured to support dual-stack ingress.</p><p>It is possible to configure a shoot cluster to support dual-stack ingress, see <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/dual-stack-ingress/>Using IPv4/IPv6 (dual-stack) Ingress in an IPv4 single-stack cluster</a> for more information.</p><p>The main benefit of this approach is that the existing cluster stays almost as is without major changes, keeping the operational simplicity.
It works very well for services that only require incoming communication, e.g. pure web services.</p><p>The main drawback is that certain scenarios, especially related to IPv6 callbacks, are not possible.
This means that services, which actively call to their clients via web hooks, will not be able to do so over IPv6.
Hence, those services will not be able to allow full-usage via IPv6.</p><h2 id=ipv6-only-shoot-clusters>IPv6-only Shoot Clusters<a class=td-heading-self-link href=#ipv6-only-shoot-clusters aria-label="Heading self-link"></a></h2><h3 id=motivation>Motivation<a class=td-heading-self-link href=#motivation aria-label="Heading self-link"></a></h3><p>IPv6-only shoot clusters are the best option to verify that services are fully IPv6-compatible.
While <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/ipv6/#dual-stack-shoot-clusters>Dual-Stack Shoot Clusters</a> may fall back on using IPv4 transparently, IPv6-only shoot clusters enforce the usage of IPv6 inside the cluster.
Therefore, it is recommended to check with IPv6-only shoot clusters if a workload is fully IPv6-compatible.</p><p>In addition to being a good testbed for IPv6 compatibility, IPv6-only shoot clusters may also be a desirable eventual target in the IPv6 migration as they allow to support both IPv4 and IPv6 clients while having a single-stack with the cluster.</p><h3 id=creating-an-ipv6-only-shoot-cluster>Creating an IPv6-only Shoot Cluster<a class=td-heading-self-link href=#creating-an-ipv6-only-shoot-cluster aria-label="Heading self-link"></a></h3><p>To create an IPv6-only shoot cluster, the following needs to be specified in the <code>Shoot</code> resource (see also <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/usage/#example-shoot-manifest-ipv6>here</a>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: ...
</span></span><span style=display:flex><span>    ipFamilies:
</span></span><span style=display:flex><span>      - IPv6
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: aws
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vpc:
</span></span><span style=display:flex><span>          cidr: 192.168.0.0/16
</span></span><span style=display:flex><span>        zones:
</span></span><span style=display:flex><span>          - name: ...
</span></span><span style=display:flex><span>            public: 192.168.32.0/20
</span></span><span style=display:flex><span>            internal: 192.168.48.0/20
</span></span></code></pre></div><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>Please note that <code>nodes</code>, <code>pods</code> and <code>services</code> should not be specified in <code>.spec.networking</code> resource.</p></blockquote><p>In contrast to that, it is still required to specify IPv4 ranges for the VPC and the public/internal subnets.
This is mainly due to the fact that public/internal load balancers still require IPv4 addresses as there are no pure IPv6-only load balancers as of now.
The ranges can be sized according to the expected amount of load balancers per zone/type.</p><p>The IPv6 address ranges are provided by AWS. It is ensured that the IPv6 ranges are globally unique und internet routable.</p><h3 id=load-balancer-configuration>Load Balancer Configuration<a class=td-heading-self-link href=#load-balancer-configuration aria-label="Heading self-link"></a></h3><p>The AWS Load Balancer Controller is automatically deployed when using an IPv6-only shoot cluster.
When creating a load balancer, the corresponding annotations need to be configured, see <a href=https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/guide/service/nlb/>AWS Load Balancer Documentation - Network Load Balancer</a> for details.</p><p>The AWS Load Balancer Controller allows dual-stack ingress so that an IPv6-only shoot cluster can serve IPv4 and IPv6 clients.
You can find an example <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/dual-stack-ingress/#creating-an-ipv4ipv6-dual-stack-ingress>here</a>.</p><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>When accessing Network Load Balancers (NLB) from within the same IPv6-only cluster, it is crucial to add the annotation <code>service.beta.kubernetes.io/aws-load-balancer-target-group-attributes: preserve_client_ip.enabled=false</code>.
Without this annotation, if a request is routed by the NLB to the same target instance from which it originated, the client IP and destination IP will be identical.
This situation, known as the hair-pinning effect, will prevent the request from being processed.
(This also happens for internal load balancers in IPv4 clusters, but is mitigated by the NAT gateway for external IPv4 load balancers.)</p></blockquote><h3 id=connectivity-to-ipv4-only-services>Connectivity to IPv4-only Services<a class=td-heading-self-link href=#connectivity-to-ipv4-only-services aria-label="Heading self-link"></a></h3><p>The IPv6-only shoot cluster can connect to IPv4-only services via DNS64/NAT64.
The cluster is configured to use the DNS64/NAT64 service of the underlying cloud provider.
This allows the cluster to resolve IPv4-only DNS names and to connect to IPv4-only services.</p><p>Please note that traffic going through NAT64 incurs the same cost as ordinary NAT traffic in an IPv4-only cluster.
Therefore, it might be beneficial to prefer IPv6 for services, which provide IPv4 and IPv6.</p><h2 id=dual-stack-shoot-clusters>Dual-Stack Shoot Clusters<a class=td-heading-self-link href=#dual-stack-shoot-clusters aria-label="Heading self-link"></a></h2><h3 id=motivation-1>Motivation<a class=td-heading-self-link href=#motivation-1 aria-label="Heading self-link"></a></h3><p>Dual-stack shoot clusters support IPv4 and IPv6 out-of-the-box.
They can be the intermediate step on the way towards IPv6 for any existing (IPv4-only) clusters.</p><h3 id=creating-a-dual-stack-shoot-cluster>Creating a Dual-Stack Shoot Cluster<a class=td-heading-self-link href=#creating-a-dual-stack-shoot-cluster aria-label="Heading self-link"></a></h3><p>To create a dual-stack shoot cluster, the following needs to be specified in the <code>Shoot</code> resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: ...
</span></span><span style=display:flex><span>    pods: 192.168.128.0/17
</span></span><span style=display:flex><span>    nodes: 192.168.0.0/18
</span></span><span style=display:flex><span>    services: 192.168.64.0/18
</span></span><span style=display:flex><span>    ipFamilies:
</span></span><span style=display:flex><span>      - IPv4
</span></span><span style=display:flex><span>      - IPv6
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: aws
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vpc:
</span></span><span style=display:flex><span>          cidr: 192.168.0.0/18
</span></span><span style=display:flex><span>        zones:
</span></span><span style=display:flex><span>          - name: ...
</span></span><span style=display:flex><span>            workers: 192.168.0.0/19
</span></span><span style=display:flex><span>            public: 192.168.32.0/20
</span></span><span style=display:flex><span>            internal: 192.168.48.0/20
</span></span></code></pre></div><p>Please note that the only change compared to an IPv4-only shoot cluster is the addition of <code>IPv6</code> to the <code>.spec.networking.ipFamilies</code> field.
The order of the IP families defines the preference of the IP family.
In this case, IPv4 is preferred over IPv6, e.g. services specifying no IP family will get only an IPv4 address.</p><h3 id=migration-of-ipv4-only-shoot-clusters-to-dual-stack>Migration of IPv4-only Shoot Clusters to Dual-Stack<a class=td-heading-self-link href=#migration-of-ipv4-only-shoot-clusters-to-dual-stack aria-label="Heading self-link"></a></h3><p>Eventually, migration should be as easy as changing the <code>.spec.networking.ipFamilies</code> field in the <code>Shoot</code> resource from <code>IPv4</code> to <code>IPv4, IPv6</code>.
However, as of now, this is not supported.</p><p>It is worth recognizing that the migration from an IPv4-only shoot cluster to a dual-stack shoot cluster involves rolling of the nodes/workload as well.
Nodes will not get a new IPv6 address assigned automatically.
The same is true for pods as well.
Once the migration is supported, the detailed caveats will be documented here.</p><h3 id=load-balancer-configuration-1>Load Balancer Configuration<a class=td-heading-self-link href=#load-balancer-configuration-1 aria-label="Heading self-link"></a></h3><p>The AWS Load Balancer Controller is automatically deployed when using a dual-stack shoot cluster.
When creating a load balancer, the corresponding annotations need to be configured, see <a href=https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/guide/service/nlb/>AWS Load Balancer Documentation - Network Load Balancer</a> for details.</p><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>Please note that load balancer services without any special annotations will default to IPv4-only regardless how <code>.spec.ipFamilies</code> is set.</p></blockquote><p>The AWS Load Balancer Controller allows dual-stack ingress so that a dual-stack shoot cluster can serve IPv4 and IPv6 clients.
You can find an example <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/dual-stack-ingress/#creating-an-ipv4ipv6-dual-stack-ingress>here</a>.</p><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>When accessing external Network Load Balancers (NLB) from within the same cluster via IPv6 or internal NLBs via IPv4, it is crucial to add the annotation <code>service.beta.kubernetes.io/aws-load-balancer-target-group-attributes: preserve_client_ip.enabled=false</code>.
Without this annotation, if a request is routed by the NLB to the same target instance from which it originated, the client IP and destination IP will be identical.
This situation, known as the hair-pinning effect, will prevent the request from being processed.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-f9e02d7a81c7f540c23da08a17dfec76>1.2.5 - Local Setup</h1><h3 id=admission-aws>admission-aws<a class=td-heading-self-link href=#admission-aws aria-label="Heading self-link"></a></h3><p><code>admission-aws</code> is an admission webhook server which is responsible for the validation of the cloud provider (AWS in this case) specific fields and resources. The Gardener API server is cloud provider agnostic and it wouldn&rsquo;t be able to perform similar validation.</p><p>Follow the steps below to run the admission webhook server locally.</p><ol><li><p>Start the Gardener API server.</p><p>For details, check the Gardener <a href=/docs/gardener/local_setup/>local setup</a>.</p></li><li><p>Start the webhook server</p><p>Make sure that the <code>KUBECONFIG</code> environment variable is pointing to the local garden cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make start-admission
</span></span></code></pre></div></li><li><p>Setup the <code>ValidatingWebhookConfiguration</code>.</p><p><code>hack/dev-setup-admission-aws.sh</code> will configure the webhook Service which will allow the kube-apiserver of your local cluster to reach the webhook server. It will also apply the <code>ValidatingWebhookConfiguration</code> manifest.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./hack/dev-setup-admission-aws.sh
</span></span></code></pre></div></li></ol><p>You are now ready to experiment with the <code>admission-aws</code> webhook server locally.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-464bc9c324b16ca3984ff0327efdf6c3>1.2.6 - Operations</h1><h1 id=using-the-aws-provider-extension-with-gardener-as-operator>Using the AWS provider extension with Gardener as operator<a class=td-heading-self-link href=#using-the-aws-provider-extension-with-gardener-as-operator aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/30-cloudprofile.yaml><code>core.gardener.cloud/v1beta1.CloudProfile</code> resource</a> declares a <code>providerConfig</code> field that is meant to contain provider-specific configuration.
Similarly, the <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml><code>core.gardener.cloud/v1beta1.Seed</code> resource</a> is structured.
Additionally, it allows to configure settings for the backups of the main etcds&rsquo; data of shoot clusters control planes running in this seed cluster.</p><p>This document explains what is necessary to configure for this provider extension.</p><h2 id=cloudprofile-resource><code>CloudProfile</code> resource<a class=td-heading-self-link href=#cloudprofile-resource aria-label="Heading self-link"></a></h2><p>In this section we are describing how the configuration for <code>CloudProfile</code>s looks like for AWS and provide an example <code>CloudProfile</code> manifest with minimal configuration that you can use to allow creating AWS shoot clusters.</p><h3 id=cloudprofileconfig><code>CloudProfileConfig</code><a class=td-heading-self-link href=#cloudprofileconfig aria-label="Heading self-link"></a></h3><p>The cloud profile configuration contains information about the real machine image IDs in the AWS environment (AMIs).
You have to map every version that you specify in <code>.spec.machineImages[].versions</code> here such that the AWS extension knows the AMI for every version you want to offer.
For each AMI an <code>architecture</code> field can be specified which specifies the CPU architecture of the machine on which given machine image can be used.</p><p>An example <code>CloudProfileConfig</code> for the AWS extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: CloudProfileConfig
</span></span><span style=display:flex><span>machineImages:
</span></span><span style=display:flex><span>- name: coreos
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>  - version: 2135.6.0
</span></span><span style=display:flex><span>    regions:
</span></span><span style=display:flex><span>    - name: eu-central-1
</span></span><span style=display:flex><span>      ami: ami-034fd8c3f4026eb39
</span></span><span style=display:flex><span>      <span style=color:green># architecture: amd64 # optional</span>
</span></span></code></pre></div><h3 id=example-cloudprofile-manifest>Example <code>CloudProfile</code> manifest<a class=td-heading-self-link href=#example-cloudprofile-manifest aria-label="Heading self-link"></a></h3><p>Please find below an example <code>CloudProfile</code> manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: CloudProfile
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: aws
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: aws
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 1.27.3
</span></span><span style=display:flex><span>    - version: 1.26.8
</span></span><span style=display:flex><span>      expirationDate: <span style=color:#a31515>&#34;2022-10-31T23:59:59Z&#34;</span>
</span></span><span style=display:flex><span>  machineImages:
</span></span><span style=display:flex><span>  - name: coreos
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 2135.6.0
</span></span><span style=display:flex><span>  machineTypes:
</span></span><span style=display:flex><span>  - name: m5.large
</span></span><span style=display:flex><span>    cpu: <span style=color:#a31515>&#34;2&#34;</span>
</span></span><span style=display:flex><span>    gpu: <span style=color:#a31515>&#34;0&#34;</span>
</span></span><span style=display:flex><span>    memory: 8Gi
</span></span><span style=display:flex><span>    usable: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  volumeTypes:
</span></span><span style=display:flex><span>  - name: gp2
</span></span><span style=display:flex><span>    class: standard
</span></span><span style=display:flex><span>    usable: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  - name: io1
</span></span><span style=display:flex><span>    class: premium
</span></span><span style=display:flex><span>    usable: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  regions:
</span></span><span style=display:flex><span>  - name: eu-central-1
</span></span><span style=display:flex><span>    zones:
</span></span><span style=display:flex><span>    - name: eu-central-1a
</span></span><span style=display:flex><span>    - name: eu-central-1b
</span></span><span style=display:flex><span>    - name: eu-central-1c
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: CloudProfileConfig
</span></span><span style=display:flex><span>    machineImages:
</span></span><span style=display:flex><span>    - name: coreos
</span></span><span style=display:flex><span>      versions:
</span></span><span style=display:flex><span>      - version: 2135.6.0
</span></span><span style=display:flex><span>        regions:
</span></span><span style=display:flex><span>        - name: eu-central-1
</span></span><span style=display:flex><span>          ami: ami-034fd8c3f4026eb39
</span></span><span style=display:flex><span>          <span style=color:green># architecture: amd64 # optional</span>
</span></span></code></pre></div><h2 id=seed-resource><code>Seed</code> resource<a class=td-heading-self-link href=#seed-resource aria-label="Heading self-link"></a></h2><p>This provider extension does not support any provider configuration for the <code>Seed</code>&rsquo;s <code>.spec.provider.providerConfig</code> field.
However, it supports to manage backup infrastructure, i.e., you can specify configuration for the <code>.spec.backup</code> field.</p><h3 id=backup-configuration>Backup configuration<a class=td-heading-self-link href=#backup-configuration aria-label="Heading self-link"></a></h3><p>Please find below an example <code>Seed</code> manifest (partly) that configures backups.
As you can see, the location/region where the backups will be stored can be different to the region where the seed cluster is running.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: backup-credentials
</span></span><span style=display:flex><span>  namespace: garden
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  accessKeyID: base64(access-key-id)
</span></span><span style=display:flex><span>  secretAccessKey: base64(secret-access-key)
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Seed
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-seed
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: aws
</span></span><span style=display:flex><span>    region: eu-west-1
</span></span><span style=display:flex><span>  backup:
</span></span><span style=display:flex><span>    provider: aws
</span></span><span style=display:flex><span>    region: eu-central-1
</span></span><span style=display:flex><span>    secretRef:
</span></span><span style=display:flex><span>      name: backup-credentials
</span></span><span style=display:flex><span>      namespace: garden
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>Please look up <a href=https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys>https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys</a> as well.</p><h4 id=permissions-for-aws-iam-user>Permissions for AWS IAM user<a class=td-heading-self-link href=#permissions-for-aws-iam-user aria-label="Heading self-link"></a></h4><p>Please make sure that the provided credentials have the correct privileges. You can use the following AWS IAM policy document and attach it to the IAM user backed by the credentials you provided (please check the <a href=http://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_manage.html>official AWS documentation</a> as well):</p><details><summary>Click to expand the AWS IAM policy document!</summary><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;Version&#34;: <span style=color:#a31515>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>  &#34;Statement&#34;: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      &#34;Action&#34;: <span style=color:#a31515>&#34;s3:*&#34;</span>,
</span></span><span style=display:flex><span>      &#34;Resource&#34;: <span style=color:#a31515>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details></div><div class=td-content style=page-break-before:always><h1 id=pg-b56ae0589f68df0d7a157f7430ba7bbd>1.2.7 - Usage</h1><h1 id=using-the-aws-provider-extension-with-gardener-as-an-end-user>Using the AWS provider extension with Gardener as an end-user<a class=td-heading-self-link href=#using-the-aws-provider-extension-with-gardener-as-an-end-user aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a few fields that are meant to contain provider-specific configuration.</p><p>In this document we are describing how this configuration looks like for AWS and provide an example <code>Shoot</code> manifest with minimal configuration that you can use to create an AWS cluster (modulo the landscape-specific information like cloud profile names, secret binding names, etc.).</p><h2 id=accessing-aws-apis>Accessing AWS APIs<a class=td-heading-self-link href=#accessing-aws-apis aria-label="Heading self-link"></a></h2><p>In order for Gardener to create a Kubernetes cluster using AWS infrastructure components, a Shoot has to provide an authentication mechanism giving sufficient permissions to the desired AWS account.
Every shoot cluster references a <code>SecretBinding</code> or a <code>CredentialsBinding</code> which itself references a <code>Secret</code> which contains the provider credentials of the AWS account.</p><blockquote class="alert alert-important"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>message-outline</title><path d="M20 2H4C2.9 2 2 2.9 2 4V22l4-4H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2m0 14H5.2L4 17.2V4H20V16z"/></svg><p>Important</p></div><p>While <code>SecretBinding</code>s can only reference <code>Secret</code>s, <code>CredentialsBinding</code>s can also reference <code>WorkloadIdentity</code>s which provide an alternative authentication method.
<code>WorkloadIdentity</code>s do not directly contain credentials but are rather a representation of the workload that is going to access the user&rsquo;s account.
If the user has configured <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_oidc.html>OIDC Federation</a> with Gardener&rsquo;s Workload Identity Issuer then the AWS infrastructure components can access the user&rsquo;s account without the need of preliminary exchange of credentials.</p></blockquote><h3 id=provider-secret-data>Provider Secret Data<a class=td-heading-self-link href=#provider-secret-data aria-label="Heading self-link"></a></h3><p>Every shoot cluster references a <code>SecretBinding</code> or a <code>CredentialsBinding</code> which itself references a <code>Secret</code>, and this <code>Secret</code> contains the provider credentials of your AWS account.
This <code>Secret</code> must look as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: core-aws
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  accessKeyID: base64(access-key-id)
</span></span><span style=display:flex><span>  secretAccessKey: base64(secret-access-key)
</span></span></code></pre></div><p>The <a href=https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys>AWS documentation</a> explains the necessary steps to enable programmatic access, i.e. create <strong>access key ID</strong> and <strong>access key</strong>, for the user of your choice.</p><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>For security reasons, we recommend creating a <strong>dedicated user with programmatic access only</strong>.
Please avoid re-using a IAM user which has access to the AWS console (human user).</p><p>Depending on your AWS API usage it can be problematic to reuse the same AWS Account for different Shoot clusters in the same region due to rate limits.
Please consider spreading your Shoots over multiple AWS Accounts if you are hitting those limits.</p></blockquote><h3 id=aws-workload-identity-federation>AWS Workload Identity Federation<a class=td-heading-self-link href=#aws-workload-identity-federation aria-label="Heading self-link"></a></h3><p>Users can choose to trust Gardener&rsquo;s Workload Identity Issuer and eliminate the need for providing AWS Access Key credentials.</p><h4 id=1-configure-oidc-federationhttpsdocsawsamazoncomiamlatestuserguideid_roles_providers_oidchtml-with-gardeners-workload-identity-issuer>1. Configure <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_oidc.html>OIDC Federation</a> with Gardener&rsquo;s Workload Identity Issuer.<a class=td-heading-self-link href=#1-configure-oidc-federationhttpsdocsawsamazoncomiamlatestuserguideid_roles_providers_oidchtml-with-gardeners-workload-identity-issuer aria-label="Heading self-link"></a></h4><p><img src=/__resources/oidc-federation_743164.png alt="OIDC Federation"></p><blockquote class="alert alert-important"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>message-outline</title><path d="M20 2H4C2.9 2 2 2.9 2 4V22l4-4H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2m0 14H5.2L4 17.2V4H20V16z"/></svg><p>Important</p></div><p>Use an audience that will uniquely identify the trust relationship between your AWS account and Gardener.</p></blockquote><h4 id=2-create-a-policy-listing-the-required-permissionsdocsextensionsinfrastructure-extensionsgardener-extension-provider-awsusagepermissions>2. Create a policy listing the <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/usage/#permissions>required permissions</a>.<a class=td-heading-self-link href=#2-create-a-policy-listing-the-required-permissionsdocsextensionsinfrastructure-extensionsgardener-extension-provider-awsusagepermissions aria-label="Heading self-link"></a></h4><h4 id=3-create-a-role-that-trusts-the-external-web-identity>3. Create a role that trusts the external web identity.<a class=td-heading-self-link href=#3-create-a-role-that-trusts-the-external-web-identity aria-label="Heading self-link"></a></h4><p>In the Identity Provider dropdown menu choose the Gardener&rsquo;s Workload Identity Provider.
<img src=/__resources/role-trust_01631d.png alt="Role Trust"></p><p>Add the newly created policy that will grant the required permissions.
<img src=/__resources/policy-premissions_2fb81d.png alt="Policy Permissions"></p><h4 id=4--configure-the-trust-relationship>4. Configure the trust relationship.<a class=td-heading-self-link href=#4--configure-the-trust-relationship aria-label="Heading self-link"></a></h4><blockquote class="alert alert-caution"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-octagon-outline</title><path d="M8.27 3 3 8.27v7.46L8.27 21h7.46C17.5 19.24 21 15.73 21 15.73V8.27L15.73 3M9.1 5h5.8L19 9.1v5.8L14.9 19H9.1L5 14.9V9.1M11 15h2v2H11V15m0-8h2v6H11V7"/></svg><p>Caution</p></div><p>Remember to reduce the scope of the identities that can assume this role only to your own controlled identities!
In the example shown below <code>WorkloadIdentity</code>s that are created in the <code>garden-myproj</code> namespace and have the name <code>aws</code> will be authenticated and granted permissions.
Later on, the scope of the trust configuration can be reduced further by replacing the wildcard &ldquo;*&rdquo; with the actual id of the <code>WorkloadIdentity</code> and converting the &ldquo;StringLike&rdquo; condition to &ldquo;StringEquals&rdquo;.
This is currently not possible since we do not have the id of the <code>WorkloadIdentity</code> yet.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    &#34;Version&#34;: <span style=color:#a31515>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>    &#34;Statement&#34;: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            &#34;Action&#34;: <span style=color:#a31515>&#34;sts:AssumeRoleWithWebIdentity&#34;</span>,
</span></span><span style=display:flex><span>            &#34;Principal&#34;: {
</span></span><span style=display:flex><span>                &#34;Federated&#34;: <span style=color:#a31515>&#34;arn:aws:iam::123456789012:oidc-provider/example.local.gardener.cloud/garden/workload-identity/issuer&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            &#34;Condition&#34;: {
</span></span><span style=display:flex><span>                &#34;StringEquals&#34;: {
</span></span><span style=display:flex><span>                    &#34;example.local.gardener.cloud/garden/workload-identity/issuer:aud&#34;: [
</span></span><span style=display:flex><span>                        <span style=color:#a31515>&#34;my-aws-account-gardener-workload-identity&#34;</span>
</span></span><span style=display:flex><span>                    ]
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                &#34;StringLike&#34;: {
</span></span><span style=display:flex><span>                    &#34;example.local.gardener.cloud/garden/workload-identity/issuer:sub&#34;: <span style=color:#a31515>&#34;gardener.cloud:workloadidentity:garden-myproj:aws:*&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></blockquote><h4 id=5-create-the-workloadidentity-in-the-garden-cluster>5. Create the <code>WorkloadIdentity</code> in the Garden cluster.<a class=td-heading-self-link href=#5-create-the-workloadidentity-in-the-garden-cluster aria-label="Heading self-link"></a></h4><p>This step will require the ARN of the role that was created in the previous step.
The identity will be used by infrastructure components to authenticate against AWS APIs.
A sample of such resource is shown below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: security.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: WorkloadIdentity
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: aws
</span></span><span style=display:flex><span>  namespace: garden-myproj
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  audiences:
</span></span><span style=display:flex><span>  - my-aws-account-gardener-workload-identity
</span></span><span style=display:flex><span>  targetSystem:
</span></span><span style=display:flex><span>    type: aws
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: WorkloadIdentityConfig
</span></span><span style=display:flex><span>      roleARN: arn:aws:iam::123456789012:role/gardener-workload-identity
</span></span></code></pre></div><blockquote class="alert alert-tip"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>lightbulb-on-outline</title><path d="M20 11h3v2H20V11M1 11H4v2H1V11M13 1V4H11V1h2M4.92 3.5 7.05 5.64 5.63 7.05 3.5 4.93 4.92 3.5M16.95 5.63 19.07 3.5 20.5 4.93 18.37 7.05 16.95 5.63M12 6a6 6 0 016 6c0 2.22-1.21 4.16-3 5.2V19a1 1 0 01-1 1H10A1 1 0 019 19V17.2C7.21 16.16 6 14.22 6 12a6 6 0 016-6m2 15v1a1 1 0 01-1 1H11a1 1 0 01-1-1V21h4m-3-3h2V15.87c1.73-.44 3-2.01 3-3.87A4 4 0 0012 8 4 4 0 008 12c0 1.86 1.27 3.43 3 3.87V18z"/></svg><p>Tip</p></div><p>Once created you can extract the whole subject of the workload identity and edit the created Role&rsquo;s trust relationship configuration to also include the workload identity&rsquo;s id.
Obtain the complete <code>sub</code> by running the following:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SUBJECT=<span style=color:#00f>$(</span>kubectl -n garden-myproj get workloadidentity aws -o=jsonpath=<span style=color:#a31515>&#39;{.status.sub}&#39;</span><span style=color:#00f>)</span>
</span></span><span style=display:flex><span>echo <span style=color:#a31515>&#34;</span>$SUBJECT<span style=color:#a31515>&#34;</span>
</span></span></code></pre></div></blockquote><h4 id=6-create-a-credentialsbinding-referencing-the-aws-workloadidentity-and-use-it-in-your-shoot-definitions>6. Create a <code>CredentialsBinding</code> referencing the AWS <code>WorkloadIdentity</code> and use it in your <code>Shoot</code> definitions.<a class=td-heading-self-link href=#6-create-a-credentialsbinding-referencing-the-aws-workloadidentity-and-use-it-in-your-shoot-definitions aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: security.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: CredentialsBinding
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: aws
</span></span><span style=display:flex><span>  namespace: garden-myproj
</span></span><span style=display:flex><span>credentialsRef:
</span></span><span style=display:flex><span>  apiVersion: security.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: WorkloadIdentity
</span></span><span style=display:flex><span>  name: aws
</span></span><span style=display:flex><span>  namespace: garden-myproj
</span></span><span style=display:flex><span>provider:
</span></span><span style=display:flex><span>  type: aws
</span></span></code></pre></div><h3 id=permissions>Permissions<a class=td-heading-self-link href=#permissions aria-label="Heading self-link"></a></h3><p>Please make sure that the provided credentials have the correct privileges. You can use the following AWS IAM policy document and attach it to the IAM user backed by the credentials you provided (please check the <a href=http://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_manage.html>official AWS documentation</a> as well):</p><details><summary>Click to expand the AWS IAM policy document!</summary><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;Version&#34;: <span style=color:#a31515>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>  &#34;Statement&#34;: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      &#34;Action&#34;: <span style=color:#a31515>&#34;autoscaling:*&#34;</span>,
</span></span><span style=display:flex><span>      &#34;Resource&#34;: <span style=color:#a31515>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      &#34;Action&#34;: <span style=color:#a31515>&#34;ec2:*&#34;</span>,
</span></span><span style=display:flex><span>      &#34;Resource&#34;: <span style=color:#a31515>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      &#34;Action&#34;: <span style=color:#a31515>&#34;elasticloadbalancing:*&#34;</span>,
</span></span><span style=display:flex><span>      &#34;Resource&#34;: <span style=color:#a31515>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      &#34;Action&#34;: [
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:GetInstanceProfile&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:GetPolicy&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:GetPolicyVersion&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:GetRole&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:GetRolePolicy&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:ListPolicyVersions&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:ListRolePolicies&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:ListAttachedRolePolicies&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:ListInstanceProfilesForRole&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:CreateInstanceProfile&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:CreatePolicy&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:CreatePolicyVersion&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:CreateRole&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:CreateServiceLinkedRole&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:AddRoleToInstanceProfile&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:AttachRolePolicy&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:DetachRolePolicy&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:RemoveRoleFromInstanceProfile&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:DeletePolicy&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:DeletePolicyVersion&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:DeleteRole&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:DeleteRolePolicy&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:DeleteInstanceProfile&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:PutRolePolicy&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:PassRole&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:UpdateAssumeRolePolicy&#34;</span>
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      &#34;Resource&#34;: <span style=color:#a31515>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:green>// The following permission set is only needed, if AWS Load Balancer controller is enabled (see ControlPlaneConfig)
</span></span></span><span style=display:flex><span><span style=color:green></span>    {
</span></span><span style=display:flex><span>      &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      &#34;Action&#34;: [
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;cognito-idp:DescribeUserPoolClient&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;acm:ListCertificates&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;acm:DescribeCertificate&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:ListServerCertificates&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;iam:GetServerCertificate&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;waf-regional:GetWebACL&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;waf-regional:GetWebACLForResource&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;waf-regional:AssociateWebACL&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;waf-regional:DisassociateWebACL&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;wafv2:GetWebACL&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;wafv2:GetWebACLForResource&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;wafv2:AssociateWebACL&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;wafv2:DisassociateWebACL&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;shield:GetSubscriptionState&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;shield:DescribeProtection&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;shield:CreateProtection&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;shield:DeleteProtection&#34;</span>
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      &#34;Resource&#34;: <span style=color:#a31515>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details><h2 id=infrastructureconfig><code>InfrastructureConfig</code><a class=td-heading-self-link href=#infrastructureconfig aria-label="Heading self-link"></a></h2><p>The infrastructure configuration mainly describes how the network layout looks like in order to create the shoot worker nodes in a later step, thus, prepares everything relevant to create VMs, load balancers, volumes, etc.</p><p>An example <code>InfrastructureConfig</code> for the AWS extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: InfrastructureConfig
</span></span><span style=display:flex><span>enableECRAccess: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>dualStack:
</span></span><span style=display:flex><span>  enabled: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>networks:
</span></span><span style=display:flex><span>  vpc: <span style=color:green># specify either &#39;id&#39; or &#39;cidr&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:green># id: vpc-123456</span>
</span></span><span style=display:flex><span>    cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>  <span style=color:green># gatewayEndpoints:</span>
</span></span><span style=display:flex><span>  <span style=color:green># - s3</span>
</span></span><span style=display:flex><span>  zones:
</span></span><span style=display:flex><span>  - name: eu-west-1a
</span></span><span style=display:flex><span>    internal: 10.250.112.0/22
</span></span><span style=display:flex><span>    public: 10.250.96.0/22
</span></span><span style=display:flex><span>    workers: 10.250.0.0/19
</span></span><span style=display:flex><span>  <span style=color:green># elasticIPAllocationID: eipalloc-123456</span>
</span></span><span style=display:flex><span>ignoreTags:
</span></span><span style=display:flex><span>  keys: <span style=color:green># individual ignored tag keys</span>
</span></span><span style=display:flex><span>  - SomeCustomKey
</span></span><span style=display:flex><span>  - AnotherCustomKey
</span></span><span style=display:flex><span>  keyPrefixes: <span style=color:green># ignored tag key prefixes</span>
</span></span><span style=display:flex><span>  - user.specific/prefix/
</span></span></code></pre></div><p>The <code>enableECRAccess</code> flag specifies whether the AWS IAM role policy attached to all worker nodes of the cluster shall contain permissions to access the Elastic Container Registry of the respective AWS account.
If the flag is not provided it is defaulted to <code>true</code>.
Please note that if the <code>iamInstanceProfile</code> is set for a worker pool in the <code>WorkerConfig</code> (see below) then <code>enableECRAccess</code> does not have any effect.
It only applies for those worker pools whose <code>iamInstanceProfile</code> is not set.</p><details><summary>Click to expand the default AWS IAM policy document used for the instance profiles!</summary><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;Version&#34;: <span style=color:#a31515>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>  &#34;Statement&#34;: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      &#34;Action&#34;: [
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;ec2:DescribeInstances&#34;</span>
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      &#34;Resource&#34;: [
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;*&#34;</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:green>// Only if `.enableECRAccess` is `true`.
</span></span></span><span style=display:flex><span><span style=color:green></span>    {
</span></span><span style=display:flex><span>      &#34;Effect&#34;: <span style=color:#a31515>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      &#34;Action&#34;: [
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;ecr:GetAuthorizationToken&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;ecr:BatchCheckLayerAvailability&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;ecr:GetDownloadUrlForLayer&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;ecr:GetRepositoryPolicy&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;ecr:DescribeRepositories&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;ecr:ListImages&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;ecr:BatchGetImage&#34;</span>
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      &#34;Resource&#34;: [
</span></span><span style=display:flex><span>        <span style=color:#a31515>&#34;*&#34;</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details><p>The <code>dualStack.enabled</code> flag specifies whether dual-stack or IPv4-only should be supported by the infrastructure.
When the flag is set to true an Amazon provided IPv6 CIDR block will be attached to the VPC.
All subnets will receive a <code>/64</code> block from it and a route entry is added to the main route table to route all IPv6 traffic over the IGW.</p><p>The <code>networks.vpc</code> section describes whether you want to create the shoot cluster in an already existing VPC or whether to create a new one:</p><ul><li>If <code>networks.vpc.id</code> is given then you have to specify the VPC ID of the existing VPC that was created by other means (manually, other tooling, &mldr;).
Please make sure that the VPC has attached an internet gateway - the AWS controller won&rsquo;t create one automatically for existing VPCs. To make sure the nodes are able to join and operate in your cluster properly, please make sure that your VPC has enabled <a href=https://docs.aws.amazon.com/vpc/latest/userguide/vpc-dns.html>DNS Support</a>, explicitly the attributes <code>enableDnsHostnames</code> and <code>enableDnsSupport</code> must be set to <code>true</code>.</li><li>If <code>networks.vpc.cidr</code> is given then you have to specify the VPC CIDR of a new VPC that will be created during shoot creation.
You can freely choose a private CIDR range.</li><li>Either <code>networks.vpc.id</code> or <code>networks.vpc.cidr</code> must be present, but not both at the same time.</li><li><code>networks.vpc.gatewayEndpoints</code> is optional. If specified then each item is used as service name in a corresponding Gateway VPC Endpoint.</li></ul><p>The <code>networks.zones</code> section contains configuration for resources you want to create or use in availability zones.
For every zone, the AWS extension creates three subnets:</p><ul><li>The <code>internal</code> subnet is used for <a href=https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/elb-internal-load-balancers.html>internal AWS load balancers</a>.</li><li>The <code>public</code> subnet is used for <a href=https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/elb-internet-facing-load-balancers.html>public AWS load balancers</a>.</li><li>The <code>workers</code> subnet is used for all shoot worker nodes, i.e., VMs which later run your applications.</li></ul><p>For every subnet, you have to specify a CIDR range contained in the VPC CIDR specified above, or the VPC CIDR of your already existing VPC.
You can freely choose these CIDRs and it is your responsibility to properly design the network layout to suit your needs.</p><p>Also, the AWS extension creates a dedicated NAT gateway for each zone.
By default, it also creates a corresponding Elastic IP that it attaches to this NAT gateway and which is used for egress traffic.
The <code>elasticIPAllocationID</code> field allows you to specify the ID of an existing Elastic IP allocation in case you want to bring your own.
If provided, no new Elastic IP will be created and, instead, the Elastic IP specified by you will be used.</p><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>If you change this field for an already existing infrastructure then it will disrupt egress traffic while AWS applies this change.
The reason is that the NAT gateway must be recreated with the new Elastic IP association.
Also, please note that the existing Elastic IP will be permanently deleted if it was earlier created by the AWS extension.</p></blockquote><p>You can configure <a href=https://docs.aws.amazon.com/vpc/latest/userguide/vpce-gateway.html>Gateway VPC Endpoints</a> by adding items in the optional list <code>networks.vpc.gatewayEndpoints</code>. Each item in the list is used as a service name and a corresponding endpoint is created for it. All created endpoints point to the service within the cluster&rsquo;s region. For example, consider this (partial) shoot config:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  region: eu-central-1
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: aws
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vpc:
</span></span><span style=display:flex><span>          gatewayEndpoints:
</span></span><span style=display:flex><span>          - s3
</span></span></code></pre></div><p>The service name of the S3 Gateway VPC Endpoint in this example is <code>com.amazonaws.eu-central-1.s3</code>.</p><p>If you want to use multiple availability zones then add a second, third, &mldr; entry to the <code>networks.zones[]</code> list and properly specify the AZ name in <code>networks.zones[].name</code>.</p><p>Apart from the VPC and the subnets the AWS extension will also create DHCP options and an internet gateway (only if a new VPC is created), routing tables, security groups, elastic IPs, NAT gateways, EC2 key pairs, IAM roles, and IAM instance profiles.</p><p>The <code>ignoreTags</code> section allows to configure which resource tags on AWS resources managed by Gardener should be ignored during
infrastructure reconciliation. By default, all tags that are added outside of Gardener&rsquo;s
reconciliation will be removed during the next reconciliation. This field allows users and automation to add
custom tags on AWS resources created and managed by Gardener without loosing them on the next reconciliation.
Tags can be ignored either by specifying exact key values (<code>ignoreTags.keys</code>) or key prefixes (<code>ignoreTags.keyPrefixes</code>).
In both cases it is forbidden to ignore the <code>Name</code> tag or any tag starting with <code>kubernetes.io</code> or <code>gardener.cloud</code>.
Please note though, that the tags are only ignored on resources created on behalf of the <code>Infrastructure</code> CR (i.e. VPC,
subnets, security groups, keypair, etc.), while tags on machines, volumes, etc. are not in the scope of this controller.</p><h2 id=controlplaneconfig><code>ControlPlaneConfig</code><a class=td-heading-self-link href=#controlplaneconfig aria-label="Heading self-link"></a></h2><p>The control plane configuration mainly contains values for the AWS-specific control plane components.
Today, the only component deployed by the AWS extension is the <code>cloud-controller-manager</code>.</p><p>An example <code>ControlPlaneConfig</code> for the AWS extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: ControlPlaneConfig
</span></span><span style=display:flex><span>cloudControllerManager:
</span></span><span style=display:flex><span><span style=color:green># featureGates:</span>
</span></span><span style=display:flex><span><span style=color:green>#   SomeKubernetesFeature: true</span>
</span></span><span style=display:flex><span>  useCustomRouteController: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span><span style=color:green># loadBalancerController:</span>
</span></span><span style=display:flex><span><span style=color:green>#   enabled: true</span>
</span></span><span style=display:flex><span><span style=color:green>#   ingressClassName: alb</span>
</span></span><span style=display:flex><span><span style=color:green># ipamController:</span>
</span></span><span style=display:flex><span><span style=color:green>#   enabled: true</span>
</span></span><span style=display:flex><span>storage:
</span></span><span style=display:flex><span>  managedDefaultClass: <span style=color:#00f>false</span>
</span></span></code></pre></div><p>The <code>cloudControllerManager.featureGates</code> contains a map of explicitly enabled or disabled feature gates.
For production usage it&rsquo;s not recommend to use this field at all as you can enable alpha features or disable beta/stable features, potentially impacting the cluster stability.
If you don&rsquo;t want to configure anything for the <code>cloudControllerManager</code> simply omit the key in the YAML specification.</p><p>The <code>cloudControllerManager.useCustomRouteController</code> controls if the <a href=https://github.com/gardener/aws-custom-route-controller>custom routes controller</a> should be enabled.
If enabled, it will add routes to the pod CIDRs for all nodes in the route tables for all zones.</p><p>The <code>storage.managedDefaultClass</code> controls if the <code>default</code> storage / volume snapshot classes are marked as default by Gardener. Set it to <code>false</code> to <a href=https://kubernetes.io/docs/tasks/administer-cluster/change-default-storage-class/>mark another storage / volume snapshot class as default</a> without Gardener overwriting this change. If unset, this field defaults to <code>true</code>.</p><p>If the <a href=https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/>AWS Load Balancer Controller</a> should be deployed, set <code>loadBalancerController.enabled</code> to <code>true</code>.
In this case, it is assumed that an <code>IngressClass</code> named <code>alb</code> is created <strong>by the user</strong>.
You can overwrite the name by setting <code>loadBalancerController.ingressClassName</code>.</p><p>Please note, that currently only the &ldquo;instance&rdquo; mode is supported.</p><h3 id=examples-for-ingress-and-service-managed-by-the-aws-load-balancer-controller>Examples for <code>Ingress</code> and <code>Service</code> managed by the AWS Load Balancer Controller:<a class=td-heading-self-link href=#examples-for-ingress-and-service-managed-by-the-aws-load-balancer-controller aria-label="Heading self-link"></a></h3><ol start=0><li>Prerequisites</li></ol><p>Make sure you have created an <code>IngressClass</code>. For more details about parameters, please see <a href=https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/guide/ingress/ingress_class/>AWS Load Balancer Controller - IngressClass</a></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: IngressClass
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: alb <span style=color:green># default name if not specified by `loadBalancerController.ingressClassName`</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  controller: ingress.k8s.aws/alb
</span></span></code></pre></div><ol><li>Ingress</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>  name: echoserver
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    <span style=color:green># complete set of annotations: https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/guide/ingress/annotations/</span>
</span></span><span style=display:flex><span>    alb.ingress.kubernetes.io/scheme: internet-facing
</span></span><span style=display:flex><span>    alb.ingress.kubernetes.io/target-type: instance <span style=color:green># target-type &#34;ip&#34; NOT supported in Gardener</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ingressClassName: alb
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>    - http:
</span></span><span style=display:flex><span>        paths:
</span></span><span style=display:flex><span>        - path: /
</span></span><span style=display:flex><span>          pathType: Prefix
</span></span><span style=display:flex><span>          backend:
</span></span><span style=display:flex><span>            service:
</span></span><span style=display:flex><span>              name: echoserver
</span></span><span style=display:flex><span>              port:
</span></span><span style=display:flex><span>                number: 80
</span></span></code></pre></div><p>For more details see <a href=https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/guide/ingress/spec/>AWS Load Balancer Documentation - Ingress Specification</a></p><ol start=2><li>Service of Type <code>LoadBalancer</code></li></ol><p>This can be used to create a Network Load Balancer (NLB).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    <span style=color:green># complete set of annotations: https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/guide/service/annotations/</span>
</span></span><span style=display:flex><span>    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: instance <span style=color:green># target-type &#34;ip&#34; NOT supported in Gardener</span>
</span></span><span style=display:flex><span>    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
</span></span><span style=display:flex><span>  name: ingress-nginx-controller
</span></span><span style=display:flex><span>  namespace: ingress-nginx
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  type: LoadBalancer
</span></span><span style=display:flex><span>  loadBalancerClass: service.k8s.aws/nlb <span style=color:green># mandatory to be managed by AWS Load Balancer Controller (otherwise the Cloud Controller Manager will act on it)</span>
</span></span></code></pre></div><p>For more details see <a href=https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/guide/service/nlb/>AWS Load Balancer Documentation - Network Load Balancer</a></p><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>When using Network Load Balancers (NLB) as internal load balancers, it is crucial to add the annotation <code>service.beta.kubernetes.io/aws-load-balancer-target-group-attributes: preserve_client_ip.enabled=false</code>.
Without this annotation, if a request is routed by the NLB to the same target instance from which it originated, the client IP and destination IP will be identical.
This situation, known as the hairpinning effect, will prevent the request from being processed.</p></blockquote><h2 id=workerconfig><code>WorkerConfig</code><a class=td-heading-self-link href=#workerconfig aria-label="Heading self-link"></a></h2><p>The AWS extension supports encryption for volumes plus support for additional data volumes per machine.
For each data volume, you have to specify a name.
By default, (if not stated otherwise), all the disks (root & data volumes) are encrypted.
Please make sure that your <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html>instance-type supports encryption</a>.
If your instance-type doesn&rsquo;t support encryption, you will have to disable encryption (which is enabled by default) by setting <code>volume.encrpyted</code> to <code>false</code> (refer below shown YAML snippet).</p><p>The following YAML is a snippet of a <code>Shoot</code> resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: cpu-worker
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        type: gp2
</span></span><span style=display:flex><span>        size: 20Gi
</span></span><span style=display:flex><span>        encrypted: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>      dataVolumes:
</span></span><span style=display:flex><span>      - name: kubelet-dir
</span></span><span style=display:flex><span>        type: gp2
</span></span><span style=display:flex><span>        size: 25Gi
</span></span><span style=display:flex><span>        encrypted: <span style=color:#00f>true</span>
</span></span></code></pre></div><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>The AWS extension does not support EBS volume (root & data volumes) encryption with <a href=https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#customer-cmk>customer managed CMK</a>.
Support for <a href=https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#customer-cmk>customer managed CMK</a> is out of scope for now.
Only <a href=https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#aws-managed-cmk>AWS managed CMK</a> is supported.</p></blockquote><p>Additionally, it is possible to provide further AWS-specific values for configuring the worker pools. The additional configuration must be specified in the <code>providerConfig</code> field of the respective worker.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>      - name: cpu-worker
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>        providerConfig:
</span></span><span style=display:flex><span>          <span style=color:green># AWS worker config</span>
</span></span></code></pre></div><p>The configuration will be evaluated when the provider-aws will reconcile the worker pools for the respective shoot.</p><p>An example <code>WorkerConfig</code> for the AWS extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>      - name: cpu-worker
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>        providerConfig:
</span></span><span style=display:flex><span>            apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>            kind: WorkerConfig
</span></span><span style=display:flex><span>            volume:
</span></span><span style=display:flex><span>              iops: 10000
</span></span><span style=display:flex><span>              throughput: 200
</span></span><span style=display:flex><span>            dataVolumes:
</span></span><span style=display:flex><span>            - name: kubelet-dir
</span></span><span style=display:flex><span>              iops: 12345
</span></span><span style=display:flex><span>              throughput: 150
</span></span><span style=display:flex><span>              snapshotID: snap-1234
</span></span><span style=display:flex><span>            iamInstanceProfile: <span style=color:green># (specify either ARN or name)</span>
</span></span><span style=display:flex><span>              name: my-profile
</span></span><span style=display:flex><span>            instanceMetadataOptions:
</span></span><span style=display:flex><span>              httpTokens: required
</span></span><span style=display:flex><span>              httpPutResponseHopLimit: 2
</span></span><span style=display:flex><span>            <span style=color:green># arn: my-instance-profile-arn</span>
</span></span><span style=display:flex><span>            nodeTemplate: <span style=color:green># (to be specified only if the node capacity would be different from cloudprofile info during runtime)</span>
</span></span><span style=display:flex><span>              capacity:
</span></span><span style=display:flex><span>                cpu: 2 <span style=color:green># inherited from pool&#39;s machine type if un-specified</span>
</span></span><span style=display:flex><span>                gpu: 0 <span style=color:green># inherited from pool&#39;s machine type if un-specified</span>
</span></span><span style=display:flex><span>                memory: 50Gi <span style=color:green># inherited from pool&#39;s machine type if un-specified</span>
</span></span><span style=display:flex><span>                ephemeral-storage: 10Gi <span style=color:green># override to specify explicit ephemeral-storage for scale fro zero</span>
</span></span><span style=display:flex><span>                resource.com/dongle: 4 <span style=color:green># Example of a custom, extended resource.</span>
</span></span></code></pre></div><p>The <code>.volume.iops</code> is the number of I/O operations per second (IOPS) that the volume supports.
For <code>io1</code> and <code>gp3</code> volume type, this represents the number of IOPS that are provisioned for the volume.
For <code>gp2</code> volume type, this represents the baseline performance of the volume and the rate at which the volume accumulates I/O credits for bursting. For more information about General Purpose SSD baseline performance, I/O credits, IOPS range and bursting, see Amazon EBS Volume Types (<a href=http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSVolumeTypes.html>http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSVolumeTypes.html</a>) in the Amazon Elastic Compute Cloud User Guide.<br>Constraint: IOPS should be a positive value. Validation of IOPS (i.e. whether it is allowed and is in the specified range for a particular volume type) is done on aws side.</p><p>The <code>volume.throughput</code> is the throughput that the volume supports, in <code>MiB/s</code>. As of <code>16th Aug 2022</code>, this parameter is valid only for <code>gp3</code> volume types and will return an error from the provider side if specified for other volume types. Its current range of throughput is from <code>125MiB/s</code> to <code>1000 MiB/s</code>. To know more about throughput and its range, see the official AWS documentation <a href=http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSVolumeTypes.html>here</a>.</p><p>The <code>.dataVolumes</code> can optionally contain configurations for the data volumes stated in the <code>Shoot</code> specification in the <code>.spec.provider.workers[].dataVolumes</code> list.
The <code>.name</code> must match to the name of the data volume in the shoot.
It is also possible to provide a snapshot ID. It allows to <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-restoring-volume.html>restore the data volume from an existing snapshot</a>.</p><p>The <code>iamInstanceProfile</code> section allows to specify the IAM instance profile name xor ARN that should be used for this worker pool.
If not specified, a dedicated IAM instance profile created by the infrastructure controller is used (see above).</p><p>The <code>instanceMetadataOptions</code> controls access to the instance metadata service (IMDS) for members of the worker. You can do the following operations:</p><ul><li>access IMDSv1 (default)</li><li>access IMDSv2 - <code>httpPutResponseHopLimit >= 2</code></li><li>access IMDSv2 only (restrict access to IMDSv1) - <code>httpPutResponseHopLimit >=2</code>, <code>httpTokens = "required"</code></li><li>disable access to IMDS - <code>httpTokens = "required"</code></li></ul><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>The accessibility of IMDS discussed in the previous point is referenced from the point of view of containers <strong>NOT</strong> running in the host network.
By default on host network IMDSv2 is already enabled (but not accessible from inside the pods).
It is currently not possible to create a VM with complete restriction to the IMDS service.
It is however possible to restrict access from inside the pods by setting <code>httpTokens</code> to <code>required</code> and not setting <code>httpPutResponseHopLimit</code> (or setting it to 1).</p></blockquote><p>You can find more information regarding the options in the <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-IMDS-new-instances.html>AWS documentation</a>.</p><p><code>cpuOptions</code> grants more finegrained control over the worker&rsquo;s CPU configuration. It has two attributes:</p><ul><li><code>coreCount</code>: Specify a custom amount of cores the instance should be configured with.</li><li><code>threadsPerCore</code>: How many threads should there be on each core. Set to <code>1</code> to disable multi-threading.</li></ul><p>Note that if you decide to configure <code>cpuOptions</code> <em>both</em> these values need to be provided. For a list of valid combinations of these values refer to the <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/cpu-options-supported-instances-values.html>AWS documentation</a>.</p><h2 id=example-shoot-manifest-one-availability-zone>Example <code>Shoot</code> manifest (one availability zone)<a class=td-heading-self-link href=#example-shoot-manifest-one-availability-zone aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest for one availability zone:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-aws
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfile:
</span></span><span style=display:flex><span>    name: aws
</span></span><span style=display:flex><span>  region: eu-central-1
</span></span><span style=display:flex><span>  secretBindingName: core-aws
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: aws
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vpc:
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>        zones:
</span></span><span style=display:flex><span>        - name: eu-central-1a
</span></span><span style=display:flex><span>          internal: 10.250.112.0/22
</span></span><span style=display:flex><span>          public: 10.250.96.0/22
</span></span><span style=display:flex><span>          workers: 10.250.0.0/19
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: m5.large
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: gp2
</span></span><span style=display:flex><span>    <span style=color:green># The following provider config is valid if the volume type is `io1`.</span>
</span></span><span style=display:flex><span>    <span style=color:green># providerConfig:</span>
</span></span><span style=display:flex><span>    <span style=color:green>#   apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1</span>
</span></span><span style=display:flex><span>    <span style=color:green>#   kind: WorkerConfig</span>
</span></span><span style=display:flex><span>    <span style=color:green>#   volume:</span>
</span></span><span style=display:flex><span>    <span style=color:green>#     iops: 10000</span>
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - eu-central-1a
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.2
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=example-shoot-manifest-three-availability-zones>Example <code>Shoot</code> manifest (three availability zones)<a class=td-heading-self-link href=#example-shoot-manifest-three-availability-zones aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest for three availability zones:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-aws
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfile:
</span></span><span style=display:flex><span>    name: aws
</span></span><span style=display:flex><span>  region: eu-central-1
</span></span><span style=display:flex><span>  secretBindingName: core-aws
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: aws
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vpc:
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>        zones:
</span></span><span style=display:flex><span>        - name: eu-central-1a
</span></span><span style=display:flex><span>          workers: 10.250.0.0/26
</span></span><span style=display:flex><span>          public: 10.250.96.0/26
</span></span><span style=display:flex><span>          internal: 10.250.112.0/26
</span></span><span style=display:flex><span>        - name: eu-central-1b
</span></span><span style=display:flex><span>          workers: 10.250.0.64/26
</span></span><span style=display:flex><span>          public: 10.250.96.64/26
</span></span><span style=display:flex><span>          internal: 10.250.112.64/26
</span></span><span style=display:flex><span>        - name: eu-central-1c
</span></span><span style=display:flex><span>          workers: 10.250.0.128/26
</span></span><span style=display:flex><span>          public: 10.250.96.128/26
</span></span><span style=display:flex><span>          internal: 10.250.112.128/26
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: m5.large
</span></span><span style=display:flex><span>      minimum: 3
</span></span><span style=display:flex><span>      maximum: 9
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: gp2
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - eu-central-1a
</span></span><span style=display:flex><span>      - eu-central-1b
</span></span><span style=display:flex><span>      - eu-central-1c
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.2
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=example-shoot-manifest-ipv6>Example <code>Shoot</code> manifest (IPv6)<a class=td-heading-self-link href=#example-shoot-manifest-ipv6 aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest for an IPv6 shoot cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-aws-ipv6
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfile:
</span></span><span style=display:flex><span>    name: aws
</span></span><span style=display:flex><span>  region: eu-central-1
</span></span><span style=display:flex><span>  secretBindingName: core-aws
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: aws
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vpc:
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>        zones:
</span></span><span style=display:flex><span>        - name: eu-central-1a
</span></span><span style=display:flex><span>          public: 10.250.96.0/22
</span></span><span style=display:flex><span>          internal: 10.250.112.0/22
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - ...
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    ipFamilies:
</span></span><span style=display:flex><span>    - IPv6
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.2
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>false</span>
</span></span></code></pre></div><h2 id=csi-volume-provisioners>CSI volume provisioners<a class=td-heading-self-link href=#csi-volume-provisioners aria-label="Heading self-link"></a></h2><p>Every AWS shoot cluster will be deployed with the AWS EBS CSI driver.
It is compatible with the legacy in-tree volume provisioner that was deprecated by the Kubernetes community and will be removed in future versions of Kubernetes.
End-users might want to update their custom <code>StorageClass</code>es to the new <code>ebs.csi.aws.com</code> provisioner.</p><h3 id=node-specific-volume-limits>Node-specific Volume Limits<a class=td-heading-self-link href=#node-specific-volume-limits aria-label="Heading self-link"></a></h3><p>The Kubernetes scheduler allows configurable limit for the number of volumes that can be attached to a node.
See <a href=https://k8s.io/docs/concepts/storage/storage-limits/#custom-limits>https://k8s.io/docs/concepts/storage/storage-limits/#custom-limits</a>.</p><p>CSI drivers usually have a different procedure for configuring this custom limit.
By default, the EBS CSI driver parses the machine type name and then decides the volume limit.
However, this is only a rough approximation and not good enough in most cases.
Specifying the volume attach limit via command line flag (<code>--volume-attach-limit</code>) is currently the alternative until a more sophisticated solution presents itself (dynamically discovering the maximum number of attachable volume per EC2 machine type, see also <a href=https://github.com/kubernetes-sigs/aws-ebs-csi-driver/issues/347>https://github.com/kubernetes-sigs/aws-ebs-csi-driver/issues/347</a>).
The AWS extension allows the <code>--volume-attach-limit</code> flag of the EBS CSI driver to be configurable via <code>aws.provider.extensions.gardener.cloud/volume-attach-limit</code> annotation on the <code>Shoot</code> resource.</p><p>ℹ️ <em>Please note:</em> If the annotation is added to an existing <code>Shoot</code>, then reconciliation needs to be triggered manually (see <a href=/docs/gardener/shoot-operations/shoot_operations/#immediate-reconciliation>Immediate reconciliation</a>), as adding an annotation to a resource is not a change that leads to an increase of <code>.metadata.generation</code> in general.</p><h3 id=other-csi-options>Other CSI options<a class=td-heading-self-link href=#other-csi-options aria-label="Heading self-link"></a></h3><p>The newer versions of EBS CSI driver are not readily compatible with the use of XFS volumes on nodes using a kernel version &lt;= 5.4.
A workaround was added that enables the use of a &ldquo;legacy XFS&rdquo; mode that introduces a backwards compatible volume formating for the older kernels.
You can enable this option for your shoot by annotating it with <code>aws.provider.extensions.gardener.cloud/legacy-xfs=true</code>.</p><p>ℹ️ <em>Please note:</em> If the annotation is added to an existing <code>Shoot</code>, then reconciliation needs to be triggered manually (see <a href=/docs/gardener/shoot-operations/shoot_operations/#immediate-reconciliation>Immediate reconciliation</a>), as adding an annotation to a resource is not a change that leads to an increase of <code>.metadata.generation</code> in general.</p><h3 id=support-for-volumeattributesclasses-beta-in-k8s-131>Support for VolumeAttributesClasses (Beta in k8s 1.31)<a class=td-heading-self-link href=#support-for-volumeattributesclasses-beta-in-k8s-131 aria-label="Heading self-link"></a></h3><p>To have the CSI-driver configured to support the necessary features for <a href=https://kubernetes.io/docs/concepts/storage/volume-attributes-classes/>VolumeAttributesClasses</a> on AWS for shoots with a k8s-version of at least 1.31, use the <code>aws.provider.extensions.gardener.cloud/enable-volume-attributes-class</code> annotation on the shoot. Keep in mind to also enable the required feature flags and runtime-config on the common kubernetes controllers (as outlined in the link above) in the shoot-spec.</p><p>For more information and examples, see <a href=https://github.com/kubernetes-sigs/aws-ebs-csi-driver/blob/master/docs/modify-volume.md#volume-modification>this markdown</a> in the aws-ebs-csi-driver repository. Please take special note of the considerations mentioned.</p><h2 id=kubernetes-versions-per-worker-pool>Kubernetes Versions per Worker Pool<a class=td-heading-self-link href=#kubernetes-versions-per-worker-pool aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>WorkerPoolKubernetesVersion</code> feature gate, i.e., having <a href=https://github.com/gardener/gardener/blob/8a9c88866ec5fce59b5acf57d4227eeeb73669d7/example/90-shoot.yaml#L69-L70>worker pools with overridden Kubernetes versions</a> since <code>gardener-extension-provider-aws@v1.34</code>.</p><h2 id=shoot-ca-certificate-and-serviceaccount-signing-key-rotation>Shoot CA Certificate and <code>ServiceAccount</code> Signing Key Rotation<a class=td-heading-self-link href=#shoot-ca-certificate-and-serviceaccount-signing-key-rotation aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>ShootCARotation</code> and <code>ShootSARotation</code> feature gates since <code>gardener-extension-provider-aws@v1.36</code>.</p><h2 id=flow-infrastructure-reconciler>Flow Infrastructure Reconciler<a class=td-heading-self-link href=#flow-infrastructure-reconciler aria-label="Heading self-link"></a></h2><p>The extension offers two different reconciler implementations for the infrastructure resource:</p><ul><li>terraform-based</li><li>native Go SDK based (dubbed the &ldquo;flow&rdquo;-based implementation)</li></ul><p>The default implementation currently is the terraform reconciler which uses the <code>https://github.com/gardener/terraformer</code> as the backend for managing the shoot&rsquo;s infrastructure.</p><p>The &ldquo;flow&rdquo; implementation is a newer implementation that is trying to solve issues we faced with managing terraform infrastructure on Kubernetes. The goal is to have more control over the reconciliation process and be able to perform fine-grained tuning over it. The implementation is completely backwards-compatible and offers a migration route from the legacy terraformer implementation.</p><p>For most users there will be no noticeable difference. However for certain use-cases, users may notice a slight deviation from the previous behavior. For example, with flow-based infrastructure users may be able to perform certain modifications to infrastructure resources without having them reconciled back by terraform. Operations that would degrade the shoot infrastructure are still expected to be reverted back.</p><p>For the time-being, to take advantage of the flow reconciler users have to &ldquo;opt-in&rdquo; by annotating the shoot manifest with: <code>aws.provider.extensions.gardener.cloud/use-flow="true"</code>. For existing shoots with this annotation, the migration will take place on the next infrastructure reconciliation (on maintenance window or if other infrastructure changes are requested). The migration is not revertible.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-327ad4a2eb9d221f7e8f6cc268e1fee3>1.3 - Provider Azure</h1><div class=lead>Gardener extension controller for the Azure cloud provider</div><h1 id=gardener-extension-for-azure-providerhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Azure provider</a><a class=td-heading-self-link href=#gardener-extension-for-azure-providerhttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-provider-azure><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-provider-azure alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-provider-azure-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-provider-azure-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-provider-azure><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-provider-azure alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the Azure provider.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-provider-azure/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=supported-kubernetes-versions>Supported Kubernetes versions<a class=td-heading-self-link href=#supported-kubernetes-versions aria-label="Heading self-link"></a></h2><p>This extension controller supports the following Kubernetes versions:</p><table><thead><tr><th>Version</th><th>Support</th><th>Conformance test results</th></tr></thead><tbody><tr><td>Kubernetes 1.32</td><td>1.32.0+</td><td>N/A</td></tr><tr><td>Kubernetes 1.31</td><td>1.31.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.31%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.31%20Azure/tests_status?style=svg" alt="Gardener v1.31 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.30</td><td>1.30.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.30%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.30%20Azure/tests_status?style=svg" alt="Gardener v1.30 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.29</td><td>1.29.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.29%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.29%20Azure/tests_status?style=svg" alt="Gardener v1.29 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.28</td><td>1.28.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.28%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.28%20Azure/tests_status?style=svg" alt="Gardener v1.28 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.27</td><td>1.27.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.27%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.27%20Azure/tests_status?style=svg" alt="Gardener v1.27 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.26</td><td>1.26.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.26%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.26%20Azure/tests_status?style=svg" alt="Gardener v1.26 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.25</td><td>1.25.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.25%20Azure><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.25%20Azure/tests_status?style=svg" alt="Gardener v1.25 Conformance Tests"></a></td></tr></tbody></table><p>Please take a look <a href=/docs/gardener/shoot-operations/supported_k8s_versions/>here</a> to see which versions are supported by Gardener in general.</p><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>.</p><p>Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-provider-azure/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/04-new-core-gardener-cloud-apis.md>GEP-4 (New <code>core.gardener.cloud/v1beta1</code> API)</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-5e517440813fb72278dc8f9748dee579>1.3.1 - Tutorials</h1></div><div class=td-content><h1 id=pg-3c4c1c240f4879d50d22eaff0e08ebbe>1.3.1.1 - Create a Kubernetes Cluster on Azure with Gardener</h1><h3 id=overview>Overview<a class=td-heading-self-link href=#overview aria-label="Heading self-link"></a></h3><p>Gardener allows you to create a Kubernetes cluster on different infrastructure providers. This tutorial will guide you through the process of creating a cluster on Azure.</p><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><ul><li>You have created an <a href=https://azure.microsoft.com/en-us/>Azure account</a>.</li><li>You have access to the Gardener dashboard and have permissions to create projects.</li><li>You have an Azure Service Principal assigned to your subscription.</li></ul><h3 id=steps>Steps<a class=td-heading-self-link href=#steps aria-label="Heading self-link"></a></h3><ol><li><p>Go to the Gardener dashboard and create a <em>Project</em>.</p><img src=/__resources/new-gardener-project_524827.png></li><li><p>Get the properties of your Azure AD tenant, Subscription and Service Principal.</p><p>Before you can provision and access a Kubernetes cluster on Azure, you need to add the Azure service principal, AD tenant and subscription credentials in Gardener.
Gardener needs the credentials to provision and operate the Azure infrastructure for your Kubernetes cluster.</p><p><strong>Ensure that the Azure service principal has the actions defined within the <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-azure/azure-permissions/>Azure Permissions</a> within your Subscription assigned.
If no fine-grained permission/actions are required, then simply the built-in <code>Contributor</code> role can be assigned.</strong></p><ul><li><p>Tenant ID</p><p>To find your <code>TenantID</code>, follow this <a href=https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/how-to-find-tenant>guide</a>.</p></li><li><p>SubscriptionID</p><p>To find your <code>SubscriptionID</code>, search for and select <em>Subscriptions</em>.
<img src=/__resources/azure-select-subscription_e138b6.png></p><p>After that, copy the <code>SubscriptionID</code> from your subscription of choice.
<img src=/__resources/azure-choose-subscription_d79d28.png></p></li><li><p>Service Principal (SPN)</p><p>A service principal consist of a <code>ClientID</code> (also called <code>ApplicationID</code>) and a Client Secret. For more information, see <a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals>Application and service principal objects in Azure Active Directory</a>. You need to obtain the:</p><ul><li><p>Client ID</p><p>Access the <a href=https://portal.azure.com>Azure Portal</a> and navigate to the <em>Active Directory</em> service.
Within the service navigate to <em>App registrations</em> and select your service principal. Copy the <code>ClientID</code> you see there.</p></li><li><p>Client Secret</p><p>Secrets for the Azure Account/Service Principal can be generated/rotated via the Azure Portal.
After copying your <code>ClientID</code>, in the <em>Detail</em> view of your Service Principal navigate to <em>Certificates & secrets</em>. In the section, you can generate a new secret.</p></li></ul></li></ul></li><li><p>Choose <em>Secrets</em>, then the plus icon <img src=/__resources/plus-icon_df44c3.png> and select <em>Azure</em>.</p><img src=/__resources/create-secret-azure_cd3c81.png></li><li><p>Create your secret.</p><ol><li>Type the name of your secret.</li><li>Copy and paste the <code>TenantID</code>, <code>SubscriptionID</code> and the Service Principal credentials (<code>ClientID</code> and <code>ClientSecret</code>).</li><li>Choose <em>Add secret</em>.
<img src=/__resources/add-azure-secret_d9b7cf.png></li></ol><blockquote><p>After completing these steps, you should see your newly created secret in the <em>Infrastructure Secrets</em> section.</p></blockquote><img src=/__resources/secret-stored_6863bb.png></li><li><p>Register resource providers for your subscription.</p><ol><li>Go to your Azure dashboard</li><li>Navigate to <em>Subscriptions</em> -> &lt;your_subscription></li><li>Pick resource providers from the sidebar</li><li>Register microsoft.Network</li><li>Register microsoft.Compute</li></ol></li><li><p>To create a new cluster, choose <em>Clusters</em> and then the plus sign in the upper right corner.</p><img src=/__resources/new-cluster_88ec0e.png></li><li><p>In the <em>Create Cluster</em> section:</p><ol><li>Select <em>Azure</em> in the <em>Infrastructure</em> tab.</li><li>Type the name of your cluster in the <em>Cluster Details</em> tab.</li><li>Choose the secret you created before in the <em>Infrastructure Details</em> tab.</li><li>Choose <em>Create</em>.</li></ol><img src=/__resources/create-cluster_55c4a1.png></li><li><p>Wait for your cluster to get created.</p><img src=/__resources/processing-cluster_19a7da.png></li></ol><h3 id=result>Result<a class=td-heading-self-link href=#result aria-label="Heading self-link"></a></h3><p>After completing the steps in this tutorial, you will be able to see and download the kubeconfig of your cluster.</p><img src=/__resources/copy-kubeconfig_9889da.png></div><div class=td-content style=page-break-before:always><h1 id=pg-202c2224b11eca2eaad739b137e4db73>1.3.2 - Azure Permissions</h1><h1 id=azure-permissions>Azure Permissions<a class=td-heading-self-link href=#azure-permissions aria-label="Heading self-link"></a></h1><p>The following document describes the required Azure actions manage a Shoot cluster on Azure split by the different Azure provider/services.</p><p>Be aware some actions are just required if particilar deployment sceanrios or features e.g. bring your own vNet, use Azure-file, let the Shoot act as Seed etc. should be used.</p><h2 id=microsoftcompute><code>Microsoft.Compute</code><a class=td-heading-self-link href=#microsoftcompute aria-label="Heading self-link"></a></h2><pre tabindex=0><code># Required if a non zonal cluster based on Availability Set should be used.
Microsoft.Compute/availabilitySets/delete
Microsoft.Compute/availabilitySets/read
Microsoft.Compute/availabilitySets/write

# Required to let Kubernetes manage Azure disks.
Microsoft.Compute/disks/delete
Microsoft.Compute/disks/read
Microsoft.Compute/disks/write

# Required for to fetch meta information about disk and virtual machines sizes.
Microsoft.Compute/locations/diskOperations/read
Microsoft.Compute/locations/operations/read
Microsoft.Compute/locations/vmSizes/read

# Required if csi snapshot capabilities should be used and/or the Shoot should act as a Seed.
Microsoft.Compute/snapshots/delete
Microsoft.Compute/snapshots/read
Microsoft.Compute/snapshots/write

# Required to let Gardener/Machine-Controller-Manager manage the cluster nodes/machines.
Microsoft.Compute/virtualMachines/delete
Microsoft.Compute/virtualMachines/read
Microsoft.Compute/virtualMachines/start/action
Microsoft.Compute/virtualMachines/write

# Required if a non zonal cluster based on VMSS Flex (VMO) should be used.
Microsoft.Compute/virtualMachineScaleSets/delete
Microsoft.Compute/virtualMachineScaleSets/read
Microsoft.Compute/virtualMachineScaleSets/write
</code></pre><h2 id=microsoftmanagedidentity><code>Microsoft.ManagedIdentity</code><a class=td-heading-self-link href=#microsoftmanagedidentity aria-label="Heading self-link"></a></h2><pre tabindex=0><code># Required if a user provided Azure managed identity should attached to the cluster nodes.
Microsoft.ManagedIdentity/userAssignedIdentities/assign/action
Microsoft.ManagedIdentity/userAssignedIdentities/read
</code></pre><h2 id=microsoftmarketplaceordering><code>Microsoft.MarketplaceOrdering</code><a class=td-heading-self-link href=#microsoftmarketplaceordering aria-label="Heading self-link"></a></h2><pre tabindex=0><code># Required if nodes/machines should be created with images hosted on the Azure Marketplace.
Microsoft.MarketplaceOrdering/offertypes/publishers/offers/plans/agreements/read
Microsoft.MarketplaceOrdering/offertypes/publishers/offers/plans/agreements/write
</code></pre><h2 id=microsoftnetwork><code>Microsoft.Network</code><a class=td-heading-self-link href=#microsoftnetwork aria-label="Heading self-link"></a></h2><pre tabindex=0><code># Required to let Kubernetes manage services of type &#39;LoadBalancer&#39;.
Microsoft.Network/loadBalancers/backendAddressPools/join/action
Microsoft.Network/loadBalancers/delete
Microsoft.Network/loadBalancers/read
Microsoft.Network/loadBalancers/write

# Required in case the Shoot should use NatGateway(s).
Microsoft.Network/natGateways/delete
Microsoft.Network/natGateways/join/action
Microsoft.Network/natGateways/read
Microsoft.Network/natGateways/write

# Required to let Gardener/Machine-Controller-Manager manage the cluster nodes/machines.
Microsoft.Network/networkInterfaces/delete
Microsoft.Network/networkInterfaces/ipconfigurations/join/action
Microsoft.Network/networkInterfaces/ipconfigurations/read
Microsoft.Network/networkInterfaces/join/action
Microsoft.Network/networkInterfaces/read
Microsoft.Network/networkInterfaces/write

# Required to let Gardener maintain the basic infrastructure of the Shoot cluster and maintaing LoadBalancer services.
Microsoft.Network/networkSecurityGroups/delete
Microsoft.Network/networkSecurityGroups/join/action
Microsoft.Network/networkSecurityGroups/read
Microsoft.Network/networkSecurityGroups/write

# Required for managing LoadBalancers and NatGateways.
Microsoft.Network/publicIPAddresses/delete
Microsoft.Network/publicIPAddresses/join/action
Microsoft.Network/publicIPAddresses/read
Microsoft.Network/publicIPAddresses/write

# Required for managing the basic infrastructure of a cluster and maintaing LoadBalancer services.
Microsoft.Network/routeTables/delete
Microsoft.Network/routeTables/join/action
Microsoft.Network/routeTables/read
Microsoft.Network/routeTables/routes/delete
Microsoft.Network/routeTables/routes/read
Microsoft.Network/routeTables/routes/write
Microsoft.Network/routeTables/write

# Required to let Gardener maintain the basic infrastructure of the Shoot cluster.
# Only a subset is required for the bring your own vNet scenario.
Microsoft.Network/virtualNetworks/delete # not required for bring your own vnet
Microsoft.Network/virtualNetworks/read
Microsoft.Network/virtualNetworks/subnets/delete
Microsoft.Network/virtualNetworks/subnets/join/action
Microsoft.Network/virtualNetworks/subnets/read
Microsoft.Network/virtualNetworks/subnets/write
Microsoft.Network/virtualNetworks/write # not required for bring your own vnet
</code></pre><h2 id=microsoftresources><code>Microsoft.Resources</code><a class=td-heading-self-link href=#microsoftresources aria-label="Heading self-link"></a></h2><pre tabindex=0><code># Required to let Gardener maintain the basic infrastructure of the Shoot cluster.
Microsoft.Resources/subscriptions/resourceGroups/delete
Microsoft.Resources/subscriptions/resourceGroups/read
Microsoft.Resources/subscriptions/resourceGroups/write
</code></pre><h2 id=microsoftstorage><code>Microsoft.Storage</code><a class=td-heading-self-link href=#microsoftstorage aria-label="Heading self-link"></a></h2><pre tabindex=0><code># Required if Azure File should be used and/or if the Shoot should act as Seed.
Microsoft.Storage/operations/read
Microsoft.Storage/storageAccounts/blobServices/containers/delete
Microsoft.Storage/storageAccounts/blobServices/containers/read
Microsoft.Storage/storageAccounts/blobServices/containers/write
Microsoft.Storage/storageAccounts/blobServices/read
Microsoft.Storage/storageAccounts/delete
Microsoft.Storage/storageAccounts/listkeys/action
Microsoft.Storage/storageAccounts/read
Microsoft.Storage/storageAccounts/write
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-6e41468eb3f4f7e8baad8ac7246ce13a>1.3.3 - Deployment</h1><h1 id=deployment-of-the-azure-provider-extension>Deployment of the Azure provider extension<a class=td-heading-self-link href=#deployment-of-the-azure-provider-extension aria-label="Heading self-link"></a></h1><p><strong>Disclaimer:</strong> This document is NOT a step by step installation guide for the Azure provider extension and only contains some configuration specifics regarding the installation of different components via the helm charts residing in the Azure provider extension <a href=https://github.com/gardener/gardener-extension-provider-azure>repository</a>.</p><h2 id=gardener-extension-admission-azure>gardener-extension-admission-azure<a class=td-heading-self-link href=#gardener-extension-admission-azure aria-label="Heading self-link"></a></h2><h3 id=authentication-against-the-garden-cluster>Authentication against the Garden cluster<a class=td-heading-self-link href=#authentication-against-the-garden-cluster aria-label="Heading self-link"></a></h3><p>There are several authentication possibilities depending on whether or not <a href=https://github.com/gardener/garden-setup#concept-the-virtual-cluster>the concept of <em>Virtual Garden</em></a> is used.</p><h4 id=virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster><em>Virtual Garden</em> is not used, i.e., the <code>runtime</code> Garden cluster is also the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster aria-label="Heading self-link"></a></h4><p><strong>Automounted Service Account Token</strong>
The easiest way to deploy the <code>gardener-extension-admission-azure</code> component will be to not provide <code>kubeconfig</code> at all. This way in-cluster configuration and an automounted service account token will be used. The drawback of this approach is that the automounted token will not be automatically rotated.</p><h4 id=virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster><em>Virtual Garden</em> is used, i.e., the <code>runtime</code> Garden cluster is different from the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster aria-label="Heading self-link"></a></h4><p><strong>Service Account</strong>
The easiest way to setup the authentication will be to create a service account and the respective roles will be bound to this service account in the <code>target</code> cluster. Then use the generated service account token and craft a <code>kubeconfig</code> which will be used by the workload in the <code>runtime</code> cluster. This approach does not provide a solution for the rotation of the service account token. However, this setup can be achieved by setting <code>.Values.global.virtualGarden.enabled: true</code> and following these steps:</p><ol><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Get the service account token and craft the <code>kubeconfig</code>.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><p><strong>Client Certificate</strong>
Another solution will be to bind the roles in the <code>target</code> cluster to a <code>User</code> subject instead of a service account and use a client certificate for authentication. This approach does not provide a solution for the client certificate rotation. However, this setup can be achieved by setting both <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>, then following these steps:</p><ol><li>Generate a client certificate for the <code>target</code> cluster for the respective user.</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Craft a <code>kubeconfig</code> using the already generated client certificate.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-c8c8cf7fad861c906c48766068d4d640>1.3.4 - Local Setup</h1><h3 id=admission-azure>admission-azure<a class=td-heading-self-link href=#admission-azure aria-label="Heading self-link"></a></h3><p><code>admission-azure</code> is an admission webhook server which is responsible for the validation of the cloud provider (Azure in this case) specific fields and resources. The Gardener API server is cloud provider agnostic and it wouldn&rsquo;t be able to perform similar validation.</p><p>Follow the steps below to run the admission webhook server locally.</p><ol><li><p>Start the Gardener API server.</p><p>For details, check the Gardener <a href=/docs/gardener/local_setup/>local setup</a>.</p></li><li><p>Start the webhook server</p><p>Make sure that the <code>KUBECONFIG</code> environment variable is pointing to the local garden cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make start-admission
</span></span></code></pre></div></li><li><p>Setup the <code>ValidatingWebhookConfiguration</code>.</p><p><code>hack/dev-setup-admission-azure.sh</code> will configure the webhook Service which will allow the kube-apiserver of your local cluster to reach the webhook server. It will also apply the <code>ValidatingWebhookConfiguration</code> manifest.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./hack/dev-setup-admission-azure.sh
</span></span></code></pre></div></li></ol><p>You are now ready to experiment with the <code>admission-azure</code> webhook server locally.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a9331c43e98d69a160078331d2ea1788>1.3.5 - Operations</h1><h1 id=using-the-azure-provider-extension-with-gardener-as-an-operator>Using the Azure provider extension with Gardener as an operator<a class=td-heading-self-link href=#using-the-azure-provider-extension-with-gardener-as-an-operator aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/30-cloudprofile.yaml><code>core.gardener.cloud/v1beta1.CloudProfile</code> resource</a> declares a <code>providerConfig</code> field that is meant to contain provider-specific configuration.
The <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml><code>core.gardener.cloud/v1beta1.Seed</code> resource</a> is structured similarly.
Additionally, it allows configuring settings for the backups of the main etcds&rsquo; data of shoot clusters control planes running in this seed cluster.</p><p>This document explains the necessary configuration for the Azure provider extension.</p><h2 id=cloudprofile-resource><code>CloudProfile</code> resource<a class=td-heading-self-link href=#cloudprofile-resource aria-label="Heading self-link"></a></h2><p>This section describes, how the configuration for <code>CloudProfile</code>s looks like for Azure by providing an example <code>CloudProfile</code> manifest with minimal configuration that can be used to allow the creation of Azure shoot clusters.</p><h3 id=cloudprofileconfig><code>CloudProfileConfig</code><a class=td-heading-self-link href=#cloudprofileconfig aria-label="Heading self-link"></a></h3><p>The cloud profile configuration contains information about the real machine image IDs in the Azure environment (image <code>urn</code>, <code>id</code>, <code>communityGalleryImageID</code> or <code>sharedGalleryImageID</code>).
You have to map every version that you specify in <code>.spec.machineImages[].versions</code> to an available VM image in your subscription.
The VM image can be either from the <a href="https://azuremarketplace.microsoft.com/en-us/marketplace/apps?filters=virtual-machine-images">Azure Marketplace</a> and will then get identified via a <code>urn</code>, it can be a custom VM image from a shared image gallery and is then identified <code>sharedGalleryImageID</code>, or it can be from a community image gallery and is then identified by its <code>communityGalleryImageID</code>. You can use <code>id</code> field also to specifiy the image location in the azure compute gallery (in which case it would have a different kind of path) but it is not recommended as it sometimes faces problems in cross subscription image sharing.
For each machine image version an <code>architecture</code> field can be specified which specifies the CPU architecture of the machine on which given machine image can be used.</p><p>An example <code>CloudProfileConfig</code> for the Azure extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: CloudProfileConfig
</span></span><span style=display:flex><span>countUpdateDomains:
</span></span><span style=display:flex><span>- region: westeurope
</span></span><span style=display:flex><span>  count: 5
</span></span><span style=display:flex><span>countFaultDomains:
</span></span><span style=display:flex><span>- region: westeurope
</span></span><span style=display:flex><span>  count: 3
</span></span><span style=display:flex><span>machineTypes:
</span></span><span style=display:flex><span>- name: Standard_D3_v2
</span></span><span style=display:flex><span>  acceleratedNetworking: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>- name: Standard_X
</span></span><span style=display:flex><span>machineImages:
</span></span><span style=display:flex><span>- name: coreos
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>  - version: 2135.6.0
</span></span><span style=display:flex><span>    urn: <span style=color:#a31515>&#34;CoreOS:CoreOS:Stable:2135.6.0&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:green># architecture: amd64 # optional</span>
</span></span><span style=display:flex><span>    acceleratedNetworking: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>- name: myimage
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>  - version: 1.0.0
</span></span><span style=display:flex><span>    id: <span style=color:#a31515>&#34;/subscriptions/&lt;subscription ID where the gallery is located&gt;/resourceGroups/myGalleryRG/providers/Microsoft.Compute/galleries/myGallery/images/myImageDefinition/versions/1.0.0&#34;</span>
</span></span><span style=display:flex><span>- name: GardenLinuxCommunityImage
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>  - version: 1.0.0
</span></span><span style=display:flex><span>    communityGalleryImageID: <span style=color:#a31515>&#34;/CommunityGalleries/gardenlinux-567905d8-921f-4a85-b423-1fbf4e249d90/Images/gardenlinux/Versions/576.1.1&#34;</span>
</span></span><span style=display:flex><span>- name: SharedGalleryImageName
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>    - version: 1.0.0
</span></span><span style=display:flex><span>      sharedGalleryImageID: <span style=color:#a31515>&#34;/SharedGalleries/sharedGalleryName/Images/sharedGalleryImageName/Versions/sharedGalleryImageVersionName&#34;</span>
</span></span></code></pre></div><p>The cloud profile configuration contains information about the update via <code>.countUpdateDomains[]</code> and failure domain via <code>.countFaultDomains[]</code> counts in the Azure regions you want to offer.</p><p>The <code>.machineTypes[]</code> list contain provider specific information to the machine types e.g. if the machine type support <a href=https://docs.microsoft.com/en-us/azure/virtual-network/create-vm-accelerated-networking-cli>Azure Accelerated Networking</a>, see <code>.machineTypes[].acceleratedNetworking</code>.</p><p>Additionally, it contains the real machine image identifiers in the Azure environment. You can provide either URN for Azure Market Place images or id of <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/linux/shared-image-galleries>Shared Image Gallery</a> images.
When Shared Image Gallery is used, you have to ensure that the image is available in the desired regions and the end-user subscriptions have access to the image or to the whole gallery.
You have to map every version that you specify in <code>.spec.machineImages[].versions</code> here such that the Azure extension knows the machine image identifiers for every version you want to offer.
Furthermore, you can specify for each image version via <code>.machineImages[].versions[].acceleratedNetworking</code> if Azure Accelerated Networking is supported.</p><h3 id=example-cloudprofile-manifest>Example <code>CloudProfile</code> manifest<a class=td-heading-self-link href=#example-cloudprofile-manifest aria-label="Heading self-link"></a></h3><p>The possible values for <code>.spec.volumeTypes[].name</code> on Azure are <code>Standard_LRS</code>, <code>StandardSSD_LRS</code> and <code>Premium_LRS</code>. There is another volume type called <code>UltraSSD_LRS</code> but this type is not supported to use as os disk. If an end user select a volume type whose name is not equal to one of the valid values then the machine will be created with the default volume type which belong to the selected machine type. Therefore it is recommended to configure only the valid values for the <code>.spec.volumeType[].name</code> in the <code>CloudProfile</code>.</p><p>Please find below an example <code>CloudProfile</code> manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: CloudProfile
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: azure
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: azure
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 1.28.2
</span></span><span style=display:flex><span>    - version: 1.23.8
</span></span><span style=display:flex><span>      expirationDate: <span style=color:#a31515>&#34;2022-10-31T23:59:59Z&#34;</span>
</span></span><span style=display:flex><span>  machineImages:
</span></span><span style=display:flex><span>  - name: coreos
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 2135.6.0
</span></span><span style=display:flex><span>  machineTypes:
</span></span><span style=display:flex><span>  - name: Standard_D3_v2
</span></span><span style=display:flex><span>    cpu: <span style=color:#a31515>&#34;4&#34;</span>
</span></span><span style=display:flex><span>    gpu: <span style=color:#a31515>&#34;0&#34;</span>
</span></span><span style=display:flex><span>    memory: 14Gi
</span></span><span style=display:flex><span>  - name: Standard_D4_v3
</span></span><span style=display:flex><span>    cpu: <span style=color:#a31515>&#34;4&#34;</span>
</span></span><span style=display:flex><span>    gpu: <span style=color:#a31515>&#34;0&#34;</span>
</span></span><span style=display:flex><span>    memory: 16Gi
</span></span><span style=display:flex><span>  volumeTypes:
</span></span><span style=display:flex><span>  - name: Standard_LRS
</span></span><span style=display:flex><span>    class: standard
</span></span><span style=display:flex><span>    usable: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  - name: StandardSSD_LRS
</span></span><span style=display:flex><span>    class: premium
</span></span><span style=display:flex><span>    usable: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>  - name: Premium_LRS
</span></span><span style=display:flex><span>    class: premium
</span></span><span style=display:flex><span>    usable: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>  regions:
</span></span><span style=display:flex><span>  - name: westeurope
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: CloudProfileConfig
</span></span><span style=display:flex><span>    machineTypes:
</span></span><span style=display:flex><span>    - name: Standard_D3_v2
</span></span><span style=display:flex><span>      acceleratedNetworking: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    - name: Standard_D4_v3
</span></span><span style=display:flex><span>    countUpdateDomains:
</span></span><span style=display:flex><span>    - region: westeurope
</span></span><span style=display:flex><span>      count: 5
</span></span><span style=display:flex><span>    countFaultDomains:
</span></span><span style=display:flex><span>    - region: westeurope
</span></span><span style=display:flex><span>      count: 3
</span></span><span style=display:flex><span>    machineImages:
</span></span><span style=display:flex><span>    - name: coreos
</span></span><span style=display:flex><span>      versions:
</span></span><span style=display:flex><span>      - version: 2303.3.0
</span></span><span style=display:flex><span>        urn: CoreOS:CoreOS:Stable:2303.3.0
</span></span><span style=display:flex><span>        <span style=color:green># architecture: amd64 # optional</span>
</span></span><span style=display:flex><span>        acceleratedNetworking: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      - version: 2135.6.0
</span></span><span style=display:flex><span>        urn: <span style=color:#a31515>&#34;CoreOS:CoreOS:Stable:2135.6.0&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:green># architecture: amd64 # optional</span>
</span></span></code></pre></div><h2 id=seed-resource><code>Seed</code> resource<a class=td-heading-self-link href=#seed-resource aria-label="Heading self-link"></a></h2><p>This provider extension does not support any provider configuration for the <code>Seed</code>&rsquo;s <code>.spec.provider.providerConfig</code> field.
However, it supports managing of backup infrastructure, i.e., you can specify a configuration for the <code>.spec.backup</code> field.</p><h3 id=backup-configuration>Backup configuration<a class=td-heading-self-link href=#backup-configuration aria-label="Heading self-link"></a></h3><p>A Seed of type <code>azure</code> can be configured to perform backups for the main etcds&rsquo; of the shoot clusters control planes using Azure Blob storage.</p><p>The location/region where the backups will be stored defaults to the region of the Seed (<code>spec.provider.region</code>), but can also be explicitly configured via the field <code>spec.backup.region</code>.
The region of the backup can be different from where the Seed cluster is running.
However, usually it makes sense to pick the same region for the backup bucket as used for the Seed cluster.</p><p>Please find below an example <code>Seed</code> manifest (partly) that configures backups using Azure Blob storage.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Seed
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-seed
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: azure
</span></span><span style=display:flex><span>    region: westeurope
</span></span><span style=display:flex><span>  backup:
</span></span><span style=display:flex><span>    provider: azure
</span></span><span style=display:flex><span>    region: westeurope <span style=color:green># default region</span>
</span></span><span style=display:flex><span>    secretRef:
</span></span><span style=display:flex><span>      name: backup-credentials
</span></span><span style=display:flex><span>      namespace: garden
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>The referenced secret has to contain the provider credentials of the Azure subscription.
Please take a look <a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal>here</a> on how to create an Azure Application, Service Principle and how to obtain credentials.
The example below demonstrates how the secret has to look like.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: core-azure
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  clientID: base64(client-id)
</span></span><span style=display:flex><span>  clientSecret: base64(client-secret)
</span></span><span style=display:flex><span>  subscriptionID: base64(subscription-id)
</span></span><span style=display:flex><span>  tenantID: base64(tenant-id)
</span></span></code></pre></div><h4 id=permissions-for-azure-blob-storage>Permissions for Azure Blob storage<a class=td-heading-self-link href=#permissions-for-azure-blob-storage aria-label="Heading self-link"></a></h4><p>Please make sure the Azure application has the following IAM roles.</p><ul><li><a href=https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#contributor>Contributor</a></li></ul><h2 id=miscellaneous>Miscellaneous<a class=td-heading-self-link href=#miscellaneous aria-label="Heading self-link"></a></h2><h3 id=gardener-managed-service-principals>Gardener managed Service Principals<a class=td-heading-self-link href=#gardener-managed-service-principals aria-label="Heading self-link"></a></h3><p>The operators of the Gardener Azure extension can provide a list of managed service principals (technical users) that can be used for Azure Shoots.
This eliminates the need for users to provide own service principals for their clusters.</p><p>The user would need to grant the managed service principal access to their subscription with proper permissions.</p><p>As service principals are managed in an Azure Active Directory for each supported Active Directory, an own service principal needs to be provided.</p><p>In case the user provides an own service principal in the Shoot secret, this one will be used instead of the managed one provided by the operator.</p><p>Each managed service principal will be maintained in a <code>Secret</code> like that:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: service-principal-my-tenant
</span></span><span style=display:flex><span>  namespace: extension-provider-azure
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    azure.provider.extensions.gardener.cloud/purpose: tenant-service-principal-secret
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  tenantID: base64(my-tenant)
</span></span><span style=display:flex><span>  clientID: base64(my-service-princiapl-id)
</span></span><span style=display:flex><span>  clientSecret: base64(my-service-princiapl-secret)
</span></span><span style=display:flex><span>type: Opaque
</span></span></code></pre></div><p>The user needs to provide in its Shoot secret a <code>tenantID</code> and <code>subscriptionID</code>.</p><p>The managed service principal will be assigned based on the <code>tenantID</code>.
In case there is a managed service principal secret with a matching <code>tenantID</code>, this one will be used for the Shoot.
If there is no matching managed service principal secret then the next Shoot operation will fail.</p><p>One of the benefits of having managed service principals is that the operator controls the lifecycle of the service principal and can rotate its secrets.</p><p>After the service principal secret has been rotated and the corresponding secret is updated, all Shoot clusters using it need to be reconciled or the last operation to be retried.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-600730bb439495112133b52f5c68b64d>1.3.6 - Usage</h1><h1 id=using-the-azure-provider-extension-with-gardener-as-end-user>Using the Azure provider extension with Gardener as end-user<a class=td-heading-self-link href=#using-the-azure-provider-extension-with-gardener-as-end-user aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a few fields that are meant to contain provider-specific configuration.</p><p>This document describes the configurable options for Azure and provides an example <code>Shoot</code> manifest with minimal configuration that can be used to create an Azure cluster (modulo the landscape-specific information like cloud profile names, secret binding names, etc.).</p><h2 id=azure-provider-credentials>Azure Provider Credentials<a class=td-heading-self-link href=#azure-provider-credentials aria-label="Heading self-link"></a></h2><p>In order for Gardener to create a Kubernetes cluster using Azure infrastructure components, a Shoot has to provide credentials with sufficient permissions to the desired Azure subscription.
Every shoot cluster references a <code>SecretBinding</code> or a <code>CredentialsBinding</code> which itself references a <code>Secret</code>, and this <code>Secret</code> contains the provider credentials of the Azure subscription.
The <code>SecretBinding</code>/<code>CredentialsBinding</code> is configurable in the <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml>Shoot cluster</a> with the field <code>secretBindingName</code>/<code>credentialsBindingName</code>.</p><p>Create an <a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal>Azure Application and Service Principle</a> and obtain its credentials.</p><p>Please ensure that the Azure application (spn) has the IAM actions defined <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-azure/azure-permissions/>here</a> assigned.
If no fine-grained permissions/actions required then simply assign the <a href=https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#contributor>Contributor</a> role.</p><p>The example below demonstrates how the secret containing the client credentials of the Azure Application has to look like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: core-azure
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  clientID: base64(client-id)
</span></span><span style=display:flex><span>  clientSecret: base64(client-secret)
</span></span><span style=display:flex><span>  subscriptionID: base64(subscription-id)
</span></span><span style=display:flex><span>  tenantID: base64(tenant-id)
</span></span></code></pre></div><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>Depending on your API usage it can be problematic to reuse the same Service Principal for different Shoot clusters due to rate limits.
Please consider spreading your Shoots over Service Principals from different Azure subscriptions if you are hitting those limits.</p></blockquote><h3 id=managed-service-principals>Managed Service Principals<a class=td-heading-self-link href=#managed-service-principals aria-label="Heading self-link"></a></h3><p>The operators of the Gardener Azure extension can provide managed service principals.
This eliminates the need for users to provide an own service principal for a Shoot.</p><p>To make use of a managed service principal, the Azure secret of a Shoot cluster must contain only a <code>subscriptionID</code> and a <code>tenantID</code> field, but no <code>clientID</code> and <code>clientSecret</code>.
Removing those fields from the secret of an existing Shoot will also let it adopt the managed service principal.</p><p>Based on the <code>tenantID</code> field, the Gardener extension will try to assign the managed service principal to the Shoot.
If no managed service principal can be assigned then the next operation on the Shoot will fail.</p><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>The managed service principal need to be assigned to the users Azure subscription with proper permissions before using it.</p></blockquote><h3 id=azure-workload-identity-federation>Azure Workload Identity Federation<a class=td-heading-self-link href=#azure-workload-identity-federation aria-label="Heading self-link"></a></h3><p>Users can choose to trust Gardener&rsquo;s Workload Identity Issuer and eliminate the need for providing Azure credentials.</p><p>As a first step a resource of type <code>WorkloadIdentity</code> should be created in the Garden cluster and configured with the required Azure information.
This identity will be used by infrastructure components to authenticate against Azure APIs.
A sample of such resource is shown below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: security.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: WorkloadIdentity
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: azure
</span></span><span style=display:flex><span>  namespace: garden-myproj
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  audiences:
</span></span><span style=display:flex><span>  <span style=color:green># This is the audience that you configure during the creation of a federated credential</span>
</span></span><span style=display:flex><span>  - api://AzureADTokenExchange-my-application
</span></span><span style=display:flex><span>  targetSystem:
</span></span><span style=display:flex><span>    type: azure
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: WorkloadIdentityConfig
</span></span><span style=display:flex><span>      clientID: 00000000-0000-0000-0000-000000000001 <span style=color:green># This is the id of the application (client)</span>
</span></span><span style=display:flex><span>      tenantID: 00000000-0000-0000-0000-000000000002 <span style=color:green># This is the id of the directory (tenant)</span>
</span></span><span style=display:flex><span>      subscriptionID: 00000000-0000-0000-0000-000000000003 <span style=color:green># This is the id of the Azure subscription</span>
</span></span></code></pre></div><p>Once created the <code>WorkloadIdentity</code> will get its own id which will be used to form the subject of the said <code>WorkloadIdentity</code>.
The subject can be obtained by running the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n garden-myproj get wi azure -o=jsonpath={.status.sub}
</span></span></code></pre></div><p>As a second step users should configure <a href="https://learn.microsoft.com/en-us/entra/workload-id/workload-identity-federation-create-trust?pivots=identity-wif-apps-methods-azp#other-identity-providers">Workload Identity Federation</a> so that their application trusts Gardener&rsquo;s Workload Identity Issuer.
In the shown example a <code>WorkloadIdentity</code> with name <code>azure</code> with id <code>00000000-0000-0000-0000-000000000000</code> from the <code>garden-myproj</code> namespace will be trusted by the Azure application.</p><blockquote class="alert alert-important"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>message-outline</title><path d="M20 2H4C2.9 2 2 2.9 2 4V22l4-4H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2m0 14H5.2L4 17.2V4H20V16z"/></svg><p>Important</p></div><p>You should replace the subject indentifier in the example below with the subject that is populated in the status of the <code>WorkloadIdentity</code>, obtained in a previous step.</p></blockquote><p><img src=/__resources/federated_credential_a0d5bd.png alt="Federated Credential"></p><p>Please ensure that the Azure application (spn) has the proper <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-azure/azure-permissions/>IAM actions</a> assigned.
If no fine-grained permissions/actions required then simply assign the <a href=https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#contributor>Contributor</a> role.</p><h2 id=infrastructureconfig><code>InfrastructureConfig</code><a class=td-heading-self-link href=#infrastructureconfig aria-label="Heading self-link"></a></h2><p>The infrastructure configuration mainly describes how the network layout looks like in order to create the shoot worker nodes in a later step, thus, prepares everything relevant to create VMs, load balancers, volumes, etc.</p><p>An example <code>InfrastructureConfig</code> for the Azure extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: InfrastructureConfig
</span></span><span style=display:flex><span>networks:
</span></span><span style=display:flex><span>  vnet: <span style=color:green># specify either &#39;name&#39; and &#39;resourceGroup&#39; or &#39;cidr&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:green># name: my-vnet</span>
</span></span><span style=display:flex><span>    <span style=color:green># resourceGroup: my-vnet-resource-group</span>
</span></span><span style=display:flex><span>    cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>    <span style=color:green># ddosProtectionPlanID: /subscriptions/test/resourceGroups/test/providers/Microsoft.Network/ddosProtectionPlans/test-ddos-protection-plan</span>
</span></span><span style=display:flex><span>  workers: 10.250.0.0/19
</span></span><span style=display:flex><span>  <span style=color:green># natGateway:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   enabled: false</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   idleConnectionTimeoutMinutes: 4</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   zone: 1</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   ipAddresses:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   - name: my-public-ip-name</span>
</span></span><span style=display:flex><span>  <span style=color:green>#     resourceGroup: my-public-ip-resource-group</span>
</span></span><span style=display:flex><span>  <span style=color:green>#     zone: 1</span>
</span></span><span style=display:flex><span>  <span style=color:green># serviceEndpoints:</span>
</span></span><span style=display:flex><span>  <span style=color:green># - Microsoft.Test</span>
</span></span><span style=display:flex><span>  <span style=color:green># zones:</span>
</span></span><span style=display:flex><span>  <span style=color:green># - name: 1</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   cidr: &#34;10.250.0.0/24</span>
</span></span><span style=display:flex><span>  <span style=color:green># - name: 2</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   cidr: &#34;10.250.0.0/24&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   natGateway:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#     enabled: false</span>
</span></span><span style=display:flex><span>zoned: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span><span style=color:green># resourceGroup:</span>
</span></span><span style=display:flex><span><span style=color:green>#   name: mygroup</span>
</span></span><span style=display:flex><span><span style=color:green>#identity:</span>
</span></span><span style=display:flex><span><span style=color:green>#  name: my-identity-name</span>
</span></span><span style=display:flex><span><span style=color:green>#  resourceGroup: my-identity-resource-group</span>
</span></span><span style=display:flex><span><span style=color:green>#  acrAccess: true</span>
</span></span></code></pre></div><p>Currently, it&rsquo;s not yet possible to deploy into existing resource groups.
The <code>.resourceGroup.name</code> field will allow specifying the name of an already existing resource group that the shoot cluster and all infrastructure resources will be deployed to.</p><p>Via the <code>.zoned</code> boolean you can tell whether you want to use Azure availability zones or not.
If you didn&rsquo;t use zones in the past then an availability set was created and only basic load balancers were used.
Now VMSS-FLex (VMO) has become the default also for non-zonal clusters and only standard load balancers are used.</p><p>The <code>networks.vnet</code> section describes whether you want to create the shoot cluster in an already existing VNet or whether to create a new one:</p><ul><li>If <code>networks.vnet.name</code> and <code>networks.vnet.resourceGroup</code> are given then you have to specify the VNet name and VNet resource group name of the existing VNet that was created by other means (manually, other tooling, &mldr;).</li><li>If <code>networks.vnet.cidr</code> is given then you have to specify the VNet CIDR of a new VNet that will be created during shoot creation.
You can freely choose a private CIDR range.</li><li>Either <code>networks.vnet.name</code> and <code>neworks.vnet.resourceGroup</code> or <code>networks.vnet.cidr</code> must be present, but not both at the same time.</li><li>The <code>networks.vnet.ddosProtectionPlanID</code> field can be used to specify the id of a ddos protection plan which should be assigned to the VNet. This will only work for a VNet managed by Gardener. For externally managed VNets the ddos protection plan must be assigned by other means.</li><li>If a vnet name is given and cilium shoot clusters are created without a network overlay within one vnet make sure that the pod CIDR specified in <code>shoot.spec.networking.pods</code> is not overlapping with any other pod CIDR used in that vnet.
Overlapping pod CIDRs will lead to disfunctional shoot clusters.</li><li>It&rsquo;s possible to place multiple shoot cluster into the same vnet</li></ul><p>The <code>networks.workers</code> section describes the CIDR for a subnet that is used for all shoot worker nodes, i.e., VMs which later run your applications.
The specified CIDR range must be contained in the VNet CIDR specified above, or the VNet CIDR of your already existing VNet.
You can freely choose this CIDR and it is your responsibility to properly design the network layout to suit your needs.</p><p>In the <code>networks.serviceEndpoints[]</code> list you can specify the list of Azure service endpoints which shall be associated with the worker subnet. All available service endpoints and their technical names can be found in the (Azure Service Endpoint documentation](<a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview>https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview</a>).</p><p>The <code>networks.natGateway</code> section contains configuration for the Azure NatGateway which can be attached to the worker subnet of a Shoot cluster. Here are some key information about the usage of the NatGateway for a Shoot cluster:</p><ul><li>NatGateway usage is optional and can be enabled or disabled via <code>.networks.natGateway.enabled</code>.</li><li>If the NatGateway is not used then the egress connections initiated within the Shoot cluster will be nated via the LoadBalancer of the clusters (default Azure behaviour, see <a href=https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-outbound-connections#scenarios>here</a>).</li><li>NatGateway is only available for zonal clusters <code>.zoned=true</code>.</li><li>The NatGateway is currently <strong>not</strong> zone redundantly deployed. That mean the NatGateway of a Shoot cluster will always be in just one zone. This zone can be optionally selected via <code>.networks.natGateway.zone</code>.</li><li><strong>Caution:</strong> Modifying the <code>.networks.natGateway.zone</code> setting requires a recreation of the NatGateway and the managed public ip (automatically used if no own public ip is specified, see below). That mean you will most likely get a different public ip for egress connections.</li><li>It is possible to bring own zonal public ip(s) via <code>networks.natGateway.ipAddresses</code>. Those public ip(s) need to be in the same zone as the NatGateway (see <code>networks.natGateway.zone</code>) and be of SKU <code>standard</code>. For each public ip the <code>name</code>, the <code>resourceGroup</code> and the <code>zone</code> need to be specified.</li><li>The field <code>networks.natGateway.idleConnectionTimeoutMinutes</code> allows the configuration of NAT Gateway&rsquo;s idle connection timeout property. The idle timeout value can be adjusted from 4 minutes, up to 120 minutes. Omitting this property will set the idle timeout to its default value according to <a href=https://docs.microsoft.com/en-us/azure/virtual-network/nat-gateway-resource#timers>NAT Gateway&rsquo;s documentation</a>.</li></ul><p>In the <code>identity</code> section you can specify an <a href=https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview#how-does-the-managed-identities-for-azure-resources-work>Azure user-assigned managed identity</a> which should be attached to all cluster worker machines. With <code>identity.name</code> you can specify the name of the identity and with <code>identity.resourceGroup</code> you can specify the resource group which contains the identity resource on Azure. The identity need to be created by the user upfront (manually, other tooling, &mldr;). Gardener/Azure Extension will only use the referenced one and won&rsquo;t create an identity. Furthermore the identity have to be in the same subscription as the Shoot cluster. Via the <code>identity.acrAccess</code> you can configure the worker machines to use the passed identity for pulling from an <a href=https://docs.microsoft.com/en-us/azure/container-registry/container-registry-intro>Azure Container Registry (ACR)</a>.
<strong>Caution:</strong> Adding, exchanging or removing the identity will require a rolling update of all worker machines in the Shoot cluster.</p><p>Apart from the VNet and the worker subnet the Azure extension will also create a dedicated resource group, route tables, security groups, and an availability set (if not using zoned clusters).</p><h3 id=infrastructureconfig-with-dedicated-subnets-per-zone>InfrastructureConfig with dedicated subnets per zone<a class=td-heading-self-link href=#infrastructureconfig-with-dedicated-subnets-per-zone aria-label="Heading self-link"></a></h3><p>Another deployment option <strong>for zonal clusters only</strong>, is to create and configure a separate subnet per availability zone. This network layout is recommended to users that require fine-grained control over their network setup. One prevalent usecase is to create a zone-redundant NAT Gateway deployment by taking advantage of the ability to deploy separate NAT Gateways for each subnet.</p><p>To use this configuration the following requirements must be met:</p><ul><li>the <code>zoned</code> field must be set to <code>true</code>.</li><li>the <code>networks.vnet</code> section must not be empty and must contain a valid configuration. For existing clusters that were not using the <code>networks.vnet</code> section, it is enough if <code>networks.vnet.cidr</code> field is set to the current <code>networks.worker</code> value.</li></ul><p>For each of the target zones a subnet CIDR range must be specified. The specified CIDR range must be contained in the VNet CIDR specified above, or the VNet CIDR of your already existing VNet. In addition, the CIDR ranges must not overlap with the ranges of the other subnets.</p><p><em>ServiceEndpoints</em> and <em>NatGateways</em> can be configured per subnet. Respectively, when <code>networks.zones</code> is specified, the fields <code>networks.workers</code>, <code>networks.serviceEndpoints</code> and <code>networks.natGateway</code> cannot be set. All the configuration for the subnets must be done inside the respective zone&rsquo;s configuration.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: InfrastructureConfig
</span></span><span style=display:flex><span>networks:
</span></span><span style=display:flex><span>  zoned: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  vnet: <span style=color:green># specify either &#39;name&#39; and &#39;resourceGroup&#39; or &#39;cidr&#39;</span>
</span></span><span style=display:flex><span>    cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>  zones:
</span></span><span style=display:flex><span>  - name: 1
</span></span><span style=display:flex><span>    cidr: <span style=color:#a31515>&#34;10.250.0.0/24&#34;</span>
</span></span><span style=display:flex><span>  - name: 2
</span></span><span style=display:flex><span>    cidr: <span style=color:#a31515>&#34;10.250.0.0/24&#34;</span>
</span></span><span style=display:flex><span>    natGateway:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>false</span>
</span></span></code></pre></div><h3 id=migrating-to-zonal-shoots-with-dedicated-subnets-per-zone>Migrating to zonal shoots with dedicated subnets per zone<a class=td-heading-self-link href=#migrating-to-zonal-shoots-with-dedicated-subnets-per-zone aria-label="Heading self-link"></a></h3><p>For existing zonal clusters it is possible to migrate to a network layout with dedicated subnets per zone. The migration works by creating additional network resources as specified in the configuration and progressively roll part of your existing nodes to use the new resources. To achieve the controlled rollout of your nodes, parts of the existing infrastructure must be preserved which is why the following constraint is imposed:</p><p>One of your specified zones must have the exact same CIDR range as the current <code>network.workers</code> field. Here is an example of such migration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>infrastructureConfig:
</span></span><span style=display:flex><span>  apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: InfrastructureConfig
</span></span><span style=display:flex><span>  networks:
</span></span><span style=display:flex><span>    vnet:
</span></span><span style=display:flex><span>      cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>    workers: 10.250.0.0/19
</span></span><span style=display:flex><span>  zoned: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>to</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>infrastructureConfig:
</span></span><span style=display:flex><span>  apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: InfrastructureConfig
</span></span><span style=display:flex><span>  networks:
</span></span><span style=display:flex><span>    vnet:
</span></span><span style=display:flex><span>      cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>    zones:
</span></span><span style=display:flex><span>      - name: 3
</span></span><span style=display:flex><span>        cidr: 10.250.0.0/19 <span style=color:green># note the preservation of the &#39;workers&#39; CIDR</span>
</span></span><span style=display:flex><span><span style=color:green># optionally add other zones</span>
</span></span><span style=display:flex><span>    <span style=color:green># - name: 2</span>
</span></span><span style=display:flex><span>    <span style=color:green>#   cidr: 10.250.32.0/19</span>
</span></span><span style=display:flex><span>    <span style=color:green>#   natGateway:</span>
</span></span><span style=display:flex><span>    <span style=color:green>#     enabled: true</span>
</span></span><span style=display:flex><span>  zoned: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>Another more advanced example with user-provided public IP addresses for the NAT Gateway and how it can be migrated:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>infrastructureConfig:
</span></span><span style=display:flex><span>  apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: InfrastructureConfig
</span></span><span style=display:flex><span>  networks:
</span></span><span style=display:flex><span>    vnet:
</span></span><span style=display:flex><span>      cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>    workers: 10.250.0.0/19
</span></span><span style=display:flex><span>    natGateway:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      zone: 1
</span></span><span style=display:flex><span>      ipAddresses:
</span></span><span style=display:flex><span>        - name: pip1
</span></span><span style=display:flex><span>          resourceGroup: group
</span></span><span style=display:flex><span>          zone: 1
</span></span><span style=display:flex><span>        - name: pip2
</span></span><span style=display:flex><span>          resourceGroup: group
</span></span><span style=display:flex><span>          zone: 1
</span></span><span style=display:flex><span>  zoned: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>to</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>infrastructureConfig:
</span></span><span style=display:flex><span>  apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: InfrastructureConfig
</span></span><span style=display:flex><span>  zoned: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  networks:
</span></span><span style=display:flex><span>    vnet:
</span></span><span style=display:flex><span>      cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>    zones:
</span></span><span style=display:flex><span>      - name: 1
</span></span><span style=display:flex><span>        cidr: 10.250.0.0/19 <span style=color:green># note the preservation of the &#39;workers&#39; CIDR</span>
</span></span><span style=display:flex><span>        natGateway:
</span></span><span style=display:flex><span>          enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>          ipAddresses:
</span></span><span style=display:flex><span>            - name: pip1
</span></span><span style=display:flex><span>              resourceGroup: group
</span></span><span style=display:flex><span>              zone: 1
</span></span><span style=display:flex><span>            - name: pip2
</span></span><span style=display:flex><span>              resourceGroup: group
</span></span><span style=display:flex><span>              zone: 1
</span></span><span style=display:flex><span><span style=color:green># optionally add other zones</span>
</span></span><span style=display:flex><span><span style=color:green>#     - name: 2</span>
</span></span><span style=display:flex><span><span style=color:green>#       cidr: 10.250.32.0/19</span>
</span></span><span style=display:flex><span><span style=color:green>#       natGateway:</span>
</span></span><span style=display:flex><span><span style=color:green>#         enabled: true</span>
</span></span><span style=display:flex><span><span style=color:green>#         ipAddresses:</span>
</span></span><span style=display:flex><span><span style=color:green>#           - name: pip3</span>
</span></span><span style=display:flex><span><span style=color:green>#             resourceGroup: group</span>
</span></span></code></pre></div><p>You can apply such change to your shoot by issuing a <code>kubectl patch</code> command to replace your current <code>.spec.provider.infrastructureConfig</code> section:</p><pre tabindex=0><code>$ cat new-infra.json

[
  {
    &#34;op&#34;: &#34;replace&#34;,
    &#34;path&#34;: &#34;/spec/provider/infrastructureConfig&#34;,
    &#34;value&#34;: {
      &#34;apiVersion&#34;: &#34;azure.provider.extensions.gardener.cloud/v1alpha1&#34;,
      &#34;kind&#34;: &#34;InfrastructureConfig&#34;,
      &#34;networks&#34;: {
        &#34;vnet&#34;: {
          &#34;cidr&#34;: &#34;&lt;your-vnet-cidr&gt;&#34;
        },
        &#34;zones&#34;: [
          {
            &#34;name&#34;: 1,
            &#34;cidr&#34;: &#34;10.250.0.0/24&#34;,
            &#34;natGateway&#34;: {
              &#34;enabled&#34;: true
            }
          },
          {
            &#34;name&#34;: 1,
            &#34;cidr&#34;: &#34;10.250.1.0/24&#34;,
            &#34;natGateway&#34;: {
              &#34;enabled&#34;: true
            }
          },
        ]
      },
      &#34;zoned&#34;: true
    }
  }
]

kubectl patch --type=&#34;json&#34; --patch-file new-infra.json shoot &lt;my-shoot&gt;
</code></pre><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>The migration to shoots with dedicated subnets per zone is a one-way process. Reverting the shoot to the previous configuration is not supported.
During the migration a subset of the nodes will be rolled to the new subnets.</p></blockquote><h2 id=controlplaneconfig><code>ControlPlaneConfig</code><a class=td-heading-self-link href=#controlplaneconfig aria-label="Heading self-link"></a></h2><p>The control plane configuration mainly contains values for the Azure-specific control plane components.
Today, the only component deployed by the Azure extension is the <code>cloud-controller-manager</code>.</p><p>An example <code>ControlPlaneConfig</code> for the Azure extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: ControlPlaneConfig
</span></span><span style=display:flex><span>cloudControllerManager:
</span></span><span style=display:flex><span><span style=color:green># featureGates:</span>
</span></span><span style=display:flex><span><span style=color:green>#   SomeKubernetesFeature: true</span>
</span></span></code></pre></div><p>The <code>cloudControllerManager.featureGates</code> contains a map of explicitly enabled or disabled feature gates.
For production usage it&rsquo;s not recommend to use this field at all as you can enable alpha features or disable beta/stable features, potentially impacting the cluster stability.
If you don&rsquo;t want to configure anything for the <code>cloudControllerManager</code> simply omit the key in the YAML specification.</p><p><code>storage</code> contains options for storage-related control plane component.
<code>storage.managedDefaultStorageClass</code> is enabled by default and will deploy a <code>storageClass</code> and mark it as a default (via the <code>storageclass.kubernetes.io/is-default-class</code> annotation)
<code>storage.managedDefaultVolumeSnapshotClass</code> is enabled by default and will deploy a <code>volumeSnapshotClass</code> and mark it as a default (via the <code>snapshot.storage.kubernetes.io/is-default-classs</code> annotation)
In case you want to manage your own default <code>storageClass</code> or <code>volumeSnapshotClass</code> you need to disable the respective options above, otherwise reconciliation of the controlplane may fail.</p><h2 id=workerconfig><code>WorkerConfig</code><a class=td-heading-self-link href=#workerconfig aria-label="Heading self-link"></a></h2><p>The Azure extension supports encryption for volumes plus support for additional data volumes per machine.
Please note that you cannot specify the <code>encrypted</code> flag for Azure disks as they are encrypted by default/out-of-the-box.
For each data volume, you have to specify a name.
The following YAML is a snippet of a <code>Shoot</code> resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: cpu-worker
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        type: Standard_LRS
</span></span><span style=display:flex><span>        size: 20Gi
</span></span><span style=display:flex><span>      dataVolumes:
</span></span><span style=display:flex><span>      - name: kubelet-dir
</span></span><span style=display:flex><span>        type: Standard_LRS
</span></span><span style=display:flex><span>        size: 25Gi
</span></span></code></pre></div><p>Additionally, it supports for other Azure-specific values and could be configured under <code>.spec.provider.workers[].providerConfig</code></p><p>An example <code>WorkerConfig</code> for the Azure extension looks like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: WorkerConfig
</span></span><span style=display:flex><span>nodeTemplate: <span style=color:green># (to be specified only if the node capacity would be different from cloudprofile info during runtime)</span>
</span></span><span style=display:flex><span>  capacity:
</span></span><span style=display:flex><span>    cpu: 2
</span></span><span style=display:flex><span>    gpu: 1
</span></span><span style=display:flex><span>    memory: 50Gi
</span></span><span style=display:flex><span>diagnosticsProfile:
</span></span><span style=display:flex><span>  enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  <span style=color:green># storageURI: https://&lt;storage-account-name&gt;.blob.core.windows.net/</span>
</span></span><span style=display:flex><span>dataVolumes:
</span></span><span style=display:flex><span>  - name: test-image
</span></span><span style=display:flex><span>    imageRef:
</span></span><span style=display:flex><span>      communityGalleryImageID: /CommunityGalleries/gardenlinux-13e998fe-534d-4b0a-8a27-f16a73aef620/Images/gardenlinux/Versions/1443.10.0
</span></span><span style=display:flex><span>      <span style=color:green># sharedGalleryImageID: /SharedGalleries/82fc46df-cc38-4306-9880-504e872cee18-VSMP_MEMORYONE_GALLERY/Images/vSMP_MemoryONE/Versions/1062800168.0.0</span>
</span></span><span style=display:flex><span>      <span style=color:green># id: /Subscriptions/2ebd38b6-270b-48a2-8e0b-2077106dc615/Providers/Microsoft.Compute/Locations/westeurope/Publishers/sap/ArtifactTypes/VMImage/Offers/gardenlinux/Skus/greatest/Versions/1443.10.0</span>
</span></span><span style=display:flex><span>      <span style=color:green># urn: sap:gardenlinux:greatest:1443.10.0</span>
</span></span></code></pre></div><p>The <code>.nodeTemplate</code> is used to specify resource information of the machine during runtime. This then helps in Scale-from-Zero.
Some points to note for this field:</p><ul><li>Currently only cpu, gpu and memory are configurable.</li><li>a change in the value lead to a rolling update of the machine in the worker pool</li><li>all the resources needs to be specified</li></ul><p>The <code>.diagnosticsProfile</code> is used to enable <a href=https://learn.microsoft.com/en-us/azure/virtual-machines/boot-diagnostics>machine boot diagnostics</a> (disabled per default).
A storage account is used for storing vm&rsquo;s boot console output and screenshots.
If <code>.diagnosticsProfile.StorageURI</code> is not specified azure managed storage will be used (recommended way).</p><p>The <code>.dataVolumes</code> field is used to add provider specific configurations for dataVolumes.
<code>.dataVolumes[].name</code> must match with one of the names in <code>workers.dataVolumes[].name</code>.
To specify an image source for the dataVolume either use <code>communityGalleryImageID</code>, <code>sharedGalleryImageID</code>, <code>id</code> or <code>urn</code> as <code>imageRef</code>.
However, users have to make sure that the image really exists, there&rsquo;s yet no check in place.
If the image does not exist the machine will get stuck in creation.</p><h2 id=example-shoot-manifest-non-zoned>Example <code>Shoot</code> manifest (non-zoned)<a class=td-heading-self-link href=#example-shoot-manifest-non-zoned aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest for a non-zoned cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-azure
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfile:
</span></span><span style=display:flex><span>    name: azure
</span></span><span style=display:flex><span>  region: westeurope
</span></span><span style=display:flex><span>  secretBindingName: core-azure
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: azure
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vnet:
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>        workers: 10.250.0.0/19
</span></span><span style=display:flex><span>      zoned: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: Standard_D4_v3
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: Standard_LRS
</span></span><span style=display:flex><span><span style=color:green>#      providerConfig:</span>
</span></span><span style=display:flex><span><span style=color:green>#        apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:green>#        kind: WorkerConfig</span>
</span></span><span style=display:flex><span><span style=color:green>#        nodeTemplate: # (to be specified only if the node capacity would be different from cloudprofile info during runtime)</span>
</span></span><span style=display:flex><span><span style=color:green>#          capacity:</span>
</span></span><span style=display:flex><span><span style=color:green>#            cpu: 2</span>
</span></span><span style=display:flex><span><span style=color:green>#            gpu: 1</span>
</span></span><span style=display:flex><span><span style=color:green>#            memory: 50Gi</span>
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>    pods: 100.96.0.0/11
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    services: 100.64.0.0/13
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.2
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=example-shoot-manifest-zoned>Example <code>Shoot</code> manifest (zoned)<a class=td-heading-self-link href=#example-shoot-manifest-zoned aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest for a zoned cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-azure
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfile:
</span></span><span style=display:flex><span>    name: azure
</span></span><span style=display:flex><span>  region: westeurope
</span></span><span style=display:flex><span>  secretBindingName: core-azure
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: azure
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vnet:
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>        workers: 10.250.0.0/19
</span></span><span style=display:flex><span>      zoned: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: Standard_D4_v3
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: Standard_LRS
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - <span style=color:#a31515>&#34;1&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#a31515>&#34;2&#34;</span>
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>    pods: 100.96.0.0/11
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    services: 100.64.0.0/13
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.2
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=example-shoot-manifest-zoned-with-nat-gateways-per-zone>Example <code>Shoot</code> manifest (zoned with NAT Gateways per zone)<a class=td-heading-self-link href=#example-shoot-manifest-zoned-with-nat-gateways-per-zone aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest for a zoned cluster using NAT Gateways per zone:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-azure
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfile:
</span></span><span style=display:flex><span>    name: azure
</span></span><span style=display:flex><span>  region: westeurope
</span></span><span style=display:flex><span>  secretBindingName: core-azure
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: azure
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vnet:
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>        zones:
</span></span><span style=display:flex><span>        - name: 1
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/24
</span></span><span style=display:flex><span>          serviceEndpoints:
</span></span><span style=display:flex><span>          - Microsoft.Storage
</span></span><span style=display:flex><span>          - Microsoft.Sql
</span></span><span style=display:flex><span>          natGateway:
</span></span><span style=display:flex><span>            enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>            idleConnectionTimeoutMinutes: 4
</span></span><span style=display:flex><span>        - name: 2
</span></span><span style=display:flex><span>          cidr: 10.250.1.0/24
</span></span><span style=display:flex><span>          serviceEndpoints:
</span></span><span style=display:flex><span>          - Microsoft.Storage
</span></span><span style=display:flex><span>          - Microsoft.Sql
</span></span><span style=display:flex><span>          natGateway:
</span></span><span style=display:flex><span>            enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      zoned: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: Standard_D4_v3
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: Standard_LRS
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - <span style=color:#a31515>&#34;1&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#a31515>&#34;2&#34;</span>
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>    pods: 100.96.0.0/11
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    services: 100.64.0.0/13
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.2
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=csi-volume-provisioners>CSI volume provisioners<a class=td-heading-self-link href=#csi-volume-provisioners aria-label="Heading self-link"></a></h2><p>Every Azure shoot cluster will be deployed with the Azure Disk CSI driver and the Azure File CSI driver.</p><h2 id=kubernetes-versions-per-worker-pool>Kubernetes Versions per Worker Pool<a class=td-heading-self-link href=#kubernetes-versions-per-worker-pool aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>WorkerPoolKubernetesVersion</code> feature gate, i.e., having <a href=https://github.com/gardener/gardener/blob/8a9c88866ec5fce59b5acf57d4227eeeb73669d7/example/90-shoot.yaml#L69-L70>worker pools with overridden Kubernetes versions</a> since <code>gardener-extension-provider-azure@v1.25</code>.</p><h2 id=shoot-ca-certificate-and-serviceaccount-signing-key-rotation>Shoot CA Certificate and <code>ServiceAccount</code> Signing Key Rotation<a class=td-heading-self-link href=#shoot-ca-certificate-and-serviceaccount-signing-key-rotation aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>ShootCARotation</code> and <code>ShootSARotation</code> feature gates since <code>gardener-extension-provider-azure@v1.28</code>.</p><h2 id=miscellaneous>Miscellaneous<a class=td-heading-self-link href=#miscellaneous aria-label="Heading self-link"></a></h2><h3 id=azure-accelerated-networking>Azure Accelerated Networking<a class=td-heading-self-link href=#azure-accelerated-networking aria-label="Heading self-link"></a></h3><p>All worker machines of the cluster will be automatically configured to use <a href=https://docs.microsoft.com/en-us/azure/virtual-network/create-vm-accelerated-networking-cli>Azure Accelerated Networking</a> if the prerequisites are fulfilled.
The prerequisites are that the cluster must be zoned, and the used machine type and operating system image version are compatible for Accelerated Networking.
<code>Availability Set</code> based shoot clusters will not be enabled for accelerated networking even if the machine type and operating system support it, this is necessary because all machines from the availability set must be scheduled on special hardware, more details can be found <a href=https://github.com/MicrosoftDocs/azure-docs/issues/10536>here</a>.
Supported machine types are listed in the CloudProfile in <code>.spec.providerConfig.machineTypes[].acceleratedNetworking</code> and the supported operating system image versions are defined in <code>.spec.providerConfig.machineImages[].versions[].acceleratedNetworking</code>.</p><h3 id=support-for-other-azure-instances>Support for other Azure instances<a class=td-heading-self-link href=#support-for-other-azure-instances aria-label="Heading self-link"></a></h3><p>The provider extension can be configured to connect to Azure instances other than the public one by providing additional configuration in the CloudProfile:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  …
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: CloudProfileConfig
</span></span><span style=display:flex><span>    cloudConfiguration:
</span></span><span style=display:flex><span>      name: AzurePublic <span style=color:green># AzurePublic | AzureGovernment | AzureChina</span>
</span></span><span style=display:flex><span>    machineTypes:
</span></span><span style=display:flex><span>      …
</span></span><span style=display:flex><span>    …
</span></span><span style=display:flex><span>  …
</span></span></code></pre></div><p>If no configuration is specified the extension will default to the public instance.
Azure instances other than <code>AzurePublic</code>, <code>AzureGovernment</code>, or <code>AzureChina</code> are not supported at this time.</p><h3 id=disabling-the-automatic-deployment-of-allow-tcpudp-loadbalancer-services>Disabling the automatic deployment of <code>allow-{tcp,udp} loadbalancer services</code><a class=td-heading-self-link href=#disabling-the-automatic-deployment-of-allow-tcpudp-loadbalancer-services aria-label="Heading self-link"></a></h3><p>Using the <code>azure-cloud-controller-manager</code> when a user first creates a loadbalancer service in the cluster, a new Load Balancer is created in Azure and all nodes of the cluster are registered as backend.
When a NAT Gateway is not used, then this Load Balancer is used as a NAT device for outbound traffic by using one of the registered FrontendIPs assigned to the k8s LB service.
In cases where a NATGateway is not used, <code>provider-azure</code> will deploy by default a set of 2 Load Balancer services in the <code>kube-system</code>.
These are responsible for allowing outbound traffic in all cases for UDP and TCP.</p><p>There is a way for users to disable the deployment of these additional LBs by using the <code>azure.provider.extensions.gardener.cloud/skip-allow-egress="true"</code> annotation on their shoot.
[!WARNING]
Disabling the system Load Balancers may affect the outbound of your shoot.
Before disabling them, users are highly advised to have created at least one Load Balancer for <strong>TCP and UDP</strong> or forward outbound traffic via a different route.</p><h3 id=support-for-volumeattributesclasses-beta-in-k8s-131>Support for VolumeAttributesClasses (Beta in k8s 1.31)<a class=td-heading-self-link href=#support-for-volumeattributesclasses-beta-in-k8s-131 aria-label="Heading self-link"></a></h3><p>To have the CSI-driver configured to support the necessary features for <a href=https://kubernetes.io/docs/concepts/storage/volume-attributes-classes/>VolumeAttributesClasses</a> on Azure for shoots with a k8s-version greater than 1.31, use the <code>azure.provider.extensions.gardener.cloud/enable-volume-attributes-class</code> annotation on the shoot. Keep in mind to also enable the required feature flags and runtime-config on the common kubernetes controllers (as outlined in the link above) in the shoot-spec.</p><p>For more information and examples on how to configure the volume attributes class, see <a href=https://github.com/kubernetes-sigs/azuredisk-csi-driver/blob/release-1.31/deploy/example/modifyvolume/README.md>example</a> provided in the the azuredisk-csi-driver repository.</p><h3 id=preview-shoot-clusters-with-vmss-flexible-orchestration-vmss-flexvmo>Preview: Shoot clusters with VMSS Flexible Orchestration (VMSS Flex/VMO)<a class=td-heading-self-link href=#preview-shoot-clusters-with-vmss-flexible-orchestration-vmss-flexvmo aria-label="Heading self-link"></a></h3><p>The machines of an Azure cluster can be created while being attached to an <a href=https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-orchestration-modes#scale-sets-with-flexible-orchestration>Azure Virtual Machine ScaleSet with flexible orchestraion</a>.
The Virtual Machine ScaleSet with flexible orchestration feature is currently in preview and not yet general available on Azure.
Subscriptions need to <a href=https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-orchestration-modes#register-for-flexible-orchestration-mode>join the preview</a> to make use of the feature.</p><p>Azure VMSS Flex is the replacement of Azure AvailabilitySet for non-zoned Azure Shoot clusters as VMSS Flex come with less disadvantages like no blocking machine operations or compatibility with <code>Standard</code> SKU loadbalancer etc.</p><p>Now, Azure Shoot clusters are using VMSS Flex by default for non-zoned clusters.
In the past you used to need to do the following:</p><ul><li>The <code>InfrastructureConfig</code> of the Shoot configuration need to contain <code>.zoned=false</code></li><li>Shoot resource need to have the following annotation assigned: <code>alpha.azure.provider.extensions.gardener.cloud/vmo=true</code></li></ul><p>Some key facts about VMSS Flex based clusters:</p><ul><li>Unlike regular non-zonal Azure Shoot clusters, which have a primary AvailabilitySet which is shared between all machines in all worker pools of a Shoot cluster, a VMSS Flex based cluster has an own VMSS for each workerpool</li><li>In case the configuration of the VMSS will change (e.g. amount of fault domains in a region change; configured in the CloudProfile) all machines of the worker pool need to be rolled</li><li>It is not possible to migrate an existing primary AvailabilitySet based Shoot cluster to VMSS Flex based Shoot cluster and vice versa</li><li>VMSS Flex based clusters are using <code>Standard</code> SKU LoadBalancers instead of <code>Basic</code> SKU LoadBalancers for AvailabilitySet based Shoot clusters</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b182a904236beecf338898551c7afb28>1.4 - Provider Equinix Metal</h1><div class=lead>Gardener extension controller for the Equinix Metal cloud provider</div><h1 id=gardener-extension-for-equinix-metal-providerhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Equinix Metal provider</a><a class=td-heading-self-link href=#gardener-extension-for-equinix-metal-providerhttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-provider-equinix-metal><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-provider-equinix-metal alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener-public/pipelines/gardener-extension-provider-equinix-metal-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener-public/pipelines/gardener-extension-provider-equinix-metal-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-provider-equinix-metal><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-provider-equinix-metal alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the Equinix Metal provider.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-provider-equinix-metal/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=supported-kubernetes-versions>Supported Kubernetes versions<a class=td-heading-self-link href=#supported-kubernetes-versions aria-label="Heading self-link"></a></h2><p>This extension controller supports the following Kubernetes versions:</p><table><thead><tr><th>Version</th><th>Support</th><th>Conformance test results</th></tr></thead><tbody><tr><td>Kubernetes 1.30</td><td>untested</td><td>N/A</td></tr><tr><td>Kubernetes 1.29</td><td>untested</td><td>N/A</td></tr><tr><td>Kubernetes 1.28</td><td>untested</td><td>N/A</td></tr><tr><td>Kubernetes 1.27</td><td>untested</td><td>N/A</td></tr><tr><td>Kubernetes 1.26</td><td>untested</td><td>N/A</td></tr><tr><td>Kubernetes 1.25</td><td>untested</td><td>N/A</td></tr></tbody></table><p>Please take a look <a href=https://github.com/gardener/gardener/blob/master/docs/usage/supported_k8s_versions.md>here</a> to see which versions are supported by Gardener in general.</p><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>.</p><p>Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=caveats>Caveats<a class=td-heading-self-link href=#caveats aria-label="Heading self-link"></a></h2><p>You can use all available disks on your Equinix instance, but only under
certain conditions:</p><ul><li>You must use Flatcar</li><li>You must have a homogenous worker pool (all workers use the same OS and
container engine)</li><li>You must set any value for <code>DataVolume</code></li></ul><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-provider-equinix-metal/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/04-new-core-gardener-cloud-apis.md>GEP-4 (New <code>core.gardener.cloud/v1beta1</code> API)</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-5efa3d65b9b0708bfa6b0905e3a03668>1.4.1 - Operations</h1><h1 id=using-the-equinix-metal-provider-extension-with-gardener-as-operator>Using the Equinix Metal provider extension with Gardener as operator<a class=td-heading-self-link href=#using-the-equinix-metal-provider-extension-with-gardener-as-operator aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/30-cloudprofile.yaml><code>core.gardener.cloud/v1beta1.CloudProfile</code> resource</a> declares a <code>providerConfig</code> field that is meant to contain provider-specific configuration.</p><p>In this document we are describing how this configuration looks like for Equinix Metal and provide an example <code>CloudProfile</code> manifest with minimal configuration that you can use to allow creating Equinix Metal shoot clusters.</p><h2 id=example-cloudprofile-manifest>Example <code>CloudProfile</code> manifest<a class=td-heading-self-link href=#example-cloudprofile-manifest aria-label="Heading self-link"></a></h2><p>Please find below an example <code>CloudProfile</code> manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: CloudProfile
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: equinix-metal
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: equinixmetal
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 1.27.2
</span></span><span style=display:flex><span>    - version: 1.26.7
</span></span><span style=display:flex><span>    - version: 1.25.10
</span></span><span style=display:flex><span>      <span style=color:green>#expirationDate: &#34;2023-03-15T23:59:59Z&#34;</span>
</span></span><span style=display:flex><span>  machineImages:
</span></span><span style=display:flex><span>  - name: flatcar
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 0.0.0-stable
</span></span><span style=display:flex><span>  machineTypes:
</span></span><span style=display:flex><span>  - name: t1.small
</span></span><span style=display:flex><span>    cpu: <span style=color:#a31515>&#34;4&#34;</span>
</span></span><span style=display:flex><span>    gpu: <span style=color:#a31515>&#34;0&#34;</span>
</span></span><span style=display:flex><span>    memory: 8Gi
</span></span><span style=display:flex><span>    usable: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  regions: <span style=color:green># List of offered metros</span>
</span></span><span style=display:flex><span>  - name: ny
</span></span><span style=display:flex><span>    zones: <span style=color:green># List of offered facilities within the respective metro</span>
</span></span><span style=display:flex><span>    - name: ewr1
</span></span><span style=display:flex><span>    - name: ny5
</span></span><span style=display:flex><span>    - name: ny7
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: equinixmetal.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: CloudProfileConfig
</span></span><span style=display:flex><span>    machineImages:
</span></span><span style=display:flex><span>    - name: flatcar
</span></span><span style=display:flex><span>      versions:
</span></span><span style=display:flex><span>      - version: 0.0.0-stable
</span></span><span style=display:flex><span>        id: flatcar_stable
</span></span><span style=display:flex><span>      - version: 3510.2.2
</span></span><span style=display:flex><span>        ipxeScriptUrl: https://stable.release.flatcar-linux.net/amd64-usr/3510.2.2/flatcar_production_packet.ipxe
</span></span></code></pre></div><h2 id=cloudprofileconfig><code>CloudProfileConfig</code><a class=td-heading-self-link href=#cloudprofileconfig aria-label="Heading self-link"></a></h2><p>The cloud profile configuration contains information about the real machine image IDs in the Equinix Metal environment (IDs).
You have to map every version that you specify in <code>.spec.machineImages[].versions</code> here such that the Equinix Metal extension knows the ID for every version you want to offer.</p><p>Equinix Metal supports two different options to specify the image:</p><ol><li>Supported Operating System: Images that are provided by Equinix Metal. They are referenced by their ID (<code>slug</code>). See (Operating Systems Reference)[https://deploy.equinix.com/developers/docs/metal/operating-systems/supported/#operating-systems-reference] for all supported operating system and their ids.</li><li>Custom iPXE Boot: Equinix Metal supports passing custom iPXE scripts during provisioning, which allows you to install a custom operating system manually. This is useful if you want to have a custom image or want to pin to a specific version. See <a href=https://deploy.equinix.com/developers/docs/metal/operating-systems/custom-ipxe/#provisioning-with-custom-ipxe>Custom iPXE Boot</a> for details.</li></ol><p>An example <code>CloudProfileConfig</code> for the Equinix Metal extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: equinixmetal.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: CloudProfileConfig
</span></span><span style=display:flex><span>machineImages:
</span></span><span style=display:flex><span>- name: flatcar
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>  - version: 0.0.0-stable
</span></span><span style=display:flex><span>    id: flatcar_stable
</span></span><span style=display:flex><span>  - version: 3510.2.2
</span></span><span style=display:flex><span>    ipxeScriptUrl: https://stable.release.flatcar-linux.net/amd64-usr/3510.2.2/flatcar_production_packet.ipxe
</span></span></code></pre></div><blockquote><p>NOTE: <code>CloudProfileConfig</code> is not a Custom Resource, so you cannot create it directly.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-5464af5b09e787e0eed69703d21d1a39>1.4.2 - Usage</h1><h1 id=using-the-equinix-metal-provider-extension-with-gardener-as-end-user>Using the Equinix Metal provider extension with Gardener as end-user<a class=td-heading-self-link href=#using-the-equinix-metal-provider-extension-with-gardener-as-end-user aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a few fields that are meant to contain provider-specific configuration.</p><p>In this document we are describing how this configuration looks like for Equinix Metal and provide an example <code>Shoot</code> manifest with minimal configuration that you can use to create an Equinix Metal cluster (modulo the landscape-specific information like cloud profile names, secret binding names, etc.).</p><h2 id=provider-secret-data>Provider secret data<a class=td-heading-self-link href=#provider-secret-data aria-label="Heading self-link"></a></h2><p>Every shoot cluster references a <code>SecretBinding</code> which itself references a <code>Secret</code>, and this <code>Secret</code> contains the provider credentials of your Equinix Metal project.
This <code>Secret</code> must look as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-secret
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  apiToken: base64(api-token)
</span></span><span style=display:flex><span>  projectID: base64(project-id)
</span></span></code></pre></div><p>Please look up <a href=https://metal.equinix.com/developers/api/>https://metal.equinix.com/developers/api/</a> as well.</p><p>With <code>Secret</code> created, create a <code>SecretBinding</code> resource referencing it. It may look like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: SecretBinding
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-secret
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>secretRef:
</span></span><span style=display:flex><span>  name: my-secret
</span></span><span style=display:flex><span>quotas: []
</span></span></code></pre></div><h2 id=infrastructureconfig><code>InfrastructureConfig</code><a class=td-heading-self-link href=#infrastructureconfig aria-label="Heading self-link"></a></h2><p>Currently, there is no infrastructure configuration possible for the Equinix Metal environment.</p><p>An example <code>InfrastructureConfig</code> for the Equinix Metal extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: equinixmetal.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: InfrastructureConfig
</span></span></code></pre></div><p>The Equinix Metal extension will only create a key pair.</p><h2 id=controlplaneconfig><code>ControlPlaneConfig</code><a class=td-heading-self-link href=#controlplaneconfig aria-label="Heading self-link"></a></h2><p>The control plane configuration mainly contains values for the Equinix Metal-specific control plane components.
Today, the Equinix Metal extension deploys the <code>cloud-controller-manager</code> and the CSI controllers, however, it doesn&rsquo;t offer any configuration options at the moment.</p><p>An example <code>ControlPlaneConfig</code> for the Equinix Metal extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: equinixmetal.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: ControlPlaneConfig
</span></span></code></pre></div><h2 id=workerconfig><code>WorkerConfig</code><a class=td-heading-self-link href=#workerconfig aria-label="Heading self-link"></a></h2><p>The Equinix Metal extension supports specifying IDs for reserved devices that should be used for the machines of a specific worker pool.</p><p>An example <code>WorkerConfig</code> for the Equinix Metal extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: equinixmetal.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: WorkerConfig
</span></span><span style=display:flex><span>reservationIDs:
</span></span><span style=display:flex><span>- my-reserved-device-1
</span></span><span style=display:flex><span>- my-reserved-device-2
</span></span><span style=display:flex><span>reservedDevicesOnly: <span style=color:#00f>false</span>
</span></span></code></pre></div><p>The <code>.reservationIDs[]</code> list contains the list of IDs of the reserved devices.
The <code>.reservedDevicesOnly</code> field indicates whether only reserved devices from the provided list of reservation IDs should be used when new machines are created.
It always will attempt to create a device from one of the reservation IDs.
If none is available, the behaviour depends on the setting:</p><ul><li><code>true</code>: return an error</li><li><code>false</code>: request a regular on-demand device</li></ul><p>The default value is <code>false</code>.</p><h2 id=example-shoot-manifest>Example <code>Shoot</code> manifest<a class=td-heading-self-link href=#example-shoot-manifest aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-shoot
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfileName: equinix-metal
</span></span><span style=display:flex><span>  region: ny <span style=color:green># Corresponds to a metro</span>
</span></span><span style=display:flex><span>  secretBindingName: my-secret
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: equinixmetal
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: equinixmetal.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: equinixmetal.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-pool1
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: t1.small
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: storage_1
</span></span><span style=display:flex><span>      zones: <span style=color:green># Optional list of facilities, all of which MUST be in the metro; if not provided, then random facilities within the metro will be chosen for each machine.</span>
</span></span><span style=display:flex><span>      - ewr1
</span></span><span style=display:flex><span>      - ny5
</span></span><span style=display:flex><span>    - name: reserved-pool
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: t1.small
</span></span><span style=display:flex><span>      minimum: 1
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        apiVersion: equinixmetal.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>        kind: WorkerConfig
</span></span><span style=display:flex><span>        reservationIDs:
</span></span><span style=display:flex><span>        - reserved-device1
</span></span><span style=display:flex><span>        - reserved-device2
</span></span><span style=display:flex><span>        reservedDevicesOnly: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: storage_1
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.27.2
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>⚠️ Note that if you specify multiple facilities in the <code>.spec.provider.workers[].zones[]</code> list then new machines are randomly created in one of the provided facilities.
Particularly, it is not ensured that all facilities are used or that all machines are equally or unequally distributed.</p><h2 id=kubernetes-versions-per-worker-pool>Kubernetes Versions per Worker Pool<a class=td-heading-self-link href=#kubernetes-versions-per-worker-pool aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>WorkerPoolKubernetesVersion</code> feature gate, i.e., having <a href=https://github.com/gardener/gardener/blob/8a9c88866ec5fce59b5acf57d4227eeeb73669d7/example/90-shoot.yaml#L69-L70>worker pools with overridden Kubernetes versions</a> since <code>gardener-extension-provider-equinix-metal@v2.2</code>.</p><h2 id=shoot-ca-certificate-and-serviceaccount-signing-key-rotation>Shoot CA Certificate and <code>ServiceAccount</code> Signing Key Rotation<a class=td-heading-self-link href=#shoot-ca-certificate-and-serviceaccount-signing-key-rotation aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>ShootCARotation</code> feature gate since <code>gardener-extension-provider-equinix-metal@v2.3</code> and <code>ShootSARotation</code> feature gate since <code>gardener-extension-provider-equinix-metal@v2.4</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3958d75f5afea52ba6f339a00c82ee93>1.5 - Provider GCP</h1><div class=lead>Gardener extension controller for the GCP cloud provider</div><h1 id=gardener-extension-for-gcp-providerhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for GCP provider</a><a class=td-heading-self-link href=#gardener-extension-for-gcp-providerhttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-provider-gcp><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-provider-gcp alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-provider-gcp-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-provider-gcp-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-provider-gcp><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-provider-gcp alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the GCP provider.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-provider-gcp/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=supported-kubernetes-versions>Supported Kubernetes versions<a class=td-heading-self-link href=#supported-kubernetes-versions aria-label="Heading self-link"></a></h2><p>This extension controller supports the following Kubernetes versions:</p><table><thead><tr><th>Version</th><th>Support</th><th>Conformance test results</th></tr></thead><tbody><tr><td>Kubernetes 1.32</td><td>1.32.0+</td><td>N/A</td></tr><tr><td>Kubernetes 1.31</td><td>1.31.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.31%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.31%20GCE/tests_status?style=svg" alt="Gardener v1.31 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.30</td><td>1.30.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.30%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.30%20GCE/tests_status?style=svg" alt="Gardener v1.30 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.29</td><td>1.29.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.29%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.29%20GCE/tests_status?style=svg" alt="Gardener v1.29 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.28</td><td>1.28.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.28%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.28%20GCE/tests_status?style=svg" alt="Gardener v1.28 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.27</td><td>1.27.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.27%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.27%20GCE/tests_status?style=svg" alt="Gardener v1.27 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.26</td><td>1.26.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.26%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.26%20GCE/tests_status?style=svg" alt="Gardener v1.26 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.25</td><td>1.25.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.25%20GCE><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.25%20GCE/tests_status?style=svg" alt="Gardener v1.25 Conformance Tests"></a></td></tr></tbody></table><p>Please take a look <a href=/docs/gardener/shoot-operations/supported_k8s_versions/>here</a> to see which versions are supported by Gardener in general.</p><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>.</p><p>Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-provider-gcp/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/04-new-core-gardener-cloud-apis.md>GEP-4 (New <code>core.gardener.cloud/v1beta1</code> API)</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-43bc49392a4264d2b4f9a208d1e2eaaa>1.5.1 - Tutorials</h1></div><div class=td-content><h1 id=pg-7d967b4e7be2e449fb9198a8ea60881e>1.5.1.1 - Create a Кubernetes Cluster on GCP with Gardener</h1><h3 id=overview>Overview<a class=td-heading-self-link href=#overview aria-label="Heading self-link"></a></h3><p>Gardener allows you to create a Kubernetes cluster on different infrastructure providers. This tutorial will guide you through the process of creating a cluster on GCP.</p><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><ul><li>You have created a <a href=https://console.cloud.google.com/>GCP account</a>.</li><li>You have access to the Gardener dashboard and have permissions to create projects.</li></ul><h3 id=steps>Steps<a class=td-heading-self-link href=#steps aria-label="Heading self-link"></a></h3><ol><li><p>Go to the Gardener dashboard and create a <em>Project</em>.</p><img src=/__resources/new-gardener-project_077542.png></li><li><p>Check which roles are required by Gardener.</p><ol><li><p>Choose <em>Secrets</em>, then the plus icon <img src=/__resources/plus-icon_9d16d6.png> and select <em>GCP</em>.</p><img src=/__resources/create-secret-gcp_9b8911.png></li><li><p>Click on the help button <img src=/__resources/help-icon_1fcfd3.png>.</p><img src=/__resources/gardener-gcp-secret-1_3a2741.png>
<img src=/__resources/gardener-gcp-secret-2_fcc008.png></li></ol></li><li><p>Create a service account with the correct roles in GCP:</p><ol><li><p><a href=https://console.cloud.google.com/iam-admin/serviceaccounts>Create a new service account in GCP</a>.</p><img src=/__resources/gcp-create-service-account-0_0a398e.png></li><li><p>Enter the name and description of your service account.</p></li><li><p>Assign the roles required by Gardener.</p></li><li><p>Choose <em>Done</em>.</p><img src=/__resources/gcp-create-service-account-1_c55fe5.png></li></ol></li><li><p>Create a key for your service:</p><ol><li><p>Locate your service account, then choose <em>Actions</em> and <em>Manage keys</em>.</p><img src=/__resources/gcp-create-key-0_b97786.png></li><li><p>Choose <em>Add Key</em>, then <em>Create new key</em>.</p><img src=/__resources/gcp-create-key-1_83ef08.png></li><li><p>Save the private key of the service account in JSON format.</p><img src=/__resources/gcp-create-key-2_a661a1.png>
<img src=/__resources/gcp-create-key-3_ad2cf4.png></li></ol><div class="alert alert-info" role=alert><h4 class=alert-heading>Note</h4>Save the key of the user, it’s used later to create secrets for Gardener.</div></li><li><p>Enable the <a href=https://console.developers.google.com/apis/library/compute.googleapis.com>Google Compute API</a> by following <a href=https://cloud.google.com/endpoints/docs/openapi/enable-api>these steps</a>.</p><blockquote><p>When you are finished, you should see the following page:</p></blockquote><img src=/__resources/gcp-compute-engine-api_e4a22b.png></li><li><p>Enable the <a href=https://console.developers.google.com/apis/library/iam.googleapis.com>Google IAM API</a> by following <a href=https://cloud.google.com/endpoints/docs/openapi/enable-api>these steps</a>.</p><blockquote><p>When you are finished, you should see the following page:</p></blockquote><img src=/__resources/gcp-iam-api_8faa7c.png></li><li><p>On the Gardener dashboard, choose <em>Secrets</em> and then the plus sign <img src=/__resources/plus-icon_9d16d6.png>. Select <em>GCP</em> from the drop down menu to add a new GCP secret.</p></li><li><p>Create your secret.</p><ol><li>Type the name of your secret.</li><li>Select your <em>Cloud Profile</em>.</li><li>Copy and paste the contents of the <em>.JSON</em> file you saved when you created the secret key on GCP.</li><li>Choose <em>Add secret</em>.
<img src=/__resources/add-gcp-secret_84ec33.png></li></ol><blockquote><p>After completing these steps, you should see your newly created secret in the <em>Infrastructure Secrets</em> section.</p></blockquote><img src=/__resources/secret-stored_2be4fd.png></li><li><p>To create a new cluster, choose <em>Clusters</em> and then the plus sign in the upper right corner.</p><img src=/__resources/new-cluster_581df0.png></li><li><p>In the <em>Create Cluster</em> section:</p><ol><li>Select <em>GCP</em> in the <em>Infrastructure</em> tab.</li><li>Type the name of your cluster in the <em>Cluster Details</em> tab.</li><li>Choose the secret you created before in the <em>Infrastructure Details</em> tab.</li><li>Choose <em>Create</em>.</li></ol><img src=/__resources/create-cluster_66c946.png></li><li><p>Wait for your cluster to get created.</p><img src=/__resources/processing-cluster_309fda.png></li></ol><h3 id=result>Result<a class=td-heading-self-link href=#result aria-label="Heading self-link"></a></h3><p>After completing the steps in this tutorial, you will be able to see and download the kubeconfig of your cluster.</p><img src=/__resources/copy-kubeconfig_3d13a9.png></div><div class=td-content style=page-break-before:always><h1 id=pg-33b6455211f26cf2f73c830998869efe>1.5.2 - Data Disk Restore From Image</h1><h1 id=data-disk-restore-from-image>Data Disk Restore From Image<a class=td-heading-self-link href=#data-disk-restore-from-image aria-label="Heading self-link"></a></h1><h2 id=table-of-contents>Table of Contents<a class=td-heading-self-link href=#table-of-contents aria-label="Heading self-link"></a></h2><ul><li><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/proposals/datadisk-image-restore/#summary>Summary</a></li><li><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/proposals/datadisk-image-restore/#motivation>Motivation</a><ul><li><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/proposals/datadisk-image-restore/#goals>Goals</a></li><li><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/proposals/datadisk-image-restore/#non-goals>Non-Goals</a></li></ul></li><li><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/proposals/datadisk-image-restore/#proposal>Proposal</a></li><li><a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/proposals/datadisk-image-restore/#alternatives>Alternatives</a></li></ul><h2 id=summary>Summary<a class=td-heading-self-link href=#summary aria-label="Heading self-link"></a></h2><p>Currently, we have no support either in the shoot spec or in the <a href=https://github.com/gardener/machine-controller-manager-provider-gcp>MCM GCP Provider</a> for restoring GCP Data Disks from images.</p><h2 id=motivation>Motivation<a class=td-heading-self-link href=#motivation aria-label="Heading self-link"></a></h2><p>The primary motivation is to support <a href=https://github.com/gardener/gardener-extension-provider-azure/issues/788>Integration of vSMP MemeoryOne in Azure</a>.
We implemented support for this in AWS via <a href=https://github.com/gardener/gardener-extension-provider-aws/pull/112>Support for data volume snapshot ID </a>.
In GCP we have the option to restore data disk from a custom image which is more convenient and flexible.</p><h3 id=goals>Goals<a class=td-heading-self-link href=#goals aria-label="Heading self-link"></a></h3><ol><li>Extend the GCP provider specific <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/usage/>WorkerConfig</a> section in the shoot YAML and support provider configuration for
data-disks to support data-disk creation from an image name by supplying an image name.</li></ol><h2 id=proposal>Proposal<a class=td-heading-self-link href=#proposal aria-label="Heading self-link"></a></h2><h3 id=shoot-specification>Shoot Specification<a class=td-heading-self-link href=#shoot-specification aria-label="Heading self-link"></a></h3><p>At this current time, there is no support for provider specific configuration of data disks in an GCP shoot spec.
The below shows an example configuration at the time of this proposal:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: WorkerConfig
</span></span><span style=display:flex><span>  volume:
</span></span><span style=display:flex><span>    interface: NVME
</span></span><span style=display:flex><span>    encryption: <span style=color:green># optional, skipped detail here</span>
</span></span><span style=display:flex><span>  serviceAccount:
</span></span><span style=display:flex><span>    email: foo@bar.com
</span></span><span style=display:flex><span>    scopes:
</span></span><span style=display:flex><span>      - https://www.googleapis.com/auth/cloud-platform
</span></span><span style=display:flex><span>  gpu:
</span></span><span style=display:flex><span>    acceleratorType: nvidia-tesla-t4
</span></span><span style=display:flex><span>    count: 1
</span></span></code></pre></div><p>We propose that the worker config section be enahnced to support data disk configuration</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: WorkerConfig
</span></span><span style=display:flex><span>  volume:
</span></span><span style=display:flex><span>    interface: NVME
</span></span><span style=display:flex><span>    encryption: <span style=color:green># optional, skipped detail here</span>
</span></span><span style=display:flex><span>  dataVolumes: <span style=color:green># &lt;-- NEW SUB_SECTION</span>
</span></span><span style=display:flex><span>    - name: vsmp1
</span></span><span style=display:flex><span>      image: imgName
</span></span><span style=display:flex><span>  serviceAccount:
</span></span><span style=display:flex><span>    email: foo@bar.com
</span></span><span style=display:flex><span>    scopes:
</span></span><span style=display:flex><span>      - https://www.googleapis.com/auth/cloud-platform
</span></span><span style=display:flex><span>  gpu:
</span></span><span style=display:flex><span>    acceleratorType: nvidia-tesla-t4
</span></span><span style=display:flex><span>    count: 1
</span></span></code></pre></div><p>In the above <code>imgName</code> specified in <code>providerConfig.dataVolumes.image</code> represents the image name of a previously created image created by a tool or process.
See <a href=https://cloud.google.com/sdk/gcloud/reference/compute/images/create>Google Cloud Create Image</a>.</p><p>The <a href=https://github.com/gardener/machine-controller-manager-provider-gcp>MCM GCP Provider</a> will ensure when a VM instance is instantiated, that the data
disk(s) for the VM are created with the <em>source image</em> set to the provided <code>imgName</code>.
The mechanics of this is left to MCM GCP provider. See <code>image</code> param to <code>--create-disk</code> flag in
<a href=https://cloud.google.com/sdk/gcloud/reference/compute/instances/create>Google Cloud Instance Creation</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c3de24169ff0acf606ae8522686249a7>1.5.3 - Deployment</h1><h1 id=deployment-of-the-gcp-provider-extension>Deployment of the GCP provider extension<a class=td-heading-self-link href=#deployment-of-the-gcp-provider-extension aria-label="Heading self-link"></a></h1><p><strong>Disclaimer:</strong> This document is NOT a step-by-step installation guide for the GCP provider extension and only contains some configuration specifics regarding the installation of different components via the helm charts residing in the GCP provider extension <a href=https://github.com/gardener/gardener-extension-provider-gcp>repository</a>.</p><h2 id=gardener-extension-admission-gcp>gardener-extension-admission-gcp<a class=td-heading-self-link href=#gardener-extension-admission-gcp aria-label="Heading self-link"></a></h2><h3 id=authentication-against-the-garden-cluster>Authentication against the Garden cluster<a class=td-heading-self-link href=#authentication-against-the-garden-cluster aria-label="Heading self-link"></a></h3><p>There are several authentication possibilities depending on whether or not <a href=https://github.com/gardener/garden-setup#concept-the-virtual-cluster>the concept of <em>Virtual Garden</em></a> is used.</p><h4 id=virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster><em>Virtual Garden</em> is not used, i.e., the <code>runtime</code> Garden cluster is also the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster aria-label="Heading self-link"></a></h4><p><strong>Automounted Service Account Token</strong>
The easiest way to deploy the <code>gardener-extension-admission-gcp</code> component will be to not provide <code>kubeconfig</code> at all. This way in-cluster configuration and an automounted service account token will be used. The drawback of this approach is that the automounted token will not be automatically rotated.</p><p><strong>Service Account Token Volume Projection</strong>
Another solution will be to use <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>Service Account Token Volume Projection</a> combined with a <code>kubeconfig</code> referencing a token file (see example below).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://default.kubernetes.svc.cluster.local
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: garden
</span></span><span style=display:flex><span>    user: garden
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>current-context: garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div><p>This will allow for automatic rotation of the service account token by the <code>kubelet</code>. The configuration can be achieved by setting both <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.kubeconfig</code> in the respective chart&rsquo;s <code>values.yaml</code> file.</p><h4 id=virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster><em>Virtual Garden</em> is used, i.e., the <code>runtime</code> Garden cluster is different from the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster aria-label="Heading self-link"></a></h4><p><strong>Service Account</strong>
The easiest way to setup the authentication will be to create a service account and the respective roles will be bound to this service account in the <code>target</code> cluster. Then use the generated service account token and craft a <code>kubeconfig</code> which will be used by the workload in the <code>runtime</code> cluster. This approach does not provide a solution for the rotation of the service account token. However, this setup can be achieved by setting <code>.Values.global.virtualGarden.enabled: true</code> and following these steps:</p><ol><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Get the service account token and craft the <code>kubeconfig</code>.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><p><strong>Client Certificate</strong>
Another solution will be to bind the roles in the <code>target</code> cluster to a <code>User</code> subject instead of a service account and use a client certificate for authentication. This approach does not provide a solution for the client certificate rotation. However, this setup can be achieved by setting both <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>, then following these steps:</p><ol><li>Generate a client certificate for the <code>target</code> cluster for the respective user.</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Craft a <code>kubeconfig</code> using the already generated client certificate.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><p><strong>Projected Service Account Token</strong>
This approach requires an already deployed and configured <a href=https://github.com/gardener/oidc-webhook-authenticator>oidc-webhook-authenticator</a> for the <code>target</code> cluster. Also the <code>runtime</code> cluster should be registered as a trusted identity provider in the <code>target</code> cluster. Then projected service accounts tokens from the <code>runtime</code> cluster can be used to authenticate against the <code>target</code> cluster. The needed steps are as follows:</p><ol><li>Deploy <a href=https://github.com/gardener/oidc-webhook-authenticator>OWA</a> and establish the needed trust.</li><li>Set <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>. <strong>Note:</strong> username value will depend on the trust configuration, e.g., <code>&lt;prefix>:system:serviceaccount:&lt;namespace>:&lt;serviceaccount></code></li><li>Set <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.serviceAccountTokenVolumeProjection.audience</code>. <strong>Note:</strong> audience value will depend on the trust configuration, e.g., <code>&lt;cliend-id-from-trust-config></code>.</li><li>Craft a kubeconfig (see example below).</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://virtual-garden.api
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: virtual-garden
</span></span><span style=display:flex><span>    user: virtual-garden
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>current-context: virtual-garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: virtual-garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-83937afb9b7b37ebb4a6752a7fcdef44>1.5.4 - Local Setup</h1><h3 id=admission-gcp>admission-gcp<a class=td-heading-self-link href=#admission-gcp aria-label="Heading self-link"></a></h3><p><code>admission-gcp</code> is an admission webhook server which is responsible for the validation of the cloud provider (GCP in this case) specific fields and resources. The Gardener API server is cloud provider agnostic and it wouldn&rsquo;t be able to perform similar validation.</p><p>Follow the steps below to run the admission webhook server locally.</p><ol><li><p>Start the Gardener API server.</p><p>For details, check the Gardener <a href=/docs/gardener/local_setup/>local setup</a>.</p></li><li><p>Start the webhook server</p><p>Make sure that the <code>KUBECONFIG</code> environment variable is pointing to the local garden cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make start-admission
</span></span></code></pre></div></li><li><p>Setup the <code>ValidatingWebhookConfiguration</code>.</p><p><code>hack/dev-setup-admission-gcp.sh</code> will configure the webhook Service which will allow the kube-apiserver of your local cluster to reach the webhook server. It will also apply the <code>ValidatingWebhookConfiguration</code> manifest.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./hack/dev-setup-admission-gcp.sh
</span></span></code></pre></div></li></ol><p>You are now ready to experiment with the <code>admission-gcp</code> webhook server locally.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-76376d0613ae014a2d188d92ecff4a5d>1.5.5 - Operations</h1><h1 id=using-the-gcp-provider-extension-with-gardener-as-operator>Using the GCP provider extension with Gardener as operator<a class=td-heading-self-link href=#using-the-gcp-provider-extension-with-gardener-as-operator aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/30-cloudprofile.yaml><code>core.gardener.cloud/v1beta1.CloudProfile</code> resource</a> declares a <code>providerConfig</code> field that is meant to contain provider-specific configuration.
The <a href=https://github.com/gardener/gardener/blob/master/example/50-seed.yaml><code>core.gardener.cloud/v1beta1.Seed</code> resource</a> is structured similarly.
Additionally, it allows configuring settings for the backups of the main etcds&rsquo; data of shoot clusters control planes running in this seed cluster.</p><p>This document explains the necessary configuration for this provider extension.</p><h2 id=cloudprofile-resource><code>CloudProfile</code> resource<a class=td-heading-self-link href=#cloudprofile-resource aria-label="Heading self-link"></a></h2><p>This section describes, how the configuration for <code>CloudProfile</code>s looks like for GCP by providing an example <code>CloudProfile</code> manifest with minimal configuration that can be used to allow the creation of GCP shoot clusters.</p><h3 id=cloudprofileconfig><code>CloudProfileConfig</code><a class=td-heading-self-link href=#cloudprofileconfig aria-label="Heading self-link"></a></h3><p>The cloud profile configuration contains information about the real machine image IDs in the GCP environment (image URLs).
You have to map every version that you specify in <code>.spec.machineImages[].versions</code> here such that the GCP extension knows the image URL for every version you want to offer.
For each machine image version an <code>architecture</code> field can be specified which specifies the CPU architecture of the machine on which given machine image can be used.</p><p>An example <code>CloudProfileConfig</code> for the GCP extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: CloudProfileConfig
</span></span><span style=display:flex><span>machineImages:
</span></span><span style=display:flex><span>- name: coreos
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>  - version: 2135.6.0
</span></span><span style=display:flex><span>    image: projects/coreos-cloud/global/images/coreos-stable-2135-6-0-v20190801
</span></span><span style=display:flex><span>    <span style=color:green># architecture: amd64 # optional</span>
</span></span></code></pre></div><h3 id=example-cloudprofile-manifest>Example <code>CloudProfile</code> manifest<a class=td-heading-self-link href=#example-cloudprofile-manifest aria-label="Heading self-link"></a></h3><p>If you want to allow that shoots can create VMs with local SSDs volumes then you have to specify the type of the disk with <code>SCRATCH</code> in the <code>.spec.volumeTypes[]</code> list.
Please find below an example <code>CloudProfile</code> manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: CloudProfile
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: gcp
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: gcp
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 1.27.3
</span></span><span style=display:flex><span>    - version: 1.26.8
</span></span><span style=display:flex><span>      expirationDate: <span style=color:#a31515>&#34;2022-10-31T23:59:59Z&#34;</span>
</span></span><span style=display:flex><span>  machineImages:
</span></span><span style=display:flex><span>  - name: coreos
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 2135.6.0
</span></span><span style=display:flex><span>  machineTypes:
</span></span><span style=display:flex><span>  - name: n1-standard-4
</span></span><span style=display:flex><span>    cpu: <span style=color:#a31515>&#34;4&#34;</span>
</span></span><span style=display:flex><span>    gpu: <span style=color:#a31515>&#34;0&#34;</span>
</span></span><span style=display:flex><span>    memory: 15Gi
</span></span><span style=display:flex><span>  volumeTypes:
</span></span><span style=display:flex><span>  - name: pd-standard
</span></span><span style=display:flex><span>    class: standard
</span></span><span style=display:flex><span>  - name: pd-ssd
</span></span><span style=display:flex><span>    class: premium
</span></span><span style=display:flex><span>  - name: SCRATCH
</span></span><span style=display:flex><span>    class: standard
</span></span><span style=display:flex><span>  regions:
</span></span><span style=display:flex><span>  - region: europe-west1
</span></span><span style=display:flex><span>    names:
</span></span><span style=display:flex><span>    - europe-west1-b
</span></span><span style=display:flex><span>    - europe-west1-c
</span></span><span style=display:flex><span>    - europe-west1-d
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: CloudProfileConfig
</span></span><span style=display:flex><span>    machineImages:
</span></span><span style=display:flex><span>    - name: coreos
</span></span><span style=display:flex><span>      versions:
</span></span><span style=display:flex><span>      - version: 2135.6.0
</span></span><span style=display:flex><span>        image: projects/coreos-cloud/global/images/coreos-stable-2135-6-0-v20190801
</span></span><span style=display:flex><span>        <span style=color:green># architecture: amd64 # optional</span>
</span></span></code></pre></div><h2 id=seed-resource><code>Seed</code> resource<a class=td-heading-self-link href=#seed-resource aria-label="Heading self-link"></a></h2><p>This provider extension does not support any provider configuration for the <code>Seed</code>&rsquo;s <code>.spec.provider.providerConfig</code> field.
However, it supports to managing of backup infrastructure, i.e., you can specify a configuration for the <code>.spec.backup</code> field.</p><h3 id=backup-configuration>Backup configuration<a class=td-heading-self-link href=#backup-configuration aria-label="Heading self-link"></a></h3><p>A Seed of type <code>gcp</code> can be configured to perform backups for the main etcds&rsquo; of the shoot clusters control planes using Google Cloud Storage buckets.</p><p>The location/region where the backups will be stored defaults to the region of the Seed (<code>spec.provider.region</code>), but can also be explicitly configured via the field <code>spec.backup.region</code>.
The region of the backup can be different from where the seed cluster is running.
However, usually it makes sense to pick the same region for the backup bucket as used for the Seed cluster.</p><p>Please find below an example <code>Seed</code> manifest (partly) that configures backups using Google Cloud Storage buckets.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Seed
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-seed
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: gcp
</span></span><span style=display:flex><span>    region: europe-west1
</span></span><span style=display:flex><span>  backup:
</span></span><span style=display:flex><span>    provider: gcp
</span></span><span style=display:flex><span>    region: europe-west1 <span style=color:green># default region</span>
</span></span><span style=display:flex><span>    secretRef:
</span></span><span style=display:flex><span>      name: backup-credentials
</span></span><span style=display:flex><span>      namespace: garden
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>An example of the referenced secret containing the credentials for the GCP Cloud storage can be found in the <a href=https://github.com/gardener/gardener-extension-provider-gcp/blob/master/example/30-etcd-backup-secret.yaml>example folder</a>.</p><h4 id=permissions-for-gcp-cloud-storage>Permissions for GCP Cloud Storage<a class=td-heading-self-link href=#permissions-for-gcp-cloud-storage aria-label="Heading self-link"></a></h4><p>Please make sure the service account associated with the provided credentials has the following IAM roles.</p><ul><li><a href=https://cloud.google.com/storage/docs/access-control/iam-roles>Storage Admin</a></li></ul><h3 id=rolling-update-triggers>Rolling Update Triggers<a class=td-heading-self-link href=#rolling-update-triggers aria-label="Heading self-link"></a></h3><p>Changes to the <code>Shoot</code> worker-pools are applied in-place where possible. In case this is not possible a rolling update of the workers will be performed to apply the new configuration, as outlined in <a href=/docs/gardener/shoot-operations/shoot_updates/#in-place-vs-rolling-updates>the Gardener documentation</a>. The exact fields that trigger this behaviour depend on whether the feature gate <code>NewWorkerPoolHash</code> is enabled. If it is not enabled, only the fields mentioned in the <a href=/docs/gardener/shoot-operations/shoot_updates/#rolling-update-triggers>Gardener doc</a> are used.
If the feature gate <em>is</em> enabled, instead of the complete provider config only the following fields are used:</p><ul><li><code>.spec.provider.workers[].dataVolumes[].name</code></li><li><code>.spec.provider.workers[].dataVolumes[].size</code></li><li><code>.spec.provider.workers[].dataVolumes[].type</code></li><li><code>.spec.provider.workers[].dataVolumes[].encrypted</code></li><li><code>.spec.provider.workers[].providerConfig.volume.encryption</code></li><li><code>.spec.provider.workers[].providerConfig.volume.localSsdInterface</code></li><li><code>.spec.provider.workers[].providerConfig.dataVolumes[].name</code></li><li><code>.spec.provider.workers[].providerConfig.dataVolumes[].sourceImage</code></li><li><code>.spec.provider.workers[].providerConfig.dataVolumes[].provisionedIops</code></li><li><code>.spec.provider.workers[].providerConfig.minCpuPlatform</code></li><li><code>.spec.provider.workers[].providerConfig.gpu</code></li><li><code>.spec.provider.workers[].providerConfig.serviceAccount</code></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a567aa2cf222ff4f19466b657fa42f04>1.5.6 - Usage</h1><h1 id=using-the-gcp-provider-extension-with-gardener-as-end-user>Using the GCP provider extension with Gardener as end-user<a class=td-heading-self-link href=#using-the-gcp-provider-extension-with-gardener-as-end-user aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a few fields that are meant to contain provider-specific configuration.</p><p>This document describes the configurable options for GCP and provides an example <code>Shoot</code> manifest with minimal configuration that can be used to create a GCP cluster (modulo the landscape-specific information like cloud profile names, secret binding names, etc.).</p><h2 id=accessing-gcp-apis>Accessing GCP APIs<a class=td-heading-self-link href=#accessing-gcp-apis aria-label="Heading self-link"></a></h2><p>In order for Gardener to create a Kubernetes cluster using GCP infrastructure components, a Shoot has to provide an authentication mechanism giving sufficient permissions to the desired GCP project.
Every shoot cluster references a <code>SecretBinding</code> or a <code>CredentialsBinding</code> which itself references a <code>Secret</code> which contains the provider credentials of the GCP project.</p><blockquote class="alert alert-important"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>message-outline</title><path d="M20 2H4C2.9 2 2 2.9 2 4V22l4-4H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2m0 14H5.2L4 17.2V4H20V16z"/></svg><p>Important</p></div><p>While <code>SecretBinding</code>s can only reference <code>Secret</code>s, <code>CredentialsBinding</code>s can also reference <code>WorkloadIdentity</code>s which provide an alternative authentication method.
<code>WorkloadIdentity</code>s do not directly contain credentials but are rather a representation of the workload that is going to access the user&rsquo;s account.
If the user has configured <a href=https://cloud.google.com/iam/docs/workload-identity-federation>Workload Identity Federation</a> with Gardener&rsquo;s Workload Identity Issuer then the GCP infrastructure components can access the user&rsquo;s account without the need of preliminary exchange of credentials.</p></blockquote><p>The <code>SecretBinding</code>/<code>CredentialsBinding</code> is configurable in the <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml>Shoot cluster</a> with the field <code>secretBindingName</code>/<code>credentialsBindingName</code>.</p><h3 id=gcp-service-account-credentials>GCP Service Account Credentials<a class=td-heading-self-link href=#gcp-service-account-credentials aria-label="Heading self-link"></a></h3><p>The required credentials for the GCP project are a <a href=https://cloud.google.com/iam/docs/service-accounts#service_account_keys>Service Account Key</a> to authenticate as a <a href=https://cloud.google.com/compute/docs/access/service-accounts>GCP Service Account</a>.
A service account is a special account that can be used by services and applications to interact with Google Cloud Platform APIs.
Applications can use service account credentials to authorize themselves to a set of APIs and perform actions within the permissions granted to the service account.</p><p>Make sure to <a href=https://cloud.google.com/service-usage/docs/enable-disable>enable the Google Identity and Access Management (IAM) API</a>.
<a href=https://cloud.google.com/iam/docs/creating-managing-service-accounts>Create a Service Account</a> that shall be used for the Shoot cluster.
<a href=https://cloud.google.com/iam/docs/granting-changing-revoking-access>Grant at least the following IAM roles</a> to the Service Account.</p><ul><li>Service Account Admin</li><li>Service Account Token Creator</li><li>Service Account User</li><li>Compute Admin</li></ul><p>Create a <a href=https://cloud.google.com/iam/docs/creating-managing-service-account-keys#creating_service_account_keys>JSON Service Account key</a> for the Service Account.
Provide it in the <code>Secret</code> (base64 encoded for field <code>serviceaccount.json</code>), that is being referenced by the <code>SecretBinding</code> in the Shoot cluster configuration.</p><p>This <code>Secret</code> must look as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: core-gcp
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  serviceaccount.json: base64(serviceaccount-json)
</span></span></code></pre></div><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>Depending on your API usage it can be problematic to reuse the same Service Account Key for different Shoot clusters due to rate limits.
Please consider spreading your Shoots over multiple Service Accounts on different GCP projects if you are hitting those limits, see <a href=https://cloud.google.com/compute/docs/api-rate-limits>https://cloud.google.com/compute/docs/api-rate-limits</a>.</p></blockquote><h3 id=gcp-workload-identity-federation>GCP Workload Identity Federation<a class=td-heading-self-link href=#gcp-workload-identity-federation aria-label="Heading self-link"></a></h3><p>Users can choose to trust Gardener&rsquo;s Workload Identity Issuer and eliminate the need for providing GCP Service Account credentials.</p><p>As a first step users should configure <a href=https://cloud.google.com/iam/docs/workload-identity-federation-with-kubernetes#kubernetes>Workload Identity Federation</a> with Gardener&rsquo;s Workload Identity Issuer.
In the example attribute mapping shown below all <code>WorkloadIdentity</code>s that are created in the <code>garden-myproj</code> namespace will be authenticated.
Now that the Workload Identity Federation is configured the user should download the credential configuration file.</p><blockquote class="alert alert-important"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>message-outline</title><path d="M20 2H4C2.9 2 2 2.9 2 4V22l4-4H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2m0 14H5.2L4 17.2V4H20V16z"/></svg><p>Important</p></div><p>If required, users can use a stricter mapping to authenticate only certain <code>WorkloadIdentity</code>s.
Please, refer to the <a href=https://cloud.google.com/iam/docs/workload-identity-federation#mapping>attribute mappings documentation</a> for more information.</p></blockquote><p><img src=/__resources/attribute_mapping_75bcec.png alt="Attribute Mapping"></p><p>Users should now create a Service Account that is going to be impersonated by the federated identity.
Make sure to <a href=https://cloud.google.com/service-usage/docs/enable-disable>enable the Google Identity and Access Management (IAM) API</a>.
<a href=https://cloud.google.com/iam/docs/creating-managing-service-accounts>Create a Service Account</a> that shall be used for the Shoot cluster.
<a href=https://cloud.google.com/iam/docs/granting-changing-revoking-access>Grant at least the following IAM roles</a> to the Service Account.</p><ul><li>Service Account Token Creator</li><li>Service Account User</li><li>Compute Admin</li></ul><p>As a next step a resource of type <code>WorkloadIdentity</code> should be created in the Garden cluster and configured with the information from the already downloaded credential configuration file.
This identity will be used to impersonate the Service Account in order to call GCP APIs.</p><p>Mind that the <code>service_account_impersonation_url</code> is probably not present in the downloaded credential configuration file.
You can use the example template or download a new credential configuration file once we grant the permission to the federated identity to impersonate the Service Account.</p><p>A sample of such resource is shown below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: security.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: WorkloadIdentity
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: gcp
</span></span><span style=display:flex><span>  namespace: garden-myproj
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  audiences:
</span></span><span style=display:flex><span>  <span style=color:green># This is the audience that you configure during workload identity pool creation</span>
</span></span><span style=display:flex><span>  - https://iam.googleapis.com/projects/&lt;project_number&gt;/locations/global/workloadIdentityPools/&lt;pool_name&gt;/providers/&lt;provider_name&gt;
</span></span><span style=display:flex><span>  targetSystem:
</span></span><span style=display:flex><span>    type: gcp
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: WorkloadIdentityConfig
</span></span><span style=display:flex><span>      projectID: gcp-project-name <span style=color:green># This is the name of the project which the workload identity will access</span>
</span></span><span style=display:flex><span>      <span style=color:green># Use the downloaded credential configuration file to set this field. The credential_source field is not important to Gardener and can be omitted.</span>
</span></span><span style=display:flex><span>      credentialsConfig:
</span></span><span style=display:flex><span>        universe_domain: <span style=color:#a31515>&#34;googleapis.com&#34;</span>
</span></span><span style=display:flex><span>        type: <span style=color:#a31515>&#34;external_account&#34;</span>
</span></span><span style=display:flex><span>        audience: <span style=color:#a31515>&#34;//iam.googleapis.com/projects/&lt;project_number&gt;/locations/global/workloadIdentityPools/&lt;pool_name&gt;/providers/&lt;provider_name&gt;&#34;</span>
</span></span><span style=display:flex><span>        subject_token_type: <span style=color:#a31515>&#34;urn:ietf:params:oauth:token-type:jwt&#34;</span>
</span></span><span style=display:flex><span>        service_account_impersonation_url: <span style=color:#a31515>&#34;https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/&lt;service_account_email&gt;:generateAccessToken&#34;</span>
</span></span><span style=display:flex><span>        token_url: <span style=color:#a31515>&#34;https://sts.googleapis.com/v1/token&#34;</span>
</span></span></code></pre></div><p>Now users should give permissions to the <code>WorkloadIdentity</code> to impersonate the Service Account.
In order to construct the principal that will be used for impersonation retrieve the subject of the created <code>WorkloadIdentity</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SUBJECT=<span style=color:#00f>$(</span>kubectl -n garden-myproj get workloadidentity gcp -o=jsonpath=<span style=color:#a31515>&#39;{.status.sub}&#39;</span><span style=color:#00f>)</span>
</span></span><span style=display:flex><span>echo <span style=color:#a31515>&#34;principal://iam.googleapis.com/projects/&lt;project_number&gt;/locations/global/workloadIdentityPools/&lt;pool_name&gt;/subject/</span>$SUBJECT<span style=color:#a31515>&#34;</span>
</span></span></code></pre></div><p>The principal template is also shown in the Google Console Workload Identity Pool UI.</p><p>Users should give this principal the Role <code>Workload Identity User</code> so that it can impersonate the Service Account.
One can do this through the Service Account <code>Permissions</code> tab, through the Google Console Workload Identity Pool UI or by using the <a href=https://cloud.google.com/iam/docs/workload-identity-federation-with-kubernetes#use-service-account-impersonation>gcloud cli</a>.</p><p>As a final step create a <code>CredentialsBinding</code> referencing the GCP <code>WorkloadIdentity</code> and use it in your <code>Shoot</code> definitions.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: security.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: CredentialsBinding
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: gcp
</span></span><span style=display:flex><span>  namespace: garden-myproj
</span></span><span style=display:flex><span>credentialsRef:
</span></span><span style=display:flex><span>  apiVersion: security.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: WorkloadIdentity
</span></span><span style=display:flex><span>  name: gcp
</span></span><span style=display:flex><span>  namespace: garden-myproj
</span></span><span style=display:flex><span>provider:
</span></span><span style=display:flex><span>  type: gcp
</span></span></code></pre></div><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>One can omit the creation of Service Account and directly grant access to the federated identity&rsquo;s principal, skipping the Service Account impersonation.
This although recommended, will not always work because federated identities do not fall under the <a href=https://cloud.google.com/iam/docs/principals-overview#all-authenticated-users><code>allAuthenticatedUsers</code></a> category and cannot access machine images that are not made available to <a href=https://cloud.google.com/iam/docs/principals-overview#all-users><code>allUsers</code></a>.
This means that machine images should be made available to <code>allUsers</code> or permissions should be explicitly given to the federated identity in order for this to work.</p><p>GCP imposes some restrictions on which images can be accessible to <code>allUsers</code>.
As of now, <a href=https://github.com/gardenlinux/gardenlinux>Gardenlinux</a> images are not published in a way that they can be accessed by <code>allUsers</code>.
See the following issue for more details <a href=https://github.com/gardenlinux/glci/issues/148>https://github.com/gardenlinux/glci/issues/148</a>.</p></blockquote><h2 id=infrastructureconfig><code>InfrastructureConfig</code><a class=td-heading-self-link href=#infrastructureconfig aria-label="Heading self-link"></a></h2><p>The infrastructure configuration mainly describes how the network layout looks like in order to create the shoot worker nodes in a later step, thus, prepares everything relevant to create VMs, load balancers, volumes, etc.</p><p>An example <code>InfrastructureConfig</code> for the GCP extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: InfrastructureConfig
</span></span><span style=display:flex><span>networks:
</span></span><span style=display:flex><span><span style=color:green># vpc:</span>
</span></span><span style=display:flex><span><span style=color:green>#   name: my-vpc</span>
</span></span><span style=display:flex><span><span style=color:green>#   cloudRouter:</span>
</span></span><span style=display:flex><span><span style=color:green>#     name: my-cloudrouter</span>
</span></span><span style=display:flex><span>  workers: 10.250.0.0/16
</span></span><span style=display:flex><span><span style=color:green># internal: 10.251.0.0/16</span>
</span></span><span style=display:flex><span><span style=color:green># cloudNAT:</span>
</span></span><span style=display:flex><span><span style=color:green>#   minPortsPerVM: 2048</span>
</span></span><span style=display:flex><span><span style=color:green>#   maxPortsPerVM: 65536</span>
</span></span><span style=display:flex><span><span style=color:green>#   endpointIndependentMapping:</span>
</span></span><span style=display:flex><span><span style=color:green>#     enabled: false</span>
</span></span><span style=display:flex><span><span style=color:green>#   enableDynamicPortAllocation: false</span>
</span></span><span style=display:flex><span><span style=color:green>#   natIPNames:</span>
</span></span><span style=display:flex><span><span style=color:green>#   - name: manualnat1</span>
</span></span><span style=display:flex><span><span style=color:green>#   - name: manualnat2</span>
</span></span><span style=display:flex><span><span style=color:green>#   udpIdleTimeoutSec: 30</span>
</span></span><span style=display:flex><span><span style=color:green>#   icmpIdleTimeoutSec: 30</span>
</span></span><span style=display:flex><span><span style=color:green>#   tcpEstablishedIdleTimeoutSec: 1200</span>
</span></span><span style=display:flex><span><span style=color:green>#   tcpTransitoryIdleTimeoutSec: 30</span>
</span></span><span style=display:flex><span><span style=color:green>#   tcpTimeWaitTimeoutSec: 120</span>
</span></span><span style=display:flex><span><span style=color:green># flowLogs:</span>
</span></span><span style=display:flex><span><span style=color:green>#   aggregationInterval: INTERVAL_5_SEC</span>
</span></span><span style=display:flex><span><span style=color:green>#   flowSampling: 0.2</span>
</span></span><span style=display:flex><span><span style=color:green>#   metadata: INCLUDE_ALL_METADATA</span>
</span></span></code></pre></div><p>The <code>networks.vpc</code> section describes whether you want to create the shoot cluster in an already existing VPC or whether to create a new one:</p><ul><li><p>If <code>networks.vpc.name</code> is given then you have to specify the VPC name of the existing VPC that was created by other means (manually, other tooling, &mldr;).
If you want to get a fresh VPC for the shoot then just omit the <code>networks.vpc</code> field.</p></li><li><p>If a VPC name is not given then we will create the cloud router + NAT gateway to ensure that worker nodes don&rsquo;t get external IPs.</p></li><li><p>If a VPC name is given then a cloud router name must also be given, failure to do so would result in validation errors
and possibly clusters without egress connectivity.</p></li><li><p>If a VPC name is given and calico shoot clusters are created without a network overlay within one VPC make sure that the pod CIDR specified in <code>shoot.spec.networking.pods</code> is not overlapping with any other pod CIDR used in that VPC.
Overlapping pod CIDRs will lead to disfunctional shoot clusters.</p></li></ul><p>The <code>networks.workers</code> section describes the CIDR for a subnet that is used for all shoot worker nodes, i.e., VMs which later run your applications.</p><p>The <code>networks.internal</code> section is optional and can describe a CIDR for a subnet that is used for <a href=https://cloud.google.com/load-balancing/docs/internal/>internal load balancers</a>,</p><p>The <code>networks.cloudNAT.minPortsPerVM</code> is optional and is used to define the <a href=https://cloud.google.com/nat/docs/overview#number_of_nat_ports_and_connections>minimum number of ports allocated to a VM for the CloudNAT</a></p><p>The <code>networks.cloudNAT.natIPNames</code> is optional and is used to specify the names of the manual ip addresses which should be used by the nat gateway</p><p>The <code>networks.cloudNAT.endpointIndependentMapping</code> is optional and is used to define the <a href=https://cloud.google.com/nat/docs/ports-and-addresses#ports-reuse-endpoints>endpoint mapping behavior</a>. You can enable it or disable it at any point by toggling <code>networks.cloudNAT.endpointIndependentMapping.enabled</code>. By default, it is disabled.</p><p><code>networks.cloudNAT.enableDynamicPortAllocation</code> is optional (default: <code>false</code>) and allows one to enable dynamic port allocation (<a href=https://cloud.google.com/nat/docs/ports-and-addresses#dynamic-port>https://cloud.google.com/nat/docs/ports-and-addresses#dynamic-port</a>). Note that enabling this puts additional restrictions on the permitted values for <code>networks.cloudNAT.minPortsPerVM</code> and <code>networks.cloudNAT.minPortsPerVM</code>, namely that they now both are required to be powers of two. Also, <code>maxPortsPerVM</code> may not be given if dynamic port allocation is <em>disabled</em>.</p><p><code>networks.cloudNAT.udpIdleTimeoutSec</code>, <code>networks.cloudNAT.icmpIdleTimeoutSec</code>, <code>networks.cloudNAT.tcpEstablishedIdleTimeoutSec</code>, <code>networks.cloudNAT.tcpTransitoryIdleTimeoutSec</code>, and <code>networks.cloudNAT.tcpTimeWaitTimeoutSec</code> give more fine-granular control over various timeout-values. For more details see <a href=https://cloud.google.com/nat/docs/public-nat#specs-timeouts>https://cloud.google.com/nat/docs/public-nat#specs-timeouts</a>.</p><p>The specified CIDR ranges must be contained in the VPC CIDR specified above, or the VPC CIDR of your already existing VPC.
You can freely choose these CIDRs and it is your responsibility to properly design the network layout to suit your needs.</p><p>The <code>networks.flowLogs</code> section describes the configuration for the VPC flow logs. In order to enable the VPC flow logs at least one of the following parameters needs to be specified in the flow log section:</p><ul><li><p><code>networks.flowLogs.aggregationInterval</code> an optional parameter describing the aggregation interval for collecting flow logs. For more details, see <a href=https://www.terraform.io/docs/providers/google/r/compute_subnetwork.html#aggregation_interval>aggregation_interval reference</a>.</p></li><li><p><code>networks.flowLogs.flowSampling</code> an optional parameter describing the sampling rate of VPC flow logs within the subnetwork where 1.0 means all collected logs are reported and 0.0 means no logs are reported. For more details, see <a href=https://www.terraform.io/docs/providers/google/r/compute_subnetwork.html#flow_sampling>flow_sampling reference</a>.</p></li><li><p><code>networks.flowLogs.metadata</code> an optional parameter describing whether metadata fields should be added to the reported VPC flow logs. For more details, see <a href=https://www.terraform.io/docs/providers/google/r/compute_subnetwork.html#metadata>metadata reference</a>.</p></li></ul><p>Apart from the VPC and the subnets the GCP extension will also create a dedicated service account for this shoot, and firewall rules.</p><h2 id=controlplaneconfig><code>ControlPlaneConfig</code><a class=td-heading-self-link href=#controlplaneconfig aria-label="Heading self-link"></a></h2><p>The control plane configuration mainly contains values for the GCP-specific control plane components.
Today, the only component deployed by the GCP extension is the <code>cloud-controller-manager</code>.</p><p>An example <code>ControlPlaneConfig</code> for the GCP extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: ControlPlaneConfig
</span></span><span style=display:flex><span>zone: europe-west1-b
</span></span><span style=display:flex><span>cloudControllerManager:
</span></span><span style=display:flex><span><span style=color:green># featureGates:</span>
</span></span><span style=display:flex><span><span style=color:green>#   SomeKubernetesFeature: true</span>
</span></span><span style=display:flex><span>storage:
</span></span><span style=display:flex><span>  managedDefaultStorageClass: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  managedDefaultVolumeSnapshotClass: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>The <code>zone</code> field tells the cloud-controller-manager in which zone it should mainly operate.
You can still create clusters in multiple availability zones, however, the cloud-controller-manager requires one &ldquo;main&rdquo; zone.
&#9888;&#xfe0f; You always have to specify this field!</p><p>The <code>cloudControllerManager.featureGates</code> contains a map of explicitly enabled or disabled feature gates.
For production usage it&rsquo;s not recommend to use this field at all as you can enable alpha features or disable beta/stable features, potentially impacting the cluster stability.
If you don&rsquo;t want to configure anything for the <code>cloudControllerManager</code> simply omit the key in the YAML specification.</p><p>The members of the <code>storage</code> allows to configure the provided storage classes further. If <code>storage.managedDefaultStorageClass</code> is enabled (the default), the <code>default</code> StorageClass deployed will be marked as default (via <code>storageclass.kubernetes.io/is-default-class</code> annotation). Similarly, if <code>storage.managedDefaultVolumeSnapshotClass</code> is enabled (the default), the <code>default</code> VolumeSnapshotClass deployed will be marked as default.
In case you want to set a different StorageClass or VolumeSnapshotClass as default you need to set the corresponding option to <code>false</code> as at most one class should be marked as default in each case and the ResourceManager will prevent any changes from the Gardener managed classes to take effect.</p><h2 id=workerconfig>WorkerConfig<a class=td-heading-self-link href=#workerconfig aria-label="Heading self-link"></a></h2><p>The worker configuration contains:</p><ul><li><p>Local SSD interface for the additional volumes attached to GCP worker machines.</p><p>If you attach the disk with <code>SCRATCH</code> type, either an <code>NVMe</code> interface or a <code>SCSI</code> interface must be specified.
It is only meaningful to provide this volume interface if only <code>SCRATCH</code> data volumes are used.</p></li><li><p>Volume Encryption config that specifies values for <code>kmsKeyName</code> and <code>kmsKeyServiceAccountName</code>.</p><ul><li>The <code>kmsKeyName</code> is the
key name of the cloud kms disk encryption key and must be specified if CMEK disk encryption is needed.</li><li>The <code>kmsKeyServiceAccount</code> is the service account granted the <code>roles/cloudkms.cryptoKeyEncrypterDecrypter</code> on the <code>kmsKeyName</code>
If empty, then the role should be given to the Compute Engine Service Agent Account. This CESA account usually has the name:
<code>service-PROJECT_NUMBER@compute-system.iam.gserviceaccount.com</code>. See: <a href=https://cloud.google.com/iam/docs/service-agents#compute-engine-service-agent>https://cloud.google.com/iam/docs/service-agents#compute-engine-service-agent</a></li><li>Prior to use, the operator should add IAM policy binding using the gcloud CLI:<pre tabindex=0><code>gcloud projects add-iam-policy-binding projectId --member
serviceAccount:name@projectIdgserviceaccount.com --role roles/cloudkms.cryptoKeyEncrypterDecrypter
</code></pre></li></ul></li><li><p>Setting a volume image with <code>dataVolumes.sourceImage</code>.
However, this parameter should only be used with particular caution.
For example Gardenlinux works with filesystem LABELs only and creating another disk form the very same image causes the LABELs to be duplicated.
See: <a href=https://github.com/gardener/gardener-extension-provider-gcp/issues/323>https://github.com/gardener/gardener-extension-provider-gcp/issues/323</a></p></li><li><p>Some hyperdisks allow adjustment of their default values for <code>provisionedIops</code> and <code>provisionedThroughput</code>.
Keep in mind though that Hyperdisk Extreme and Hyperdisk Throughput volumes can&rsquo;t be used as boot disks.</p></li><li><p>Service Account with their specified scopes, authorized for this worker.</p><p>Service accounts created in advance that generate access tokens that can be accessed through the metadata server and used to authenticate applications on the instance.</p><p><strong>Note</strong>: If you do not provide service accounts for your workers, the Compute Engine default service account will be used. For more details on the default account, see <a href=https://cloud.google.com/compute/docs/access/service-accounts#default_service_account>https://cloud.google.com/compute/docs/access/service-accounts#default_service_account</a>.
If the <code>DisableGardenerServiceAccountCreation</code> feature gate is disabled, Gardener will create a shared service accounts to use for all instances. This feature gate is currently in beta and it will no longer be possible to re-enable the service account creation via feature gate flag.</p></li><li><p>GPU with its type and count per node. This will attach that GPU to all the machines in the worker grp</p><p><strong>Note</strong>:</p><ul><li><p>A rolling upgrade of the worker group would be triggered in case the <code>acceleratorType</code> or <code>count</code> is updated.</p></li><li><p>Some machineTypes like <a href=https://cloud.google.com/blog/products/compute/announcing-google-cloud-a2-vm-family-based-on-nvidia-a100-gpu>a2 family</a> come with already attached gpu of <code>a100</code> type and pre-defined count. If your workerPool consists of such machineTypes, please specify exact GPU configuration for the machine type as specified in Google cloud documentation. <code>acceleratorType</code> to use for families with attached gpu are stated below:</p><ol><li><em>a2 family</em> -> <code>nvidia-tesla-a100</code></li><li><em>g2 family</em> -> <code>nvidia-l4</code></li></ol></li><li><p>Sufficient quota of gpu is needed in the GCP project. This includes quota to support autoscaling if enabled.</p></li><li><p>GPU-attached machines can&rsquo;t be live migrated during host maintenance events. Find out how to handle that in your application <a href=https://cloud.google.com/compute/docs/gpus/gpu-host-maintenance>here</a></p></li><li><p>GPU count specified here is considered for forming node template during scale-from-zero in Cluster Autoscaler</p></li></ul></li><li><p>The <code>.nodeTemplate</code> is used to specify resource information of the machine during runtime. This then helps in Scale-from-Zero.
Some points to note for this field:</p><ul><li>Currently only cpu, gpu and memory are configurable.</li><li>a change in the value lead to a rolling update of the machine in the workerpool</li><li>all the resources needs to be specified</li></ul><p>An example <code>WorkerConfig</code> for the GCP looks as follows:</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: WorkerConfig
</span></span><span style=display:flex><span>volume:
</span></span><span style=display:flex><span>  interface: NVME
</span></span><span style=display:flex><span>  encryption:
</span></span><span style=display:flex><span>    kmsKeyName: <span style=color:#a31515>&#34;projects/projectId/locations/&lt;zoneName&gt;/keyRings/&lt;keyRingName&gt;/cryptoKeys/alpha&#34;</span>
</span></span><span style=display:flex><span>    kmsKeyServiceAccount: <span style=color:#a31515>&#34;user@projectId.iam.gserviceaccount.com&#34;</span>
</span></span><span style=display:flex><span>dataVolumes:
</span></span><span style=display:flex><span>  - name: test
</span></span><span style=display:flex><span>    sourceImage: projects/sap-se-gcp-gardenlinux/global/images/gardenlinux-gcp-gardener-prod-amd64-1443-3-c261f887
</span></span><span style=display:flex><span>    provisionedIops: 3000
</span></span><span style=display:flex><span>    provisionedThroughput: 140
</span></span><span style=display:flex><span>serviceAccount:
</span></span><span style=display:flex><span>  email: foo@bar.com
</span></span><span style=display:flex><span>  scopes:
</span></span><span style=display:flex><span>  - https://www.googleapis.com/auth/cloud-platform
</span></span><span style=display:flex><span>gpu:
</span></span><span style=display:flex><span>  acceleratorType: nvidia-tesla-t4
</span></span><span style=display:flex><span>  count: 1
</span></span><span style=display:flex><span>nodeTemplate: <span style=color:green># (to be specified only if the node capacity would be different from cloudprofile info during runtime)</span>
</span></span><span style=display:flex><span>  capacity:
</span></span><span style=display:flex><span>    cpu: 2
</span></span><span style=display:flex><span>    gpu: 1
</span></span><span style=display:flex><span>    memory: 50Gi
</span></span></code></pre></div><h2 id=example-shoot-manifest>Example <code>Shoot</code> manifest<a class=td-heading-self-link href=#example-shoot-manifest aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-gcp
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfile:
</span></span><span style=display:flex><span>    name: gcp
</span></span><span style=display:flex><span>  region: europe-west1
</span></span><span style=display:flex><span>  secretBindingName: core-gcp
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: gcp
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        workers: 10.250.0.0/16
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>      zone: europe-west1-b
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: n1-standard-4
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: pd-standard
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - europe-west1-b
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.2
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=csi-volume-provisioners>CSI volume provisioners<a class=td-heading-self-link href=#csi-volume-provisioners aria-label="Heading self-link"></a></h2><p>Every GCP shoot cluster will be deployed with the GCP PD CSI driver.
It is compatible with the legacy in-tree volume provisioner that was deprecated by the Kubernetes community and will be removed in future versions of Kubernetes.
End-users might want to update their custom <code>StorageClass</code>es to the new <code>pd.csi.storage.gke.io</code> provisioner.</p><h2 id=support-for-volumeattributesclasses-beta-in-k8s-131>Support for VolumeAttributesClasses (Beta in k8s 1.31)<a class=td-heading-self-link href=#support-for-volumeattributesclasses-beta-in-k8s-131 aria-label="Heading self-link"></a></h2><p>To have the CSI-driver configured to support the necessary features for <a href=https://kubernetes.io/docs/concepts/storage/volume-attributes-classes/>VolumeAttributesClasses</a> on GCP for shoots with a k8s-version greater than 1.31, use the <code>gcp.provider.extensions.gardener.cloud/enable-volume-attributes-class</code> annotation on the shoot. Keep in mind to also enable the required feature flags and runtime-config on the common kubernetes controllers (as outlined in the link above) in the shoot-spec.</p><h2 id=kubernetes-versions-per-worker-pool>Kubernetes Versions per Worker Pool<a class=td-heading-self-link href=#kubernetes-versions-per-worker-pool aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>WorkerPoolKubernetesVersion</code> feature gate, i.e., having <a href=https://github.com/gardener/gardener/blob/8a9c88866ec5fce59b5acf57d4227eeeb73669d7/example/90-shoot.yaml#L69-L70>worker pools with overridden Kubernetes versions</a> since <code>gardener-extension-provider-gcp@v1.21</code>.</p><h2 id=shoot-ca-certificate-and-serviceaccount-signing-key-rotation>Shoot CA Certificate and <code>ServiceAccount</code> Signing Key Rotation<a class=td-heading-self-link href=#shoot-ca-certificate-and-serviceaccount-signing-key-rotation aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>ShootCARotation</code> and <code>ShootSARotation</code> feature gates since <code>gardener-extension-provider-gcp@v1.23</code>.</p><h2 id=backupbucket>BackupBucket<a class=td-heading-self-link href=#backupbucket aria-label="Heading self-link"></a></h2><p>Gardener manages <code>etcd</code> backups for Shoot clusters using provider-specific backup storage solutions. On GCP, this storage is implemented through <a href=https://cloud.google.com/storage/docs/buckets#buckets>Google Cloud Storage (GCS) buckets</a>, which store snapshots of the cluster’s <code>etcd</code> data.</p><p>The <code>BackupBucket</code> resource abstracts the backup infrastructure, enabling Gardener and its extension controllers to manage it seamlessly. This abstraction allows Gardener to create, delete, and maintain backup buckets across various cloud providers in a standardized manner.</p><p>The <code>BackupBucket</code> resource includes a <code>spec</code> field, which defines the configuration details for the backup bucket. These details include:</p><ul><li>The region where the bucket should be created.</li><li>A reference to the secret containing credentials for accessing the cloud provider.</li><li>A <code>ProviderConfig</code> field for provider-specific configurations.</li></ul><h3 id=backupbucketconfig>BackupBucketConfig<a class=td-heading-self-link href=#backupbucketconfig aria-label="Heading self-link"></a></h3><p>The <code>BackupBucketConfig</code> represents the configuration for a backup bucket. It includes an optional immutability configuration that enforces retention policies on the backup bucket.</p><p>The Gardener extension provider for GCP supports creating and managing immutable backup buckets by leveraging the <a href=https://cloud.google.com/storage/docs/bucket-lock>bucket lock</a> feature. Immutability ensures that once data is written to the bucket, it cannot be modified or deleted for a specified period. This feature is crucial for protecting backups from accidental or malicious deletion, ensuring data safety and availability for restoration.</p><p>Here is an example configuration for <code>BackupBucketConfig</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: BackupBucketConfig
</span></span><span style=display:flex><span>immutability:
</span></span><span style=display:flex><span>  retentionType: bucket
</span></span><span style=display:flex><span>  retentionPeriod: <span style=color:#a31515>&#34;24h&#34;</span>
</span></span><span style=display:flex><span>  locked: <span style=color:#00f>false</span>
</span></span></code></pre></div><ul><li><strong><code>retentionType</code></strong>: Specifies the type of retention policy. The allowed value is <code>bucket</code>, which applies the retention policy to the entire bucket. For more details, refer to the <a href=https://cloud.google.com/storage/docs/bucket-lock>documentation</a>.</li><li><strong><code>retentionPeriod</code></strong>: Defines the duration for which objects in the bucket will remain immutable. The value should follow GCP-supported formats, such as <code>"24h"</code> for 24 hours. Refer to <a href=https://cloud.google.com/storage/docs/bucket-lock#retention-periods>retention period formats</a> for more information. The minimum retention period is <strong>24 hours</strong>.</li><li><strong><code>locked</code></strong>: A boolean indicating whether the retention policy is locked. Once locked, the policy cannot be removed or shortened, ensuring immutability. Learn more about locking policies <a href=https://cloud.google.com/storage/docs/bucket-lock#policy-locks>here</a>.</li></ul><p>To configure a <code>BackupBucket</code> with immutability, include the <code>BackupBucketConfig</code> in the <code>ProviderConfig</code> of the <code>BackupBucket</code> resource. If the <code>locked</code> field is set to <code>true</code>, the retention policy will be locked, preventing further changes.</p><p>Here is an example of configuring a <code>BackupBucket</code> with immutability:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: BackupBucket
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-backup-bucket
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    region: europe-west1
</span></span><span style=display:flex><span>  secretRef:
</span></span><span style=display:flex><span>    name: my-gcp-secret
</span></span><span style=display:flex><span>    namespace: my-namespace
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: BackupBucketConfig
</span></span><span style=display:flex><span>    immutability:
</span></span><span style=display:flex><span>      retentionType: bucket
</span></span><span style=display:flex><span>      retentionPeriod: 24h
</span></span><span style=display:flex><span>      locked: <span style=color:#00f>true</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-b46674e0cabcf6e848e4d419e8c17465>1.6 - Provider Openstack</h1><div class=lead>Gardener extension controller for the OpenStack cloud provider</div><h1 id=gardener-extension-for-openstack-providerhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for OpenStack provider</a><a class=td-heading-self-link href=#gardener-extension-for-openstack-providerhttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-provider-openstack><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-provider-openstack alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-provider-openstack-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-provider-openstack-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-provider-openstack><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-provider-openstack alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the OpenStack provider.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-provider-openstack/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=supported-kubernetes-versions>Supported Kubernetes versions<a class=td-heading-self-link href=#supported-kubernetes-versions aria-label="Heading self-link"></a></h2><p>This extension controller supports the following Kubernetes versions:</p><table><thead><tr><th>Version</th><th>Support</th><th>Conformance test results</th></tr></thead><tbody><tr><td>Kubernetes 1.32</td><td>1.32.0+</td><td>N/A</td></tr><tr><td>Kubernetes 1.31</td><td>1.31.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.31%20OpenStack><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.31%20OpenStack/tests_status?style=svg" alt="Gardener v1.31 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.30</td><td>1.30.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.30%20OpenStack><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.30%20OpenStack/tests_status?style=svg" alt="Gardener v1.30 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.29</td><td>1.29.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.29%20OpenStack><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.29%20OpenStack/tests_status?style=svg" alt="Gardener v1.29 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.28</td><td>1.28.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.28%20OpenStack><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.28%20OpenStack/tests_status?style=svg" alt="Gardener v1.28 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.27</td><td>1.27.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.27%20OpenStack><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.27%20OpenStack/tests_status?style=svg" alt="Gardener v1.27 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.26</td><td>1.26.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.26%20OpenStack><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.26%20OpenStack/tests_status?style=svg" alt="Gardener v1.26 Conformance Tests"></a></td></tr><tr><td>Kubernetes 1.25</td><td>1.25.0+</td><td><a href=https://testgrid.k8s.io/conformance-gardener#Gardener,%20v1.25%20OpenStack><img src="https://testgrid.k8s.io/q/summary/conformance-gardener/Gardener,%20v1.25%20OpenStack/tests_status?style=svg" alt="Gardener v1.25 Conformance Tests"></a></td></tr></tbody></table><p>Please take a look <a href=/docs/gardener/shoot-operations/supported_k8s_versions/>here</a> to see which versions are supported by Gardener in general.</p><hr><h2 id=compatibility>Compatibility<a class=td-heading-self-link href=#compatibility aria-label="Heading self-link"></a></h2><p>The following lists known compatibility issues of this extension controller with other Gardener components.</p><table><thead><tr><th>OpenStack Extension</th><th>Gardener</th><th>Action</th><th>Notes</th></tr></thead><tbody><tr><td><code>&lt; v1.12.0</code></td><td><code>> v1.10.0</code></td><td>Please update the provider version to <code>>= v1.12.0</code> or disable the feature gate <code>MountHostCADirectories</code> in the Gardenlet.</td><td>Applies if feature flag <code>MountHostCADirectories</code> in the Gardenlet is enabled. This is to prevent duplicate volume mounts to <code>/usr/share/ca-certificates</code> in the Shoot API Server.</td></tr></tbody></table><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>.</p><p>Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-provider-openstack/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/04-new-core-gardener-cloud-apis.md>GEP-4 (New <code>core.gardener.cloud/v1beta1</code> API)</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-0f4e10642c2c30cf21153633c30e4808>1.6.1 - Deployment</h1><h1 id=deployment-of-the-openstack-provider-extension>Deployment of the OpenStack provider extension<a class=td-heading-self-link href=#deployment-of-the-openstack-provider-extension aria-label="Heading self-link"></a></h1><p><strong>Disclaimer:</strong> This document is NOT a step by step installation guide for the OpenStack provider extension and only contains some configuration specifics regarding the installation of different components via the helm charts residing in the OpenStack provider extension <a href=https://github.com/gardener/gardener-extension-provider-openstack>repository</a>.</p><h2 id=gardener-extension-admission-openstack>gardener-extension-admission-openstack<a class=td-heading-self-link href=#gardener-extension-admission-openstack aria-label="Heading self-link"></a></h2><h3 id=authentication-against-the-garden-cluster>Authentication against the Garden cluster<a class=td-heading-self-link href=#authentication-against-the-garden-cluster aria-label="Heading self-link"></a></h3><p>There are several authentication possibilities depending on whether or not <a href=https://github.com/gardener/garden-setup#concept-the-virtual-cluster>the concept of <em>Virtual Garden</em></a> is used.</p><h4 id=virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster><em>Virtual Garden</em> is not used, i.e., the <code>runtime</code> Garden cluster is also the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster aria-label="Heading self-link"></a></h4><p><strong>Automounted Service Account Token</strong>
The easiest way to deploy the <code>gardener-extension-admission-openstack</code> component will be to not provide <code>kubeconfig</code> at all. This way in-cluster configuration and an automounted service account token will be used. The drawback of this approach is that the automounted token will not be automatically rotated.</p><p><strong>Service Account Token Volume Projection</strong>
Another solution will be to use <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>Service Account Token Volume Projection</a> combined with a <code>kubeconfig</code> referencing a token file (see example below).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://default.kubernetes.svc.cluster.local
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: garden
</span></span><span style=display:flex><span>    user: garden
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>current-context: garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div><p>This will allow for automatic rotation of the service account token by the <code>kubelet</code>. The configuration can be achieved by setting both <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.kubeconfig</code> in the respective chart&rsquo;s <code>values.yaml</code> file.</p><h4 id=virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster><em>Virtual Garden</em> is used, i.e., the <code>runtime</code> Garden cluster is different from the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster aria-label="Heading self-link"></a></h4><p><strong>Service Account</strong>
The easiest way to setup the authentication will be to create a service account and the respective roles will be bound to this service account in the <code>target</code> cluster. Then use the generated service account token and craft a <code>kubeconfig</code> which will be used by the workload in the <code>runtime</code> cluster. This approach does not provide a solution for the rotation of the service account token. However, this setup can be achieved by setting <code>.Values.global.virtualGarden.enabled: true</code> and following these steps:</p><ol><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Get the service account token and craft the <code>kubeconfig</code>.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><p><strong>Client Certificate</strong>
Another solution will be to bind the roles in the <code>target</code> cluster to a <code>User</code> subject instead of a service account and use a client certificate for authentication. This approach does not provide a solution for the client certificate rotation. However, this setup can be achieved by setting both <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>, then following these steps:</p><ol><li>Generate a client certificate for the <code>target</code> cluster for the respective user.</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Craft a <code>kubeconfig</code> using the already generated client certificate.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><p><strong>Projected Service Account Token</strong>
This approach requires an already deployed and configured <a href=https://github.com/gardener/oidc-webhook-authenticator>oidc-webhook-authenticator</a> for the <code>target</code> cluster. Also the <code>runtime</code> cluster should be registered as a trusted identity provider in the <code>target</code> cluster. Then projected service accounts tokens from the <code>runtime</code> cluster can be used to authenticate against the <code>target</code> cluster. The needed steps are as follows:</p><ol><li>Deploy <a href=https://github.com/gardener/oidc-webhook-authenticator>OWA</a> and establish the needed trust.</li><li>Set <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>. <strong>Note:</strong> username value will depend on the trust configuration, e.g., <code>&lt;prefix>:system:serviceaccount:&lt;namespace>:&lt;serviceaccount></code></li><li>Set <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.serviceAccountTokenVolumeProjection.audience</code>. <strong>Note:</strong> audience value will depend on the trust configuration, e.g., <code>&lt;cliend-id-from-trust-config></code>.</li><li>Craft a kubeconfig (see example below).</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://virtual-garden.api
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: virtual-garden
</span></span><span style=display:flex><span>    user: virtual-garden
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>current-context: virtual-garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: virtual-garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ee3a6965a7798320d3839fae1d5ac560>1.6.2 - Local Setup</h1><h3 id=admission-openstack>admission-openstack<a class=td-heading-self-link href=#admission-openstack aria-label="Heading self-link"></a></h3><p><code>admission-openstack</code> is an admission webhook server which is responsible for the validation of the cloud provider (OpenStack in this case) specific fields and resources. The Gardener API server is cloud provider agnostic and it wouldn&rsquo;t be able to perform similar validation.</p><p>Follow the steps below to run the admission webhook server locally.</p><ol><li><p>Start the Gardener API server.</p><p>For details, check the Gardener <a href=/docs/gardener/local_setup/>local setup</a>.</p></li><li><p>Start the webhook server</p><p>Make sure that the <code>KUBECONFIG</code> environment variable is pointing to the local garden cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make start-admission
</span></span></code></pre></div></li><li><p>Setup the <code>ValidatingWebhookConfiguration</code>.</p><p><code>hack/dev-setup-admission-openstack.sh</code> will configure the webhook Service which will allow the kube-apiserver of your local cluster to reach the webhook server. It will also apply the <code>ValidatingWebhookConfiguration</code> manifest.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./hack/dev-setup-admission-openstack.sh
</span></span></code></pre></div></li></ol><p>You are now ready to experiment with the <code>admission-openstack</code> webhook server locally.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3df166b7d9a610b7b2c577e05a949958>1.6.3 - Operations</h1><h1 id=using-the-openstack-provider-extension-with-gardener-as-operator>Using the OpenStack provider extension with Gardener as operator<a class=td-heading-self-link href=#using-the-openstack-provider-extension-with-gardener-as-operator aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/30-cloudprofile.yaml><code>core.gardener.cloud/v1beta1.CloudProfile</code> resource</a> declares a <code>providerConfig</code> field that is meant to contain provider-specific configuration.</p><p>In this document we are describing how this configuration looks like for OpenStack and provide an example <code>CloudProfile</code> manifest with minimal configuration that you can use to allow creating OpenStack shoot clusters.</p><h2 id=cloudprofileconfig><code>CloudProfileConfig</code><a class=td-heading-self-link href=#cloudprofileconfig aria-label="Heading self-link"></a></h2><p>The cloud profile configuration contains information about the real machine image IDs in the OpenStack environment (image names).
You have to map every version that you specify in <code>.spec.machineImages[].versions</code> here such that the OpenStack extension knows the image ID for every version you want to offer.</p><p>It also contains optional default values for DNS servers that shall be used for shoots.
In the <code>dnsServers[]</code> list you can specify IP addresses that are used as DNS configuration for created shoot subnets.</p><p>Also, you have to specify the keystone URL in the <code>keystoneURL</code> field to your environment.</p><p>Additionally, you can influence the HTTP request timeout when talking to the OpenStack API in the <code>requestTimeout</code> field.
This may help when you have for example a long list of load balancers in your environment.</p><p>In case your OpenStack system uses <a href=https://docs.openstack.org/octavia/latest/>Octavia</a> for network load balancing then you have to set the <code>useOctavia</code> field to <code>true</code> such that the cloud-controller-manager for OpenStack gets correctly configured (it defaults to <code>false</code>).</p><p>Some hypervisors (especially those which are VMware-based) don&rsquo;t automatically send a new volume size to a Linux kernel when a volume is resized and in-use.
For those hypervisors you can enable the storage plugin interacting with Cinder to telling the SCSI block device to refresh its information to provide information about it&rsquo;s updated size to the kernel. You might need to enable this behavior depending on the underlying hypervisor of your OpenStack installation. The <code>rescanBlockStorageOnResize</code> field controls this. Please note that it only applies for Kubernetes versions where CSI is used.</p><p>Some openstack configurations do not allow to attach more volumes than a specific amount to a single node.
To tell the k8s scheduler to not over schedule volumes on a node, you can set <code>nodeVolumeAttachLimit</code> which defaults to 256.
Some openstack configurations have different names for volume and compute availability zones, which might cause pods to go into pending state as there are no nodes available in the detected volume AZ. To ignore the volume AZ when scheduling pods, you can set <code>ignoreVolumeAZ</code> to <code>true</code> (it defaults to <code>false</code>).
See <a href=https://github.com/kubernetes/cloud-provider-openstack/blob/master/docs/cinder-csi-plugin/using-cinder-csi-plugin.md#block-storage>CSI Cinder driver</a>.</p><p>The cloud profile config also contains constraints for floating pools and load balancer providers that can be used in shoots.</p><p>If your OpenStack system supports server groups, the <code>serverGroupPolicies</code> property will enable your end-users to create shoots with workers where the nodes are managed by Nova&rsquo;s server groups.
Specifying <code>serverGroupPolicies</code> is optional and can be omitted. If enabled, the end-user can choose whether or not to use this feature for a shoot&rsquo;s workers. Gardener will handle the creation of the server group and node assignment.</p><p>To enable this feature, an operator should:</p><ul><li>specify the allowed policy values (e.g. <code>affintity</code>, <code>anti-affinity</code>) in this section. Only the policies in the allow-list will be available for end-users.</li><li>make sure that your OpenStack project has enough server group capacity. Otherwise, shoot creation will fail.</li></ul><p>If your OpenStack system has multiple <code>volume-types</code>, the <code>storageClasses</code> property enables the creation of kubernetes <code>storageClasses</code> for shoots.
Set <code>storageClasses[].parameters.type</code> to map it with an openstack <code>volume-type</code>. Specifying <code>storageClasses</code> is optional and can be omitted.</p><p>An example <code>CloudProfileConfig</code> for the OpenStack extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: openstack.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: CloudProfileConfig
</span></span><span style=display:flex><span>machineImages:
</span></span><span style=display:flex><span>- name: coreos
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>  - version: 2135.6.0
</span></span><span style=display:flex><span>    <span style=color:green># Fallback to image name if no region mapping is found</span>
</span></span><span style=display:flex><span>    <span style=color:green># Only works for amd64 and is strongly discouraged. Prefer image IDs!</span>
</span></span><span style=display:flex><span>    image: coreos-2135.6.0
</span></span><span style=display:flex><span>    regions:
</span></span><span style=display:flex><span>    - name: europe
</span></span><span style=display:flex><span>      id: <span style=color:#a31515>&#34;1234-amd64&#34;</span>
</span></span><span style=display:flex><span>      architecture: amd64 <span style=color:green># optional, defaults to amd64</span>
</span></span><span style=display:flex><span>    - name: europe
</span></span><span style=display:flex><span>      id: <span style=color:#a31515>&#34;1234-arm64&#34;</span>
</span></span><span style=display:flex><span>      architecture: arm64
</span></span><span style=display:flex><span>    - name: asia
</span></span><span style=display:flex><span>      id: <span style=color:#a31515>&#34;5678-amd64&#34;</span>
</span></span><span style=display:flex><span>      architecture: amd64
</span></span><span style=display:flex><span><span style=color:green># keystoneURL: https://url-to-keystone/v3/</span>
</span></span><span style=display:flex><span><span style=color:green># keystoneURLs:</span>
</span></span><span style=display:flex><span><span style=color:green># - region: europe</span>
</span></span><span style=display:flex><span><span style=color:green>#   url: https://europe.example.com/v3/</span>
</span></span><span style=display:flex><span><span style=color:green># - region: asia</span>
</span></span><span style=display:flex><span><span style=color:green>#   url: https://asia.example.com/v3/</span>
</span></span><span style=display:flex><span><span style=color:green># dnsServers:</span>
</span></span><span style=display:flex><span><span style=color:green># - 10.10.10.11</span>
</span></span><span style=display:flex><span><span style=color:green># - 10.10.10.12</span>
</span></span><span style=display:flex><span><span style=color:green># requestTimeout: 60s</span>
</span></span><span style=display:flex><span><span style=color:green># useOctavia: true</span>
</span></span><span style=display:flex><span><span style=color:green># useSNAT: true</span>
</span></span><span style=display:flex><span><span style=color:green># rescanBlockStorageOnResize: true</span>
</span></span><span style=display:flex><span><span style=color:green># ignoreVolumeAZ: true</span>
</span></span><span style=display:flex><span><span style=color:green># nodeVolumeAttachLimit: 30</span>
</span></span><span style=display:flex><span><span style=color:green># serverGroupPolicies:</span>
</span></span><span style=display:flex><span><span style=color:green># - soft-anti-affinity</span>
</span></span><span style=display:flex><span><span style=color:green># - anti-affinity</span>
</span></span><span style=display:flex><span><span style=color:green># resolvConfOptions:</span>
</span></span><span style=display:flex><span><span style=color:green># - rotate</span>
</span></span><span style=display:flex><span><span style=color:green># - timeout:1</span>
</span></span><span style=display:flex><span><span style=color:green># storageClasses:</span>
</span></span><span style=display:flex><span><span style=color:green># - name: example-sc</span>
</span></span><span style=display:flex><span><span style=color:green>#   default: false</span>
</span></span><span style=display:flex><span><span style=color:green>#   provisioner: cinder.csi.openstack.org</span>
</span></span><span style=display:flex><span><span style=color:green>#   volumeBindingMode: WaitForFirstConsumer</span>
</span></span><span style=display:flex><span><span style=color:green>#   parameters:</span>
</span></span><span style=display:flex><span><span style=color:green>#     type: storage_premium_perf0</span>
</span></span><span style=display:flex><span>constraints:
</span></span><span style=display:flex><span>  floatingPools:
</span></span><span style=display:flex><span>  - name: fp-pool-1
</span></span><span style=display:flex><span><span style=color:green>#   region: europe</span>
</span></span><span style=display:flex><span><span style=color:green>#   loadBalancerClasses:</span>
</span></span><span style=display:flex><span><span style=color:green>#   - name: lb-class-1</span>
</span></span><span style=display:flex><span><span style=color:green>#     floatingSubnetID: &#34;1234&#34;</span>
</span></span><span style=display:flex><span><span style=color:green>#     floatingNetworkID: &#34;4567&#34;</span>
</span></span><span style=display:flex><span><span style=color:green>#     subnetID: &#34;7890&#34;</span>
</span></span><span style=display:flex><span><span style=color:green># - name: &#34;fp-pool-*&#34;</span>
</span></span><span style=display:flex><span><span style=color:green>#   region: europe</span>
</span></span><span style=display:flex><span><span style=color:green>#   loadBalancerClasses:</span>
</span></span><span style=display:flex><span><span style=color:green>#   - name: lb-class-1</span>
</span></span><span style=display:flex><span><span style=color:green>#     floatingSubnetID: &#34;1234&#34;</span>
</span></span><span style=display:flex><span><span style=color:green>#     floatingNetworkID: &#34;4567&#34;</span>
</span></span><span style=display:flex><span><span style=color:green>#     subnetID: &#34;7890&#34;</span>
</span></span><span style=display:flex><span><span style=color:green># - name: &#34;fp-pool-eu-demo&#34;</span>
</span></span><span style=display:flex><span><span style=color:green>#   region: europe</span>
</span></span><span style=display:flex><span><span style=color:green>#   domain: demo</span>
</span></span><span style=display:flex><span><span style=color:green>#   loadBalancerClasses:</span>
</span></span><span style=display:flex><span><span style=color:green>#   - name: lb-class-1</span>
</span></span><span style=display:flex><span><span style=color:green>#     floatingSubnetID: &#34;1234&#34;</span>
</span></span><span style=display:flex><span><span style=color:green>#     floatingNetworkID: &#34;4567&#34;</span>
</span></span><span style=display:flex><span><span style=color:green>#     subnetID: &#34;7890&#34;</span>
</span></span><span style=display:flex><span><span style=color:green># - name: &#34;fp-pool-eu-dev&#34;</span>
</span></span><span style=display:flex><span><span style=color:green>#   region: europe</span>
</span></span><span style=display:flex><span><span style=color:green>#   domain: dev</span>
</span></span><span style=display:flex><span><span style=color:green>#   nonConstraining: true</span>
</span></span><span style=display:flex><span><span style=color:green>#   loadBalancerClasses:</span>
</span></span><span style=display:flex><span><span style=color:green>#   - name: lb-class-1</span>
</span></span><span style=display:flex><span><span style=color:green>#     floatingSubnetID: &#34;1234&#34;</span>
</span></span><span style=display:flex><span><span style=color:green>#     floatingNetworkID: &#34;4567&#34;</span>
</span></span><span style=display:flex><span><span style=color:green>#     subnetID: &#34;7890&#34;</span>
</span></span><span style=display:flex><span>  loadBalancerProviders:
</span></span><span style=display:flex><span>  - name: haproxy
</span></span><span style=display:flex><span><span style=color:green># - name: f5</span>
</span></span><span style=display:flex><span><span style=color:green>#   region: asia</span>
</span></span><span style=display:flex><span><span style=color:green># - name: haproxy</span>
</span></span><span style=display:flex><span><span style=color:green>#   region: asia</span>
</span></span></code></pre></div><p>Please note that it is possible to configure a region mapping for keystone URLs, floating pools, and load balancer providers.
Additionally, floating pools can be constrainted to a keystone domain by specifying the <code>domain</code> field.
Floating pool names may also contains simple wildcard expressions, like <code>*</code> or <code>fp-pool-*</code> or <code>*-fp-pool</code>. Please note that the <code>*</code> must be either single or at the beginning or at the end. Consequently, <code>fp-*-pool</code> is not possible/allowed.
The default behavior is that, if found, the regional (and/or domain restricted) entry is taken.
If no entry for the given region exists then the fallback value is the most matching entry (w.r.t. wildcard matching) in the list without a <code>region</code> field (or the <code>keystoneURL</code> value for the keystone URLs).
If an additional floating pool should be selectable for a region and/or domain, you can mark it as non constraining
with setting the optional field <code>nonConstraining</code> to <code>true</code>.
Multiple <code>loadBalancerProviders</code> can be specified in the <code>CloudProfile</code>. Each provider may specify a region constraint for where it can be used.
If at least one region specific entry exists in the <code>CloudProfile</code>, the shoot&rsquo;s specified <code>loadBalancerProvider</code> must adhere to the list of the available providers of that region. Otherwise, one of the non-regional specific providers should be used.
Each entry in the <code>loadBalancerProviders</code> must be uniquely identified by its name and if applicable, its region.</p><p>The <code>loadBalancerClasses</code> field is an optional list of load balancer classes which can be when the corresponding floating pool network is choosen. The load balancer classes can be configured in the same way as in the <code>ControlPlaneConfig</code> in the <code>Shoot</code> resource, therefore see <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-openstack/usage/#ControlPlaneConfig>here</a> for more details.</p><p>Some OpenStack environments don&rsquo;t need these regional mappings, hence, the <code>region</code> and <code>keystoneURLs</code> fields are optional.
If your OpenStack environment only has regional values and it doesn&rsquo;t make sense to provide a (non-regional) fallback then simply
omit <code>keystoneURL</code> and always specify <code>region</code>.</p><p>If Gardener creates and manages the router of a shoot cluster, it is additionally possible to specify that the <a href=https://registry.terraform.io/providers/terraform-provider-openstack/openstack/latest/docs/resources/networking_router_v2#enable_snat>enable_snat</a> field is set to <code>true</code> via <code>useSNAT: true</code> in the <code>CloudProfileConfig</code>.</p><p>On some OpenStack enviroments, there may be the need to set options in the file <code>/etc/resolv.conf</code> on worker nodes.
If the field <code>resolvConfOptions</code> is set, a systemd service will be installed which copies <code>/run/systemd/resolve/resolv.conf</code>
on every change to <code>/etc/resolv.conf</code> and appends the given options.</p><h2 id=example-cloudprofile-manifest>Example <code>CloudProfile</code> manifest<a class=td-heading-self-link href=#example-cloudprofile-manifest aria-label="Heading self-link"></a></h2><p>Please find below an example <code>CloudProfile</code> manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: CloudProfile
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: openstack
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: openstack
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 1.27.3
</span></span><span style=display:flex><span>    - version: 1.26.8
</span></span><span style=display:flex><span>      expirationDate: <span style=color:#a31515>&#34;2022-10-31T23:59:59Z&#34;</span>
</span></span><span style=display:flex><span>  machineImages:
</span></span><span style=display:flex><span>  - name: coreos
</span></span><span style=display:flex><span>    versions:
</span></span><span style=display:flex><span>    - version: 2135.6.0
</span></span><span style=display:flex><span>      architectures: <span style=color:green># optional, defaults to [amd64]</span>
</span></span><span style=display:flex><span>      - amd64
</span></span><span style=display:flex><span>      - arm64
</span></span><span style=display:flex><span>  machineTypes:
</span></span><span style=display:flex><span>  - name: medium_4_8
</span></span><span style=display:flex><span>    cpu: <span style=color:#a31515>&#34;4&#34;</span>
</span></span><span style=display:flex><span>    gpu: <span style=color:#a31515>&#34;0&#34;</span>
</span></span><span style=display:flex><span>    memory: 8Gi
</span></span><span style=display:flex><span>    architecture: amd64 <span style=color:green># optional, defaults to amd64</span>
</span></span><span style=display:flex><span>    storage:
</span></span><span style=display:flex><span>      class: standard
</span></span><span style=display:flex><span>      type: default
</span></span><span style=display:flex><span>      size: 40Gi
</span></span><span style=display:flex><span>  - name: medium_4_8_arm
</span></span><span style=display:flex><span>    cpu: <span style=color:#a31515>&#34;4&#34;</span>
</span></span><span style=display:flex><span>    gpu: <span style=color:#a31515>&#34;0&#34;</span>
</span></span><span style=display:flex><span>    memory: 8Gi
</span></span><span style=display:flex><span>    architecture: arm64
</span></span><span style=display:flex><span>    storage:
</span></span><span style=display:flex><span>      class: standard
</span></span><span style=display:flex><span>      type: default
</span></span><span style=display:flex><span>      size: 40Gi
</span></span><span style=display:flex><span>  regions:
</span></span><span style=display:flex><span>  - name: europe-1
</span></span><span style=display:flex><span>    zones:
</span></span><span style=display:flex><span>    - name: europe-1a
</span></span><span style=display:flex><span>    - name: europe-1b
</span></span><span style=display:flex><span>    - name: europe-1c
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: openstack.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: CloudProfileConfig
</span></span><span style=display:flex><span>    machineImages:
</span></span><span style=display:flex><span>    - name: coreos
</span></span><span style=display:flex><span>      versions:
</span></span><span style=display:flex><span>      - version: 2135.6.0
</span></span><span style=display:flex><span>        <span style=color:green># Fallback to image name if no region mapping is found</span>
</span></span><span style=display:flex><span>        <span style=color:green># Only works for amd64 and is strongly discouraged. Prefer image IDs!</span>
</span></span><span style=display:flex><span>        image: coreos-2135.6.0
</span></span><span style=display:flex><span>        regions:
</span></span><span style=display:flex><span>        - name: europe
</span></span><span style=display:flex><span>          id: <span style=color:#a31515>&#34;1234-amd64&#34;</span>
</span></span><span style=display:flex><span>          architecture: amd64 <span style=color:green># optional, defaults to amd64</span>
</span></span><span style=display:flex><span>        - name: europe
</span></span><span style=display:flex><span>          id: <span style=color:#a31515>&#34;1234-arm64&#34;</span>
</span></span><span style=display:flex><span>          architecture: arm64
</span></span><span style=display:flex><span>        - name: asia
</span></span><span style=display:flex><span>          id: <span style=color:#a31515>&#34;5678-amd64&#34;</span>
</span></span><span style=display:flex><span>          architecture: amd64
</span></span><span style=display:flex><span>    keystoneURL: https://url-to-keystone/v3/
</span></span><span style=display:flex><span>    constraints:
</span></span><span style=display:flex><span>      floatingPools:
</span></span><span style=display:flex><span>      - name: fp-pool-1
</span></span><span style=display:flex><span>      loadBalancerProviders:
</span></span><span style=display:flex><span>      - name: haproxy
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-549286e04ceb30d6fbbbb06051934d8c>1.6.4 - Usage</h1><h1 id=using-the-openstack-provider-extension-with-gardener-as-end-user>Using the OpenStack provider extension with Gardener as end-user<a class=td-heading-self-link href=#using-the-openstack-provider-extension-with-gardener-as-end-user aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a few fields that are meant to contain provider-specific configuration.</p><p>In this document we are describing how this configuration looks like for OpenStack and provide an example <code>Shoot</code> manifest with minimal configuration that you can use to create an OpenStack cluster (modulo the landscape-specific information like cloud profile names, secret binding names, etc.).</p><h2 id=provider-secret-data>Provider Secret Data<a class=td-heading-self-link href=#provider-secret-data aria-label="Heading self-link"></a></h2><p>Every shoot cluster references a <code>SecretBinding</code> or a <code>CredentialsBinding</code> which itself references a <code>Secret</code>, and this <code>Secret</code> contains the provider credentials of your OpenStack tenant.
This <code>Secret</code> must look as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: core-openstack
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  domainName: base64(domain-name)
</span></span><span style=display:flex><span>  tenantName: base64(tenant-name)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:green># either use username/password</span>
</span></span><span style=display:flex><span>  username: base64(user-name)
</span></span><span style=display:flex><span>  password: base64(password)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># or application credentials</span>
</span></span><span style=display:flex><span>  <span style=color:green>#applicationCredentialID: base64(app-credential-id)</span>
</span></span><span style=display:flex><span>  <span style=color:green>#applicationCredentialName: base64(app-credential-name) # optional</span>
</span></span><span style=display:flex><span>  <span style=color:green>#applicationCredentialSecret: base64(app-credential-secret)</span>
</span></span></code></pre></div><p>Please look up <a href=https://docs.openstack.org/keystone/pike/admin/identity-concepts.html>https://docs.openstack.org/keystone/pike/admin/identity-concepts.html</a> as well.</p><p>For authentication with username/password see <a href=https://docs.openstack.org/keystone/latest/user/supported_clients.html>Keystone username/password</a></p><p>Alternatively, for authentication with application credentials see <a href=https://docs.openstack.org/keystone/latest/user/application_credentials.html>Keystone Application Credentials</a>.</p><p>⚠️ Depending on your API usage it can be problematic to reuse the same provider credentials for different Shoot clusters due to rate limits.
Please consider spreading your Shoots over multiple credentials from different tenants if you are hitting those limits.</p><h2 id=infrastructureconfig><code>InfrastructureConfig</code><a class=td-heading-self-link href=#infrastructureconfig aria-label="Heading self-link"></a></h2><p>The infrastructure configuration mainly describes how the network layout looks like in order to create the shoot worker nodes in a later step, thus, prepares everything relevant to create VMs, load balancers, volumes, etc.</p><p>An example <code>InfrastructureConfig</code> for the OpenStack extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: openstack.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: InfrastructureConfig
</span></span><span style=display:flex><span>floatingPoolName: MY-FLOATING-POOL
</span></span><span style=display:flex><span><span style=color:green># floatingPoolSubnetName: my-floating-pool-subnet-name</span>
</span></span><span style=display:flex><span>networks:
</span></span><span style=display:flex><span><span style=color:green># id: 12345678-abcd-efef-08af-0123456789ab</span>
</span></span><span style=display:flex><span><span style=color:green># router:</span>
</span></span><span style=display:flex><span><span style=color:green>#   id: 1234</span>
</span></span><span style=display:flex><span>  workers: 10.250.0.0/19
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># shareNetwork:</span>
</span></span><span style=display:flex><span><span style=color:green>#   enabled: true</span>
</span></span></code></pre></div><p>The <code>floatingPoolName</code> is the name of the floating pool you want to use for your shoot.
If you don&rsquo;t know which floating pools are available look it up in the respective <code>CloudProfile</code>.</p><p>With <code>floatingPoolSubnetName</code> you can explicitly define to which subnet in the floating pool network (defined via <code>floatingPoolName</code>) the router should be attached to.</p><p><code>networks.id</code> is an optional field. If it is given, you can specify the uuid of an existing private Neutron network (created manually, by other tooling, &mldr;) that should be reused. A new subnet for the Shoot will be created in it.</p><p>If a <code>networks.id</code> is given and calico shoot clusters are created without a network overlay within one network make sure that the pod CIDR specified in <code>shoot.spec.networking.pods</code> is not overlapping with any other pod CIDR used in that network.
Overlapping pod CIDRs will lead to disfunctional shoot clusters.</p><p>The <code>networks.router</code> section describes whether you want to create the shoot cluster in an already existing router or whether to create a new one:</p><ul><li><p>If <code>networks.router.id</code> is given then you have to specify the router id of the existing router that was created by other means (manually, other tooling, &mldr;).
If you want to get a fresh router for the shoot then just omit the <code>networks.router</code> field.</p></li><li><p>In any case, the shoot cluster will be created in a <strong>new</strong> subnet.</p></li></ul><p>The <code>networks.workers</code> section describes the CIDR for a subnet that is used for all shoot worker nodes, i.e., VMs which later run your applications.</p><p>You can freely choose these CIDRs and it is your responsibility to properly design the network layout to suit your needs.</p><p>Apart from the router and the worker subnet the OpenStack extension will also create a network, router interfaces, security groups, and a key pair.</p><p>The optional <code>networks.shareNetwork.enabled</code> field controls the creation of a share network. This is only needed if shared
file system storage (like NFS) should be used. Note, that in this case, the <code>ControlPlaneConfig</code> needs additional configuration, too.</p><h2 id=controlplaneconfig><code>ControlPlaneConfig</code><a class=td-heading-self-link href=#controlplaneconfig aria-label="Heading self-link"></a></h2><p>The control plane configuration mainly contains values for the OpenStack-specific control plane components.
Today, the only component deployed by the OpenStack extension is the <code>cloud-controller-manager</code>.</p><p>An example <code>ControlPlaneConfig</code> for the OpenStack extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: openstack.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: ControlPlaneConfig
</span></span><span style=display:flex><span>loadBalancerProvider: haproxy
</span></span><span style=display:flex><span>loadBalancerClasses:
</span></span><span style=display:flex><span>- name: lbclass-1
</span></span><span style=display:flex><span>  purpose: default
</span></span><span style=display:flex><span>  floatingNetworkID: fips-1-id
</span></span><span style=display:flex><span>  floatingSubnetName: internet-*
</span></span><span style=display:flex><span>- name: lbclass-2
</span></span><span style=display:flex><span>  floatingNetworkID: fips-1-id
</span></span><span style=display:flex><span>  floatingSubnetTags: internal,private
</span></span><span style=display:flex><span>- name: lbclass-3
</span></span><span style=display:flex><span>  purpose: private
</span></span><span style=display:flex><span>  subnetID: internal-id
</span></span><span style=display:flex><span><span style=color:green># cloudControllerManager:</span>
</span></span><span style=display:flex><span><span style=color:green>#   featureGates:</span>
</span></span><span style=display:flex><span><span style=color:green>#     SomeKubernetesFeature: true</span>
</span></span><span style=display:flex><span><span style=color:green># storage:</span>
</span></span><span style=display:flex><span><span style=color:green>#   csiManila:</span>
</span></span><span style=display:flex><span><span style=color:green>#     enabled: true</span>
</span></span></code></pre></div><p>The <code>loadBalancerProvider</code> is the provider name you want to use for load balancers in your shoot.
If you don&rsquo;t know which types are available look it up in the respective <code>CloudProfile</code>.</p><p>The <code>loadBalancerClasses</code> field contains an optional list of load balancer classes which will be available in the cluster. Each entry can have the following fields:</p><ul><li><code>name</code> to select the load balancer class via the kubernetes <a href=https://github.com/kubernetes/cloud-provider-openstack/blob/master/docs/openstack-cloud-controller-manager/expose-applications-using-loadbalancer-type-service.md#switching-between-floating-subnets-by-using-preconfigured-classes>service annotations</a> <code>loadbalancer.openstack.org/class=name</code></li><li><code>purpose</code> with values <code>default</code> or <code>private</code><ul><li>The configuration of the <code>default</code> load balancer class will be used as default for all other kubernetes loadbalancer services without a class annotation</li><li>The configuration of the <code>private</code> load balancer class will be also set to the global loadbalancer configuration of the cluster, but will be overridden by the <code>default</code> purpose</li></ul></li><li><code>floatingNetworkID</code> can be specified to receive an ip from an floating/external network, additionally the subnet in this network can be selected via<ul><li><code>floatingSubnetName</code> can be either a full subnet name or a regex/glob to match subnet name</li><li><code>floatingSubnetTags</code> a comma seperated list of subnet tags</li><li><code>floatingSubnetID</code> the id of a specific subnet</li></ul></li><li><code>subnetID</code> can be specified by to receive an ip from an internal subnet (will not have an effect in combination with floating/external network configuration)</li></ul><p>The <code>cloudControllerManager.featureGates</code> contains a map of explicitly enabled or disabled feature gates.
For production usage it&rsquo;s not recommended to use this field at all as you can enable alpha features or disable beta/stable features, potentially impacting the cluster stability.
If you don&rsquo;t want to configure anything for the <code>cloudControllerManager</code> simply omit the key in the YAML specification.</p><p>The optional <code>storage.csiManila.enabled</code> field is used to enable the deployment of the CSI Manila driver to support NFS persistent volumes.
In this case, please ensure to set <code>networks.shareNetwork.enabled=true</code> in the <code>InfrastructureConfig</code>, too.
Additionally, if CSI Manila driver is enabled, for each availability zone a NFS <code>StorageClass</code> will be created on the shoot
named like <code>csi-manila-nfs-&lt;zone></code>.</p><h2 id=workerconfig><code>WorkerConfig</code><a class=td-heading-self-link href=#workerconfig aria-label="Heading self-link"></a></h2><p>Each worker group in a shoot may contain provider-specific configurations and options. These are contained in the <code>providerConfig</code> section of a worker group and can be configured using a <code>WorkerConfig</code> object.
An example of a <code>WorkerConfig</code> looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: openstack.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: WorkerConfig
</span></span><span style=display:flex><span>serverGroup:
</span></span><span style=display:flex><span>  policy: soft-anti-affinity
</span></span><span style=display:flex><span><span style=color:green># nodeTemplate: # (to be specified only if the node capacity would be different from cloudprofile info during runtime)</span>
</span></span><span style=display:flex><span><span style=color:green>#   capacity:</span>
</span></span><span style=display:flex><span><span style=color:green>#     cpu: 2</span>
</span></span><span style=display:flex><span><span style=color:green>#     gpu: 0</span>
</span></span><span style=display:flex><span><span style=color:green>#     memory: 50Gi</span>
</span></span><span style=display:flex><span><span style=color:green># machineLabels:</span>
</span></span><span style=display:flex><span><span style=color:green>#  - name: my-label</span>
</span></span><span style=display:flex><span><span style=color:green>#    value: foo</span>
</span></span><span style=display:flex><span><span style=color:green>#  - name: my-rolling-label</span>
</span></span><span style=display:flex><span><span style=color:green>#    value: bar</span>
</span></span><span style=display:flex><span><span style=color:green>#    triggerRollingOnUpdate: true # means any change of the machine label value will trigger rolling of all machines of the worker pool</span>
</span></span></code></pre></div><h3 id=servergroups>ServerGroups<a class=td-heading-self-link href=#servergroups aria-label="Heading self-link"></a></h3><p>When you specify the <code>serverGroup</code> section in your worker group configuration, a new server group will be created with the configured policy for each worker group that enabled this setting and all machines managed by this worker group will be assigned as members of the created server group.</p><p>For users to have access to the server group feature, it must be enabled on the <code>CloudProfile</code> by your operator.
Existing clusters can take advantage of this feature by updating the server group configuration of their respective worker groups. Worker groups that are already configured with server groups can update their setting to change the policy used, or remove it altogether at any time.</p><p>Users must be aware that <strong>any change to the server group settings will result in a rolling deployment of new nodes for the affected worker group</strong>.</p><p>Please note the following restrictions when deploying workers with server groups:</p><ul><li>The <code>serverGroup</code> section is optional, but if it is included in the worker configuration, it must contain a valid policy value.</li><li>The available <code>policy</code> values that can be used, are defined in the provider specific section of <code>CloudProfile</code> by your operator.</li><li>Certain policy values may induce further constraints. Using the <code>affinity</code> policy is only allowed when the worker group utilizes a single zone.</li></ul><h3 id=machinelabels>MachineLabels<a class=td-heading-self-link href=#machinelabels aria-label="Heading self-link"></a></h3><p>The <code>machineLabels</code> section in the worker group configuration allows to specify additional machine labels. These labels are added to the machine
instances only, but not to the node object. Additionally, they have an optional <code>triggerRollingOnUpdate</code> field. If it is set to <code>true</code>, changing the label value
will trigger a rolling of all machines of this worker pool.</p><h3 id=node-templates>Node Templates<a class=td-heading-self-link href=#node-templates aria-label="Heading self-link"></a></h3><p>Node templates allow users to override the capacity of the nodes as defined by the server flavor specified in the <code>CloudProfile</code>&rsquo;s <code>machineTypes</code>. This is useful for certain dynamic scenarios as it allows users to customize cluster-autoscaler&rsquo;s behavior for these workergroup with their provided values.</p><h2 id=example-shoot-manifest-one-availability-zone>Example <code>Shoot</code> manifest (one availability zone)<a class=td-heading-self-link href=#example-shoot-manifest-one-availability-zone aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest for one availability zone:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-openstack
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfile:
</span></span><span style=display:flex><span>    name: openstack
</span></span><span style=display:flex><span>  region: europe-1
</span></span><span style=display:flex><span>  secretBindingName: core-openstack
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: openstack
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: openstack.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      floatingPoolName: MY-FLOATING-POOL
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        workers: 10.250.0.0/19
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: openstack.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>      loadBalancerProvider: haproxy
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: medium_4_8
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - europe-1a
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.2
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=csi-volume-provisioners>CSI volume provisioners<a class=td-heading-self-link href=#csi-volume-provisioners aria-label="Heading self-link"></a></h2><p>Every OpenStack shoot cluster will be deployed with the OpenStack Cinder CSI driver.
It is compatible with the legacy in-tree volume provisioner that was deprecated by the Kubernetes community and will be removed in future versions of Kubernetes.
End-users might want to update their custom <code>StorageClass</code>es to the new <code>cinder.csi.openstack.org</code> provisioner.</p><h2 id=kubernetes-versions-per-worker-pool>Kubernetes Versions per Worker Pool<a class=td-heading-self-link href=#kubernetes-versions-per-worker-pool aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>WorkerPoolKubernetesVersion</code> feature gate, i.e., having <a href=https://github.com/gardener/gardener/blob/8a9c88866ec5fce59b5acf57d4227eeeb73669d7/example/90-shoot.yaml#L69-L70>worker pools with overridden Kubernetes versions</a> since <code>gardener-extension-provider-openstack@v1.23</code>.</p><h2 id=shoot-ca-certificate-and-serviceaccount-signing-key-rotation>Shoot CA Certificate and <code>ServiceAccount</code> Signing Key Rotation<a class=td-heading-self-link href=#shoot-ca-certificate-and-serviceaccount-signing-key-rotation aria-label="Heading self-link"></a></h2><p>This extension supports <code>gardener/gardener</code>&rsquo;s <code>ShootCARotation</code> and <code>ShootSARotation</code> feature gates since <code>gardener-extension-provider-openstack@v1.26</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cf44505b1a6fee28c6d8a49feb963c88>2 - Operating System Extensions</h1><div class=lead>Gardener extension controllers for the supported operating systems</div></div><div class=td-content><h1 id=pg-cd6184375a7182a45366dc72ad6e13d1>2.1 - CoreOS/FlatCar OS</h1><div class=lead>Gardener extension controller for the CoreOS/FlatCar Container Linux operating system</div><h1 id=gardener-extension-for-coreos-container-linuxhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for CoreOS Container Linux</a><a class=td-heading-self-link href=#gardener-extension-for-coreos-container-linuxhttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-os-coreos><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-os-coreos alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener-public/pipelines/gardener-extension-os-coreos-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener-public/pipelines/gardener-extension-os-coreos-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-os-coreos><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-os-coreos alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service. Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>. However, the project has grown to a size where it is very hard to extend, maintain, and test. With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics. This way, we can keep Gardener core clean and independent.</p><p>This controller operates on the <code>OperatingSystemConfig</code> resource in the <code>extensions.gardener.cloud/v1alpha1</code> API group. It supports <a href=https://coreos.com/os/docs/latest/>CoreOS Container Linux</a> and <a href=https://www.flatcar-linux.org/>Flatcar Container Linux</a> (&ldquo;a friendly fork of CoreOS Container Linux&rdquo;).</p><p>The controller manages those objects that are requesting <a href=https://coreos.com/os/docs/latest/>CoreOS Container Linux</a> configuration (<code>.spec.type=coreos</code>) or <a href=https://www.flatcar-linux.org/>Flatcar Container Linux</a> configuration (<code>.spec.type=flatcar</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: OperatingSystemConfig
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: pool-01-original
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: coreos
</span></span><span style=display:flex><span>  units:
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  files:
</span></span><span style=display:flex><span>    ...
</span></span></code></pre></div><p>Please find <a href=https://github.com/gardener/gardener-extension-os-coreos/blob/master/example/40-operatingsystemconfig.yaml>a concrete example</a> in the <code>example</code> folder.</p><p>After reconciliation the resulting data will be stored in a secret within the same namespace (as the config itself might contain confidential data). The name of the secret will be written into the resource&rsquo;s <code>.status</code> field:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>status:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  cloudConfig:
</span></span><span style=display:flex><span>    secretRef:
</span></span><span style=display:flex><span>      name: osc-result-pool-01-original
</span></span><span style=display:flex><span>      namespace: default
</span></span><span style=display:flex><span>  command: /usr/bin/coreos-cloudinit -from-file=&lt;path&gt;
</span></span><span style=display:flex><span>  units:
</span></span><span style=display:flex><span>  - docker-monitor.service
</span></span><span style=display:flex><span>  - kubelet-monitor.service
</span></span><span style=display:flex><span>  - kubelet.service
</span></span></code></pre></div><p>The secret has one data key <code>cloud_config</code> that stores the generation.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-os-coreos/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the kubeconfig to the cluster you want to connect to ready in the <code>./dev/kubeconfig</code> file.</p><p>Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-os-coreos/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7490efaa24f7fa053776844f854c404c>2.1.1 - Usage</h1><h1 id=using-the-coreos-extension-with-gardener-as-end-user>Using the CoreOS extension with Gardener as end-user<a class=td-heading-self-link href=#using-the-coreos-extension-with-gardener-as-end-user aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a few fields that must be considered when this OS extension is used.</p><p>In this document we describe how this configuration looks like and under which circumstances your attention may be required.</p><h2 id=aws-vpc-settings-for-coreos-workers>AWS VPC settings for CoreOS workers<a class=td-heading-self-link href=#aws-vpc-settings-for-coreos-workers aria-label="Heading self-link"></a></h2><p>Gardener allows you to create CoreOS based worker nodes by:</p><ol><li>Using a Gardener managed VPC</li><li>Reusing a VPC that already exists (VPC <code>id</code> specified in <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/usage/#infrastructureconfig>InfrastructureConfig</a>]</li></ol><p>If the second option applies to your use-case please make sure that your VPC has enabled <strong>DNS Support</strong>. Otherwise CoreOS based nodes aren&rsquo;t able to join or operate in your cluster properly.</p><p><strong><a href=https://docs.aws.amazon.com/vpc/latest/userguide/vpc-dns.html>DNS</a></strong> settings (required):</p><ul><li><code>enableDnsHostnames</code>: true (necessary for collecting <a href=https://kubernetes.io/docs/tasks/debug-application-cluster/resource-metrics-pipeline/>node metrics</a>)</li><li><code>enableDnsSupport</code>: true</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-0aede9ce025bb447b055d2593567eef6>2.2 - Garden Linux OS</h1><div class=lead>Gardener extension controller for the Garden Linux operating system</div><h1 id=gardener-extension-for-garden-linux-oshttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Garden Linux OS</a><a class=td-heading-self-link href=#gardener-extension-for-garden-linux-oshttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-os-gardenlinux><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-os-gardenlinux alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-os-gardenlinux-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-os-gardenlinux-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-os-gardenlinux><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-os-gardenlinux alt="Go Report Card"></a></p><p>This controller operates on the <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md#cloud-config-user-data-for-bootstrapping-machines><code>OperatingSystemConfig</code></a> resource in the <code>extensions.gardener.cloud/v1alpha1</code> API group.</p><p>It manages those objects that are requesting&mldr;</p><ul><li><p><a href=https://gardenlinux.io/>Garden Linux OS</a> configuration (<code>.spec.type=gardenlinux</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: OperatingSystemConfig
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: pool-01-original
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: gardenlinux
</span></span><span style=display:flex><span>  units:
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  files:
</span></span><span style=display:flex><span>    ...
</span></span></code></pre></div><p>Please find <a href=https://github.com/gardener/gardener-extension-os-gardenlinux/blob/master/example/40-operatingsystemconfig-gardenlinux.yaml>a concrete example</a> in the <code>example</code> folder.</p></li><li><p>MemoryOne on Garden Linux configuration (<code>spec.type=memoryone-gardenlinux</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: OperatingSystemConfig
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: pool-01-original
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: memoryone-gardenlinux
</span></span><span style=display:flex><span>  units:
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  files:
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: memoryone-gardenlinux.os.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: OperatingSystemConfiguration
</span></span><span style=display:flex><span>    memoryTopology: <span style=color:#a31515>&#34;2&#34;</span>
</span></span><span style=display:flex><span>    systemMemory: <span style=color:#a31515>&#34;6x&#34;</span>
</span></span></code></pre></div><p>Please find <a href=https://github.com/gardener/gardener-extension-os-gardenlinux/blob/master/example/40-operatingsystemconfig-memoryonegardenlinux.yaml>a concrete example</a> in the <code>example</code> folder.</p></li></ul><p>After reconciliation the resulting data will be stored in a secret within the same namespace (as the config itself might contain confidential data). The name of the secret will be written into the resource&rsquo;s <code>.status</code> field:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>status:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  cloudConfig:
</span></span><span style=display:flex><span>    secretRef:
</span></span><span style=display:flex><span>      name: osc-result-pool-01-original
</span></span><span style=display:flex><span>      namespace: default
</span></span><span style=display:flex><span>  command: /usr/bin/env bash &lt;path&gt;
</span></span><span style=display:flex><span>  units:
</span></span><span style=display:flex><span>  - docker-monitor.service
</span></span><span style=display:flex><span>  - kubelet-monitor.service
</span></span><span style=display:flex><span>  - kubelet.service
</span></span></code></pre></div><p>The secret has one data key <code>cloud_config</code> that stores the generation.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-os-gardenlinux/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the kubeconfig to the cluster you want to connect to ready in the <code>./dev/kubeconfig</code> file.
Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-os-gardenlinux/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e032feff371332908baf100fa0bb6350>2.3 - SUSE CHost OS</h1><div class=lead>Gardener extension controller for the SUSE Container Host operating system (CHost)</div><h1 id=gardener-extension-for-suse-chosthttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for SUSE CHost</a><a class=td-heading-self-link href=#gardener-extension-for-suse-chosthttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-os-suse-chost><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-os-suse-chost alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-os-suse-chost-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-os-suse-chost-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-os-suse-chost><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-os-suse-chost alt="Go Report Card"></a></p><p>This controller operates on the <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md#cloud-config-user-data-for-bootstrapping-machines><code>OperatingSystemConfig</code></a> resource in the <code>extensions.gardener.cloud/v1alpha1</code> API group. It manages those objects that are requesting SUSE Container Host configuration, i.e. <code>suse-chost</code> type:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: OperatingSystemConfig
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: pool-01-original
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: suse-chost
</span></span><span style=display:flex><span>  units:
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  files:
</span></span><span style=display:flex><span>    ...
</span></span></code></pre></div><p>Please find <a href=https://github.com/gardener/gardener-extension-os-suse-chost/blob/master/example/40-operatingsystemconfig-chost.yaml>a concrete example</a> in the <code>example</code> folder.</p><p>It is also capable of supporting the <a href="https://marketplace.cloud.vmware.com/services/details/vsmp-memoryone?slug=true">vSMP MemoryOne</a> operating system with the <code>memoryone-chost</code> type. Please find more information <a href=/docs/extensions/os-extensions/gardener-extension-os-suse-chost/usage/#support-for-vsmp-memoryone>here</a>.</p><p>After reconciliation the resulting data will be stored in a secret within the same namespace (as the config itself might contain confidential data). The name of the secret will be written into the resource&rsquo;s <code>.status</code> field:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>status:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  cloudConfig:
</span></span><span style=display:flex><span>    secretRef:
</span></span><span style=display:flex><span>      name: osc-result-pool-01-original
</span></span><span style=display:flex><span>      namespace: default
</span></span><span style=display:flex><span>  command: /usr/bin/env bash &lt;path&gt;
</span></span><span style=display:flex><span>  units:
</span></span><span style=display:flex><span>  - docker-monitor.service
</span></span><span style=display:flex><span>  - kubelet-monitor.service
</span></span><span style=display:flex><span>  - kubelet.service
</span></span></code></pre></div><p>The secret has one data key <code>cloud_config</code> that stores the generation.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-os-suse-chost/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the kubeconfig to the cluster you want to connect to ready in the <code>./dev/kubeconfig</code> file.
Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-os-suse-chost/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f86412446679d5f86ba051fe37aa4472>2.3.1 - Usage</h1><h1 id=using-the-suse-chost-extension-with-gardener-as-end-user>Using the SuSE CHost extension with Gardener as end-user<a class=td-heading-self-link href=#using-the-suse-chost-extension-with-gardener-as-end-user aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a few fields that must be considered when this OS extension is used.</p><p>In this document we describe how this configuration looks like and under which circumstances your attention may be required.</p><h2 id=aws-vpc-settings-for-suse-chost-workers>AWS VPC settings for SuSE CHost workers<a class=td-heading-self-link href=#aws-vpc-settings-for-suse-chost-workers aria-label="Heading self-link"></a></h2><p>Gardener allows you to create SuSE CHost based worker nodes by:</p><ol><li>Using a Gardener managed VPC</li><li>Reusing a VPC that already exists (VPC <code>id</code> specified in <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/usage/#infrastructureconfig>InfrastructureConfig</a>]</li></ol><p>If the second option applies to your use-case please make sure that your VPC has enabled <strong>DNS Support</strong>. Otherwise SuSE CHost based nodes aren&rsquo;t able to join or operate in your cluster properly.</p><p><strong><a href=https://docs.aws.amazon.com/vpc/latest/userguide/vpc-dns.html>DNS</a></strong> settings (required):</p><ul><li><code>enableDnsHostnames</code>: true</li><li><code>enableDnsSupport</code>: true</li></ul><h2 id=support-for-vsmp-memoryone>Support for vSMP MemoryOne<a class=td-heading-self-link href=#support-for-vsmp-memoryone aria-label="Heading self-link"></a></h2><p>This extension controller is also capable of generating user-data for the <a href="https://marketplace.cloud.vmware.com/services/details/vsmp-memoryone?slug=true">vSMP MemoryOne</a> operating system in conjunction with SuSE CHost.
It reacts on the <code>memoryone-chost</code> extension type.
Additionally, it allows certain customizations with the following configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: memoryone-chost.os.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: OperatingSystemConfiguration
</span></span><span style=display:flex><span>memoryTopology: <span style=color:#a31515>&#34;3&#34;</span>
</span></span><span style=display:flex><span>systemMemory: <span style=color:#a31515>&#34;7x&#34;</span>
</span></span></code></pre></div><ul><li>The <code>memoryTopology</code> field controls the <code>mem_topology</code> setting. If it&rsquo;s not provided then it will default to <code>2</code>.</li><li>The <code>systemMemory</code> field controls the <code>system_memory</code> setting. If it&rsquo;s not provided then it defaults to <code>6x</code>.</li></ul><p>Please note that it was only e2e-tested on AWS.
Additionally, you need a snapshot ID of a SuSE CHost/CHost volume (see below how to create it).</p><p>An exemplary worker pool configuration inside a <code>Shoot</code> resource using for the vSMP MemoryOne operating system would look as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: vsmp-memoryone
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  workers:
</span></span><span style=display:flex><span>  - name: cpu-worker3
</span></span><span style=display:flex><span>    minimum: 1
</span></span><span style=display:flex><span>    maximum: 1
</span></span><span style=display:flex><span>    maxSurge: 1
</span></span><span style=display:flex><span>    maxUnavailable: 0
</span></span><span style=display:flex><span>    machine:
</span></span><span style=display:flex><span>      image:
</span></span><span style=display:flex><span>        name: memoryone-chost
</span></span><span style=display:flex><span>        version: 9.5.195
</span></span><span style=display:flex><span>        providerConfig:
</span></span><span style=display:flex><span>          apiVersion: memoryone-chost.os.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>          kind: OperatingSystemConfiguration
</span></span><span style=display:flex><span>          memoryTopology: <span style=color:#a31515>&#34;2&#34;</span>
</span></span><span style=display:flex><span>          systemMemory: <span style=color:#a31515>&#34;6x&#34;</span>
</span></span><span style=display:flex><span>      type: c5d.metal
</span></span><span style=display:flex><span>    volume:
</span></span><span style=display:flex><span>      size: 20Gi
</span></span><span style=display:flex><span>      type: gp2
</span></span><span style=display:flex><span>    dataVolumes:
</span></span><span style=display:flex><span>    - name: chost
</span></span><span style=display:flex><span>      size: 50Gi
</span></span><span style=display:flex><span>      type: gp2
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: aws.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: WorkerConfig
</span></span><span style=display:flex><span>      dataVolumes:
</span></span><span style=display:flex><span>      - name: chost
</span></span><span style=display:flex><span>        snapshotID: snap-123456
</span></span><span style=display:flex><span>    zones:
</span></span><span style=display:flex><span>    - eu-central-1b
</span></span></code></pre></div><p>Please note that vSMP MemoryOne only works for EC2 bare-metal instance types such as <code>M5d</code>, <code>R5</code>, <code>C5</code>, <code>C5d</code>, etc. - please consult <a href=https://aws.amazon.com/ec2/instance-types/>the EC2 instance types overview page</a> and the documentation of vSMP MemoryOne to find out whether the instance type in question is eligible.</p><h3 id=generating-an-aws-snapshot-id-for-the-chostchost-operating-system>Generating an AWS snapshot ID for the CHost/CHost operating system<a class=td-heading-self-link href=#generating-an-aws-snapshot-id-for-the-chostchost-operating-system aria-label="Heading self-link"></a></h3><p>The following script will help to generate the snapshot ID on AWS.
It runs in the region that is selected in your <code>$HOME/.aws/config</code> file.
Consequently, if you want to generate the snapshot in multiple regions, you have to run in multiple times after configuring the respective region using <code>aws configure</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ami=<span style=color:#a31515>&#34;ami-1234&#34;</span> <span style=color:green>#Replace the ami with the intended one.</span>
</span></span><span style=display:flex><span>name=<span style=color:#a31515>`</span>aws ec2 describe-images --image-ids $ami  --query=<span style=color:#a31515>&#34;Images[].Name&#34;</span> --output=text<span style=color:#a31515>`</span>
</span></span><span style=display:flex><span>cur=<span style=color:#a31515>`</span>aws ec2 describe-snapshots --filter=<span style=color:#a31515>&#34;Name=description,Values=snap-</span>$name<span style=color:#a31515>&#34;</span> --query=<span style=color:#a31515>&#34;Snapshots[].Description&#34;</span> --output=text<span style=color:#a31515>`</span>
</span></span><span style=display:flex><span><span style=color:#00f>if</span> [ -n <span style=color:#a31515>&#34;</span>$cur<span style=color:#a31515>&#34;</span> ]; <span style=color:#00f>then</span>
</span></span><span style=display:flex><span>  echo <span style=color:#a31515>&#34;AMI </span>$name<span style=color:#a31515> exists as snapshot </span>$cur<span style=color:#a31515>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#00f>continue</span>
</span></span><span style=display:flex><span><span style=color:#00f>fi</span>
</span></span><span style=display:flex><span>echo <span style=color:#a31515>&#34;AMI </span>$name<span style=color:#a31515> ... creating private snapshot&#34;</span>
</span></span><span style=display:flex><span>inst=<span style=color:#a31515>`</span>aws ec2 run-instances --instance-type t3.nano --image-id $ami --query <span style=color:#a31515>&#39;Instances[0].InstanceId&#39;</span> --output=text --subnet-id subnet-1234 --tag-specifications <span style=color:#a31515>&#39;ResourceType=instance,Tags=[{Key=scalemp-test,Value=scalemp-test}]&#39;</span><span style=color:#a31515>`</span> <span style=color:green>#Replace the subnet-id with the intended one.</span>
</span></span><span style=display:flex><span>aws ec2 wait instance-running --instance-ids $inst
</span></span><span style=display:flex><span>vol=<span style=color:#a31515>`</span>aws ec2 describe-instances --instance-ids $inst --query <span style=color:#a31515>&#34;Reservations[].Instances[].BlockDeviceMappings[0].Ebs.VolumeId&#34;</span> --output=text<span style=color:#a31515>`</span>
</span></span><span style=display:flex><span>snap=<span style=color:#a31515>`</span>aws ec2 create-snapshot --description <span style=color:#a31515>&#34;snap-</span>$name<span style=color:#a31515>&#34;</span> --volume-id $vol --query=<span style=color:#a31515>&#39;SnapshotId&#39;</span> --tag-specifications <span style=color:#a31515>&#34;ResourceType=snapshot,Tags=[{Key=Name,Value=\&#34;</span>$name<span style=color:#a31515>\&#34;}]&#34;</span> --output=text<span style=color:#a31515>`</span>
</span></span><span style=display:flex><span>aws ec2 wait snapshot-completed --snapshot-ids $snap
</span></span><span style=display:flex><span>aws ec2 terminate-instances --instance-id $inst &gt; /dev/null
</span></span><span style=display:flex><span>echo $snap
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-2d1349b5e5eed4ce62ec06792f100731>2.4 - Ubuntu OS</h1><div class=lead>Gardener extension controller for the Ubuntu operating system</div><h1 id=gardener-extension-for-ubuntu-oshttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Ubuntu OS</a><a class=td-heading-self-link href=#gardener-extension-for-ubuntu-oshttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-os-ubuntu><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-os-ubuntu alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-os-ubuntu-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-os-ubuntu-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-os-ubuntu><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-os-ubuntu alt="Go Report Card"></a></p><p>This controller operates on the <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md#cloud-config-user-data-for-bootstrapping-machines><code>OperatingSystemConfig</code></a> resource in the <code>extensions.gardener.cloud/v1alpha1</code> API group. It manages those objects that are requesting <a href=https://www.ubuntu.com/>Ubuntu OS</a> configuration (<code>.spec.type=ubuntu</code>). An experimental support for Ubuntu Pro is added (<code>.spec.type=ubuntu-pro</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: OperatingSystemConfig
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: pool-01-original
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: ubuntu
</span></span><span style=display:flex><span>  units:
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  files:
</span></span><span style=display:flex><span>    ...
</span></span></code></pre></div><p>Please find <a href=https://github.com/gardener/gardener-extension-os-ubuntu/blob/master/example/40-operatingsystemconfig.yaml>a concrete example</a> in the <code>example</code> folder.</p><p>After reconciliation the resulting data will be stored in a secret within the same namespace (as the config itself might contain confidential data). The name of the secret will be written into the resource&rsquo;s <code>.status</code> field:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>status:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  cloudConfig:
</span></span><span style=display:flex><span>    secretRef:
</span></span><span style=display:flex><span>      name: osc-result-pool-01-original
</span></span><span style=display:flex><span>      namespace: default
</span></span><span style=display:flex><span>  command: /usr/bin/env bash &lt;path&gt;
</span></span><span style=display:flex><span>  units:
</span></span><span style=display:flex><span>  - docker-monitor.service
</span></span><span style=display:flex><span>  - kubelet-monitor.service
</span></span><span style=display:flex><span>  - kubelet.service
</span></span></code></pre></div><p>The secret has one data key <code>cloud_config</code> that stores the generation.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-os-ubuntu/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the kubeconfig to the cluster you want to connect to ready in the <code>./dev/kubeconfig</code> file.
Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-os-ubuntu/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ec8342c0ff3d2e093022f079b19254f8>2.4.1 - Usage</h1><h1 id=using-the-ubuntu-extension-with-gardener-as-end-user>Using the Ubuntu extension with Gardener as end-user<a class=td-heading-self-link href=#using-the-ubuntu-extension-with-gardener-as-end-user aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a few fields that must be considered when this OS extension is used.</p><p>In this document we describe how this configuration looks like and under which circumstances your attention may be required.</p><h2 id=aws-vpc-settings-for-ubuntu-workers>AWS VPC settings for Ubuntu workers<a class=td-heading-self-link href=#aws-vpc-settings-for-ubuntu-workers aria-label="Heading self-link"></a></h2><p>Gardener allows you to create Ubuntu based worker nodes by:</p><ol><li>Using a Gardener managed VPC</li><li>Reusing a VPC that already exists (VPC <code>id</code> specified in <a href=/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/usage/#infrastructureconfig>InfrastructureConfig</a>]</li></ol><p>If the second option applies to your use-case please make sure that your VPC has enabled <strong>DNS Support</strong>. Otherwise Ubuntu based nodes aren&rsquo;t able to join or operate in your cluster properly.</p><p><strong><a href=https://docs.aws.amazon.com/vpc/latest/userguide/vpc-dns.html>DNS</a></strong> settings (required):</p><ul><li><code>enableDnsHostnames</code>: true</li><li><code>enableDnsSupport</code>: true</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-55b1ec84af5ed73ab7f671bfe8da200e>3 - Network Extensions</h1><div class=lead>Gardener extension controllers for the supported container network interfaces</div></div><div class=td-content><h1 id=pg-306b134fc579fc34549bdcef99158c9b>3.1 - Calico CNI</h1><div class=lead>Gardener extension controller for the Calico CNI network plugin</div><h1 id=gardener-extension-for-calico-networkinghttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Calico Networking</a><a class=td-heading-self-link href=#gardener-extension-for-calico-networkinghttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-networking-calico><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-networking-calico alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-networking-calico-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-networking-calico-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-networking-calico><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-networking-calico alt="Go Report Card"></a></p><p>This controller operates on the <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/03-networking-extensibility.md#gardener-network-extension><code>Network</code></a> resource in the <code>extensions.gardener.cloud/v1alpha1</code> API group. It manages those objects that are requesting <a href=https://www.projectcalico.org/>Calico Networking</a> configuration (<code>.spec.type=calico</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Network
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: calico-network
</span></span><span style=display:flex><span>  namespace: shoot--core--test-01
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: calico
</span></span><span style=display:flex><span>  clusterCIDR: 192.168.0.0/24
</span></span><span style=display:flex><span>  serviceCIDR:  10.96.0.0/24
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: NetworkConfig
</span></span><span style=display:flex><span>    overlay:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>false</span>
</span></span></code></pre></div><p>Please find <a href=https://github.com/gardener/gardener-extension-networking-calico/blob/master/example/20-network.yaml>a concrete example</a> in the <code>example</code> folder. All the <code>Calico</code> specific configuration
should be configured in the <code>providerConfig</code> section. If additional configuration is required, it should be added to
the <code>networking-calico</code> chart in <code>controllers/networking-calico/charts/internal/calico/values.yaml</code> and corresponding code
parts should be adapted (for example in <code>controllers/networking-calico/pkg/charts/utils.go</code>).</p><p>Once the network resource is applied, the <code>networking-calico</code> controller would then create all the necessary <code>managed-resources</code> which should be picked
up by the <a href=https://github.com/gardener/gardener-resource-manager>gardener-resource-manager</a> which will then apply all the
network extensions resources to the shoot cluster.</p><p>Finally after successful reconciliation an output similar to the one below should be expected.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  status:
</span></span><span style=display:flex><span>    lastOperation:
</span></span><span style=display:flex><span>      description: Successfully reconciled network
</span></span><span style=display:flex><span>      lastUpdateTime: <span style=color:#a31515>&#34;...&#34;</span>
</span></span><span style=display:flex><span>      progress: 100
</span></span><span style=display:flex><span>      state: Succeeded
</span></span><span style=display:flex><span>      type: Reconcile
</span></span><span style=display:flex><span>    observedGeneration: 1
</span></span><span style=display:flex><span>    providerStatus:
</span></span><span style=display:flex><span>      apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: NetworkStatus
</span></span></code></pre></div><h2 id=compatibility>Compatibility<a class=td-heading-self-link href=#compatibility aria-label="Heading self-link"></a></h2><p>The following table lists known compatibility issues of this extension controller with other Gardener components.</p><table><thead><tr><th>Calico Extension</th><th>Gardener</th><th>Action</th><th>Notes</th></tr></thead><tbody><tr><td><code>>= v1.30.0</code></td><td><code>&lt; v1.63.0</code></td><td>Please first update Gardener components to <code>>= v1.63.0</code>.</td><td>Without the mentioned minimum Gardener version, Calico <code>Pod</code>s are not only scheduled to dedicated system component nodes in the shoot cluster.</td></tr></tbody></table><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the <code>kubeconfig</code> pointed to the cluster you want to connect to.
Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-networking-calico/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f2920606a4dac52b27a770078c916407>3.1.1 - Deployment</h1><h1 id=deployment-of-the-networking-calico-extension>Deployment of the networking Calico extension<a class=td-heading-self-link href=#deployment-of-the-networking-calico-extension aria-label="Heading self-link"></a></h1><p><strong>Disclaimer:</strong> This document is NOT a step by step deployment guide for the networking Calico extension and only contains some configuration specifics regarding the deployment of different components via the helm charts residing in the networking Calico extension <a href=https://github.com/gardener/gardener-extension-networking-calico>repository</a>.</p><h2 id=gardener-extension-admission-calico>gardener-extension-admission-calico<a class=td-heading-self-link href=#gardener-extension-admission-calico aria-label="Heading self-link"></a></h2><h3 id=authentication-against-the-garden-cluster>Authentication against the Garden cluster<a class=td-heading-self-link href=#authentication-against-the-garden-cluster aria-label="Heading self-link"></a></h3><p>There are several authentication possibilities depending on whether or not <a href=https://github.com/gardener/garden-setup#concept-the-virtual-cluster>the concept of Virtual Garden</a> is used.</p><h4 id=virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster>Virtual Garden is not used, i.e., the <code>runtime</code> Garden cluster is also the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster aria-label="Heading self-link"></a></h4><h5 id=automounted-service-account-token>Automounted Service Account Token<a class=td-heading-self-link href=#automounted-service-account-token aria-label="Heading self-link"></a></h5><p>The easiest way to deploy the <code>gardener-extension-admission-calico</code> component will be to not provide <code>kubeconfig</code> at all. This way in-cluster configuration and an automounted service account token will be used. The drawback of this approach is that the automounted token will not be automatically rotated.</p><h5 id=service-account-token-volume-projection>Service Account Token Volume Projection<a class=td-heading-self-link href=#service-account-token-volume-projection aria-label="Heading self-link"></a></h5><p>Another solution will be to use <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>Service Account Token Volume Projection</a> combined with a <code>kubeconfig</code> referencing a token file (see example below).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://default.kubernetes.svc.cluster.local
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: garden
</span></span><span style=display:flex><span>    user: garden
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>current-context: garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div><p>This will allow for automatic rotation of the service account token by the <code>kubelet</code>. The configuration can be achieved by setting both <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.kubeconfig</code> in the respective chart&rsquo;s <code>values.yaml</code> file.</p><h4 id=virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster>Virtual Garden is used, i.e., the <code>runtime</code> Garden cluster is different from the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster aria-label="Heading self-link"></a></h4><h5 id=service-account>Service Account<a class=td-heading-self-link href=#service-account aria-label="Heading self-link"></a></h5><p>The easiest way to setup the authentication will be to create a service account and the respective roles will be bound to this service account in the <code>target</code> cluster. Then use the generated service account token and craft a <code>kubeconfig</code> which will be used by the workload in the <code>runtime</code> cluster. This approach does not provide a solution for the rotation of the service account token. However, this setup can be achieved by setting <code>.Values.global.virtualGarden.enabled: true</code> and following these steps:</p><ol><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Get the service account token and craft the <code>kubeconfig</code>.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><h5 id=client-certificate>Client Certificate<a class=td-heading-self-link href=#client-certificate aria-label="Heading self-link"></a></h5><p>Another solution will be to bind the roles in the <code>target</code> cluster to a <code>User</code> subject instead of a service account and use a client certificate for authentication. This approach does not provide a solution for the client certificate rotation. However, this setup can be achieved by setting both <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>, then following these steps:</p><ol><li>Generate a client certificate for the <code>target</code> cluster for the respective user.</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Craft a <code>kubeconfig</code> using the already generated client certificate.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><h5 id=projected-service-account-token>Projected Service Account Token<a class=td-heading-self-link href=#projected-service-account-token aria-label="Heading self-link"></a></h5><p>This approach requires an already deployed and configured <a href=https://github.com/gardener/oidc-webhook-authenticator>oidc-webhook-authenticator</a> for the <code>target</code> cluster. Also the <code>runtime</code> cluster should be registered as a trusted identity provider in the <code>target</code> cluster. Then projected service accounts tokens from the <code>runtime</code> cluster can be used to authenticate against the <code>target</code> cluster. The needed steps are as follows:</p><ol><li>Deploy <a href=https://github.com/gardener/oidc-webhook-authenticator>OWA</a> and establish the needed trust.</li><li>Set <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>. <strong>Note:</strong> username value will depend on the trust configuration, e.g., <code>&lt;prefix>:system:serviceaccount:&lt;namespace>:&lt;serviceaccount></code></li><li>Set <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.serviceAccountTokenVolumeProjection.audience</code>. <strong>Note:</strong> audience value will depend on the trust configuration, e.g., <code>&lt;cliend-id-from-trust-config></code>.</li><li>Craft a kubeconfig (see example below).</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://virtual-garden.api
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: virtual-garden
</span></span><span style=display:flex><span>    user: virtual-garden
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>current-context: virtual-garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: virtual-garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-7b8605820c421d09eab14cf68a7e3d85>3.1.2 - Operations</h1><h1 id=using-the-calico-networking-extension-with-gardener-as-operator>Using the Calico networking extension with Gardener as operator<a class=td-heading-self-link href=#using-the-calico-networking-extension-with-gardener-as-operator aria-label="Heading self-link"></a></h1><p>This document explains configuration options supported by the networking-calico extension.</p><h3 id=run-calico-node-in-non-privileged-and-non-root-mode>Run calico-node in non-privileged and non-root mode<a class=td-heading-self-link href=#run-calico-node-in-non-privileged-and-non-root-mode aria-label="Heading self-link"></a></h3><p><strong>Feature State</strong>: <code>Alpha</code></p><h5 id=motivation>Motivation<a class=td-heading-self-link href=#motivation aria-label="Heading self-link"></a></h5><p>Running containers in privileged mode is not recommended as privileged containers run with all <a href=https://man7.org/linux/man-pages/man7/capabilities.7.html>linux capabilities</a> enabled and can access the host&rsquo;s resources. Running containers in privileged mode opens number of security threats such as breakout to underlying host OS.</p><h5 id=support-for-non-privileged-and-non-root-mode>Support for non-privileged and non-root mode<a class=td-heading-self-link href=#support-for-non-privileged-and-non-root-mode aria-label="Heading self-link"></a></h5><p>The Calico project has a preliminary support for running the calico-node component in non-privileged mode (see <a href=https://projectcalico.docs.tigera.io/security/non-privileged>this guide</a>). Similar to <a href=https://github.com/tigera/operator>Tigera Calico operator</a> the networking-calico extension can also run calico-node in non-privileged and non-root mode. This feature is controller via feature gate named <code>NonPrivilegedCalicoNode</code>. The feature gates are configured in the <a href=https://github.com/gardener/gardener-extension-networking-calico/blob/master/example/00-componentconfig.yaml>ControllerConfiguration</a> of networking-calico. The corresponding ControllerDeployment configuration that enables the <code>NonPrivilegedCalicoNode</code> would look like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerDeployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: networking-calico
</span></span><span style=display:flex><span>type: helm
</span></span><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  values:
</span></span><span style=display:flex><span>    chart: &lt;omitted&gt;
</span></span><span style=display:flex><span>    config:
</span></span><span style=display:flex><span>      featureGates:
</span></span><span style=display:flex><span>        NonPrivilegedCalicoNode: <span style=color:#00f>false</span>
</span></span></code></pre></div><h5 id=limitations>Limitations<a class=td-heading-self-link href=#limitations aria-label="Heading self-link"></a></h5><ul><li>The support for the non-privileged mode in the Calico project is not ready for productive usage. The <a href=https://projectcalico.docs.tigera.io/security/non-privileged>upstream documentation</a> states that in non-privileged mode the support for features added after Calico v3.21 is not guaranteed.</li><li>Calico in non-privileged mode does not support eBPF dataplane. That&rsquo;s why when eBPF dataplane is enabled, calico-node has to run in privileged mode (even when the <code>NonPrivilegedCalicoNode</code> feature gate is enabled).</li><li>(At the time of writing this guide) there is the following issue <a href=https://github.com/projectcalico/calico/issues/5348>projectcalico/calico#5348</a> that is not addressed.</li><li>(At the time of writing this guide) the upstream adoptions seems to be low. The Calico charts and manifest in <a href=https://github.com/projectcalico/calico>projectcalico/calico</a> run calico-node in privileged mode.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-0a971930c7387d0186d6b88a9cdeb689>3.1.3 - Shoot Overlay Network</h1><h1 id=enable--disable-overlay-network-for-shoots-with-calico>Enable / disable overlay network for shoots with Calico<a class=td-heading-self-link href=#enable--disable-overlay-network-for-shoots-with-calico aria-label="Heading self-link"></a></h1><p>Gardener can be used with or without the overlay network.</p><p>Starting versions:</p><ul><li><a href=https://github.com/gardener/gardener-extension-provider-gcp/releases/tag/v1.25.0>provider-gcp@v1.25.0</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-alicloud/releases/tag/v1.43.0>provider-alicloud@v1.43.0</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-aws/releases/tag/v1.38.2>provider-aws@v1.38.2</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-openstack/releases/tag/v1.30.0>provider-openstack@v1.30.0</a></li></ul><p>The default configuration of shoot clusters is without overlay network.</p><h2 id=understanding-overlay-network>Understanding overlay network<a class=td-heading-self-link href=#understanding-overlay-network aria-label="Heading self-link"></a></h2><p>The Overlay networking permits the routing of packets between multiples pods located on multiple nodes, even if the pod and the node network are not the same.</p><p>This is done through the encapsulation of pod packets in the node network so that the routing can be done as usual. We use <code>ipip</code> encapsulation with calico as default in case the overlay network is enabled. This (simply put) sends an IP packet as workload in another IP packet.</p><p><img src=/__resources/Overlay-Network.drawio_ebaafc.png alt></p><p>In order to simplify the troubleshooting of problems and reduce the latency of packets traveling between nodes, the overlay network is disabled by default as stated above for all new clusters.</p><p><img src=/__resources/No-Overlay-Network.drawio_db83e3.png alt></p><p>This means that the routing is done directly through the VPC routing table. Basically, when a new node is created, it is assigned a slice (usually a /24) of the pod network. All future pods in that node are going to be in this slice. Then, the cloud-controller-manager updates the cloud provider router to add the new route (all packets within the network slice as destination should go to that node).</p><p>This has the advantage of:</p><ul><li>Doing less work for the node as encapsulation takes some CPU cycles.</li><li>The maximum transmission unit (MTU) is slightly bigger resulting in slightly better performance, i.e. potentially more workload bytes per packet.</li><li>More direct and simpler setup, which makes the problems much easier to troubleshoot.</li></ul><p><strong>In the case where multiple shoots are in the same VPC and the overlay network is disabled, if the pod&rsquo;s network is not configured properly, there is a very strong chance that some pod IP address might overlap, which is going to cause all sorts of funny problems.</strong> So, if someone asks you how to avoid that, they need to make sure that the podCIDRs for each shoot <strong>do not overlap with each other</strong>.</p><h2 id=enabling-the-overlay-network>Enabling the overlay network<a class=td-heading-self-link href=#enabling-the-overlay-network aria-label="Heading self-link"></a></h2><p>In certain cases, the overlay network might be preferable if, for example, the customer wants to create multiple clusters in the same VPC without ensuring there&rsquo;s no overlap between the pod networks.</p><p>To enable the overlay network, add the following to the shoot&rsquo;s YAML:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: NetworkConfig
</span></span><span style=display:flex><span>      overlay:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><h2 id=disabling-the-overlay-network>Disabling the overlay network<a class=td-heading-self-link href=#disabling-the-overlay-network aria-label="Heading self-link"></a></h2><p>Inversely, here is how to disable the overlay network:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: NetworkConfig
</span></span><span style=display:flex><span>      overlay:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><h2 id=using-vxlan-as-overlay>Using VXLAN as overlay<a class=td-heading-self-link href=#using-vxlan-as-overlay aria-label="Heading self-link"></a></h2><p>To enable the overlay network with VXLAN, add the following to the shoot&rsquo;s YAML:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: NetworkConfig
</span></span><span style=display:flex><span>      overlay:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      vxlan:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><h2 id=how-to-know-if-a-cluster-is-using-overlay-or-not>How to know if a cluster is using overlay or not?<a class=td-heading-self-link href=#how-to-know-if-a-cluster-is-using-overlay-or-not aria-label="Heading self-link"></a></h2><p>You can look at any of the old nodes. If there are <code>tunl0</code> devices at least at some point in time the overlay network was used.
Another way is to look into the Network object in the shoot&rsquo;s control plane namespace on the seed (see example above).</p><h2 id=do-we-have-some-documentation-somewhere-on-how-to-do-the-migration>Do we have some documentation somewhere on how to do the migration?<a class=td-heading-self-link href=#do-we-have-some-documentation-somewhere-on-how-to-do-the-migration aria-label="Heading self-link"></a></h2><p>No, not yet. The migration from no overlay to overlay is fairly simply by just setting the configuration as specified above. The other way is more complicated as the Network configuration needs to be changed AND the local routes need to be cleaned.
Unfortunately, the change will be rolled out slowly (one calico-node at a time). Hence, it implies some network outages during the migration.</p><h2 id=aws-implementation>AWS implementation<a class=td-heading-self-link href=#aws-implementation aria-label="Heading self-link"></a></h2><p>On AWS, it is not possible to use the cloud-controller-manager for managing the routes as it does not support multiple route tables, which Gardener creates. Therefore, a custom controller is created to manage the routes.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2082dbad51907d23dce5fffeb6099f2e>3.1.4 - Usage</h1><h1 id=using-the-networking-calico-extension-with-gardener-as-end-user>Using the Networking Calico extension with Gardener as end-user<a class=td-heading-self-link href=#using-the-networking-calico-extension-with-gardener-as-end-user aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a <code>networking</code> field that is meant to contain network-specific configuration.</p><p>In this document we are describing how this configuration looks like for Calico and provide an example <code>Shoot</code> manifest with minimal configuration that you can use to create a cluster.</p><h2 id=calico-typha>Calico Typha<a class=td-heading-self-link href=#calico-typha aria-label="Heading self-link"></a></h2><p>Calico Typha is an optional component of Project Calico designed to offload the Kubernetes API server. The Typha daemon sits between the datastore (such as the Kubernetes API server which is the one used by Gardener managed Kubernetes) and many instances of Felix. Typha’s main purpose is to increase scale by reducing each node’s impact on the datastore. You can opt-out Typha via <code>.spec.networking.providerConfig.typha.enabled=false</code> of your Shoot manifest. By default the Typha is enabled.</p><h2 id=ebpf-dataplane>EBPF Dataplane<a class=td-heading-self-link href=#ebpf-dataplane aria-label="Heading self-link"></a></h2><p>Calico can be run in ebpf dataplane mode. This has several benefits, calico scales to higher troughput, uses less cpu per GBit and has native support for kubernetes services (without needing kube-proxy).
To switch to a pure ebpf dataplane it is recommended to run without an overlay network. The following configuration can be used to run without an overlay and without kube-proxy.</p><p>An example ebpf dataplane <code>NetworkingConfig</code> manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: NetworkConfig
</span></span><span style=display:flex><span>ebpfDataplane:
</span></span><span style=display:flex><span>  enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>overlay:
</span></span><span style=display:flex><span>  enabled: <span style=color:#00f>false</span>
</span></span></code></pre></div><p>To disable kube-proxy set the enabled field to false in the shoot manifest.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: ebpf-shoot
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    kubeProxy:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>false</span>
</span></span></code></pre></div><h3 id=know-limitations-of-the-ebpf-dataplane>Know limitations of the EBPF Dataplane<a class=td-heading-self-link href=#know-limitations-of-the-ebpf-dataplane aria-label="Heading self-link"></a></h3><p>Please note that the default settings for calico&rsquo;s ebpf dataplane may interfere with
<a href=https://learn.microsoft.com/en-us/azure/virtual-network/accelerated-networking-overview>accelerated networking in azure</a>
rendering nodes with accelerated networking unusable in the network. The reason for this is that calico does not ignore
the accelerated networking interface <code>enP...</code> as it should, but applies its ebpf programs to it. A simple mitigation for
this is to adapt the <code>FelixConfiguration</code> <code>default</code> and ensure that the <code>bpfDataIfacePattern</code> does not include <code>enP...</code>.
Per default <code>bpfDataIfacePattern</code> is not set. The default value for this option can be found
<a href=https://github.com/projectcalico/calico/blob/3f7fe4d290541bbdd73c97bdc89a29a29855a48a/felix/config/config_params.go#L180>here</a>.
For example, you could apply the following change:</p><pre tabindex=0><code>$ kubectl edit felixconfiguration default
...
apiVersion: crd.projectcalico.org/v1
kind: FelixConfiguration
metadata:
  ...
  name: default
  ...
spec:
  bpfDataIfacePattern: ^((en|wl|ww|sl|ib)[opsx].*|(eth|wlan|wwan).*|tunl0$|vxlan.calico$|wireguard.cali$|wg-v6.cali$)
  ...
</code></pre><h2 id=autoscaling>AutoScaling<a class=td-heading-self-link href=#autoscaling aria-label="Heading self-link"></a></h2><p>Autoscaling defines how the calico components are automatically scaled. It allows to use either static resource assignment, vertical pod or cluster-proportional autoscaler (default: cluster-proportional).</p><p>The cluster-proportional autoscaling mode is preferable when conditions require minimal disturbances and vpa mode for improved cluster resource utilization. Static resource assignments causes no disruptions due to autoscaling, but has no dynamics to handle changing demands.</p><p>Please note VPA must be enabled on the shoot as a pre-requisite to enabling vpa mode.</p><p>An example <code>NetworkingConfig</code> manifest for vertical pod autoscaling:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: NetworkConfig
</span></span><span style=display:flex><span>autoScaling:
</span></span><span style=display:flex><span>  mode: <span style=color:#a31515>&#34;vpa&#34;</span>
</span></span></code></pre></div><p>An example <code>NetworkingConfig</code> manifest for static resource assignment:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: NetworkConfig
</span></span><span style=display:flex><span>autoScaling:
</span></span><span style=display:flex><span>  mode: <span style=color:#a31515>&#34;static&#34;</span>
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    node:
</span></span><span style=display:flex><span>      cpu: 100m
</span></span><span style=display:flex><span>      memory: 100Mi
</span></span><span style=display:flex><span>    typha:
</span></span><span style=display:flex><span>      cpu: 100m
</span></span><span style=display:flex><span>      memory: 100Mi
</span></span></code></pre></div><blockquote><p>ℹ️ Please note that in static mode, you have the option to configure the resource requests for calico-node and calico-typha. If not specified, default settings will be used.
If the resource requests are chosen too low, it might impact the stability/performance of the cluster.
Specifying the resource requests for any other autoscaling mode has no effect.</p></blockquote><h2 id=example-networkingconfig-manifest>Example <code>NetworkingConfig</code> manifest<a class=td-heading-self-link href=#example-networkingconfig-manifest aria-label="Heading self-link"></a></h2><p>An example <code>NetworkingConfig</code> for the Calico extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: NetworkConfig
</span></span><span style=display:flex><span>ipam:
</span></span><span style=display:flex><span>  type: host-local
</span></span><span style=display:flex><span>  cidr: usePodCIDR
</span></span><span style=display:flex><span>vethMTU: 1440
</span></span><span style=display:flex><span>typha:
</span></span><span style=display:flex><span>  enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>overlay:
</span></span><span style=display:flex><span>  enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>autoScaling:
</span></span><span style=display:flex><span>  mode: <span style=color:#a31515>&#34;vpa&#34;</span>
</span></span></code></pre></div><h2 id=example-shoot-manifest>Example <code>Shoot</code> manifest<a class=td-heading-self-link href=#example-shoot-manifest aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest with calico networking configratations:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-azure
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfileName: azure
</span></span><span style=display:flex><span>  region: westeurope
</span></span><span style=display:flex><span>  secretBindingName: core-azure
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: azure
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vnet:
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>        workers: 10.250.0.0/19
</span></span><span style=display:flex><span>      zoned: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: Standard_D4_v3
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: Standard_LRS
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - <span style=color:#a31515>&#34;1&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#a31515>&#34;2&#34;</span>
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: NetworkConfig
</span></span><span style=display:flex><span>      ipam:
</span></span><span style=display:flex><span>        type: host-local
</span></span><span style=display:flex><span>      vethMTU: 1440
</span></span><span style=display:flex><span>      overlay:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      typha:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.28.3
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=known-limitations-in-conjunction-with-nodelocaldns>Known Limitations in conjunction with <code>NodeLocalDNS</code><a class=td-heading-self-link href=#known-limitations-in-conjunction-with-nodelocaldns aria-label="Heading self-link"></a></h2><p>If <a href=https://github.com/gardener/gardener/blob/master/docs/usage/node-local-dns.md><code>NodeLocalDNS</code></a> is active in a shoot cluster, which uses calico as CNI without overlay network, it may be impossible to block DNS traffic to the cluster DNS server via network policy. This is due to <code>FELIX_CHAININSERTMODE</code> being set to <code>APPEND</code> instead of <code>INSERT</code> in case SNAT is being applied to requests to the infrastructure DNS server. In this scenario the <code>iptables</code> rules of <code>NodeLocalDNS</code> already accept the traffic before the network policies are checked.</p><p>This only applies to traffic directed to <code>NodeLocalDNS</code>. If blocking of all DNS traffic is desired via network policy the pod <code>dnsPolicy</code> should be changed to <code>Default</code> so that the cluster DNS is not used. Alternatives are usage of overlay network or disabling of <code>NodeLocalDNS</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4892da3b15a7be1985453914cbefd13a>3.2 - Cilium CNI</h1><div class=lead>Gardener extension controller for the Cilium CNI network plugin</div><h1 id=gardener-extension-for-cilium-networkinghttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for cilium Networking</a><a class=td-heading-self-link href=#gardener-extension-for-cilium-networkinghttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-networking-cilium><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-networking-cilium alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-networking-cilium-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-networking-cilium-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-networking-cilium><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-networking-cilium alt="Go Report Card"></a></p><p>This controller operates on the <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/03-networking-extensibility.md#gardener-network-extension><code>Network</code></a> resource in the <code>extensions.gardener.cloud/v1alpha1</code> API group. It manages those objects that are requesting <a href=https://cilium.io/>cilium Networking</a> configuration (<code>.spec.type=cilium</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Network
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: cilium-network
</span></span><span style=display:flex><span>  namespace: shoot--foo--bar
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: cilium
</span></span><span style=display:flex><span>  podCIDR: 10.244.0.0/16
</span></span><span style=display:flex><span>  serviceCIDR:  10.96.0.0/24
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: cilium.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: NetworkConfig
</span></span><span style=display:flex><span><span style=color:green>#    hubble:</span>
</span></span><span style=display:flex><span><span style=color:green>#      enabled: true</span>
</span></span><span style=display:flex><span><span style=color:green>#    store: kubernetes</span>
</span></span></code></pre></div><p>Please find <a href=https://github.com/gardener/gardener-extension-networking-cilium/blob/master/example/20-network.yaml>a concrete example</a> in the <code>example</code> folder. All the <code>cilium</code> specific configuration
should be configured in the <code>providerConfig</code> section. If additional configuration is required, it should be added to
the <code>networking-cilium</code> chart in <code>controllers/networking-cilium/charts/internal/cilium/values.yaml</code> and corresponding code
parts should be adapted (for example in <code>controllers/networking-cilium/pkg/charts/utils.go</code>).</p><p>Once the network resource is applied, the <code>networking-cilium</code> controller would then create all the necessary <code>managed-resources</code> which should be picked
up by the <a href=https://github.com/gardener/gardener-resource-manager>gardener-resource-manager</a> which will then apply all the
network extensions resources to the shoot cluster.</p><p>Finally after successful reconciliation an output similar to the one below should be expected.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  status:
</span></span><span style=display:flex><span>    lastOperation:
</span></span><span style=display:flex><span>      description: Successfully reconciled network
</span></span><span style=display:flex><span>      lastUpdateTime: <span style=color:#a31515>&#34;...&#34;</span>
</span></span><span style=display:flex><span>      progress: 100
</span></span><span style=display:flex><span>      state: Succeeded
</span></span><span style=display:flex><span>      type: Reconcile
</span></span><span style=display:flex><span>    observedGeneration: 1
</span></span></code></pre></div><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the <code>kubeconfig</code> pointed to the cluster you want to connect to.
Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-networking-cilium/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://docs.cilium.io/>Docs for <code>cilium</code> user</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ff35bd2db0ed090c7cdd3ca86a7dd125>3.2.1 - Usage</h1><h1 id=using-the-networking-cilium-extension-with-gardener-as-end-user>Using the Networking Cilium extension with Gardener as end-user<a class=td-heading-self-link href=#using-the-networking-cilium-extension-with-gardener-as-end-user aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a <code>networking</code> field that is meant to contain network-specific configuration.</p><p>In this document we are describing how this configuration looks like for Cilium and provide an example <code>Shoot</code> manifest with minimal configuration that you can use to create a cluster.</p><h2 id=cilium-hubble>Cilium Hubble<a class=td-heading-self-link href=#cilium-hubble aria-label="Heading self-link"></a></h2><p>Hubble is a fully distributed networking and security observability platform build on top of Cilium and BPF. It is optional and is deployed to the cluster when enabled in the <code>NetworkConfig</code>.
If the dashboard is not externally exposed</p><pre tabindex=0><code>kubectl port-forward -n kube-system deployment/hubble-ui 8081
</code></pre><p>can be used to acess it locally.</p><h2 id=example-networkingconfig-manifest>Example <code>NetworkingConfig</code> manifest<a class=td-heading-self-link href=#example-networkingconfig-manifest aria-label="Heading self-link"></a></h2><p>An example <code>NetworkingConfig</code> for the Cilium extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cilium.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: NetworkConfig
</span></span><span style=display:flex><span>hubble:
</span></span><span style=display:flex><span>  enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span><span style=color:green>#debug: false</span>
</span></span><span style=display:flex><span><span style=color:green>#tunnel: vxlan</span>
</span></span><span style=display:flex><span><span style=color:green>#store: kubernetes</span>
</span></span></code></pre></div><h2 id=networkingconfig-options><code>NetworkingConfig</code> options<a class=td-heading-self-link href=#networkingconfig-options aria-label="Heading self-link"></a></h2><p>The <code>hubble.enabled</code> field describes whether hubble should be deployed into the cluster or not (default).</p><p>The <code>debug</code> field describes whether you want to run cilium in debug mode or not (default), change this value to <code>true</code> to use debug mode.</p><p>The <code>tunnel</code> field describes the encapsulation mode for communication between nodes. Possible values are <code>vxlan</code> (default), <code>geneve</code> or <code>disabled</code>.</p><p>The <code>bpfSocketLBHostnsOnly.enabled</code> field describes whether socket LB will be skipped for services when inside a pod namespace (default), in favor of service LB at the pod interface. Socket LB is still used when in the host namespace. This feature is required when using cilium with a service mesh like istio or linkerd.</p><p>Setting the field <code>cni.exclusive</code> to <code>false</code> might be useful when additional plugins, such as Istio or Linkerd, wish to chain after Cilium. This action disables the default behavior of Cilium, which is to overwrite changes to the CNI configuration file.</p><p>The <code>egressGateway.enabled</code> field describes whether egress gateways are enabled or not (default). To use this feature kube-proxy must be disabled. This can be done with the following configuration in the Shoot:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    kubeProxy:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>false</span>
</span></span></code></pre></div><p>The egress gateway feature is only supported in gardener with an overlay network (shoot.spec.networking.providerConfig.overlay.enabled: true) at the moment. This is due to the reason that bpf masquerading is required for the egress gateway feature. Once the overlay network is enabled <code>bpf.masquerade</code> is set to <code>true</code> in the cilium configmap.</p><p>The <code>snatToUpstreamDNS.enabled</code> field describes whether the traffic to the upstream dns server should be masqueraded or not (default). This is needed on some infrastructures where traffic to the dns server with the pod CIDR range is blocked.</p><h2 id=example-shoot-manifest>Example <code>Shoot</code> manifest<a class=td-heading-self-link href=#example-shoot-manifest aria-label="Heading self-link"></a></h2><p>Please find below an example <code>Shoot</code> manifest with cilium networking configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: aws-cilium
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: cilium
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: cilium.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: NetworkConfig
</span></span><span style=display:flex><span>      hubble:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    pods: 100.96.0.0/11
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    services: 100.64.0.0/13
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>If you would like to see a provider specific shoot example, please check out the documentation of the well-known extensions. A list of them can be found <a href=https://github.com/gardener/gardener/tree/master/extensions#infrastructure-provider>here</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-43f4dc9f68e5519a75d0b2b944be89d1>4 - Container Runtime Extensions</h1><div class=lead>Gardener extensions for the supported container runtime interfaces</div></div><div class=td-content><h1 id=pg-60e80e50f871d6bf3e0bd35d36ca22c2>4.1 - GVisor container runtime</h1><div class=lead>Gardener extension controller for the gVisor container runtime sandbox</div><h1 id=gardener-extension-for-the-gvisor-container-runtime-sandboxhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for the gVisor Container Runtime Sandbox</a><a class=td-heading-self-link href=#gardener-extension-for-the-gvisor-container-runtime-sandboxhttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-runtime-gvisor><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-runtime-gvisor alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-runtime-gvisor-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-runtime-gvisor-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-runtime-gvisor><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-runtime-gvisor alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service. Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>. However, the project has grown to a size where it is very hard to extend, maintain, and test. With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics. This way, we can keep Gardener core clean and independent.</p><hr><h2 id=how-to-use-this-controller>How to use this Controller<a class=td-heading-self-link href=#how-to-use-this-controller aria-label="Heading self-link"></a></h2><p>This controller operates on the <a href=/docs/gardener/extensions/resources/containerruntime/>ContainerRuntime</a> resource in the <code>extensions.gardener.cloud/v1alpha1 API</code> group.</p><p>It manages objects that are requesting (<code>.spec.type=gvisor</code>) to enable the gVisor container runtime sandbox for a worker pool of a shoot cluster.</p><p>The ContainerRuntime can be configured in the shoot manifest in <code>.spec.povider.workers[].cri.containerRuntimes</code> an example can be found <a href=https://github.com/gardener/gardener-extension-runtime-gvisor/blob/master/example/shoot.yaml>here</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: gvisor-shoot
</span></span><span style=display:flex><span>  namespace: garden-local
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>      - name: worker-xyz
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>        cri:
</span></span><span style=display:flex><span>          name: containerd
</span></span><span style=display:flex><span>          containerRuntimes:
</span></span><span style=display:flex><span>            - type: gvisor
</span></span><span style=display:flex><span>    ...
</span></span></code></pre></div><p>GVisor can be configured with additional configuration flags by adding them to the <code>configFlags</code> field in the providerConfig. Right now we only allow the <code>"net-raw"</code> flag to be set. All other flags are ignored.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>            - type: gvisor
</span></span><span style=display:flex><span>              providerConfig:
</span></span><span style=display:flex><span>                apiVersion: gvisor.os.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>                kind: GVisorConfiguration
</span></span><span style=display:flex><span>                configFlags:
</span></span><span style=display:flex><span>                  <span style=color:#a31515>&#34;net-raw&#34;</span> <span style=color:#a31515>&#34;true&#34;</span>
</span></span><span style=display:flex><span>                  ...
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Based on the configuration in the shoot manifest the ContainerRuntime resource is created:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: ContainerRuntime
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-container-runtime
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  binaryPath: /var/bin/containerruntimes
</span></span><span style=display:flex><span>  type: gvisor
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: gvisor.runtime.extensions.config.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    configFlags:
</span></span><span style=display:flex><span>      net-raw: <span style=color:#a31515>&#34;true&#34;</span>
</span></span><span style=display:flex><span>    kind: GVisorConfiguration
</span></span><span style=display:flex><span>  workerPool:
</span></span><span style=display:flex><span>    name: worker-ubuntu
</span></span><span style=display:flex><span>    selector:
</span></span><span style=display:flex><span>      matchLabels:
</span></span><span style=display:flex><span>        worker.gardener.cloud/pool: worker-xyz
</span></span></code></pre></div><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the kubeconfig to the cluster you want to connect to ready in the <code>./dev/kubeconfig</code> file.</p><p>Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-runtime-gvisor/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/10-shoot-additional-container-runtimes.md>GEP-10 (Additional Container Runtimes)</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-cffa3bdf900ab3321268d1bbbd4743ff>5 - Others</h1><div class=lead>Other Gardener extensions</div></div><div class=td-content><h1 id=pg-ed74ceaa562b93985c3d5ce5042a7a22>5.1 - Certificate services</h1><div class=lead>Gardener extension controller for certificate services for shoot clusters</div><h1 id=gardener-extension-for-certificate-serviceshttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for certificate services</a><a class=td-heading-self-link href=#gardener-extension-for-certificate-serviceshttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-cert-service><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-cert-service alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-shoot-cert-service-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-shoot-cert-service-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-shoot-cert-service><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-shoot-cert-service alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service. Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>. However, the project has grown to a size where it is very hard to extend, maintain, and test. With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics. This way, we can keep Gardener core clean and independent.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>Example configuration for this extension controller:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: shoot-cert-service.extensions.config.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Configuration
</span></span><span style=display:flex><span>issuerName: gardener
</span></span><span style=display:flex><span>restrictIssuer: <span style=color:#00f>true</span> <span style=color:green># restrict issuer to any sub-domain of shoot.spec.dns.domain (default)</span>
</span></span><span style=display:flex><span>acme:
</span></span><span style=display:flex><span>  email: john.doe@example.com
</span></span><span style=display:flex><span>  server: https://acme-v02.api.letsencrypt.org/directory
</span></span><span style=display:flex><span><span style=color:green># privateKey: | # Optional key for Let&#39;s Encrypt account.</span>
</span></span><span style=display:flex><span><span style=color:green>#   -----BEGIN BEGIN RSA PRIVATE KEY-----</span>
</span></span><span style=display:flex><span><span style=color:green>#   ...</span>
</span></span><span style=display:flex><span><span style=color:green>#   -----END RSA PRIVATE KEY-----</span>
</span></span></code></pre></div><h2 id=extension-resources>Extension-Resources<a class=td-heading-self-link href=#extension-resources aria-label="Heading self-link"></a></h2><p>Example extension resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Extension
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: <span style=color:#a31515>&#34;extension-certificate-service&#34;</span>
</span></span><span style=display:flex><span>  namespace: shoot--project--abc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: shoot-cert-service
</span></span></code></pre></div><p>When an extension resource is reconciled, the extension controller will create an instance of <a href=https://github.com/gardener/cert-management>Cert-Management</a> as well as an <code>Issuer</code> with the ACME information provided in the <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/#Configuration>configuration</a> above. These resources are placed inside the shoot namespace on the seed. Also, the controller takes care about generating necessary <code>RBAC</code> resources for the seed as well as for the shoot.</p><p>Please note, this extension controller relies on the <a href=https://github.com/gardener/gardener-resource-manager>Gardener-Resource-Manager</a> to deploy k8s resources to seed and shoot clusters, i.e. it never deploys them directly.</p><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the kubeconfig to the cluster you want to connect to ready in the <code>./dev/kubeconfig</code> file.
Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-cert-service/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a7493d3f6af5f7614666d700176dc331>5.1.1 - Changing alerting settings</h1><div class=lead>How to change the alerting on expiring certificates</div><h1 id=changing-alerting-settings>Changing alerting settings<a class=td-heading-self-link href=#changing-alerting-settings aria-label="Heading self-link"></a></h1><p>Certificates are normally renewed automatically 30 days before they expire.
As a second line of defense, there is an alerting in Prometheus activated if the certificate is a few days
before expiration. By default, the alert is triggered 15 days before expiration.</p><p>You can configure the days in the <code>providerConfig</code> of the extension.
Setting it to 0 disables the alerting.</p><p>In this example, the days are changed to 3 days before expiration.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-cert-service
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: CertConfig
</span></span><span style=display:flex><span>      alerting:
</span></span><span style=display:flex><span>        certExpirationAlertDays: 3
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-938a1eb564207b1aa0e30daeca7ffeda>5.1.2 - Manage certificates with Gardener for default domain</h1><div class=lead>Use the Gardener cert-management to get fully managed, publicly trusted TLS certificates</div><h1 id=manage-certificates-with-gardener-for-default-domain>Manage certificates with Gardener for default domain<a class=td-heading-self-link href=#manage-certificates-with-gardener-for-default-domain aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Dealing with applications on Kubernetes which offer a secure service endpoints (e.g. HTTPS) also require you to enable a
secured communication via SSL/TLS. With the <a href=https://github.com/gardener/gardener-extension-shoot-cert-service>certificate extension</a> enabled, Gardener can manage commonly trusted X.509 certificate for your application
endpoint. From initially requesting certificate, it also handeles their renewal in time using the free Let&rsquo;s Encrypt API.</p><p><strong>There are two senarios with which you can use the certificate extension</strong></p><ul><li>You want to use a certificate for a subdomain the shoot&rsquo;s default DNS (see <code>.spec.dns.domain</code> of your shoot resource, e.g. <code>short.ingress.shoot.project.default-domain.gardener.cloud</code>). If this is your case, please keep reading this article.</li><li>You want to use a certificate for a custom domain. If this is your case, please see <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/>Manage certificates with Gardener for public domain</a></li></ul><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Before you start this guide there are a few requirements you need to fulfill:</p><ul><li>You have an existing shoot cluster</li></ul><p>Since you are using the default DNS name, all DNS configuration should already be done and ready.</p><h2 id=issue-a-certificate>Issue a certificate<a class=td-heading-self-link href=#issue-a-certificate aria-label="Heading self-link"></a></h2><p>Every X.509 certificate is represented by a Kubernetes custom resource <code>certificate.cert.gardener.cloud</code> in your cluster. A <code>Certificate</code> resource may be used to initiate a new certificate request as well as to manage its lifecycle. Gardener&rsquo;s certificate service regularly checks the expiration timestamp of Certificates, triggers a renewal process if necessary and replaces the existing X.509 certificate with a new one.</p><blockquote><p>Your application should be able to reload replaced certificates in a timely manner to avoid service disruptions.</p></blockquote><p>Certificates can be requested via 3 resources type</p><ul><li>Ingress</li><li>Service (type LoadBalancer)</li><li>certificate (Gardener CRD)</li></ul><p>If either of the first 2 are used, a corresponding <code>Certificate</code> resource will automatically be created.</p><h3 id=using-an-ingress-resource>Using an ingress Resource<a class=td-heading-self-link href=#using-an-ingress-resource aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/purpose: managed
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/issuer: custom-issuer                    # optional to specify custom issuer (use namespace/name for shoot issuers)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/follow-cname: &#34;true&#34;                     # optional, same as spec.followCNAME in certificates</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/secret-labels: &#34;key1=value1,key2=value2&#34; # optional labels for the certificate secret</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/preferred-chain: &#34;chain name&#34;            # optional to specify preferred-chain (value is the Subject Common Name of the root issuer)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-algorithm: ECDSA             # optional to specify algorithm for private key, allowed values are &#39;RSA&#39; or &#39;ECDSA&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-size: &#34;384&#34;                  # optional to specify size of private key, allowed values for RSA are &#34;2048&#34;, &#34;3072&#34;, &#34;4096&#34; and for ECDSA &#34;256&#34; and &#34;384&#34;spec:</span>
</span></span><span style=display:flex><span>  tls:
</span></span><span style=display:flex><span>  - hosts:
</span></span><span style=display:flex><span>    <span style=color:green># Must not exceed 64 characters.</span>
</span></span><span style=display:flex><span>    - short.ingress.shoot.project.default-domain.gardener.cloud
</span></span><span style=display:flex><span>    <span style=color:green># Certificate and private key reside in this secret.</span>
</span></span><span style=display:flex><span>    secretName: tls-secret
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  - host: short.ingress.shoot.project.default-domain.gardener.cloud
</span></span><span style=display:flex><span>    http:
</span></span><span style=display:flex><span>      paths:
</span></span><span style=display:flex><span>      - pathType: Prefix
</span></span><span style=display:flex><span>        path: <span style=color:#a31515>&#34;/&#34;</span>
</span></span><span style=display:flex><span>        backend:
</span></span><span style=display:flex><span>          service:
</span></span><span style=display:flex><span>            name: amazing-svc
</span></span><span style=display:flex><span>            port:
</span></span><span style=display:flex><span>              number: 8080
</span></span></code></pre></div><h3 id=using-a-service-type-loadbalancer>Using a service type LoadBalancer<a class=td-heading-self-link href=#using-a-service-type-loadbalancer aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/purpose: managed
</span></span><span style=display:flex><span>    <span style=color:green># Certificate and private key reside in this secret.</span>
</span></span><span style=display:flex><span>    cert.gardener.cloud/secretname: tls-secret
</span></span><span style=display:flex><span>    <span style=color:green># You may add more domains separated by commas (e.g. &#34;service.shoot.project.default-domain.gardener.cloud, amazing.shoot.project.default-domain.gardener.cloud&#34;)</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: <span style=color:#a31515>&#34;service.shoot.project.default-domain.gardener.cloud&#34;</span> 
</span></span><span style=display:flex><span>    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;600&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/issuer: custom-issuer                    # optional to specify custom issuer (use namespace/name for shoot issuers)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/follow-cname: &#34;true&#34;                     # optional, same as spec.followCNAME in certificates</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/secret-labels: &#34;key1=value1,key2=value2&#34; # optional labels for the certificate secret</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/preferred-chain: &#34;chain name&#34;            # optional to specify preferred-chain (value is the Subject Common Name of the root issuer)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-algorithm: ECDSA             # optional to specify algorithm for private key, allowed values are &#39;RSA&#39; or &#39;ECDSA&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-size: &#34;384&#34;                  # optional to specify size of private key, allowed values for RSA are &#34;2048&#34;, &#34;3072&#34;, &#34;4096&#34; and for ECDSA &#34;256&#34; and &#34;384&#34;  name: test-service</span>
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>    - name: http
</span></span><span style=display:flex><span>      port: 80
</span></span><span style=display:flex><span>      protocol: TCP
</span></span><span style=display:flex><span>      targetPort: 8080
</span></span><span style=display:flex><span>  type: LoadBalancer
</span></span></code></pre></div><h3 id=using-the-custom-certificate-resource>Using the custom Certificate resource<a class=td-heading-self-link href=#using-the-custom-certificate-resource aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Certificate
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: cert-example
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  commonName: short.ingress.shoot.project.default-domain.gardener.cloud
</span></span><span style=display:flex><span>  secretRef:
</span></span><span style=display:flex><span>    name: tls-secret
</span></span><span style=display:flex><span>    namespace: default
</span></span><span style=display:flex><span>  <span style=color:green># Optionnal if using the default issuer</span>
</span></span><span style=display:flex><span>  issuerRef:
</span></span><span style=display:flex><span>    name: garden
</span></span></code></pre></div><p>If you&rsquo;re interested in the current progress of your request, you&rsquo;re advised to consult the description, more specifically the <code>status</code> attribute in case the issuance failed.</p><h2 id=request-a-wildcard-certificate>Request a wildcard certificate<a class=td-heading-self-link href=#request-a-wildcard-certificate aria-label="Heading self-link"></a></h2><p>In order to avoid the creation of multiples certificates for every single endpoints, you may want to create a wildcard certificate for your shoot&rsquo;s default cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/purpose: managed
</span></span><span style=display:flex><span>    cert.gardener.cloud/commonName: <span style=color:#a31515>&#34;*.ingress.shoot.project.default-domain.gardener.cloud&#34;</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  tls:
</span></span><span style=display:flex><span>  - hosts:
</span></span><span style=display:flex><span>    - amazing.ingress.shoot.project.default-domain.gardener.cloud
</span></span><span style=display:flex><span>    secretName: tls-secret
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  - host: amazing.ingress.shoot.project.default-domain.gardener.cloud
</span></span><span style=display:flex><span>    http:
</span></span><span style=display:flex><span>      paths:
</span></span><span style=display:flex><span>      - pathType: Prefix
</span></span><span style=display:flex><span>        path: <span style=color:#a31515>&#34;/&#34;</span>
</span></span><span style=display:flex><span>        backend:
</span></span><span style=display:flex><span>          service:
</span></span><span style=display:flex><span>            name: amazing-svc
</span></span><span style=display:flex><span>            port:
</span></span><span style=display:flex><span>              number: 8080
</span></span></code></pre></div><p>Please note that this can also be achived by directly adding an annotation to a Service type LoadBalancer. You could also create a Certificate object with a wildcard domain.</p><h2 id=more-information>More information<a class=td-heading-self-link href=#more-information aria-label="Heading self-link"></a></h2><p>For more information and more examples about using the certificate extension, please see <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/>Manage certificates with Gardener for public domain</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-37cf7e12cfd0a0c8e335a954d4e324a1>5.1.3 - Manage certificates with Gardener for public domain</h1><div class=lead>Use the Gardener cert-management to get fully managed, publicly trusted TLS certificates</div><h1 id=manage-certificates-with-gardener-for-public-domain>Manage certificates with Gardener for public domain<a class=td-heading-self-link href=#manage-certificates-with-gardener-for-public-domain aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Dealing with applications on Kubernetes which offer a secure service endpoints (e.g. HTTPS) also require you to enable a
secured communication via SSL/TLS. With the <a href=https://github.com/gardener/gardener-extension-shoot-cert-service>certificate extension</a> enabled, Gardener can manage commonly trusted X.509 certificate for your application
endpoint. From initially requesting certificate, it also handeles their renewal in time using the free Let&rsquo;s Encrypt API.</p><p><strong>There are two senarios with which you can use the certificate extension</strong></p><ul><li>You want to use a certificate for a subdomain the shoot&rsquo;s default DNS (see <code>.spec.dns.domain</code> of your shoot resource, e.g. <code>short.ingress.shoot.project.default-domain.gardener.cloud</code>). If this is your case, please see <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_default_domain_cert/>Manage certificates with Gardener for default domain</a></li><li>You want to use a certificate for a custom domain. If this is your case, please keep reading this article.</li></ul><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><p>Before you start this guide there are a few requirements you need to fulfill:</p><ul><li>You have an existing shoot cluster</li><li>Your custom domain is under a <a href=https://www.iana.org/domains/root/db>public top level domain</a> (e.g. <code>.com</code>)</li><li>Your custom zone is resolvable with a public resolver via the internet (e.g. <code>8.8.8.8</code>)</li><li>You have a custom DNS provider configured and working (see <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_providers/>&ldquo;DNS Providers&rdquo;</a>)</li></ul><p>As part of the <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a> <a href=https://tools.ietf.org/html/rfc8555>ACME</a> challenge validation process, Gardener sets a DNS TXT entry and Let&rsquo;s Encrypt checks if it can both resolve and authenticate it. Therefore, it&rsquo;s important that your DNS-entries are publicly resolvable. You can check this by querying e.g. Googles public DNS server and if it returns an entry your DNS is publicly visible:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:green># returns the A record for cert-example.example.com using Googles DNS server (8.8.8.8)</span>
</span></span><span style=display:flex><span>dig cert-example.example.com @8.8.8.8 A
</span></span></code></pre></div><h3 id=dns-provider>DNS provider<a class=td-heading-self-link href=#dns-provider aria-label="Heading self-link"></a></h3><p>In order to issue certificates for a custom domain you need to specify a DNS provider which is permitted to create DNS records for subdomains of your requested domain in the certificate. For example, if you request a certificate for <code>host.example.com</code> your DNS provider must be capable of managing subdomains of <code>host.example.com</code>.</p><p>DNS providers are normally specified in the shoot manifest. To learn more on how to configure one, please see the <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_providers/>DNS provider</a> documentation.</p><h2 id=issue-a-certificate>Issue a certificate<a class=td-heading-self-link href=#issue-a-certificate aria-label="Heading self-link"></a></h2><p>Every X.509 certificate is represented by a Kubernetes custom resource <code>certificate.cert.gardener.cloud</code> in your cluster. A <code>Certificate</code> resource may be used to initiate a new certificate request as well as to manage its lifecycle. Gardener&rsquo;s certificate service regularly checks the expiration timestamp of Certificates, triggers a renewal process if necessary and replaces the existing X.509 certificate with a new one.</p><blockquote><p>Your application should be able to reload replaced certificates in a timely manner to avoid service disruptions.</p></blockquote><p>Certificates can be requested via 3 resources type</p><ul><li>Ingress</li><li>Service (type LoadBalancer)</li><li>Gateways (both Istio gateways and from the Gateway API)</li><li>Certificate (Gardener CRD)</li></ul><p>If either of the first 2 are used, a corresponding <code>Certificate</code> resource will be created automatically.</p><h3 id=using-an-ingress-resource>Using an Ingress Resource<a class=td-heading-self-link href=#using-an-ingress-resource aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/purpose: managed
</span></span><span style=display:flex><span>    <span style=color:green># Optional but recommended, this is going to create the DNS entry at the same time</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;600&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/commonname: &#34;*.example.com&#34;              # optional, if not specified the first name from spec.tls[].hosts is used as common name</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/dnsnames: &#34;&#34;                             # optional, if not specified the names from spec.tls[].hosts are used</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/follow-cname: &#34;true&#34;                     # optional, same as spec.followCNAME in certificates</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/secret-labels: &#34;key1=value1,key2=value2&#34; # optional labels for the certificate secret</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/issuer: custom-issuer                    # optional to specify custom issuer (use namespace/name for shoot issuers)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/preferred-chain: &#34;chain name&#34;            # optional to specify preferred-chain (value is the Subject Common Name of the root issuer)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-algorithm: ECDSA             # optional to specify algorithm for private key, allowed values are &#39;RSA&#39; or &#39;ECDSA&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-size: &#34;384&#34;                  # optional to specify size of private key, allowed values for RSA are &#34;2048&#34;, &#34;3072&#34;, &#34;4096&#34; and for ECDSA &#34;256&#34; and &#34;384&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  tls:
</span></span><span style=display:flex><span>  - hosts:
</span></span><span style=display:flex><span>    <span style=color:green># Must not exceed 64 characters.</span>
</span></span><span style=display:flex><span>    - amazing.example.com
</span></span><span style=display:flex><span>    <span style=color:green># Certificate and private key reside in this secret.</span>
</span></span><span style=display:flex><span>    secretName: tls-secret
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  - host: amazing.example.com
</span></span><span style=display:flex><span>    http:
</span></span><span style=display:flex><span>      paths:
</span></span><span style=display:flex><span>      - pathType: Prefix
</span></span><span style=display:flex><span>        path: <span style=color:#a31515>&#34;/&#34;</span>
</span></span><span style=display:flex><span>        backend:
</span></span><span style=display:flex><span>          service:
</span></span><span style=display:flex><span>            name: amazing-svc
</span></span><span style=display:flex><span>            port:
</span></span><span style=display:flex><span>              number: 8080
</span></span></code></pre></div><p>Replace the <code>hosts</code> and <code>rules[].host</code> value again with your own domain and adjust the remaining Ingress attributes in accordance with your deployment (e.g. the above is for an <code>istio</code> Ingress controller and forwards traffic to a <code>service1</code> on port 80).</p><h3 id=using-a-service-of-type-loadbalancer>Using a Service of type LoadBalancer<a class=td-heading-self-link href=#using-a-service-of-type-loadbalancer aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/secretname: tls-secret
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: example.example.com
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>    <span style=color:green># Optional</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;600&#34;</span>
</span></span><span style=display:flex><span>    cert.gardener.cloud/commonname: <span style=color:#a31515>&#34;*.example.example.com&#34;</span>
</span></span><span style=display:flex><span>    cert.gardener.cloud/dnsnames: <span style=color:#a31515>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/follow-cname: &#34;true&#34;                     # optional, same as spec.followCNAME in certificates</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/secret-labels: &#34;key1=value1,key2=value2&#34; # optional labels for the certificate secret</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/issuer: custom-issuer                    # optional to specify custom issuer (use namespace/name for shoot issuers)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/preferred-chain: &#34;chain name&#34;            # optional to specify preferred-chain (value is the Subject Common Name of the root issuer)</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-algorithm: ECDSA             # optional to specify algorithm for private key, allowed values are &#39;RSA&#39; or &#39;ECDSA&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/private-key-size: &#34;384&#34;                  # optional to specify size of private key, allowed values for RSA are &#34;2048&#34;, &#34;3072&#34;, &#34;4096&#34; and for ECDSA &#34;256&#34; and &#34;384&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  name: test-service
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>    - name: http
</span></span><span style=display:flex><span>      port: 80
</span></span><span style=display:flex><span>      protocol: TCP
</span></span><span style=display:flex><span>      targetPort: 8080
</span></span><span style=display:flex><span>  type: LoadBalancer
</span></span></code></pre></div><h3 id=using-a-gateway-resource>Using a Gateway resource<a class=td-heading-self-link href=#using-a-gateway-resource aria-label="Heading self-link"></a></h3><p>Please see <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/tutorials/istio-gateways/>Istio Gateways</a> or <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/tutorials/gateway-api-gateways/>Gateway API</a> for details.</p><h3 id=using-the-custom-certificate-resource>Using the custom Certificate resource<a class=td-heading-self-link href=#using-the-custom-certificate-resource aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Certificate
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: cert-example
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  commonName: amazing.example.com
</span></span><span style=display:flex><span>  secretRef:
</span></span><span style=display:flex><span>    name: tls-secret
</span></span><span style=display:flex><span>    namespace: default
</span></span><span style=display:flex><span>  <span style=color:green># Optionnal if using the default issuer</span>
</span></span><span style=display:flex><span>  issuerRef:
</span></span><span style=display:flex><span>    name: garden
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># If delegated domain for DNS01 challenge should be used. This has only an effect if a CNAME record is set for</span>
</span></span><span style=display:flex><span>  <span style=color:green># &#39;_acme-challenge.amazing.example.com&#39;.</span>
</span></span><span style=display:flex><span>  <span style=color:green># For example: If a CNAME record exists &#39;_acme-challenge.amazing.example.com&#39; =&gt; &#39;_acme-challenge.writable.domain.com&#39;,</span>
</span></span><span style=display:flex><span>  <span style=color:green># the DNS challenge will be written to &#39;_acme-challenge.writable.domain.com&#39;.</span>
</span></span><span style=display:flex><span>  <span style=color:green>#followCNAME: true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># optionally set labels for the secret</span>
</span></span><span style=display:flex><span>  <span style=color:green>#secretLabels:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#  key1: value1</span>
</span></span><span style=display:flex><span>  <span style=color:green>#  key2: value2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># Optionally specify the preferred certificate chain: if the CA offers multiple certificate chains, prefer the chain with an issuer matching this Subject Common Name. If no match, the default offered chain will be used.</span>
</span></span><span style=display:flex><span>  <span style=color:green>#preferredChain: &#34;ISRG Root X1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># Optionally specify algorithm and key size for private key. Allowed algorithms: &#34;RSA&#34; (allowed sizes: 2048, 3072, 4096) and &#34;ECDSA&#34; (allowed sizes: 256, 384)</span>
</span></span><span style=display:flex><span>  <span style=color:green># If not specified, RSA with 2048 is used.</span>
</span></span><span style=display:flex><span>  <span style=color:green>#privateKey:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#  algorithm: ECDSA</span>
</span></span><span style=display:flex><span>  <span style=color:green>#  size: 384</span>
</span></span></code></pre></div><h2 id=supported-attributes>Supported attributes<a class=td-heading-self-link href=#supported-attributes aria-label="Heading self-link"></a></h2><p>Here is a list of all supported annotations regarding the certificate extension:</p><table><thead><tr><th>Path</th><th>Annotation</th><th>Value</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td>N/A</td><td><code>cert.gardener.cloud/purpose:</code></td><td><code>managed</code></td><td>Yes when using annotations</td><td>Flag for Gardener that this specific Ingress or Service requires a certificate</td></tr><tr><td><code>spec.commonName</code></td><td><code>cert.gardener.cloud/commonname:</code></td><td>E.g. &ldquo;*.demo.example.com&rdquo; or<br>&ldquo;special.example.com&rdquo;</td><td>Certificate and Ingress : No<br>Service: Yes, if DNS names unset</td><td>Specifies for which domain the certificate request will be created. If not specified, the names from spec.tls[].hosts are used. This entry must comply with the <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/#Character-Restrictions>64 character</a> limit.</td></tr><tr><td><code>spec.dnsNames</code></td><td><code>cert.gardener.cloud/dnsnames:</code></td><td>E.g. &ldquo;special.example.com&rdquo;</td><td>Certificate and Ingress : No<br>Service: Yes, if common name unset</td><td>Additional domains the certificate should be valid for (Subject Alternative Name). If not specified, the names from spec.tls[].hosts are used. Entries in this list can be longer than 64 characters.</td></tr><tr><td><code>spec.secretRef.name</code></td><td><code>cert.gardener.cloud/secretname:</code></td><td><code>any-name</code></td><td>Yes for certificate and Service</td><td>Specifies the secret which contains the certificate/key pair. If the secret is not available yet, it&rsquo;ll be created automatically as soon as the certificate has been issued.</td></tr><tr><td><code>spec.issuerRef.name</code></td><td><code>cert.gardener.cloud/issuer:</code></td><td>E.g. <code>gardener</code></td><td>No</td><td>Specifies the issuer you want to use. Only necessary if you request certificates for <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/#Custom-Domains>custom domains</a>.</td></tr><tr><td>N/A</td><td><code>cert.gardener.cloud/revoked:</code></td><td><code>true</code> otherwise always false</td><td>No</td><td>Use only to revoke a certificate, see <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/#references>reference</a> for more details</td></tr><tr><td><code>spec.followCNAME</code></td><td><code>cert.gardener.cloud/follow-cname</code></td><td>E.g. <code>true</code></td><td>No</td><td>Specifies that the usage of a delegated domain for DNS challenges is allowed. Details see <a href=https://github.com/gardener/cert-management#follow-cname>Follow CNAME</a>.</td></tr><tr><td><code>spec.preferredChain</code></td><td><code>cert.gardener.cloud/preferred-chain</code></td><td>E.g. <code>ISRG Root X1</code></td><td>No</td><td>Specifies the Common Name of the issuer for selecting the certificate chain. Details see <a href=https://github.com/gardener/cert-management#preferred-chain>Preferred Chain</a>.</td></tr><tr><td><code>spec.secretLabels</code></td><td><code>cert.gardener.cloud/secret-labels</code></td><td>for annotation use e.g. <code>key1=value1,key2=value2</code></td><td>No</td><td>Specifies labels for the certificate secret.</td></tr><tr><td><code>spec.privateKey.algorithm</code></td><td><code>cert.gardener.cloud/private-key-algorithm</code></td><td><code>RSA</code>, <code>ECDSA</code></td><td>No</td><td>Specifies algorithm for private key generation. The default value is depending on configuration of the extension (default of the default is <code>RSA</code>). You may request a new certificate without privateKey settings to find out the concrete defaults in your Gardener.</td></tr><tr><td><code>spec.privateKey.size</code></td><td><code>cert.gardener.cloud/private-key-size</code></td><td><code>"256"</code>, <code>"384"</code>, <code>"2048"</code>, <code>"3072"</code>, <code>"4096"</code></td><td>No</td><td>Specifies size for private key generation. Allowed values for <code>RSA</code> are <code>2048</code>, <code>3072</code>, and <code>4096</code>. For <code>ECDSA</code> allowed values are <code>256</code> and <code>384</code>. The default values are depending on the configuration of the extension (defaults of the default values are <code>3072</code> for <code>RSA</code> and <code>384</code> for <code>ECDSA</code> respectively).</td></tr></tbody></table><h2 id=request-a-wildcard-certificate>Request a wildcard certificate<a class=td-heading-self-link href=#request-a-wildcard-certificate aria-label="Heading self-link"></a></h2><p>In order to avoid the creation of multiples certificates for every single endpoints, you may want to create a wildcard certificate for your shoot&rsquo;s default cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/purpose: managed
</span></span><span style=display:flex><span>    cert.gardener.cloud/commonName: <span style=color:#a31515>&#34;*.example.com&#34;</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  tls:
</span></span><span style=display:flex><span>  - hosts:
</span></span><span style=display:flex><span>    - amazing.example.com
</span></span><span style=display:flex><span>    secretName: tls-secret
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  - host: amazing.example.com
</span></span><span style=display:flex><span>    http:
</span></span><span style=display:flex><span>      paths:
</span></span><span style=display:flex><span>      - pathType: Prefix
</span></span><span style=display:flex><span>        path: <span style=color:#a31515>&#34;/&#34;</span>
</span></span><span style=display:flex><span>        backend:
</span></span><span style=display:flex><span>          service:
</span></span><span style=display:flex><span>            name: amazing-svc
</span></span><span style=display:flex><span>            port:
</span></span><span style=display:flex><span>              number: 8080
</span></span></code></pre></div><p>Please note that this can also be achived by directly adding an annotation to a Service type LoadBalancer. You could also create a Certificate object with a wildcard domain.</p><h2 id=using-a-custom-issuer>Using a custom Issuer<a class=td-heading-self-link href=#using-a-custom-issuer aria-label="Heading self-link"></a></h2><p>Most Gardener deployment with the certification extension enabled have a preconfigured <code>garden</code> issuer. It is also usually configured to use Let&rsquo;s Encrypt as the certificate provider.</p><p>If you need a custom issuer for a specific cluster, please see <a href=/docs/extensions/others/gardener-extension-shoot-cert-service/custom_shoot_issuer/>Using a custom Issuer</a></p><h2 id=quotas>Quotas<a class=td-heading-self-link href=#quotas aria-label="Heading self-link"></a></h2><p>For security reasons there may be a default quota on the certificate requests per day set globally in the controller
registration of the shoot-cert-service.</p><p>The default quota only applies if there is no explicit quota defined for the issuer itself with the field
<code>requestsPerDayQuota</code>, e.g.:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-cert-service
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: CertConfig
</span></span><span style=display:flex><span>      issuers:
</span></span><span style=display:flex><span>        - email: your-email@example.com
</span></span><span style=display:flex><span>          name: custom-issuer <span style=color:green># issuer name must be specified in every custom issuer request, must not be &#34;garden&#34;</span>
</span></span><span style=display:flex><span>          server: <span style=color:#a31515>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span>
</span></span><span style=display:flex><span>          requestsPerDayQuota: 10
</span></span></code></pre></div><h2 id=dns-propagation>DNS Propagation<a class=td-heading-self-link href=#dns-propagation aria-label="Heading self-link"></a></h2><p>As stated before, cert-manager uses the ACME challenge protocol to authenticate that you are the DNS owner for the domain&rsquo;s certificate you are requesting.
This works by creating a DNS TXT record in your DNS provider under <code>_acme-challenge.example.example.com</code> containing a token to compare with. The TXT record is only applied during the domain validation.
Typically, the record is propagated within a few minutes. But if the record is not visible to the ACME server for any reasons, the certificate request is retried again after several minutes.
This means you may have to wait up to one hour after the propagation problem has been resolved before the certificate request is retried. Take a look in the events with <code>kubectl describe ingress example</code> for troubleshooting.</p><h2 id=character-restrictions>Character Restrictions<a class=td-heading-self-link href=#character-restrictions aria-label="Heading self-link"></a></h2><p>Due to restriction of the common name to 64 characters, you may to leave the common name unset in such cases.</p><p>For example, the following request is invalid:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Certificate
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: cert-invalid
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  commonName: morethan64characters.ingress.shoot.project.default-domain.gardener.cloud
</span></span></code></pre></div><p>But it is valid to request a certificate for this domain if you have left the common name unset:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Certificate
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: cert-example
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  dnsNames:
</span></span><span style=display:flex><span>  - morethan64characters.ingress.shoot.project.default-domain.gardener.cloud
</span></span></code></pre></div><h2 id=references>References<a class=td-heading-self-link href=#references aria-label="Heading self-link"></a></h2><ul><li><a href=https://github.com/gardener/cert-management>Gardener cert-management</a></li><li><a href=https://github.com/gardener/gardener-extension-shoot-dns-service>Managing DNS with Gardener</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-3402884b4c1c0b3f1b0c817d7375a826>5.1.4 - Using a custom Issuer</h1><div class=lead>How to define a custom issuer forma shoot cluster</div><h1 id=using-a-custom-issuer>Using a custom Issuer<a class=td-heading-self-link href=#using-a-custom-issuer aria-label="Heading self-link"></a></h1><p>Another possibility to request certificates for custom domains is a dedicated issuer.</p><blockquote><p>Note: This is only needed if the default issuer provided by Gardener is restricted to shoot related domains or you are using domain names not visible to public DNS servers. <strong>Which means that your senario most likely doesn&rsquo;t require your to add an issuer</strong>.</p></blockquote><p>The custom issuers are specified normally in the shoot manifest. If the <code>shootIssuers</code> feature is enabled, it can alternatively be defined in the shoot cluster.</p><h2 id=custom-issuer-in-the-shoot-manifest>Custom issuer in the shoot manifest<a class=td-heading-self-link href=#custom-issuer-in-the-shoot-manifest aria-label="Heading self-link"></a></h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-cert-service
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: CertConfig
</span></span><span style=display:flex><span>      issuers:
</span></span><span style=display:flex><span>        - email: your-email@example.com
</span></span><span style=display:flex><span>          name: custom-issuer <span style=color:green># issuer name must be specified in every custom issuer request, must not be &#34;garden&#34;</span>
</span></span><span style=display:flex><span>          server: <span style=color:#a31515>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span>
</span></span><span style=display:flex><span>          privateKeySecretName: my-privatekey <span style=color:green># referenced resource, the private key must be stored in the secret at `data.privateKey` (optionally, only needed as alternative to auto registration) </span>
</span></span><span style=display:flex><span>          <span style=color:green>#precheckNameservers: # to provide special set of nameservers to be used for prechecking DNSChallenges for an issuer</span>
</span></span><span style=display:flex><span>          <span style=color:green>#- dns1.private.company-net:53</span>
</span></span><span style=display:flex><span>          <span style=color:green>#- dns2.private.company-net:53&#34; </span>
</span></span><span style=display:flex><span>      <span style=color:green>#shootIssuers:</span>
</span></span><span style=display:flex><span>        <span style=color:green># if true, allows to specify issuers in the shoot cluster</span>
</span></span><span style=display:flex><span>        <span style=color:green>#enabled: true </span>
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - name: my-privatekey
</span></span><span style=display:flex><span>    resourceRef:
</span></span><span style=display:flex><span>      apiVersion: v1
</span></span><span style=display:flex><span>      kind: Secret
</span></span><span style=display:flex><span>      name: custom-issuer-privatekey <span style=color:green># name of secret in Gardener project</span>
</span></span></code></pre></div><p>If you are using an ACME provider for private domains, you may need to change the nameservers used for
checking the availability of the DNS challenge&rsquo;s TXT record before the certificate is requested from the ACME provider.
By default, only public DNS servers may be used for this purpose.
At least one of the <code>precheckNameservers</code> must be able to resolve the private domain names.</p><h3 id=using-the-custom-issuer>Using the custom issuer<a class=td-heading-self-link href=#using-the-custom-issuer aria-label="Heading self-link"></a></h3><p>To use the custom issuer in a certificate, just specify its name in the spec.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Certificate
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  issuerRef:
</span></span><span style=display:flex><span>    name: custom-issuer
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>For source resources like <code>Ingress</code> or <code>Service</code> use the <code>cert.gardener.cloud/issuer</code> annotation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/purpose: managed
</span></span><span style=display:flex><span>    cert.gardener.cloud/issuer: custom-issuer
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=custom-issuer-in-the-shoot-cluster>Custom issuer in the shoot cluster<a class=td-heading-self-link href=#custom-issuer-in-the-shoot-cluster aria-label="Heading self-link"></a></h2><p><em>Prerequiste</em>: The <code>shootIssuers</code> feature has to be enabled.
It is either enabled globally in the <code>ControllerDeployment</code> or in the shoot manifest
with:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-cert-service
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: CertConfig
</span></span><span style=display:flex><span>      shootIssuers:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span> <span style=color:green># if true, allows to specify issuers in the shoot cluster</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Example for specifying an <code>Issuer</code> resource and its <code>Secret</code> directly in any
namespace of the shoot cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Issuer
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-own-issuer
</span></span><span style=display:flex><span>  namespace: my-namespace
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  acme:
</span></span><span style=display:flex><span>    domains:
</span></span><span style=display:flex><span>      include:
</span></span><span style=display:flex><span>      - my.own.domain.com
</span></span><span style=display:flex><span>    email: some.user@my.own.domain.com
</span></span><span style=display:flex><span>    privateKeySecretRef:
</span></span><span style=display:flex><span>      name: my-own-issuer-secret
</span></span><span style=display:flex><span>      namespace: my-namespace
</span></span><span style=display:flex><span>    server: https://acme-v02.api.letsencrypt.org/directory
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-own-issuer-secret
</span></span><span style=display:flex><span>  namespace: my-namespace
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  privateKey: ... <span style=color:green># replace &#39;...&#39; with valus encoded as base64</span>
</span></span></code></pre></div><h3 id=using-the-custom-shoot-issuer>Using the custom shoot issuer<a class=td-heading-self-link href=#using-the-custom-shoot-issuer aria-label="Heading self-link"></a></h3><p>To use the custom issuer in a certificate, just specify its name and namespace in the spec.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Certificate
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  issuerRef:
</span></span><span style=display:flex><span>    name: my-own-issuer
</span></span><span style=display:flex><span>    namespace: my-namespace
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><p>For source resources like <code>Ingress</code> or <code>Service</code> use the <code>cert.gardener.cloud/issuer</code> annotation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/purpose: managed
</span></span><span style=display:flex><span>    cert.gardener.cloud/issuer: my-namespace/my-own-issuer
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-2b9b78037572abda5ff1054023909c78>5.1.5 - Deployment</h1><h1 id=gardener-certificate-management>Gardener Certificate Management<a class=td-heading-self-link href=#gardener-certificate-management aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener comes with an extension that enables shoot owners to request X.509 compliant certificates for shoot domains.</p><h2 id=extension-installation>Extension Installation<a class=td-heading-self-link href=#extension-installation aria-label="Heading self-link"></a></h2><p>The <code>Shoot-Cert-Service</code> extension can be deployed and configured via Gardener&rsquo;s native resource <a href=/docs/gardener/extensions/controllerregistration/>ControllerRegistration</a>.</p><h3 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h3><p>To let the <code>Shoot-Cert-Service</code> operate properly, you need to have:</p><ul><li>a <a href=https://github.com/gardener/external-dns-management>DNS service</a> in your seed</li><li>contact details and optionally a private key for a pre-existing <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a> account</li></ul><h3 id=controllerregistration>ControllerRegistration<a class=td-heading-self-link href=#controllerregistration aria-label="Heading self-link"></a></h3><p>An example of a <code>ControllerRegistration</code> for the <code>Shoot-Cert-Service</code> can be found at <a href=https://github.com/gardener/gardener-extension-shoot-cert-service/blob/master/example/controller-registration.yaml>controller-registration.yaml</a>.</p><p>The <code>ControllerRegistration</code> contains a Helm chart which eventually deploy the <code>Shoot-Cert-Service</code> to seed clusters. It offers some configuration options, mainly to set up a default issuer for shoot clusters. With a default issuer, pre-existing Let&rsquo;s Encrypt accounts can be used and shared with shoot clusters (See &ldquo;One Account or Many?&rdquo; of the <a href=https://letsencrypt.org/docs/integration-guide/>Integration Guide</a>).</p><blockquote><p>Please keep the Let&rsquo;s Encrypt <a href=https://letsencrypt.org/docs/rate-limits/>Rate Limits</a> in mind when using this shared account model. Depending on the amount of shoots and domains it is recommended to use an account with increased rate limits.</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerRegistration
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  values:
</span></span><span style=display:flex><span>    certificateConfig:
</span></span><span style=display:flex><span>      defaultIssuer:
</span></span><span style=display:flex><span>        acme:
</span></span><span style=display:flex><span>            email: foo@example.com
</span></span><span style=display:flex><span>            privateKey: |-<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>            -----BEGIN RSA PRIVATE KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>            ...
</span></span></span><span style=display:flex><span><span style=color:#a31515>            -----END RSA PRIVATE KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>            server: https://acme-v02.api.letsencrypt.org/directory</span>            
</span></span><span style=display:flex><span>        name: default-issuer
</span></span><span style=display:flex><span><span style=color:green>#       restricted: true # restrict default issuer to any sub-domain of shoot.spec.dns.domain</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green>#     defaultRequestsPerDayQuota: 50</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green>#     precheckNameservers: 8.8.8.8,8.8.4.4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green>#     caCertificates: | # optional custom CA certificates when using private ACME provider</span>
</span></span><span style=display:flex><span><span style=color:green>#     -----BEGIN CERTIFICATE-----</span>
</span></span><span style=display:flex><span><span style=color:green>#     ...</span>
</span></span><span style=display:flex><span><span style=color:green>#     -----END CERTIFICATE-----</span>
</span></span><span style=display:flex><span><span style=color:green>#</span>
</span></span><span style=display:flex><span><span style=color:green>#     -----BEGIN CERTIFICATE-----</span>
</span></span><span style=display:flex><span><span style=color:green>#     ...</span>
</span></span><span style=display:flex><span><span style=color:green>#     -----END CERTIFICATE-----</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      shootIssuers:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>false</span> <span style=color:green># if true, allows to specify issuers in the shoot clusters</span>
</span></span></code></pre></div><h4 id=enablement>Enablement<a class=td-heading-self-link href=#enablement aria-label="Heading self-link"></a></h4><p>If the <code>Shoot-Cert-Service</code> should be enabled for every shoot cluster in your Gardener managed environment, you need to globally enable it in the <code>ControllerRegistration</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerRegistration
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - globallyEnabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    kind: Extension
</span></span><span style=display:flex><span>    type: shoot-cert-service
</span></span></code></pre></div><p>Alternatively, you&rsquo;re given the option to only enable the service for certain shoots:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-cert-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6d9e639c54740cffc4077bf1de9de8a1>5.1.6 - Gardener yourself a Shoot with Istio, custom Domains, and Certificates</h1><p>As we ramp up more and more friends of Gardener, I thought it worthwhile to explore and write a tutorial about how to simply:</p><ul><li>create a Gardener managed Kubernetes Cluster (Shoot) via kubectl</li><li>install Istio as a preferred, production ready Ingress/Service Mesh (instead of the Nginx Ingress addon)</li><li>attach your own custom domain to be managed by Gardener</li><li>combine everything with certificates from Let&rsquo;s Encrypt</li></ul><p>Here are some pre-pointers that you will need to go deeper:</p><ul><li><a href=/docs/guides/administer-shoots/create-delete-shoot/>CRUD Gardener Shoot</a></li><li><a href=https://github.com/gardener/external-dns-management/blob/master/README.md>DNS Management</a></li><li><a href=https://github.com/gardener/cert-management/blob/master/README.md>Certificate Management</a></li><li><a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_names/>Tutorial Domain Names</a></li><li><a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/>Tutorial Certificates</a></li></ul><div class="alert alert-primary" role=alert><h4 class=alert-heading>Tip</h4>If you try my instructions and fail, then read the alternative title of this tutorial as &ldquo;Shoot yourself in the foot with Gardener, custom Domains, Istio and Certificates&rdquo;.</div><h2 id=first-things-first>First Things First<a class=td-heading-self-link href=#first-things-first aria-label="Heading self-link"></a></h2><p>Login to your Gardener landscape, setup a project with adequate infrastructure credentials and then navigate to your account. Note down the name of your secret. I chose the GCP infrastructure from the vast possible options that my Gardener provides me with, so i had named the secret as <code>shoot-operator-gcp</code>.</p><p>From the Access widget (leave the default settings) download your personalized <code>kubeconfig</code> into <code>~/.kube/kubeconfig-garden-myproject</code>. Follow the instructions to setup <code>kubelogin</code>:</p><p><img src=/__resources/access_0ffd66.png alt=access></p><p>For convinience, let us set an alias command with</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>alias kgarden=<span style=color:#a31515>&#34;kubectl --kubeconfig ~/.kube/kubeconfig-garden-myproject.yaml&#34;</span>
</span></span></code></pre></div><p><code>kgarden</code> now gives you all botanical powers and connects you directly with your Gardener.</p><p>You should now be able to run <code>kgarden get shoots</code>, automatically get an oidc token, and list already running clusters/shoots.</p><h2 id=prepare-your-custom-domain>Prepare your Custom Domain<a class=td-heading-self-link href=#prepare-your-custom-domain aria-label="Heading self-link"></a></h2><p>I am going to use <a href=https://www.cloudflare.com/>Cloud Flare</a> as programmatic DNS of my custom domain <code>mydomain.io</code>. Please follow detailed instructions from Cloud Flare on how to delegate your domain (the free account does not support delegating subdomains). Alternatively, AWS Route53 (and most others) support <a href=https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/CreatingNewSubdomain.html>delegating subdomains</a>.</p><p>I needed to follow these <a href=https://github.com/gardener/external-dns-management/blob/master/docs/cloudflare/README.md>instructions</a> and created the following secret:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: cloudflare-mydomain-io
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  CLOUDFLARE_API_TOKEN: useYOURownDAMITzNDU2Nzg5MDEyMzQ1Njc4OQ==
</span></span></code></pre></div><p>Apply this secret into your project with <code>kgarden create -f cloudflare-mydomain-io.yaml</code>.</p><p>Our <a href=https://github.com/gardener/external-dns-management/>External DNS Manager</a> also supports Amazon Route53, Google CloudDNS, AliCloud DNS, Azure DNS, or OpenStack Designate. Check it out.</p><h2 id=prepare-gardener-extensions>Prepare Gardener Extensions<a class=td-heading-self-link href=#prepare-gardener-extensions aria-label="Heading self-link"></a></h2><p>I now need to prepare the Gardener extensions <code>shoot-dns-service</code> and <code>shoot-cert-service</code> and set the parameters accordingly.</p><div class="alert alert-info" role=alert>Please note, that the availability of Gardener Extensions depends on how your administrator has configured the Gardener landscape. Please contact your Gardener administrator in case you experience any issues during activation.</div><p>The following snippet allows Gardener to manage my entire custom domain, whereas with the <code>include:</code> attribute I restrict all dynamic entries under the subdomain <code>gsicdc.mydomain.io</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  dns:
</span></span><span style=display:flex><span>    providers:
</span></span><span style=display:flex><span>      - domains:
</span></span><span style=display:flex><span>          include:
</span></span><span style=display:flex><span>            - gsicdc.mydomain.io
</span></span><span style=display:flex><span>        primary: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>        secretName: cloudflare-mydomain-io
</span></span><span style=display:flex><span>        type: cloudflare-dns
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-dns-service
</span></span></code></pre></div><p>The next snipplet allows Gardener to manage certificates automatically from <em><a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a></em> on <code>mydomain.io</code> for me:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-cert-service
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>        issuers:
</span></span><span style=display:flex><span>          - email: me@mail.com
</span></span><span style=display:flex><span>            name: mydomain
</span></span><span style=display:flex><span>            server: <span style=color:#a31515>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span>
</span></span><span style=display:flex><span>          - email: me@mail.com
</span></span><span style=display:flex><span>            name: mydomain-staging
</span></span><span style=display:flex><span>            server: <span style=color:#a31515>&#39;https://acme-staging-v02.api.letsencrypt.org/directory&#39;</span>
</span></span></code></pre></div><div class="alert alert-info" role=alert>Adjust the snipplets with your parameters (don&rsquo;t forget your email). And please use the mydomain-staging issuer while you are testing and learning. Otherwise, Let&rsquo;s Encrypt will rate limit your frequent requests and you can wait a week until you can continue.</div><p>References for <a href=https://letsencrypt.org>Let&rsquo;s Encrypt</a>:</p><ul><li><a href=https://letsencrypt.org/docs/rate-limits/>Rate limit</a></li><li><a href=https://letsencrypt.org/docs/staging-environment/>Staging environment</a></li><li><a href=https://letsencrypt.org/docs/challenge-types/>Challenge Types</a></li><li><a href=https://community.letsencrypt.org/t/acme-v2-production-environment-wildcards/55578>Wildcard Certificates</a></li></ul><h2 id=create-the-gardener-shoot-cluster>Create the Gardener Shoot Cluster<a class=td-heading-self-link href=#create-the-gardener-shoot-cluster aria-label="Heading self-link"></a></h2><p>Remember I chose to create the Shoot on GCP, so below is the simplest declarative shoot or cluster order document. Notice that I am referring to the infrastructure credentials with <code>shoot-operator-gcp</code> and I combined the above snippets into the yaml file:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: gsicdc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  dns:
</span></span><span style=display:flex><span>    providers:
</span></span><span style=display:flex><span>    - domains:
</span></span><span style=display:flex><span>        include:
</span></span><span style=display:flex><span>          - gsicdc.mydomain.io
</span></span><span style=display:flex><span>      primary: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>      secretName: cloudflare-mydomain-io
</span></span><span style=display:flex><span>      type: cloudflare-dns
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-dns-service
</span></span><span style=display:flex><span>  - type: shoot-cert-service
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: service.cert.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      issuers:
</span></span><span style=display:flex><span>        - email: me@mail.com
</span></span><span style=display:flex><span>          name: mydomain
</span></span><span style=display:flex><span>          server: <span style=color:#a31515>&#39;https://acme-v02.api.letsencrypt.org/directory&#39;</span>
</span></span><span style=display:flex><span>        - email: me@mail.com
</span></span><span style=display:flex><span>          name: mydomain-staging
</span></span><span style=display:flex><span>          server: <span style=color:#a31515>&#39;https://acme-staging-v02.api.letsencrypt.org/directory&#39;</span>
</span></span><span style=display:flex><span>  cloudProfileName: gcp
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    allowPrivilegedContainers: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    version: 1.24.8
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    pods: 100.96.0.0/11
</span></span><span style=display:flex><span>    services: 100.64.0.0/13
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>      zone: europe-west1-d
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: gcp.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        workers: 10.250.0.0/16
</span></span><span style=display:flex><span>    type: gcp
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - machine:
</span></span><span style=display:flex><span>        image:
</span></span><span style=display:flex><span>          name: gardenlinux
</span></span><span style=display:flex><span>          version: 576.9.0
</span></span><span style=display:flex><span>        type: n1-standard-2
</span></span><span style=display:flex><span>      maxSurge: 1
</span></span><span style=display:flex><span>      maxUnavailable: 0
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      minimum: 1
</span></span><span style=display:flex><span>      name: my-workerpool
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: pd-standard
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - europe-west1-d
</span></span><span style=display:flex><span>  purpose: testing
</span></span><span style=display:flex><span>  region: europe-west1
</span></span><span style=display:flex><span>  secretBindingName: shoot-operator-gcp
</span></span></code></pre></div><p>Create your cluster and wait for it to be ready (about 5 to 7min).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kgarden create -f gsicdc.yaml
</span></span><span style=display:flex><span>shoot.core.gardener.cloud/gsicdc created
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kgarden get shoot gsicdc --watch
</span></span><span style=display:flex><span>NAME     CLOUDPROFILE   VERSION   SEED   DOMAIN                                        HIBERNATION   OPERATION    PROGRESS   APISERVER     CONTROL       NODES     SYSTEM    AGE
</span></span><span style=display:flex><span>gsicdc   gcp            1.24.8    gcp    gsicdc.myproject.shoot.devgarden.cloud   Awake         Processing   38         Progressing   Progressing   Unknown   Unknown   83s
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>gsicdc   gcp            1.24.8    gcp    gsicdc.myproject.shoot.devgarden.cloud   Awake         Succeeded    100        True          True          True          False         6m7s
</span></span></code></pre></div><p>Get access to your freshly baked cluster and set your <code>KUBECONFIG</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kgarden get secrets gsicdc.kubeconfig -o jsonpath={.data.kubeconfig} | base64 -d &gt;kubeconfig-gsicdc.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ export KUBECONFIG=<span style=color:#00f>$(</span>pwd<span style=color:#00f>)</span>/kubeconfig-gsicdc.yaml
</span></span><span style=display:flex><span>$ kubectl get all
</span></span><span style=display:flex><span>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
</span></span><span style=display:flex><span>service/kubernetes   ClusterIP   100.64.0.1   &lt;none&gt;        443/TCP   89m
</span></span></code></pre></div><h2 id=install-istio>Install Istio<a class=td-heading-self-link href=#install-istio aria-label="Heading self-link"></a></h2><p>Please follow the Istio installation <a href=https://istio.io/docs/setup/getting-started/>instructions</a> and download <code>istioctl</code>. If you are on a Mac, I recommend:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install istioctl
</span></span></code></pre></div><p>I want to install Istio with a default profile and SDS enabled. Furthermore I pass the following annotations to the service object <code>istio-ingressgateway</code> in the <code>istio-system</code> namespace.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    cert.gardener.cloud/issuer: mydomain-staging
</span></span><span style=display:flex><span>    cert.gardener.cloud/secretname: wildcard-tls
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: <span style=color:#a31515>&#34;*.gsicdc.mydomain.io&#34;</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;120&#34;</span>
</span></span></code></pre></div><p>With these annotations three things now happen automatically:</p><ol><li>The <a href=https://github.com/gardener/external-dns-management/blob/master/README.md>External DNS Manager</a>, provided to you as a service (<code>dns.gardener.cloud/class: garden</code>), picks up the request and creates the wildcard DNS entry <code>*.gsicdc.mydomain.io</code> with a time to live of 120sec at your DNS provider. My provider Cloud Flare is very very quick (as opposed to some other services). You should be able to verify the entry with <code>dig lovemygardener.gsicdc.mydomain.io</code> within seconds.</li><li>The <a href=https://github.com/gardener/cert-management/blob/master/README.md>Certificate Management</a> picks up the request as well and initiates a DNS01 protocol exchange with Let&rsquo;s Encrypt; using the staging environment referred to with the issuer behind <code>mydomain-staging</code>.</li><li>After aproximately 70sec (give and take) you will receive the wildcard certificate in the <code>wildcard-tls</code> secret in the namespace <code>istio-system</code>.</li></ol><div class="alert alert-info" role=alert>Notice, that the namespace for the certificate secret is often the cause of many troubleshooting sessions: the secret must reside in the same namespace of the gateway.</div><p>Here is the istio-install script:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ export domainname=<span style=color:#a31515>&#34;*.gsicdc.mydomain.io&#34;</span>
</span></span><span style=display:flex><span>$ export issuer=<span style=color:#a31515>&#34;mydomain-staging&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | istioctl install -y -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: install.istio.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: IstioOperator
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  profile: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>  components:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    ingressGateways:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - name: istio-ingressgateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>      enabled: true
</span></span></span><span style=display:flex><span><span style=color:#a31515>      k8s:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        serviceAnnotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>          cert.gardener.cloud/issuer: &#34;${issuer}&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>          cert.gardener.cloud/secretname: wildcard-tls
</span></span></span><span style=display:flex><span><span style=color:#a31515>          dns.gardener.cloud/class: garden
</span></span></span><span style=display:flex><span><span style=color:#a31515>          dns.gardener.cloud/dnsnames: &#34;${domainname}&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>          dns.gardener.cloud/ttl: &#34;120&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>Verify that setup is working and that DNS and certificates have been created/delivered:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system describe service istio-ingressgateway
</span></span><span style=display:flex><span>&lt;snip&gt;
</span></span><span style=display:flex><span>Events:
</span></span><span style=display:flex><span>  Type    Reason                Age                From                     Message
</span></span><span style=display:flex><span>  ----    ------                ----               ----                     -------
</span></span><span style=display:flex><span>  Normal  EnsuringLoadBalancer  58s                service-controller       Ensuring load balancer
</span></span><span style=display:flex><span>  Normal  reconcile             58s                cert-controller-manager  created certificate object istio-system/istio-ingressgateway-service-pwqdm
</span></span><span style=display:flex><span>  Normal  cert-annotation       58s                cert-controller-manager  wildcard-tls: cert request is pending
</span></span><span style=display:flex><span>  Normal  cert-annotation       54s                cert-controller-manager  wildcard-tls: certificate pending: certificate requested, preparing/waiting <span style=color:#00f>for</span> successful DNS01 challenge
</span></span><span style=display:flex><span>  Normal  cert-annotation       28s                cert-controller-manager  wildcard-tls: certificate ready
</span></span><span style=display:flex><span>  Normal  EnsuredLoadBalancer   26s                service-controller       Ensured load balancer
</span></span><span style=display:flex><span>  Normal  reconcile             26s                dns-controller-manager   created dns entry object shoot--core--gsicdc/istio-ingressgateway-service-p9qqb
</span></span><span style=display:flex><span>  Normal  dns-annotation        26s                dns-controller-manager   *.gsicdc.mydomain.io: dns entry is pending
</span></span><span style=display:flex><span>  Normal  dns-annotation        21s (x3 over 21s)  dns-controller-manager   *.gsicdc.mydomain.io: dns entry active
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ dig lovemygardener.gsicdc.mydomain.io
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; lovemygardener.gsicdc.mydomain.io
</span></span><span style=display:flex><span>&lt;snip&gt;
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>lovemygardener.gsicdc.mydomain.io. 120 IN A	35.195.120.62
</span></span><span style=display:flex><span>&lt;snip&gt;
</span></span></code></pre></div><p>There you have it, the wildcard-tls certificate is ready and the *.gsicdc.mydomain.io dns entry is active. Traffic will be going your way.</p><h2 id=handy-tools-to-install>Handy Tools to Install<a class=td-heading-self-link href=#handy-tools-to-install aria-label="Heading self-link"></a></h2><p>Another set of fine tools to use are <a href=https://carvel.dev/kapp/>kapp</a> (formerly known as k14s), <a href=https://k9scli.io/>k9s</a> and <a href=https://httpie.org/>HTTPie</a>. While we are at it, let&rsquo;s install them all. If you are on a Mac, I recommend:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew tap vmware-tanzu/carvel
</span></span><span style=display:flex><span>brew install ytt kbld kapp kwt imgpkg vendir
</span></span><span style=display:flex><span>brew install derailed/k9s/k9s
</span></span><span style=display:flex><span>brew install httpie
</span></span></code></pre></div><h2 id=ingress-at-your-service>Ingress at Your Service<a class=td-heading-self-link href=#ingress-at-your-service aria-label="Heading self-link"></a></h2><div class="alert alert-info" role=alert>Networking is a central part of Kubernetes, but it can be challenging to understand exactly how it is expected to work. You should learn about Kubernetes networking, and first try to debug problems yourself. With a solid managed cluster from Gardener, it is always PEBCAK!</div><p>Kubernetes Ingress is a subject that is evolving to much broader standard. Please watch <a href="https://www.youtube.com/watch?v=cduG0FrjdJA">Evolving the Kubernetes Ingress APIs to GA and Beyond</a> for a good introduction. In this example, I did not want to use the Kubernetes <code>Ingress</code> compatibility option of Istio. Instead, I used <code>VirtualService</code> and <code>Gateway</code> from the Istio&rsquo;s API group <code>networking.istio.io/v1</code> directly, and enabled istio-injection generically for the namespace.</p><p>I use <a href=https://httpbin.org/>httpbin</a> as service that I want to expose to the internet, or where my ingress should be routed to (depends on your point of view, I guess).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Namespace
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: production
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    istio-injection: enabled
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: httpbin
</span></span><span style=display:flex><span>  namespace: production
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    app: httpbin
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>  - name: http
</span></span><span style=display:flex><span>    port: 8000
</span></span><span style=display:flex><span>    targetPort: 80
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    app: httpbin
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: apps/v1
</span></span><span style=display:flex><span>kind: Deployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: httpbin
</span></span><span style=display:flex><span>  namespace: production
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  replicas: 1
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      app: httpbin
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        app: httpbin
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>      - image: docker.io/kennethreitz/httpbin
</span></span><span style=display:flex><span>        imagePullPolicy: IfNotPresent
</span></span><span style=display:flex><span>        name: httpbin
</span></span><span style=display:flex><span>        ports:
</span></span><span style=display:flex><span>        - containerPort: 80
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: networking.istio.io/v1
</span></span><span style=display:flex><span>kind: Gateway
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: httpbin-gw
</span></span><span style=display:flex><span>  namespace: production
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    istio: ingressgateway <span style=color:green>#! use istio default ingress gateway</span>
</span></span><span style=display:flex><span>  servers:
</span></span><span style=display:flex><span>  - port:
</span></span><span style=display:flex><span>      number: 80
</span></span><span style=display:flex><span>      name: http
</span></span><span style=display:flex><span>      protocol: HTTP
</span></span><span style=display:flex><span>    tls:
</span></span><span style=display:flex><span>      httpsRedirect: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    hosts:
</span></span><span style=display:flex><span>    - <span style=color:#a31515>&#34;httpbin.gsicdc.mydomain.io&#34;</span>
</span></span><span style=display:flex><span>  - port:
</span></span><span style=display:flex><span>      number: 443
</span></span><span style=display:flex><span>      name: https
</span></span><span style=display:flex><span>      protocol: HTTPS
</span></span><span style=display:flex><span>    tls:
</span></span><span style=display:flex><span>      mode: SIMPLE
</span></span><span style=display:flex><span>      credentialName: wildcard-tls
</span></span><span style=display:flex><span>    hosts:
</span></span><span style=display:flex><span>    - <span style=color:#a31515>&#34;httpbin.gsicdc.mydomain.io&#34;</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: networking.istio.io/v1
</span></span><span style=display:flex><span>kind: VirtualService
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: httpbin-vs
</span></span><span style=display:flex><span>  namespace: production
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  hosts:
</span></span><span style=display:flex><span>  - <span style=color:#a31515>&#34;httpbin.gsicdc.mydomain.io&#34;</span>
</span></span><span style=display:flex><span>  gateways:
</span></span><span style=display:flex><span>  - httpbin-gw
</span></span><span style=display:flex><span>  http:
</span></span><span style=display:flex><span>  - match:
</span></span><span style=display:flex><span>    - uri:
</span></span><span style=display:flex><span>        regex: /.*
</span></span><span style=display:flex><span>    route:
</span></span><span style=display:flex><span>    - destination:
</span></span><span style=display:flex><span>        port:
</span></span><span style=display:flex><span>          number: 8000
</span></span><span style=display:flex><span>        host: httpbin
</span></span><span style=display:flex><span>---
</span></span></code></pre></div><p>Let us now deploy the whole package of Kubernetes primitives using <code>kapp</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kapp deploy -a httpbin -f httpbin-kapp.yaml
</span></span><span style=display:flex><span>Target cluster <span style=color:#a31515>&#39;https://api.gsicdc.myproject.shoot.devgarden.cloud&#39;</span> (nodes: shoot--myproject--gsicdc-my-workerpool-z1-6586c8f6cb-x24kh)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Changes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Namespace   Name        Kind            Conds.  Age  Op      Wait to    Rs  Ri
</span></span><span style=display:flex><span>(cluster)   production  Namespace       -       -    create  reconcile  -   -
</span></span><span style=display:flex><span>production  httpbin     Deployment      -       -    create  reconcile  -   -
</span></span><span style=display:flex><span>^           httpbin     Service         -       -    create  reconcile  -   -
</span></span><span style=display:flex><span>^           httpbin-gw  Gateway         -       -    create  reconcile  -   -
</span></span><span style=display:flex><span>^           httpbin-vs  VirtualService  -       -    create  reconcile  -   -
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Op:      5 create, 0 delete, 0 update, 0 noop
</span></span><span style=display:flex><span>Wait to: 5 reconcile, 0 delete, 0 noop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Continue? [yN]: y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>5:36:31PM: ---- applying 1 changes [0/5 <span style=color:#00f>done</span>] ----
</span></span><span style=display:flex><span>&lt;snip&gt;
</span></span><span style=display:flex><span>5:37:00PM: ok: reconcile deployment/httpbin (apps/v1) namespace: production
</span></span><span style=display:flex><span>5:37:00PM: ---- applying complete [5/5 <span style=color:#00f>done</span>] ----
</span></span><span style=display:flex><span>5:37:00PM: ---- waiting complete [5/5 <span style=color:#00f>done</span>] ----
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Succeeded
</span></span></code></pre></div><p>Let&rsquo;s finally test the service (Of course you can use the browser as well):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ http httpbin.gsicdc.mydomain.io
</span></span><span style=display:flex><span>HTTP/1.1 301 Moved Permanently
</span></span><span style=display:flex><span>content-length: 0
</span></span><span style=display:flex><span>date: Wed, 13 May 2020 21:29:13 GMT
</span></span><span style=display:flex><span>location: https://httpbin.gsicdc.mydomain.io/
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ curl -k https://httpbin.gsicdc.mydomain.io/ip
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#34;origin&#34;</span>: <span style=color:#a31515>&#34;10.250.0.2&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Quod erat demonstrandum.
The proof of exchanging the issuer is now left to the reader.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Tip</h4>Remember that the certificate is actually not valid because it is issued from the Let&rsquo;s encrypt staging environment. Thus, we needed &ldquo;curl -k&rdquo; or &ldquo;http &ndash;verify no&rdquo;.</div><p>Hint: use the interactive k9s tool.
<img src=/__resources/k9s_97660c.png alt=k9s></p><h2 id=cleanup>Cleanup<a class=td-heading-self-link href=#cleanup aria-label="Heading self-link"></a></h2><p>Remove the cloud native application:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kapp ls
</span></span><span style=display:flex><span>Apps in namespace <span style=color:#a31515>&#39;default&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Name     Namespaces            Lcs   Lca
</span></span><span style=display:flex><span>httpbin  (cluster),production  true  17m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kapp delete -a httpbin
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Continue? [yN]: y
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>11:47:47PM: ---- waiting complete [8/8 <span style=color:#00f>done</span>] ----
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Succeeded
</span></span></code></pre></div><p>Remove Istio:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ istioctl x uninstall --purge
</span></span><span style=display:flex><span>clusterrole.rbac.authorization.k8s.io <span style=color:#a31515>&#34;prometheus-istio-system&#34;</span> deleted
</span></span><span style=display:flex><span>clusterrolebinding.rbac.authorization.k8s.io <span style=color:#a31515>&#34;prometheus-istio-system&#34;</span> deleted
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Delete your Shoot:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kgarden annotate shoot gsicdc confirmation.gardener.cloud/deletion=true --overwrite
</span></span><span style=display:flex><span>kgarden delete shoot gsicdc --wait=false
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-a2a5f0d146f804e6007c05aca45d155f>5.1.7 - Gateway Api Gateways</h1><h1 id=using-annotated-gateway-api-gateway-andor-httproutes-as-source>Using annotated Gateway API Gateway and/or HTTPRoutes as Source<a class=td-heading-self-link href=#using-annotated-gateway-api-gateway-andor-httproutes-as-source aria-label="Heading self-link"></a></h1><p>This tutorial describes how to use annotated Gateway API resources as source for <code>Certificate</code>.</p><h2 id=install-istio-on-your-cluster>Install Istio on your cluster<a class=td-heading-self-link href=#install-istio-on-your-cluster aria-label="Heading self-link"></a></h2><p>Follow the Istio <a href=https://istio.io/latest/docs/tasks/traffic-management/ingress/gateway-api/>Kubernetes Gateway API</a> to
install the Gateway API and to install Istio.</p><p>These are the typical commands for the Istio installation with the Kubernetes Gateway API:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export KUEBCONFIG=...
</span></span><span style=display:flex><span>curl -L https://istio.io/downloadIstio | sh -
</span></span><span style=display:flex><span>kubectl get crd gateways.gateway.networking.k8s.io &amp;&gt; /dev/null || <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  { kubectl kustomize <span style=color:#a31515>&#34;github.com/kubernetes-sigs/gateway-api/config/crd?ref=v1.0.0&#34;</span> | kubectl apply -f -; }
</span></span><span style=display:flex><span>istioctl install --set profile=minimal -y
</span></span><span style=display:flex><span>kubectl label namespace default istio-injection=enabled
</span></span></code></pre></div><h2 id=verify-that-gateway-source-works>Verify that Gateway Source works<a class=td-heading-self-link href=#verify-that-gateway-source-works aria-label="Heading self-link"></a></h2><h3 id=install-a-sample-service>Install a sample service<a class=td-heading-self-link href=#install-a-sample-service aria-label="Heading self-link"></a></h3><p>With automatic sidecar injection:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/httpbin/httpbin.yaml
</span></span></code></pre></div><p>Note: The sample service is not used in the following steps. It is deployed for illustration purposes only.
To use it with certificates, you have to add an HTTPS port for it.</p><h3 id=using-a-gateway-as-a-source>Using a Gateway as a source<a class=td-heading-self-link href=#using-a-gateway-as-a-source aria-label="Heading self-link"></a></h3><p>Deploy the Gateway API configuration including a single exposed route (i.e., /get):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace istio-ingress
</span></span><span style=display:flex><span>kubectl apply -f - <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    #cert.gardener.cloud/dnsnames: &#34;*.example.com&#34; # alternative if you want to control the dns names explicitly.
</span></span></span><span style=display:flex><span><span style=color:#a31515>    cert.gardener.cloud/purpose: managed
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gatewayClassName: istio
</span></span></span><span style=display:flex><span><span style=color:#a31515>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hostname: &#34;*.example.com&#34;  # this is used by cert-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>    port: 443
</span></span></span><span style=display:flex><span><span style=color:#a31515>    protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#a31515>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      namespaces:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        from: All
</span></span></span><span style=display:flex><span><span style=color:#a31515>    tls:                       # important: tls section must be defined with exactly one certificateRefs item
</span></span></span><span style=display:flex><span><span style=color:#a31515>      certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        - name: foo-example-com
</span></span></span><span style=display:flex><span><span style=color:#a31515>---
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>    namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hostnames: [&#34;httpbin.example.com&#34;]  # this is used by cert-controller-manager to extract DNS names too
</span></span></span><span style=display:flex><span><span style=color:#a31515>  rules:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - path:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#a31515>        value: /get
</span></span></span><span style=display:flex><span><span style=color:#a31515>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>      port: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>You should now see a created <code>Certificate</code> resource similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-ingress get cert -oyaml
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>items:
</span></span><span style=display:flex><span>- apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: Certificate
</span></span><span style=display:flex><span>  metadata:
</span></span><span style=display:flex><span>    generateName: gateway-gateway-
</span></span><span style=display:flex><span>    name: gateway-gateway-kdw6h
</span></span><span style=display:flex><span>    namespace: istio-ingress
</span></span><span style=display:flex><span>    ownerReferences:
</span></span><span style=display:flex><span>    - apiVersion: gateway.networking.k8s.io/v1
</span></span><span style=display:flex><span>      blockOwnerDeletion: true
</span></span><span style=display:flex><span>      controller: true
</span></span><span style=display:flex><span>      kind: Gateway
</span></span><span style=display:flex><span>      name: gateway
</span></span><span style=display:flex><span>  spec:
</span></span><span style=display:flex><span>    commonName: <span style=color:#a31515>&#39;*.example.com&#39;</span>
</span></span><span style=display:flex><span>    secretName: foo-example-com
</span></span><span style=display:flex><span>  status:
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>kind: List
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  resourceVersion: <span style=color:#a31515>&#34;&#34;</span>
</span></span></code></pre></div><h4 id=using-a-httproute-as-a-source>Using a HTTPRoute as a source<a class=td-heading-self-link href=#using-a-httproute-as-a-source aria-label="Heading self-link"></a></h4><p>If the <code>Gateway</code> resource is annotated with <code>cert.gardener.cloud/purpose: managed</code>,
hostnames from all referencing <code>HTTPRoute</code> resources are automatically extracted.
These resources don&rsquo;t need an additional annotation.</p><p>Deploy the Gateway API configuration including a single exposed route (i.e., /get):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace istio-ingress
</span></span><span style=display:flex><span>kubectl apply -f - <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    cert.gardener.cloud/purpose: managed
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gatewayClassName: istio
</span></span></span><span style=display:flex><span><span style=color:#a31515>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hostname: null  # not set 
</span></span></span><span style=display:flex><span><span style=color:#a31515>    port: 443
</span></span></span><span style=display:flex><span><span style=color:#a31515>    protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#a31515>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      namespaces:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        from: All
</span></span></span><span style=display:flex><span><span style=color:#a31515>    tls:                            # important: tls section must be defined with exactly one certificateRefs item
</span></span></span><span style=display:flex><span><span style=color:#a31515>      certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        - name: foo-example-com
</span></span></span><span style=display:flex><span><span style=color:#a31515>---
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>    namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hostnames: [&#34;httpbin.example.com&#34;]  # this is used by dns-controller-manager to extract DNS names too
</span></span></span><span style=display:flex><span><span style=color:#a31515>  rules:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - path:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#a31515>        value: /get
</span></span></span><span style=display:flex><span><span style=color:#a31515>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>      port: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>This should show a similar <code>Certificate</code> resource as above.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-614605ecfea245fcd8cabc692b978938>5.1.8 - Istio Gateways</h1><h1 id=using-annotated-istio-gateway-andor-istio-virtual-service-as-source>Using annotated Istio Gateway and/or Istio Virtual Service as Source<a class=td-heading-self-link href=#using-annotated-istio-gateway-andor-istio-virtual-service-as-source aria-label="Heading self-link"></a></h1><p>This tutorial describes how to use annotated Istio Gateway resources as source for <code>Certificate</code> resources.</p><h2 id=install-istio-on-your-cluster>Install Istio on your cluster<a class=td-heading-self-link href=#install-istio-on-your-cluster aria-label="Heading self-link"></a></h2><p>Follow the <a href=https://istio.io/latest/docs/setup/getting-started/>Istio Getting Started</a> to download and install Istio.</p><p>These are the typical commands for the istio demo installation</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export KUEBCONFIG=...
</span></span><span style=display:flex><span>curl -L https://istio.io/downloadIstio | sh -
</span></span><span style=display:flex><span>istioctl install --set profile=demo -y
</span></span><span style=display:flex><span>kubectl label namespace default istio-injection=enabled
</span></span></code></pre></div><p><em>Note: If you are using a KinD cluster, the istio-ingressgateway service may be pending forever.</em></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system get svc istio-ingressgateway
</span></span><span style=display:flex><span>NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                                                                      AGE
</span></span><span style=display:flex><span>istio-ingressgateway   LoadBalancer   10.96.88.189   &lt;pending&gt;     15021:30590/TCP,80:30185/TCP,443:30075/TCP,31400:30129/TCP,15443:30956/TCP   13m
</span></span></code></pre></div><p>In this case, you may patch the status for demo purposes (of course it still would not accept connections)</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n istio-system patch svc istio-ingressgateway --type=merge --subresource status --patch <span style=color:#a31515>&#39;{&#34;status&#34;:{&#34;loadBalancer&#34;:{&#34;ingress&#34;:[{&#34;ip&#34;:&#34;1.2.3.4&#34;}]}}}&#39;</span>
</span></span></code></pre></div><h2 id=verify-that-istio-gatewayvirtualservice-source-works>Verify that Istio Gateway/VirtualService Source works<a class=td-heading-self-link href=#verify-that-istio-gatewayvirtualservice-source-works aria-label="Heading self-link"></a></h2><h3 id=install-a-sample-service>Install a sample service<a class=td-heading-self-link href=#install-a-sample-service aria-label="Heading self-link"></a></h3><p>With automatic sidecar injection:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/httpbin/httpbin.yaml
</span></span></code></pre></div><h3 id=using-a-gateway-as-a-source>Using a Gateway as a source<a class=td-heading-self-link href=#using-a-gateway-as-a-source aria-label="Heading self-link"></a></h3><h4 id=create-an-istio-gateway>Create an Istio Gateway:<a class=td-heading-self-link href=#create-an-istio-gateway aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-system
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    #cert.gardener.cloud/dnsnames: &#34;*.example.com&#34; # alternative if you want to control the dns names explicitly.
</span></span></span><span style=display:flex><span><span style=color:#a31515>    cert.gardener.cloud/purpose: managed
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  selector:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    istio: ingressgateway # use Istio default gateway implementation
</span></span></span><span style=display:flex><span><span style=color:#a31515>  servers:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      number: 443
</span></span></span><span style=display:flex><span><span style=color:#a31515>      name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>      protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - &#34;httpbin.example.com&#34; # this is used by the dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>    tls:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      credentialName: my-tls-secret
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>You should now see a created <code>Certificate</code> resource similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system get cert -oyaml
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>items:
</span></span><span style=display:flex><span>- apiVersion: cert.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>  kind: Certificate
</span></span><span style=display:flex><span>  metadata:
</span></span><span style=display:flex><span>    generateName: httpbin-gateway-gateway-
</span></span><span style=display:flex><span>    name: httpbin-gateway-gateway-hdbjb
</span></span><span style=display:flex><span>    namespace: istio-system
</span></span><span style=display:flex><span>    ownerReferences:
</span></span><span style=display:flex><span>    - apiVersion: networking.istio.io/v1
</span></span><span style=display:flex><span>      blockOwnerDeletion: true
</span></span><span style=display:flex><span>      controller: true
</span></span><span style=display:flex><span>      kind: Gateway
</span></span><span style=display:flex><span>      name: httpbin-gateway
</span></span><span style=display:flex><span>  spec:
</span></span><span style=display:flex><span>    commonName: httpbin.example.com
</span></span><span style=display:flex><span>    secretName: my-tls-secret
</span></span><span style=display:flex><span>  status:
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>kind: List
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  resourceVersion: <span style=color:#a31515>&#34;&#34;</span>
</span></span></code></pre></div><h3 id=using-a-virtualservice-as-a-source>Using a VirtualService as a source<a class=td-heading-self-link href=#using-a-virtualservice-as-a-source aria-label="Heading self-link"></a></h3><p>If the <code>Gateway</code> resource is annotated with <code>cert.gardener.cloud/purpose: managed</code>,
hosts from all referencing <code>VirtualServices</code> resources are automatically extracted.
These resources don&rsquo;t need an additional annotation.</p><h4 id=create-an-istio-gateway-1>Create an Istio Gateway:<a class=td-heading-self-link href=#create-an-istio-gateway-1 aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-system
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    cert.gardener.cloud/purpose: managed
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  selector:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    istio: ingressgateway # use Istio default gateway implementation
</span></span></span><span style=display:flex><span><span style=color:#a31515>  servers:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      number: 443
</span></span></span><span style=display:flex><span><span style=color:#a31515>      name: https
</span></span></span><span style=display:flex><span><span style=color:#a31515>      protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    tls:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      credentialName: my-tls-secret    
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><h4 id=configure-routes-for-traffic-entering-via-the-gateway>Configure routes for traffic entering via the Gateway:<a class=td-heading-self-link href=#configure-routes-for-traffic-entering-via-the-gateway aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: VirtualService
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default  
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - &#34;httpbin.example.com&#34; # this is used by dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gateways:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - istio-system/httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  http:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - match:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /status
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /delay
</span></span></span><span style=display:flex><span><span style=color:#a31515>    route:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - destination:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>          number: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>        host: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>This should show a similar <code>Certificate</code> resource as above.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4773e80fa0a0952ed75e41786df93e8c>5.2 - DNS services</h1><div class=lead>Gardener extension controller for DNS services for shoot clusters</div><h1 id=gardener-extension-for-dns-serviceshttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for DNS services</a><a class=td-heading-self-link href=#gardener-extension-for-dns-serviceshttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-dns-service><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-dns-service alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-shoot-dns-service-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-shoot-dns-service-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-shoot-dns-service><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-shoot-dns-service alt="Go Report Card"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service. Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>. However, the project has grown to a size where it is very hard to extend, maintain, and test. With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics. This way, we can keep Gardener core clean and independent.</p><h2 id=extension-resources>Extension-Resources<a class=td-heading-self-link href=#extension-resources aria-label="Heading self-link"></a></h2><p>Example extension resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Extension
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: <span style=color:#a31515>&#34;extension-dns-service&#34;</span>
</span></span><span style=display:flex><span>  namespace: shoot--project--abc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: shoot-dns-service
</span></span></code></pre></div><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the kubeconfig to the cluster you want to connect to ready in the <code>./dev/kubeconfig</code> file.
Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-dns-service/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-28d1868bb81c37360bc1080f4bd76d56>5.2.1 - Configuration</h1><h1 id=deployment-of-the-shoot-dns-service-extension>Deployment of the shoot DNS service extension<a class=td-heading-self-link href=#deployment-of-the-shoot-dns-service-extension aria-label="Heading self-link"></a></h1><p><strong>Disclaimer:</strong> This document is NOT a step by step deployment guide for the shoot DNS service extension and only contains some configuration specifics regarding the deployment of different components via the helm charts residing in the shoot DNS service extension <a href=https://github.com/gardener/gardener-extension-shoot-dns-service>repository</a>.</p><h2 id=gardener-extension-admission-shoot-dns-service>gardener-extension-admission-shoot-dns-service<a class=td-heading-self-link href=#gardener-extension-admission-shoot-dns-service aria-label="Heading self-link"></a></h2><h3 id=authentication-against-the-garden-cluster>Authentication against the Garden cluster<a class=td-heading-self-link href=#authentication-against-the-garden-cluster aria-label="Heading self-link"></a></h3><p>There are several authentication possibilities depending on whether or not <a href=https://github.com/gardener/garden-setup#concept-the-virtual-cluster>the concept of Virtual Garden</a> is used.</p><h4 id=virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster>Virtual Garden is not used, i.e., the <code>runtime</code> Garden cluster is also the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster aria-label="Heading self-link"></a></h4><h5 id=automounted-service-account-token>Automounted Service Account Token<a class=td-heading-self-link href=#automounted-service-account-token aria-label="Heading self-link"></a></h5><p>The easiest way to deploy the <code>gardener-extension-admission-shoot-dns-service</code> component will be to not provide <code>kubeconfig</code> at all. This way in-cluster configuration and an automounted service account token will be used. The drawback of this approach is that the automounted token will not be automatically rotated.</p><h5 id=service-account-token-volume-projection>Service Account Token Volume Projection<a class=td-heading-self-link href=#service-account-token-volume-projection aria-label="Heading self-link"></a></h5><p>Another solution will be to use <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>Service Account Token Volume Projection</a> combined with a <code>kubeconfig</code> referencing a token file (see example below).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://default.kubernetes.svc.cluster.local
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: garden
</span></span><span style=display:flex><span>    user: garden
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>current-context: garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div><p>This will allow for automatic rotation of the service account token by the <code>kubelet</code>. The configuration can be achieved by setting both <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.kubeconfig</code> in the respective chart&rsquo;s <code>values.yaml</code> file.</p><h4 id=virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster>Virtual Garden is used, i.e., the <code>runtime</code> Garden cluster is different from the <code>target</code> Garden cluster.<a class=td-heading-self-link href=#virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster aria-label="Heading self-link"></a></h4><h5 id=service-account>Service Account<a class=td-heading-self-link href=#service-account aria-label="Heading self-link"></a></h5><p>The easiest way to setup the authentication will be to create a service account and the respective roles will be bound to this service account in the <code>target</code> cluster. Then use the generated service account token and craft a <code>kubeconfig</code> which will be used by the workload in the <code>runtime</code> cluster. This approach does not provide a solution for the rotation of the service account token. However, this setup can be achieved by setting <code>.Values.global.virtualGarden.enabled: true</code> and following these steps:</p><ol><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Get the service account token and craft the <code>kubeconfig</code>.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><h5 id=client-certificate>Client Certificate<a class=td-heading-self-link href=#client-certificate aria-label="Heading self-link"></a></h5><p>Another solution will be to bind the roles in the <code>target</code> cluster to a <code>User</code> subject instead of a service account and use a client certificate for authentication. This approach does not provide a solution for the client certificate rotation. However, this setup can be achieved by setting both <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>, then following these steps:</p><ol><li>Generate a client certificate for the <code>target</code> cluster for the respective user.</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Craft a <code>kubeconfig</code> using the already generated client certificate.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><h5 id=projected-service-account-token>Projected Service Account Token<a class=td-heading-self-link href=#projected-service-account-token aria-label="Heading self-link"></a></h5><p>This approach requires an already deployed and configured <a href=https://github.com/gardener/oidc-webhook-authenticator>oidc-webhook-authenticator</a> for the <code>target</code> cluster. Also the <code>runtime</code> cluster should be registered as a trusted identity provider in the <code>target</code> cluster. Then projected service accounts tokens from the <code>runtime</code> cluster can be used to authenticate against the <code>target</code> cluster. The needed steps are as follows:</p><ol><li>Deploy <a href=https://github.com/gardener/oidc-webhook-authenticator>OWA</a> and establish the needed trust.</li><li>Set <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>. <strong>Note:</strong> username value will depend on the trust configuration, e.g., <code>&lt;prefix>:system:serviceaccount:&lt;namespace>:&lt;serviceaccount></code></li><li>Set <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.serviceAccountTokenVolumeProjection.audience</code>. <strong>Note:</strong> audience value will depend on the trust configuration, e.g., <code>&lt;cliend-id-from-trust-config></code>.</li><li>Craft a kubeconfig (see example below).</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://virtual-garden.api
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: virtual-garden
</span></span><span style=display:flex><span>    user: virtual-garden
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>current-context: virtual-garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: virtual-garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-12a6b686a7df4d2160d67befee1ebdfa>5.2.2 - Deployment</h1><h1 id=gardener-dns-management-for-shoots>Gardener DNS Management for Shoots<a class=td-heading-self-link href=#gardener-dns-management-for-shoots aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener allows Shoot clusters to request DNS names for Ingresses and Services out of the box.
To support this the gardener must be installed with the <code>shoot-dns-service</code>
extension.
This extension uses the seed&rsquo;s dns management infrastructure to maintain DNS
names for shoot clusters. So, far only the external DNS domain of a shoot
(already used for the kubernetes api server and ingress DNS names) can be used
for managed DNS names.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>To generally enable the DNS management for shoot objects the
<code>shoot-dns-service</code> extension must be registered by providing an
appropriate <a href=https://github.com/gardener/gardener-extension-shoot-dns-service/blob/master/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available
for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots, the registration must set the <em>globallyEnabled</em> flag to <code>true</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - kind: Extension
</span></span><span style=display:flex><span>      type: shoot-dns-service
</span></span><span style=display:flex><span>      globallyEnabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=deployment-of-dns-controller-manager>Deployment of DNS controller manager<a class=td-heading-self-link href=#deployment-of-dns-controller-manager aria-label="Heading self-link"></a></h3><p>If you are using Gardener version >= <code>1.54</code>, please make sure to deploy the DNS controller manager by
adding the <code>dnsControllerManager</code> section to the <code>providerConfig.values</code> section.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerDeployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-dns-service
</span></span><span style=display:flex><span>type: helm
</span></span><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  chart: ...
</span></span><span style=display:flex><span>  values:
</span></span><span style=display:flex><span>    image:
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>    dnsControllerManager:
</span></span><span style=display:flex><span>      image:
</span></span><span style=display:flex><span>        repository: europe-docker.pkg.dev/gardener-project/releases/dns-controller-manager
</span></span><span style=display:flex><span>        tag: v0.16.0
</span></span><span style=display:flex><span>      configuration:
</span></span><span style=display:flex><span>        cacheTtl: 300
</span></span><span style=display:flex><span>        controllers: dnscontrollers,dnssources
</span></span><span style=display:flex><span>        dnsPoolResyncPeriod: 30m
</span></span><span style=display:flex><span>        <span style=color:green>#poolSize: 20</span>
</span></span><span style=display:flex><span>        <span style=color:green>#providersPoolResyncPeriod: 24h</span>
</span></span><span style=display:flex><span>        serverPortHttp: 8080
</span></span><span style=display:flex><span>      createCRDs: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>      deploy: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      replicaCount: 1
</span></span><span style=display:flex><span>      <span style=color:green>#resources:</span>
</span></span><span style=display:flex><span>      <span style=color:green>#  requests:</span>
</span></span><span style=display:flex><span>      <span style=color:green>#    cpu: 50m</span>
</span></span><span style=display:flex><span>      <span style=color:green>#    memory: 500Mi</span>
</span></span><span style=display:flex><span>    dnsProviderManagement:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=providing-base-domains-usable-for-a-shoot>Providing Base Domains usable for a Shoot<a class=td-heading-self-link href=#providing-base-domains-usable-for-a-shoot aria-label="Heading self-link"></a></h3><p>So, far only the external DNS domain of a shoot already used
for the kubernetes api server and ingress DNS names can be used for managed
DNS names. This is either the shoot domain as subdomain of the default domain
configured for the gardener installation, or a dedicated domain with dedicated
access credentials configured for a dedicated shoot via the shoot manifest.</p><p>Alternatively, you can specify <code>DNSProviders</code> and its credentials
<code>Secret</code> directly in the shoot, if this feature is enabled.
By default, <code>DNSProvider</code> replication is disabled, but it can be enabled globally in the <code>ControllerDeployment</code>
or for a shoot cluster in the shoot manifest (details see further below).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerDeployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-dns-service
</span></span><span style=display:flex><span>type: helm
</span></span><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  chart: ...
</span></span><span style=display:flex><span>  values:
</span></span><span style=display:flex><span>    image:
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>    dnsProviderReplication:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>See <a href=https://github.com/gardener/external-dns-management/tree/master/examples>example files (20-* and 30-*)</a>
for details for the various provider types.</p><h3 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h3><p>If the shoot DNS feature is not globally enabled by default (depends on the
extension registration on the garden cluster), it must be enabled per shoot.</p><p>To enable the feature for a shoot, the shoot manifest must explicitly add the
<code>shoot-dns-service</code> extension.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-dns-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h4 id=enabledisable-dns-provider-replication-for-a-shoot>Enable/disable DNS provider replication for a shoot<a class=td-heading-self-link href=#enabledisable-dns-provider-replication-for-a-shoot aria-label="Heading self-link"></a></h4><p>The DNSProvider` replication feature enablement can be overwritten in the
shoot manifest, e.g.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>Kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-dns-service
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        apiVersion: service.dns.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>        kind: DNSConfig
</span></span><span style=display:flex><span>        dnsProviderReplication:
</span></span><span style=display:flex><span>          enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-25999a79f656efd317f31f09d85cb4cf>5.2.3 - DNS Names</h1><h1 id=request-dns-names-in-shoot-clusters>Request DNS Names in Shoot Clusters<a class=td-heading-self-link href=#request-dns-names-in-shoot-clusters aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Within a shoot cluster, it is possible to request DNS records via the following resource types:</p><ul><li><a href=https://kubernetes.io/docs/concepts/services-networking/ingress/>Ingress</a></li><li><a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a></li><li><a href=https://github.com/gardener/external-dns-management/blob/master/README.md#the-model>DNSEntry</a></li></ul><p>It is necessary that the Gardener installation your shoot cluster runs in is equipped with a <code>shoot-dns-service</code> extension. This extension uses the seed&rsquo;s dns management infrastructure to maintain DNS names for shoot clusters. Please ask your Gardener operator if the extension is available in your environment.</p><h2 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h2><p>In some Gardener setups the <code>shoot-dns-service</code> extension is not enabled globally and thus must be configured per shoot cluster. Please adapt the shoot specification by the configuration shown below to activate the extension individually.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-dns-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=before-you-start>Before you start<a class=td-heading-self-link href=#before-you-start aria-label="Heading self-link"></a></h2><p>You should :</p><ul><li>Have created a shoot cluster</li><li>Have created and correctly configured a DNS Provider (Please consult <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_providers/>this page</a> for more information)</li><li>Have a basic understanding of DNS (see link under <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_names/#references>References</a>)</li></ul><p>There are 2 types of DNS that you can use within Kubernetes :</p><ul><li>internal (usually managed by coreDNS)</li><li>external (managed by a public DNS provider).</li></ul><p>This page, and the extension, exclusively works for external DNS handling.</p><p>Gardener allows 2 way of managing your external DNS:</p><ul><li>Manually, which means you are in charge of creating / maintaining your Kubernetes related DNS entries</li><li>Via the Gardener DNS extension</li></ul><h2 id=gardener-dns-extension>Gardener DNS extension<a class=td-heading-self-link href=#gardener-dns-extension aria-label="Heading self-link"></a></h2><p>The managed external DNS records feature of the Gardener clusters makes all this easier. You do not need DNS service provider specific knowledge, and in fact you do not need to leave your cluster at all to achieve that. You simply annotate the Ingress / Service that needs its DNS records managed and it will be automatically created / managed by Gardener.</p><p>Managed external DNS records are supported with the following DNS provider types:</p><ul><li>aws-route53</li><li>azure-dns</li><li>azure-private-dns</li><li>google-clouddns</li><li>openstack-designate</li><li>alicloud-dns</li><li>cloudflare-dns</li></ul><h3 id=request-dns-records-for-ingress-resources>Request DNS records for Ingress resources<a class=td-heading-self-link href=#request-dns-records-for-ingress-resources aria-label="Heading self-link"></a></h3><p>To request a DNS name for <code>Ingress</code>, <code>Service</code> or <code>Gateway</code> (Istio or Gateway API) objects in the shoot cluster it must be annotated with the DNS class <code>garden</code> and an annotation denoting the desired DNS names.</p><p>Example for an annotated Ingress resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>kind: Ingress
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-ingress
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    <span style=color:green># Let Gardener manage external DNS records for this Ingress.</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: special.example.com <span style=color:green># Use &#34;*&#34; to collects domains names from .spec.rules[].host</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;600&#34;</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>    <span style=color:green># If you are delegating the certificate management to Gardener, uncomment the following line</span>
</span></span><span style=display:flex><span>    <span style=color:green>#cert.gardener.cloud/purpose: managed</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  - host: special.example.com
</span></span><span style=display:flex><span>    http:
</span></span><span style=display:flex><span>      paths:
</span></span><span style=display:flex><span>      - pathType: Prefix
</span></span><span style=display:flex><span>        path: <span style=color:#a31515>&#34;/&#34;</span>
</span></span><span style=display:flex><span>        backend:
</span></span><span style=display:flex><span>          service:
</span></span><span style=display:flex><span>            name: amazing-svc
</span></span><span style=display:flex><span>            port:
</span></span><span style=display:flex><span>              number: 8080
</span></span><span style=display:flex><span>  <span style=color:green># Uncomment the following part if you are delegating the certificate management to Gardener</span>
</span></span><span style=display:flex><span>  <span style=color:green>#tls:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#  - hosts:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#      - special.example.com</span>
</span></span><span style=display:flex><span>  <span style=color:green>#    secretName: my-cert-secret-name</span>
</span></span></code></pre></div><p>For an Ingress, the DNS names are already declared in the specification. Nevertheless the <em>dnsnames</em> annotation must be present. Here a subset of the DNS names of the ingress can be specified. If DNS names for all names are desired, the value <code>all</code> can be used.</p><p>Keep in mind that ingress resources are ignored unless an ingress controller is set up. Gardener does not provide an ingress controller by default. For more details, see <a href=https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/>Ingress Controllers</a> and <a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a> in the Kubernetes documentation.</p><h3 id=request-dns-records-for-service-type-loadbalancer>Request DNS records for service type LoadBalancer<a class=td-heading-self-link href=#request-dns-records-for-service-type-loadbalancer aria-label="Heading self-link"></a></h3><p>Example for an annotated Service (it must have the type <code>LoadBalancer</code>) resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: amazing-svc
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    <span style=color:green># Let Gardener manage external DNS records for this Service.</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: special.example.com
</span></span><span style=display:flex><span>    dns.gardener.cloud/ttl: <span style=color:#a31515>&#34;600&#34;</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    app: amazing-app
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>    - protocol: TCP
</span></span><span style=display:flex><span>      port: 80
</span></span><span style=display:flex><span>      targetPort: 8080
</span></span><span style=display:flex><span>  type: LoadBalancer
</span></span></code></pre></div><h3 id=request-dns-records-for-gateway-resources>Request DNS records for Gateway resources<a class=td-heading-self-link href=#request-dns-records-for-gateway-resources aria-label="Heading self-link"></a></h3><p>Please see <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/tutorials/istio-gateways/>Istio Gateways</a> or <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/tutorials/gateway-api-gateways/>Gateway API</a> for details.</p><h3 id=creating-a-dnsentry-resource-explicitly>Creating a DNSEntry resource explicitly<a class=td-heading-self-link href=#creating-a-dnsentry-resource-explicitly aria-label="Heading self-link"></a></h3><p>It is also possible to create a DNS entry via the Kubernetes resource called <code>DNSEntry</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: dns.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: DNSEntry
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    <span style=color:green># Let Gardener manage this DNS entry.</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>  name: special-dnsentry
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  dnsName: special.example.com
</span></span><span style=display:flex><span>  ttl: 600
</span></span><span style=display:flex><span>  targets:
</span></span><span style=display:flex><span>  - 1.2.3.4
</span></span></code></pre></div><p>If one of the accepted DNS names is a direct subname of the shoot&rsquo;s ingress domain, this is already handled by the standard wildcard entry for the ingress domain. Therefore this name should be excluded from the <em>dnsnames</em> list in the annotation. If only this DNS name is configured in the ingress, no explicit DNS entry is required, and the DNS annotations should be omitted at all.</p><p>You can check the status of the <code>DNSEntry</code> with</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get dnsentry
</span></span><span style=display:flex><span>NAME          DNS                                                            TYPE          PROVIDER      STATUS    AGE
</span></span><span style=display:flex><span>mydnsentry    special.example.com     aws-route53   default/aws   Ready     24s
</span></span></code></pre></div><p>As soon as the status of the entry is <code>Ready</code>, the provider has accepted the new DNS record. Depending on the provider and your DNS settings and cache, <strong>it may take up to 24 hours for the new entry to be propagated over all internet</strong>.</p><p>More examples can be found <a href=https://github.com/gardener/external-dns-management/blob/master/examples/>here</a></p><h3 id=request-dns-records-for-serviceingress-resources-using-a-dnsannotation-resource>Request DNS records for Service/Ingress resources using a DNSAnnotation resource<a class=td-heading-self-link href=#request-dns-records-for-serviceingress-resources-using-a-dnsannotation-resource aria-label="Heading self-link"></a></h3><p>In rare cases it may not be possible to add annotations to a <code>Service</code> or <code>Ingress</code> resource object.</p><p>E.g.: the helm chart used to deploy the resource may not be adaptable for some reasons or some automation is used, which always restores the original content of the resource object by dropping any additional annotations.</p><p>In these cases, it is recommended to use an additional <code>DNSAnnotation</code> resource in order to have more flexibility that <code>DNSentry resources</code>. The <code>DNSAnnotation</code> resource makes the DNS shoot service behave as if annotations have been added to the referenced resource.</p><p>For the Ingress example shown above, you can create a <code>DNSAnnotation</code> resource alternatively to provide the annotations.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: dns.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: DNSAnnotation
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>  name: test-ingress-annotation
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resourceRef:
</span></span><span style=display:flex><span>    kind: Ingress
</span></span><span style=display:flex><span>    apiVersion: networking.k8s.io/v1
</span></span><span style=display:flex><span>    name: test-ingress
</span></span><span style=display:flex><span>    namespace: default
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    dns.gardener.cloud/dnsnames: <span style=color:#a31515>&#39;*&#39;</span>
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden    
</span></span></code></pre></div><p>Note that the DNSAnnotation resource itself needs the <code>dns.gardener.cloud/class=garden</code> annotation. This also only works for annotations known to the DNS shoot service (see <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_names/#accepted-external-dns-records-annotations>Accepted External DNS Records Annotations</a>).</p><p>For more details, see also <a href=https://github.com/gardener/external-dns-management#dnsannotation-objects>DNSAnnotation objects</a></p><h3 id=accepted-external-dns-records-annotations>Accepted External DNS Records Annotations<a class=td-heading-self-link href=#accepted-external-dns-records-annotations aria-label="Heading self-link"></a></h3><p>Here are all of the accepted annotation related to the DNS extension:</p><table><thead><tr><th>Annotation</th><th>Description</th></tr></thead><tbody><tr><td>dns.gardener.cloud/dnsnames</td><td>Mandatory for service and ingress resources, accepts a comma-separated list of DNS names if multiple names are required. For ingress you can use the special value <code>'*'</code>. In this case, the DNS names are collected from <code>.spec.rules[].host</code>.</td></tr><tr><td>dns.gardener.cloud/class</td><td>Mandatory, in the context of the shoot-dns-service it must always be set to <code>garden</code>.</td></tr><tr><td>dns.gardener.cloud/ttl</td><td>Recommended, overrides the default Time-To-Live of the DNS record.</td></tr><tr><td>dns.gardener.cloud/cname-lookup-interval</td><td>Only relevant if multiple domain name targets are specified. It specifies the lookup interval for CNAMEs to map them to IP addresses (in seconds)</td></tr><tr><td>dns.gardener.cloud/realms</td><td>Internal, for restricting provider access for shoot DNS entries. Typcially not set by users of the shoot-dns-service.</td></tr><tr><td>dns.gardener.cloud/ip-stack</td><td>Only relevant for provider type <code>aws-route53</code> if target is an AWS load balancer domain name. Can be set for service, ingress and DNSEntry resources. It specify which DNS records with alias targets are created instead of the usual <code>CNAME</code> records. If the annotation is not set (or has the value <code>ipv4</code>), only an <code>A</code> record is created. With value <code>dual-stack</code>, both <code>A</code> and <code>AAAA</code> records are created. With value <code>ipv6</code> only an <code>AAAA</code> record is created.</td></tr><tr><td>service.beta.kubernetes.io/aws-load-balancer-ip-address-type=dualstack</td><td>For services, behaves similar to <code>dns.gardener.cloud/ip-stack=dual-stack</code>.</td></tr><tr><td>loadbalancer.openstack.org/load-balancer-address</td><td>Internal, for services only: support for PROXY protocol on Openstack (which needs a hostname as ingress). Typcially not set by users of the shoot-dns-service.</td></tr></tbody></table><p>If one of the accepted DNS names is a direct subdomain of the shoot&rsquo;s ingress domain, this is already handled by the standard wildcard entry for the ingress domain. Therefore, this name should be excluded from the <em>dnsnames</em> list in the annotation. If only this DNS name is configured in the ingress, no explicit DNS entry is required, and the DNS annotations should be omitted at all.</p><h2 id=troubleshooting>Troubleshooting<a class=td-heading-self-link href=#troubleshooting aria-label="Heading self-link"></a></h2><h3 id=general-dns-tools>General DNS tools<a class=td-heading-self-link href=#general-dns-tools aria-label="Heading self-link"></a></h3><p>To check the DNS resolution, use the <code>nslookup</code> or <code>dig</code> command.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nslookup special.your-domain.com
</span></span></code></pre></div><p>or with dig</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ dig +short special.example.com
</span></span><span style=display:flex><span>Depending on your network settings, you may get a successful response faster using a public DNS server (e.g. 8.8.8.8, 8.8.4.4, or 1.1.1.1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dig @8.8.8.8 +short special.example.com
</span></span></code></pre></div><h3 id=dns-record-events>DNS record events<a class=td-heading-self-link href=#dns-record-events aria-label="Heading self-link"></a></h3><p>The DNS controller publishes Kubernetes events for the resource which requested the DNS record (Ingress, Service, DNSEntry). These events reveal more information about the DNS requests being processed and are especially useful to check any kind of misconfiguration, e.g. requests for a domain you don&rsquo;t own.</p><p>Events for a successfully created DNS record:</p><pre tabindex=0><code>$ kubectl describe service my-service

Events:
  Type    Reason          Age                From                    Message
  ----    ------          ----               ----                    -------
  Normal  dns-annotation  19s                dns-controller-manager  special.example.com: dns entry is pending
  Normal  dns-annotation  19s (x3 over 19s)  dns-controller-manager  special.example.com: dns entry pending: waiting for dns reconciliation
  Normal  dns-annotation  9s (x3 over 10s)   dns-controller-manager  special.example.com: dns entry active
</code></pre><p>Please note, events vanish after their retention period (usually <code>1h</code>).</p><h3 id=dnsentry-status>DNSEntry status<a class=td-heading-self-link href=#dnsentry-status aria-label="Heading self-link"></a></h3><p><code>DNSEntry</code> resources offer a <code>.status</code> sub-resource which can be used to check the current state of the object.</p><p>Status of a erroneous <code>DNSEntry</code>.</p><pre tabindex=0><code>  status:
    message: No responsible provider found
    observedGeneration: 3
    provider: remote
    state: Error
</code></pre><h2 id=references>References<a class=td-heading-self-link href=#references aria-label="Heading self-link"></a></h2><ul><li><a href=https://www.cloudflare.com/en-ca/learning/dns/what-is-dns>Understanding DNS</a></li><li><a href=https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/>Kubernetes Internal DNS</a></li><li><a href=https://github.com/gardener/external-dns-management/blob/master/pkg/apis/dns/v1alpha1/dnsentry.go>DNSEntry API (Golang)</a></li><li><a href=/docs/extensions/others/gardener-extension-shoot-cert-service/request_cert/>Managing Certificates with Gardener</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ecf32a50f50533e421c6d743abdd9ee2>5.2.4 - DNS Providers</h1><h1 id=dns-providers>DNS Providers<a class=td-heading-self-link href=#dns-providers aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener can manage DNS records on your behalf, so that you can request them via different resource types (see <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_names/>here</a>) within the shoot cluster. The domains for which you are permitted to request records, are however restricted and depend on the DNS provider configuration.</p><h2 id=shoot-provider>Shoot provider<a class=td-heading-self-link href=#shoot-provider aria-label="Heading self-link"></a></h2><p>By default, every shoot cluster is equipped with a default provider. It is the very same provider that manages the shoot cluster&rsquo;s <code>kube-apiserver</code> public DNS record (DNS address in your Kubeconfig).</p><pre tabindex=0><code>kind: Shoot
...
dns:
  domain: shoot.project.default-domain.gardener.cloud
</code></pre><p>You are permitted to request any sub-domain of <code>.dns.domain</code> that is not already taken (e.g. <code>api.shoot.project.default-domain.gardener.cloud</code>, <code>*.ingress.shoot.project.default-domain.gardener.cloud</code>) with this provider.</p><h2 id=additional-providers>Additional providers<a class=td-heading-self-link href=#additional-providers aria-label="Heading self-link"></a></h2><p>If you need to request DNS records for domains not managed by the <a href=/docs/extensions/others/gardener-extension-shoot-dns-service/dns_providers/#Shoot-provider>default provider</a>, additional providers can
be configured in the shoot specification.
Alternatively, if it is enabled, it can be added as <code>DNSProvider</code> resources to the shoot cluster.</p><h3 id=additional-providers-in-the-shoot-specification>Additional providers in the shoot specification<a class=td-heading-self-link href=#additional-providers-in-the-shoot-specification aria-label="Heading self-link"></a></h3><p>To add a providers in the shoot spec, you need set them in the <code>spec.dns.providers</code> list.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  dns:
</span></span><span style=display:flex><span>    domain: shoot.project.default-domain.gardener.cloud
</span></span><span style=display:flex><span>    providers:
</span></span><span style=display:flex><span>    - secretName: my-aws-account
</span></span><span style=display:flex><span>      type: aws-route53
</span></span><span style=display:flex><span>    - secretName: my-gcp-account
</span></span><span style=display:flex><span>      type: google-clouddns
</span></span></code></pre></div><blockquote><p>Please consult the <a href=https://gardener.cloud/docs/gardener/api-reference/core/#core.gardener.cloud/v1beta1.DNSProvider>API-Reference</a> to get a complete list of supported fields and configuration options.</p></blockquote><p>Referenced secrets should exist in the project namespace in the Garden cluster and must comply with the provider specific credentials format. The <strong>External-DNS-Management</strong> project provides corresponding examples (<a href=https://github.com/gardener/external-dns-management/tree/master/examples>20-secret-&lt;provider-name>-credentials.yaml</a>) for known providers.</p><h3 id=additional-providers-as-resources-in-the-shoot-cluster>Additional providers as resources in the shoot cluster<a class=td-heading-self-link href=#additional-providers-as-resources-in-the-shoot-cluster aria-label="Heading self-link"></a></h3><p>If it is not enabled globally, you have to enable the feature in the shoot manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>Kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-dns-service
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        apiVersion: service.dns.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>        kind: DNSConfig
</span></span><span style=display:flex><span>        dnsProviderReplication:
</span></span><span style=display:flex><span>          enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>To add a provider directly in the shoot cluster, provide a <code>DNSProvider</code> in any namespace together
with <code>Secret</code> containing the credentials.</p><p>For example if the domain is hosted with AWS Route 53 (provider type <code>aws-route53</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: dns.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: DNSProvider
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    dns.gardener.cloud/class: garden
</span></span><span style=display:flex><span>  name: my-own-domain
</span></span><span style=display:flex><span>  namespace: my-namespace
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: aws-route53
</span></span><span style=display:flex><span>  secretRef:
</span></span><span style=display:flex><span>    name: my-own-domain-credentials
</span></span><span style=display:flex><span>  domains:
</span></span><span style=display:flex><span>    include:
</span></span><span style=display:flex><span>    - my.own.domain.com
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: my-own-domain-credentials
</span></span><span style=display:flex><span>  namespace: my-namespace
</span></span><span style=display:flex><span>type: Opaque
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  <span style=color:green># replace &#39;...&#39; with values encoded as base64</span>
</span></span><span style=display:flex><span>  AWS_ACCESS_KEY_ID: ...
</span></span><span style=display:flex><span>  AWS_SECRET_ACCESS_KEY: ...
</span></span></code></pre></div><p>The <strong>External-DNS-Management</strong> project provides examples with more details for <code>DNSProviders</code> (30-provider-&lt;provider-name>.yaml)
and credential <code>Secrets</code> (20-secret-&lt;provider-name>.yaml) at <a href=https://github.com/gardener/external-dns-management/tree/master/examples>https://github.com/gardener/external-dns-management//examples</a>
for all supported provider types.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ea762d41ff072075554bb0c27bbc83d5>5.2.5 - Gateway Api Gateways</h1><h1 id=using-annotated-gateway-api-gateway-andor-httproutes-as-source>Using annotated Gateway API Gateway and/or HTTPRoutes as Source<a class=td-heading-self-link href=#using-annotated-gateway-api-gateway-andor-httproutes-as-source aria-label="Heading self-link"></a></h1><p>This tutorial describes how to use annotated Gateway API resources as source for DNSEntries with the Gardener shoot-dns-service extension.</p><p>The dns-controller-manager supports the resources <code>Gateway</code> and <code>HTTPRoute</code>.</p><h2 id=install-istio-on-your-cluster>Install Istio on your cluster<a class=td-heading-self-link href=#install-istio-on-your-cluster aria-label="Heading self-link"></a></h2><p>Using a new or existing shoot cluster, follow the Istio <a href=https://istio.io/latest/docs/tasks/traffic-management/ingress/gateway-api/>Kubernetes Gateway API</a> to
install the Gateway API and to install Istio.</p><p>These are the typical commands for the Istio installation with the Kubernetes Gateway API:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export KUEBCONFIG=...
</span></span><span style=display:flex><span>curl -L https://istio.io/downloadIstio | sh -
</span></span><span style=display:flex><span>kubectl get crd gateways.gateway.networking.k8s.io &amp;&gt; /dev/null || <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  { kubectl kustomize <span style=color:#a31515>&#34;github.com/kubernetes-sigs/gateway-api/config/crd?ref=v1.0.0&#34;</span> | kubectl apply -f -; }
</span></span><span style=display:flex><span>istioctl install --set profile=minimal -y
</span></span><span style=display:flex><span>kubectl label namespace default istio-injection=enabled
</span></span></code></pre></div><h2 id=verify-that-gateway-source-works>Verify that Gateway Source works<a class=td-heading-self-link href=#verify-that-gateway-source-works aria-label="Heading self-link"></a></h2><h3 id=install-a-sample-service>Install a sample service<a class=td-heading-self-link href=#install-a-sample-service aria-label="Heading self-link"></a></h3><p>With automatic sidecar injection:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/httpbin/httpbin.yaml
</span></span></code></pre></div><h3 id=using-a-gateway-as-a-source>Using a Gateway as a source<a class=td-heading-self-link href=#using-a-gateway-as-a-source aria-label="Heading self-link"></a></h3><p>Deploy the Gateway API configuration including a single exposed route (i.e., /get):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace istio-ingress
</span></span><span style=display:flex><span>kubectl apply -f - <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/dnsnames: &#34;*.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/class: garden
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gatewayClassName: istio
</span></span></span><span style=display:flex><span><span style=color:#a31515>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hostname: &#34;*.example.com&#34;  # this is used by dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>    port: 80
</span></span></span><span style=display:flex><span><span style=color:#a31515>    protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#a31515>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      namespaces:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        from: All
</span></span></span><span style=display:flex><span><span style=color:#a31515>---
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>    namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hostnames: [&#34;httpbin.example.com&#34;]  # this is used by dns-controller-manager to extract DNS names too
</span></span></span><span style=display:flex><span><span style=color:#a31515>  rules:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - path:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#a31515>        value: /get
</span></span></span><span style=display:flex><span><span style=color:#a31515>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>      port: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>You should now see events in the namespace of the gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system get events --sort-by={.metadata.creationTimestamp}
</span></span><span style=display:flex><span>LAST SEEN   TYPE      REASON                 OBJECT                                       MESSAGE
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         service/gateway-istio                      httpbin.example.com: created dns entry object shoot--foo--bar/gateway-istio-service-zpf8n
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         service/gateway-istio                      httpbin.example.com: dns entry pending: waiting <span style=color:#00f>for</span> dns reconciliation
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         service/gateway-istio                      httpbin.example.com: dns entry is pending
</span></span><span style=display:flex><span>36s         Normal    dns-annotation         service/gateway-istio                      httpbin.example.com: dns entry active
</span></span></code></pre></div><h4 id=using-a-httproute-as-a-source>Using a HTTPRoute as a source<a class=td-heading-self-link href=#using-a-httproute-as-a-source aria-label="Heading self-link"></a></h4><p>If the <code>Gateway</code> resource is annotated with <code>dns.gardener.cloud/dnsnames: "*"</code>, hostnames from all referencing <code>HTTPRoute</code> resources
are automatically extracted. These resources don&rsquo;t need an additional annotation.</p><p>Deploy the Gateway API configuration including a single exposed route (i.e., /get):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create namespace istio-ingress
</span></span><span style=display:flex><span>kubectl apply -f - <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/dnsnames: &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/class: garden
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gatewayClassName: istio
</span></span></span><span style=display:flex><span><span style=color:#a31515>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hostname: null  # not set 
</span></span></span><span style=display:flex><span><span style=color:#a31515>    port: 80
</span></span></span><span style=display:flex><span><span style=color:#a31515>    protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#a31515>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      namespaces:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        from: All
</span></span></span><span style=display:flex><span><span style=color:#a31515>---
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - name: gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>    namespace: istio-ingress
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hostnames: [&#34;httpbin.example.com&#34;]  # this is used by dns-controller-manager to extract DNS names too
</span></span></span><span style=display:flex><span><span style=color:#a31515>  rules:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - path:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#a31515>        value: /get
</span></span></span><span style=display:flex><span><span style=color:#a31515>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>      port: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>This should show a similar events as above.</p><h4 id=access-the-sample-service-using-curl>Access the sample service using <code>curl</code><a class=td-heading-self-link href=#access-the-sample-service-using-curl aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I http://httpbin.example.com/get
</span></span><span style=display:flex><span>HTTP/1.1 200 OK
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>date: Tue, 13 Feb 2024 08:09:41 GMT
</span></span><span style=display:flex><span>content-type: application/json
</span></span><span style=display:flex><span>content-length: 701
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>access-control-allow-credentials: true
</span></span><span style=display:flex><span>x-envoy-upstream-service-time: 19
</span></span></code></pre></div><p>Accessing any other URL that has not been explicitly exposed should return an HTTP 404 error:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I http://httpbin.example.com/headers
</span></span><span style=display:flex><span>HTTP/1.1 404 Not Found
</span></span><span style=display:flex><span>date: Tue, 13 Feb 2024 08:09:41 GMT
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>transfer-encoding: chunked
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-003ade58dc4b08afb6f7278172caaaf8>5.2.6 - Istio Gateways</h1><h1 id=using-annotated-istio-gateway-andor-istio-virtual-service-as-source>Using annotated Istio Gateway and/or Istio Virtual Service as Source<a class=td-heading-self-link href=#using-annotated-istio-gateway-andor-istio-virtual-service-as-source aria-label="Heading self-link"></a></h1><p>This tutorial describes how to use annotated Istio Gateway resources as source for DNSEntries with the Gardener shoot-dns-service extension.</p><h2 id=install-istio-on-your-cluster>Install Istio on your cluster<a class=td-heading-self-link href=#install-istio-on-your-cluster aria-label="Heading self-link"></a></h2><p>Using a new or existing shoot cluster, follow the <a href=https://istio.io/latest/docs/setup/getting-started/>Istio Getting Started</a> to download and install Istio.</p><p>These are the typical commands for the istio demo installation</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export KUEBCONFIG=...
</span></span><span style=display:flex><span>curl -L https://istio.io/downloadIstio | sh -
</span></span><span style=display:flex><span>istioctl install --set profile=demo -y
</span></span><span style=display:flex><span>kubectl label namespace default istio-injection=enabled
</span></span></code></pre></div><h2 id=verify-that-istio-gatewayvirtualservice-source-works>Verify that Istio Gateway/VirtualService Source works<a class=td-heading-self-link href=#verify-that-istio-gatewayvirtualservice-source-works aria-label="Heading self-link"></a></h2><h3 id=install-a-sample-service>Install a sample service<a class=td-heading-self-link href=#install-a-sample-service aria-label="Heading self-link"></a></h3><p>With automatic sidecar injection:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/httpbin/httpbin.yaml
</span></span></code></pre></div><h3 id=using-a-gateway-as-a-source>Using a Gateway as a source<a class=td-heading-self-link href=#using-a-gateway-as-a-source aria-label="Heading self-link"></a></h3><h4 id=create-an-istio-gateway>Create an Istio Gateway:<a class=td-heading-self-link href=#create-an-istio-gateway aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-system
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/dnsnames: &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/class: garden
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  selector:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    istio: ingressgateway # use Istio default gateway implementation
</span></span></span><span style=display:flex><span><span style=color:#a31515>  servers:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      number: 80
</span></span></span><span style=display:flex><span><span style=color:#a31515>      name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - &#34;httpbin.example.com&#34; # this is used by the dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><h4 id=configure-routes-for-traffic-entering-via-the-gateway>Configure routes for traffic entering via the Gateway:<a class=td-heading-self-link href=#configure-routes-for-traffic-entering-via-the-gateway aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: VirtualService
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - &#34;httpbin.example.com&#34; # this is also used by the dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gateways:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - istio-system/httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  http:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - match:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /status
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /delay
</span></span></span><span style=display:flex><span><span style=color:#a31515>    route:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - destination:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>          number: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>        host: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>You should now see events in the namespace of the gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system get events --sort-by={.metadata.creationTimestamp}
</span></span><span style=display:flex><span>LAST SEEN   TYPE      REASON                 OBJECT                                       MESSAGE
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         gateway/httpbin-gateway                      httpbin.example.com: created dns entry object shoot--foo--bar/httpbin-gateway-gateway-zpf8n
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         gateway/httpbin-gateway                      httpbin.example.com: dns entry pending: waiting <span style=color:#00f>for</span> dns reconciliation
</span></span><span style=display:flex><span>38s         Normal    dns-annotation         gateway/httpbin-gateway                      httpbin.example.com: dns entry is pending
</span></span><span style=display:flex><span>36s         Normal    dns-annotation         gateway/httpbin-gateway                      httpbin.example.com: dns entry active
</span></span></code></pre></div><h3 id=using-a-virtualservice-as-a-source>Using a VirtualService as a source<a class=td-heading-self-link href=#using-a-virtualservice-as-a-source aria-label="Heading self-link"></a></h3><p>If the <code>Gateway</code> resource is annotated with <code>dns.gardener.cloud/dnsnames: "*"</code>, hosts from all referencing <code>VirtualServices</code> resources
are automatically extracted. These resources don&rsquo;t need an additional annotation.</p><h4 id=create-an-istio-gateway-1>Create an Istio Gateway:<a class=td-heading-self-link href=#create-an-istio-gateway-1 aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: istio-system
</span></span></span><span style=display:flex><span><span style=color:#a31515>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/dnsnames: &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>    dns.gardener.cloud/class: garden
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  selector:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    istio: ingressgateway # use Istio default gateway implementation
</span></span></span><span style=display:flex><span><span style=color:#a31515>  servers:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>      number: 80
</span></span></span><span style=display:flex><span><span style=color:#a31515>      name: http
</span></span></span><span style=display:flex><span><span style=color:#a31515>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#a31515>    hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><h4 id=configure-routes-for-traffic-entering-via-the-gateway-1>Configure routes for traffic entering via the Gateway:<a class=td-heading-self-link href=#configure-routes-for-traffic-entering-via-the-gateway-1 aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#a31515>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: VirtualService
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: default  
</span></span></span><span style=display:flex><span><span style=color:#a31515>spec:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  hosts:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - &#34;httpbin.example.com&#34; # this is used by dns-controller-manager to extract DNS names
</span></span></span><span style=display:flex><span><span style=color:#a31515>  gateways:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - istio-system/httpbin-gateway
</span></span></span><span style=display:flex><span><span style=color:#a31515>  http:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  - match:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /status
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - uri:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        prefix: /delay
</span></span></span><span style=display:flex><span><span style=color:#a31515>    route:
</span></span></span><span style=display:flex><span><span style=color:#a31515>    - destination:
</span></span></span><span style=display:flex><span><span style=color:#a31515>        port:
</span></span></span><span style=display:flex><span><span style=color:#a31515>          number: 8000
</span></span></span><span style=display:flex><span><span style=color:#a31515>        host: httpbin
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>This should show a similar events as above.</p><p>To get the targets to the extracted DNS names, the shoot-dns-service controller is able to gather information from the kubernetes service of the Istio Ingress Gateway.</p><p><strong>Note</strong>: It is also possible to set the targets my specifying an Ingress resource using the <code>dns.gardener.cloud/ingress</code> annotation on the Istio Ingress Gateway resource.</p><p><strong>Note</strong>: It is also possible to set the targets manually by using the <code>dns.gardener.cloud/targets</code> annotation on the Istio Ingress Gateway resource.</p><h3 id=access-the-sample-service-using-curl>Access the sample service using <code>curl</code><a class=td-heading-self-link href=#access-the-sample-service-using-curl aria-label="Heading self-link"></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I http://httpbin.example.com/status/200
</span></span><span style=display:flex><span>HTTP/1.1 200 OK
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>date: Tue, 13 Feb 2024 07:49:37 GMT
</span></span><span style=display:flex><span>content-type: text/html; charset=utf-8
</span></span><span style=display:flex><span>access-control-allow-origin: *
</span></span><span style=display:flex><span>access-control-allow-credentials: true
</span></span><span style=display:flex><span>content-length: 0
</span></span><span style=display:flex><span>x-envoy-upstream-service-time: 15
</span></span></code></pre></div><p>Accessing any other URL that has not been explicitly exposed should return an HTTP 404 error:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -I http://httpbin.example.com/headers
</span></span><span style=display:flex><span>HTTP/1.1 404 Not Found
</span></span><span style=display:flex><span>date: Tue, 13 Feb 2024 08:09:41 GMT
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>transfer-encoding: chunked
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-26c3d61f82c9dd9b0643835430f275f6>5.3 - Egress filtering</h1><div class=lead>Gardener extension controller for egress filtering for shoot clusters</div><h1 id=gardener-extension-for-networking-filterhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Networking Filter</a><a class=td-heading-self-link href=#gardener-extension-for-networking-filterhttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-networking-filter><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-networking-filter alt="REUSE status"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the <code>shoot-networking-filter</code> extension.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-shoot-networking-filter/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=extension-resources>Extension Resources<a class=td-heading-self-link href=#extension-resources aria-label="Heading self-link"></a></h2><p>Example extension resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Extension
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-networking-filter
</span></span><span style=display:flex><span>  namespace: shoot--project--abc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    egressFilter:
</span></span><span style=display:flex><span>      blackholingEnabled: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>      staticFilterList:
</span></span><span style=display:flex><span>      - network: 1.2.3.4/31
</span></span><span style=display:flex><span>        policy: BLOCK_ACCESS
</span></span><span style=display:flex><span>      workers:
</span></span><span style=display:flex><span>        blackholingEnabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        names:
</span></span><span style=display:flex><span>        - external-api
</span></span></code></pre></div><p>When an extension resource is reconciled, if the optional <code>workers</code> field is not used, the extension controller will create a daemonset <code>egress-filter-applier</code> on the shoot containing a <a href=https://github.com/gardener/egress-filter-refresher/blob/master/Dockerfile>Dockerfile</a> container.</p><p>If the optional <code>workers</code> field is used, the extension controller will create one daemonset <code>egress-filter-applier-&lt;worker name></code> per <strong>each worker group</strong> on the shoot.</p><p>See the <a href=/docs/extensions/others/gardener-extension-shoot-networking-filter/shoot-networking-filter/>usage documentation</a> for more details on how to configure the extension on a shoot cluster.</p><p>Please note, this extension controller relies on the <a href=/docs/gardener/concepts/resource-manager/>Gardener-Resource-Manager</a> to deploy k8s resources to seed and shoot clusters.</p><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>.</p><p>We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-networking-filter/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-0d6e87b50dd76f1d75b01b3bb7cc698f>5.3.1 - Deployment</h1><h1 id=gardener-networking-policy-filter-for-shoots>Gardener Networking Policy Filter for Shoots<a class=td-heading-self-link href=#gardener-networking-policy-filter-for-shoots aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener allows shoot clusters to filter egress traffic on node level. To support this the Gardener must be installed with the <code>shoot-networking-filter</code> extension.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>To generally enable the networking filter for shoot objects the <code>shoot-networking-filter</code> extension must be registered by providing an appropriate <a href=https://github.com/gardener/gardener-extension-shoot-networking-filter/blob/master/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots the <code>globallyEnabled</code> flag should be set to <code>true</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerRegistration
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - kind: Extension
</span></span><span style=display:flex><span>      type: shoot-networking-filter
</span></span><span style=display:flex><span>      globallyEnabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=controllerregistration>ControllerRegistration<a class=td-heading-self-link href=#controllerregistration aria-label="Heading self-link"></a></h3><p>An example of a <code>ControllerRegistration</code> for the <code>shoot-networking-filter</code> can be found at <a href=https://github.com/gardener/gardener-extension-shoot-networking-filter/blob/master/example/controller-registration.yaml>controller-registration.yaml</a>.</p><p>The <code>ControllerRegistration</code> contains a Helm chart which eventually deploys the <code>shoot-networking-filter</code> to seed clusters. It offers some configuration options, mainly to set up a static filter list or provide the configuration for downloading the filter list from a service endpoint.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerDeployment
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  values:
</span></span><span style=display:flex><span>    egressFilter:
</span></span><span style=display:flex><span>      blackholingEnabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      filterListProviderType: static
</span></span><span style=display:flex><span>      staticFilterList:
</span></span><span style=display:flex><span>        - network: 1.2.3.4/31
</span></span><span style=display:flex><span>          policy: BLOCK_ACCESS
</span></span><span style=display:flex><span>        - network: 5.6.7.8/32
</span></span><span style=display:flex><span>          policy: BLOCK_ACCESS
</span></span><span style=display:flex><span>        - network: ::2/128
</span></span><span style=display:flex><span>          policy: BLOCK_ACCESS
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:green>#filterListProviderType: download</span>
</span></span><span style=display:flex><span>      <span style=color:green>#downloaderConfig:</span>
</span></span><span style=display:flex><span>      <span style=color:green>#  endpoint: https://my.filter.list.server/lists/policy</span>
</span></span><span style=display:flex><span>      <span style=color:green>#  oauth2Endpoint: https://my.auth.server/oauth2/token</span>
</span></span><span style=display:flex><span>      <span style=color:green>#  refreshPeriod: 1h</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:green>## if the downloader needs an OAuth2 access token, client credentials can be provided with oauth2Secret</span>
</span></span><span style=display:flex><span>      <span style=color:green>#oauth2Secret:</span>
</span></span><span style=display:flex><span>      <span style=color:green># clientID: 1-2-3-4</span>
</span></span><span style=display:flex><span>      <span style=color:green># clientSecret: secret!!</span>
</span></span><span style=display:flex><span>      <span style=color:green>## either clientSecret of client certificate is required</span>
</span></span><span style=display:flex><span>      <span style=color:green># client.crt.pem: |</span>
</span></span><span style=display:flex><span>      <span style=color:green>#   -----BEGIN CERTIFICATE-----</span>
</span></span><span style=display:flex><span>      <span style=color:green>#   ...</span>
</span></span><span style=display:flex><span>      <span style=color:green>#   -----END CERTIFICATE-----</span>
</span></span><span style=display:flex><span>      <span style=color:green># client.key.pem: |</span>
</span></span><span style=display:flex><span>      <span style=color:green>#   -----BEGIN PRIVATE KEY-----</span>
</span></span><span style=display:flex><span>      <span style=color:green>#   ...</span>
</span></span><span style=display:flex><span>      <span style=color:green>#   -----END PRIVATE KEY-----</span>
</span></span></code></pre></div><h3 id=enablement-for-a-shoot>Enablement for a Shoot<a class=td-heading-self-link href=#enablement-for-a-shoot aria-label="Heading self-link"></a></h3><p>If the shoot networking filter is not globally enabled by default (depends on the extension registration on the garden cluster), it can be enabled per shoot. To enable the service for a shoot, the shoot manifest must explicitly add the <code>shoot-networking-filter</code> extension.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-filter
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>If the shoot networking filter is globally enabled by default, it can be disabled per shoot. To disable the service for a shoot, the shoot manifest must explicitly state it.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-filter
</span></span><span style=display:flex><span>      disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-51bc5860c666351f02b783c6f9331d81>5.3.2 - Shoot Networking Filter</h1><h1 id=register-shoot-networking-filter-extension-in-shoot-clusters>Register Shoot Networking Filter Extension in Shoot Clusters<a class=td-heading-self-link href=#register-shoot-networking-filter-extension-in-shoot-clusters aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Within a shoot cluster, it is possible to enable the networking filter. It is necessary that the Gardener installation your shoot cluster runs in is equipped with a <code>shoot-networking-filter</code> extension. Please ask your Gardener operator if the extension is available in your environment.</p><h2 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h2><p>In most of the Gardener setups the <code>shoot-networking-filter</code> extension is not enabled globally and thus must be configured per shoot cluster. Please adapt the shoot specification by the configuration shown below to activate the extension individually.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-filter
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=opt-out>Opt-out<a class=td-heading-self-link href=#opt-out aria-label="Heading self-link"></a></h2><p>If the shoot networking filter is globally enabled by default, it can be disabled per shoot. To disable the service for a shoot, the shoot manifest must explicitly state it.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-filter
</span></span><span style=display:flex><span>      disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=ingress-filtering>Ingress Filtering<a class=td-heading-self-link href=#ingress-filtering aria-label="Heading self-link"></a></h2><p>By default, the networking filter only filters egress traffic. However, if you enable blackholing, incoming traffic will also be blocked.
You can enable blackholing on a per-shoot basis.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-filter
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        egressFilter:
</span></span><span style=display:flex><span>          blackholingEnabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Ingress traffic can only be blocked by blackhole routing, if the source IP address is preserved. On Azure, GCP and AliCloud this works by default.
The default on AWS is a classic load balancer that replaces the source IP by it&rsquo;s own IP address. Here, a network load balancer has to be
configured adding the annotation <code>service.beta.kubernetes.io/aws-load-balancer-type: "nlb"</code> to the service.
On OpenStack, load balancers don&rsquo;t preserve the source address.</p><p>When you disable <code>blackholing</code> in an existing shoot, the associated blackhole routes will be removed automatically.
Conversely, when you re-enable <code>blackholing</code> again, the iptables-based filter rules will be removed and replaced by blackhole routes.</p><h2 id=ingress-filtering-per-worker-group>Ingress Filtering per Worker Group<a class=td-heading-self-link href=#ingress-filtering-per-worker-group aria-label="Heading self-link"></a></h2><p>You can optionally enable or disable ingress filtering for specified worker groups.
For example, you may want to disable blackholing in general but enable it for a worker group hosting an external API.
You can do so by using an optional <code>workers</code> field:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-filter
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        egressFilter:
</span></span><span style=display:flex><span>          blackholingEnabled: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>          workers:
</span></span><span style=display:flex><span>            blackholingEnabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>            names:
</span></span><span style=display:flex><span>              - external-api
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Please note that only blackholing can be changed per worker group. You may not define different IPs to block or
disable blocking altogether.</p><h2 id=custom-ip>Custom IP<a class=td-heading-self-link href=#custom-ip aria-label="Heading self-link"></a></h2><p>It is possible to add custom IP addresses to the network filter. This can be useful for testing purposes.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-filter
</span></span><span style=display:flex><span>      providerConfig:
</span></span><span style=display:flex><span>        egressFilter:
</span></span><span style=display:flex><span>          staticFilterList:
</span></span><span style=display:flex><span>          - network: 1.2.3.4/31
</span></span><span style=display:flex><span>            policy: BLOCK_ACCESS
</span></span><span style=display:flex><span>          - network: 5.6.7.8/32
</span></span><span style=display:flex><span>            policy: BLOCK_ACCESS
</span></span><span style=display:flex><span>          - network: ::2/128
</span></span><span style=display:flex><span>            policy: BLOCK_ACCESS
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ccc7f4f683b2c7803e99873d2bc4a42a>5.4 - Lakom service</h1><div class=lead>A k8s admission controller verifying pods are using signed images (cosign signatures) and a gardener extension to install it for shoots and seeds.</div><h1 id=gardener-extension-for-lakom-serviceshttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for lakom services</a><a class=td-heading-self-link href=#gardener-extension-for-lakom-serviceshttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-lakom-service><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-lakom-service alt="REUSE status"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the <code>shoot-lakom-service</code> extension.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-shoot-lakom-service/blob/main/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=lakom-admission-controller>Lakom Admission Controller<a class=td-heading-self-link href=#lakom-admission-controller aria-label="Heading self-link"></a></h2><p>Lakom is kubernetes admission controller which purpose is to implement <a href=https://github.com/sigstore/cosign>cosign</a> image signature verification against public cosign key. It also takes care to resolve image tags to sha256 digests. It also caches all OCI artifacts to reduce the load toward the OCI registry.</p><h2 id=extension-resources>Extension Resources<a class=td-heading-self-link href=#extension-resources aria-label="Heading self-link"></a></h2><p>Example extension resource:</p><blockquote></blockquote><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Extension
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-lakom-service
</span></span><span style=display:flex><span>  namespace: shoot--project--abc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: shoot-lakom-service
</span></span></code></pre></div><p>When an extension resource is reconciled, the extension controller will create an instance of <code>lakom</code> admission controller. These resources are placed inside the shoot namespace on the seed. Also, the controller takes care about generating necessary <code>RBAC</code> resources for the seed as well as for the shoot.</p><p>Please note, this extension controller relies on the <a href=/docs/gardener/concepts/resource-manager/>Gardener-Resource-Manager</a> to deploy k8s resources to seed and shoot clusters.</p><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>The <code>Lakom</code> admission controller can be configured with <code>make dev-setup</code> and started with <code>make start-lakom</code>.
You can run the lakom extension controller locally on your machine by executing <code>make start</code>.</p><p>If you&rsquo;d like to develop Lakom using a local cluster such as KinD, make sure your KUBECONFIG environment variable is targeting the local Garden cluster.
Add <code>127.0.0.1 garden.local.gardener.cloud</code> to your <code>/etc/hosts</code>. You can then run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-up
</span></span></code></pre></div><p>This will trigger a skaffold deployment that builds the images, pushes them to the registry and installs the helm charts from <code>/charts</code>.</p><p>We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-lakom-service/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c0e9837a0c6f3e6821df938a89b541e1>5.4.1 - Deployment</h1><h1 id=gardener-lakom-service-for-shoots>Gardener Lakom Service for Shoots<a class=td-heading-self-link href=#gardener-lakom-service-for-shoots aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener allows Shoot clusters to use <code>Lakom</code> admission controller for cosign image signing verification. To support this the Gardener must be installed with the <code>shoot-lakom-service</code> extension.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>To generally enable the Lakom service for shoot objects the <code>shoot-lakom-service</code> extension must be registered by providing an appropriate <a href=https://github.com/gardener/gardener-extension-shoot-lakom-service/blob/main/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots the <code>globallyEnabled</code> flag should be set to <code>true</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - kind: Extension
</span></span><span style=display:flex><span>      type: shoot-lakom-service
</span></span><span style=display:flex><span>      globallyEnabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h3><p>If the shoot Lakom service is not globally enabled by default (depends on the extension registration on the garden cluster), it can be enabled per shoot. To enable the service for a shoot, the shoot manifest must explicitly add the <code>shoot-lakom-service</code> extension.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-lakom-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>If the shoot Lakom service is globally enabled by default, it can be disabled per shoot. To disable the service for a shoot, the shoot manifest must explicitly state it.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-lakom-service
</span></span><span style=display:flex><span>      disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-baad6af6b7a83fa2c3b395ecc1578177>5.4.2 - Lakom</h1><h1 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h1><p>Lakom is kubernetes admission controller which purpose is to implement
<a href=https://github.com/sigstore/cosign>cosign</a> image signature verification with
public cosign key. It also takes care to resolve image tags to sha256 digests. A
built-in cache mechanism can be enabled to reduce the load toward the OCI
registry.</p><h2 id=flags>Flags<a class=td-heading-self-link href=#flags aria-label="Heading self-link"></a></h2><p>Lakom admission controller is configurable via command line flags. The trusted
cosign public keys and the associated algorithms associated with them are set
viq configuration file provided with the flag <code>--lakom-config-path</code>.</p><table><thead><tr><th>Flag Name</th><th>Description</th><th>Default Value</th></tr></thead><tbody><tr><td><code>--bind-address</code></td><td>Address to bind to</td><td>&ldquo;0.0.0.0&rdquo;</td></tr><tr><td><code>--cache-refresh-interval</code></td><td>Refresh interval for the cached objects</td><td>30s</td></tr><tr><td><code>--cache-ttl</code></td><td>TTL for the cached objects. Set to 0, if cache has to be disabled</td><td>10m0s</td></tr><tr><td><code>--contention-profiling</code></td><td>Enable lock contention profiling, if profiling is enabled</td><td>false</td></tr><tr><td><code>--health-bind-address</code></td><td>Bind address for the health server</td><td>&ldquo;:8081&rdquo;</td></tr><tr><td><code>-h</code>, <code>--help</code></td><td>help for lakom</td><td></td></tr><tr><td><code>--insecure-allow-insecure-registries</code></td><td>If set, communication via HTTP with registries will be allowed.</td><td>false</td></tr><tr><td><code>--insecure-allow-untrusted-images</code></td><td>If set, the webhook will just return warning for the images without trusted signatures.</td><td>false</td></tr><tr><td><code>--kubeconfig</code></td><td>Paths to a kubeconfig. Only required if out-of-cluster.</td><td></td></tr><tr><td><code>--lakom-config-path</code></td><td>Path to file with lakom configuration containing cosign public keys used to verify the image signatures</td><td></td></tr><tr><td><code>--metrics-bind-address</code></td><td>Bind address for the metrics server</td><td>&ldquo;:8080&rdquo;</td></tr><tr><td><code>--port</code></td><td>Webhook server port</td><td>9443</td></tr><tr><td><code>--profiling</code></td><td>Enable profiling via web interface host:port/debug/pprof/</td><td>false</td></tr><tr><td><code>--tls-cert-dir</code></td><td>Directory with server TLS certificate and key (must contain a tls.crt and tls.key file</td><td></td></tr><tr><td><code>--use-only-image-pull-secrets</code></td><td>If set, only the credentials from the image pull secrets of the pod are used to access the OCI registry. Otherwise, the node identity and docker config are also used.</td><td>false</td></tr><tr><td><code>--version</code></td><td>prints version information and quits; &ndash;version=vX.Y.Z&mldr; sets the reported version</td><td></td></tr></tbody></table><h2 id=lakom-cosign-public-keys-configuration-file>Lakom Cosign Public Keys Configuration File<a class=td-heading-self-link href=#lakom-cosign-public-keys-configuration-file aria-label="Heading self-link"></a></h2><p>Lakom cosign public keys configuration file should be YAML or JSON formatted. It
can set multiple trusted keys, as each key must be given a name. The supported
types of public keys are <code>RSA</code>, <code>ECDSA</code> and <code>Ed25519</code>. The <code>RSA</code> keys can be
additionally configured with a signature verification algorithm specifying the
scheme and hash function used during signature verification. As of now <code>ECDSA</code>
and <code>Ed25519</code> keys cannot be configured with specific algorithm.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>publicKeys:
</span></span><span style=display:flex><span>- name: example-public-key
</span></span><span style=display:flex><span>  algorithm: RSASSA-PSS-SHA256
</span></span><span style=display:flex><span>  key: |-<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----BEGIN PUBLIC KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>    MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAPeQXbIWMMXYV+9+j9b4jXTflnpfwn4E
</span></span></span><span style=display:flex><span><span style=color:#a31515>    GMrmqYVhm0sclXb2FPP5aV/NFH6SZdHDZcT8LCNsNgxzxV4N+UE/JIsCAwEAAQ==
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----END PUBLIC KEY-----</span>    
</span></span></code></pre></div><p>Here:</p><ul><li><code>name</code> is logical human friendly name of the key.</li><li><code>algorithm</code> is the algorithm that has to be used to verify the signature, see <a href=/docs/extensions/others/gardener-extension-shoot-lakom-service/lakom/#supported-rsa-signature-verification-algorithms>Supported RSA Signature Verification Algorithms</a> for the list of supported algorithms.</li><li><code>key</code> is the cryptographic public key that will be used for image signature validation.</li></ul><h3 id=supported-rsa-signature-verification-algorithms>Supported RSA Signature Verification Algorithms<a class=td-heading-self-link href=#supported-rsa-signature-verification-algorithms aria-label="Heading self-link"></a></h3><ul><li><code>RSASSA-PKCS1-v1_5-SHA256</code>: uses <code>RSASSA-PKCS1-v1_5</code> scheme with <code>SHA256</code> hash func</li><li><code>RSASSA-PKCS1-v1_5-SHA384</code>: uses <code>RSASSA-PKCS1-v1_5</code> scheme with <code>SHA384</code> hash func</li><li><code>RSASSA-PKCS1-v1_5-SHA512</code>: uses <code>RSASSA-PKCS1-v1_5</code> scheme with <code>SHA512</code> hash func</li><li><code>RSASSA-PSS-SHA256</code>: uses <code>RSASSA-PSS</code> scheme with <code>SHA256</code> hash func</li><li><code>RSASSA-PSS-SHA384</code>: uses <code>RSASSA-PSS</code> scheme with <code>SHA384</code> hash func</li><li><code>RSASSA-PSS-SHA512</code>: uses <code>RSASSA-PSS</code> scheme with <code>SHA512</code> hash func</li></ul><h3 id=supported-resources-for-verification>Supported Resources for Verification<a class=td-heading-self-link href=#supported-resources-for-verification aria-label="Heading self-link"></a></h3><p>By default, Lakom validates only <code>Pod</code> resources in the clusters that it covers.
However, it also has the capabilities to validate the following Gardener specific resources:</p><ul><li><code>controllerdeployments.core.gardener.cloud/v1</code></li><li><code>gardenlets.seedmanagement.gardener.cloud/v1alpha1</code></li><li><code>extensions.operator.gardener.cloud/v1alpha1</code></li></ul><blockquote class="alert alert-important"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>message-outline</title><path d="M20 2H4C2.9 2 2 2.9 2 4V22l4-4H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2m0 14H5.2L4 17.2V4H20V16z"/></svg><p>Important</p></div><p>When deploying Lakom via the helm chart in <code>/charts/lakom</code>, the <code>admissionConfig.rules</code> key
can be fully customized to include any of the listed resources above.
Make sure that they are registered with the same group & versions as the ones listed above.
Any difference will cause Lakom to skip validation and approve the request,
making it a security risk.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-8acb7c19c8c9dff4f5cb1f6e453dc1dd>5.4.3 - Oci Registries</h1><h1 id=oci-registries>OCI Registries<a class=td-heading-self-link href=#oci-registries aria-label="Heading self-link"></a></h1><p>This document aims to introduce the reader to the general architecture of OCI
Registries, their history and jargon that might be encountered.</p><h2 id=history-of-container-registries>History of Container Registries<a class=td-heading-self-link href=#history-of-container-registries aria-label="Heading self-link"></a></h2><p>Most readers might be familiar with the container registry that was introduced
by Docker. It aims to provide a way for developers to store and distribute
container images that can be used for running applications in containers.</p><p>In the beginning, the registry was meant to only host images in a way that the
different layers of the image could be downloaded in parallel, while being
assembled on the client side.</p><p>In June 2015, multiple companies agreed to standardize the container image format,
including its distribution and runtime. This was the birth of the Open Container
Initiative (OCI).</p><h2 id=understanding-oci-registries>Understanding OCI Registries<a class=td-heading-self-link href=#understanding-oci-registries aria-label="Heading self-link"></a></h2><p>The most important document that pertains to OCI Registries in the case of Lakom is the <a href=https://github.com/opencontainers/distribution-spec/blob/main/spec.md>OCI
distribution spec</a>.
It outlines the way that artifacts shall be stored and fetched from a registry
that adheres to the OCI standard.</p><p>OCI Registries are meant to store <em>content</em>. While in the beginning the main
problem that they were trying to solve was image storage, during the evolution
of the image registry concept, a decision was made to make it more general
for storage of any form of objects, sometimes called <em>artifacts</em>.</p><p>An artifact is an abstract idea of multiple components that together describe
how an object is built along with storing metadata about the object.</p><p>To implement this, every OCI registry has to expose an API for creating
3 types of objects:</p><ul><li>Blobs</li><li>Manifests</li><li>Tags</li></ul><h3 id=blobs>Blobs<a class=td-heading-self-link href=#blobs aria-label="Heading self-link"></a></h3><p>A blob is just a set of bytes. Nothing more. The important part about blobs
is that they are <em>content addressable</em>. <a href=https://en.wikipedia.org/wiki/Content-addressable_storage>Content Addressable Storage (CAS)</a>
is a method of storing data in such a way that the address of the data is derived
from the data itself. This means that if you store the same blob twice, it will
be stored only once, and the address of the blob will be the same. This is achieved
by using the <a href=https://en.wikipedia.org/wiki/Cryptographic_hash_function>digest</a> of the blob as the address.</p><p>This is the actual mechanism for allowing images to be optimal in terms of storage.
Since most images begin by depending on the same base image, this means that
it can be stored only once and referenced by multiple images.</p><h3 id=manifests>Manifests<a class=td-heading-self-link href=#manifests aria-label="Heading self-link"></a></h3><p>A manifest is just a JSON document. It is stored separately from the blobs.
But similarly to the blobs, it is also content addressable. The manifest gets
formatted to a canonical form and then hashed. The hash becomes the address of
the manifest.</p><p>Where manifests become powerful is when they are used to reference to other
manifests or blobs. These references are called <a href=https://github.com/opencontainers/image-spec/blob/v1.0.1/descriptor.md>OCI Content Descriptors</a>.
For example, the Image Manifest that most readers would be familiar with contains
a list of layers that are used to build the image. Each layer is a reference to
a blob.</p><p>An additional reference outside the layer references is used for storing
additional configuration. More info can be found in the official <a href=https://github.com/opencontainers/image-spec/blob/v1.0.1/manifest.md>OCI Image Manifest spec</a>.</p><p>The term <em>artifact</em> is just a generalization over the Image Manifest idea.
The Image Manifest has a specific format that can be found in the aforementioned <a href=https://github.com/opencontainers/image-spec/blob/v1.0.1/manifest.md>OCI Image Manifest spec</a>.
The important field is the <code>.config.mediaType</code> field. Based on the official guidelines,
it can be used for defining types other than an image. More info can be found <a href=https://github.com/opencontainers/image-spec/blob/main/manifest.md#guidelines-for-artifact-usage>here</a>.</p><p>Combining all of these ideas, we can see that artifacts can be represented by 1
specific object - a manifest. That manifest, based on the media type in the config, can be
interpreted by different programs for their specific use case. Eg. a Helm chart.
Helm charts specifically have a mediaType of <code>application/vnd.cncf.helm.config.v1+json</code>.
Layers, too, have a media type. The media type of a layer when the artifact
is a helm chart is one of:</p><ul><li>application/vnd.cncf.helm.config.v1+json</li><li>application/vnd.cncf.helm.chart.content.v1.tar+gzip</li><li>application/vnd.cncf.helm.chart.provenance.v1.prov</li></ul><p>More info specifically on Helm charts as OCI Artifacts can be found here: <a href=https://helm.sh/blog/helm-oci-mediatypes/>Helm OCI MediaTypes</a>.</p><h3 id=tags>Tags<a class=td-heading-self-link href=#tags aria-label="Heading self-link"></a></h3><p>While manifests and blobs being content addressable is nice, it becomes hard
to address them in a human-readable format. Tags allow us to add a reference
to a given manifest that differs from the digest of the object.</p><p>Normally, whenever we push an image to a registry, if we don&rsquo;t give it an
explicit tag, the registry would most likely give it the tag <code>latest</code>. This,
actually is not mandatory based on the distribution spec. Manifests don&rsquo;t
require that they have a tag.</p><p>Multiple tags can point to the same manifest.</p><h3 id=cosign>Cosign<a class=td-heading-self-link href=#cosign aria-label="Heading self-link"></a></h3><p>Cosign is generally a part of the bigger project called <a href=https://sigstore.dev/>sigstore</a>.
Sigstore is an &ldquo;open-source project for improving software supply chain security&rdquo;.
It aims for developers to have a hassle-free way to sign their artifacts while
leveraging other components that add additional layers of security to the
signature process. Eg. Rekor and Fulcio.</p><p>Cosign is a CLI tool aiming to tie all the components of sigstore together.
In our specific case, we use it only as a format for creating signatures and
then verifying them. In theory, we wouldn&rsquo;t need to use Cosign for this, but
it uses a popular format for the signatures and the libraries help us
save work.</p><p>In the context of Lakom, what interests us is how Cosign signs OCI artifacts
and how it stores them.
The signing process in a nutshell is the following &ndash; <code>Sign(sha256(SimpleSigningPayload(sha256(Image Manifest))))</code>, where:</p><ul><li>Image Manifest is what it says. Just the manifest of the image (artifact).</li><li>sha256 is the hashing algorithm used.</li><li>SimpleSigningPayload is the interesting part here. Instead of just signing the
hash of the manifest itself, the hash itself is packed into a JSON doc that
is called the <code>SimpleSigningPayload</code>. Example payload:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    &#34;critical&#34;: {
</span></span><span style=display:flex><span>           &#34;identity&#34;: {
</span></span><span style=display:flex><span>               &#34;docker-reference&#34;: <span style=color:#a31515>&#34;testing/manifest&#34;</span>
</span></span><span style=display:flex><span>           },
</span></span><span style=display:flex><span>           &#34;image&#34;: {
</span></span><span style=display:flex><span>               &#34;Docker-manifest-digest&#34;: <span style=color:#a31515>&#34;sha256:20be...fe55&#34;</span>
</span></span><span style=display:flex><span>           },
</span></span><span style=display:flex><span>           &#34;type&#34;: <span style=color:#a31515>&#34;cosign container image signature&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    &#34;optional&#34;: {
</span></span><span style=display:flex><span>           &#34;creator&#34;: <span style=color:#a31515>&#34;atomic&#34;</span>,
</span></span><span style=display:flex><span>           &#34;timestamp&#34;: 1458239713
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can see that the hash of the manifest is stored in the <code>Docker-manifest-digest</code>.
Now this object is the one that gets signed using our private key. The signed
version of this objest is the one that gets stored and gets used for
verification.</p><p>Storage of the signature is done via an image manifest that gets uploaded
in the same repo as the image, but tagged with <code>sha256-&lt;container-image-digest>.sig</code>.
Thus, the signature discovery mechanism is to just fetch the image digest
that is tagged with the aforementioned tag.</p><p>More info on this whole process can be found <a href=https://github.com/sigstore/cosign/blob/main/specs/SIGNATURE_SPEC.md>here</a>.</p><p>Lakom relies on the cosign libraries to automate this whole process. When
validating an artifact, if we know its digest, we can fetch the signature and
verify it. If the signature is valid, we can be sure that the artifact has not
been tampered with.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f2dfab902de56f28952cebcd9108225f>5.4.4 - Shoot Extension</h1><h1 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h1><p>This extension implements <a href=https://github.com/sigstore/cosign>cosign</a> image verification. It is strictly limited only to the kubernetes system components deployed by Gardener and other Gardener Extensions in the <code>kube-system</code> namespace of a shoot cluster.</p><h2 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h2><p>In most of the Gardener setups the <code>shoot-lakom-service</code> extension is enabled globally and thus can be configured per shoot cluster. Please adapt the shoot specification by the configuration shown below to disable the extension individually.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - name: lakom-ref
</span></span><span style=display:flex><span>    resourceRef:
</span></span><span style=display:flex><span>      apiVersion: v1
</span></span><span style=display:flex><span>      kind: Secret
</span></span><span style=display:flex><span>      name: lakom-secret
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-lakom-service
</span></span><span style=display:flex><span>    disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: lakom.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: LakomConfig
</span></span><span style=display:flex><span>      scope: KubeSystem
</span></span><span style=display:flex><span>      trustedKeysResourceName: lakom-ref
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h3 id=scope>Scope<a class=td-heading-self-link href=#scope aria-label="Heading self-link"></a></h3><p>The <code>scope</code> field instruct lakom which pods to validate. The possible values are:</p><ul><li><code>KubeSystem</code>
Lakom will validate all pods in the <code>kube-system</code> namespace.</li><li><code>KubeSystemManagedByGardener</code>
Lakom will validate all pods in the <code>kube-system</code> namespace that are annotated with &ldquo;managed-by/gardener&rdquo;. This is the default value.</li><li><code>Cluster</code>
Lakom will validate all pods in all namespaces.</li></ul><h3 id=trustedkeysresourcename>TrustedKeysResourceName<a class=td-heading-self-link href=#trustedkeysresourcename aria-label="Heading self-link"></a></h3><p>Lakom, by default, tries to verify only workloads that belong to Gardener. Because of this, the only public keys that it uses to do its job are the ones for the Gardener workload.</p><p>If you&rsquo;d like to use Lakom as a tool for verifying your own workload, you&rsquo;ll need to add your own public keys to the ones that Lakom is already using. This can be achieved using Gardener <a href=/docs/gardener/extensions/referenced-resources/>referenced resources</a>. More information about the keys and their format can be found <a href=/docs/extensions/others/gardener-extension-shoot-lakom-service/lakom/#lakom-cosign-public-keys-configuration-file>here</a>.</p><p>Simply:</p><ol><li>Create a secret in your project namespace that contains a field <code>keys</code> with your keys as a value. Example keys:</li></ol><pre tabindex=0><code>- name: example-client-key1
  algorithm: RSASSA-PSS-SHA256
  key: |-
    -----BEGIN PUBLIC KEY-----
    MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAPeQXbIWMMXYV+9+j9b4jXTflnpfwn4E
    GMrmqYVhm0sclXb2FPP5aV/NFH6SZdHDZcT8LCNsNgxzxV4N+UE/JIsCAwEAAQ==
    -----END PUBLIC KEY-----
- name: example-client-key2
  algorithm: RSASSA-PSS-SHA256
  key: |-
    -----BEGIN PUBLIC KEY-----
    MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAPeQXbIWMMXYV+9+j9b4jXTflnpfwn4E
    GMrmqYVhm0sclXb2FPP5aV/NFH6SZdHDZcT8LCNsNgxzxV4N+UE/JIsCAwEAAQ==
    -----END PUBLIC KEY-----
</code></pre><ol start=2><li>Add a reference to your secret via the <code>resources</code> field in the shoot spec as shown above.</li><li>Add the name of your referenece in <code>trustedKeysResourceName </code>in the provider config as shown above.</li></ol><p>Now, whenever Lakom tries to verify a Pod, it will make sure to use your public keys as well.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d21abe30553ea86e1f5973d8484fc9d1>5.5 - Networking problemdetector</h1><div class=lead>Gardener extension for deploying network problem detector</div><h1 id=gardener-extension-for-network-problem-detectorhttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Network Problem Detector</a><a class=td-heading-self-link href=#gardener-extension-for-network-problem-detectorhttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-networking-problemdetector><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-networking-problemdetector alt="REUSE status"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the <code>shoot-networking-problemdetector</code> extension.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-shoot-networking-problemdetector/blob/main/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=extension-resources>Extension Resources<a class=td-heading-self-link href=#extension-resources aria-label="Heading self-link"></a></h2><p>Currently there is nothing to specify in the extension spec.</p><p>Example extension resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Extension
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-networking-problemdetector
</span></span><span style=display:flex><span>  namespace: shoot--project--abc
</span></span><span style=display:flex><span>spec:
</span></span></code></pre></div><p>When an extension resource is reconciled, the extension controller will create two daemonsets <code>nwpd-agent-pod-net</code> and <code>nwpd-agent-node-net</code> deploying
the &ldquo;network problem detector agent&rdquo;.
These daemon sets perform and collect various checks between all nodes of the Kubernetes cluster, to its Kube API server and/or external endpoints.
Checks are performed using TCP connections, PING (ICMP) or mDNS (UDP).
More details about the network problem detector agent can be found in its repository <a href=https://github.com/gardener/network-problem-detector>gardener/network-problem-detector</a>.</p><p>Please note, this extension controller relies on the <a href=/docs/gardener/concepts/resource-manager/>Gardener-Resource-Manager</a> to deploy k8s resources to seed and shoot clusters.</p><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>.</p><p>We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-networking-problemdetector/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-bebb19906236a4aead1990c60039a112>5.5.1 - Deployment</h1><h1 id=gardener-networking-policy-filter-for-shoots>Gardener Networking Policy Filter for Shoots<a class=td-heading-self-link href=#gardener-networking-policy-filter-for-shoots aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener allows shoot clusters to add network problem observability using the network problem detector.
To support this the Gardener must be installed with the <code>shoot-networking-problemdetector</code> extension.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>To generally enable the networking problem detector for shoot objects the <code>shoot-networking-problemdetector</code> extension must be registered by providing an appropriate <a href=https://github.com/gardener/gardener-extension-shoot-networking-problemdetector/blob/main/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots the <code>globallyEnabled</code> flag should be set to <code>true</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerRegistration
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - kind: Extension
</span></span><span style=display:flex><span>      type: shoot-networking-problemdetector
</span></span><span style=display:flex><span>      globallyEnabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=controllerregistration>ControllerRegistration<a class=td-heading-self-link href=#controllerregistration aria-label="Heading self-link"></a></h3><p>An example of a <code>ControllerRegistration</code> for the <code>shoot-networking-problemdetector</code> can be found at <a href=https://github.com/gardener/gardener-extension-shoot-networking-problemdetector/blob/master/example/controller-registration.yaml>controller-registration.yaml</a>.</p><p>The <code>ControllerRegistration</code> contains a Helm chart which eventually deploys the <code>shoot-networking-problemdetector</code> to seed clusters. It offers some configuration options, mainly to set up a static filter list or provide the configuration for downloading the filter list from a service endpoint.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerDeployment
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  values:
</span></span><span style=display:flex><span>    <span style=color:green>#networkProblemDetector:</span>
</span></span><span style=display:flex><span>    <span style=color:green>#  defaultPeriod: 30s</span>
</span></span></code></pre></div><h3 id=enablement-for-a-shoot>Enablement for a Shoot<a class=td-heading-self-link href=#enablement-for-a-shoot aria-label="Heading self-link"></a></h3><p>If the shoot network problem detector is not globally enabled by default (depends on the extension registration on the garden cluster), it can be enabled per shoot. To enable the service for a shoot, the shoot manifest must explicitly add the <code>shoot-networking-problemdetector</code> extension.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-problemdetector
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>If the shoot network problem detector is globally enabled by default, it can be disabled per shoot. To disable the service for a shoot, the shoot manifest must explicitly state it.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-problemdetector
</span></span><span style=display:flex><span>      disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c9d138e16c74e4d2eff97bab16571286>5.5.2 - Shoot Networking Problemdetector</h1><h1 id=register-shoot-networking-filter-extension-in-shoot-clusters>Register Shoot Networking Filter Extension in Shoot Clusters<a class=td-heading-self-link href=#register-shoot-networking-filter-extension-in-shoot-clusters aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Within a shoot cluster, it is possible to enable the network problem detector. It is necessary that the Gardener installation your shoot cluster runs in is equipped with a <code>shoot-networking-problemdetector</code> extension. Please ask your Gardener operator if the extension is available in your environment.</p><h2 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h2><p>In most of the Gardener setups the <code>shoot-networking-problemdetector</code> extension is not enabled globally and thus must be configured per shoot cluster. Please adapt the shoot specification by the configuration shown below to activate the extension individually.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-problemdetector
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=opt-out>Opt-out<a class=td-heading-self-link href=#opt-out aria-label="Heading self-link"></a></h2><p>If the shoot network problem detector is globally enabled by default, it can be disabled per shoot. To disable the service for a shoot, the shoot manifest must explicitly state it.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-networking-problemdetector
</span></span><span style=display:flex><span>      disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6889f213566c4acb69ba72feddc07601>5.6 - Node Audit Logging</h1><div class=lead>Gardener extension controller which configures the rsyslog and auditd services installed on shoot nodes.</div><h1 id=gardener-extension-to-configure-rsyslog-with-relp-modulehttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension to configure rsyslog with relp module</a><a class=td-heading-self-link href=#gardener-extension-to-configure-rsyslog-with-relp-modulehttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-rsyslog-relp><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-rsyslog-relp alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-shoot-rsyslog-relp-main/jobs/main-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-shoot-rsyslog-relp-main/jobs/main-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-shoot-rsyslog-relp><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-shoot-rsyslog-relp alt="Go Report Card"></a></p><p>Gardener extension controller which configures the rsyslog and auditd services installed on shoot nodes.</p><h2 id=usage>Usage<a class=td-heading-self-link href=#usage aria-label="Heading self-link"></a></h2><ul><li><a href=/docs/extensions/others/gardener-extension-shoot-rsyslog-relp/configuration/>Configuring the Rsyslog Relp Extension</a> - learn what is the use-case for rsyslog-relp, how to enable it and configure it</li></ul><h2 id=local-setup-and-development>Local Setup and Development<a class=td-heading-self-link href=#local-setup-and-development aria-label="Heading self-link"></a></h2><ul><li><a href=/docs/extensions/others/gardener-extension-shoot-rsyslog-relp/getting-started/>Deploying the Rsyslog Relp Extension Locally</a> - learn how to set up a local development environment</li><li><a href=/docs/extensions/others/gardener-extension-shoot-rsyslog-relp/shoot-rsyslog-relp/>Developer Docs for Gardener Shoot Rsyslog Relp Extension</a> - learn about the inner workings</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-5ebc3f99478b6244b628fb0367c1bbaa>5.6.1 - Configuration</h1><h1 id=configuring-the-rsyslog-relp-extension>Configuring the Rsyslog Relp Extension<a class=td-heading-self-link href=#configuring-the-rsyslog-relp-extension aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>As a cluster owner, you might need audit logs on a Shoot node level. With these audit logs you can track actions on your nodes like privilege escalation, file integrity, process executions, and who is the user that performed these actions. Such information is essential for the security of your Shoot cluster. Linux operating systems collect such logs via the <code>auditd</code> and <code>journald</code> daemons. However, these logs can be lost if they are only kept locally on the operating system. You need a reliable way to send them to a remote server where they can be stored for longer time periods and retrieved when necessary.</p><p><a href=https://www.rsyslog.com/>Rsyslog</a> offers a solution for that. It gathers and processes logs from <code>auditd</code> and <code>journald</code> and then forwards them to a remote server. Moreover, <code>rsyslog</code> can make use of the RELP protocol so that logs are sent reliably and no messages are lost.</p><p>The <code>shoot-rsyslog-relp</code> extension is used to configure <code>rsyslog</code> on each Shoot node so that the following can take place:</p><ol><li><code>Rsyslog</code> reads logs from the <code>auditd</code> and <code>journald</code> sockets.</li><li>The logs are filtered based on the program name and syslog severity of the message.</li><li>The logs are enriched with metadata containing the name of the Project in which the Shoot is created, the name of the Shoot, the UID of the Shoot, and the hostname of the node on which the log event occurred.</li><li>The enriched logs are sent to the target remote server via the RELP protocol.</li></ol><p>The following graph shows a rough outline of how that looks in a Shoot cluster:
<img src=/__resources/rsyslog-logging-architecture_a57f91.png alt=rsyslog-logging-architecture></p><h2 id=shoot-configuration>Shoot Configuration<a class=td-heading-self-link href=#shoot-configuration aria-label="Heading self-link"></a></h2><p>The extension is not globally enabled and must be configured per Shoot cluster. The Shoot specification has to be adapted to include the <code>shoot-rsyslog-relp</code> extension configuration, which specifies the target server to which logs are forwarded, its port, and some optional rsyslog settings described in the examples below.</p><p>Below is an example <code>shoot-rsyslog-relp</code> extension configuration as part of the Shoot spec:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: bar
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-rsyslog-relp
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>      <span style=color:green># Set the target server to which logs are sent. The server must support the RELP protocol.</span>
</span></span><span style=display:flex><span>      target: some.rsyslog-relp.server
</span></span><span style=display:flex><span>      <span style=color:green># Set the port of the target server.</span>
</span></span><span style=display:flex><span>      port: 10250
</span></span><span style=display:flex><span>      <span style=color:green># Define rules to select logs from which programs and with what syslog severity</span>
</span></span><span style=display:flex><span>      <span style=color:green># are forwarded to the target server.</span>
</span></span><span style=display:flex><span>      loggingRules:
</span></span><span style=display:flex><span>      - severity: 4
</span></span><span style=display:flex><span>        programNames: [<span style=color:#a31515>&#34;kubelet&#34;</span>, <span style=color:#a31515>&#34;audisp-syslog&#34;</span>]
</span></span><span style=display:flex><span>      - severity: 1
</span></span><span style=display:flex><span>        programNames: [<span style=color:#a31515>&#34;audisp-syslog&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:green># Define an interval of 90 seconds at which the current connection is broken and re-established.</span>
</span></span><span style=display:flex><span>      <span style=color:green># By default this value is 0 which means that the connection is never broken and re-established.</span>
</span></span><span style=display:flex><span>      rebindInterval: 90
</span></span><span style=display:flex><span>      <span style=color:green># Set the timeout for relp sessions to 90 seconds. If set too low, valid sessions may be considered</span>
</span></span><span style=display:flex><span>      <span style=color:green># dead and tried to recover.</span>
</span></span><span style=display:flex><span>      timeout: 90
</span></span><span style=display:flex><span>      <span style=color:green># Set how often an action is retried before it is considered to have failed.</span>
</span></span><span style=display:flex><span>      <span style=color:green># Failed actions discard log messages. Setting `-1` here means that messages are never discarded.</span>
</span></span><span style=display:flex><span>      resumeRetryCount: -1
</span></span><span style=display:flex><span>      <span style=color:green># Configures rsyslog to report continuation of action suspension, e.g. when the connection to the target</span>
</span></span><span style=display:flex><span>      <span style=color:green># server is broken.</span>
</span></span><span style=display:flex><span>      reportSuspensionContinuation: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      <span style=color:green># Add tls settings if tls should be used to encrypt the connection to the target server.</span>
</span></span><span style=display:flex><span>      tls:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        <span style=color:green># Use `name` authentication mode for the tls connection.</span>
</span></span><span style=display:flex><span>        authMode: name
</span></span><span style=display:flex><span>        <span style=color:green># Only allow connections if the server&#39;s name is `some.rsyslog-relp.server`</span>
</span></span><span style=display:flex><span>        permittedPeer:
</span></span><span style=display:flex><span>        - <span style=color:#a31515>&#34;some.rsyslog-relp.server&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:green># Reference to the resource which contains certificates used for the tls connection.</span>
</span></span><span style=display:flex><span>        <span style=color:green># It must be added to the `.spec.resources` field of the Shoot.</span>
</span></span><span style=display:flex><span>        secretReferenceName: rsyslog-relp-tls
</span></span><span style=display:flex><span>        <span style=color:green># Instruct librelp on the Shoot nodes to use the gnutls tls library.</span>
</span></span><span style=display:flex><span>        tlsLib: gnutls
</span></span><span style=display:flex><span>      <span style=color:green># Add auditConfig settings if you want to customize node level auditing.</span>
</span></span><span style=display:flex><span>      auditConfig:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        <span style=color:green># Reference to the resource which contains the audit configuration.</span>
</span></span><span style=display:flex><span>        <span style=color:green># It must be added to the `.spec.resources` field of the Shoot.</span>
</span></span><span style=display:flex><span>        configMapReferenceName: audit-config
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    <span style=color:green># Add the rsyslog-relp-tls secret in the resources field of the Shoot spec.</span>
</span></span><span style=display:flex><span>    - name: rsyslog-relp-tls
</span></span><span style=display:flex><span>      resourceRef:
</span></span><span style=display:flex><span>        apiVersion: v1
</span></span><span style=display:flex><span>        kind: Secret
</span></span><span style=display:flex><span>        name: rsyslog-relp-tls-v1
</span></span><span style=display:flex><span>    - name: audit-config
</span></span><span style=display:flex><span>      resourceRef:
</span></span><span style=display:flex><span>        apiVersion: v1
</span></span><span style=display:flex><span>        kind: ConfigMap
</span></span><span style=display:flex><span>        name: audit-config-v1
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h3 id=choosing-which-log-messages-to-send-to-the-target-server>Choosing Which Log Messages to Send to the Target Server<a class=td-heading-self-link href=#choosing-which-log-messages-to-send-to-the-target-server aria-label="Heading self-link"></a></h3><p>The <code>.loggingRules</code> field defines rules about which logs should be sent to the target server. When a log is processed by rsyslog, it is compared against the list of rules in order. If the program name and the syslog severity of the log messages matches the rule, the message is forwarded to the target server. The following table describes the syslog severity and their corresponding codes:</p><pre tabindex=0><code>Numerical         Severity
  Code

  0               Emergency: system is unusable
  1               Alert: action must be taken immediately
  2               Critical: critical conditions
  3               Error: error conditions
  4               Warning: warning conditions
  5               Notice: normal but significant condition
  6               Informational: informational messages
  7               Debug: debug-level messages
</code></pre><p>Below is an example with a <code>.loggingRules</code> section that will only forward logs from the <code>kubelet</code> program with syslog severity of 6 or lower and any other program with syslog severity of 2 or lower:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>target: localhost
</span></span><span style=display:flex><span>port: 1520
</span></span><span style=display:flex><span>loggingRules:
</span></span><span style=display:flex><span>- severity: 6
</span></span><span style=display:flex><span>  programNames: [<span style=color:#a31515>&#34;kubelet&#34;</span>]
</span></span><span style=display:flex><span>- severity: 2
</span></span></code></pre></div><p>You can use a minimal <code>shoot-rsyslog-relp</code> extension configuration to forward all logs to the target server:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>target: some.rsyslog-relp.server
</span></span><span style=display:flex><span>port: 10250
</span></span><span style=display:flex><span>loggingRules:
</span></span><span style=display:flex><span>- severity: 7
</span></span></code></pre></div><h3 id=securing-the-communication-to-the-target-server-with-tls>Securing the Communication to the Target Server with TLS<a class=td-heading-self-link href=#securing-the-communication-to-the-target-server-with-tls aria-label="Heading self-link"></a></h3><p>The communication to the target server is not encrypted by default. To enable encryption, set the <code>.tls.enabled</code> field in the <code>shoot-rsyslog-relp</code> extension configuration to <code>true</code>. In this case, an immutable secret which contains the TLS certificates used to establish the TLS connection to the server must be created in the same project namespace as your Shoot.</p><p>An example Secret is given below:</p><blockquote><p><strong>Note:</strong> The secret must be immutable</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: rsyslog-relp-tls-v1
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>immutable: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  ca: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----BEGIN BEGIN RSA PRIVATE KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>    ...
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----END RSA PRIVATE KEY-----</span>    
</span></span><span style=display:flex><span>  crt: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----BEGIN BEGIN RSA PRIVATE KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>    ...
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----END RSA PRIVATE KEY-----</span>    
</span></span><span style=display:flex><span>  key: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----BEGIN BEGIN RSA PRIVATE KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>    ...
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----END RSA PRIVATE KEY-----</span>    
</span></span></code></pre></div><p>The Secret must be referenced in the Shoot&rsquo;s <code>.spec.resources</code> field and the corresponding resource entry must be referenced in the <code>.tls.secretReferenceName</code> of the <code>shoot-rsyslog-relp</code> extension configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: bar
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-rsyslog-relp
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>      target: some.rsyslog-relp.server
</span></span><span style=display:flex><span>      port: 10250
</span></span><span style=display:flex><span>      loggingRules:
</span></span><span style=display:flex><span>      - severity: 7
</span></span><span style=display:flex><span>      tls:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        secretReferenceName: rsyslog-relp-tls
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - name: rsyslog-relp-tls
</span></span><span style=display:flex><span>      resourceRef:
</span></span><span style=display:flex><span>        apiVersion: v1
</span></span><span style=display:flex><span>        kind: Secret
</span></span><span style=display:flex><span>        name: rsyslog-relp-tls-v1
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>You can set a few additional parameters for the TLS connection: <code>.tls.authMode</code>, <code>tls.permittedPeer</code>, and <code>tls.tlsLib</code>. Refer to the rsyslog documentation for more information on these parameters:</p><ul><li><a href=https://www.rsyslog.com/doc/v8-stable/configuration/modules/omrelp.html#tls-authmode><code>.tls.authMode</code></a></li><li><a href=https://www.rsyslog.com/doc/v8-stable/configuration/modules/omrelp.html#tls-permittedpeer><code>.tls.permittedPeer</code></a></li><li><a href=https://www.rsyslog.com/doc/v8-stable/configuration/modules/imrelp.html#tls-tlslib><code>.tls.tlsLib</code></a></li></ul><h3 id=configuring-the-audit-daemon-on-the-shoot-nodes>Configuring the Audit Daemon on the Shoot Nodes<a class=td-heading-self-link href=#configuring-the-audit-daemon-on-the-shoot-nodes aria-label="Heading self-link"></a></h3><p>The <code>shoot-rsyslog-relp</code> extension also allows you to configure the Audit Daemon (<code>auditd</code>) on the Shoot nodes.</p><p>By default, the audit rules located under the <code>/etc/audit/rules.d</code> directory on your Shoot&rsquo;s nodes will be moved to <code>/etc/audit/rules.d.original</code> and the following rules will be placed under the <code>/etc/audit/rules.d</code> directory: <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/auditrules/00-base-config.rules>00-base-config.rules</a>, <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/auditrules/10-privilege-escalation.rules>10-privilege-escalation.rules</a>, <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/auditrules/11-privileged-special.rules>11-privilege-special.rules</a>, <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/auditrules/12-system-integrity.rules>12-system-integrity.rules</a>. Next, <code>augerules --load</code> will be called and the audit daemon (<code>auditd</code>) restarted so that the new rules can take effect.</p><p>Alternatively, you can define your own <code>auditd</code> rules to be placed on your Shoot&rsquo;s nodes by using the following configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Auditd
</span></span><span style=display:flex><span>auditRules: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>  ## First rule - delete all existing rules
</span></span></span><span style=display:flex><span><span style=color:#a31515>  -D
</span></span></span><span style=display:flex><span><span style=color:#a31515>  ## Now define some custom rules
</span></span></span><span style=display:flex><span><span style=color:#a31515>  -a exit,always -F arch=b64 -S setuid -S setreuid -S setgid -S setregid -F auid&gt;0 -F auid!=-1 -F key=privilege_escalation
</span></span></span><span style=display:flex><span><span style=color:#a31515>  -a exit,always -F arch=b64 -S execve -S execveat -F euid=0 -F auid&gt;0 -F auid!=-1 -F key=privilege_escalation</span>  
</span></span></code></pre></div><p>In this case the original rules are also backed up in the <code>/etc/audit/rules.d.original</code> directory.</p><p>To deploy this configuration, it must be embedded in an immutable ConfigMap.</p><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>The data key storing this configuration must be named <code>auditd</code>.</p></blockquote><p>An example <code>ConfigMap</code> is given below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: ConfigMap
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: audit-config-v1
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>immutable: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>data:
</span></span><span style=display:flex><span>  auditd: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#a31515>    kind: Auditd
</span></span></span><span style=display:flex><span><span style=color:#a31515>    auditRules: |
</span></span></span><span style=display:flex><span><span style=color:#a31515>      ## First rule - delete all existing rules
</span></span></span><span style=display:flex><span><span style=color:#a31515>      -D
</span></span></span><span style=display:flex><span><span style=color:#a31515>      ## Now define some custom rules
</span></span></span><span style=display:flex><span><span style=color:#a31515>      -a exit,always -F arch=b64 -S setuid -S setreuid -S setgid -S setregid -F auid&gt;0 -F auid!=-1 -F key=privilege_escalation
</span></span></span><span style=display:flex><span><span style=color:#a31515>      -a exit,always -F arch=b64 -S execve -S execveat -F euid=0 -F auid&gt;0 -F auid!=-1 -F key=privilege_escalation</span>    
</span></span></code></pre></div><p>After creating such a <code>ConfigMap</code>, it must be included in the Shoot&rsquo;s <code>spec.resources</code> array and then referenced from the <code>providerConfig.auditConfig.configMapReferenceName</code> field in the <code>shoot-rsyslog-relp</code> extension configuration.</p><p>An example configuration is given below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: bar
</span></span><span style=display:flex><span>  namespace: garden-foo
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-rsyslog-relp
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: rsyslog-relp.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: RsyslogRelpConfig
</span></span><span style=display:flex><span>      target: some.rsyslog-relp.server
</span></span><span style=display:flex><span>      port: 10250
</span></span><span style=display:flex><span>      loggingRules:
</span></span><span style=display:flex><span>      - severity: 7
</span></span><span style=display:flex><span>      auditConfig:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        configMapReferenceName: audit-config
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - name: audit-config
</span></span><span style=display:flex><span>      resourceRef:
</span></span><span style=display:flex><span>        apiVersion: v1
</span></span><span style=display:flex><span>        kind: ConfigMap
</span></span><span style=display:flex><span>        name: audit-config-v1
</span></span></code></pre></div><p>Finally, by setting <code>providerConfig.auditConfig.enabled</code> to <code>false</code> in the <code>shoot-rsyslog-relp</code> extension configuration, the original audit rules on your Shoot&rsquo;s nodes will not be modified and <code>auditd</code> will not be restarted.</p><p>Examples on how the <code>providerConfig.auditConfig.enabled</code> field functions are given below:</p><ul><li>The following deploys the extension default audit rules as of today:<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  auditConfig:
</span></span><span style=display:flex><span>    enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div></li><li>The following deploys only the rules specified in the referenced ConfigMap:<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  auditConfig:
</span></span><span style=display:flex><span>    enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    configMapReferenceName: audit-config
</span></span></code></pre></div></li><li>Both of the following do not deploy any audit rules:<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  auditConfig:
</span></span><span style=display:flex><span>    enabled: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>    configMapReferenceName: audit-config
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  auditConfig:
</span></span><span style=display:flex><span>    enabled: <span style=color:#00f>false</span>
</span></span></code></pre></div></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d98ae8d67f017fd530967ee60a540c5c>5.6.2 - Deploying Rsyslog Relp Extension Remotely</h1><div class=lead>Learn how to set up a development environment using own Seed clusters on an existing Kubernetes cluster</div><h1 id=deploying-rsyslog-relp-extension-remotely>Deploying Rsyslog Relp Extension Remotely<a class=td-heading-self-link href=#deploying-rsyslog-relp-extension-remotely aria-label="Heading self-link"></a></h1><p>This document will walk you through running the Rsyslog Relp extension controller on a remote seed cluster and the rsyslog relp admission component in your local garden cluster for development purposes. This guide uses Gardener&rsquo;s <a href=/docs/gardener/deployment/getting_started_locally_with_extensions/>setup with provider extensions</a> and builds on top of it.</p><p>If you encounter difficulties, please open an issue so that we can make this process easier.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>Make sure that you have a running Gardener setup with provider extensions. The steps to complete this can be found in the <a href=/docs/gardener/deployment/getting_started_locally_with_extensions/>Deploying Gardener Locally and Enabling Provider-Extensions</a> guide.</li><li>Make sure you are running Gardener version <code>>= 1.95.0</code> or the latest version of the master branch.</li></ul><h2 id=setting-up-the-rsyslog-relp-extension>Setting up the Rsyslog Relp Extension<a class=td-heading-self-link href=#setting-up-the-rsyslog-relp-extension aria-label="Heading self-link"></a></h2><p><strong>Important:</strong> Make sure that your <code>KUBECONFIG</code> env variable is targeting the local Gardener cluster!</p><p>The location of the Gardener project from the Gardener setup is expected to be under the same root as this repository (e.g. ~/go/src/github.com/gardener/). If this is not the case, the location of Gardener project should be specified in <code>GARDENER_REPO_ROOT</code> environment variable:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export GARDENER_REPO_ROOT=<span style=color:#a31515>&#34;&lt;path_to_gardener_project&gt;&#34;</span>
</span></span></code></pre></div><p>Then you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-up
</span></span></code></pre></div><p>In case you have added additional Seeds you can specify the seed name:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-up SEED_NAME=&lt;seed-name&gt;
</span></span></code></pre></div><h2 id=creating-a-shoot-cluster>Creating a Shoot Cluster<a class=td-heading-self-link href=#creating-a-shoot-cluster aria-label="Heading self-link"></a></h2><p>Once the above step is completed, you can create a Shoot cluster. In order to create a Shoot cluster, please create your own <code>Shoot</code> definition depending on providers on your <code>Seed</code> cluster.</p><h2 id=configuring-the-shoot-cluster-and-deploying-the-rsyslog-relp-echo-server>Configuring the Shoot Cluster and deploying the Rsyslog Relp Echo Server<a class=td-heading-self-link href=#configuring-the-shoot-cluster-and-deploying-the-rsyslog-relp-echo-server aria-label="Heading self-link"></a></h2><p>To be able to properly test the rsyslog relp extension you need a running rsyslog relp echo server to which logs from the Shoot nodes can be sent. To deploy the server and configure the rsyslog relp extension on your Shoot cluster you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make configure-shoot SHOOT_NAME=&lt;shoot-name&gt; SHOOT_NAMESPACE=&lt;shoot-namespace&gt;
</span></span></code></pre></div><p>This command will deploy an rsyslog relp echo server in your Shoot cluster in the <code>rsyslog-relp-echo-server</code> namespace.
It will also add configuration for the <code>shoot-rsyslog-relp</code> extension to your <code>Shoot</code> spec by patching it with <code>./example/extension/&lt;shoot-name>--&lt;shoot-namespace>--extension-config-patch.yaml</code>. This file is automatically copied from <code>extension-config-patch.yaml.tmpl</code> in the same directory when you run <code>make configure-shoot</code> for the first time. The file also includes explanations of the properties you should set or change.
The command will also deploy the <code>rsyslog-relp-tls</code> secret in case you wish to enable tls.</p><h2 id=tearing-down-the-development-environment>Tearing Down the Development Environment<a class=td-heading-self-link href=#tearing-down-the-development-environment aria-label="Heading self-link"></a></h2><p>To tear down the development environment, delete the Shoot cluster or disable the <code>shoot-rsyslog-relp</code> extension in the Shoot&rsquo;s specification. When the extension is not used by the Shoot anymore, you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-down
</span></span></code></pre></div><p>The make target will delete the ControllerDeployment and ControllerRegistration of the extension, and the <code>shoot-rsyslog-relp</code> admission helm deployment.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5931a564b136d80a746006d8ebc0311b>5.6.3 - Getting Started</h1><h1 id=deploying-rsyslog-relp-extension-locally>Deploying Rsyslog Relp Extension Locally<a class=td-heading-self-link href=#deploying-rsyslog-relp-extension-locally aria-label="Heading self-link"></a></h1><p>This document will walk you through running the Rsyslog Relp extension and a fake rsyslog relp service on your local machine for development purposes. This guide uses Gardener&rsquo;s local development setup and builds on top of it.</p><p>If you encounter difficulties, please open an issue so that we can make this process easier.</p><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>Make sure that you have a running local Gardener setup. The steps to complete this can be found <a href=/docs/gardener/deployment/getting_started_locally/>here</a>.</li><li>Make sure you are running Gardener version <code>>= 1.74.0</code> or the latest version of the master branch.</li></ul><h2 id=setting-up-the-rsyslog-relp-extension>Setting up the Rsyslog Relp Extension<a class=td-heading-self-link href=#setting-up-the-rsyslog-relp-extension aria-label="Heading self-link"></a></h2><p><strong>Important:</strong> Make sure that your <code>KUBECONFIG</code> env variable is targeting the local Gardener cluster!</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-up
</span></span></code></pre></div><p>This will build the <code>shoot-rsyslog-relp</code>, <code>shoot-rsyslog-relp-admission</code>, and <code>shoot-rsyslog-relp-echo-server</code> images and deploy the needed resources and configurations in the garden cluster. The <code>shoot-rsyslog-relp-echo-server</code> will act as development replacement of a real rsyslog relp server.</p><h2 id=creating-a-shoot-cluster>Creating a Shoot Cluster<a class=td-heading-self-link href=#creating-a-shoot-cluster aria-label="Heading self-link"></a></h2><p>Once the above step is completed, we can deploy and configure a Shoot cluster with default rsyslog relp settings.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f ./example/shoot.yaml
</span></span></code></pre></div><p>Once the Shoot&rsquo;s namespace is created, we can create a <code>networkpolicy</code> that will allow egress traffic from the <code>rsyslog</code> on the Shoot&rsquo;s nodes to the <code>rsyslog-relp-echo-server</code> that serves as a fake rsyslog target server.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f ./example/local/allow-machine-to-rsyslog-relp-echo-server-netpol.yaml
</span></span></code></pre></div><p>Currently, the Shoot&rsquo;s nodes run Ubuntu, which does not have the <code>rsyslog-relp</code> and <code>auditd</code> packages installed, so the configuration done by the extension has no effect.
Once the Shoot is created, we have to manually install the <code>rsyslog-relp</code> and <code>auditd</code> packages:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n shoot--local--local exec -it <span style=color:#00f>$(</span>kubectl -n shoot--local--local get po -l app=machine,machine-provider=local -o name<span style=color:#00f>)</span> -- bash -c <span style=color:#a31515>&#34;
</span></span></span><span style=display:flex><span><span style=color:#a31515>   apt-get update &amp;&amp; \
</span></span></span><span style=display:flex><span><span style=color:#a31515>   apt-get install -y rsyslog-relp auditd &amp;&amp; \
</span></span></span><span style=display:flex><span><span style=color:#a31515>   systemctl enable rsyslog.service &amp;&amp; \
</span></span></span><span style=display:flex><span><span style=color:#a31515>   systemctl start rsyslog.service&#34;</span>
</span></span></code></pre></div><p>Once that is done we can verify that log messages are forwarded to the <code>rsyslog-relp-echo-server</code> by checking its logs.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n rsyslog-relp-echo-server logs deployment/rsyslog-relp-echo-server
</span></span></code></pre></div><h2 id=making-changes-to-the-rsyslog-relp-extension>Making Changes to the Rsyslog Relp Extension<a class=td-heading-self-link href=#making-changes-to-the-rsyslog-relp-extension aria-label="Heading self-link"></a></h2><p>Changes to the rsyslog relp extension can be applied to the local environment by repeatedly running the <code>make</code> recipe.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-up
</span></span></code></pre></div><h2 id=tearing-down-the-development-environment>Tearing Down the Development Environment<a class=td-heading-self-link href=#tearing-down-the-development-environment aria-label="Heading self-link"></a></h2><p>To tear down the development environment, delete the Shoot cluster or disable the <code>shoot-rsyslog-relp</code> extension in the Shoot&rsquo;s spec. When the extension is not used by the Shoot anymore, you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-down
</span></span></code></pre></div><p>This will delete the <code>ControllerRegistration</code> and <code>ControllerDeployment</code> of the extension, the <code>shoot-rsyslog-relp-admission</code> deployment, and the <code>rsyslog-relp-echo-server</code> deployment.</p><h1 id=maintaining-the-publicly-available-image-for-the-rsyslog-relp-echo-server>Maintaining the Publicly Available Image for the rsyslog-relp Echo Server<a class=td-heading-self-link href=#maintaining-the-publicly-available-image-for-the-rsyslog-relp-echo-server aria-label="Heading self-link"></a></h1><p>The <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/tree/main/test/testmachinery/shoot>testmachinery tests</a> use an <code>rsyslog-relp-echo-server</code> image from a publicly available repository. The one which is currently used is <code>eu.gcr.io/gardener-project/gardener/extensions/shoot-rsyslog-relp-echo-server:v0.1.0</code>.</p><p>Sometimes it might be necessary to update the image and publish it, e.g. when updating the <code>alpine</code> base image version specified in the repository&rsquo;s <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/Dockerfile#L34>Dokerfile</a>.</p><p>To do that:</p><ol><li><p>Bump the version with which the image is built in the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/Makefile#L17>Makefile</a>.</p></li><li><p>Build the <code>shoot-rsyslog-relp-echo-server</code> image:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make echo-server-docker-image
</span></span></code></pre></div></li><li><p>Once the image is built, push it to <code>gcr</code> with:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make push-echo-server-image
</span></span></code></pre></div></li><li><p>Finally, bump the version of the image used by the <code>testmachinery</code> tests <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/test/testmachinery/shoot/common_test.go>here</a>.</p></li><li><p>Create a PR with the changes.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-1841124a2d14ff1da23f3b3ac50c5742>5.6.4 - Monitoring</h1><h1 id=monitoring>Monitoring<a class=td-heading-self-link href=#monitoring aria-label="Heading self-link"></a></h1><p>The <code>shoot-rsyslog-relp</code> extension exposes metrics for the <code>rsyslog</code> service running on a Shoot&rsquo;s nodes so that they can be easily viewed by cluster owners and operators in the Shoot&rsquo;s Prometheus and Plutono instances. The exposed monitoring data offers valuable insights into the operation of the <code>rsyslog</code> service and can be used to detect and debug ongoing issues. This guide describes the various metrics, alerts and logs available to cluster owners and operators.</p><h2 id=metrics>Metrics<a class=td-heading-self-link href=#metrics aria-label="Heading self-link"></a></h2><p>Metrics for the <code>rsyslog</code> service originate from its <code>impstats</code> module. These include the number of messages in the various queues, the number of ingested messages, the number of processed messages by configured actions, system resources used by the <code>rsyslog</code> service, and others. More information about them can be found in the <a href=https://www.rsyslog.com/doc/configuration/modules/impstats.html><code>impstats</code> documentation</a> and the <a href=https://www.rsyslog.com/doc/configuration/rsyslog_statistic_counter.html>statistics counter documentation</a>. They are exposed via the <a href="https://github.com/prometheus/node_exporter?tab=readme-ov-file#node-exporter"><code>node-exporter</code></a> running on each Shoot node and are scraped by the Shoot&rsquo;s <a href=https://github.com/gardener/gardener/blob/release-v1.99/docs/monitoring/README.md#shoot-prometheus>Prometheus instance</a>.</p><p>These metrics can also be viewed in a dedicated dashboard named <code>Rsyslog Stats</code> in the Shoot&rsquo;s Plutono instance. You can select the node for which you wish the metrics to be displayed from the <code>Node</code> dropdown menu (by default metrics are summed over all nodes).</p><p>Following is a list of all exposed <code>rsyslog</code> metrics. The <code>name</code> and <code>origin</code> labels can be used to determine wether the metric is for: a <a href=https://www.rsyslog.com/doc/configuration/rsyslog_statistic_counter.html#queue>queue</a>, an <a href=https://www.rsyslog.com/doc/configuration/rsyslog_statistic_counter.html#queue>action</a>, <a href=https://www.rsyslog.com/doc/configuration/rsyslog_statistic_counter.html#plugins>plugins</a> or <a href=https://www.rsyslog.com/doc/configuration/modules/impstats.html#statistic-counter>system stats</a>; the <code>node</code> label can be used to determine the node the metric originates from:</p><h4 id=rsyslog_pstat_submitted>rsyslog_pstat_submitted<a class=td-heading-self-link href=#rsyslog_pstat_submitted aria-label="Heading self-link"></a></h4><p>Number of messages that were submitted to the <code>rsyslog</code> service from its input. Currently <code>rsyslog</code> uses the <code>/run/systemd/journal/syslog</code> socket as input.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_processed>rsyslog_pstat_processed<a class=td-heading-self-link href=#rsyslog_pstat_processed aria-label="Heading self-link"></a></h4><p>Number of messages that are successfully processed by an action and sent to the target server.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_failed>rsyslog_pstat_failed<a class=td-heading-self-link href=#rsyslog_pstat_failed aria-label="Heading self-link"></a></h4><p>Number of messages that could not be processed by an action nor sent to the target server.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_suspended>rsyslog_pstat_suspended<a class=td-heading-self-link href=#rsyslog_pstat_suspended aria-label="Heading self-link"></a></h4><p>Total number of times an action suspended itself. Note that this counts the number of times the action transitioned from active to suspended state. The counter is no indication of how long the action was suspended or how often it was retried.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_suspended_duration>rsyslog_pstat_suspended_duration<a class=td-heading-self-link href=#rsyslog_pstat_suspended_duration aria-label="Heading self-link"></a></h4><p>The total number of seconds this action was disabled.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_resumed>rsyslog_pstat_resumed<a class=td-heading-self-link href=#rsyslog_pstat_resumed aria-label="Heading self-link"></a></h4><p>The total number of times this action resumed itself. A resumption occurs after the action has detected that a failure condition does no longer exist.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_utime>rsyslog_pstat_utime<a class=td-heading-self-link href=#rsyslog_pstat_utime aria-label="Heading self-link"></a></h4><p>User time used in microseconds.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_stime>rsyslog_pstat_stime<a class=td-heading-self-link href=#rsyslog_pstat_stime aria-label="Heading self-link"></a></h4><p>System time used in microsends.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_maxrss>rsyslog_pstat_maxrss<a class=td-heading-self-link href=#rsyslog_pstat_maxrss aria-label="Heading self-link"></a></h4><p>Maximum resident set size</p><ul><li>Type: Gauge</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_minflt>rsyslog_pstat_minflt<a class=td-heading-self-link href=#rsyslog_pstat_minflt aria-label="Heading self-link"></a></h4><p>Total number of minor faults the task has made per second, those which have not required loading a memory page from disk.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_majflt>rsyslog_pstat_majflt<a class=td-heading-self-link href=#rsyslog_pstat_majflt aria-label="Heading self-link"></a></h4><p>Total number of major faults the task has made per second, those which have required loading a memory page from disk.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_inblock>rsyslog_pstat_inblock<a class=td-heading-self-link href=#rsyslog_pstat_inblock aria-label="Heading self-link"></a></h4><p>Filesystem input operations.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_oublock>rsyslog_pstat_oublock<a class=td-heading-self-link href=#rsyslog_pstat_oublock aria-label="Heading self-link"></a></h4><p>Filesystem output operations.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_nvcsw>rsyslog_pstat_nvcsw<a class=td-heading-self-link href=#rsyslog_pstat_nvcsw aria-label="Heading self-link"></a></h4><p>Voluntary context switches.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_nivcsw>rsyslog_pstat_nivcsw<a class=td-heading-self-link href=#rsyslog_pstat_nivcsw aria-label="Heading self-link"></a></h4><p>Involuntary context switches.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_openfiles>rsyslog_pstat_openfiles<a class=td-heading-self-link href=#rsyslog_pstat_openfiles aria-label="Heading self-link"></a></h4><p>Number of open files.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_size>rsyslog_pstat_size<a class=td-heading-self-link href=#rsyslog_pstat_size aria-label="Heading self-link"></a></h4><p>Messages currently in queue.</p><ul><li>Type: Gauge</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_enqueued>rsyslog_pstat_enqueued<a class=td-heading-self-link href=#rsyslog_pstat_enqueued aria-label="Heading self-link"></a></h4><p>Total messages enqueued.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_full>rsyslog_pstat_full<a class=td-heading-self-link href=#rsyslog_pstat_full aria-label="Heading self-link"></a></h4><p>Times queue was full.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_discarded_full>rsyslog_pstat_discarded_full<a class=td-heading-self-link href=#rsyslog_pstat_discarded_full aria-label="Heading self-link"></a></h4><p>Messages discarded due to queue being full.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_discarded_nf>rsyslog_pstat_discarded_nf<a class=td-heading-self-link href=#rsyslog_pstat_discarded_nf aria-label="Heading self-link"></a></h4><p>Messages discarded when queue not full.</p><ul><li>Type: Counter</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_pstat_maxqsize>rsyslog_pstat_maxqsize<a class=td-heading-self-link href=#rsyslog_pstat_maxqsize aria-label="Heading self-link"></a></h4><p>Maximum size queue has reached.</p><ul><li>Type: Gauge</li><li>Labels: <code>name</code> <code>node</code> <code>origin</code></li></ul><h4 id=rsyslog_augenrules_load_success>rsyslog_augenrules_load_success<a class=td-heading-self-link href=#rsyslog_augenrules_load_success aria-label="Heading self-link"></a></h4><p>Shows whether the <code>augenrules --load</code> command was executed successfully or not on the node.</p><ul><li>Type: Gauge</li><li>Labels: <code>node</code></li></ul><h2 id=alerts>Alerts<a class=td-heading-self-link href=#alerts aria-label="Heading self-link"></a></h2><p>There are three alerts defined for the <code>rsyslog</code> service in the Shoot&rsquo;s Prometheus instance:</p><h4 id=rsyslogtoomanyrelpactionfailures>RsyslogTooManyRelpActionFailures<a class=td-heading-self-link href=#rsyslogtoomanyrelpactionfailures aria-label="Heading self-link"></a></h4><p>This indicates that the cumulative failure rate in processing <code>relp</code> action messages is greater than 2%. In other words, it compares the rate of processed <code>relp</code> action messages to the rate of failed <code>relp</code> action messages and fires an alert when the following expression evaluates to true:</p><pre tabindex=0><code>sum(rate(rsyslog_pstat_failed{origin=&#34;core.action&#34;,name=&#34;rsyslg-relp&#34;}[5m])) / sum(rate(rsyslog_pstat_processed{origin=&#34;core.action&#34;,name=&#34;rsyslog-relp&#34;}[5m])) &gt; bool 0.02`
</code></pre><h4 id=rsyslogrelpactionprocessingrateiszero>RsyslogRelpActionProcessingRateIsZero<a class=td-heading-self-link href=#rsyslogrelpactionprocessingrateiszero aria-label="Heading self-link"></a></h4><p>This indicates that no messages are being sent to the upstream rsyslog target by the <code>relp</code> action. An alert is fired when the following expression evaluates to true:</p><pre tabindex=0><code>rate(rsyslog_pstat_processed{origin=&#34;core.action&#34;,name=&#34;rsyslog-relp&#34;}[5m]) == 0
</code></pre><h4 id=rsyslogrelpauditrulesnotloadedsuccessfully>RsyslogRelpAuditRulesNotLoadedSuccessfully<a class=td-heading-self-link href=#rsyslogrelpauditrulesnotloadedsuccessfully aria-label="Heading self-link"></a></h4><p>This indicates that <code>augenrules --load</code> was not executed successfully when called to load the configured audit rules. You should check if the <code>auditd</code> configuration you provided is valid. An alert is fired when the following expression evaluates to true:</p><pre tabindex=0><code>absent(rsyslog_augenrules_load_success == 1)
</code></pre><p>Users can subscribe to these alerts by following the Gardener <a href=/docs/gardener/monitoring/alerting/#alerting-for-users>alerting guide</a>.</p><h2 id=logging>Logging<a class=td-heading-self-link href=#logging aria-label="Heading self-link"></a></h2><p>There are two ways to view the logs of the <code>rsyslog</code> service running on the Shoot&rsquo;s nodes - either using the <code>Explore</code> tab of the Shoot&rsquo;s Plutono instance, or <code>ssh</code>-ing directly to a node.</p><p>To view logs in Plutono, navigate to the <code>Explore</code> tab and select <code>vali</code> from the <code>Explore</code> dropdown menu. Afterwards enter the following <code>vali</code> query:</p><p><code>{nodename="&lt;name-of-node>"} |~ "\"unit\":\"rsyslog.service\""</code></p><p>Notice that you cannot use the <code>unit</code> label to filter for the <code>rsyslog.service</code> unit logs. Instead, you have to <code>grep</code> for the service as displayed in the example above.</p><p>To view logs when directly <code>ssh</code>-ing to a node in the Shoot cluster, use either of the following commands on the node:</p><p><code>systemctl status rsyslog</code></p><p><code>journalctl -u rsyslog</code></p></div><div class=td-content style=page-break-before:always><h1 id=pg-9de2fab25f87ab9a7ba8bb94aa9858b9>5.6.5 - Shoot Rsyslog Relp</h1><h1 id=developer-docs-for-gardener-shoot-rsyslog-relp-extension>Developer Docs for Gardener Shoot Rsyslog Relp Extension<a class=td-heading-self-link href=#developer-docs-for-gardener-shoot-rsyslog-relp-extension aria-label="Heading self-link"></a></h1><p>This document outlines how Shoot reconciliation and deletion works for a Shoot with the shoot-rsyslog-relp extension enabled.</p><h2 id=shoot-reconciliation>Shoot Reconciliation<a class=td-heading-self-link href=#shoot-reconciliation aria-label="Heading self-link"></a></h2><p>This section outlines how the reconciliation works for a Shoot with the shoot-rsyslog-relp extension enabled.</p><h3 id=extension-enablement--reconciliation>Extension Enablement / Reconciliation<a class=td-heading-self-link href=#extension-enablement--reconciliation aria-label="Heading self-link"></a></h3><p>This section outlines how the extension enablement/reconciliation works, e.g., the extension has been added to the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, the gardenlet deploys the <a href=https://github.com/gardener/gardener/blob/v1.82.0/docs/extensions/extension.md>Extension</a> resource.</li><li>The shoot-rsyslog-relp extension reconciles the Extension resource. <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/controller/lifecycle/actuator.go>pkg/controller/lifecycle/actuator.go</a> contains the implementation of the <a href=https://github.com/gardener/gardener/blob/v1.82.0/extensions/pkg/controller/extension/actuator.go>extension.Actuator</a> interface. The reconciliation of an Extension of type <code>shoot-rsyslog-relp</code> only deploys the necessary monitoring configuration - the <code>shoot-rsyslog-relp-dashboards</code> ConfigMap which contains the definitions for: Plutono dashboard for the Rsyslog component, and the <code>shoot-shoot-rsyslog-relp</code> <code>ServiceMonitor</code> and <code>PrometheusRule</code> resources which contains the definitions for: scraping metrics by prometheus, alerting rules.</li><li>As part of the Shoot reconciliation flow, the gardenlet deploys the OperatingSystemConfig resource.</li><li>The shoot-rsyslog-relp extension serves a webhook that mutates the OperatingSystemConfig resource for Shoots having the shoot-rsyslog-relp extension enabled (the corresponding namespace gets labeled by the gardenlet with <code>extensions.gardener.cloud/shoot-rsyslog-relp=true</code>). <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/ensurer.go>pkg/webhook/operatingsystemconfig/ensurer.go</a> contains implementation of the <a href=https://github.com/gardener/gardener/blob/v1.82.0/extensions/pkg/webhook/controlplane/genericmutator/mutator.go>genericmutator.Ensurer</a> interface.<ol><li>The webhook renders the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/templates/scripts/configure-rsyslog.tpl.sh>60-audit.conf.tpl</a> template script and appends it to the OperatingSystemConfig files. When rendering the template, the configuration of the shoot-rsyslog-relp extension is used to fill in the required template values. The file is installed as <code>/var/lib/rsyslog-relp-configurator/rsyslog.d/60-audit.conf</code> on the host OS.</li><li>The webhook appends the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/tree/main/pkg/webhook/operatingsystemconfig/resources/auditrules>audit rules</a> to the OperatingSystemConfig. The files are installed under <code>/var/lib/rsyslog-relp-configurator/rules.d</code> on the host OS.</li><li>If the user has specified alternative audit rules in a config map reference, the webhook fetches the referenced <code>ConfigMap</code> from the Shoot&rsquo;s control plane namespace and decodes the value of its <code>auditd</code> data key into an object of type <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/apis/rsyslog/types_auditd.go><code>Auditd</code></a>. It then takes the <code>auditRules</code> defined in the object and places those under the <code>/var/lib/rsyslog-relp-configurator/rules.d</code> directory in a single file.</li><li>The webhook renders the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/templates/scripts/configure-rsyslog.tpl.sh>configure-rsyslog.tpl.sh</a> script and appends it to the OperatingSystemConfig files. This script is installed as <code>/var/lib/rsyslog-relp-configurator/configure-rsyslog.sh</code> on the host OS. It keeps the configuration of the <code>rsyslog</code> systemd service up-to-date by copying <code>/var/lib/rsyslog-relp-configurator/rsyslog.d/60-audit.conf</code> to <code>/etc/rsyslog.d/60-audit.conf</code>, if <code>/etc/rsyslog.d/60-audit.conf</code> does not exist or the files differ. The script also takes care of syncing the audit rules in <code>/etc/audit/rules.d</code> with the ones installed in <code>/var/lib/rsyslog-relp-configurator/rules.d</code> and restarts the auditd systemd service if necessary.</li><li>The webhook renders the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/webhook/operatingsystemconfig/resources/templates/scripts/process-rsyslog-pstats.tpl.sh>process-rsyslog-pstats.tpl.sh</a> and appends it to the OperatingSystemConfig files. This script receives metrics from the <code>rsyslog</code> process, transforms them, and writes them to <code>/var/lib/node-exporter/textfile-collector/rsyslog_pstats.prom</code> so that they can be collected by the <code>node-exporter</code>.</li><li>As part of the Shoot reconciliation, before the shoot-rsyslog-relp extension is deployed, the gardenlet copies all Secret and ConfigMap resources referenced in <code>.spec.resources[]</code> to the Shoot&rsquo;s control plane namespace on the Seed.
When the <code>.tls.enabled</code> field is <code>true</code> in the shoot-rsyslog-relp extension configuration, a value for <code>.tls.secretReferenceName</code> must also be specified so that it references a <a href=https://github.com/gardener/gardener/blob/v1.82.0/pkg/apis/core/v1beta1/types_shoot.go#L487>named resource reference</a> in the Shoot&rsquo;s <code>.spec.resources[]</code> array.
The webhook appends the data of the referenced Secret in the Shoot&rsquo;s control plane namespace to the OperatingSystemConfig files.</li><li>The webhook appends the <code>rsyslog-configurator.service</code> unit to the OperatingSystemConfig units. The unit invokes the <code>configure-rsyslog.sh</code> script every 15 seconds.</li></ol></li></ol><h3 id=extension-disablement>Extension Disablement<a class=td-heading-self-link href=#extension-disablement aria-label="Heading self-link"></a></h3><p>This section outlines how the extension disablement works, i.e., the extension has to be removed from the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, the gardenlet destroys the <a href=https://github.com/gardener/gardener/blob/v1.82.0/docs/extensions/extension.md>Extension</a> resource because it is no longer needed.<ol><li>As part of the deletion flow, the shoot-rsyslog-relp extension deploys the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/component/rsyslogrelpconfigcleaner/rsyslog_relp_config_cleaner.go><code>rsyslog-relp-configuration-cleaner</code> DaemonSet</a> to the Shoot cluster to clean up the existing rsyslog configuration and revert the audit rules.</li></ol></li></ol><h2 id=shoot-deletion>Shoot Deletion<a class=td-heading-self-link href=#shoot-deletion aria-label="Heading self-link"></a></h2><p>This section outlines how the deletion works for a Shoot with the shoot-rsyslog-relp extension enabled.</p><ol><li>As part of the Shoot deletion flow, the gardenlet destroys the <a href=https://github.com/gardener/gardener/blob/v1.82.0/docs/extensions/extension.md>Extension</a> resource.<ol><li>In the Shoot deletion flow, the Extension resource is deleted after the Worker resource. Hence, there is no need to deploy the <a href=https://github.com/gardener/gardener-extension-shoot-rsyslog-relp/blob/main/pkg/component/rsyslogrelpconfigcleaner/rsyslog_relp_config_cleaner.go><code>rsyslog-relp-configuration-cleaner</code> DaemonSet</a> to the Shoot cluster to clean up the existing rsyslog configuration and revert the audit rules.</li></ol></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-4872a011abb88ad2166ddf01e06b0631>5.7 - OpenID Connect services</h1><div class=lead>Gardener extension controller for OpenID Connect services for shoot clusters</div><h1 id=gardener-extension-for-openid-connect-serviceshttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for openid connect services</a><a class=td-heading-self-link href=#gardener-extension-for-openid-connect-serviceshttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-oidc-service><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-oidc-service alt="REUSE status"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the <code>shoot-oidc-service</code> extension.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-shoot-oidc-service/blob/master/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=compatibility>Compatibility<a class=td-heading-self-link href=#compatibility aria-label="Heading self-link"></a></h2><p>The following lists compatibility requirements of this extension controller with regards to other Gardener components.</p><table><thead><tr><th>OIDC Extension</th><th>Gardener</th><th>Notes</th></tr></thead><tbody><tr><td><code>== v0.15.0</code></td><td><code>>= 1.60.0 &lt;= v1.64.0</code></td><td>A typical side-effect when running Gardener &lt; v1.63.0 is an unexpected scale-down of the OIDC webhook from <code>2 -> 1</code>.</td></tr><tr><td><code>== v0.16.0</code></td><td><code>>= 1.65.0</code></td><td></td></tr></tbody></table><hr><h2 id=extension-resources>Extension Resources<a class=td-heading-self-link href=#extension-resources aria-label="Heading self-link"></a></h2><p>Example extension resource:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Extension
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-oidc-service
</span></span><span style=display:flex><span>  namespace: shoot--project--abc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: shoot-oidc-service
</span></span></code></pre></div><p>When an extension resource is reconciled, the extension controller will create an instance of <a href=https://github.com/gardener/oidc-webhook-authenticator>OIDC Webhook Authenticator</a>. These resources are placed inside the shoot namespace on the seed. Also, the controller takes care about generating necessary <code>RBAC</code> resources for the seed as well as for the shoot.</p><p>Please note, this extension controller relies on the <a href=/docs/gardener/concepts/resource-manager/>Gardener-Resource-Manager</a> to deploy k8s resources to seed and shoot clusters.</p><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>You can run the controller locally on your machine by executing <code>make start</code>.</p><p>We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-oidc-service/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-486a89ff012d57a06dd34631cf82838a>5.7.1 - Deployment</h1><h1 id=gardener-oidc-service-for-shoots>Gardener OIDC Service for Shoots<a class=td-heading-self-link href=#gardener-oidc-service-for-shoots aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener allows Shoot clusters to dynamically register OpenID Connect providers. To support this the Gardener must be installed with the <code>shoot-oidc-service</code> extension.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>To generally enable the OIDC service for shoot objects the <code>shoot-oidc-service</code> extension must be registered by providing an appropriate <a href=https://github.com/gardener/gardener-extension-shoot-oidc-service/blob/master/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots the <code>globallyEnabled</code> flag should be set to <code>true</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - kind: Extension
</span></span><span style=display:flex><span>      type: shoot-oidc-service
</span></span><span style=display:flex><span>      globallyEnabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h3><p>If the shoot OIDC service is not globally enabled by default (depends on the extension registration on the garden cluster), it can be enabled per shoot. To enable the service for a shoot, the shoot manifest must explicitly add the <code>shoot-oidc-service</code> extension.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-oidc-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>If the shoot OIDC service is globally enabled by default, it can be disabled per shoot. To disable the service for a shoot, the shoot manifest must explicitly state it.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-oidc-service
</span></span><span style=display:flex><span>      disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-22a2de35d1bea1230de182b1da4a55fc>5.7.2 - Openidconnects</h1><h1 id=register-openid-connect-provider-in-shoot-clusters>Register OpenID Connect provider in Shoot Clusters<a class=td-heading-self-link href=#register-openid-connect-provider-in-shoot-clusters aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Within a shoot cluster, it is possible to dynamically register OpenID Connect providers. It is necessary that the Gardener installation your shoot cluster runs in is equipped with a <code>shoot-oidc-service</code> extension. Please ask your Gardener operator if the extension is available in your environment.</p><blockquote class="alert alert-important"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>message-outline</title><path d="M20 2H4C2.9 2 2 2.9 2 4V22l4-4H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2m0 14H5.2L4 17.2V4H20V16z"/></svg><p>Important</p></div><p>Kubernetes v1.29 introduced support for <a href=https://kubernetes.io/blog/2024/04/25/structured-authentication-moves-to-beta/>Structured Authentication</a>.
Gardener allows the use of this feature for shoot clusters with Kubernetes version >= 1.30.</p><p>Structured Authentication should be preferred over the Gardener OIDC Extension in case:</p><ul><li>you do not need more than 64 authenticators (a limitation that is tracked in <a href=https://github.com/kubernetes/kubernetes/issues/122809>https://github.com/kubernetes/kubernetes/issues/122809</a>)</li><li>you do not need to register an issuer twice (anyways not recommended since it can lead to misconfiguration and user impersonation if done poorly)</li><li>you need the ability to write custom expressions to map and validate claims</li><li>you need support for multiple audiences per authenticator</li><li>you need support for providers that don&rsquo;t support OpenID connect discovery</li></ul><p>See how to make use of <a href=https://gardener.cloud/docs/gardener/shoot/shoot_access/#structured-authentication>Structured Authentication in Gardener</a>.</p></blockquote><h2 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h2><p>In most of the Gardener setups the <code>shoot-oidc-service</code> extension is not enabled globally and thus must be configured per shoot cluster. Please adapt the shoot specification by the configuration shown below to activate the extension individually.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-oidc-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h2 id=openid-connect-provider>OpenID Connect provider<a class=td-heading-self-link href=#openid-connect-provider aria-label="Heading self-link"></a></h2><p>In order to register an OpenID Connect provider an <code>openidconnect</code> resource should be deployed in the shoot cluster.</p><blockquote class="alert alert-caution"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-octagon-outline</title><path d="M8.27 3 3 8.27v7.46L8.27 21h7.46C17.5 19.24 21 15.73 21 15.73V8.27L15.73 3M9.1 5h5.8L19 9.1v5.8L14.9 19H9.1L5 14.9V9.1M11 15h2v2H11V15m0-8h2v6H11V7"/></svg><p>Caution</p></div><p>It is <strong>strongly</strong> recommended to <strong>NOT</strong> disable prefixing since it may result in unwanted impersonations.
The rule of thumb is to always use meaningful and unique prefixes for both <code>username</code> and <code>groups</code>.
A good way to ensure this is to use the name of the <code>openidconnect</code> resource as shown in the example below.</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: authentication.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: OpenIDConnect
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: abc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  <span style=color:green># issuerURL is the URL the provider signs ID Tokens as.</span>
</span></span><span style=display:flex><span>  <span style=color:green># This will be the &#34;iss&#34; field of all tokens produced by the provider and is used for configuration discovery.</span>
</span></span><span style=display:flex><span>  issuerURL: https://abc-oidc-provider.example
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># clientID is the audience for which the JWT must be issued for, the &#34;aud&#34; field.</span>
</span></span><span style=display:flex><span>  clientID: my-shoot-cluster
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># usernameClaim is the JWT field to use as the user&#39;s username.</span>
</span></span><span style=display:flex><span>  usernameClaim: sub
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># usernamePrefix, if specified, causes claims mapping to username to be prefix with the provided value.</span>
</span></span><span style=display:flex><span>  <span style=color:green># A value &#34;oidc:&#34; would result in usernames like &#34;oidc:john&#34;.</span>
</span></span><span style=display:flex><span>  <span style=color:green># If not provided, the prefix defaults to &#34;( .metadata.name )/&#34;. The value &#34;-&#34; can be used to disable all prefixing.</span>
</span></span><span style=display:flex><span>  usernamePrefix: <span style=color:#a31515>&#34;abc:&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># groupsClaim, if specified, causes the OIDCAuthenticator to try to populate the user&#39;s groups with an ID Token field.</span>
</span></span><span style=display:flex><span>  <span style=color:green># If the groupsClaim field is present in an ID Token the value must be a string or list of strings.</span>
</span></span><span style=display:flex><span>  <span style=color:green># groupsClaim: groups</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># groupsPrefix, if specified, causes claims mapping to group names to be prefixed with the value.</span>
</span></span><span style=display:flex><span>  <span style=color:green># A value &#34;oidc:&#34; would result in groups like &#34;oidc:engineering&#34; and &#34;oidc:marketing&#34;.</span>
</span></span><span style=display:flex><span>  <span style=color:green># If not provided, the prefix defaults to &#34;( .metadata.name )/&#34;.</span>
</span></span><span style=display:flex><span>  <span style=color:green># The value &#34;-&#34; can be used to disable all prefixing.</span>
</span></span><span style=display:flex><span>  <span style=color:green># groupsPrefix: &#34;abc:&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># caBundle is a PEM encoded CA bundle which will be used to validate the OpenID server&#39;s certificate. If unspecified, system&#39;s trusted certificates are used.</span>
</span></span><span style=display:flex><span>  <span style=color:green># caBundle: &lt;base64 encoded bundle&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># supportedSigningAlgs sets the accepted set of JOSE signing algorithms that can be used by the provider to sign tokens.</span>
</span></span><span style=display:flex><span>  <span style=color:green># The default value is RS256.</span>
</span></span><span style=display:flex><span>  <span style=color:green># supportedSigningAlgs:</span>
</span></span><span style=display:flex><span>  <span style=color:green># - RS256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># requiredClaims, if specified, causes the OIDCAuthenticator to verify that all the</span>
</span></span><span style=display:flex><span>  <span style=color:green># required claims key value pairs are present in the ID Token.</span>
</span></span><span style=display:flex><span>  <span style=color:green># requiredClaims:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   customclaim: requiredvalue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># maxTokenExpirationSeconds if specified, sets a limit in seconds to the maximum validity duration of a token.</span>
</span></span><span style=display:flex><span>  <span style=color:green># Tokens issued with validity greater that this value will not be verified.</span>
</span></span><span style=display:flex><span>  <span style=color:green># Setting this will require that the tokens have the &#34;iat&#34; and &#34;exp&#34; claims.</span>
</span></span><span style=display:flex><span>  <span style=color:green># maxTokenExpirationSeconds: 3600</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green># jwks if specified, provides an option to specify JWKS keys offline.</span>
</span></span><span style=display:flex><span>  <span style=color:green># jwks:</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   keys is a base64 encoded JSON webkey Set. If specified, the OIDCAuthenticator skips the request to the issuer&#39;s jwks_uri endpoint to retrieve the keys.</span>
</span></span><span style=display:flex><span>  <span style=color:green>#   keys: &lt;base64 encoded jwks&gt;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-a725bc0c0d89baaccba25cbb56b86675>5.8 - Registry cache</h1><div class=lead>Gardener extension controller which deploys pull-through caches for container registries.</div><h1 id=gardener-extension-for-registry-cachehttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Registry Cache</a><a class=td-heading-self-link href=#gardener-extension-for-registry-cachehttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-registry-cache><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-registry-cache alt="REUSE status"></a>
<a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-registry-cache-main/jobs/main-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-registry-cache-main/jobs/main-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-registry-cache><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-registry-cache alt="Go Report Card"></a></p><p>Gardener extension controller which deploys pull-through caches for container registries.</p><h2 id=usage>Usage<a class=td-heading-self-link href=#usage aria-label="Heading self-link"></a></h2><ul><li><a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/configuration/>Configuring the Registry Cache Extension</a> - learn what is the use-case for a pull-through cache, how to enable it and configure it</li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/upstream-credentials/>How to provide credentials for upstream repository?</a></li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/observability/>Registry Cache Observability</a> - learn what metrics and alerts are exposed and how to view the registry cache logs</li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/registry-mirror/configuration/>Configuring the Registry Mirror Extension</a> - learn what is the use-case for a registry mirror, how to enable and configure it</li></ul><h2 id=local-setup-and-development>Local Setup and Development<a class=td-heading-self-link href=#local-setup-and-development aria-label="Heading self-link"></a></h2><ul><li><a href=/docs/extensions/others/gardener-extension-registry-cache/getting-started-locally/>Deploying Registry Cache Extension Locally</a> - learn how to set up a local development environment</li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/getting-started-remotely/>Deploying Registry Cache Extension in Gardener&rsquo;s Local Setup with Provider Extensions</a> - learn how to set up a development environment using own Seed clusters on an existing Kubernetes cluster</li><li><a href=/docs/extensions/others/gardener-extension-registry-cache/extension-registry-cache/>Developer Docs for Gardener Extension Registry Cache</a> - learn about the inner workings</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b3f12d97b4af322636c2e0cc80685cc8>5.8.1 - Configuring the Registry Cache Extension</h1><div class=lead>Learn what is the use-case for a pull-through cache, how to enable it and configure it</div><h1 id=configuring-the-registry-cache-extension>Configuring the Registry Cache Extension<a class=td-heading-self-link href=#configuring-the-registry-cache-extension aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><h3 id=use-case>Use Case<a class=td-heading-self-link href=#use-case aria-label="Heading self-link"></a></h3><p>For a Shoot cluster, the containerd daemon of every Node goes to the internet and fetches an image that it doesn&rsquo;t have locally in the Node&rsquo;s image cache. New Nodes are often created due to events such as auto-scaling (scale up), rolling update, or replacement of unhealthy Node. Such a new Node would need to pull all of the images of the Pods running on it from the internet because the Node&rsquo;s cache is initially empty. Pulling an image from a registry produces network traffic and registry costs. To avoid these network traffic and registry costs, you can use the registry-cache extension to run a registry as pull-through cache.</p><p>The following diagram shows a rough outline of how an image pull looks like for a Shoot cluster <strong>without registry cache</strong>:
<img src=/__resources/shoot-cluster-without-registry-cache_e266ba.png alt=shoot-cluster-without-registry-cache></p><h3 id=solution>Solution<a class=td-heading-self-link href=#solution aria-label="Heading self-link"></a></h3><p>The registry-cache extension deploys and manages a registry in the Shoot cluster that runs as pull-through cache. The used registry implementation is <a href=https://github.com/distribution/distribution>distribution/distribution</a>.</p><h3 id=how-does-it-work>How does it work?<a class=td-heading-self-link href=#how-does-it-work aria-label="Heading self-link"></a></h3><p>When the extension is enabled, a registry cache for each configured upstream is deployed to the Shoot cluster. Along with this, the containerd daemon on the Shoot cluster Nodes gets configured to use as a mirror the Service IP address of the deployed registry cache. For example, if a registry cache for upstream <code>docker.io</code> is requested via the Shoot spec, then containerd gets configured to first pull the image from the deployed cache in the Shoot cluster. If this image pull operation fails, containerd falls back to the upstream itself (<code>docker.io</code> in that case).</p><p>The first time an image is requested from the pull-through cache, it pulls the image from the configured upstream registry and stores it locally, before handing it back to the client. On subsequent requests, the pull-through cache is able to serve the image from its own storage.</p><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>The used registry implementation (<a href=https://github.com/distribution/distribution>distribution/distribution</a>) supports mirroring of only one upstream registry.</p></blockquote><p>The following diagram shows a rough outline of how an image pull looks like for a Shoot cluster <strong>with registry cache</strong>:
<img src=/__resources/shoot-cluster-with-registry-cache_9e6b5f.png alt=shoot-cluster-with-registry-cache></p><h2 id=shoot-configuration>Shoot Configuration<a class=td-heading-self-link href=#shoot-configuration aria-label="Heading self-link"></a></h2><p>The extension is not globally enabled and must be configured per Shoot cluster. The Shoot specification has to be adapted to include the <code>registry-cache</code> extension configuration.</p><p>Below is an example of <code>registry-cache</code> extension configuration as part of the Shoot spec:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: crazy-botany
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: registry-cache
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: registry.extensions.gardener.cloud/v1alpha3
</span></span><span style=display:flex><span>      kind: RegistryConfig
</span></span><span style=display:flex><span>      caches:
</span></span><span style=display:flex><span>      - upstream: docker.io
</span></span><span style=display:flex><span>        volume:
</span></span><span style=display:flex><span>          size: 100Gi
</span></span><span style=display:flex><span>          <span style=color:green># storageClassName: premium</span>
</span></span><span style=display:flex><span>      - upstream: ghcr.io
</span></span><span style=display:flex><span>      - upstream: quay.io
</span></span><span style=display:flex><span>        garbageCollection:
</span></span><span style=display:flex><span>          ttl: 0s
</span></span><span style=display:flex><span>        secretReferenceName: quay-credentials
</span></span><span style=display:flex><span>      - upstream: my-registry.io:5000
</span></span><span style=display:flex><span>        remoteURL: http://my-registry.io:5000
</span></span><span style=display:flex><span>  <span style=color:green># ...</span>
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - name: quay-credentials
</span></span><span style=display:flex><span>    resourceRef:
</span></span><span style=display:flex><span>      apiVersion: v1
</span></span><span style=display:flex><span>      kind: Secret
</span></span><span style=display:flex><span>      name: quay-credentials-v1
</span></span></code></pre></div><p>The <code>providerConfig</code> field is required.</p><p>The <code>providerConfig.caches</code> field contains information about the registry caches to deploy. It is a required field. At least one cache has to be specified.</p><p>The <code>providerConfig.caches[].upstream</code> field is the remote registry host to cache. It is a required field.
The value must be a valid DNS subdomain (RFC 1123) and optionally a port (i.e. <code>&lt;host>[:&lt;port>]</code>). It must not include a scheme.</p><p>The <code>providerConfig.caches[].remoteURL</code> optional field is the remote registry URL. If configured, it must include an <code>https://</code> or <code>http://</code> scheme.
If the field is not configured, the remote registry URL defaults to <code>https://&lt;upstream></code>. In case the upstream is <code>docker.io</code>, it defaults to <code>https://registry-1.docker.io</code>.</p><p>The <code>providerConfig.caches[].volume</code> field contains settings for the registry cache volume.
The registry-cache extension deploys a StatefulSet with a volume claim template. A PersistentVolumeClaim is created with the configured size and StorageClass name.</p><p>The <code>providerConfig.caches[].volume.size</code> field is the size of the registry cache volume. Defaults to <code>10Gi</code>. The size must be a positive quantity (greater than 0).
This field is immutable. See <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/configuration/#increase-the-cache-disk-size>Increase the cache disk size</a> on how to resize the disk.
The extension defines alerts for the volume. More information about the registry cache alerts and how to enable notifications for them can be found in the <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/observability/#alerts>alerts documentation</a>.</p><p>The <code>providerConfig.caches[].volume.storageClassName</code> field is the name of the StorageClass used by the registry cache volume.
This field is immutable. If the field is not specified, then the <a href=https://kubernetes.io/docs/concepts/storage/storage-classes/#default-storageclass>default StorageClass</a> will be used.</p><p>The <code>providerConfig.caches[].garbageCollection.ttl</code> field is the time to live of a blob in the cache. If the field is set to <code>0s</code>, the garbage collection is disabled. Defaults to <code>168h</code> (7 days). See the <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/configuration/#garbage-collection>Garbage Collection section</a> for more details.</p><p>The <code>providerConfig.caches[].secretReferenceName</code> is the name of the reference for the Secret containing the upstream registry credentials. To cache images from a private registry, credentials to the upstream registry should be supplied. For more details, see <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/upstream-credentials/#how-to-provide-credentials-for-upstream-registry>How to provide credentials for upstream registry</a>.</p><blockquote class="alert alert-note"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>information-outline</title><path d="M11 9h2V7H11m1 13c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8M12 2A10 10 0 002 12 10 10 0 0012 22 10 10 0 0022 12 10 10 0 0012 2M11 17h2V11H11v6z"/></svg><p>Note</p></div><p>It is only possible to provide one set of credentials for one private upstream registry.</p></blockquote><p>The <code>providerConfig.caches[].proxy.httpProxy</code> field represents the proxy server for HTTP connections which is used by the registry cache. It must include an <code>https://</code> or <code>http://</code> scheme.</p><p>The <code>providerConfig.caches[].proxy.httpsProxy</code> field represents the proxy server for HTTPS connections which is used by the registry cache. It must include an <code>https://</code> or <code>http://</code> scheme.</p><p>The <code>providerConfig.caches[].http.tls</code> field indicates whether TLS is enabled for the HTTP server of the registry cache. Defaults to <code>true</code>.</p><h2 id=garbage-collection>Garbage Collection<a class=td-heading-self-link href=#garbage-collection aria-label="Heading self-link"></a></h2><p>When the registry cache receives a request for an image that is not present in its local store, it fetches the image from the upstream, returns it to the client and stores the image in the local store. The registry cache runs a scheduler that deletes images when their time to live (ttl) expires. When adding an image to the local store, the registry cache also adds a time to live for the image. The ttl defaults to <code>168h</code> (7 days) and is configurable. The garbage collection can be disabled by setting the ttl to <code>0s</code>. Requesting an image from the registry cache does not extend the time to live of the image. Hence, an image is always garbage collected from the registry cache store when its ttl expires.
At the time of writing this document, there is no functionality for garbage collection based on disk size - e.g., garbage collecting images when a certain disk usage threshold is passed.
The garbage collection cannot be enabled once it is disabled. This constraint is added to mitigate <a href=https://github.com/distribution/distribution/issues/4249>distribution/distribution#4249</a>.</p><h2 id=increase-the-cache-disk-size>Increase the Cache Disk Size<a class=td-heading-self-link href=#increase-the-cache-disk-size aria-label="Heading self-link"></a></h2><p>When there is no available disk space, the registry cache continues to respond to requests. However, it cannot store the remotely fetched images locally because it has no free disk space. In such case, it is simply acting as a proxy without being able to cache the images in its local store. The disk has to be resized to ensure that the registry cache continues to cache images.</p><p>There are two alternatives to enlarge the cache&rsquo;s disk size:</p><h3 id=alternative-1-resize-the-pvc>[Alternative 1] Resize the PVC<a class=td-heading-self-link href=#alternative-1-resize-the-pvc aria-label="Heading self-link"></a></h3><p>To enlarge the PVC&rsquo;s size, perform the following steps:</p><ol><li><p>Make sure that the <code>KUBECONFIG</code> environment variable is targeting the correct Shoot cluster.</p></li><li><p>Find the PVC name to resize for the desired upstream. The below example fetches the PVC for the <code>docker.io</code> upstream:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n kube-system get pvc -l upstream-host=docker.io
</span></span></code></pre></div></li><li><p>Patch the PVC&rsquo;s size to the desired size. The below example patches the size of a PVC to <code>10Gi</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n kube-system patch pvc $PVC_NAME --type merge -p <span style=color:#a31515>&#39;{&#34;spec&#34;:{&#34;resources&#34;:{&#34;requests&#34;: {&#34;storage&#34;: &#34;10Gi&#34;}}}}&#39;</span>
</span></span></code></pre></div></li><li><p>Make sure that the PVC gets resized. Describe the PVC to check the resize operation result:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n kube-system describe pvc -l upstream-host=docker.io
</span></span></code></pre></div></li></ol><blockquote><p>Drawback of this approach: The cache&rsquo;s size in the Shoot spec (<code>providerConfig.caches[].size</code>) diverges from the PVC&rsquo;s size.</p></blockquote><h3 id=alternative-2-remove-and-readd-the-cache>[Alternative 2] Remove and Readd the Cache<a class=td-heading-self-link href=#alternative-2-remove-and-readd-the-cache aria-label="Heading self-link"></a></h3><p>There is always the option to remove the cache from the Shoot spec and to readd it again with the updated size.</p><blockquote><p>Drawback of this approach: The already cached images get lost and the cache starts with an empty disk.</p></blockquote><h2 id=high-availability>High Availability<a class=td-heading-self-link href=#high-availability aria-label="Heading self-link"></a></h2><p>The registry cache runs with a single replica. This fact may lead to concerns for the high availability such as &ldquo;What happens when the registry cache is down? Does containerd fail to pull the image?&rdquo;. As outlined in the <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/configuration/#how-does-it-work>How does it work? section</a>, containerd is configured to fall back to the upstream registry if it fails to pull the image from the registry cache. Hence, when the registry cache is unavailable, the containerd&rsquo;s image pull operations are not affected because containerd falls back to image pull from the upstream registry.</p><h2 id=possible-pitfalls>Possible Pitfalls<a class=td-heading-self-link href=#possible-pitfalls aria-label="Heading self-link"></a></h2><ul><li>The used registry implementation (the <a href=https://github.com/distribution/distribution>Distribution project</a>) supports mirroring of only one upstream registry. The extension deploys a pull-through cache for each configured upstream.</li><li><code>us-docker.pkg.dev</code>, <code>europe-docker.pkg.dev</code>, and <code>asia-docker.pkg.dev</code> are different upstreams. Hence, configuring <code>pkg.dev</code> as upstream won&rsquo;t cache images from <code>us-docker.pkg.dev</code>, <code>europe-docker.pkg.dev</code>, or <code>asia-docker.pkg.dev</code>.</li></ul><h2 id=limitations>Limitations<a class=td-heading-self-link href=#limitations aria-label="Heading self-link"></a></h2><ol><li><p>Images that are pulled before a registry cache Pod is running or before a registry cache Service is reachable from the corresponding Node won&rsquo;t be cached - containerd will pull these images directly from the upstream.</p><p>The reasoning behind this limitation is that a registry cache Pod is running in the Shoot cluster. To have a registry cache&rsquo;s Service cluster IP reachable from containerd running on the Node, the registry cache Pod has to be running and kube-proxy has to configure iptables/IPVS rules for the registry cache Service. If kube-proxy hasn&rsquo;t configured iptables/IPVS rules for the registry cache Service, then the image pull times (and new Node bootstrap times) will be increased significantly. For more detailed explanations, see point 2. and <a href=https://github.com/gardener/gardener-extension-registry-cache/pull/68>gardener/gardener-extension-registry-cache#68</a>.</p><p>That&rsquo;s why the registry configuration on a Node is applied only after the registry cache Service is reachable from the Node. The <code>gardener-node-agent.service</code> systemd unit sends requests to the registry cache&rsquo;s Service. Once the registry cache responds with <code>HTTP 200</code>, the unit creates the needed registry configuration file (<code>hosts.toml</code>).</p><p>As a result, for images from Shoot system components:</p><ul><li>On Shoot creation with the registry cache extension enabled, a registry cache is unable to cache all of the images from the Shoot system components. Usually, until the registry cache Pod is running, containerd pulls from upstream the images from Shoot system components (before the registry configuration gets applied).</li><li>On new Node creation for existing Shoot with the registry cache extension enabled, a registry cache is unable to cache most of the images from Shoot system components. The reachability of the registry cache Service requires the Service network to be set up, i.e., the kube-proxy for that new Node to be running and to have set up iptables/IPVS configuration for the registry cache Service.</li></ul></li><li><p>containerd requests will time out in 30s in case kube-proxy hasn&rsquo;t configured iptables/IPVS rules for the registry cache Service - the image pull times will increase significantly.</p><p>containerd is configured to fall back to the upstream itself if a request against the cache fails. However, if the cluster IP of the registry cache Service does not exist or if kube-proxy hasn&rsquo;t configured iptables/IPVS rules for the registry cache Service, then containerd requests against the registry cache time out in 30 seconds. This significantly increases the image pull times because containerd does multiple requests as part of the image pull (HEAD request to resolve the manifest by tag, GET request for the manifest by SHA, GET requests for blobs)</p><p>Example: If the Service of a registry cache is deleted, then a new Service will be created. containerd&rsquo;s registry config will still contain the old Service&rsquo;s cluster IP. containerd requests against the old Service&rsquo;s cluster IP will time out and containerd will fall back to upstream.</p><ul><li>Image pull of <code>docker.io/library/alpine:3.13.2</code> from the upstream takes ~2s while image pull of the same image with invalid registry cache cluster IP takes ~2m.2s.</li><li>Image pull of <code>eu.gcr.io/gardener-project/gardener/ops-toolbelt:0.18.0</code> from the upstream takes ~10s while image pull of the same image with invalid registry cache cluster IP takes ~3m.10s.</li></ul></li><li><p>Amazon Elastic Container Registry is currently not supported. For details see <a href=https://github.com/distribution/distribution/issues/4383>distribution/distribution#4383</a>.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-5d2cb16601b6838a4a67ba8b5a7ae2f4>5.8.2 - Configuring the Registry Mirror Extension</h1><div class=lead>Learn what is the use-case for a registry mirror, how to enable and configure it</div><h1 id=configuring-the-registry-mirror-extension>Configuring the Registry Mirror Extension<a class=td-heading-self-link href=#configuring-the-registry-mirror-extension aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><h3 id=use-case>Use Case<a class=td-heading-self-link href=#use-case aria-label="Heading self-link"></a></h3><p>containerd allows registry mirrors to be configured. Use cases are:</p><ul><li>Usage of public mirror(s) - for example, circumvent issues with the upstream registry such as rate limiting, outages, and others.</li><li>Usage of private mirror(s) - for example, reduce network costs by using a private mirror running in the same network.</li></ul><h3 id=solution>Solution<a class=td-heading-self-link href=#solution aria-label="Heading self-link"></a></h3><p>The registry-mirror extension allows the registry mirror configuration to be configured via the Shoot spec directly.</p><h3 id=how-does-it-work>How does it work?<a class=td-heading-self-link href=#how-does-it-work aria-label="Heading self-link"></a></h3><p>When the extension is enabled, the containerd daemon on the Shoot cluster Nodes gets configured to use the requested mirrors as a mirror. For example, if for the upstream <code>docker.io</code> the mirror <code>https://mirror.gcr.io</code> is configured in the Shoot spec, then containerd gets configured to first pull the image from the mirror (<code>https://mirror.gcr.io</code> in that case). If this image pull operation fails, containerd falls back to the upstream itself (<code>docker.io</code> in that case).</p><p>The extension is based on the contract described in <a href=/docs/gardener/advanced/containerd-registry-configuration/><code>containerd</code> Registry Configuration</a>. The corresponding upstream documentation in containerd is <a href=https://github.com/containerd/containerd/blob/v1.7.0/docs/hosts.md>Registry Configuration - Introduction</a>.</p><h2 id=shoot-configuration>Shoot Configuration<a class=td-heading-self-link href=#shoot-configuration aria-label="Heading self-link"></a></h2><p>The Shoot specification has to be adapted to include the <code>registry-mirror</code> extension configuration.</p><p>Below is an example of <code>registry-mirror</code> extension configuration as part of the Shoot spec:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: crazy-botany
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: registry-mirror
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: mirror.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: MirrorConfig
</span></span><span style=display:flex><span>      mirrors:
</span></span><span style=display:flex><span>      - upstream: docker.io
</span></span><span style=display:flex><span>        hosts:
</span></span><span style=display:flex><span>        - host: <span style=color:#a31515>&#34;https://mirror.gcr.io&#34;</span>
</span></span><span style=display:flex><span>          capabilities: [<span style=color:#a31515>&#34;pull&#34;</span>]
</span></span></code></pre></div><p>The <code>providerConfig</code> field is required.</p><p>The <code>providerConfig.mirrors</code> field contains information about the registry mirrors to configure. It is a required field. At least one mirror has to be specified.</p><p>The <code>providerConfig.mirror[].upstream</code> field is the remote registry host to mirror. It is a required field.
The value must be a valid DNS subdomain (RFC 1123) and optionally a port (i.e. <code>&lt;host>[:&lt;port>]</code>). It must not include a scheme.</p><p>The <code>providerConfig.mirror[].hosts</code> field represents the mirror hosts to be used for the upstream. At least one mirror host has to be specified.</p><p>The <code>providerConfig.mirror[].hosts[].host</code> field is the mirror host. It is a required field.
The value must include a scheme - <code>http://</code> or <code>https://</code>.</p><p>The <code>providerConfig.mirror[].hosts[].capabilities</code> field represents the operations a host is capable of performing. This also represents the set of operations for which the mirror host may be trusted to perform. Defaults to <code>["pull"]</code>. The supported values are <code>pull</code> and <code>resolve</code>.
See the <a href=https://github.com/containerd/containerd/blob/v1.7.0/docs/hosts.md#capabilities-field>capabilities field documentation</a> for more information on which operations are considered trusted ones against public/private mirrors.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-279dc2188cd014dd3864f373e1503c87>5.8.3 - Deploying Registry Cache Extension in Gardener's Local Setup with Provider Extensions</h1><div class=lead>Learn how to set up a development environment using own Seed clusters on an existing Kubernetes cluster</div><h1 id=deploying-registry-cache-extension-in-gardeners-local-setup-with-provider-extensions>Deploying Registry Cache Extension in Gardener&rsquo;s Local Setup with Provider Extensions<a class=td-heading-self-link href=#deploying-registry-cache-extension-in-gardeners-local-setup-with-provider-extensions aria-label="Heading self-link"></a></h1><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>Make sure that you have a running local Gardener setup with enabled provider extensions. The steps to complete this can be found in the <a href=/docs/gardener/deployment/getting_started_locally_with_extensions/>Deploying Gardener Locally and Enabling Provider-Extensions</a> guide.</li></ul><h2 id=setting-up-the-registry-cache-extension>Setting up the Registry Cache Extension<a class=td-heading-self-link href=#setting-up-the-registry-cache-extension aria-label="Heading self-link"></a></h2><p>Make sure that your <code>KUBECONFIG</code> environment variable is targeting the local Gardener cluster.</p><p>The location of the Gardener project from the Gardener setup step is expected to be under the same root (e.g. <code>~/go/src/github.com/gardener/</code>). If this is not the case, the location of Gardener project should be specified in <code>GARDENER_REPO_ROOT</code> environment variable:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export GARDENER_REPO_ROOT=<span style=color:#a31515>&#34;&lt;path_to_gardener_project&gt;&#34;</span>
</span></span></code></pre></div><p>Then you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-up
</span></span></code></pre></div><p>In case you have added additional Seeds you can specify the seed name:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-up SEED_NAME=&lt;seed-name&gt;
</span></span></code></pre></div><p>The corresponding make target will build the extension image, push it into the Seed cluster image registry, and deploy the registry-cache ControllerDeployment and ControllerRegistration resources into the kind cluster.
The container image in the ControllerDeployment will be the image that was build and pushed into the Seed cluster image registry.</p><p>The make target will then deploy the registry-cache admission component. It will build the admission image, push it into the kind cluster image registry, and finally install the admission component charts to the kind cluster.</p><h2 id=creating-a-shoot-cluster>Creating a Shoot Cluster<a class=td-heading-self-link href=#creating-a-shoot-cluster aria-label="Heading self-link"></a></h2><p>Once the above step is completed, you can create a Shoot cluster. In order to create a Shoot cluster, please create your own Shoot definition depending on providers on your Seed cluster.</p><h2 id=tearing-down-the-development-environment>Tearing Down the Development Environment<a class=td-heading-self-link href=#tearing-down-the-development-environment aria-label="Heading self-link"></a></h2><p>To tear down the development environment, delete the Shoot cluster or disable the <code>registry-cache</code> extension in the Shoot&rsquo;s specification. When the extension is not used by the Shoot anymore, you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make remote-extension-down
</span></span></code></pre></div><p>The make target will delete the ControllerDeployment and ControllerRegistration of the extension, and the registry-cache admission helm deployment.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6292d6e3adb445c003eb0156582838fc>5.8.4 - Deploying Registry Cache Extension Locally</h1><div class=lead>Learn how to set up a local development environment</div><h1 id=deploying-registry-cache-extension-locally>Deploying Registry Cache Extension Locally<a class=td-heading-self-link href=#deploying-registry-cache-extension-locally aria-label="Heading self-link"></a></h1><h2 id=prerequisites>Prerequisites<a class=td-heading-self-link href=#prerequisites aria-label="Heading self-link"></a></h2><ul><li>Make sure that you have a running local Gardener setup. The steps to complete this can be found in the <a href=/docs/gardener/deployment/getting_started_locally/>Deploying Gardener Locally guide</a>.</li></ul><h2 id=setting-up-the-registry-cache-extension>Setting up the Registry Cache Extension<a class=td-heading-self-link href=#setting-up-the-registry-cache-extension aria-label="Heading self-link"></a></h2><p>Make sure that your <code>KUBECONFIG</code> environment variable is targeting the local Gardener cluster. When this is ensured, run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-up
</span></span></code></pre></div><p>The corresponding make target will build the extension image, load it into the kind cluster Nodes, and deploy the registry-cache ControllerDeployment and ControllerRegistration resources. The container image in the ControllerDeployment will be the image that was build and loaded into the kind cluster Nodes.</p><p>The make target will then deploy the registry-cache admission component. It will build the admission image, load it into the kind cluster Nodes, and finally install the admission component charts to the kind cluster.</p><h2 id=creating-a-shoot-cluster>Creating a Shoot Cluster<a class=td-heading-self-link href=#creating-a-shoot-cluster aria-label="Heading self-link"></a></h2><p>Once the above step is completed, you can create a Shoot cluster.</p><p><a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/example/shoot-registry-cache.yaml><code>example/shoot-registry-cache.yaml</code></a> contains a Shoot specification with the <code>registry-cache</code> extension:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f example/shoot-registry-cache.yaml
</span></span></code></pre></div><p><a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/example/shoot-registry-mirror.yaml><code>example/shoot-registry-mirror.yaml</code></a> contains a Shoot specification with the <code>registry-mirror</code> extension:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f example/shoot-registry-mirror.yaml
</span></span></code></pre></div><h2 id=tearing-down-the-development-environment>Tearing Down the Development Environment<a class=td-heading-self-link href=#tearing-down-the-development-environment aria-label="Heading self-link"></a></h2><p>To tear down the development environment, delete the Shoot cluster or disable the <code>registry-cache</code> extension in the Shoot&rsquo;s specification. When the extension is not used by the Shoot anymore, you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-down
</span></span></code></pre></div><p>The make target will delete the ControllerDeployment and ControllerRegistration of the extension, and the registry-cache admission helm deployment.</p><h2 id=alternative-setup-using-the-gardener-operator-local-setup>Alternative Setup Using the <code>gardener-operator</code> Local Setup<a class=td-heading-self-link href=#alternative-setup-using-the-gardener-operator-local-setup aria-label="Heading self-link"></a></h2><p>Alternatively, you can deploy the registry-cache extension in the <code>gardener-operator</code> local setup. To do this, make sure you are have a running local setup based on <a href=/docs/gardener/deployment/getting_started_locally/#alternative-way-to-set-up-garden-and-seed-leveraging-gardener-operator>Alternative Way to Set Up Garden and Seed Leveraging <code>gardener-operator</code></a>. The <code>KUBECONFIG</code> environment variable should target the operator local KinD cluster (i.e. <code>&lt;path_to_gardener_project>/example/gardener-local/kind/operator/kubeconfig</code>).</p><h4 id=creating-the-registry-cache-extensionoperatorgardenercloud-resource>Creating the registry-cache <code>Extension.operator.gardener.cloud</code> resource:<a class=td-heading-self-link href=#creating-the-registry-cache-extensionoperatorgardenercloud-resource aria-label="Heading self-link"></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-operator-up
</span></span></code></pre></div><p>The corresponding make target will build the registry-cache admission and extension container images, OCI artifacts for the admission runtime and application charts, and the extension chart. Then, the container images and the OCI artifacts are pushed into the default skaffold registry (i.e. <code>garden.local.gardener.cloud:5001</code>). Next, the registry-cache <code>Extension.operator.gardener.cloud</code> resource is deployed into the KinD cluster. Based on this resource the gardener-operator will deploy the registry-cache admission component, as well as the registry-cache ControllerDeployment and ControllerRegistration resources.</p><h4 id=creating-a-shoot-cluster-1>Creating a Shoot Cluster<a class=td-heading-self-link href=#creating-a-shoot-cluster-1 aria-label="Heading self-link"></a></h4><p>To create a Shoot cluster the <code>KUBECONFIG</code> environment variable should target virtual garden cluster (i.e. <code>&lt;path_to_gardener_project>/example/operator/virtual-garden/kubeconfig</code>) and then execute:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f example/shoot-registry-cache.yaml
</span></span></code></pre></div><h4 id=delete-the-registry-cache-extensionoperatorgardenercloud-resource>Delete the registry-cache <code>Extension.operator.gardener.cloud</code> resource<a class=td-heading-self-link href=#delete-the-registry-cache-extensionoperatorgardenercloud-resource aria-label="Heading self-link"></a></h4><p>Make sure the environment variable <code>KUBECONFIG</code> points to the operator&rsquo;s local KinD cluster and then run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-operator-down
</span></span></code></pre></div><p>The corresponding make target will delete the <code>Extension.operator.gardener.cloud</code> resource. Consequently, the gardener-operator will delete the registry-cache admission component and registry-cache ControllerDeployment and ControllerRegistration resources.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c7f55909c55d9671db41105c674d8223>5.8.5 - Developer Docs for Gardener Extension Registry Cache</h1><div class=lead>Learn about the inner workings</div><h1 id=developer-docs-for-gardener-extension-registry-cache>Developer Docs for Gardener Extension Registry Cache<a class=td-heading-self-link href=#developer-docs-for-gardener-extension-registry-cache aria-label="Heading self-link"></a></h1><p>This document outlines how Shoot reconciliation and deletion works for a Shoot with the registry-cache extension enabled.</p><h2 id=shoot-reconciliation>Shoot Reconciliation<a class=td-heading-self-link href=#shoot-reconciliation aria-label="Heading self-link"></a></h2><p>This section outlines how the reconciliation works for a Shoot with the registry-cache extension enabled.</p><h3 id=extension-enablement--reconciliation>Extension Enablement / Reconciliation<a class=td-heading-self-link href=#extension-enablement--reconciliation aria-label="Heading self-link"></a></h3><p>This section outlines how the extension enablement/reconciliation works, e.g., the extension has been added to the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, the gardenlet deploys the <a href=/docs/gardener/extensions/resources/extension/>Extension</a> resource.</li><li>The registry-cache extension reconciles the Extension resource. <a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/pkg/controller/cache/actuator.go>pkg/controller/cache/actuator.go</a> contains the implementation of the <a href=https://github.com/gardener/gardener/blob/v1.88.0/extensions/pkg/controller/extension/actuator.go>extension.Actuator</a> interface. The reconciliation of an Extension of type <code>registry-cache</code> consists of the following steps:<ol><li>The registry-cache extension deploys resources to the Shoot cluster via ManagedResource. For every configured upstream, it creates a StatefulSet (with PVC), Service, and other resources.</li><li>It lists all Services from the <code>kube-system</code> namespace that have the <code>upstream-host</code> label. It will return an error (and retry in exponential backoff) until the Services count matches the configured registries count.</li><li>When there is a Service created for each configured upstream registry, the registry-cache extension populates the Extension resource status. In the Extension status, for each upstream, it maintains an endpoint (in the format <code>http://&lt;cluster-ip>:5000</code>) which can be used to access the registry cache from within the Shoot cluster. <code>&lt;cluster-ip></code> is the cluster IP of the registry cache Service. The cluster IP of a Service is assigned by the Kubernetes API server on Service creation.</li></ol></li><li>As part of the Shoot reconciliation flow, the gardenlet deploys the <a href=/docs/gardener/extensions/resources/operatingsystemconfig/>OperatingSystemConfig</a> resource.</li><li>The registry-cache extension serves a webhook that mutates the OperatingSystemConfig resource for Shoots having the registry-cache extension enabled (the corresponding namespace gets labeled by the gardenlet with <code>extensions.gardener.cloud/registry-cache=true</code>). <a href=https://github.com/gardener/gardener-extension-registry-cache/blob/main/pkg/webhook/cache/ensurer.go>pkg/webhook/cache/ensurer.go</a> contains an implementation of the <a href=https://github.com/gardener/gardener/blob/v1.88.0/extensions/pkg/webhook/controlplane/genericmutator/mutator.go>genericmutator.Ensurer</a> interface.<ol><li>The webhook appends or updates <code>RegistryConfig</code> entries in the <a href=/docs/gardener/extensions/resources/operatingsystemconfig/#cri-support>OperatingSystemConfig CRI</a> configuration that corresponds to configured registry caches in the Shoot. The <code>RegistryConfig</code> readiness probe is enabled so that <a href=/docs/gardener/concepts/node-agent/>gardener-node-agent</a> creates a <code>hosts.toml</code> containerd registry configuration file when all <code>RegistryConfig</code> hosts are reachable.</li></ol></li></ol><h3 id=extension-disablement>Extension Disablement<a class=td-heading-self-link href=#extension-disablement aria-label="Heading self-link"></a></h3><p>This section outlines how the extension disablement works, i.e., the extension has to be removed from the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, the gardenlet destroys the <a href=/docs/gardener/extensions/resources/extension/>Extension</a> resource because it is no longer needed.<ol><li>The extension deletes the ManagedResource containing the registry cache resources.</li><li>The OperatingSystemConfig resource will not be mutated and no <code>RegistryConfig</code> entries will be added or updated. The <a href=/docs/gardener/concepts/node-agent/>gardener-node-agent</a> detects that <code>RegistryConfig</code> entries have been removed or changed and deletes or updates corresponding <code>hosts.toml</code> configuration files under <code>/etc/containerd/certs.d</code> folder.</li></ol></li></ol><h2 id=shoot-deletion>Shoot Deletion<a class=td-heading-self-link href=#shoot-deletion aria-label="Heading self-link"></a></h2><p>This section outlines how the deletion works for a Shoot with the registry-cache extension enabled.</p><ol><li>As part of the Shoot deletion flow, the gardenlet destroys the <a href=/docs/gardener/extensions/resources/extension/>Extension</a> resource.<ol><li>The extension deletes the ManagedResource containing the registry cache resources.</li></ol></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-ec03b3bb47b090a3cb2f8a348465d050>5.8.6 - How to provide credentials for upstream registry?</h1><h1 id=how-to-provide-credentials-for-upstream-registry>How to provide credentials for upstream registry?<a class=td-heading-self-link href=#how-to-provide-credentials-for-upstream-registry aria-label="Heading self-link"></a></h1><p>In Kubernetes, to pull images from private container image registries you either have to specify an image pull Secret (see <a href=https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/>Pull an Image from a Private Registry</a>) or you have to configure the kubelet to dynamically retrieve credentials using a credential provider plugin (see <a href=https://kubernetes.io/docs/tasks/administer-cluster/kubelet-credential-provider/>Configure a kubelet image credential provider</a>). When pulling an image, the kubelet is providing the credentials to the CRI implementation. The CRI implementation uses the provided credentials against the upstream registry to pull the image.</p><p>The registry-cache extension is using the <a href=https://github.com/distribution/distribution>Distribution project</a> as pull through cache implementation. The Distribution project does not use the provided credentials from the CRI implementation while fetching an image from the upstream. Hence, the above-described scenarios such as configuring image pull Secret for a Pod or configuring kubelet credential provider plugins don&rsquo;t work out of the box with the pull through cache provided by the registry-cache extension.
Instead, the Distribution project supports configuring only one set of credentials for a given pull through cache instance (for a given upstream).</p><p>This document describe how to supply credentials for the private upstream registry in order to pull private image with the registry cache.</p><h2 id=how-to-configure-the-registry-cache-to-use-upstream-registry-credentials>How to configure the registry cache to use upstream registry credentials?<a class=td-heading-self-link href=#how-to-configure-the-registry-cache-to-use-upstream-registry-credentials aria-label="Heading self-link"></a></h2><ol><li><p>Create an immutable Secret with the upstream registry credentials in the Garden cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create -f - <span style=color:#a31515>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a31515>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#a31515>metadata:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  name: ro-docker-secret-v1
</span></span></span><span style=display:flex><span><span style=color:#a31515>  namespace: garden-dev
</span></span></span><span style=display:flex><span><span style=color:#a31515>type: Opaque
</span></span></span><span style=display:flex><span><span style=color:#a31515>immutable: true
</span></span></span><span style=display:flex><span><span style=color:#a31515>data:
</span></span></span><span style=display:flex><span><span style=color:#a31515>  username: $(echo -n $USERNAME | base64 -w0)
</span></span></span><span style=display:flex><span><span style=color:#a31515>  password: $(echo -n $PASSWORD | base64 -w0)
</span></span></span><span style=display:flex><span><span style=color:#a31515>EOF</span>
</span></span></code></pre></div><p>For Artifact Registry, the username is <code>_json_key</code> and the password is the service account key in JSON format. To base64 encode the service account key, copy it and run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo -n $SERVICE_ACCOUNT_KEY_JSON | base64 -w0
</span></span></code></pre></div></li><li><p>Add the newly created Secret as a reference to the Shoot spec, and then to the registry-cache extension configuration.</p><p>In the registry-cache configuration, set the <code>secretReferenceName</code> field. It should point to a resource reference under <code>spec.resources</code>. The resource reference itself points to the Secret in project namespace.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span><span style=color:green># ...</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: registry-cache
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: registry.extensions.gardener.cloud/v1alpha3
</span></span><span style=display:flex><span>      kind: RegistryConfig
</span></span><span style=display:flex><span>      caches:
</span></span><span style=display:flex><span>      - upstream: docker.io
</span></span><span style=display:flex><span>        secretReferenceName: docker-secret
</span></span><span style=display:flex><span>  <span style=color:green># ...</span>
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - name: docker-secret
</span></span><span style=display:flex><span>    resourceRef:
</span></span><span style=display:flex><span>      apiVersion: v1
</span></span><span style=display:flex><span>      kind: Secret
</span></span><span style=display:flex><span>      name: ro-docker-secret-v1
</span></span><span style=display:flex><span><span style=color:green># ...</span>
</span></span></code></pre></div></li></ol><blockquote class="alert alert-warning"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>alert-outline</title><path d="M12 2 1 21H23M12 6l7.53 13H4.47M11 10v4h2V10m-2 6v2h2V16"/></svg><p>Warning</p></div><p>Do not delete the referenced Secret when there is a Shoot still using it.</p></blockquote><h2 id=how-to-rotate-the-registry-credentials>How to rotate the registry credentials?<a class=td-heading-self-link href=#how-to-rotate-the-registry-credentials aria-label="Heading self-link"></a></h2><p>To rotate registry credentials perform the following steps:</p><ol><li>Generate a new pair of credentials in the cloud provider account. Do not invalidate the old ones.</li><li>Create a new Secret (e.g., <code>ro-docker-secret-v2</code>) with the newly generated credentials as described in step 1. in <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/upstream-credentials/#how-to-configure-the-registry-cache-to-use-upstream-registry-credentials>How to configure the registry cache to use upstream registry credentials?</a>.</li><li>Update the Shoot spec with newly created Secret as described in step 2. in <a href=/docs/extensions/others/gardener-extension-registry-cache/registry-cache/upstream-credentials/#how-to-configure-the-registry-cache-to-use-upstream-registry-credentials>How to configure the registry cache to use upstream registry credentials?</a>.</li><li>The above step will trigger a Shoot reconciliation. Wait for it to complete.</li><li>Make sure that the old Secret is no longer referenced by any Shoot cluster. Finally, delete the Secret containing the old credentials (e.g., <code>ro-docker-secret-v1</code>).</li><li>Delete the corresponding old credentials from the cloud provider account.</li></ol><h2 id=possible-pitfalls>Possible Pitfalls<a class=td-heading-self-link href=#possible-pitfalls aria-label="Heading self-link"></a></h2><ul><li>The registry cache is not protected by any authentication/authorization mechanism. The cached images (incl. private images) can be fetched from the registry cache without authentication/authorization. Note that the registry cache itself is not exposed publicly.</li><li>The registry cache provides the credentials for every request against the corresponding upstream. In some cases, misconfigured credentials can prevent the registry cache to pull even public images from the upstream (for example: invalid service account key for Artifact Registry). However, this behaviour is controlled by the server-side logic of the upstream registry.</li><li>Do not remove the image pull Secrets when configuring credentials for the registry cache. When the registry-cache is not available, containerd falls back to the upstream registry. containerd still needs the image pull Secret to pull the image and in this way to have the fallback mechanism working.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4343922c3fe104128e4a9eecfb15c364>5.8.7 - Observability</h1><h1 id=registry-cache-observability>Registry Cache Observability<a class=td-heading-self-link href=#registry-cache-observability aria-label="Heading self-link"></a></h1><p>The <code>registry-cache</code> extension exposes metrics for the registry caches running in the Shoot cluster so that they can be easily viewed by cluster owners and operators in the Shoot&rsquo;s Prometheus and Plutono instances. The exposed monitoring data provides an overview of the performance of the pull-through caches, including hit rate and network traffic data.</p><h2 id=metrics>Metrics<a class=td-heading-self-link href=#metrics aria-label="Heading self-link"></a></h2><p>A registry cache serves <a href=https://github.com/distribution/distribution/blob/v3.0.0-rc.3/registry/proxy/proxymetrics.go#L12-L21>several metrics</a>. The metrics are scraped by the <a href=/docs/gardener/monitoring/#shoot-prometheus>Shoot&rsquo;s Prometheus instance</a>.</p><p>The <code>Registry Caches</code> dashboard in the Shoot&rsquo;s Plutono instance contains several panels which are built using the registry cache metrics. From the <code>Registry</code> dropdown menu you can select the upstream for which you wish the metrics to be displayed (by default, metrics are summed for all upstream registries).</p><p>Following is a list of all exposed registry cache metrics. The <code>upstream_host</code> label can be used to determine the upstream host to which the metrics are related, while the <code>type</code> label can be used to determine weather the metric is for an image <code>blob</code> or an image <code>manifest</code>:</p><h4 id=registry_proxy_requests_total>registry_proxy_requests_total<a class=td-heading-self-link href=#registry_proxy_requests_total aria-label="Heading self-link"></a></h4><p>The number of total incoming request received.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id=registry_proxy_hits_total>registry_proxy_hits_total<a class=td-heading-self-link href=#registry_proxy_hits_total aria-label="Heading self-link"></a></h4><p>The number of total cache hits; i.e. the requested content exists in the registry cache&rsquo;s image store and it is served from there (upstream is not contacted at all for serving the requested content).</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id=registry_proxy_misses_total>registry_proxy_misses_total<a class=td-heading-self-link href=#registry_proxy_misses_total aria-label="Heading self-link"></a></h4><p>The number of total cache misses; i.e. the requested content does not exist in the registry cache&rsquo;s image store and it is fetched from the upstream.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id=registry_proxy_pulled_bytes_total>registry_proxy_pulled_bytes_total<a class=td-heading-self-link href=#registry_proxy_pulled_bytes_total aria-label="Heading self-link"></a></h4><p>The size of total bytes that the registry cache has pulled from the upstream.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id=registry_proxy_pushed_bytes_total>registry_proxy_pushed_bytes_total<a class=td-heading-self-link href=#registry_proxy_pushed_bytes_total aria-label="Heading self-link"></a></h4><p>The size of total bytes pushed to the registry cache&rsquo;s clients.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h2 id=alerts>Alerts<a class=td-heading-self-link href=#alerts aria-label="Heading self-link"></a></h2><p>There are two alerts defined for the registry cache <code>PersistentVolume</code> in the Shoot&rsquo;s Prometheus instance:</p><h4 id=registrycachepersistentvolumeusagecritical>RegistryCachePersistentVolumeUsageCritical<a class=td-heading-self-link href=#registrycachepersistentvolumeusagecritical aria-label="Heading self-link"></a></h4><p>This indicates that the registry cache <code>PersistentVolume</code> is almost full and less than 5% is free. When there is no available disk space, no new images will be cached. However, image pull operations are not affected. An alert is fired when the following expression evaluates to true:</p><pre tabindex=0><code>100 * (
 kubelet_volume_stats_available_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}
   /
 kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}
) &lt; 5
</code></pre><h4 id=registrycachepersistentvolumefullinfourdays>RegistryCachePersistentVolumeFullInFourDays<a class=td-heading-self-link href=#registrycachepersistentvolumefullinfourdays aria-label="Heading self-link"></a></h4><p>This indicates that the registry cache <code>PersistentVolume</code> is expected to fill up within four days based on recent sampling. An alert is fired when the following expression evaluates to true:</p><pre tabindex=0><code>100 * (
 kubelet_volume_stats_available_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}
   /
 kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}
) &lt; 15
and
predict_linear(kubelet_volume_stats_available_bytes{persistentvolumeclaim=~&#34;^cache-volume-registry-.+$&#34;}[30m], 4 * 24 * 3600) &lt;= 0
</code></pre><p>Users can subscribe to these alerts by following the Gardener <a href=/docs/gardener/monitoring/alerting/#alerting-for-users>alerting guide</a>.</p><h2 id=logging>Logging<a class=td-heading-self-link href=#logging aria-label="Heading self-link"></a></h2><p>To view the registry cache logs in Plutono, navigate to the <code>Explore</code> tab and select <code>vali</code> from the <code>Explore</code> dropdown menu. Afterwards enter the following <code>vali</code> query:</p><ul><li><code>{container_name="registry-cache"}</code> to view the logs for all registries.</li><li><code>{pod_name=~"registry-&lt;upstream_host>.+"}</code> to view the logs for specific upstream registry.</li></ul></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2025 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>