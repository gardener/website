<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.95.0"><link rel=canonical type=text/html href=https://gardener.cloud/docs/other-components/machine-controller-manager/operations/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/other-components/machine-controller-manager/operations/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Operations | Gardener</title><meta name=description content><meta property="og:title" content="Operations"><meta property="og:description" content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:type" content="website"><meta property="og:url" content="https://gardener.cloud/docs/other-components/machine-controller-manager/operations/"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Operations"><meta itemprop=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Operations"><meta name=twitter:description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><link rel=preload href=/scss/main.min.b5b806bb2cd9fe9ed809539377398aa9df0eb8ca0c983a6eae0b413d528d8f0e.css as=style><link href=/scss/main.min.b5b806bb2cd9fe9ed809539377398aa9df0eb8ca0c983a6eae0b413d528d8f0e.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7N3XF5XLGV"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7N3XF5XLGV",{anonymize_ip:!1})}</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.d154bfdd4adab8c18f7914fbe2331fe3.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/other-components/machine-controller-manager/operations/>Return to the regular view of this page</a>.</p></div><h1 class=title>Operations</h1><div class=content></div></div><div class=td-content><h1 id=pg-227cca7f320594f2f0d872cb0b5c89cb>1 - Deployment</h1><h1 id=deploying-the-machine-controller-manager-into-a-kubernetes-cluster>Deploying the Machine Controller Manager into a Kubernetes cluster</h1><ul><li><a href=#deploying-the-machine-controller-manager-into-a-kubernetes-cluster>Deploying the Machine Controller Manager into a Kubernetes cluster</a><ul><li><a href=#prepare-the-cluster>Prepare the cluster</a></li><li><a href=#build-the-docker-image>Build the Docker image</a></li><li><a href=#configuring-optional-parameters-while-deploying>Configuring optional parameters while deploying</a></li><li><a href=#usage>Usage</a></li></ul></li></ul><p>As already mentioned, the Machine Controller Manager is designed to run as controller in a Kubernetes cluster. The existing source code can be compiled and tested on a local machine as described in <a href=/docs/other-components/machine-controller-manager/development/local_setup/>Setting up a local development environment</a>. You can deploy the Machine Controller Manager using the steps described below.</p><h2 id=prepare-the-cluster>Prepare the cluster</h2><ul><li>Connect to the remote kubernetes cluster where you plan to deploy the Machine Controller Manager using the kubectl. Set the environment variable KUBECONFIG to the path of the yaml file containing the cluster info.</li><li>Now, create the required CRDs on the remote cluster using the following command,</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f kubernetes/crds
</span></span></code></pre></div><h2 id=build-the-docker-image>Build the Docker image</h2><blockquote><p>⚠️ Modify the <code>Makefile</code> to refer to your own registry.</p></blockquote><ul><li>Run the build which generates the binary to <code>bin/machine-controller-manager</code></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ make build
</span></span></code></pre></div><ul><li>Build docker image from latest compiled binary</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ make docker-image
</span></span></code></pre></div><ul><li>Push the last created docker image onto the online docker registry.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ make push
</span></span></code></pre></div><ul><li>Now you can deploy this docker image to your cluster. A <a href=https://github.com/gardener/machine-controller-manager/blob/master/kubernetes/deployment/out-of-tree/deployment.yaml>sample development file</a> is provided. By default, the deployment manages the cluster it is running in. Optionally, the kubeconfig could also be passed as a flag as described in <code>/kubernetes/deployment/out-of-tree/deployment.yaml</code>. This is done when you want your controller running outside the cluster to be managed from.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f kubernetes/deployment/out-of-tree/deployment.yaml
</span></span></code></pre></div><ul><li>Also deploy the required clusterRole and clusterRoleBindings</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f kubernetes/deployment/out-of-tree/clusterrole.yaml
</span></span><span style=display:flex><span>$ kubectl apply -f kubernetes/deployment/out-of-tree/clusterrolebinding.yaml
</span></span></code></pre></div><h2 id=configuring-optional-parameters-while-deploying>Configuring optional parameters while deploying</h2><p>Machine-controller-manager supports several configurable parameters while deploying. Refer to <a href=https://github.com/gardener/machine-controller-manager/blob/master/kubernetes/deployment/out-of-tree/deployment.yaml#L21-L30>the following lines</a>, to know how each parameter can be configured, and what it&rsquo;s purpose is for.</p><h2 id=usage>Usage</h2><p>To start using Machine Controller Manager, follow the links given at <a href=/docs/other-components/machine-controller-manager/>usage here</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6e8ec8f797bdf2a763e1eb51463d5a08>2 - Machine</h1><h1 id=creatingdeleting-machines-vm>Creating/Deleting machines (VM)</h1><ul><li><a href=#creatingdeleting-machines-vm>Creating/Deleting machines (VM)</a><ul><li><a href=#setting-up-your-usage-environment>Setting up your usage environment</a></li><li><a href=#important>Important :</a></li><li><a href=#creating-machine>Creating machine</a></li><li><a href=#inspect-status-of-machine>Inspect status of machine</a></li><li><a href=#delete-machine>Delete machine</a></li></ul></li></ul><h2 id=setting-up-your-usage-environment>Setting up your usage environment</h2><ul><li>Follow the <a href=/docs/other-components/machine-controller-manager/operations/prerequisite/>steps described here</a></li></ul><h2 id=important->Important :</h2><blockquote><p>Make sure that the <code>kubernetes/machine_objects/machine.yaml</code> points to the same class name as the <code>kubernetes/machine_classes/aws-machine-class.yaml</code>.</p></blockquote><blockquote><p>Similarly <code>kubernetes/machine_objects/aws-machine-class.yaml</code> secret name and namespace should be same as that mentioned in <code>kubernetes/secrets/aws-secret.yaml</code></p></blockquote><h2 id=creating-machine>Creating machine</h2><ul><li>Modify <code>kubernetes/machine_objects/machine.yaml</code> as per your requirement and create the VM as shown below:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f kubernetes/machine_objects/machine.yaml
</span></span></code></pre></div><p>You should notice that the Machine Controller Manager has immediately picked up your manifest and started to create a new machine by talking to the cloud provider.</p><ul><li>Check Machine Controller Manager machines in the cluster</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get machine
</span></span><span style=display:flex><span>NAME           STATUS    AGE
</span></span><span style=display:flex><span>test-machine   Running   5m
</span></span></code></pre></div><p>A new machine is created with the name provided in the <code>kubernetes/machine_objects/machine.yaml</code> file.</p><ul><li>After a few minutes (~3 minutes for AWS), you should notice a new node joining the cluster. You can verify this by running:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get nodes
</span></span><span style=display:flex><span>NAME                                         STATUS     AGE     VERSION
</span></span><span style=display:flex><span>ip-10-250-14-52.eu-east-1.compute.internal.  Ready      1m      v1.8.0
</span></span></code></pre></div><p>This shows that a new node has successfully joined the cluster.</p><h2 id=inspect-status-of-machine>Inspect status of machine</h2><p>To inspect the status of any created machine, run the command given below.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get machine test-machine -o yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: machine.sapcloud.io/v1alpha1
</span></span><span style=display:flex><span>kind: Machine
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    kubectl.kubernetes.io/last-applied-configuration: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>      </span>      {<span style=color:#a31515>&#34;apiVersion&#34;</span>:<span style=color:#a31515>&#34;machine.sapcloud.io/v1alpha1&#34;</span>,<span style=color:#a31515>&#34;kind&#34;</span>:<span style=color:#a31515>&#34;Machine&#34;</span>,<span style=color:#a31515>&#34;metadata&#34;</span>:{<span style=color:#a31515>&#34;annotations&#34;</span>:{},<span style=color:#a31515>&#34;labels&#34;</span>:{<span style=color:#a31515>&#34;test-label&#34;</span>:<span style=color:#a31515>&#34;test-label&#34;</span>},<span style=color:#a31515>&#34;name&#34;</span>:<span style=color:#a31515>&#34;test-machine&#34;</span>,<span style=color:#a31515>&#34;namespace&#34;</span>:<span style=color:#a31515>&#34;&#34;</span>},<span style=color:#a31515>&#34;spec&#34;</span>:{<span style=color:#a31515>&#34;class&#34;</span>:{<span style=color:#a31515>&#34;kind&#34;</span>:<span style=color:#a31515>&#34;AWSMachineClass&#34;</span>,<span style=color:#a31515>&#34;name&#34;</span>:<span style=color:#a31515>&#34;test-aws&#34;</span>}}}
</span></span><span style=display:flex><span>  clusterName: <span style=color:#a31515>&#34;&#34;</span>
</span></span><span style=display:flex><span>  creationTimestamp: 2017-12-27T06:58:21Z
</span></span><span style=display:flex><span>  finalizers:
</span></span><span style=display:flex><span>  - machine.sapcloud.io/operator
</span></span><span style=display:flex><span>  generation: 0
</span></span><span style=display:flex><span>  initializers: <span style=color:#00f>null</span>
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    node: ip-10-250-14-52.eu-east-1.compute.internal
</span></span><span style=display:flex><span>    test-label: test-label
</span></span><span style=display:flex><span>  name: test-machine
</span></span><span style=display:flex><span>  namespace: <span style=color:#a31515>&#34;&#34;</span>
</span></span><span style=display:flex><span>  resourceVersion: <span style=color:#a31515>&#34;12616948&#34;</span>
</span></span><span style=display:flex><span>  selfLink: /apis/machine.sapcloud.io/v1alpha1/test-machine
</span></span><span style=display:flex><span>  uid: 535e596c-ead3-11e7-a6c0-828f843e4186
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  class:
</span></span><span style=display:flex><span>    kind: AWSMachineClass
</span></span><span style=display:flex><span>    name: test-aws
</span></span><span style=display:flex><span>  providerID: aws:///eu-east-1/i-00bef3f2618ffef23
</span></span><span style=display:flex><span>status:
</span></span><span style=display:flex><span>  conditions:
</span></span><span style=display:flex><span>  - lastHeartbeatTime: 2017-12-27T07:00:46Z
</span></span><span style=display:flex><span>    lastTransitionTime: 2017-12-27T06:59:16Z
</span></span><span style=display:flex><span>    message: kubelet has sufficient disk space available
</span></span><span style=display:flex><span>    reason: KubeletHasSufficientDisk
</span></span><span style=display:flex><span>    status: <span style=color:#a31515>&#34;False&#34;</span>
</span></span><span style=display:flex><span>    type: OutOfDisk
</span></span><span style=display:flex><span>  - lastHeartbeatTime: 2017-12-27T07:00:46Z
</span></span><span style=display:flex><span>    lastTransitionTime: 2017-12-27T06:59:16Z
</span></span><span style=display:flex><span>    message: kubelet has sufficient memory available
</span></span><span style=display:flex><span>    reason: KubeletHasSufficientMemory
</span></span><span style=display:flex><span>    status: <span style=color:#a31515>&#34;False&#34;</span>
</span></span><span style=display:flex><span>    type: MemoryPressure
</span></span><span style=display:flex><span>  - lastHeartbeatTime: 2017-12-27T07:00:46Z
</span></span><span style=display:flex><span>    lastTransitionTime: 2017-12-27T06:59:16Z
</span></span><span style=display:flex><span>    message: kubelet has no disk pressure
</span></span><span style=display:flex><span>    reason: KubeletHasNoDiskPressure
</span></span><span style=display:flex><span>    status: <span style=color:#a31515>&#34;False&#34;</span>
</span></span><span style=display:flex><span>    type: DiskPressure
</span></span><span style=display:flex><span>  - lastHeartbeatTime: 2017-12-27T07:00:46Z
</span></span><span style=display:flex><span>    lastTransitionTime: 2017-12-27T07:00:06Z
</span></span><span style=display:flex><span>    message: kubelet is posting ready status
</span></span><span style=display:flex><span>    reason: KubeletReady
</span></span><span style=display:flex><span>    status: <span style=color:#a31515>&#34;True&#34;</span>
</span></span><span style=display:flex><span>    type: Ready
</span></span><span style=display:flex><span>  currentStatus:
</span></span><span style=display:flex><span>    lastUpdateTime: 2017-12-27T07:00:06Z
</span></span><span style=display:flex><span>    phase: Running
</span></span><span style=display:flex><span>  lastOperation:
</span></span><span style=display:flex><span>    description: Machine is now ready
</span></span><span style=display:flex><span>    lastUpdateTime: 2017-12-27T07:00:06Z
</span></span><span style=display:flex><span>    state: Successful
</span></span><span style=display:flex><span>    type: Create
</span></span><span style=display:flex><span>  node: ip-10-250-14-52.eu-west-1.compute.internal
</span></span></code></pre></div><h2 id=delete-machine>Delete machine</h2><p>To delete the VM using the <code>kubernetes/machine_objects/machine.yaml</code> as shown below</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl delete -f kubernetes/machine_objects/machine.yaml
</span></span></code></pre></div><p>Now the Machine Controller Manager picks up the manifest immediately and starts to delete the existing VM by talking to the cloud provider. The node should be detached from the cluster in a few minutes (~1min for AWS).</p></div><div class=td-content style=page-break-before:always><h1 id=pg-da88ac1c86384ffd93401f00ca638fde>3 - Machine Deployment</h1><h1 id=maintaining-machine-replicas-using-machines-deployments>Maintaining machine replicas using machines-deployments</h1><ul><li><a href=#maintaining-machine-replicas-using-machines-deployments>Maintaining machine replicas using machines-deployments</a><ul><li><a href=#setting-up-your-usage-environment>Setting up your usage environment</a><ul><li><a href=#important-warning>Important ⚠️</a></li></ul></li><li><a href=#creating-machine-deployment>Creating machine-deployment</a></li><li><a href=#inspect-status-of-machine-deployment>Inspect status of machine-deployment</a></li><li><a href=#health-monitoring>Health monitoring</a></li><li><a href=#update-your-machines>Update your machines</a><ul><li><a href=#inspect-existing-cluster-configuration>Inspect existing cluster configuration</a></li><li><a href=#perform-a-rolling-update>Perform a rolling update</a></li><li><a href=#re-check-cluster-configuration>Re-check cluster configuration</a></li><li><a href=#more-variants-of-updates>More variants of updates</a></li></ul></li><li><a href=#undo-an-update>Undo an update</a></li><li><a href=#pause-an-update>Pause an update</a></li><li><a href=#delete-machine-deployment>Delete machine-deployment</a></li></ul></li></ul><h2 id=setting-up-your-usage-environment>Setting up your usage environment</h2><p>Follow the <a href=/docs/other-components/machine-controller-manager/operations/prerequisite/>steps described here</a></p><h3 id=important->Important ⚠️</h3><blockquote><p>Make sure that the <code>kubernetes/machine_objects/machine-deployment.yaml</code> points to the same class name as the <code>kubernetes/machine_classes/aws-machine-class.yaml</code>.</p></blockquote><blockquote><p>Similarly <code>kubernetes/machine_classes/aws-machine-class.yaml</code> secret name and namespace should be same as that mentioned in <code>kubernetes/secrets/aws-secret.yaml</code></p></blockquote><h2 id=creating-machine-deployment>Creating machine-deployment</h2><ul><li>Modify <code>kubernetes/machine_objects/machine-deployment.yaml</code> as per your requirement. Modify the number of replicas to the desired number of machines. Then, create an machine-deployment.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f kubernetes/machine_objects/machine-deployment.yaml
</span></span></code></pre></div><p>Now the Machine Controller Manager picks up the manifest immediately and starts to create a new machines based on the number of replicas you have provided in the manifest.</p><ul><li>Check Machine Controller Manager machine-deployments in the cluster</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get machinedeployment
</span></span><span style=display:flex><span>NAME                      READY   DESIRED   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>test-machine-deployment   3       3         3            0           10m
</span></span></code></pre></div><p>You will notice a new machine-deployment with your given name</p><ul><li>Check Machine Controller Manager machine-sets in the cluster</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get machineset
</span></span><span style=display:flex><span>NAME                                 DESIRED   CURRENT   READY   AGE
</span></span><span style=display:flex><span>test-machine-deployment-5bc6dd7c8f   3         3         0       10m
</span></span></code></pre></div><p>You will notice a new machine-set backing your machine-deployment</p><ul><li>Check Machine Controller Manager machines in the cluster</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get machine
</span></span><span style=display:flex><span>NAME                                       STATUS    AGE
</span></span><span style=display:flex><span>test-machine-deployment-5bc6dd7c8f-5d24b   Pending   5m
</span></span><span style=display:flex><span>test-machine-deployment-5bc6dd7c8f-6mpn4   Pending   5m
</span></span><span style=display:flex><span>test-machine-deployment-5bc6dd7c8f-dpt2q   Pending   5m
</span></span></code></pre></div><p>Now you will notice N (number of replicas specified in the manifest) new machines whose name are prefixed with the machine-deployment object name that you created.</p><ul><li>After a few minutes (~3 minutes for AWS), you would see that new nodes have joined the cluster. You can see this using</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$  kubectl get nodes
</span></span><span style=display:flex><span>NAME                                          STATUS    AGE       VERSION
</span></span><span style=display:flex><span>ip-10-250-20-19.eu-west-1.compute.internal    Ready     1m        v1.8.0
</span></span><span style=display:flex><span>ip-10-250-27-123.eu-west-1.compute.internal   Ready     1m        v1.8.0
</span></span><span style=display:flex><span>ip-10-250-31-80.eu-west-1.compute.internal    Ready     1m        v1.8.0
</span></span></code></pre></div><p>This shows how new nodes have joined your cluster</p><h2 id=inspect-status-of-machine-deployment>Inspect status of machine-deployment</h2><p>To inspect the status of any created machine-deployment run the command below,</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get machinedeployment test-machine-deployment -o yaml
</span></span></code></pre></div><p>You should get the following output.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: machine.sapcloud.io/v1alpha1
</span></span><span style=display:flex><span>kind: MachineDeployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    deployment.kubernetes.io/revision: <span style=color:#a31515>&#34;1&#34;</span>
</span></span><span style=display:flex><span>    kubectl.kubernetes.io/last-applied-configuration: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>      </span>      {<span style=color:#a31515>&#34;apiVersion&#34;</span>:<span style=color:#a31515>&#34;machine.sapcloud.io/v1alpha1&#34;</span>,<span style=color:#a31515>&#34;kind&#34;</span>:<span style=color:#a31515>&#34;MachineDeployment&#34;</span>,<span style=color:#a31515>&#34;metadata&#34;</span>:{<span style=color:#a31515>&#34;annotations&#34;</span>:{},<span style=color:#a31515>&#34;name&#34;</span>:<span style=color:#a31515>&#34;test-machine-deployment&#34;</span>,<span style=color:#a31515>&#34;namespace&#34;</span>:<span style=color:#a31515>&#34;&#34;</span>},<span style=color:#a31515>&#34;spec&#34;</span>:{<span style=color:#a31515>&#34;minReadySeconds&#34;</span>:200,<span style=color:#a31515>&#34;replicas&#34;</span>:3,<span style=color:#a31515>&#34;selector&#34;</span>:{<span style=color:#a31515>&#34;matchLabels&#34;</span>:{<span style=color:#a31515>&#34;test-label&#34;</span>:<span style=color:#a31515>&#34;test-label&#34;</span>}},<span style=color:#a31515>&#34;strategy&#34;</span>:{<span style=color:#a31515>&#34;rollingUpdate&#34;</span>:{<span style=color:#a31515>&#34;maxSurge&#34;</span>:1,<span style=color:#a31515>&#34;maxUnavailable&#34;</span>:1},<span style=color:#a31515>&#34;type&#34;</span>:<span style=color:#a31515>&#34;RollingUpdate&#34;</span>},<span style=color:#a31515>&#34;template&#34;</span>:{<span style=color:#a31515>&#34;metadata&#34;</span>:{<span style=color:#a31515>&#34;labels&#34;</span>:{<span style=color:#a31515>&#34;test-label&#34;</span>:<span style=color:#a31515>&#34;test-label&#34;</span>}},<span style=color:#a31515>&#34;spec&#34;</span>:{<span style=color:#a31515>&#34;class&#34;</span>:{<span style=color:#a31515>&#34;kind&#34;</span>:<span style=color:#a31515>&#34;AWSMachineClass&#34;</span>,<span style=color:#a31515>&#34;name&#34;</span>:<span style=color:#a31515>&#34;test-aws&#34;</span>}}}}}
</span></span><span style=display:flex><span>  clusterName: <span style=color:#a31515>&#34;&#34;</span>
</span></span><span style=display:flex><span>  creationTimestamp: 2017-12-27T08:55:56Z
</span></span><span style=display:flex><span>  generation: 0
</span></span><span style=display:flex><span>  initializers: <span style=color:#00f>null</span>
</span></span><span style=display:flex><span>  name: test-machine-deployment
</span></span><span style=display:flex><span>  namespace: <span style=color:#a31515>&#34;&#34;</span>
</span></span><span style=display:flex><span>  resourceVersion: <span style=color:#a31515>&#34;12634168&#34;</span>
</span></span><span style=display:flex><span>  selfLink: /apis/machine.sapcloud.io/v1alpha1/test-machine-deployment
</span></span><span style=display:flex><span>  uid: c0b488f7-eae3-11e7-a6c0-828f843e4186
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  minReadySeconds: 200
</span></span><span style=display:flex><span>  replicas: 3
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      test-label: test-label
</span></span><span style=display:flex><span>  strategy:
</span></span><span style=display:flex><span>    rollingUpdate:
</span></span><span style=display:flex><span>      maxSurge: 1
</span></span><span style=display:flex><span>      maxUnavailable: 1
</span></span><span style=display:flex><span>    type: RollingUpdate
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      creationTimestamp: <span style=color:#00f>null</span>
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        test-label: test-label
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      class:
</span></span><span style=display:flex><span>        kind: AWSMachineClass
</span></span><span style=display:flex><span>        name: test-aws
</span></span><span style=display:flex><span>status:
</span></span><span style=display:flex><span>  availableReplicas: 3
</span></span><span style=display:flex><span>  conditions:
</span></span><span style=display:flex><span>  - lastTransitionTime: 2017-12-27T08:57:22Z
</span></span><span style=display:flex><span>    lastUpdateTime: 2017-12-27T08:57:22Z
</span></span><span style=display:flex><span>    message: Deployment has minimum availability.
</span></span><span style=display:flex><span>    reason: MinimumReplicasAvailable
</span></span><span style=display:flex><span>    status: <span style=color:#a31515>&#34;True&#34;</span>
</span></span><span style=display:flex><span>    type: Available
</span></span><span style=display:flex><span>  readyReplicas: 3
</span></span><span style=display:flex><span>  replicas: 3
</span></span><span style=display:flex><span>  updatedReplicas: 3
</span></span></code></pre></div><h2 id=health-monitoring>Health monitoring</h2><p>Health monitor is also applied similar to how it&rsquo;s described for <a href=/docs/other-components/machine-controller-manager/operations/machine_set/>machine-sets</a></p><h2 id=update-your-machines>Update your machines</h2><p>Let us consider the scenario where you wish to update all nodes of your cluster from t2.xlarge machines to m5.xlarge machines. Assume that your current <em>test-aws</em> has its <strong>spec.machineType: t2.xlarge</strong> and your deployment <em>test-machine-deployment</em> points to this AWSMachineClass.</p><h4 id=inspect-existing-cluster-configuration>Inspect existing cluster configuration</h4><ul><li>Check Nodes present in the cluster</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get nodes
</span></span><span style=display:flex><span>NAME                                          STATUS    AGE       VERSION
</span></span><span style=display:flex><span>ip-10-250-20-19.eu-west-1.compute.internal    Ready     1m        v1.8.0
</span></span><span style=display:flex><span>ip-10-250-27-123.eu-west-1.compute.internal   Ready     1m        v1.8.0
</span></span><span style=display:flex><span>ip-10-250-31-80.eu-west-1.compute.internal    Ready     1m        v1.8.0
</span></span></code></pre></div><ul><li>Check Machine Controller Manager machine-sets in the cluster. You will notice one machine-set backing your machine-deployment</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get machineset
</span></span><span style=display:flex><span>NAME                                 DESIRED   CURRENT   READY   AGE
</span></span><span style=display:flex><span>test-machine-deployment-5bc6dd7c8f   3         3         3       10m
</span></span></code></pre></div><ul><li>Login to your cloud provider (AWS). In the VM management console, you will find N VMs created of type t2.xlarge.</li></ul><h4 id=perform-a-rolling-update>Perform a rolling update</h4><p>To update this machine-deployment VMs to <code>m5.xlarge</code>, we would do the following:</p><ul><li>Copy your existing aws-machine-class.yaml</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp kubernetes/machine_classes/aws-machine-class.yaml kubernetes/machine_classes/aws-machine-class-new.yaml
</span></span></code></pre></div><ul><li>Modify aws-machine-class-new.yaml, and update its <em>metadata.name: test-aws2</em> and <em>spec.machineType: m5.xlarge</em></li><li>Now create this modified MachineClass</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f kubernetes/machine_classes/aws-machine-class-new.yaml
</span></span></code></pre></div><ul><li>Edit your existing machine-deployment</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl edit machinedeployment test-machine-deployment
</span></span></code></pre></div><ul><li>Update from <em>spec.template.spec.class.name: test-aws</em> to <em>spec.template.spec.class.name: test-aws2</em></li></ul><h4 id=re-check-cluster-configuration>Re-check cluster configuration</h4><p>After a few minutes (~3mins)</p><ul><li>Check nodes present in cluster now. They are different nodes.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get nodes
</span></span><span style=display:flex><span>NAME                                          STATUS    AGE       VERSION
</span></span><span style=display:flex><span>ip-10-250-11-171.eu-west-1.compute.internal   Ready     4m        v1.8.0
</span></span><span style=display:flex><span>ip-10-250-17-213.eu-west-1.compute.internal   Ready     5m        v1.8.0
</span></span><span style=display:flex><span>ip-10-250-31-81.eu-west-1.compute.internal    Ready     5m        v1.8.0
</span></span></code></pre></div><ul><li>Check Machine Controller Manager machine-sets in the cluster. You will notice two machine-sets backing your machine-deployment</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get machineset
</span></span><span style=display:flex><span>NAME                                 DESIRED   CURRENT   READY   AGE
</span></span><span style=display:flex><span>test-machine-deployment-5bc6dd7c8f   0         0         0       1h
</span></span><span style=display:flex><span>test-machine-deployment-86ff45cc5    3         3         3       20m
</span></span></code></pre></div><ul><li>Login to your cloud provider (AWS). In the VM management console, you will find N VMs created of type t2.xlarge in terminated state, and N new VMs of type m5.xlarge in running state.</li></ul><p>This shows how a rolling update of a cluster from nodes with t2.xlarge to m5.xlarge went through.</p><h4 id=more-variants-of-updates>More variants of updates</h4><ul><li>The above demonstration was a simple use case. This could be more complex like - updating the system disk image versions/ kubelet versions/ security patches etc.</li><li>You can also play around with the maxSurge and maxUnavailable fields in machine-deployment.yaml</li><li>You can also change the update strategy from rollingupdate to recreate</li></ul><h2 id=undo-an-update>Undo an update</h2><ul><li>Edit the existing machine-deployment</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl edit machinedeployment test-machine-deployment
</span></span></code></pre></div><ul><li>Edit the deployment to have this new field of <em>spec.rollbackTo.revision: 0</em> as shown as comments in <code>kubernetes/machine_objects/machine-deployment.yaml</code></li><li>This will undo your update to the previous version.</li></ul><h2 id=pause-an-update>Pause an update</h2><ul><li>You can also pause the update while update is going on by editing the existing machine-deployment</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl edit machinedeployment test-machine-deployment
</span></span></code></pre></div><ul><li><p>Edit the deployment to have this new field of <em>spec.paused: true</em> as shown as comments in <code>kubernetes/machine_objects/machine-deployment.yaml</code></p></li><li><p>This will pause the rollingUpdate if it&rsquo;s in process</p></li><li><p>To resume the update, edit the deployment as mentioned above and remove the field <em>spec.paused: true</em> updated earlier</p></li></ul><h2 id=delete-machine-deployment>Delete machine-deployment</h2><ul><li>To delete the VM using the <code>kubernetes/machine_objects/machine-deployment.yaml</code></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl delete -f kubernetes/machine_objects/machine-deployment.yaml
</span></span></code></pre></div><p>The Machine Controller Manager picks up the manifest and starts to delete the existing VMs by talking to the cloud provider. The nodes should be detached from the cluster in a few minutes (~1min for AWS).</p></div><div class=td-content style=page-break-before:always><h1 id=pg-42199c1438c8f192eebbcdc0c8efa41c>4 - Machine Set</h1><h1 id=maintaining-machine-replicas-using-machines-sets>Maintaining machine replicas using machines-sets</h1><ul><li><a href=#maintaining-machine-replicas-using-machines-sets>Maintaining machine replicas using machines-sets</a><ul><li><a href=#setting-up-your-usage-environment>Setting up your usage environment</a></li><li><a href=#important-warning>Important ⚠️</a></li><li><a href=#creating-machine-set>Creating machine-set</a></li><li><a href=#inspect-status-of-machine-set>Inspect status of machine-set</a></li><li><a href=#health-monitoring>Health monitoring</a></li><li><a href=#delete-machine-set>Delete machine-set</a></li></ul></li></ul><h2 id=setting-up-your-usage-environment>Setting up your usage environment</h2><ul><li>Follow the <a href=/docs/other-components/machine-controller-manager/operations/prerequisite/>steps described here</a></li></ul><h2 id=important->Important ⚠️</h2><blockquote><p>Make sure that the <code>kubernetes/machines_objects/machine-set.yaml</code> points to the same class name as the <code>kubernetes/machine_classes/aws-machine-class.yaml</code>.</p></blockquote><blockquote><p>Similarly <code>kubernetes/machine_classes/aws-machine-class.yaml</code> secret name and namespace should be same as that mentioned in <code>kubernetes/secrets/aws-secret.yaml</code></p></blockquote><h2 id=creating-machine-set>Creating machine-set</h2><ul><li>Modify <code>kubernetes/machine_objects/machine-set.yaml</code> as per your requirement. You can modify the number of replicas to the desired number of machines. Then, create an machine-set:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f kubernetes/machine_objects/machine-set.yaml
</span></span></code></pre></div><p>You should notice that the Machine Controller Manager has immediately picked up your manifest and started to create a new machines based on the number of replicas you have provided in the manifest.</p><ul><li>Check Machine Controller Manager machine-sets in the cluster</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get machineset
</span></span><span style=display:flex><span>NAME               DESIRED   CURRENT   READY   AGE
</span></span><span style=display:flex><span>test-machine-set   3         3         0       1m
</span></span></code></pre></div><p>You will see a new machine-set with your given name</p><ul><li>Check Machine Controller Manager machines in the cluster:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get machine
</span></span><span style=display:flex><span>NAME                     STATUS    AGE
</span></span><span style=display:flex><span>test-machine-set-b57zs   Pending   5m
</span></span><span style=display:flex><span>test-machine-set-c4bg8   Pending   5m
</span></span><span style=display:flex><span>test-machine-set-kvskg   Pending   5m
</span></span></code></pre></div><p>Now you will see N (number of replicas specified in the manifest) new machines whose names are prefixed with the machine-set object name that you created.</p><ul><li>After a few minutes (~3 minutes for AWS), you should notice new nodes joining the cluster. You can verify this by running:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get nodes
</span></span><span style=display:flex><span>NAME                                         STATUS    AGE       VERSION
</span></span><span style=display:flex><span>ip-10-250-0-234.eu-west-1.compute.internal   Ready     3m        v1.8.0
</span></span><span style=display:flex><span>ip-10-250-15-98.eu-west-1.compute.internal   Ready     3m        v1.8.0
</span></span><span style=display:flex><span>ip-10-250-6-21.eu-west-1.compute.internal    Ready     2m        v1.8.0
</span></span></code></pre></div><p>This shows how new nodes have joined your cluster</p><h2 id=inspect-status-of-machine-set>Inspect status of machine-set</h2><ul><li>To inspect the status of any created machine-set run the following command:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get machineset test-machine-set -o yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: machine.sapcloud.io/v1alpha1
</span></span><span style=display:flex><span>kind: MachineSet
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    kubectl.kubernetes.io/last-applied-configuration: |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>      </span>      {<span style=color:#a31515>&#34;apiVersion&#34;</span>:<span style=color:#a31515>&#34;machine.sapcloud.io/v1alpha1&#34;</span>,<span style=color:#a31515>&#34;kind&#34;</span>:<span style=color:#a31515>&#34;MachineSet&#34;</span>,<span style=color:#a31515>&#34;metadata&#34;</span>:{<span style=color:#a31515>&#34;annotations&#34;</span>:{},<span style=color:#a31515>&#34;name&#34;</span>:<span style=color:#a31515>&#34;test-machine-set&#34;</span>,<span style=color:#a31515>&#34;namespace&#34;</span>:<span style=color:#a31515>&#34;&#34;</span>,<span style=color:#a31515>&#34;test-label&#34;</span>:<span style=color:#a31515>&#34;test-label&#34;</span>},<span style=color:#a31515>&#34;spec&#34;</span>:{<span style=color:#a31515>&#34;minReadySeconds&#34;</span>:200,<span style=color:#a31515>&#34;replicas&#34;</span>:3,<span style=color:#a31515>&#34;selector&#34;</span>:{<span style=color:#a31515>&#34;matchLabels&#34;</span>:{<span style=color:#a31515>&#34;test-label&#34;</span>:<span style=color:#a31515>&#34;test-label&#34;</span>}},<span style=color:#a31515>&#34;template&#34;</span>:{<span style=color:#a31515>&#34;metadata&#34;</span>:{<span style=color:#a31515>&#34;labels&#34;</span>:{<span style=color:#a31515>&#34;test-label&#34;</span>:<span style=color:#a31515>&#34;test-label&#34;</span>}},<span style=color:#a31515>&#34;spec&#34;</span>:{<span style=color:#a31515>&#34;class&#34;</span>:{<span style=color:#a31515>&#34;kind&#34;</span>:<span style=color:#a31515>&#34;AWSMachineClass&#34;</span>,<span style=color:#a31515>&#34;name&#34;</span>:<span style=color:#a31515>&#34;test-aws&#34;</span>}}}}}
</span></span><span style=display:flex><span>  clusterName: <span style=color:#a31515>&#34;&#34;</span>
</span></span><span style=display:flex><span>  creationTimestamp: 2017-12-27T08:37:42Z
</span></span><span style=display:flex><span>  finalizers:
</span></span><span style=display:flex><span>  - machine.sapcloud.io/operator
</span></span><span style=display:flex><span>  generation: 0
</span></span><span style=display:flex><span>  initializers: <span style=color:#00f>null</span>
</span></span><span style=display:flex><span>  name: test-machine-set
</span></span><span style=display:flex><span>  namespace: <span style=color:#a31515>&#34;&#34;</span>
</span></span><span style=display:flex><span>  resourceVersion: <span style=color:#a31515>&#34;12630893&#34;</span>
</span></span><span style=display:flex><span>  selfLink: /apis/machine.sapcloud.io/v1alpha1/test-machine-set
</span></span><span style=display:flex><span>  uid: 3469faaa-eae1-11e7-a6c0-828f843e4186
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  machineClass: {}
</span></span><span style=display:flex><span>  minReadySeconds: 200
</span></span><span style=display:flex><span>  replicas: 3
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      test-label: test-label
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      creationTimestamp: <span style=color:#00f>null</span>
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        test-label: test-label
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      class:
</span></span><span style=display:flex><span>        kind: AWSMachineClass
</span></span><span style=display:flex><span>        name: test-aws
</span></span><span style=display:flex><span>status:
</span></span><span style=display:flex><span>  availableReplicas: 3
</span></span><span style=display:flex><span>  fullyLabeledReplicas: 3
</span></span><span style=display:flex><span>  machineSetCondition: <span style=color:#00f>null</span>
</span></span><span style=display:flex><span>  lastOperation:
</span></span><span style=display:flex><span>    lastUpdateTime: <span style=color:#00f>null</span>
</span></span><span style=display:flex><span>  observedGeneration: 0
</span></span><span style=display:flex><span>  readyReplicas: 3
</span></span><span style=display:flex><span>  replicas: 3
</span></span></code></pre></div><h2 id=health-monitoring>Health monitoring</h2><ul><li>If you try to delete/terminate any of the machines backing the machine-set by either talking to the Machine Controller Manager or from the cloud provider, the Machine Controller Manager recreates a matching healthy machine to replace the deleted machine.</li><li>Similarly, if any of your machines are unreachable or in an unhealthy state (kubelet not ready / disk pressure) for longer than the configured timeout (~ 5mins), the Machine Controller Manager recreates the nodes to replace the unhealthy nodes.</li></ul><h2 id=delete-machine-set>Delete machine-set</h2><ul><li>To delete the VM using the <code>kubernetes/machine_objects/machine-set.yaml</code>:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl delete -f kubernetes/machine-set.yaml
</span></span></code></pre></div><p>Now the Machine Controller Manager has immediately picked up your manifest and started to delete the existing VMs by talking to the cloud provider. Your nodes should be detached from the cluster in a few minutes (~1min for AWS).</p></div><div class=td-content style=page-break-before:always><h1 id=pg-332d14c64a273da7528fad02b8806e65>5 - Prerequisite</h1><h1 id=setting-up-the-usage-environment>Setting up the usage environment</h1><ul><li><a href=#setting-up-the-usage-environment>Setting up the usage environment</a><ul><li><a href=#important-warning>Important ⚠️</a></li><li><a href=#set-kubeconfig>Set KUBECONFIG</a></li><li><a href=#replace-provider-credentials-and-desired-vm-configurations>Replace provider credentials and desired VM configurations</a></li><li><a href=#deploy-required-crds-and-objects>Deploy required CRDs and Objects</a></li><li><a href=#check-current-cluster-state>Check current cluster state</a></li></ul></li></ul><h2 id=important->Important ⚠️</h2><blockquote><p>All paths are relative to the root location of this project repository.</p></blockquote><blockquote><p>Run the Machine Controller Manager either as described in <a href=/docs/other-components/machine-controller-manager/development/local_setup/>Setting up a local development environment</a> or <a href=/docs/other-components/machine-controller-manager/operations/deployment/>Deploying the Machine Controller Manager into a Kubernetes cluster</a>.</p></blockquote><blockquote><p>Make sure that the following steps are run before managing machines/ machine-sets/ machine-deploys.</p></blockquote><h2 id=set-kubeconfig>Set KUBECONFIG</h2><p>Using the existing <a href=https://kubernetes.io/docs/tasks/access-application-cluster/authenticate-across-clusters-kubeconfig/>Kubeconfig</a>, open another Terminal panel/window with the <code>KUBECONFIG</code> environment variable pointing to this Kubeconfig file as shown below,</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ export KUBECONFIG=&lt;PATH_TO_REPO&gt;/dev/kubeconfig.yaml
</span></span></code></pre></div><h2 id=replace-provider-credentials-and-desired-vm-configurations>Replace provider credentials and desired VM configurations</h2><p>Open <code>kubernetes/machine_classes/aws-machine-class.yaml</code> and replace required values there with the desired VM configurations.</p><p>Similarily open <code>kubernetes/secrets/aws-secret.yaml</code> and replace - <em>userData, providerAccessKeyId, providerSecretAccessKey</em> with base64 encoded values of cloudconfig file, AWS access key id, and AWS secret access key respectively. Use the following command to get the base64 encoded value of your details</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo <span style=color:#a31515>&#34;sample-cloud-config&#34;</span> | base64
</span></span><span style=display:flex><span>base64-encoded-cloud-config
</span></span></code></pre></div><p>Do the same for your access key id and secret access key.</p><h2 id=deploy-required-crds-and-objects>Deploy required CRDs and Objects</h2><p>Create all the required CRDs in the cluster using <code>kubernetes/crds.yaml</code></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f kubernetes/crds.yaml
</span></span></code></pre></div><p>Create the class template that will be used as an machine template to create VMs using <code>kubernetes/machine_classes/aws-machine-class.yaml</code></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f kubernetes/machine_classes/aws-machine-class.yaml
</span></span></code></pre></div><p>Create the secret used for the cloud credentials and cloudconfig using <code>kubernetes/secrets/aws-secret.yaml</code></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -f kubernetes/secrets/aws-secret.yaml
</span></span></code></pre></div><h2 id=check-current-cluster-state>Check current cluster state</h2><p>Get to know the current cluster state using the following commands,</p><ul><li>Checking aws-machine-class in the cluster</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get awsmachineclass
</span></span><span style=display:flex><span>NAME       MACHINE TYPE   AMI          AGE
</span></span><span style=display:flex><span>test-aws   t2.large       ami-123456   5m
</span></span></code></pre></div><ul><li>Checking kubernetes secrets in the cluster</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get secret
</span></span><span style=display:flex><span>NAME                  TYPE                                  DATA      AGE
</span></span><span style=display:flex><span>test-secret           Opaque                                3         21h
</span></span></code></pre></div><ul><li>Checking kubernetes nodes in the cluster</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get nodes
</span></span></code></pre></div><p>Lists the default set of nodes attached to your cluster</p><ul><li>Checking Machine Controller Manager machines in the cluster</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get machine
</span></span><span style=display:flex><span>No resources found.
</span></span></code></pre></div><ul><li>Checking Machine Controller Manager machine-sets in the cluster</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get machineset
</span></span><span style=display:flex><span>No resources found.
</span></span></code></pre></div><ul><li>Checking Machine Controller Manager machine-deploys in the cluster</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get machinedeployment
</span></span><span style=display:flex><span>No resources found.
</span></span></code></pre></div></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2023 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid@8.13.4/dist/mermaid.min.js integrity="sha512-JERecFUBbsm75UpkVheAuDOE8NdHjQBrPACfEQYPwvPG+fjgCpHAz1Jw2ci9EXmd3DdfiWth3O3CQvcfEg8gsA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.7b24c0fb082ffb2de6cb14d6c95e9f8053053709ffcf8c761ef8e9ad2f8021e4.js integrity="sha256-eyTA+wgv+y3myxTWyV6fgFMFNwn/z4x2HvjprS+AIeQ=" crossorigin=anonymous></script></body></html>