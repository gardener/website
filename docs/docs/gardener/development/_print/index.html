<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.95.0"><link rel=canonical type=text/html href=https://gardener.cloud/docs/gardener/development/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/gardener/development/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Development | Gardener</title><meta name=description content><meta property="og:title" content="Development"><meta property="og:description" content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta property="og:type" content="website"><meta property="og:url" content="https://gardener.cloud/docs/gardener/development/"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Development"><meta itemprop=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Development"><meta name=twitter:description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><link rel=preload href=/scss/main.min.b5b806bb2cd9fe9ed809539377398aa9df0eb8ca0c983a6eae0b413d528d8f0e.css as=style><link href=/scss/main.min.b5b806bb2cd9fe9ed809539377398aa9df0eb8ca0c983a6eae0b413d528d8f0e.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7N3XF5XLGV"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7N3XF5XLGV",{anonymize_ip:!1})}</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.8b1951faffaf2026ea15beed28087bd1.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/gardener/development/>Return to the regular view of this page</a>.</p></div><h1 class=title>Development</h1><div class=content></div></div><div class=td-content><h1 id=pg-d3de31ca8fda3468ee64b931363985a9>1 - Changing the API</h1><h1 id=changing-the-api>Changing the API</h1><p>This document describes the steps that need to be performed when changing the API.
It provides guidance for API changes to both (Gardener system in general or component configurations).</p><p>Generally, as Gardener is a Kubernetes-native extension, it follows the same API conventions and guidelines like Kubernetes itself. The Kubernetes
<a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md>API Conventions</a> as well as <a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api_changes.md>Changing the API</a> topics already provide a good overview and general explanation of the basic concepts behind it.
We are following the same approaches.</p><h2 id=gardener-api>Gardener API</h2><p>The Gardener API is defined in the <code>pkg/apis/{core,extensions,settings}</code> directories and is the main point of interaction with the system.
It must be ensured that the API is always backwards-compatible.</p><h3 id=changing-the-api-1>Changing the API</h3><p><strong>Checklist</strong> when changing the API:</p><ol><li>Modify the field(s) in the respective Golang files of all external versions and the internal version.<ol><li>Make sure new fields are being added as &ldquo;optional&rdquo; fields, i.e., they are of pointer types, they have the <code>// +optional</code> comment, and they have the <code>omitempty</code> JSON tag.</li><li>Make sure that the existing field numbers in the protobuf tags are not changed.</li></ol></li><li>If necessary, implement/adapt the conversion logic defined in the versioned APIs (e.g., <code>pkg/apis/core/v1beta1/conversions*.go</code>).</li><li>If necessary, implement/adapt defaulting logic defined in the versioned APIs (e.g., <code>pkg/apis/core/v1beta1/defaults*.go</code>).</li><li>Run the code generation: <code>make generate</code></li><li>If necessary, implement/adapt validation logic defined in the internal API (e.g., <code>pkg/apis/core/validation/validation*.go</code>).</li><li>If necessary, adapt the exemplary YAML manifests of the Gardener resources defined in <code>example/*.yaml</code>.</li><li>In most cases, it makes sense to add/adapt the documentation for administrators/operators and/or end-users in the <code>docs</code> folder to provide information on purpose and usage of the added/changed fields.</li><li>When opening the pull request, always add a release note so that end-users are becoming aware of the changes.</li></ol><h3 id=removing-a-field>Removing a Field</h3><p>If fields shall be removed permanently from the API, then a proper deprecation period must be adhered to so that end-users have enough time to adapt their clients.</p><p>Once the deprecation period is over, the field should be dropped from the API in a two-step process, i.e., in two release cycles. In the first step, all the usages in the code base should be dropped. In the second step, the field should be dropped from API. We need to follow this two-step process cause there can be the case where <code>gardener-apiserver</code> is upgraded to a new version in which the field has been removed but other controllers are still on the old version of Gardener. This can lead to <code>nil</code> pointer exceptions or other unexpected behaviour.</p><p>The steps for removing a field from the code base is:</p><ol><li><p>The field in the external version(s) has to be commented out with appropriate doc string that the protobuf number of the corresponding field is reserved. Example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>-	SeedTemplate *gardencorev1beta1.SeedTemplate `json:&#34;seedTemplate,omitempty&#34; protobuf:&#34;bytes,2,opt,name=seedTemplate&#34;`
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>+	// SeedTemplate is tombstoned to show why 2 is reserved protobuf tag.
</span></span><span style=display:flex><span>+	// SeedTemplate *gardencorev1beta1.SeedTemplate `json:&#34;seedTemplate,omitempty&#34; protobuf:&#34;bytes,2,opt,name=seedTemplate&#34;`
</span></span></code></pre></div><p>The reasoning behind this is to prevent the same protobuf number being used by a new field. Introducing a new field with the same protobuf number would be a breaking change for clients still using the old protobuf definitions that have the old field for the given protobuf number.
The field in the internal version can be removed.</p></li><li><p>A unit test has to be added to make sure that a new field does not reuse the already reserved protobuf tag.</p></li></ol><p>Example of field removal can be found in the <a href=https://github.com/gardener/gardener/pull/6972>Remove <code>seedTemplate</code> field from ManagedSeed API</a> PR.</p><h2 id=component-configuration-apis>Component Configuration APIs</h2><p>Most Gardener components have a component configuration that follows similar principles to the Gardener API.
Those component configurations are defined in <code>pkg/{controllermanager,gardenlet,scheduler},pkg/apis/config</code>.
Hence, the above checklist also applies for changes to those APIs.
However, since these APIs are only used internally and only during the deployment of Gardener, the guidelines with respect to changes and backwards-compatibility are slightly relaxed.
If necessary, it is allowed to remove fields without a proper deprecation period if the release note uses the <code>breaking operator</code> keywords.</p><p>In addition to the above checklist:</p><ol><li>If necessary, then adapt the Helm chart of Gardener defined in <code>charts/gardener</code>. Adapt the <code>values.yaml</code> file as well as the manifest templates.</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-71a5b626648208e387c23def0d131cde>2 - Component Checklist</h1><h1 id=checklist-for-adding-new-components>Checklist For Adding New Components</h1><p>Adding new components that run in the garden, seed, or shoot cluster is theoretically quite simple - we just need a <code>Deployment</code> (or other similar workload resource), the respective container image, and maybe a bit of configuration.
In practice, however, there are a couple of things to keep in mind in order to make the deployment production-ready.
This document provides a checklist for them that you can walk through.</p><h2 id=general>General</h2><ol><li><p><strong>Avoid usage of Helm charts</strong> (<a href=https://github.com/gardener/gardener/tree/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/metricsserver>example</a>)</p><p>Nowadays, we use <a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/interfaces.go>Golang components</a> instead of Helm charts for deploying components to a cluster.
Please find a typical structure of such components in the provided <a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/metricsserver/metrics_server.go#L80-L97>metrics_server.go</a> file (configuration values are typically managed in a <code>Values</code> structure).
There are a few exceptions (e.g., <a href=https://github.com/gardener/gardener/tree/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/istio>Istio</a>) still using charts, however the default should be using a Golang-based implementation.
For the exceptional cases, use Golang&rsquo;s <a href=https://pkg.go.dev/embed>embed</a> package to embed the Helm chart directory (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/istio/istiod.go#L59-L60>example 1</a>, <a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/istio/istiod.go#L297-L313>example 2</a>).</p></li><li><p><strong>Choose the proper deployment way</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/kubescheduler/kube_scheduler.go#L212-L232>example 1 (direct application w/ client)</a>, <a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/kubescheduler/kube_scheduler.go#L447-L488>example 2 (using <code>ManagedResource</code>)</a>, <a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/kubestatemetrics/kube_state_metrics.go#L120>example 3 (mixed scenario)</a>)</p><p>For historic reasons, resources related to shoot control plane components are applied directly with the client.
All other resources (seed or shoot system components) are deployed via <code>gardener-resource-manager</code>&rsquo;s <a href=/docs/gardener/concepts/resource-manager/#managedresource-controller>Resource controller</a> (<code>ManagedResource</code>s) since it performs health checks out-of-the-box and has a lot of other features (see its documentation for more information).
Components that can run as both seed system component or shoot control plane component (e.g., VPA or <code>kube-state-metrics</code>) can make use of <a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/resourceconfig.go>these utility functions</a>.</p></li><li><p><strong>Do not hard-code container image references</strong> (<a href=https://github.com/gardener/gardener/blob/6a0fea86850ffec8937d1956bdf1a8ca6d074f3b/charts/images.yaml#L130-L133>example 1</a>, <a href=https://github.com/gardener/gardener/blob/6a0fea86850ffec8937d1956bdf1a8ca6d074f3b/pkg/operation/botanist/metricsserver.go#L28-L31>example 2</a>, <a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/metricsserver/metrics_server.go#L82-L83>example 3</a>)</p><p>We define all image references centrally in the <a href=https://github.com/gardener/gardener/blob/6a0fea86850ffec8937d1956bdf1a8ca6d074f3b/charts/images.yaml><code>charts/images.yaml</code></a> file.
Hence, the image references must not be hard-coded in the pod template spec but read from this so-called <a href=/docs/gardener/deployment/image_vector/>image vector</a> instead.</p></li><li><p><strong>Do not use container images from Docker Hub</strong> (example: <a href=https://github.com/gardener/gardener/blob/6f4e64fe9494cafb5c5da9a2c0a491a5690161b6/charts/images.yaml#L257-L260>image vector</a>, <a href=https://github.com/gardener/ci-infra/blob/92782bedd92815639abf4dc14b2c484f77c6e57d/config/images/images.yaml#L7-L10>prow configuration</a>)</p><p>The <code>docker.io</code> registry doesn&rsquo;t support pulling images over IPv6 (see <a href=https://www.docker.com/blog/beta-ipv6-support-on-docker-hub-registry/>Beta IPv6 Support on Docker Hub Registry</a>).
There is also a strict <a href=https://docs.docker.com/docker-hub/download-rate-limit/>rate-limit</a> that applies to the Docker Hub registry.
There is a <a href=https://github.com/gardener/ci-infra/blob/92782bedd92815639abf4dc14b2c484f77c6e57d/config/jobs/ci-infra/copy-images.yaml>prow job</a> copying images from Docker Hub that are needed in gardener components to the gardener GCR under the prefix <code>eu.gcr.io/gardener-project/3rd/</code> (see the <a href=https://github.com/gardener/ci-infra/tree/master/config/images>documentation</a> or <a href=https://github.com/gardener/ci-infra/issues/619>gardener/ci-infra#619</a>).
If you want to use a new image from Docker Hub or upgrade an already used image to a newer tag, please open a PR to the ci-infra repository that modifies the job&rsquo;s list of images to copy: <a href=https://github.com/gardener/ci-infra/blob/master/config/images/images.yaml><code>images.yaml</code></a>.</p></li><li><p><strong>Use unique <code>ConfigMap</code>s/<code>Secret</code>s</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/kubescheduler/kube_scheduler.go#L183-L190>example 1</a>, <a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/kubescheduler/kube_scheduler.go#L353>example 2</a>)</p><p><a href=https://kubernetes.io/docs/concepts/configuration/configmap/#configmap-immutable>Unique <code>ConfigMap</code>s/<code>Secret</code>s</a> are immutable for modification and have a unique name.
This has a couple of benefits, e.g. the <code>kubelet</code> doesn&rsquo;t watch these resources, and it is always clear which resource contains which data since it cannot be changed.
As a consequence, unique/immutable <code>ConfigMap</code>s/<code>Secret</code> are superior to checksum annotations on the pod templates.
Stale/unused <code>ConfigMap</code>s/<code>Secret</code>s are garbage-collected by <code>gardener-resource-manager</code>&rsquo;s <a href=/docs/gardener/concepts/resource-manager/#garbage-collector-for-immutable-configmapssecrets>GarbageCollector</a>.
There are utility functions (see examples above) for using unique <code>ConfigMap</code>s/<code>Secret</code>s in Golang components.
It is essential to inject the annotations into the workload resource to make the garbage-collection work.<br>Note that some <code>ConfigMap</code>s/<code>Secret</code>s should not be unique (e.g., those containing monitoring or logging configuration).
The reason is that the old revision stays in the cluster even if unused until the garbage-collector acts.
During this time, they would be wrongly aggregated to the full configuration.</p></li><li><p><strong>Manage certificates/secrets via <a href=https://github.com/gardener/gardener/tree/6a0fea86850ffec8937d1956bdf1a8ca6d074f3b/pkg/utils/secrets/manager>secrets manager</a></strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/metricsserver/metrics_server.go#L100-L109>example</a>)</p><p>You should use the <a href=/docs/gardener/development/secrets_management/>secrets manager</a> for the management of any kind of credentials.
This makes sure that credentials rotation works out-of-the-box without you requiring to think about it.
Generally, do not use client certificates (see the <a href=#security>Security section</a>).</p></li><li><p><strong>Consider hibernation when calculating replica count</strong> (<a href=https://github.com/gardener/gardener/blob/6a0fea86850ffec8937d1956bdf1a8ca6d074f3b/pkg/operation/botanist/kubescheduler.go#L36>example</a>)</p><p>Shoot clusters can be <a href=/docs/gardener/usage/shoot_hibernate/>hibernated</a> meaning that all control plane components in the shoot namespace in the seed cluster are scaled down to zero and all worker nodes are terminated.
If your component runs in the seed cluster then you have to consider this case and provide the proper replica count.
There is a utility function available (see example).</p></li><li><p><strong>Ensure task dependencies are as precise as possible in shoot flows</strong> (<a href=https://github.com/gardener/gardener/blob/6a0fea86850ffec8937d1956bdf1a8ca6d074f3b/pkg/gardenlet/controller/shoot/shoot/reconciler_reconcile.go#L508-L512>example 1</a>, <a href=https://github.com/gardener/gardener/blob/6a0fea86850ffec8937d1956bdf1a8ca6d074f3b/pkg/gardenlet/controller/shoot/shoot/reconciler_delete.go#L368-L372>example 2</a>)</p><p>Only define the minimum of needed dependency tasks in the <a href=https://github.com/gardener/gardener/tree/6a0fea86850ffec8937d1956bdf1a8ca6d074f3b/pkg/gardenlet/controller/shoot/shoot>shoot reconciliation/deletion flows</a>.</p></li><li><p><strong>Handle shoot system components</strong></p><p>Shoot system components deployed by <code>gardener-resource-manager</code> are labelled with <code>resource.gardener.cloud/managed-by: gardener</code>. This makes Gardener adding required label selectors and tolerations so that non-<code>DaemonSet</code> managed <code>Pod</code>s will exclusively run on selected nodes (for more information, see <a href=/docs/gardener/concepts/resource-manager/#system-components-webhook>System Components Webhook</a>).
<code>DaemonSet</code>s on the other hand, should generally tolerate any <code>NoSchedule</code> or <code>NoExecute</code> taints so that they can run on any <code>Node</code>, regardless of user added taints.</p></li></ol><h2 id=security>Security</h2><ol><li><p><strong>Use a <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/>dedicated <code>ServiceAccount</code></a> and disable auto-mount</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/metricsserver/metrics_server.go#L145-L151>example</a>)</p><p>Components that need to talk to the API server of their runtime cluster must always use a dedicated <code>ServiceAccount</code> (do not use <code>default</code>), with <code>automountServiceAccountToken</code> set to <code>false</code>.
This makes <code>gardener-resource-manager</code>&rsquo;s <a href=/docs/gardener/concepts/resource-manager/#tokeninvalidator>TokenInvalidator</a> invalidate the static token secret and its <a href=/docs/gardener/concepts/resource-manager/#auto-mounting-projected-serviceaccount-tokens><code>ProjectedTokenMount</code> webhook</a> inject a projected token automatically.</p></li><li><p><strong>Use shoot access tokens instead of a client certificates</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/kubescheduler/kube_scheduler.go#L234-L236>example</a>)</p><p>For components that need to talk to a target cluster different from their runtime cluster (e.g., running in seed cluster but talking to shoot) the <code>gardener-resource-manager</code>&rsquo;s <a href=/docs/gardener/concepts/resource-manager/#tokenrequestor>TokenRequestor</a> should be used to manage a so-called &ldquo;shoot access token&rdquo;.</p></li><li><p><strong>Define RBAC roles with minimal privileges</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/metricsserver/metrics_server.go#L153-L223>example</a>)</p><p>The component&rsquo;s <code>ServiceAccount</code> (if it exists) should have as little privileges as possible.
Consequently, please define proper <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>RBAC roles</a> for it.
This might include a combination of <code>ClusterRole</code>s and <code>Role</code>s.
Please do not provide elevated privileges due to laziness (e.g., because there is already a <code>ClusterRole</code> that can be extended vs. creating a <code>Role</code> only when access to a single namespace is needed).</p></li><li><p><strong>Use <a href=https://kubernetes.io/docs/concepts/services-networking/network-policies/><code>NetworkPolicy</code>s</a> to restrict network traffic</strong></p><p>You should restrict both ingress and egress traffic to/from your component as much as possible to ensure that it only gets access to/from other components if really needed.
Gardener provides a few default policies for typical usage scenarios. For more information, see <a href=/docs/gardener/usage/network_policies/><code>NetworkPolicy</code>s In Garden, Seed, Shoot Clusters</a>.</p></li><li><p><strong>Do not run components in privileged mode</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/nodelocaldns/nodelocaldns.go#L324-L328>example 1</a>, <a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/nodelocaldns/nodelocaldns.go#L501>example 2</a>)</p><p>Avoid running components with <code>privileged=true</code>. Instead, define the needed <a href=https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-capabilities-for-a-container>Linux capabilities</a>.</p></li><li><p><strong>Choose the proper Seccomp profile</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/nodelocaldns/nodelocaldns.go#L283-L287>example 1</a>, <a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/nginxingress/nginxingress.go#L447>example 2</a>)</p><p>The <a href=https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-the-seccomp-profile-for-a-container>Seccomp profile</a> will be defaulted by <code>gardener-resource-manager</code>&rsquo;s SeccompProfile webhook which works well for the majority of components.
However, in some special cases you might need to overwrite it.</p></li><li><p><strong>Define <code>PodSecurityPolicy</code>s</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/vpnshoot/vpnshoot.go#L341-L412>example</a>)</p><p><code>PodSecurityPolicy</code>s are deprecated, however Gardener still supports shoot clusters with older Kubernetes versions (<a href=/docs/gardener/usage/supported_k8s_versions/>ref</a>).
To make sure that such clusters can run with <code>.spec.kubernetes.allowPrivilegedContainers=false</code>, you have to define proper <code>PodSecurityPolicy</code>s.
For more information, see <a href=/docs/gardener/usage/pod-security/>Pod Security</a>.</p></li></ol><h2 id=high-availability--stability>High Availability / Stability</h2><ol><li><p><strong>Specify the component type label for high availability</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/kubescheduler/kube_scheduler.go#L241>example</a>)</p><p>To support high-availability deployments, <code>gardener-resource-manager</code>s <a href=/docs/gardener/concepts/resource-manager/#high-availability-config>HighAvailabilityConfig</a> webhook injects the proper specification like replica or topology spread constraints.
You only need to specify the type label. For more information, see <a href=/docs/gardener/development/high-availability/>High Availability Of Deployed Components</a>.</p></li><li><p><strong>Define a <code>PodDisruptionBudget</code></strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/metricsserver/metrics_server.go#L384-L408>example</a>)</p><p>Closely related to high availability but also to stability in general: The definition of a <a href=https://kubernetes.io/docs/tasks/run-application/configure-pdb/><code>PodDisruptionBudget</code></a> with <code>maxUnavailable=1</code> should be provided by default.</p></li><li><p><strong>Choose the right <code>PriorityClass</code></strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/kubescheduler/kube_scheduler.go#L307>example</a>)</p><p>Each cluster runs many components with different priorities.
Gardener provides a set of default <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/#priorityclass><code>PriorityClass</code>es</a>. For more information, see <a href=/docs/gardener/development/priority-classes/>Priority Classes</a>.</p></li><li><p><strong>Consider defining liveness and readiness probes</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/metricsserver/metrics_server.go#L321-L344>example</a>)</p><p>To ensure smooth rolling update behaviour, consider the definition of <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/>liveness and/or readiness probes</a>.</p></li><li><p><strong>Mark node-critical components</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/kubeproxy/resources.go#L328>example</a>)</p><p>To ensure user workload pods are only scheduled to <code>Nodes</code> where all node-critical components are ready, these components need to tolerate the <code>node.gardener.cloud/critical-components-not-ready</code> taint (<code>NoSchedule</code> effect).
Also, such <code>DaemonSets</code> and the included <code>PodTemplates</code> need to be labelled with <code>node.gardener.cloud/critical-component=true</code>.
For more information, see <a href=/docs/gardener/usage/node-readiness/>Readiness of Shoot Worker Nodes</a>.</p></li><li><p><strong>Consider making a <code>Service</code> topology-aware</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/vpa/admissioncontroller.go#L154>example</a>)</p><p>To reduce costs and to improve the network traffic latency in multi-zone Seed clusters, consider making a <code>Service</code> topology-aware, if applicable. In short, when a <code>Service</code> is topology-aware, Kubernetes routes network traffic to the <code>Endpoint</code>s (<code>Pod</code>s) which are located in the same zone where the traffic originated from. In this way, the cross availability zone traffic is avoided. See <a href=/docs/gardener/usage/topology_aware_routing/>Topology-Aware Traffic Routing</a>.</p></li></ol><h2 id=scalability>Scalability</h2><ol><li><p><strong>Provide resource requirements</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/metricsserver/metrics_server.go#L345-L353>example</a>)</p><p>All components should have <a href=https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits>resource requirements</a>.
Generally, they should always request CPU and memory, while only memory shall be limited (no CPU limits!).</p></li><li><p><strong>Define a <code>VerticalPodAutoscaler</code></strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/metricsserver/metrics_server.go#L416-L444>example</a>)</p><p>We typically perform vertical auto-scaling via the VPA managed by the <a href=https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler>Kubernetes community</a>.
Each component should have a respective <code>VerticalPodAutoscaler</code> with &ldquo;min allowed&rdquo; resources, &ldquo;auto update mode&rdquo;, and &ldquo;requests only&rdquo;-mode.
VPA is always enabled in garden or seed clusters, while it is optional for shoot clusters.</p></li><li><p><strong>Define a <code>HorizontalPodAutoscaler</code> if needed</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/coredns/coredns.go#L671-L726>example</a>)</p><p>If your component is capable of scaling horizontally, you should consider defining a <a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/><code>HorizontalPodAutoscaler</code></a>.</p></li></ol><h2 id=observability--operations-productivity>Observability / Operations Productivity</h2><ol><li><p><strong>Provide monitoring scrape config and alerting rules</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/coredns/monitoring.go>example 1</a>, <a href=https://github.com/gardener/gardener/blob/6a0fea86850ffec8937d1956bdf1a8ca6d074f3b/pkg/operation/botanist/monitoring.go#L97>example 2</a>)</p><p>Components should provide scrape configuration and alerting rules for Prometheus/Alertmanager if appropriate.
This should be done inside a dedicated <code>monitoring.go</code> file.
Extensions should follow the guidelines described in <a href=/docs/gardener/extensions/logging-and-monitoring/#extensions-monitoring-integration>Extensions Monitoring Integration</a>.</p></li><li><p><strong>Provide logging parsers and filters</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/coredns/logging.go>example 1</a>, <a href=https://github.com/gardener/gardener/blob/6a0fea86850ffec8937d1956bdf1a8ca6d074f3b/pkg/gardenlet/controller/seed/seed/reconciler_reconcile.go#L563>example 2</a>)</p><p>Components should provide parsers and filters for fluent-bit, if appropriate.
This should be done inside a dedicated <code>logging.go</code> file.
Extensions should follow the guidelines described in <a href=/docs/gardener/extensions/logging-and-monitoring/#fluent-bit-log-parsers-and-filters>Fluent-bit log parsers and filters</a>.</p></li><li><p><strong>Set the <code>revisionHistoryLimit</code> to <code>2</code> for <code>Deployment</code>s</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/metricsserver/metrics_server.go#L272>example</a>)</p><p>In order to allow easy inspection of two <code>ReplicaSet</code>s to quickly find the changes that lead to a rolling update, the <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#revision-history-limit>revision history limit</a> should be set to <code>2</code>.</p></li><li><p><strong>Define health checks</strong> (<a href=https://github.com/gardener/gardener/blob/6a0fea86850ffec8937d1956bdf1a8ca6d074f3b/pkg/operation/care/checker.go#L45-L71>example 1</a>, <a href=https://github.com/gardener/gardener/blob/6a0fea86850ffec8937d1956bdf1a8ca6d074f3b/pkg/operation/care/seed_health.go#L46-L54>example 2</a>)</p><p><code>gardenlet</code>&rsquo;s <a href=/docs/gardener/concepts/gardenlet/#controllers>care controllers</a> regularly check the health status of system or control plane components.
You need to enhance the lists of components to check if your component related to the seed system or shoot control plane (shoot system components are automatically checked via their respective <a href=/docs/gardener/concepts/resource-manager/#managedresource-controller><code>ManagedResource</code> conditions</a>), see examples above.</p></li><li><p><strong>Configure automatic restarts in shoot maintenance time window</strong> (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/kubescheduler/kube_scheduler.go#L250>example 1</a>, <a href=https://github.com/gardener/gardener/blob/6a0fea86850ffec8937d1956bdf1a8ca6d074f3b/pkg/operation/botanist/coredns.go#L90-L107>example 2</a>)</p><p>Gardener offers to restart components during the maintenance time window. For more information, see <a href=/docs/gardener/usage/shoot_maintenance/#restart-control-plane-controllers>Restart Control Plane Controllers</a> and <a href=/docs/gardener/usage/shoot_maintenance/#restart-some-core-addons>Restart Some Core Addons</a>.
You can consider adding the needed label to your control plane component to get this automatic restart (probably not needed for most components).</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-58950a0fdac8b00f91fdd5b644642c8f>3 - Dependencies</h1><h1 id=dependency-management>Dependency Management</h1><p>We are using <a href=https://github.com/golang/go/wiki/Modules>go modules</a> for depedency management.
In order to add a new package dependency to the project, you can perform <code>go get &lt;PACKAGE>@&lt;VERSION></code> or edit the <code>go.mod</code> file and append the package along with the version you want to use.</p><h2 id=updating-dependencies>Updating Dependencies</h2><p>The <code>Makefile</code> contains a rule called <code>revendor</code> which performs <code>go mod tidy</code> and <code>go mod vendor</code>:</p><ul><li><code>go mod tidy</code> makes sure <code>go.mod</code> matches the source code in the module. It adds any missing modules necessary to build the current module&rsquo;s packages and dependencies, and it removes unused modules that don&rsquo;t provide any relevant packages.</li><li><code>go mod vendor</code> resets the main module&rsquo;s vendor directory to include all packages needed to build and test all the main module&rsquo;s packages. It does not include test code for vendored packages.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make revendor
</span></span></code></pre></div><p>The dependencies are installed into the <code>vendor</code> folder, which <strong>should be added</strong> to the VCS.</p><p>⚠️ Make sure that you test the code after you have updated the dependencies!</p><h2 id=exported-packages>Exported Packages</h2><p>This repository contains several packages that could be considered &ldquo;exported packages&rdquo;, in a sense that they are supposed to be reused in other Go projects.
For example:</p><ul><li>Gardener&rsquo;s API packages: <code>pkg/apis</code></li><li>Library for building Gardener extensions: <code>extensions</code></li><li>Gardener&rsquo;s Test Framework: <code>test/framework</code></li></ul><p>There are a few more folders in this repository (non-Go sources) that are reused across projects in the Gardener organization:</p><ul><li>GitHub templates: <code>.github</code></li><li>Concourse / cc-utils related helpers: <code>hack/.ci</code></li><li>Development, build and testing helpers: <code>hack</code></li></ul><p>These packages feature a dummy <code>doc.go</code> file to allow other Go projects to pull them in as go mod dependencies.</p><p>These packages are explicitly <em>not</em> supposed to be used in other projects (consider them as &ldquo;non-exported&rdquo;):</p><ul><li>API validation packages: <code>pkg/apis/*/*/validation</code></li><li>Operation package (main Gardener business logic regarding <code>Seed</code> and <code>Shoot</code> clusters): <code>pkg/operation</code></li><li>Third party code: <code>third_party</code></li></ul><p>Currently, we don&rsquo;t have a mechanism yet for selectively syncing out these exported packages into dedicated repositories like kube&rsquo;s <a href=https://github.com/kubernetes/kubernetes/tree/master/staging>staging mechanism</a> (<a href=https://github.com/kubernetes/publishing-bot>publishing-bot</a>).</p><h2 id=import-restrictions>Import Restrictions</h2><p>We want to make sure that other projects can depend on this repository&rsquo;s &ldquo;exported&rdquo; packages without pulling in the entire repository (including &ldquo;non-exported&rdquo; packages) or a high number of other unwanted dependencies.
Hence, we have to be careful when adding new imports or references between our packages.</p><blockquote><p>ℹ️ General rule of thumb: the mentioned &ldquo;exported&rdquo; packages should be as self-contained as possible and depend on as few other packages in the repository and other projects as possible.</p></blockquote><p>In order to support that rule and automatically check compliance with that goal, we leverage <a href=https://github.com/kubernetes/code-generator/tree/master/cmd/import-boss>import-boss</a>.
The tool checks all imports of the given packages (including transitive imports) against rules defined in <code>.import-restrictions</code> files in each directory.
An import is allowed if it matches at least one allowed prefix and does not match any forbidden prefixes.</p><blockquote><p>Note: <code>''</code> (the empty string) is a prefix of everything.
For more details, see the <a href=https://github.com/kubernetes/code-generator/tree/master/cmd/import-boss/README.md>import-boss</a> topic.</p></blockquote><p><code>import-boss</code> is executed on every pull request and blocks the PR if it doesn&rsquo;t comply with the defined import restrictions.
You can also run it locally using <code>make check</code>.</p><p>Import restrictions should be changed in the following situations:</p><ul><li>We spot a new pattern of imports across our packages that was not restricted before but makes it more difficult for other projects to depend on our &ldquo;exported&rdquo; packages.
In that case, the imports should be further restricted to disallow such problematic imports, and the code/package structure should be reworked to comply with the newly given restrictions.</li><li>We want to share code between packages, but existing import restrictions prevent us from doing so.
In that case, please consider what additional dependencies it will pull in, when loosening existing restrictions.
Also consider possible alternatives, like code restructurings or extracting shared code into dedicated packages for minimal impact on dependent projects.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-94e3f754736ad20216bc6c1d11abac6f>4 - Getting Started Locally</h1><h1 id=developing-gardener-locally>Developing Gardener Locally</h1><p><a href=/docs/gardener/deployment/getting_started_locally/>This document</a> explains how to setup a kind based environment for developing Gardener locally.</p><p>For the best development experience you should especially check the <a href=/docs/gardener/deployment/getting_started_locally/#developing-gardener>Developing Gardener</a> section.</p><p>In case you plan a debugging session please check the <a href=/docs/gardener/deployment/getting_started_locally/#debugging-gardener>Debugging Gardener</a> section.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-98608cf34dc96853f47fc158ed5e0886>5 - High Availability</h1><h1 id=high-availability-of-deployed-components>High Availability of Deployed Components</h1><p><code>gardenlet</code>s and extension controllers are deploying components via <code>Deployment</code>s, <code>StatefulSet</code>s, etc., as part of the shoot control plane, or the seed or shoot system components.</p><p>Some of the above component deployments must be further tuned to improve fault tolerance / resilience of the service. This document outlines what needs to be done to achieve this goal.</p><p>Please be forwarded to the <a href=#convenient-application-of-these-rules>Convenient Application Of These Rules</a> section, if you want to take a shortcut to the list of actions that require developers&rsquo; attention.</p><h2 id=seed-clusters>Seed Clusters</h2><p>The worker nodes of seed clusters can be deployed to one or multiple availability zones.
The <code>Seed</code> specification allows you to provide the information which zones are available:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    region: europe-1
</span></span><span style=display:flex><span>    zones:
</span></span><span style=display:flex><span>    - europe-1a
</span></span><span style=display:flex><span>    - europe-1b
</span></span><span style=display:flex><span>    - europe-1c
</span></span></code></pre></div><p>Independent of the number of zones, seed system components like the <code>gardenlet</code> or the extension controllers themselves, or others like <code>etcd-druid</code>, <code>dependency-watchdog</code>, etc., should always be running with multiple replicas.</p><p>Concretely, all seed system components should respect the following conventions:</p><ul><li><p><strong>Replica Counts</strong></p><table><thead><tr><th>Component Type</th><th><code>&lt; 3</code> Zones</th><th><code>>= 3</code> Zones</th><th>Comment</th></tr></thead><tbody><tr><td>Observability (Monitoring, Logging)</td><td>1</td><td>1</td><td>Downtimes accepted due to cost reasons</td></tr><tr><td>Controllers</td><td>2</td><td>2</td><td>/</td></tr><tr><td>(Webhook) Servers</td><td>2</td><td>2</td><td>/</td></tr></tbody></table><p>Apart from the above, there might be special cases where these rules do not apply, for example:</p><ul><li><code>istio-ingressgateway</code> is scaled horizontally, hence the above numbers are the minimum values.</li><li><code>nginx-ingress-controller</code> in the seed cluster is used to advertise all shoot observability endpoints, so due to performance reasons it runs with <code>2</code> replicas at all times. In the future, this component might disappear in favor of the <code>istio-ingressgateway</code> anyways.</li></ul></li><li><p><strong>Topology Spread Constraints</strong></p><p>When the component has <code>>= 2</code> replicas &mldr;</p><ul><li><p>&mldr; then it should also have a <code>topologySpreadConstraint</code>, ensuring the replicas are spread over the nodes:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  topologySpreadConstraints:
</span></span><span style=display:flex><span>  - maxSkew: 1
</span></span><span style=display:flex><span>    topologyKey: kubernetes.io/hostname
</span></span><span style=display:flex><span>    whenUnsatisfiable: ScheduleAnyway
</span></span><span style=display:flex><span>    matchLabels: ...
</span></span></code></pre></div><p>Hence, the node spread is done on best-effort basis only.</p></li><li><p>&mldr; and the seed cluster has <code>>= 2</code> zones, then the component should also have a second <code>topologySpreadConstraint</code>, ensuring the replicas are spread over the zones:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  topologySpreadConstraints:
</span></span><span style=display:flex><span>  - maxSkew: 1
</span></span><span style=display:flex><span>    minDomains: 2 <span style=color:green># lower value of max replicas or number of zones</span>
</span></span><span style=display:flex><span>    topologyKey: topology.kubernetes.io/zone
</span></span><span style=display:flex><span>    whenUnsatisfiable: DoNotSchedule
</span></span><span style=display:flex><span>    matchLabels: ...
</span></span></code></pre></div></li></ul></li></ul><blockquote><p>According to these conventions, even seed clusters with only one availability zone try to be highly available &ldquo;as good as possible&rdquo; by spreading the replicas across multiple nodes.
Hence, while such seed clusters obviously cannot handle zone outages, they can at least handle node failures.</p></blockquote><h2 id=shoot-clusters>Shoot Clusters</h2><p>The <code>Shoot</code> specification allows configuring &ldquo;high availability&rdquo; as well as the failure tolerance type for the control plane components, see <a href=/docs/gardener/usage/shoot_high_availability/>Highly Available Shoot Control Plane</a> for details.</p><p>Regarding the seed cluster selection, the only constraint is that shoot clusters with failure tolerance type <code>zone</code> are only allowed to run on seed clusters with at least three zones.
All other shoot clusters (non-HA or those with failure tolerance type <code>node</code>) can run on seed clusters with any number of zones.</p><h3 id=control-plane-components>Control Plane Components</h3><p>All control plane components should respect the following conventions:</p><ul><li><p><strong>Replica Counts</strong></p><table><thead><tr><th>Component Type</th><th>w/o HA</th><th>w/ HA (<code>node</code>)</th><th>w/ HA (<code>zone</code>)</th><th>Comment</th></tr></thead><tbody><tr><td>Observability (Monitoring, Logging)</td><td>1</td><td>1</td><td>1</td><td>Downtimes accepted due to cost reasons</td></tr><tr><td>Controllers</td><td>1</td><td>2</td><td>2</td><td>/</td></tr><tr><td>(Webhook) Servers</td><td>2</td><td>2</td><td>2</td><td>/</td></tr></tbody></table><p>Apart from the above, there might be special cases where these rules do not apply, for example:</p><ul><li><code>etcd</code> is a server, though the most critical component of a cluster requiring a quorum to survive failures. Hence, it should have <code>3</code> replicas even when the failure tolerance is <code>node</code> only.</li><li><code>kube-apiserver</code> is scaled horizontally, hence the above numbers are the minimum values (even when the shoot cluster is not HA, there might be multiple replicas).</li></ul></li><li><p><strong>Topology Spread Constraints</strong></p><p>When the component has <code>>= 2</code> replicas &mldr;</p><ul><li><p>&mldr; then it should also have a <code>topologySpreadConstraint</code> ensuring the replicas are spread over the nodes:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  topologySpreadConstraints:
</span></span><span style=display:flex><span>  - maxSkew: 1
</span></span><span style=display:flex><span>    topologyKey: kubernetes.io/hostname
</span></span><span style=display:flex><span>    whenUnsatisfiable: ScheduleAnyway
</span></span><span style=display:flex><span>    matchLabels: ...
</span></span></code></pre></div><p>Hence, the node spread is done on best-effort basis only.</p><p>However, if the shoot cluster has defined a failure tolerance type, the <code>whenUnsafisfiable</code> field should be set to <code>DoNotSchedule</code>.</p></li><li><p>&mldr; and the failure tolerance type of the shoot cluster is <code>zone</code>, then the component should also have a second <code>topologySpreadConstraint</code> ensuring the replicas are spread over the zones:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  topologySpreadConstraints:
</span></span><span style=display:flex><span>  - maxSkew: 1
</span></span><span style=display:flex><span>    minDomains: 2 <span style=color:green># lower value of max replicas or number of zones</span>
</span></span><span style=display:flex><span>    topologyKey: topology.kubernetes.io/zone
</span></span><span style=display:flex><span>    whenUnsatisfiable: DoNotSchedule
</span></span><span style=display:flex><span>    matchLabels: ...
</span></span></code></pre></div></li></ul></li><li><p><strong>Node Affinity</strong></p><p>The <code>gardenlet</code> annotates the shoot namespace in the seed cluster with the <code>high-availability-config.resources.gardener.cloud/zones</code> annotation.</p><ul><li>If the shoot cluster is non-HA or has failure tolerance type <code>node</code>, then the value will be always exactly one zone (e.g., <code>high-availability-config.resources.gardener.cloud/zones=europe-1b</code>).</li><li>If the shoot cluster has failure tolerance type <code>zone</code>, then the value will always contain exactly three zones (e.g., <code>high-availability-config.resources.gardener.cloud/zones=europe-1a,europe-1b,europe-1c</code>).</li></ul><p>For backwards-compatibility, this annotation might contain multiple zones for shoot clusters created before <code>gardener/gardener@v1.60</code> and not having failure tolerance type <code>zone</code>.
This is because their volumes might already exist in multiple zones, hence pinning them to only one zone would not work.</p><p>Hence, in case this annotation is present, the components should have the following node affinity:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  affinity:
</span></span><span style=display:flex><span>    nodeAffinity:
</span></span><span style=display:flex><span>      requiredDuringSchedulingIgnoredDuringExecution:
</span></span><span style=display:flex><span>        nodeSelectorTerms:
</span></span><span style=display:flex><span>        - matchExpressions:
</span></span><span style=display:flex><span>          - key: topology.kubernetes.io/zone
</span></span><span style=display:flex><span>            operator: In
</span></span><span style=display:flex><span>            values:
</span></span><span style=display:flex><span>            - europe-1a
</span></span><span style=display:flex><span>          <span style=color:green># - ...</span>
</span></span></code></pre></div><p>This is to ensure all pods are running in the same (set of) availability zone(s) such that cross-zone network traffic is avoided as much as possible (such traffic is typically charged by the underlying infrastructure provider).</p></li></ul><h3 id=system-components>System Components</h3><p>The availability of system components is independent of the control plane since they run on the shoot worker nodes while the control plane components run on the seed worker nodes (for more information, see the <a href=/docs/gardener/concepts/architecture/>Kubernetes architecture overview</a>).
Hence, it only depends on the number of availability zones configured in the shoot worker pools via <code>.spec.provider.workers[].zones</code>.
Concretely, the highest number of zones of a worker pool with <code>systemComponents.allow=true</code> is considered.</p><p>All system components should respect the following conventions:</p><ul><li><p><strong>Replica Counts</strong></p><table><thead><tr><th>Component Type</th><th><code>1</code> or <code>2</code> Zones</th><th><code>>= 3</code> Zones</th></tr></thead><tbody><tr><td>Controllers</td><td>2</td><td>2</td></tr><tr><td>(Webhook) Servers</td><td>2</td><td>2</td></tr></tbody></table><p>Apart from the above, there might be special cases where these rules do not apply, for example:</p><ul><li><code>coredns</code> is scaled horizontally (today), hence the above numbers are the minimum values (possibly, scaling these components vertically may be more appropriate, but that&rsquo;s unrelated to the HA subject matter).</li><li>Optional addons like <code>nginx-ingress</code> or <code>kubernetes-dashboard</code> are only provided on best-effort basis for evaluation purposes, hence they run with <code>1</code> replica at all times.</li></ul></li><li><p><strong>Topology Spread Constraints</strong></p><p>When the component has <code>>= 2</code> replicas &mldr;</p><ul><li><p>&mldr; then it should also have a <code>topologySpreadConstraint</code> ensuring the replicas are spread over the nodes:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  topologySpreadConstraints:
</span></span><span style=display:flex><span>  - maxSkew: 1
</span></span><span style=display:flex><span>    topologyKey: kubernetes.io/hostname
</span></span><span style=display:flex><span>    whenUnsatisfiable: ScheduleAnyway
</span></span><span style=display:flex><span>    matchLabels: ...
</span></span></code></pre></div><p>Hence, the node spread is done on best-effort basis only.</p></li><li><p>&mldr; and the cluster has <code>>= 2</code> zones, then the component should also have a second <code>topologySpreadConstraint</code> ensuring the replicas are spread over the zones:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  topologySpreadConstraints:
</span></span><span style=display:flex><span>  - maxSkew: 1
</span></span><span style=display:flex><span>    minDomains: 2 <span style=color:green># lower value of max replicas or number of zones</span>
</span></span><span style=display:flex><span>    topologyKey: topology.kubernetes.io/zone
</span></span><span style=display:flex><span>    whenUnsatisfiable: DoNotSchedule
</span></span><span style=display:flex><span>    matchLabels: ...
</span></span></code></pre></div></li></ul></li></ul><h2 id=convenient-application-of-these-rules>Convenient Application of These Rules</h2><p>According to above scenarios and conventions, the <code>replicas</code>, <code>topologySpreadConstraints</code> or <code>affinity</code> settings of the deployed components might need to be adapted.</p><p>In order to apply those conveniently and easily for developers, Gardener installs a mutating webhook into both seed and shoot clusters which reacts on <code>Deployment</code>s and <code>StatefulSet</code>s deployed to namespaces with the <code>high-availability-config.resources.gardener.cloud/consider=true</code> label set.</p><p><strong>The following actions have to be taken by developers:</strong></p><ol><li><p>Check if <code>components</code> are prepared to run concurrently with multiple replicas, e.g. controllers usually use <a href=https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/leaderelection>leader election</a> to achieve this.</p></li><li><p>All components should be generally equipped with <code>PodDisruptionBudget</code>s with <code>.spec.maxUnavailable=1</code>:</p></li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  maxUnavailable: 1
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels: ...
</span></span></code></pre></div><ol start=3><li>Add the label <code>high-availability-config.resources.gardener.cloud/type</code> to <code>deployment</code>s or <code>statefulset</code>s, as well as optionally involved <code>horizontalpodautoscaler</code>s or <code>HVPA</code>s where the following two values are possible:</li></ol><ul><li><code>controller</code></li><li><code>server</code></li></ul><p>Type <code>server</code> is also preferred if a component is a controller and (webhook) server at the same time.</p><p>You can read more about the webhook&rsquo;s internals in <a href=/docs/gardener/concepts/resource-manager/#high-availability-config>High Availability Config</a>.</p><h2 id=gardenlet-internals><code>gardenlet</code> Internals</h2><p>Make sure you have read the above document about the webhook internals before continuing reading this section.</p><h3 id=seed-controller><code>Seed</code> Controller</h3><p>The <code>gardenlet</code> performs the following changes on all namespaces running seed system components:</p><ul><li>adds the label <code>high-availability-config.resources.gardener.cloud/consider=true</code>.</li><li>adds the annotation <code>high-availability-config.resources.gardener.cloud/zones=&lt;zones></code>, where <code>&lt;zones></code> is the list provided in <code>.spec.provider.zones[]</code> in the <code>Seed</code> specification.</li></ul><p>Note that neither the <code>high-availability-config.resources.gardener.cloud/failure-tolerance-type</code>, nor the <code>high-availability-config.resources.gardener.cloud/zone-pinning</code> annotations are set, hence the node affinity would never be touched by the webhook.</p><p>The only exception to this rule are the istio ingress gateway namespaces. This includes the default istio ingress gateway when SNI is enabled, as well as analogous namespaces for exposure classes and zone-specific istio ingress gateways. Those namespaces
will additionally be annotated with <code>high-availability-config.resources.gardener.cloud/zone-pinning</code> set to <code>true</code>, resulting in the node affinities and the topology spread constraints being set. The replicas are not touched, as the istio ingress gateways
are scaled by a horizontal autoscaler instance.</p><h3 id=shoot-controller><code>Shoot</code> Controller</h3><h4 id=control-plane>Control Plane</h4><p>The <code>gardenlet</code> performs the following changes on the namespace running the shoot control plane components:</p><ul><li>adds the label <code>high-availability-config.resources.gardener.cloud/consider=true</code>. This makes the webhook mutate the replica count and the topology spread constraints.</li><li>adds the annotation <code>high-availability-config.resources.gardener.cloud/failure-tolerance-type</code> with value equal to <code>.spec.controlPlane.highAvailability.failureTolerance.type</code> (or <code>""</code>, if <code>.spec.controlPlane.highAvailability=nil</code>). This makes the webhook mutate the node affinity according to the specified zone(s).</li><li>adds the annotation <code>high-availability-config.resources.gardener.cloud/zones=&lt;zones></code>, where <code>&lt;zones></code> is a &mldr;<ul><li>&mldr; random zone chosen from the <code>.spec.provider.zones[]</code> list in the <code>Seed</code> specification (always only one zone (even if there are multiple available in the seed cluster)) in case the <code>Shoot</code> has no HA setting (i.e., <code>spec.controlPlane.highAvailability=nil</code>) or when the <code>Shoot</code> has HA setting with failure tolerance type <code>node</code>.</li><li>&mldr; list of three randomly chosen zones from the <code>.spec.provider.zones[]</code> list in the <code>Seed</code> specification in case the <code>Shoot</code> has HA setting with failure tolerance type <code>zone</code>.</li></ul></li></ul><h4 id=system-components-1>System Components</h4><p>The <code>gardenlet</code> performs the following changes on all namespaces running shoot system components:</p><ul><li>adds the label <code>high-availability-config.resources.gardener.cloud/consider=true</code>. This makes the webhook mutate the replica count and the topology spread constraints.</li><li>adds the annotation <code>high-availability-config.resources.gardener.cloud/zones=&lt;zones></code> where <code>&lt;zones></code> is the merged list of zones provided in <code>.zones[]</code> with <code>systemComponents.allow=true</code> for all worker pools in <code>.spec.provider.workers[]</code> in the <code>Shoot</code> specification.</li></ul><p>Note that neither the <code>high-availability-config.resources.gardener.cloud/failure-tolerance-type</code>, nor the <code>high-availability-config.resources.gardener.cloud/zone-pinning</code> annotations are set, hence the node affinity would never be touched by the webhook.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c95b2a377d941a326c0914b796d1f8d3>6 - Kubernetes Clients</h1><h1 id=kubernetes-clients-in-gardener>Kubernetes Clients in Gardener</h1><p>This document aims at providing a general developer guideline on different aspects of using Kubernetes clients in a large-scale distributed system and project like Gardener.
The points included here are not meant to be consulted as absolute rules, but rather as general rules of thumb that allow developers to get a better feeling about certain gotchas and caveats.
It should be updated with lessons learned from maintaining the project and running Gardener in production.</p><h2 id=prerequisites>Prerequisites:</h2><p>Please familiarize yourself with the following basic Kubernetes API concepts first, if you&rsquo;re new to Kubernetes. A good understanding of these basics will help you better comprehend the following document.</p><ul><li><a href=https://kubernetes.io/docs/reference/using-api/api-concepts/>Kubernetes API Concepts</a> (including terminology, watch basics, etc.)</li><li><a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/>Extending the Kubernetes API</a> (including Custom Resources and aggregation layer / extension API servers)</li><li><a href=https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/>Extend the Kubernetes API with CustomResourceDefinitions</a></li><li><a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/>Working with Kubernetes Objects</a></li><li><a href=https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md>Sample Controller</a> (the diagram helps to build an understanding of an controller&rsquo;s basic structure)</li></ul><h2 id=client-types-client-go-generated-controller-runtime>Client Types: Client-Go, Generated, Controller-Runtime</h2><p>For historical reasons, you will find different kinds of Kubernetes clients in Gardener:</p><h3 id=client-go-clients>Client-Go Clients</h3><p><a href=https://github.com/kubernetes/client-go>client-go</a> is the default/official client for talking to the Kubernetes API in Golang.
It features the so called <a href=https://github.com/kubernetes/client-go/blob/release-1.21/kubernetes/clientset.go#L72>&ldquo;client sets&rdquo;</a> for all built-in Kubernetes API groups and versions (e.g. <code>v1</code> (aka <code>core/v1</code>), <code>apps/v1</code>).
client-go clients are generated from the built-in API types using <a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-api-machinery/generating-clientset.md>client-gen</a> and are composed of interfaces for every known API GroupVersionKind.
A typical client-go usage looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>var</span> (
</span></span><span style=display:flex><span>  ctx        context.Context
</span></span><span style=display:flex><span>  c          kubernetes.Interface <span style=color:green>// &#34;k8s.io/client-go/kubernetes&#34;
</span></span></span><span style=display:flex><span><span style=color:green></span>  deployment *appsv1.Deployment   <span style=color:green>// &#34;k8s.io/api/apps/v1&#34;
</span></span></span><span style=display:flex><span><span style=color:green></span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>updatedDeployment, err := c.AppsV1().Deployments(<span style=color:#a31515>&#34;default&#34;</span>).Update(ctx, deployment, metav1.UpdateOptions{})
</span></span></code></pre></div><p><em>Important characteristics of client-go clients:</em></p><ul><li>clients are specific to a given API GroupVersionKind, i.e., clients are hard-coded to corresponding API-paths (don&rsquo;t need to use the discovery API to map GVK to a REST endpoint path).</li><li>client&rsquo;s don&rsquo;t modify the passed in-memory object (e.g. <code>deployment</code> in the above example). Instead, they return a new in-memory object.<br>This means that controllers have to continue working with the new in-memory object or overwrite the shared object to not lose any state updates.</li></ul><h3 id=generated-client-sets-for-gardener-apis>Generated Client Sets for Gardener APIs</h3><p>Gardener&rsquo;s APIs extend the Kubernetes API by registering an extension API server (in the garden cluster) and <code>CustomResourceDefinition</code>s (on Seed clusters), meaning that the Kubernetes API will expose additional REST endpoints to manage Gardener resources in addition to the built-in API resources.
In order to talk to these extended APIs in our controllers and components, client-gen is used to generate client-go-style clients to <a href=https://github.com/gardener/gardener/tree/master/pkg/client><code>pkg/client/{core,extensions,seedmanagement,...}</code></a>.</p><p>Usage of these clients is equivalent to <code>client-go</code> clients, and the same characteristics apply. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>var</span> (
</span></span><span style=display:flex><span>  ctx   context.Context
</span></span><span style=display:flex><span>  c     gardencoreclientset.Interface <span style=color:green>// &#34;github.com/gardener/gardener/pkg/client/core/clientset/versioned&#34;
</span></span></span><span style=display:flex><span><span style=color:green></span>  shoot *gardencorev1beta1.Shoot      <span style=color:green>// &#34;github.com/gardener/gardener/pkg/apis/core/v1beta1&#34;
</span></span></span><span style=display:flex><span><span style=color:green></span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>updatedShoot, err := c.CoreV1beta1().Shoots(<span style=color:#a31515>&#34;garden-my-project&#34;</span>).Update(ctx, shoot, metav1.UpdateOptions{})
</span></span></code></pre></div><h3 id=controller-runtime-clients>Controller-Runtime Clients</h3><p><a href=https://github.com/kubernetes-sigs/controller-runtime>controller-runtime</a> is a Kubernetes community project (<a href=https://github.com/kubernetes-sigs/kubebuilder>kubebuilder</a> subproject) for building controllers and operators for custom resources.
Therefore, it features a generic client that follows a different approach and does not rely on generated client sets. Instead, the client can be used for managing any Kubernetes resources (built-in or custom) homogeneously.
For example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>var</span> (
</span></span><span style=display:flex><span>  ctx        context.Context
</span></span><span style=display:flex><span>  c          client.Client            <span style=color:green>// &#34;sigs.k8s.io/controller-runtime/pkg/client&#34;
</span></span></span><span style=display:flex><span><span style=color:green></span>  deployment *appsv1.Deployment       <span style=color:green>// &#34;k8s.io/api/apps/v1&#34;
</span></span></span><span style=display:flex><span><span style=color:green></span>  shoot      *gardencorev1beta1.Shoot <span style=color:green>// &#34;github.com/gardener/gardener/pkg/apis/core/v1beta1&#34;
</span></span></span><span style=display:flex><span><span style=color:green></span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>err := c.Update(ctx, deployment)
</span></span><span style=display:flex><span><span style=color:green>// or
</span></span></span><span style=display:flex><span><span style=color:green></span>err = c.Update(ctx, shoot)
</span></span></code></pre></div><p>A brief introduction to controller-runtime and its basic constructs can be found at the <a href=https://pkg.go.dev/sigs.k8s.io/controller-runtime>official Go documentation</a>.</p><p><em>Important characteristics of controller-runtime clients:</em></p><ul><li>The client functions take a generic <code>client.Object</code> or <code>client.ObjectList</code> value. These interfaces are implemented by all Golang types, that represent Kubernetes API objects or lists respectively which can be interacted with via usual API requests. [1]</li><li>The client first consults a <code>runtime.Scheme</code> (configured during client creation) for recognizing the object&rsquo;s <code>GroupVersionKind</code> (this happens on the client-side only).<br>A <code>runtime.Scheme</code> is basically a registry for Golang API types, defaulting and conversion functions. Schemes are usually provided per <code>GroupVersion</code> (see <a href=https://github.com/kubernetes/api/blob/release-1.21/apps/v1/register.go>this example</a> for <code>apps/v1</code>) and can be combined to one single scheme for further usage (<a href=https://github.com/gardener/gardener/blob/v1.29.0/pkg/client/kubernetes/types.go#L96>example</a>). In controller-runtime clients, schemes are used only for mapping a typed API object to its <code>GroupVersionKind</code>.</li><li>It then consults a <code>meta.RESTMapper</code> (also configured during client creation) for mapping the <code>GroupVersionKind</code> to a <code>RESTMapping</code>, which contains the <code>GroupVersionResource</code> and <code>Scope</code> (namespaced or cluster-scoped). From these values, the client can unambiguously determine the REST endpoint path of the corresponding API resource. For instance: <code>appsv1.DeploymentList</code> is available at <code>/apis/apps/v1/deployments</code> or <code>/apis/apps/v1/namespaces/&lt;namespace>/deployments</code> respectively.<ul><li>There are different <code>RESTMapper</code> implementations, but generally they are talking to the API server&rsquo;s discovery API for retrieving <code>RESTMappings</code> for all API resources known to the API server (either built-in, registered via API extension or <code>CustomResourceDefinition</code>s).</li><li>The default implementation of a controller-runtime (which Gardener uses as well) is the <a href=https://github.com/kubernetes-sigs/controller-runtime/blob/v0.9.0/pkg/client/apiutil/dynamicrestmapper.go#L77>dynamic <code>RESTMapper</code></a>. It caches discovery results (i.e. <code>RESTMappings</code>) in-memory and only re-discovers resources from the API server when a client tries to use an unknown <code>GroupVersionKind</code>, i.e., when it encounters a <code>No{Kind,Resource}MatchError</code>.</li></ul></li><li>The client writes back results from the API server into the passed in-memory object.<ul><li>This means that controllers don&rsquo;t have to worry about copying back the results and should just continue to work on the given in-memory object.</li><li>This is a nice and flexible pattern, and helper functions should try to follow it wherever applicable. Meaning, if possible accept an object param, pass it down to clients and keep working on the same in-memory object instead of creating a new one in your helper function.</li><li>The benefit is that you don&rsquo;t lose updates to the API object and always have the last-known state in memory. Therefore, you don&rsquo;t have to read it again, e.g., for getting the current <code>resourceVersion</code> when working with <a href=#conflicts-concurrency-control-and-optimistic-locking>optimistic locking</a>, and thus minimize the chances for running into conflicts.</li><li>However, controllers <em>must not</em> use the same in-memory object concurrently in multiple goroutines. For example, decoding results from the API server in multiple goroutines into the same maps (e.g., labels, annotations) will cause panics because of &ldquo;concurrent map writes&rdquo;. Also, reading from an in-memory API object in one goroutine while decoding into it in another goroutine will yield non-atomic reads, meaning data might be corrupt and represent a non-valid/non-existing API object.</li><li>Therefore, if you need to use the same in-memory object in multiple goroutines concurrently (e.g., shared state), remember to leverage proper synchronization techniques like channels, mutexes, <code>atomic.Value</code> and/or copy the object prior to use. The average controller however, will not need to share in-memory API objects between goroutines, and it&rsquo;s typically an indicator that the controller&rsquo;s design should be improved.</li></ul></li><li>The client decoder erases the object&rsquo;s <code>TypeMeta</code> (<code>apiVersion</code> and <code>kind</code> fields) after retrieval from the API server, see <a href=https://github.com/kubernetes/kubernetes/issues/80609>kubernetes/kubernetes#80609</a>, <a href=https://github.com/kubernetes-sigs/controller-runtime/issues/1517>kubernetes-sigs/controller-runtime#1517</a>.
Unstructured and metadata-only requests objects are an exception to this because the contained <code>TypeMeta</code> is the only way to identify the object&rsquo;s type.
Because of this behavior, <code>obj.GetObjectKind().GroupVersionKind()</code> is likely to return an empty <code>GroupVersionKind</code>.
I.e., you must not rely on <code>TypeMeta</code> being set or <code>GetObjectKind()</code> to return something usable.<br>If you need to identify an object&rsquo;s <code>GroupVersionKind</code>, use a scheme and its <code>ObjectKinds</code> function instead (or the helper function <code>apiutil.GVKForObject</code>).
This is not specific to controller-runtime clients and applies to client-go clients as well.</li></ul><p>[1] Other lower level, config or internal API types (e.g., such as <a href=https://github.com/kubernetes/api/blob/release-1.21/admission/v1/types.go#L29><code>AdmissionReview</code></a>) don&rsquo;t implement <code>client.Object</code>. However, you also can&rsquo;t interact with such objects via the Kubernetes API and thus also not via a client, so this can be disregarded at this point.</p><h3 id=metadata-only-clients>Metadata-Only Clients</h3><p>Additionally, controller-runtime clients can be used to easily retrieve metadata-only objects or lists.
This is useful for efficiently checking if at least one object of a given kind exists, or retrieving metadata of an object, if one is not interested in the rest (e.g., spec/status).<br>The <code>Accept</code> header sent to the API server then contains <code>application/json;as=PartialObjectMetadataList;g=meta.k8s.io;v=v1</code>, which makes the API server only return metadata of the retrieved object(s).
This saves network traffic and CPU/memory load on the API server and client side.
If the client fully lists all objects of a given kind including their spec/status, the resulting list can be quite large and easily exceed the controllers available memory.
That&rsquo;s why it&rsquo;s important to carefully check if a full list is actually needed, or if metadata-only list can be used instead.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>var</span> (
</span></span><span style=display:flex><span>  ctx       context.Context
</span></span><span style=display:flex><span>  c         client.Client                         <span style=color:green>// &#34;sigs.k8s.io/controller-runtime/pkg/client&#34;
</span></span></span><span style=display:flex><span><span style=color:green></span>  shootList = &amp;metav1.PartialObjectMetadataList{} <span style=color:green>// &#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;
</span></span></span><span style=display:flex><span><span style=color:green></span>)
</span></span><span style=display:flex><span>shootList.SetGroupVersionKind(gardencorev1beta1.SchemeGroupVersion.WithKind(<span style=color:#a31515>&#34;ShootList&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>if</span> err := c.List(ctx, shootList, client.InNamespace(<span style=color:#a31515>&#34;garden-my-project&#34;</span>), client.Limit(1)); err != <span style=color:#00f>nil</span> {
</span></span><span style=display:flex><span>  <span style=color:#00f>return</span> err
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>if</span> len(shootList.Items) &gt; 0 {
</span></span><span style=display:flex><span>  <span style=color:green>// project has at least one shoot
</span></span></span><span style=display:flex><span><span style=color:green></span>} <span style=color:#00f>else</span> {
</span></span><span style=display:flex><span>  <span style=color:green>// project doesn&#39;t have any shoots
</span></span></span><span style=display:flex><span><span style=color:green></span>}
</span></span></code></pre></div><h3 id=gardeners-client-collection-clientmaps>Gardener&rsquo;s Client Collection, ClientMaps</h3><p>The Gardener codebase has a collection of clients (<a href=https://github.com/gardener/gardener/blob/v1.29.0/pkg/client/kubernetes/types.go#L149><code>kubernetes.Interface</code></a>), which can return all the above mentioned client types.
Additionally, it contains helpers for rendering and applying helm charts (<code>ChartRender</code>, <code>ChartApplier</code>) and retrieving the API server&rsquo;s version (<code>Version</code>).<br>Client sets are managed by so called <code>ClientMap</code>s, which are a form of registry for all client set for a given type of cluster, i.e., Garden, Seed and Shoot.
ClientMaps manage the whole lifecycle of clients: they take care of creating them if they don&rsquo;t exist already, running their caches, refreshing their cached server version and invalidating them when they are no longer needed.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>var</span> (
</span></span><span style=display:flex><span>  ctx   context.Context
</span></span><span style=display:flex><span>  cm    clientmap.ClientMap <span style=color:green>// &#34;github.com/gardener/gardener/pkg/client/kubernetes/clientmap&#34;
</span></span></span><span style=display:flex><span><span style=color:green></span>  shoot *gardencorev1beta1.Shoot
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cs, err := cm.GetClient(ctx, keys.ForShoot(shoot)) <span style=color:green>// kubernetes.Interface
</span></span></span><span style=display:flex><span><span style=color:green></span><span style=color:#00f>if</span> err != <span style=color:#00f>nil</span> {
</span></span><span style=display:flex><span>  <span style=color:#00f>return</span> err
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>c := cs.Client() <span style=color:green>// client.Client
</span></span></span></code></pre></div><p>The client collection mainly exist for historical reasons (there used to be a lot of code using the client-go style clients).
However, Gardener is in the process of moving more towards controller-runtime and only using their clients, as they provide many benefits and are much easier to use.
Also, <a href=https://github.com/gardener/gardener/issues/4251>gardener/gardener#4251</a> aims at refactoring our controller and admission components to native controller-runtime components.</p><blockquote><p>⚠️ Please always prefer controller-runtime clients over other clients when writing new code or refactoring existing code.</p></blockquote><h2 id=cache-types-informers-listers-controller-runtime-caches>Cache Types: Informers, Listers, Controller-Runtime Caches</h2><p>Similar to the different types of client(set)s, there are also different kinds of Kubernetes client caches.
However, all of them are based on the same concept: <code>Informer</code>s.
An <code>Informer</code> is a watch-based cache implementation, meaning it opens <a href=https://kubernetes.io/docs/reference/using-api/api-concepts/#efficient-detection-of-changes>watch connections</a> to the API server and continuously updates cached objects based on the received watch events (<code>ADDED</code>, <code>MODIFIED</code>, <code>DELETED</code>).
<code>Informer</code>s offer to add indices to the cache for efficient object lookup (e.g., by name or labels) and to add <code>EventHandler</code>s for the watch events.
The latter is used by controllers to fill queues with objects that should be reconciled on watch events.</p><p>Informers are used in and created via several higher-level constructs:</p><h3 id=sharedinformerfactories-listers>SharedInformerFactories, Listers</h3><p>The generated clients (built-in as well as extended) feature a <code>SharedInformerFactory</code> for every API group, which can be used to create and retrieve <code>Informers</code> for all GroupVersionKinds.
Similarly, it can be used to retrieve <code>Listers</code> that allow getting and listing objects from the <code>Informer</code>&rsquo;s cache.
However, both of these constructs are only used for historical reasons, and we are in the process of migrating away from them in favor of cached controller-runtime clients (see <a href=https://github.com/gardener/gardener/issues/2414>gardener/gardener#2414</a>, <a href=https://github.com/gardener/gardener/issues/2822>gardener/gardener#2822</a>). Thus, they are described only briefly here.</p><p><em>Important characteristics of Listers:</em></p><ul><li>Objects read from Informers and Listers can always be slightly out-out-date (i.e., stale) because the client has to first observe changes to API objects via watch events (which can intermittently lag behind by a second or even more).</li><li>Thus, don&rsquo;t make any decisions based on data read from Listers if the consequences of deciding wrongfully based on stale state might be catastrophic (e.g. leaking infrastructure resources). In such cases, read directly from the API server via a client instead.</li><li>Objects retrieved from Informers or Listers are pointers to the cached objects, so they must not be modified without copying them first, otherwise the objects in the cache are also modified.</li></ul><h3 id=controller-runtime-caches>Controller-Runtime Caches</h3><p>controller-runtime features a cache implementation that can be used equivalently as their clients. In fact, it implements a subset of the <code>client.Client</code> interface containing the <code>Get</code> and <code>List</code> functions.
Under the hood, a <code>cache.Cache</code> dynamically creates <code>Informers</code> (i.e., opens watches) for every object GroupVersionKind that is being retrieved from it.</p><p>Note that the underlying Informers of a controller-runtime cache (<code>cache.Cache</code>) and the ones of a <code>SharedInformerFactory</code> (client-go) are not related in any way.
Both create <code>Informers</code> and watch objects on the API server individually.
This means that if you read the same object from different cache implementations, you may receive different versions of the object because the watch connections of the individual Informers are not synced.</p><blockquote><p>⚠️ Because of this, controllers/reconcilers should get the object from the same cache in the reconcile loop, where the <code>EventHandler</code> was also added to set up the controller. For example, if a <code>SharedInformerFactory</code> is used for setting up the controller then read the object in the reconciler from the <code>Lister</code> instead of from a cached controller-runtime client.</p></blockquote><p>By default, the <code>client.Client</code> created by a controller-runtime <code>Manager</code> is a <code>DelegatingClient</code>. It delegates <code>Get</code> and <code>List</code> calls to a <code>Cache</code>, and all other calls to a client that talks directly to the API server. Exceptions are requests with <code>*unstructured.Unstructured</code> objects and object kinds that were configured to be excluded from the cache in the <code>DelegatingClient</code>.</p><blockquote><p>ℹ️
<code>kubernetes.Interface.Client()</code> returns a <code>DelegatingClient</code> that uses the cache returned from <code>kubernetes.Interface.Cache()</code> under the hood. This means that all <code>Client()</code> usages need to be ready for cached clients and should be able to cater with stale cache reads.</p></blockquote><p><em>Important characteristics of cached controller-runtime clients:</em></p><ul><li>Like for Listers, objects read from a controller-runtime cache can always be slightly out of date. Hence, don&rsquo;t base any important decisions on data read from the cache (see above).</li><li>In contrast to Listers, controller-runtime caches fill the passed in-memory object with the state of the object in the cache (i.e., they perform something like a &ldquo;deep copy into&rdquo;). This means that objects read from a controller-runtime cache can safely be modified without unintended side effects.</li><li>Reading from a controller-runtime cache or a cached controller-runtime client implicitly starts a watch for the given object kind under the hood. This has important consequences:<ul><li>Reading a given object kind from the cache for the first time can take up to a few seconds depending on size and amount of objects as well as API server latency. This is because the cache has to do a full list operation and wait for an initial watch sync before returning results.</li><li>⚠️ Controllers need appropriate RBAC permissions for the object kinds they retrieve via cached clients (i.e., <code>list</code> and <code>watch</code>).</li><li>⚠️ By default, watches started by a controller-runtime cache are cluster-scoped, meaning it watches and caches objects across all namespaces. Thus, be careful which objects to read from the cache as it might significantly increase the controller&rsquo;s memory footprint.</li></ul></li><li>There is no interaction with the cache on writing calls (<code>Create</code>, <code>Update</code>, <code>Patch</code> and <code>Delete</code>), see below.</li></ul><p><strong>Uncached objects, filtered caches, <code>APIReader</code>s:</strong></p><p>In order to allow more granular control over which object kinds should be cached and which calls should bypass the cache, controller-runtime offers a few mechanisms to further tweak the client/cache behavior:</p><ul><li>When creating a <code>DelegatingClient</code>, certain object kinds can be configured to always be read directly from the API instead of from the cache. Note that this does not prevent starting a new Informer when retrieving them directly from the cache.</li><li>Watches can be restricted to a given (set of) namespace(s) by using <code>cache.MultiNamespacedCacheBuilder</code> or setting <code>cache.Options.Namespace</code>.</li><li>Watches can be filtered (e.g., by label) per object kind by configuring <code>cache.Options.SelectorsByObject</code> on creation of the cache.</li><li>Retrieving metadata-only objects or lists from a cache results in a metadata-only watch/cache for that object kind.</li><li>The <code>APIReader</code> can be used to always talk directly to the API server for a given <code>Get</code> or <code>List</code> call (use with care and only as a last resort!).</li></ul><h3 id=to-cache-or-not-to-cache>To Cache or Not to Cache</h3><p>Although watch-based caches are an important factor for the immense scalability of Kubernetes, it definitely comes at a price (mainly in terms of memory consumption).
Thus, developers need to be careful when introducing new API calls and caching new object kinds.
Here are some general guidelines on choosing whether to read from a cache or not:</p><ul><li>Always try to use the cache wherever possible and make your controller able to tolerate stale reads.<ul><li>Leverage optimistic locking: use deterministic naming for objects you create (this is what the <code>Deployment</code> controller does [2]).</li><li>Leverage optimistic locking / concurrency control of the API server: send updates/patches with the last-known <code>resourceVersion</code> from the cache (see below). This will make the request fail, if there were concurrent updates to the object (conflict error), which indicates that we have operated on stale data and might have made wrong decisions. In this case, let the controller handle the error with exponential backoff. This will make the controller eventually consistent.</li><li>Track the actions you took, e.g., when creating objects with <code>generateName</code> (this is what the <code>ReplicaSet</code> controller does [3]). The actions can be tracked in memory and repeated if the expected watch events don&rsquo;t occur after a given amount of time.</li><li>Always try to write controllers with the assumption that data will only be eventually correct and can be slightly out of date (even if read directly from the API server!).</li><li>If there is already some other code that needs a cache (e.g., a controller watch), reuse it instead of doing extra direct reads.</li><li>Don&rsquo;t read an object again if you just sent a write request. Write requests (<code>Create</code>, <code>Update</code>, <code>Patch</code> and <code>Delete</code>) don&rsquo;t interact with the cache. Hence, use the current state that the API server returned (filled into the passed in-memory object), which is basically a &ldquo;free direct read&rdquo; instead of reading the object again from a cache, because this will probably set back the object to an older <code>resourceVersion</code>.</li></ul></li><li>If you are concerned about the impact of the resulting cache, try to minimize that by using filtered or metadata-only watches.</li><li>If watching and caching an object type is not feasible, for example because there will be a lot of updates, and you are only interested in the object every ~5m, or because it will blow up the controllers memory footprint, fallback to a direct read. This can either be done by disabling caching the object type generally or doing a single request via an <code>APIReader</code>. In any case, please bear in mind that every direct API call results in a <a href=https://kubernetes.io/docs/reference/using-api/api-concepts/#the-resourceversion-parameter>quorum read from etcd</a>, which can be costly in a heavily-utilized cluster and impose significant scalability limits. Thus, always try to minimize the impact of direct calls by filtering results by namespace or labels, limiting the number of results and/or using metadata-only calls.</li></ul><p>[2] The <code>Deployment</code> controller uses the pattern <code>&lt;deployment-name>-&lt;podtemplate-hash></code> for naming <code>ReplicaSets</code>. This means, the name of a <code>ReplicaSet</code> it tries to create/update/delete at any given time is deterministically calculated based on the <code>Deployment</code> object. By this, it is insusceptible to stale reads from its <code>ReplicaSets</code> cache.</p><p>[3] In simple terms, the <code>ReplicaSet</code> controller tracks its <code>CREATE pod</code> actions as follows: when creating new <code>Pods</code>, it increases a counter of expected <code>ADDED</code> watch events for the corresponding <code>ReplicaSet</code>. As soon as such events arrive, it decreases the counter accordingly. It only creates new <code>Pods</code> for a given <code>ReplicaSet</code> once all expected events occurred (counter is back to zero) or a timeout has occurred. This way, it prevents creating more <code>Pods</code> than desired because of stale cache reads and makes the controller eventually consistent.</p><h2 id=conflicts-concurrency-control-and-optimistic-locking>Conflicts, Concurrency Control, and Optimistic Locking</h2><p>Every Kubernetes API object contains the <code>metadata.resourceVersion</code> field, which identifies an object&rsquo;s version in the backing data store, i.e., etcd. Every write to an object in etcd results in a newer <code>resourceVersion</code>.
This field is mainly used for concurrency control on the API server in an optimistic locking fashion, but also for efficient resumption of interrupted watch connections.</p><p>Optimistic locking in the Kubernetes API sense means that when a client wants to update an API object, then it includes the object&rsquo;s <code>resourceVersion</code> in the request to indicate the object&rsquo;s version the modifications are based on.
If the <code>resourceVersion</code> in etcd has not changed in the meantime, the update request is accepted by the API server and the updated object is written to etcd.
If the <code>resourceVersion</code> sent by the client does not match the one of the object stored in etcd, there were concurrent modifications to the object. Consequently, the request is rejected with a conflict error (status code <code>409</code>, API reason <code>Conflict</code>), for example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;kind&#34;: <span style=color:#a31515>&#34;Status&#34;</span>,
</span></span><span style=display:flex><span>  &#34;apiVersion&#34;: <span style=color:#a31515>&#34;v1&#34;</span>,
</span></span><span style=display:flex><span>  &#34;metadata&#34;: {},
</span></span><span style=display:flex><span>  &#34;status&#34;: <span style=color:#a31515>&#34;Failure&#34;</span>,
</span></span><span style=display:flex><span>  &#34;message&#34;: <span style=color:#a31515>&#34;Operation cannot be fulfilled on configmaps \&#34;foo\&#34;: the object has been modified; please apply your changes to the latest version and try again&#34;</span>,
</span></span><span style=display:flex><span>  &#34;reason&#34;: <span style=color:#a31515>&#34;Conflict&#34;</span>,
</span></span><span style=display:flex><span>  &#34;details&#34;: {
</span></span><span style=display:flex><span>    &#34;name&#34;: <span style=color:#a31515>&#34;foo&#34;</span>,
</span></span><span style=display:flex><span>    &#34;kind&#34;: <span style=color:#a31515>&#34;configmaps&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  &#34;code&#34;: 409
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This concurrency control is an important mechanism in Kubernetes as there are typically multiple clients acting on API objects at the same time (humans, different controllers, etc.). If a client receives a conflict error, it should read the object&rsquo;s latest version from the API server, make the modifications based on the newest changes, and retry the update.
The reasoning behind this is that a client might choose to make different decisions based on the concurrent changes made by other actors compared to the outdated version that it operated on.</p><p><em>Important points about concurrency control and conflicts:</em></p><ul><li>The <code>resourceVersion</code> field carries a string value and clients must not assume numeric values (the type and structure of versions depend on the backing data store). This means clients may compare <code>resourceVersion</code> values to detect whether objects were changed. But they must not compare <code>resourceVersion</code>s to figure out which one is newer/older, i.e., no greater/less-than comparisons are allowed.</li><li>By default, update calls (e.g. via client-go and controller-runtime clients) use optimistic locking as the passed in-memory usually object contains the latest <code>resourceVersion</code> known to the controller, which is then also sent to the API server.</li><li>API servers can also choose to accept update calls without optimistic locking (i.e., without a <code>resourceVersion</code> in the object&rsquo;s metadata) for any given resource. However, sending update requests without optimistic locking is strongly discouraged, as doing so overwrites the entire object, discarding any concurrent changes made to it.</li><li>On the other side, patch requests can always be executed either with or without optimistic locking, by (not) including the <code>resourceVersion</code> in the patched object&rsquo;s metadata. Sending patch requests without optimistic locking might be safe and even desirable as a patch typically updates only a specific section of the object. However, there are also situations where patching without optimistic locking is not safe (see below).</li></ul><h3 id=dont-retry-on-conflict>Don’t Retry on Conflict</h3><p>Similar to how a human would typically handle a conflict error, there are helper functions implementing <code>RetryOnConflict</code>-semantics, i.e., try an update call, then re-read the object if a conflict occurs, apply the modification again and retry the update.
However, controllers should generally <em>not</em> use <code>RetryOnConflict</code>-semantics. Instead, controllers should abort their current reconciliation run and let the queue handle the conflict error with exponential backoff.
The reasoning behind this is that a conflict error indicates that the controller has operated on stale data and might have made wrong decisions earlier on in the reconciliation.
When using a helper function that implements <code>RetryOnConflict</code>-semantics, the controller doesn&rsquo;t check which fields were changed and doesn&rsquo;t revise its previous decisions accordingly.
Instead, retrying on conflict basically just ignores any conflict error and blindly applies the modification.</p><p>To properly solve the conflict situation, controllers should immediately return with the error from the update call. This will cause retries with exponential backoff so that the cache has a chance to observe the latest changes to the object.
In a later run, the controller will then make correct decisions based on the newest version of the object, not run into conflict errors, and will then be able to successfully reconcile the object. This way, the controller becomes eventually consistent.</p><p>The other way to solve the situation is to modify objects without optimistic locking in order to avoid running into a conflict in the first place (only if this is safe).
This can be a preferable solution for controllers with long-running reconciliations (which is actually an anti-pattern but quite unavoidable in some of Gardener&rsquo;s controllers).
Aborting the entire reconciliation run is rather undesirable in such cases, as it will add a lot of unnecessary waiting time for end users and overhead in terms of compute and network usage.</p><p>However, in any case, retrying on conflict is probably not the right option to solve the situation (there are some correct use cases for it, though, they are very rare). Hence, don&rsquo;t retry on conflict.</p><h3 id=to-lock-or-not-to-lock>To Lock or Not to Lock</h3><p>As explained before, conflicts are actually important and prevent clients from doing wrongful concurrent updates. This means that conflicts are not something we generally want to avoid or ignore.
However, in many cases controllers are exclusive owners of the fields they want to update and thus it might be safe to run without optimistic locking.</p><p>For example, the gardenlet is the exclusive owner of the <code>spec</code> section of the Extension resources it creates on behalf of a Shoot (e.g., the <code>Infrastructure</code> resource for creating VPC). Meaning, it knows the exact desired state and no other actor is supposed to update the Infrastructure&rsquo;s <code>spec</code> fields.
When the gardenlet now updates the Infrastructures <code>spec</code> section as part of the Shoot reconciliation, it can simply issue a <code>PATCH</code> request that only updates the <code>spec</code> and runs without optimistic locking.
If another controller concurrently updated the object in the meantime (e.g., the <code>status</code> section), the <code>resourceVersion</code> got changed, which would cause a conflict error if running with optimistic locking.
However, concurrent <code>status</code> updates would not change the gardenlet&rsquo;s mind on the desired <code>spec</code> of the Infrastructure resource as it is determined only by looking at the Shoot&rsquo;s specification.
If the <code>spec</code> section was changed concurrently, it&rsquo;s still fine to overwrite it because the gardenlet should reconcile the <code>spec</code> back to its desired state.</p><p>Generally speaking, if a controller is the exclusive owner of a given set of fields and they are independent of concurrent changes to other fields in that object, it can patch these fields without optimistic locking.
This might ignore concurrent changes to other fields or blindly overwrite changes to the same fields, but this is fine if the mentioned conditions apply.
Obviously, this applies only to patch requests that modify only a specific set of fields but not to update requests that replace the entire object.</p><p>In such cases, it&rsquo;s even desirable to run without optimistic locking as it will be more performant and save retries.
If certain requests are made with high frequency and have a good chance of causing conflicts, retries because of optimistic locking can cause a lot of additional network traffic in a large-scale Gardener installation.</p><h2 id=updates-patches-server-side-apply>Updates, Patches, Server-Side Apply</h2><p>There are different ways of modifying Kubernetes API objects.
The following snippet demonstrates how to do a given modification with the most frequently used options using a controller-runtime client:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>var</span> (
</span></span><span style=display:flex><span>  ctx   context.Context
</span></span><span style=display:flex><span>  c     client.Client
</span></span><span style=display:flex><span>  shoot *gardencorev1beta1.Shoot
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green>// update
</span></span></span><span style=display:flex><span><span style=color:green></span>shoot.Spec.Kubernetes.Version = <span style=color:#a31515>&#34;1.22&#34;</span>
</span></span><span style=display:flex><span>err := c.Update(ctx, shoot)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green>// json merge patch
</span></span></span><span style=display:flex><span><span style=color:green></span>patch := client.MergeFrom(shoot.DeepCopy())
</span></span><span style=display:flex><span>shoot.Spec.Kubernetes.Version = <span style=color:#a31515>&#34;1.22&#34;</span>
</span></span><span style=display:flex><span>err = c.Patch(ctx, shoot, patch)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green>// strategic merge patch
</span></span></span><span style=display:flex><span><span style=color:green></span>patch = client.StrategicMergeFrom(shoot.DeepCopy())
</span></span><span style=display:flex><span>shoot.Spec.Kubernetes.Version = <span style=color:#a31515>&#34;1.22&#34;</span>
</span></span><span style=display:flex><span>err = c.Patch(ctx, shoot, patch)
</span></span></code></pre></div><p><em>Important characteristics of the shown request types:</em></p><ul><li>Update requests always send the entire object to the API server and update all fields accordingly. By default, optimistic locking is used (<code>resourceVersion</code> is included).</li><li>Both patch types run without optimistic locking by default. However, it can be enabled explicitly if needed:<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:green>// json merge patch + optimistic locking
</span></span></span><span style=display:flex><span><span style=color:green></span>patch := client.MergeFromWithOptions(shoot.DeepCopy(), client.MergeFromWithOptimisticLock{})
</span></span><span style=display:flex><span><span style=color:green>// ...
</span></span></span><span style=display:flex><span><span style=color:green></span>
</span></span><span style=display:flex><span><span style=color:green>// strategic merge patch + optimistic locking
</span></span></span><span style=display:flex><span><span style=color:green></span>patch = client.StrategicMergeFrom(shoot.DeepCopy(), client.MergeFromWithOptimisticLock{})
</span></span><span style=display:flex><span><span style=color:green>// ...
</span></span></span></code></pre></div></li><li>Patch requests only contain the changes made to the in-memory object between the copy passed to <code>client.*MergeFrom</code> and the object passed to <code>Client.Patch()</code>. The diff is calculated on the client-side based on the in-memory objects only. This means that if in the meantime some fields were changed on the API server to a different value than the one on the client-side, the fields will not be changed back as long as they are not changed on the client-side as well (there will be no diff in memory).</li><li>Thus, if you want to ensure a given state using patch requests, always read the object first before patching it, as there will be no diff otherwise, meaning the patch will be empty. For more information, see <a href=https://github.com/gardener/gardener/pull/4057>gardener/gardener#4057</a> and the comments in <a href=https://github.com/gardener/gardener/pull/4027>gardener/gardener#4027</a>.</li><li>Also, always send updates and patch requests even if your controller hasn&rsquo;t made any changes to the current state on the API server. I.e., don&rsquo;t make any optimization for preventing empty patches or no-op updates. There might be mutating webhooks in the system that will modify the object and that rely on update/patch requests being sent (even if they are no-op). Gardener&rsquo;s extension concept makes heavy use of mutating webhooks, so it&rsquo;s important to keep this in mind.</li><li>JSON merge patches always replace lists as a whole and don&rsquo;t merge them. Keep this in mind when operating on lists with merge patch requests. If the controller is the exclusive owner of the entire list, it&rsquo;s safe to run without optimistic locking. Though, if you want to prevent overwriting concurrent changes to the list or its items made by other actors (e.g., additions/removals to the <code>metadata.finalizers</code> list), enable optimistic locking.</li><li>Strategic merge patches are able to make more granular modifications to lists and their elements without replacing the entire list. It uses Golang struct tags of the API types to determine which and how lists should be merged. See <a href=https://kubernetes.io/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/>Update API Objects in Place Using kubectl patch</a> or the <a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-api-machinery/strategic-merge-patch.md>strategic merge patch documentation</a> for more in-depth explanations and comparison with JSON merge patches.
With this, controllers <em>might</em> be able to issue patch requests for individual list items without optimistic locking, even if they are not exclusive owners of the entire list. Remember to check the <code>patchStrategy</code> and <code>patchMergeKey</code> struct tags of the fields you want to modify before blindly adding patch requests without optimistic locking.</li><li>Strategic merge patches are only supported by built-in Kubernetes resources and custom resources served by Extension API servers. Strategic merge patches are not supported by custom resources defined by <code>CustomResourceDefinition</code>s (see <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#advanced-features-and-flexibility>this comparison</a>). In that case, fallback to JSON merge patches.</li><li><a href=https://kubernetes.io/docs/reference/using-api/server-side-apply/>Server-side Apply</a> is yet another mechanism to modify API objects, which is supported by all API resources (in newer Kubernetes versions). However, it has a few problems and more caveats preventing us from using it in Gardener at the time of writing. See <a href=https://github.com/gardener/gardener/issues/4122>gardener/gardener#4122</a> for more details.</li></ul><blockquote><p>Generally speaking, patches are often the better option compared to update requests because they can save network traffic, encoding/decoding effort, and avoid conflicts under the presented conditions.
If choosing a patch type, consider which type is supported by the resource you&rsquo;re modifying and what will happen in case of a conflict. Consider whether your modification is safe to run without optimistic locking.
However, there is no simple rule of thumb on which patch type to choose.</p></blockquote><h2 id=on-helper-functions>On Helper Functions</h2><p>Here is a note on some helper functions, that should be avoided and why:</p><p><code>controllerutil.CreateOrUpdate</code> does a basic get, mutate and create or update call chain, which is often used in controllers. We should avoid using this helper function in Gardener, because it is likely to cause conflicts for cached clients and doesn&rsquo;t send no-op requests if nothing was changed, which can cause problems because of the heavy use of webhooks in Gardener extensions (see above).
That&rsquo;s why usage of this function was completely replaced in <a href=https://github.com/gardener/gardener/pull/4227>gardener/gardener#4227</a> and similar PRs.</p><p><code>controllerutil.CreateOrPatch</code> is similar to <code>CreateOrUpdate</code> but does a patch request instead of an update request. It has the same drawback as <code>CreateOrUpdate</code> regarding no-op updates.
Also, controllers can&rsquo;t use optimistic locking or strategic merge patches when using <code>CreateOrPatch</code>.
Another reason for avoiding use of this function is that it also implicitly patches the status section if it was changed, which is confusing for others reading the code. To accomplish this, the func does some back and forth conversion, comparison and checks, which are unnecessary in most of our cases and simply wasted CPU cycles and complexity we want to avoid.</p><p>There were some <code>Try{Update,UpdateStatus,Patch,PatchStatus}</code> helper functions in Gardener that were already removed by <a href=https://github.com/gardener/gardener/pull/4378>gardener/gardener#4378</a> but are still used in some extension code at the time of writing.
The reason for eliminating these functions is that they implement <code>RetryOnConflict</code>-semantics. Meaning, they first get the object, mutate it, then try to update and retry if a conflict error occurs.
As explained above, retrying on conflict is a controller anti-pattern and should be avoided in almost every situation.
The other problem with these functions is that they read the object first from the API server (always do a direct call), although in most cases we already have a recent version of the object at hand. So, using this function generally does unnecessary API calls and therefore causes unwanted compute and network load.</p><p>For the reasons explained above, there are similar helper functions that accomplish similar things but address the mentioned drawbacks: <code>controllerutils.{GetAndCreateOrMergePatch,GetAndCreateOrStrategicMergePatch}</code>.
These can be safely used as replacements for the aforementioned helper funcs.
If they are not fitting for your use case, for example because you need to use optimistic locking, just do the appropriate calls in the controller directly.</p><h2 id=related-links>Related Links</h2><ul><li><a href="https://www.youtube.com/watch?v=RPsUo925PUA&t=40s">Kubernetes Client usage in Gardener</a> (Community Meeting talk, 2020-06-26)</li></ul><p>These resources are only partially related to the topics covered in this doc, but might still be interesting for developer seeking a deeper understanding of Kubernetes API machinery, architecture and foundational concepts.</p><ul><li><a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md>API Conventions</a></li><li><a href=https://github.com/kubernetes/design-proposals-archive/blob/main/architecture/resource-management.md>The Kubernetes Resource Model</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-21c83bbf03336ea56a38d93f1d4fa12f>7 - Local Setup</h1><h1 id=overview>Overview</h1><p>Conceptually, all Gardener components are designed to run as a Pod inside a Kubernetes cluster.
The Gardener API server extends the Kubernetes API via the user-aggregated API server concepts.
However, if you want to develop it, you may want to work locally with the Gardener without building a Docker image and deploying it to a cluster each and every time.
That means that the Gardener runs outside a Kubernetes cluster which requires providing a <a href=https://kubernetes.io/docs/tasks/access-application-cluster/authenticate-across-clusters-kubeconfig/>Kubeconfig</a> in your local filesystem and point the Gardener to it when starting it (see below).</p><p>Further details can be found in</p><ol><li><a href=https://kubernetes.io/docs/concepts/>Principles of Kubernetes</a>, and its <a href=https://kubernetes.io/docs/concepts/overview/components/>components</a></li><li><a href=https://github.com/kubernetes/community/tree/master/contributors/devel>Kubernetes Development Guide</a></li><li><a href=https://github.com/gardener/documentation/wiki/Architecture>Architecture of Gardener</a></li></ol><p>This guide is split into two main parts:</p><ul><li><a href=#preparing-the-setup>Preparing your setup by installing all dependencies and tools</a></li><li><a href=#get-the-sources>Getting the Gardener source code locally</a></li></ul><h1 id=preparing-the-setup>Preparing the Setup</h1><h2 id=macos-only-installing-homebrew>[macOS only] Installing homebrew</h2><p>The copy-paste instructions in this guide are designed for macOS and use the package manager <a href=https://brew.sh/>Homebrew</a>.</p><p>On macOS run</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/bin/bash -c <span style=color:#a31515>&#34;</span><span style=color:#00f>$(</span>curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh<span style=color:#00f>)</span><span style=color:#a31515>&#34;</span>
</span></span></code></pre></div><h2 id=installing-git>Installing git</h2><p>We use <code>git</code> as VCS which you need to install. On macOS run</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install git
</span></span></code></pre></div><p>For other OS, please check the <a href=https://git-scm.com/book/en/v2/Getting-Started-Installing-Git>Git installation documentation</a>.</p><h2 id=installing-go>Installing Go</h2><p>Install the latest version of Go. On macOS run</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install go
</span></span></code></pre></div><p>For other OS, please check <a href=https://golang.org/doc/install>Go installation documentation</a>.</p><h2 id=installing-kubectl>Installing kubectl</h2><p>Install <code>kubectl</code>. Please make sure that the version of <code>kubectl</code> is at least <code>v1.22.x</code>. On macOS run</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install kubernetes-cli
</span></span></code></pre></div><p>For other OS, please check the <a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/>kubectl installation documentation</a>.</p><h2 id=installing-docker>Installing Docker</h2><p>You need to have docker installed and running. On macOS run</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install --cask docker
</span></span></code></pre></div><p>For other OS please check the <a href=https://docs.docker.com/get-docker/>docker installation documentation</a>.</p><h2 id=installing-iproute2>Installing iproute2</h2><p><code>iproute2</code> provides a collection of utilities for network administration and configuration. On macOS run</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install iproute2mac
</span></span></code></pre></div><h2 id=installing-jq>Installing jq</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install jq
</span></span></code></pre></div><h2 id=installing-gnu-parallel>Installing GNU Parallel</h2><p><a href=https://www.gnu.org/software/parallel/>GNU Parallel</a> is a shell tool for executing jobs in parallel, used by the code generation scripts (<code>make generate</code>). On macOS run</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install parallel
</span></span></code></pre></div><h2 id=macos-only-install-gnu-core-utilities>[macOS only] Install GNU Core Utilities</h2><p>When running on macOS, install the GNU core utilities and friends:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install coreutils gnu-sed gnu-tar grep gzip
</span></span></code></pre></div><p>This will create symbolic links for the GNU utilities with <code>g</code> prefix on your <code>PATH</code>, e.g., <code>gsed</code> or <code>gbase64</code>.
To allow using them without the <code>g</code> prefix, add the <code>gnubin</code> directories to the beginning of your <code>PATH</code> environment variable (<code>brew install</code> and <code>brew info</code> will print out instructions for each formula):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export PATH=<span style=color:#00f>$(</span>brew --prefix<span style=color:#00f>)</span>/opt/coreutils/libexec/gnubin:$PATH
</span></span><span style=display:flex><span>export PATH=<span style=color:#00f>$(</span>brew --prefix<span style=color:#00f>)</span>/opt/gnu-sed/libexec/gnubin:$PATH
</span></span><span style=display:flex><span>export PATH=<span style=color:#00f>$(</span>brew --prefix<span style=color:#00f>)</span>/opt/gnu-tar/libexec/gnubin:$PATH
</span></span><span style=display:flex><span>export PATH=<span style=color:#00f>$(</span>brew --prefix<span style=color:#00f>)</span>/opt/grep/libexec/gnubin:$PATH
</span></span><span style=display:flex><span>export PATH=<span style=color:#00f>$(</span>brew --prefix<span style=color:#00f>)</span>/opt/gzip/bin:$PATH
</span></span></code></pre></div><h2 id=windows-only-wsl2>[Windows Only] WSL2</h2><p>Apart from Linux distributions and macOS, the local gardener setup can also run on the Windows Subsystem for Linux 2.</p><p>While WSL1, plain docker for Windows and various Linux distributions and local Kubernetes environments may be supported, this setup was verified with:</p><ul><li><a href=https://docs.microsoft.com/en-us/windows/wsl/wsl2-index>WSL2</a></li><li><a href=https://docs.docker.com/docker-for-windows/wsl/>Docker Desktop WSL2 Engine</a></li><li><a href=https://ubuntu.com/blog/ubuntu-on-wsl-2-is-generally-available>Ubuntu 18.04 LTS on WSL2</a></li><li>Nodeless local garden (see below)</li></ul><p>The Gardener repository and all the above-mentioned tools (git, golang, kubectl, &mldr;) should be installed in your WSL2 distro, according to the distribution-specific Linux installation instructions.</p><h1 id=get-the-sources>Get the Sources</h1><p>Clone the repository from GitHub into your <code>$GOPATH</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p <span style=color:#00f>$(</span>go env GOPATH<span style=color:#00f>)</span>/src/github.com/gardener
</span></span><span style=display:flex><span>cd <span style=color:#00f>$(</span>go env GOPATH<span style=color:#00f>)</span>/src/github.com/gardener
</span></span><span style=display:flex><span>git clone git@github.com:gardener/gardener.git
</span></span><span style=display:flex><span>cd gardener
</span></span></code></pre></div><blockquote><p>Note: Gardener is using Go modules and cloning the repository into <code>$GOPATH</code> is not a hard requirement. However it is still recommended to clone into <code>$GOPATH</code> because <code>k8s.io/code-generator</code> does not work yet outside of <code>$GOPATH</code> - <a href=https://github.com/kubernetes/kubernetes/issues/86753>kubernetes/kubernetes#86753</a>.</p></blockquote><h1 id=start-the-gardener>Start the Gardener</h1><p>Please see <a href=/docs/gardener/deployment/getting_started_locally/>getting_started_locally.md</a> how to build and deploy Gardener from your local sources.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ba2932673ad3c4565462541e83ca1ede>8 - Log Parsers</h1><h1 id=how-to-create-log-parser-for-container-into-fluent-bit>How to Create Log Parser for Container into fluent-bit</h1><p>If our log message is parsed correctly, it has to be showed in Plutono like this:</p><pre tabindex=0><code class=language-jsonc data-lang=jsonc>  {&#34;log&#34;:&#34;OpenAPI AggregationController: Processing item v1beta1.metrics.k8s.io&#34;,&#34;pid&#34;:&#34;1&#34;,&#34;severity&#34;:&#34;INFO&#34;,&#34;source&#34;:&#34;controller.go:107&#34;}
</code></pre><p>Otherwise it will looks like this:</p><pre tabindex=0><code class=language-jsonc data-lang=jsonc>{
  &#34;log&#34;:&#34;{
  \&#34;level\&#34;:\&#34;info\&#34;,\&#34;ts\&#34;:\&#34;2020-06-01T11:23:26.679Z\&#34;,\&#34;logger\&#34;:\&#34;gardener-resource-manager.health-reconciler\&#34;,\&#34;msg\&#34;:\&#34;Finished ManagedResource health checks\&#34;,\&#34;object\&#34;:\&#34;garden/provider-aws-dsm9r\&#34;
  }\n&#34;
  }
}
</code></pre><h2 id=create-a-custom-parser>Create a Custom Parser</h2><ul><li><p>First of all, we need to know how the log for the specific container looks like (for example, lets take a log from the <code>alertmanager</code> :
<code>level=info ts=2019-01-28T12:33:49.362015626Z caller=main.go:175 build_context="(go=go1.11.2, user=root@4ecc17c53d26, date=20181109-15:40:48)</code>)</p></li><li><p>We can see that this log contains 4 subfields(severity=info, timestamp=2019-01-28T12:33:49.362015626Z, source=main.go:175 and the actual message).
So we have to write a regex which matches this log in 4 groups(We can use <a href=https://regex101.com/>https://regex101.com/</a> like helping tool). So, for this purpose our regex looks like this:</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>^level=(?&lt;severity&gt;\w+)\s+ts=(?&lt;time&gt;\d{4}-\d{2}-\d{2}[Tt].*[zZ])\s+caller=(?&lt;source&gt;[^\s]*+)\s+(?&lt;log&gt;.*)
</span></span></code></pre></div><ul><li>Now we have to create correct time format for the timestamp (We can use this site for this purpose: <a href=http://ruby-doc.org/stdlib-2.4.1/libdoc/time/rdoc/Time.html#method-c-strptime>http://ruby-doc.org/stdlib-2.4.1/libdoc/time/rdoc/Time.html#method-c-strptime</a>).
So our timestamp matches correctly the following format:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>%Y-%m-%dT%H:%M:%S.%L
</span></span></code></pre></div><ul><li>It&rsquo;s time to apply our new regex into fluent-bit configuration. To achieve that we can just deploy in the cluster where the <code>fluent-operator</code> is deployed the following custom resources:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: fluentbit.fluent.io/v1alpha2
</span></span><span style=display:flex><span>kind: ClusterFilter
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    fluentbit.gardener/type: seed
</span></span><span style=display:flex><span>  name: &lt;&lt; pod-name &gt;&gt;--(&lt;&lt; container-name &gt;&gt;)
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  filters:
</span></span><span style=display:flex><span>  - parser:
</span></span><span style=display:flex><span>      keyName: log
</span></span><span style=display:flex><span>      parser: &lt;&lt; container-name &gt;&gt;-parser
</span></span><span style=display:flex><span>      reserveData: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  match: kubernetes.&lt;&lt; pod-name &gt;&gt;*&lt;&lt; container-name &gt;&gt;*
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>EXAMPLE
</span></span><span style=display:flex><span>apiVersion: fluentbit.fluent.io/v1alpha2
</span></span><span style=display:flex><span>kind: ClusterFilter
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    fluentbit.gardener/type: seed
</span></span><span style=display:flex><span>  name: alertmanager
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  filters:
</span></span><span style=display:flex><span>  - parser:
</span></span><span style=display:flex><span>      keyName: log
</span></span><span style=display:flex><span>      parser: alertmanager-parser
</span></span><span style=display:flex><span>      reserveData: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  match: <span style=color:#a31515>&#34;kubernetes.alertmanager*alertmanager*&#34;</span>
</span></span></code></pre></div><ul><li>Now lets check if there already exists <code>ClusterParser</code> with such a regex and time format that we need. If it doesn&rsquo;t, create one:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: fluentbit.fluent.io/v1alpha2
</span></span><span style=display:flex><span>kind: ClusterParser
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name:  &lt;&lt; container-name &gt;&gt;-parser
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    fluentbit.gardener/type: <span style=color:#a31515>&#34;seed&#34;</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  regex:
</span></span><span style=display:flex><span>    timeKey: time
</span></span><span style=display:flex><span>    timeFormat: &lt;&lt; time-format &gt;&gt;
</span></span><span style=display:flex><span>    regex: <span style=color:#a31515>&#34;&lt;&lt; regex &gt;&gt;&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>EXAMPLE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>apiVersion: fluentbit.fluent.io/v1alpha2
</span></span><span style=display:flex><span>kind: ClusterParser
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: alermanager-parser
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    fluentbit.gardener/type: <span style=color:#a31515>&#34;seed&#34;</span>
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  regex:
</span></span><span style=display:flex><span>    timeKey: time
</span></span><span style=display:flex><span>    timeFormat: <span style=color:#a31515>&#34;%Y-%m-%dT%H:%M:%S.%L&#34;</span>
</span></span><span style=display:flex><span>    regex: <span style=color:#a31515>&#34;^level=(?&lt;severity&gt;\\w+)\\s+ts=(?&lt;time&gt;\\d{4}-\\d{2}-\\d{2}[Tt].*[zZ])\\s+caller=(?&lt;source&gt;[^\\s]*+)\\s+(?&lt;log&gt;.*)&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Follow your development setup to validate that the parsers are working correctly.
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6072f273ee0aa37eba651d226b098168>9 - Logging</h1><h1 id=logging-in-gardener-components>Logging in Gardener Components</h1><p>This document aims at providing a general developer guideline on different aspects of logging practices and conventions used in the Gardener codebase.
It contains mostly Gardener-specific points, and references other existing and commonly accepted logging guidelines for general advice.
Developers and reviewers should consult this guide when writing, refactoring, and reviewing Gardener code.
If parts are unclear or new learnings arise, this guide should be adapted accordingly.</p><h2 id=logging-libraries--implementations>Logging Libraries / Implementations</h2><p>Historically, Gardener components have been using <a href=https://github.com/sirupsen/logrus>logrus</a>.
There is a global logrus logger (<a href=https://github.com/gardener/gardener/blob/626ba7c10e1150819b3905116d3988512c18c9ee/pkg/logger/logrus.go#L28><code>logger.Logger</code></a>) that is initialized by components on startup and used across the codebase.
In most places, it is used as a <code>printf</code>-style logger and only in some instances we make use of logrus&rsquo; structured logging functionality.</p><p>In the process of migrating our components to native controller-runtime components (see <a href=https://github.com/gardener/gardener/issues/4251>gardener/gardener#4251</a>), we also want to make use of controller-runtime&rsquo;s built-in mechanisms for streamlined logging.
controller-runtime uses <a href=https://github.com/go-logr/logr>logr</a>, a simple structured logging interface, for library-internal logging and logging in controllers.</p><p>logr itself is only an interface and doesn&rsquo;t provide an implementation out of the box.
Instead, it needs to be backed by a logging implementation like <a href=https://github.com/go-logr/zapr>zapr</a>. Code that uses the logr interface is thereby not tied to a specific logging implementation and makes the implementation easily exchangeable.
controller-runtime already provides a <a href=https://github.com/kubernetes-sigs/controller-runtime/tree/v0.11.0/pkg/log/zap>set of helpers</a> for constructing zapr loggers, i.e., logr loggers backed by <a href=https://github.com/uber-go/zap>zap</a>, which is a popular logging library in the go community.
Hence, we are migrating our component logging from logrus to logr (backed by zap) as part of <a href=https://github.com/gardener/gardener/issues/4251>gardener/gardener#4251</a>.</p><blockquote><p>⚠️ <code>logger.Logger</code> (logrus logger) is deprecated in Gardener and shall not be used in new code – use logr loggers when writing new code! (also see <a href=#migration-from-logrus-to-logr>Migration from logrus to logr</a>)</p><p>ℹ️ Don&rsquo;t use zap loggers directly, always use the logr interface in order to avoid tight coupling to a specific logging implementation.</p></blockquote><p>gardener-apiserver differs from the other components as it is based on the <a href=https://github.com/kubernetes/apiserver>apiserver library</a> and therefore uses <a href=https://github.com/kubernetes/klog>klog</a> – just like kube-apiserver.
As gardener-apiserver writes (almost) no logs in our coding (outside the apiserver library), there is currently no plan for switching the logging implementation.
Hence, the following sections focus on logging in the controller and admission components only.</p><h2 id=logcheck-tool><code>logcheck</code> Tool</h2><p>To ensure a smooth migration to logr and make logging in Gardener components more consistent, the <a href=https://github.com/gardener/gardener/tree/master/hack/tools/logcheck><code>logcheck</code> tool</a> was added.
It enforces (parts of) this guideline and detects programmer-level errors early on in order to prevent bugs.
Please check out the <a href=https://github.com/gardener/gardener/tree/master/hack/tools/logcheck>tool&rsquo;s documentation</a> for a detailed description.</p><h2 id=structured-logging>Structured Logging</h2><p>Similar to <a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/migration-to-structured-logging.md>efforts in the Kubernetes project</a>, we want to migrate our component logs to structured logging.
As motivated above, we will use the logr interface instead of klog though.</p><p>You can read more about the motivation behind structured logging in <a href=https://github.com/go-logr/logr#background>logr&rsquo;s background and FAQ</a> (also see <a href=http://dave.cheney.net/2015/11/05/lets-talk-about-logging>this blog post by Dave Cheney</a>).
Also, make sure to check out controller-runtime&rsquo;s <a href=https://github.com/kubernetes-sigs/controller-runtime/blob/v0.11.0/TMP-LOGGING.md>logging guideline</a> with specifics for projects using the library.
The following sections will focus on the most important takeaways from those guidelines and give general instructions on how to apply them to Gardener and its controller-runtime components.</p><blockquote><p>Note: Some parts in this guideline differ slightly from controller-runtime&rsquo;s document.</p></blockquote><h3 id=tldr-of-structured-logging>TL;DR of Structured Logging</h3><p>❌ Stop using <code>printf</code>-style logging:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>var</span> logger *logrus.Logger
</span></span><span style=display:flex><span>logger.Infof(<span style=color:#a31515>&#34;Scaling deployment %s/%s to %d replicas&#34;</span>, deployment.Namespace, deployment.Name, replicaCount)
</span></span></code></pre></div><p>✅ Instead, write static log messages and enrich them with additional structured information in form of key-value pairs:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>var</span> logger logr.Logger
</span></span><span style=display:flex><span>logger.Info(<span style=color:#a31515>&#34;Scaling deployment&#34;</span>, <span style=color:#a31515>&#34;deployment&#34;</span>, client.ObjectKeyFromObject(deployment), <span style=color:#a31515>&#34;replicas&#34;</span>, replicaCount)
</span></span></code></pre></div><h2 id=log-configuration>Log Configuration</h2><p>Gardener components can be configured to either log in <code>json</code> (default) or <code>text</code> format:
<code>json</code> format is supposed to be used in production, while <code>text</code> format might be nicer for development.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># json
</span></span><span style=display:flex><span>{&#34;level&#34;:&#34;info&#34;,&#34;ts&#34;:&#34;2021-12-16T08:32:21.059+0100&#34;,&#34;msg&#34;:&#34;Hello botanist&#34;,&#34;garden&#34;:&#34;eden&#34;}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># text
</span></span><span style=display:flex><span>2021-12-16T08:32:21.059+0100    INFO    Hello botanist  {&#34;garden&#34;: &#34;eden&#34;}
</span></span></code></pre></div><p>Components can be set to one of the following log levels (with increasing verbosity): <code>error</code>, <code>info</code> (default), <code>debug</code>.</p><h2 id=log-levels>Log Levels</h2><p>logr uses <a href=https://github.com/go-logr/logr#why-v-levels>V-levels</a> (numbered log levels), higher V-level means higher verbosity.
V-levels are relative (in contrast to <code>klog</code>&rsquo;s absolute V-levels), i.e., <code>V(1)</code> creates a logger, that is one level more verbose than its parent logger.</p><p>In Gardener components, the mentioned log levels in the component config (<code>error</code>, <code>info</code>, <code>debug</code>) map to the zap levels with the same names (see <a href=https://github.com/gardener/gardener/blob/770fc01a34b70f6cb77b8cfe929d9daef0026d1c/pkg/logger/zap.go#L43-L55>here</a>).
Hence, our loggers follow the same mapping from numerical logr levels to named zap levels like described in <a href=https://github.com/go-logr/zapr/tree/v1.1.0#increasing-verbosity>zapr</a>, i.e.:</p><ul><li>component config specifies <code>debug</code> ➡️ both <code>V(0)</code> and <code>V(1)</code> are enabled</li><li>component config specifies <code>info</code> ➡️ <code>V(0)</code> is enabled, <code>V(1)</code> will not be shown</li><li>component config specifies <code>error</code> ➡️ neither <code>V(0)</code> nor <code>V(1)</code> will be shown</li><li><code>Error()</code> logs will always be shown</li></ul><p>This mapping applies to the components&rsquo; root loggers (the ones that are not &ldquo;derived&rdquo; from any other logger; constructed on component startup).
If you derive a new logger with e.g. <code>V(1)</code>, the mapping will shift by one. For example, <code>V(0)</code> will then log at zap&rsquo;s <code>debug</code> level.</p><p>There is no <code>warning</code> level (see <a href=https://dave.cheney.net/2015/11/05/lets-talk-about-logging>Dave Cheney&rsquo;s post</a>).
If there is an error condition (e.g., unexpected error received from a called function), the error should either be handled or logged at <code>error</code> if it is neither handled nor returned.
If you have an <code>error</code> value at hand that doesn&rsquo;t represent an actual error condition, but you still want to log it as an informational message, log it at <code>info</code> level with key <code>err</code>.</p><p>We might consider to make use of a broader range of log levels in the future when introducing more logs and common command line flags for our components (comparable to <code>--v</code> of Kubernetes components).
For now, we stick to the mentioned two log levels like controller-runtime: info (<code>V(0)</code>) and debug (<code>V(1)</code>).</p><h2 id=logging-in-controllers>Logging in Controllers</h2><h3 id=named-loggers>Named Loggers</h3><p>Controllers should use named loggers that include their name, e.g.:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>controllerLogger := rootLogger.WithName(<span style=color:#a31515>&#34;controller&#34;</span>).WithName(<span style=color:#a31515>&#34;shoot&#34;</span>)
</span></span><span style=display:flex><span>controllerLogger.Info(<span style=color:#a31515>&#34;Deploying kube-apiserver&#34;</span>)
</span></span></code></pre></div><p>results in</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>2021-12-16T09:27:56.550+0100    INFO    controller.shoot    Deploying kube-apiserver
</span></span></code></pre></div><p>Logger names are hierarchical. You can make use of it, where controllers are composed of multiple &ldquo;subcontrollers&rdquo;, e.g., <code>controller.shoot.hibernation</code> or <code>controller.shoot.maintenance</code>.</p><p>Using the global logger <code>logf.Log</code> directly is discouraged and should be rather exceptional because it makes correlating logs with code harder.
Preferably, all parts of the code should use some named logger.</p><h3 id=reconciler-loggers>Reconciler Loggers</h3><p>In your <code>Reconcile</code> function, retrieve a logger from the given <code>context.Context</code>.
It inherits from the controller&rsquo;s logger (i.e., is already named) and is preconfigured with <code>name</code> and <code>namespace</code> values for the reconciliation request:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>func</span> (r *reconciler) Reconcile(ctx context.Context, request reconcile.Request) (reconcile.Result, <span style=color:#2b91af>error</span>) {
</span></span><span style=display:flex><span>  log := logf.FromContext(ctx)
</span></span><span style=display:flex><span>  log.Info(<span style=color:#a31515>&#34;Reconciling Shoot&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:green>// ...
</span></span></span><span style=display:flex><span><span style=color:green></span>  <span style=color:#00f>return</span> reconcile.Result{}, <span style=color:#00f>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>results in</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>2021-12-16T09:35:59.099+0100    INFO    controller.shoot    Reconciling Shoot        {&#34;name&#34;: &#34;sunflower&#34;, &#34;namespace&#34;: &#34;garden-greenhouse&#34;}
</span></span></code></pre></div><p>The logger is injected by controller-runtime&rsquo;s <code>Controller</code> implementation. The logger returned by <code>logf.FromContext</code> is never <code>nil</code>. If the context doesn&rsquo;t carry a logger, it falls back to the global logger (<code>logf.Log</code>), which might discard logs if not configured, but is also never <code>nil</code>.</p><blockquote><p>⚠️ Make sure that you don&rsquo;t overwrite the <code>name</code> or <code>namespace</code> value keys for such loggers, otherwise you will lose information about the reconciled object.</p></blockquote><p>The controller implementation (controller-runtime) itself takes care of logging the error returned by reconcilers.
Hence, don&rsquo;t log an error that you are returning.
Generally, functions should not return an error, if they already logged it, because that means the error is already handled and not an error anymore.
See <a href=https://dave.cheney.net/2015/11/05/lets-talk-about-logging>Dave Cheney&rsquo;s post</a> for more on this.</p><h3 id=messages>Messages</h3><ul><li>Log messages should be static. Don&rsquo;t put variable content in there, i.e., no <code>fmt.Sprintf</code> or string concatenation (<code>+</code>). Use key-value pairs instead.</li><li>Log messages should be capitalized. Note: This contrasts with error messages, that should not be capitalized. However, both should not end with a punctuation mark.</li></ul><h3 id=keys-and-values>Keys and Values</h3><ul><li><p>Use <code>WithValues</code> instead of repeatedly adding key-value pairs for multiple log statements. <code>WithValues</code> creates a new logger from the parent, that carries the given key-value pairs. E.g., use it when acting on one object in multiple steps and logging something for each step:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>log := parentLog.WithValues(<span style=color:#a31515>&#34;infrastructure&#34;</span>, client.ObjectKeyFromObject(infrastrucutre))
</span></span><span style=display:flex><span><span style=color:green>// ...
</span></span></span><span style=display:flex><span><span style=color:green></span>log.Info(<span style=color:#a31515>&#34;Creating Infrastructure&#34;</span>)
</span></span><span style=display:flex><span><span style=color:green>// ...
</span></span></span><span style=display:flex><span><span style=color:green></span>log.Info(<span style=color:#a31515>&#34;Waiting for Infrastructure to be reconciled&#34;</span>)
</span></span><span style=display:flex><span><span style=color:green>// ...
</span></span></span></code></pre></div></li></ul><blockquote><p>Note: <code>WithValues</code> bypasses controller-runtime&rsquo;s special zap encoder that nicely encodes <code>ObjectKey</code>/<code>NamespacedName</code> and <code>runtime.Object</code> values, see <a href=https://github.com/kubernetes-sigs/controller-runtime/issues/1290>kubernetes-sigs/controller-runtime#1290</a>.
Thus, the end result might look different depending on the value and its <code>Stringer</code> implementation.</p></blockquote><ul><li><p>Use <a href=https://en.wiktionary.org/wiki/lowerCamelCase>lowerCamelCase</a> for keys. Don&rsquo;t put spaces in keys, as it will make log processing with simple tools like <code>jq</code> harder.</p></li><li><p>Keys should be constant, human-readable, consistent across the codebase and naturally match parts of the log message, see <a href=https://github.com/go-logr/logr#how-do-i-choose-my-keys>logr guideline</a>.</p></li><li><p>When logging object keys (name and namespace), use the object&rsquo;s type as the log key and a <code>client.ObjectKey</code>/<code>types.NamespacedName</code> value as value, e.g.:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>var</span> deployment *appsv1.Deployment
</span></span><span style=display:flex><span>log.Info(<span style=color:#a31515>&#34;Creating Deployment&#34;</span>, <span style=color:#a31515>&#34;deployment&#34;</span>, client.ObjectKeyFromObject(deployment))
</span></span></code></pre></div><p>which results in</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{&#34;level&#34;:&#34;info&#34;,&#34;ts&#34;:&#34;2021-12-16T08:32:21.059+0100&#34;,&#34;msg&#34;:&#34;Creating Deployment&#34;,&#34;deployment&#34;:{&#34;name&#34;: &#34;bar&#34;, &#34;namespace&#34;: &#34;foo&#34;}}
</span></span></code></pre></div><p>Earlier, we often used <code>kutil.ObjectName()</code> for logging object keys, which encodes them into a flat string like <code>foo/bar</code>. However, this flat string cannot be processed so easily by logging stacks (or <code>jq</code>) like a structured log. Hence, the use of <code>kutil.ObjectName()</code> for logging object keys is discouraged. Existing usages should be refactored to use <code>client.ObjectKeyFromObject()</code> instead.</p></li><li><p>There are cases where you don&rsquo;t have the full object key or the object itself at hand, e.g., if an object references another object (in the same namespace) by name (think <code>secretRef</code> or similar).
In such a cases, either construct the full object key including the implied namespace or log the object name under a key ending in <code>Name</code>, e.g.:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>var</span> (
</span></span><span style=display:flex><span>  <span style=color:green>// object to reconcile
</span></span></span><span style=display:flex><span><span style=color:green></span>  shoot *gardencorev1beta1.Shoot
</span></span><span style=display:flex><span>  <span style=color:green>// retrieved via logf.FromContext, preconfigured by controller with namespace and name of reconciliation request
</span></span></span><span style=display:flex><span><span style=color:green></span>  log logr.Logger
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green>// option a: full object key, manually constructed
</span></span></span><span style=display:flex><span><span style=color:green></span>log.Info(<span style=color:#a31515>&#34;Shoot uses SecretBinding&#34;</span>, <span style=color:#a31515>&#34;secretBinding&#34;</span>, client.ObjectKey{Namespace: shoot.Namespace, Name: *shoot.Spec.SecretBindingName})
</span></span><span style=display:flex><span><span style=color:green>// option b: only name under respective *Name log key
</span></span></span><span style=display:flex><span><span style=color:green></span>log.Info(<span style=color:#a31515>&#34;Shoot uses SecretBinding&#34;</span>, <span style=color:#a31515>&#34;secretBindingName&#34;</span>, *shoot.Spec.SecretBindingName)
</span></span></code></pre></div><p>Both options result in well-structured logs, that are easy to interpret and process:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{&#34;level&#34;:&#34;info&#34;,&#34;ts&#34;:&#34;2022-01-18T18:00:56.672+0100&#34;,&#34;msg&#34;:&#34;Shoot uses SecretBinding&#34;,&#34;name&#34;:&#34;my-shoot&#34;,&#34;namespace&#34;:&#34;garden-project&#34;,&#34;secretBinding&#34;:{&#34;namespace&#34;:&#34;garden-project&#34;,&#34;name&#34;:&#34;aws&#34;}}
</span></span><span style=display:flex><span>{&#34;level&#34;:&#34;info&#34;,&#34;ts&#34;:&#34;2022-01-18T18:00:56.673+0100&#34;,&#34;msg&#34;:&#34;Shoot uses SecretBinding&#34;,&#34;name&#34;:&#34;my-shoot&#34;,&#34;namespace&#34;:&#34;garden-project&#34;,&#34;secretBindingName&#34;:&#34;aws&#34;}
</span></span></code></pre></div></li><li><p>When handling generic <code>client.Object</code> values (e.g. in helper funcs), use <code>object</code> as key.</p></li><li><p>When adding timestamps to key-value pairs, use <code>time.Time</code> values. By this, they will be encoded in the same format as the log entry&rsquo;s timestamp.<br>Don&rsquo;t use <code>metav1.Time</code> values, as they will be encoded in a different format by their <code>Stringer</code> implementation. Pass <code>&lt;someTimestamp>.Time</code> to loggers in case you have a <code>metav1.Time</code> value at hand.</p></li><li><p>Same applies to durations. Use <code>time.Duration</code> values instead of <code>*metav1.Duration</code>. Durations can be handled specially by zap just like timestamps.</p></li><li><p>Event recorders not only create <code>Event</code> objects but also log them.
However, both Gardener&rsquo;s manually instantiated event recorders and the ones that controller-runtime provides log to <code>debug</code> level and use generic formats, that are not very easy to interpret or process (no structured logs).
Hence, don&rsquo;t use event recorders as replacements for well-structured logs.
If a controller records an event for a completed action or important information, it should probably log it as well, e.g.:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>log.Info(<span style=color:#a31515>&#34;Creating ManagedSeed&#34;</span>, <span style=color:#a31515>&#34;replica&#34;</span>, r.GetObjectKey())
</span></span><span style=display:flex><span>a.recorder.Eventf(managedSeedSet, corev1.EventTypeNormal, EventCreatingManagedSeed, <span style=color:#a31515>&#34;Creating ManagedSeed %s&#34;</span>, r.GetFullName())
</span></span></code></pre></div></li></ul><h2 id=logging-in-test-code>Logging in Test Code</h2><ul><li><p>If the tested production code requires a logger, you can pass <code>logr.Discard()</code> or <code>logf.NullLogger{}</code> in your test, which simply discards all logs.</p></li><li><p><code>logf.Log</code> is safe to use in tests and will not cause a nil pointer deref, even if it&rsquo;s not initialized via <code>logf.SetLogger</code>.
It is initially set to a <code>NullLogger</code> by default, which means all logs are discarded, unless <code>logf.SetLogger</code> is called in the first 30 seconds of execution.</p></li><li><p>Pass <code>zap.WriteTo(GinkgoWriter)</code> in tests where you want to see the logs on test failure but not on success, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>logf.SetLogger(logger.MustNewZapLogger(logger.DebugLevel, logger.FormatJSON, zap.WriteTo(GinkgoWriter)))
</span></span><span style=display:flex><span>log := logf.Log.WithName(<span style=color:#a31515>&#34;test&#34;</span>)
</span></span></code></pre></div></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d42cb3e424a70c7c39b9f2acb996f1c8>10 - Monitoring Stack</h1><h1 id=extending-the-monitoring-stack>Extending the Monitoring Stack</h1><p>This document provides instructions to extend the Shoot cluster monitoring stack by integrating new scrape targets, alerts and dashboards.</p><p>Please ensure that you have understood the basic principles of <a href=https://prometheus.io/docs/introduction/overview/>Prometheus</a> and its ecosystem before you continue.</p><p>‼️ <strong>The purpose of the monitoring stack is to observe the behaviour of the control plane and the system components deployed by Gardener onto the worker nodes. Monitoring of custom workloads running in the cluster is out of scope.</strong></p><h2 id=overview>Overview</h2><p><img src=/__resources/monitoring-architecture_cd945d.png alt="Monitoring Architecture"></p><p>Each Shoot cluster comes with its own monitoring stack. The following components are deployed into the seed and shoot:</p><ul><li>Seed<ul><li><a href=https://github.com/prometheus/prometheus>Prometheus</a></li><li><a href=https://github.com/credativ/plutono>Plutono</a></li><li><a href=https://github.com/prometheus/blackbox_exporter>blackbox-exporter</a></li><li><a href=https://github.com/kubernetes/kube-state-metrics>kube-state-metrics</a> (Seed metrics)</li><li><a href=https://github.com/kubernetes/kube-state-metrics>kube-state-metrics</a> (Shoot metrics)</li><li><a href=https://github.com/prometheus/alertmanager>Alertmanager</a> (Optional)</li></ul></li><li>Shoot<ul><li><a href=https://github.com/prometheus/node_exporter>node-exporter(s)</a></li><li><a href=https://github.com/kubernetes/kube-state-metrics>kube-state-metrics</a></li><li><a href=https://github.com/prometheus/blackbox_exporter>blackbox-exporter</a></li></ul></li></ul><p>In each Seed cluster there is a Prometheus in the <code>garden</code> namespace responsible for collecting metrics from the Seed kubelets and cAdvisors. These metrics are provided to each Shoot Prometheus via federation.</p><p>The alerts for all Shoot clusters hosted on a Seed are routed to a central Alertmanger running in the <code>garden</code> namespace of the Seed. The purpose of this central Alertmanager is to forward all important alerts to the operators of the Gardener setup.</p><p>The Alertmanager in the Shoot namespace on the Seed is only responsible for forwarding alerts from its Shoot cluster to a cluster owner/cluster alert receiver via email. The Alertmanager is optional and the conditions for a deployment are already described in <a href=/docs/gardener/monitoring/alerting/>Alerting</a>.</p><h2 id=adding-new-monitoring-targets>Adding New Monitoring Targets</h2><p>After exploring the metrics which your component provides or adding new metrics, you should be aware which metrics are required to write the needed alerts and dashboards.</p><p>Prometheus prefers a pull based metrics collection approach and therefore the targets to observe need to be defined upfront. The targets are defined in <code>charts/seed-monitoring/charts/core/charts/prometheus/templates/config.yaml</code>.
New scrape jobs can be added in the section <code>scrape_configs</code>. Detailed information how to configure scrape jobs and how to use the kubernetes service discovery are available in the <a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config>Prometheus documentation</a>.</p><p>The <code>job_name</code> of a scrape job should be the name of the component e.g. <code>kube-apiserver</code> or <code>vpn</code>. The collection interval should be the default of <code>30s</code>. You do not need to specify this in the configuration.</p><p>Please do not ingest all metrics which are provided by a component. Rather, collect only those metrics which are needed to define the alerts and dashboards (i.e. whitelist). This can be achieved by adding the following <code>metric_relabel_configs</code> statement to your scrape jobs (replace <code>exampleComponent</code> with component name).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    - job_name: example-component
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>      metric_relabel_configs:
</span></span><span style=display:flex><span>{{ include &#34;prometheus.keep-metrics.metric-relabel-config&#34; .Values.allowedMetrics.exampleComponent | indent 6 }}
</span></span></code></pre></div><p>The whitelist for the metrics of your job can be maintained in <code>charts/seed-monitoring/charts/core/charts/prometheus/values.yaml</code> in section <code>allowedMetrics.exampleComponent</code> (replace <code>exampleComponent</code> with component name). Check the following example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>allowedMetrics:
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  exampleComponent:
</span></span><span style=display:flex><span>  * metrics_name_1
</span></span><span style=display:flex><span>  * metrics_name_2
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><h2 id=adding-alerts>Adding Alerts</h2><p>The alert definitons are located in <code>charts/seed-monitoring/charts/core/charts/prometheus/rules</code>. There are two approaches for adding new alerts.</p><ol><li>Adding additional alerts for a component which already has a set of alerts. In this case you have to extend the existing rule file for the component.</li><li>Adding alerts for a new component. In this case a new rule file with name scheme <code>example-component.rules.yaml</code> needs to be added.</li><li>Add the new alert to <code>alertInhibitionGraph.dot</code>, add any required inhibition flows and render the new graph. To render the graph, run:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dot -Tpng ./content/alertInhibitionGraph.dot -o ./content/alertInhibitionGraph.png
</span></span></code></pre></div><ol><li>Create a test for the new alert. See <code>Alert Tests</code>.</li></ol><p>Example alert:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>groups:
</span></span><span style=display:flex><span>* name: example.rules
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  * alert: ExampleAlert
</span></span><span style=display:flex><span>    expr: absent(up{job=&#34;exampleJob&#34;} == 1)
</span></span><span style=display:flex><span>    for: 20m
</span></span><span style=display:flex><span>    labels:
</span></span><span style=display:flex><span>      service: example
</span></span><span style=display:flex><span>      severity: critical <span style=color:green># How severe is the alert? (blocker|critical|info|warning)</span>
</span></span><span style=display:flex><span>      type: shoot <span style=color:green># For which topology is the alert relevant? (seed|shoot)</span>
</span></span><span style=display:flex><span>      visibility: all <span style=color:green># Who should receive the alerts? (all|operator|owner)</span>
</span></span><span style=display:flex><span>    annotations:
</span></span><span style=display:flex><span>      description: A longer description of the example alert that should also explain the impact of the alert.
</span></span><span style=display:flex><span>      summary: Short summary of an example alert.
</span></span></code></pre></div><p>If the deployment of component is optional then the alert definitions needs to be added to <code>charts/seed-monitoring/charts/core/charts/prometheus/optional-rules</code> instead. Furthermore the alerts for component need to be activatable in <code>charts/seed-monitoring/charts/core/charts/prometheus/values.yaml</code> via <code>rules.optional.example-component.enabled</code>. The default should be <code>true</code>.</p><p>Basic instruction how to define alert rules can be found in the <a href=https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules>Prometheus documentation</a>.</p><h3 id=routing-tree>Routing Tree</h3><p>The Alertmanager is grouping incoming alerts based on labels into buckets. Each bucket has its own configuration like alert receivers, initial delaying duration or resending frequency, etc. You can find more information about Alertmanager routing in the <a href=https://prometheus.io/docs/alerting/configuration/#route>Prometheus/Alertmanager documentation</a>. The routing trees for the Alertmanagers deployed by Gardener are depicted below.</p><p>Central Seed Alertmanager</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>∟ main route (all alerts for all shoots on the seed will enter)
</span></span><span style=display:flex><span>  ∟ group by project and shoot name
</span></span><span style=display:flex><span>    ∟ group by visibility &#34;all&#34; and &#34;operator&#34;
</span></span><span style=display:flex><span>      ∟ group by severity &#34;blocker&#34;, &#34;critical&#34;, and &#34;info&#34; → route to Garden operators
</span></span><span style=display:flex><span>      ∟ group by severity &#34;warning&#34; (dropped)
</span></span><span style=display:flex><span>    ∟ group by visibility &#34;owner&#34; (dropped)
</span></span></code></pre></div><p>Shoot Alertmanager</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>∟ main route (only alerts for one Shoot will enter)
</span></span><span style=display:flex><span>  ∟ group by visibility &#34;all&#34; and &#34;owner&#34;
</span></span><span style=display:flex><span>    ∟ group by severity &#34;blocker&#34;, &#34;critical&#34;, and &#34;info&#34; → route to cluster alert receiver
</span></span><span style=display:flex><span>    ∟ group by severity &#34;warning&#34; (dropped, will change soon → route to cluster alert receiver)
</span></span><span style=display:flex><span>  ∟ group by visibility &#34;operator&#34; (dropped)
</span></span></code></pre></div><h3 id=alert-inhibition>Alert Inhibition</h3><p>All alerts related to components running on the Shoot workers are inhibited in case of an issue with the vpn connection, because those components can&rsquo;t be scraped anymore and Prometheus will fire alerts in consequence. The components running on the workers are probably healthy and the alerts are presumably false positives. The inhibition flow is shown in the figure below. If you add a new alert, make sure to add it to the diagram.</p><p><img src=/__resources/alertInhibitionGraph_ceaef0.png alt=alertDiagram></p><h3 id=alert-attributes>Alert Attributes</h3><p>Each alert rule definition has to contain the following annotations:</p><ul><li><strong>summary</strong>: A short description of the issue.</li><li><strong>description</strong>: A detailed explanation of the issue with hints to the possible root causes and the impact assessment of the issue.</li></ul><p>In addtion, each alert must contain the following labels:</p><ul><li><strong>type</strong><ul><li><code>shoot</code>: Components running on the Shoot worker nodes in the <code>kube-system</code> namespace.</li><li><code>seed</code>: Components running on the Seed in the Shoot namespace as part of/next to the control plane.</li></ul></li><li><strong>service</strong><ul><li>Name of the component (in lowercase) e.g. <code>kube-apiserver</code>, <code>alertmanager</code> or <code>vpn</code>.</li></ul></li><li><strong>severity</strong><ul><li><code>blocker</code>: All issues which make the cluster entirely unusable, e.g. <code>KubeAPIServerDown</code> or <code>KubeSchedulerDown</code></li><li><code>critical</code>: All issues which affect single functionalities/components but do not affect the cluster in its core functionality e.g. <code>VPNDown</code> or <code>KubeletDown</code>.</li><li><code>info</code>: All issues that do not affect the cluster or its core functionality, but if this component is down we cannot determine if a blocker alert is firing. (i.e. A component with an info level severity is a dependency for a component with a blocker severity)</li><li><code>warning</code>: No current existing issue, rather a hint for situations which could lead to real issue in the close future e.g. <code>HighLatencyApiServerToWorkers</code> or <code>ApiServerResponseSlow</code>.</li></ul></li></ul><h3 id=alert-tests>Alert Tests</h3><p>To test the Prometheus alerts:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make test-prometheus
</span></span></code></pre></div><p>If you want to add alert tests:</p><ol><li><p>Create a new file in <code>rules-tests</code> in the form <code>&lt;alert-group-name>.rules.test.yaml</code> or if the alerts are for an existing component with existing tests, simply add the tests to the appropriate files.</p></li><li><p>Make sure that newly added tests succeed. See above.</p></li></ol><h2 id=adding-plutono-dashboards>Adding Plutono Dashboards</h2><p>The dashboard definition files are located in <code>charts/seed-monitoring/charts/plutono/dashboards</code>. Every dashboard needs its own file.</p><p>If you are adding a new component dashboard please also update the overview dashboard by adding a chart for its current up/down status and with a drill down option to the component dashboard.</p><h3 id=dashboard-structure>Dashboard Structure</h3><p>The dashboards should be structured in the following way. The assignment of the component dashboards to the categories should be handled via dashboard tags.</p><ul><li>Kubernetes control plane components (Tag: <code>control-plane</code>)<ul><li>All components which are part of the Kubernetes control plane e. g. Kube API Server, Kube Controller Manager, Kube Scheduler and Cloud Controller Manager</li><li>ETCD + Backup/Restore</li><li>Kubernetes Addon Manager</li></ul></li><li>Node/Machine components (Tag: <code>node/machine</code>)<ul><li>All metrics which are related to the behaviour/control of the Kubernetes nodes and kubelets</li><li>Machine-Controller-Manager + Cluster Autoscaler</li></ul></li><li>Networking components (Tag: <code>network</code>)<ul><li>CoreDNS, KubeProxy, Calico, VPN, Nginx Ingress</li></ul></li><li>Addon components (Tag: <code>addon</code>)<ul><li>Cert Broker</li></ul></li><li>Monitoring components (Tag: <code>monitoring</code>)</li><li>Logging components (Tag: <code>logging</code>)</li></ul><h4 id=mandatory-charts-for-component-dashboards>Mandatory Charts for Component Dashboards</h4><p>For each new component, its corresponding dashboard should contain the following charts in the first row, before adding custom charts for the component in the subsequent rows.</p><ol><li>Pod up/down status <code>up{job="example-component"}</code></li><li>Pod/containers cpu utilization</li><li>Pod/containers memorty consumption</li><li>Pod/containers network i/o</li></ol><p>That information is provided by the cAdvisor metrics. These metrics are already integrated. Please check the other dashboards for detailed information on how to query.</p><h5 id=chart-requirements>Chart Requirements</h5><p>Each chart needs to contain:</p><ul><li>a meaningful name</li><li>a detailed description (for non trivial charts)</li><li>appropriate x/y axis descriptions</li><li>appropriate scaling levels for the x/y axis</li><li>proper units for the x/y axis</li></ul><h5 id=dashboard-parameters>Dashboard Parameters</h5><p>The following parameters should be added to all dashboards to ensure a homogeneous experience across all dashboards.</p><p>Dashboards have to:</p><ul><li>contain a title which refers to the component name(s)</li><li>contain a timezone statement which should be the browser time</li><li>contain tags which express where the component is running (<code>seed</code> or <code>shoot</code>) and to which category the component belong (see dashboard structure)</li><li>contain a version statement with a value of 1</li><li>be immutable</li></ul><p>Example dashboard configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;title&#34;: <span style=color:#a31515>&#34;example-component&#34;</span>,
</span></span><span style=display:flex><span>  &#34;timezone&#34;: <span style=color:#a31515>&#34;utc&#34;</span>,
</span></span><span style=display:flex><span>  &#34;tags&#34;: [
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#34;seed&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#34;control-plane&#34;</span>
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  &#34;version&#34;: 1,
</span></span><span style=display:flex><span>  &#34;editable&#34;: <span style=color:#a31515>&#34;false&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Furthermore, all dashboards should contain the following time options:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;time&#34;: {
</span></span><span style=display:flex><span>    &#34;from&#34;: <span style=color:#a31515>&#34;now-1h&#34;</span>,
</span></span><span style=display:flex><span>    &#34;to&#34;: <span style=color:#a31515>&#34;now&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  &#34;timepicker&#34;: {
</span></span><span style=display:flex><span>    &#34;refresh_intervals&#34;: [
</span></span><span style=display:flex><span>      <span style=color:#a31515>&#34;30s&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a31515>&#34;1m&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a31515>&#34;5m&#34;</span>
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    &#34;time_options&#34;: [
</span></span><span style=display:flex><span>      <span style=color:#a31515>&#34;5m&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a31515>&#34;15m&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a31515>&#34;1h&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a31515>&#34;6h&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a31515>&#34;12h&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a31515>&#34;24h&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a31515>&#34;2d&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a31515>&#34;10d&#34;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-0323918722a5b41e437d646bc4e3ca40>11 - New Cloud Provider</h1><h1 id=adding-cloud-providers>Adding Cloud Providers</h1><p>This document provides an overview of how to integrate a new cloud provider into Gardener. Each component that requires integration has a detailed description of how to integrate it and the steps required.</p><h2 id=cloud-components>Cloud Components</h2><p>Gardener is composed of 2 or more Kubernetes clusters:</p><ul><li>Shoot: These are the end-user clusters, the regular Kubernetes clusters you have seen. They provide places for your workloads to run.</li><li>Seed: This is the &ldquo;management&rdquo; cluster. It manages the control planes of shoots by running them as native Kubernetes workloads.</li></ul><p>These two clusters can run in the same cloud provider, but they do not need to. For example, you could run your Seed in AWS, while having one shoot in Azure, two in Google, two in Alicloud, and three in Equinix Metal.</p><p>The Seed cluster deploys and manages the Shoot clusters. Importantly, for this discussion, the <code>etcd</code> data store backing each Shoot runs as workloads inside the Seed. Thus, to use the above example, the clusters in Azure, Google, Alicloud and Equinix Metal will have their worker nodes and master nodes running in those clouds, but the <code>etcd</code> clusters backing them will run as separate <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/>deployments</a> in the Seed Kubernetes cluster on AWS.</p><p>This distinction becomes important when preparing the integration to a new cloud provider.</p><h2 id=gardener-cloud-integration>Gardener Cloud Integration</h2><p>Gardener and its related components integrate with cloud providers at the following key lifecycle elements:</p><ul><li>Create/destroy/get/list machines for the Shoot.</li><li>Create/destroy/get/list infrastructure components for the Shoot, e.g. VPCs, subnets, routes, etc.</li><li>Backup/restore etcd for the Seed via writing files to and reading them from object storage.</li></ul><p>Thus, the integrations you need for your cloud provider depend on whether you want to deploy Shoot clusters to the provider, Seed or both.</p><ul><li>Shoot Only: machine lifecycle management, infrastructure</li><li>Seed: etcd backup/restore</li></ul><h2 id=gardener-api>Gardener API</h2><p>In addition to the requirements to integrate with the cloud provider, you also need to enable the core Gardener app to receive, validate, and process requests to use that cloud provider.</p><ul><li>Expose the cloud provider to the consumers of the Gardener API, so it can be told to use that cloud provider as an option.</li><li>Validate that API as requests come in.</li><li>Write cloud provider specific implementation (called &ldquo;provider extension&rdquo;).</li></ul><h2 id=cloud-provider-api-requirements>Cloud Provider API Requirements</h2><p>In order for a cloud provider to integrate with Gardener, the provider must have an API to perform machine lifecycle events, specifically:</p><ul><li>Create a machine</li><li>Destroy a machine</li><li>Get information about a machine and its state</li><li>List machines</li></ul><p>In addition, if the Seed is to run on the given provider, it also must have an API to save files to block storage and retrieve them, for etcd backup/restore.</p><p>The current integration with cloud providers is to add their API calls to Gardener and the Machine Controller Manager. As both Gardener and the Machine Controller Manager are written in <a href=https://golang.org>go</a>, the cloud provider should have a go SDK. However, if it has an API that is wrappable in go, e.g. a REST API, then you can use that to integrate.</p><p>The Gardener team is working on bringing cloud provider integrations out-of-tree, making them pluggable, which should simplify the process and make it possible to use other SDKs.</p><h2 id=summary>Summary</h2><p>To add a new cloud provider, you need some or all of the following. Each repository contains instructions on how to extend it to a new cloud provider.</p><table><thead><tr><th>Type</th><th>Purpose</th><th>Location</th><th>Documentation</th></tr></thead><tbody><tr><td>Seed or Shoot</td><td>Machine Lifecycle</td><td><a href=https://github.com/gardener/machine-controller-manager>machine-controller-manager</a></td><td><a href=/docs/other-components/machine-controller-manager/development/cp_support_new/>MCM new cloud provider</a></td></tr><tr><td>Seed only</td><td>etcd backup/restore</td><td><a href=https://github.com/gardener/etcd-backup-restore/>etcd-backup-restore</a></td><td>In process</td></tr><tr><td>All</td><td>Extension implementation</td><td><a href=https://github.com/gardener/gardener>gardener</a></td><td><a href=/docs/gardener/extensions/overview/>Extension controller</a></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-d926243c7cdf1cf05524b388093c464b>12 - New Kubernetes Version</h1><h1 id=adding-support-for-a-new-kubernetes-version>Adding Support For a New Kubernetes Version</h1><p>This document describes the steps needed to perform in order to confidently add support for a new Kubernetes <strong>minor</strong> version.</p><blockquote><p>⚠️ Typically, once a minor Kubernetes version <code>vX.Y</code> is supported by Gardener, then all patch versions <code>vX.Y.Z</code> are also automatically supported without any required action.
This is because patch versions do not introduce any new feature or API changes, so there is nothing that needs to be adapted in <code>gardener/gardener</code> code.</p></blockquote><p>The Kubernetes community release a new minor version roughly every 4 months.
Please refer to the <a href=https://kubernetes.io/releases/release/>official documentation</a> about their release cycles for any additional information.</p><p>Shortly before a new release, an &ldquo;umbrella&rdquo; issue should be opened which is used to collect the required adaptations and to track the work items.
For example, <a href=https://github.com/gardener/gardener/issues/5102>#5102</a> can be used as a template for the issue description.
As you can see, the task of supporting a new Kubernetes version also includes the provider extensions maintained in the <code>gardener</code> GitHub organization and is not restricted to <code>gardener/gardener</code> only.</p><p>Generally, the work items can be split into two groups:
The first group contains tasks specific to the changes in the given Kubernetes release, the second group contains Kubernetes release-independent tasks.</p><blockquote><p>ℹ️ Upgrading the <code>k8s.io/*</code> and <code>sigs.k8s.io/controller-runtime</code> Golang dependencies is typically tracked and worked on separately (see e.g. <a href=https://github.com/gardener/gardener/issues/4772>#4772</a> or <a href=https://github.com/gardener/gardener/issues/5282>#5282</a>).</p></blockquote><h2 id=deriving-release-specific-tasks>Deriving Release-Specific Tasks</h2><p>Most new minor Kubernetes releases incorporate API changes, deprecations, or new features.
The community announces them via their <a href=https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/>change logs</a>.
In order to derive the release-specific tasks, the respective change log for the new version <code>vX.Y</code> has to be read and understood (for example, <a href=https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.24.md>the changelog</a> for <code>v1.24</code>).</p><p>As already mentioned, typical changes to watch out for are:</p><ul><li>API version promotions or deprecations</li><li>Feature gate promotions or deprecations</li><li>CLI flag changes for Kubernetes components</li><li>New default values in resources</li><li>New available fields in resources</li><li>New features potentially relevant for the Gardener system</li><li>Changes of labels or annotations Gardener relies on</li><li>&mldr;</li></ul><p>Obviously, this requires a certain experience and understanding of the Gardener project so that all &ldquo;relevant changes&rdquo; can be identified.
While reading the change log, add the tasks (along with the respective PR in <code>kubernetes/kubernetes</code> to the umbrella issue).</p><blockquote><p>ℹ️ Some of the changes might be specific to certain cloud providers. Pay attention to those as well and add related tasks to the issue.</p></blockquote><h2 id=list-of-release-independent-tasks>List Of Release-Independent Tasks</h2><p>The following paragraphs describe recurring tasks that need to be performed for each new release.</p><h3 id=make-sure-a-new-hyperkube-image-is-released>Make Sure a New <code>hyperkube</code> Image Is Released</h3><p>The <a href=https://github.com/gardener/hyperkube><code>gardener/hyperkube</code></a> repository is used to release container images consisting of the <code>kubectl</code> and <code>kubelet</code> binaries.</p><p>There is a CI/CD job that runs periodically and releases a new <code>hyperkube</code> image when there is a new Kubernetes release. Before proceeding with the next steps, make sure that a new <code>hyperkube</code> image is released for the corresponding new Kubernetes minor version. Make sure that container image is present in GCR.</p><h3 id=adapting-gardener>Adapting Gardener</h3><ul><li>Allow instantiation of a Kubernetes client for the new minor version and update the <code>README.md</code>:<ul><li>See <a href=https://github.com/gardener/gardener/pull/5255/commits/63bdae022f1cb1c9cbd1cd49b557545dca2ec32a>this</a> example commit.</li><li>The list of supported versions is meanwhile maintained <a href=https://github.com/gardener/gardener/blob/master/pkg/utils/validation/kubernetesversion/version.go>here</a> in the <code>SupportedVersions</code> variable.</li></ul></li><li>Maintain the Kubernetes feature gates used for validation of <code>Shoot</code> resources:<ul><li>The feature gates are maintained in <a href=https://github.com/gardener/gardener/blob/master/pkg/utils/validation/features/featuregates.go>this</a> file.</li><li>To maintain this list for new Kubernetes versions, run <code>hack/compare-k8s-feature-gates.sh &lt;old-version> &lt;new-version></code> (e.g. <code>hack/compare-k8s-feature-gates.sh v1.22 v1.23</code>).</li><li>It will present 3 lists of feature gates: those added and those removed in <code>&lt;new-version></code> compared to <code>&lt;old-version></code> and feature gates that got locked to default in <code>&lt;new-version></code>.</li><li>Add all added feature gates to the map with <code>&lt;new-version></code> as <code>AddedInVersion</code> and no <code>RemovedInVersion</code>.</li><li>For any removed feature gates, add <code>&lt;new-version></code> as <code>RemovedInVersion</code> to the already existing feature gate in the map.</li><li>For feature gates locked to default, add <code>&lt;new-version></code> as <code>LockedToDefaultInVersion</code> to the already existing feature gate in the map.</li><li>See <a href=https://github.com/gardener/gardener/pull/5255/commits/97923b0604300ff805def8eae981ed388d5e4a83>this</a> example commit.</li></ul></li><li>Maintain the Kubernetes <code>kube-apiserver</code> admission plugins used for validation of <code>Shoot</code> resources:<ul><li>The admission plugins are maintained in <a href=https://github.com/gardener/gardener/blob/master/pkg/utils/validation/admissionplugins/admissionplugins.go>this</a> file.</li><li>To maintain this list for new Kubernetes versions, run <code>hack/compare-k8s-admission-plugins.sh &lt;old-version> &lt;new-version></code> (e.g. <code>hack/compare-k8s-admission-plugins.sh 1.24 1.25</code>).</li><li>It will present 2 lists of admission plugins: those added and those removed in <code>&lt;new-version></code> compared to <code>&lt;old-version></code>.</li><li>Add all added admission plugins to the <code>admissionPluginsVersionRanges</code> map with <code>&lt;new-version></code> as <code>AddedInVersion</code> and no <code>RemovedInVersion</code>.</li><li>For any removed admission plugins, add <code>&lt;new-version></code> as <code>RemovedInVersion</code> to the already existing admission plugin in the map.</li><li>Flag any admission plugins that are required (plugins that must not be disabled in the <code>Shoot</code> spec) by setting the <code>Required</code> boolean variable to true for the admission plugin in the map.</li><li>Flag any admission plugins that are forbidden by setting the <code>Forbidden</code> boolean variable to true for the admission plugin in the map.</li></ul></li><li>Maintain the <code>ServiceAccount</code> names for the controllers part of <code>kube-controller-manager</code>:<ul><li>The names are maintained in <a href=https://github.com/gardener/gardener/blob/master/pkg/component/shootsystem/shootsystem.go>this</a> file.</li><li>To maintain this list for new Kubernetes versions, run <code>hack/compare-k8s-controllers.sh &lt;old-version> &lt;new-version></code> (e.g. <code>hack/compare-k8s-controllers.sh 1.22 1.23</code>).</li><li>It will present 2 lists of controllers: those added and those removed in <code>&lt;new-version></code> compared to <code>&lt;old-version></code>.</li><li>Double check whether such <code>ServiceAccount</code> indeed appears in the <code>kube-system</code> namespace when creating a cluster with <code>&lt;new-version></code>. Note that it sometimes might be hidden behind a default-off feature gate. You can create a local cluster with the new version using the <a href=/docs/gardener/development/getting_started_locally/>local provider</a>.</li><li>If it appears, add all added controllers to the list based on the Kubernetes version (<a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/shootsystem/shootsystem.go#L253-L318>example</a>).</li><li>For any removed controllers, add them only to the Kubernetes version if it is low enough.</li></ul></li><li>Maintain the names of controllers used for workerless Shoots, <a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/kubecontrollermanager/kube_controller_manager.go#L683C27-L709>here</a> after carefully evaluating whether they are needed if there are no workers.</li><li>Maintain copies of the <code>DaemonSet</code> controller&rsquo;s scheduling logic:<ul><li><code>gardener-resource-manager</code>&rsquo;s <a href=/docs/gardener/concepts/resource-manager/#node-controllerpkgresourcemanagercontrollernode><code>Node</code> controller</a> uses a copy of parts of the <code>DaemonSet</code> controller&rsquo;s logic for determining whether a specific <code>Node</code> should run a daemon pod of a given <code>DaemonSet</code>: see <a href=https://github.com/gardener/gardener/blob/master/pkg/resourcemanager/controller/node/helper/daemon_controller.go>this file</a>.</li><li>Check the referenced upstream files for changes to the <code>DaemonSet</code> controller&rsquo;s logic and adapt our copies accordingly. This might include introducing version-specific checks in our codebase to handle different shoot cluster versions.</li></ul></li><li>Bump the used Kubernetes version for local <code>Shoot</code> and local e2e test.<ul><li>See <a href=https://github.com/gardener/gardener/pull/5255/commits/5707c4c7a4fd265b176387178b755cabeea89ffe>this</a> example commit.</li></ul></li></ul><h4 id=filing-the-pull-request>Filing the Pull Request</h4><p>Work on all the tasks you have collected and validate them using the <a href=/docs/gardener/development/getting_started_locally/>local provider</a>.
Execute the e2e tests and if everything looks good, then go ahead and file the PR (<a href=https://github.com/gardener/gardener/pull/5255>example PR</a>).
Generally, it is great if you add the PRs also to the umbrella issue so that they can be tracked more easily.</p><h3 id=adapting-provider-extensions>Adapting Provider Extensions</h3><p>After the PR in <code>gardener/gardener</code> for the support of the new version has been merged, you can go ahead and work on the provider extensions.</p><blockquote><p>Actually, you can already start even if the PR is not yet merged and use the branch of your fork.</p></blockquote><ul><li>Revendor the <code>github.com/gardener/gardener</code> dependency in the extension and update the <code>README.md</code>.</li><li>Work on release-specific tasks related to this provider.</li></ul><h4 id=maintaining-the-cloud-controller-manager-images>Maintaining the <code>cloud-controller-manager</code> Images</h4><p>Some of the cloud providers are not yet using upstream <code>cloud-controller-manager</code> images.
Instead, we build and maintain them ourselves:</p><ul><li><a href=https://github.com/gardener/cloud-provider-aws>https://github.com/gardener/cloud-provider-aws</a></li><li><a href=https://github.com/gardener/cloud-provider-azure>https://github.com/gardener/cloud-provider-azure</a> (since <code>v1.23</code>, we use the upstream image)</li><li><a href=https://github.com/gardener/cloud-provider-gcp>https://github.com/gardener/cloud-provider-gcp</a></li></ul><p>Until we switch to upstream images, you need to revendor the Kubernetes dependencies and release a new image.
The required steps are as follows:</p><ul><li>Checkout the <code>legacy-cloud-provider</code> branch of the respective repository</li><li>Bump the versions in the <code>Dockerfile</code> (<a href=https://github.com/gardener/cloud-provider-gcp/commit/b7eb3f56b252aaf29adc78406672574b1bc17495>example commit</a>).</li><li>Update the <code>VERSION</code> to <code>vX.Y.Z-dev</code> where <code>Z</code> is the latest available Kubernetes patch version for the <code>vX.Y</code> minor version.</li><li>Update the <code>k8s.io/*</code> dependencies in the <code>go.mod</code> file to <code>vX.Y.Z</code> and run <code>go mod vendor</code> and <code>go mod tidy</code> (<a href=https://github.com/gardener/cloud-provider-gcp/commit/d41cc9f035bcc4893b40d90a4f617c4d436c5d62>example commit</a>).</li><li>Checkout a new <code>release-vX.Y</code> branch and release it (<a href=https://github.com/gardener/cloud-provider-gcp/commits/release-v1.23>example</a>)</li></ul><blockquote><p>As you are already on it, it is great if you also bump the <code>k8s.io/*</code> dependencies for the last three minor releases as well.
In this case, you need to checkout the <code>release-vX.{Y-{1,2,3}}</code> branches and only perform the last three steps (<a href=https://github.com/gardener/cloud-provider-gcp/commits/release-v1.20>example branch</a>, <a href=https://github.com/gardener/cloud-provider-gcp/commit/372aa43fbacdeb76b3da9f6fad6cfd924d916227>example commit</a>).</p></blockquote><p>Now you need to update the new releases in the <code>charts/images.yaml</code> of the respective provider extension so that they are used (see this <a href=https://github.com/gardener/gardener-extension-provider-aws/pull/480/commits/76256de933d5a508aba26a8f589dd1a39026142e>example commit</a> for reference).</p><h4 id=filing-the-pull-request-1>Filing the Pull Request</h4><p>Again, work on all the tasks you have collected.
This time, you cannot use the local provider for validation but should create real clusters on the various infrastructures.
Typically, the following validations should be performed:</p><ul><li>Create new clusters with versions &lt; <code>vX.Y</code></li><li>Create new clusters with version = <code>vX.Y</code></li><li>Upgrade old clusters from version <code>vX.{Y-1}</code> to version <code>vX.Y</code></li><li>Delete clusters with versions &lt; <code>vX.Y</code></li><li>Delete clusters with version = <code>vX.Y</code></li></ul><p>If everything looks good, then go ahead and file the PR (<a href=https://github.com/gardener/gardener-extension-provider-aws/pull/480>example PR</a>).
Generally, it is again great if you add the PRs also to the umbrella issue so that they can be tracked more easily.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-255067da5c8d985de3cf53847d3ecf4b>13 - Priority Classes</h1><h1 id=priorityclasses-in-gardener-clusters><code>PriorityClass</code>es in Gardener Clusters</h1><p>Gardener makes use of <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/><code>PriorityClass</code>es</a> to improve the overall robustness of the system.
In order to benefit from the full potential of <code>PriorityClass</code>es, the gardenlet manages a set of well-known <code>PriorityClass</code>es with fine-granular priority values.</p><p>All components of the system should use these well-known <code>PriorityClass</code>es instead of creating and using separate ones with arbitrary values, which would compromise the overall goal of using <code>PriorityClass</code>es in the first place.
The gardenlet manages the well-known <code>PriorityClass</code>es listed in this document, so that third parties (e.g., Gardener extensions) can rely on them to be present when deploying components to Seed and Shoot clusters.</p><p>The listed well-known <code>PriorityClass</code>es follow this rough concept:</p><ul><li>Values are close to the maximum that can be declared by the user. This is important to ensure that Shoot system components have higher priority than the workload deployed by end-users.</li><li>Values have a bit of headroom in between to ensure flexibility when the need for intermediate priority values arises.</li><li>Values of <code>PriorityClass</code>es created on Seed clusters are lower than the ones on Shoots to ensure that Shoot system components have higher priority than Seed components, if the Seed is backed by a Shoot (<code>ManagedSeed</code>), e.g. <code>coredns</code> should have higher priority than <code>gardenlet</code>.</li><li>Names simply include the last digits of the value to minimize confusion caused by many (similar) names like <code>critical</code>, <code>importance-high</code>, etc.</li></ul><h2 id=garden-clusters>Garden Clusters</h2><p>When using the <code>gardener-operator</code> for managing the garden runtime and virtual cluster, the following <code>PriorityClass</code>es are available:</p><h3 id=priorityclasses-for-garden-control-plane-components><code>PriorityClass</code>es for Garden Control Plane Components</h3><table><thead><tr><th>Name</th><th>Priority</th><th>Associated Components (Examples)</th></tr></thead><tbody><tr><td><code>gardener-garden-system-critical</code></td><td>999999550</td><td><code>gardener-operator</code>, <code>gardener-resource-manager</code>, <code>istio</code></td></tr><tr><td><code>gardener-garden-system-500</code></td><td>999999500</td><td><code>virtual-garden-etcd-events</code>, <code>virtual-garden-etcd-main</code>, <code>virtual-garden-kube-apiserver</code></td></tr><tr><td><code>gardener-garden-system-400</code></td><td>999999400</td><td><code>virtual-garden-gardener-resource-manager</code></td></tr><tr><td><code>gardener-garden-system-300</code></td><td>999999300</td><td><code>virtual-garden-kube-controller-manager</code>, <code>vpa-admission-controller</code>, <code>etcd-druid</code></td></tr><tr><td><code>gardener-garden-system-200</code></td><td>999999200</td><td><code>vpa-recommender</code>, <code>vpa-updater</code>, <code>hvpa-controller</code></td></tr><tr><td><code>gardener-garden-system-100</code></td><td>999999100</td><td><code>kube-state-metrics</code></td></tr></tbody></table><h2 id=seed-clusters>Seed Clusters</h2><h3 id=priorityclasses-for-seed-system-components><code>PriorityClass</code>es for Seed System Components</h3><table><thead><tr><th>Name</th><th>Priority</th><th>Associated Components (Examples)</th></tr></thead><tbody><tr><td><code>gardener-system-critical</code></td><td>999998950</td><td><code>gardenlet</code>, <code>gardener-resource-manager</code>, <code>istio-ingressgateway</code>, <code>istiod</code></td></tr><tr><td><code>gardener-system-900</code></td><td>999998900</td><td>Extensions, <code>reversed-vpn-auth-server</code></td></tr><tr><td><code>gardener-system-800</code></td><td>999998800</td><td><code>dependency-watchdog-endpoint</code>, <code>dependency-watchdog-probe</code>, <code>etcd-druid</code>, <code>(auditlog-)mutator</code>, <code>vpa-admission-controller</code></td></tr><tr><td><code>gardener-system-700</code></td><td>999998700</td><td><code>auditlog-seed-controller</code>, <code>hvpa-controller</code>, <code>vpa-recommender</code>, <code>vpa-updater</code></td></tr><tr><td><code>gardener-system-600</code></td><td>999998600</td><td><code>aggregate-alertmanager</code>, <code>alertmanager</code>, <code>fluent-bit</code>, <code>plutono</code>, <code>kube-state-metrics</code>, <code>nginx-ingress-controller</code>, <code>nginx-k8s-backend</code>, <code>prometheus</code>, <code>vali</code>, <code>seed-prometheus</code></td></tr><tr><td><code>gardener-reserve-excess-capacity</code></td><td>-5</td><td><code>reserve-excess-capacity</code> (<a href=https://github.com/gardener/gardener/pull/6135>ref</a>)</td></tr></tbody></table><h3 id=priorityclasses-for-shoot-control-plane-components><code>PriorityClass</code>es for Shoot Control Plane Components</h3><table><thead><tr><th>Name</th><th>Priority</th><th>Associated Components (Examples)</th></tr></thead><tbody><tr><td><code>gardener-system-500</code></td><td>999998500</td><td><code>etcd-events</code>, <code>etcd-main</code>, <code>kube-apiserver</code></td></tr><tr><td><code>gardener-system-400</code></td><td>999998400</td><td><code>gardener-resource-manager</code></td></tr><tr><td><code>gardener-system-300</code></td><td>999998300</td><td><code>cloud-controller-manager</code>, <code>cluster-autoscaler</code>, <code>csi-driver-controller</code>, <code>kube-controller-manager</code>, <code>kube-scheduler</code>, <code>machine-controller-manager</code>, <code>terraformer</code>, <code>vpn-seed-server</code></td></tr><tr><td><code>gardener-system-200</code></td><td>999998200</td><td><code>csi-snapshot-controller</code>, <code>csi-snapshot-validation</code>, <code>cert-controller-manager</code>, <code>shoot-dns-service</code>, <code>vpa-admission-controller</code>, <code>vpa-recommender</code>, <code>vpa-updater</code></td></tr><tr><td><code>gardener-system-100</code></td><td>999998100</td><td><code>alertmanager</code>, <code>plutono</code>, <code>kube-state-metrics</code>, <code>prometheus</code>, <code>vali</code>, <code>event-logger</code></td></tr></tbody></table><h2 id=shoot-clusters>Shoot Clusters</h2><h2 id=priorityclasses-for-shoot-system-components><code>PriorityClass</code>es for Shoot System Components</h2><table><thead><tr><th>Name</th><th>Priority</th><th>Associated Components (Examples)</th></tr></thead><tbody><tr><td><code>system-node-critical</code> (created by Kubernetes)</td><td>2000001000</td><td><code>calico-node</code>, <code>kube-proxy</code>, <code>apiserver-proxy</code>, <code>csi-driver</code>, <code>egress-filter-applier</code></td></tr><tr><td><code>system-cluster-critical</code> (created by Kubernetes)</td><td>2000000000</td><td><code>calico-typha</code>, <code>calico-kube-controllers</code>, <code>coredns</code>, <code>vpn-shoot</code></td></tr><tr><td><code>gardener-shoot-system-900</code></td><td>999999900</td><td><code>node-problem-detector</code></td></tr><tr><td><code>gardener-shoot-system-800</code></td><td>999999800</td><td><code>calico-typha-horizontal-autoscaler</code>, <code>calico-typha-vertical-autoscaler</code></td></tr><tr><td><code>gardener-shoot-system-700</code></td><td>999999700</td><td><code>blackbox-exporter</code>, <code>node-exporter</code></td></tr><tr><td><code>gardener-shoot-system-600</code></td><td>999999600</td><td><code>addons-nginx-ingress-controller</code>, <code>addons-nginx-ingress-k8s-backend</code>, <code>kubernetes-dashboard</code>, <code>kubernetes-metrics-scraper</code></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-00cd3641980cfeb33469951e8feeb244>14 - Process</h1><h1 id=releases-features-hotfixes>Releases, Features, Hotfixes</h1><p>This document describes how to contribute features or hotfixes, and how new Gardener releases are usually scheduled, validated, etc.</p><ul><li><a href=#releases-features-hotfixes>Releases, Features, Hotfixes</a><ul><li><a href=#releases>Releases</a><ul><li><a href=#release-responsible-plan>Release Responsible Plan</a></li><li><a href=#release-validation>Release Validation</a></li></ul></li><li><a href=#contributing-new-features-or-fixes>Contributing New Features or Fixes</a></li><li><a href=#cherry-picks>Cherry Picks</a><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#initiate-a-cherry-pick>Initiate a Cherry Pick</a></li></ul></li></ul></li></ul><h2 id=releases>Releases</h2><p>The <a href=https://github.com/orgs/gardener/teams/gardener-maintainers>@gardener-maintainers</a> are trying to provide a new release roughly every other week (depending on their capacity and the stability/robustness of the <code>master</code> branch).</p><p>Hotfixes are usually maintained for the latest three minor releases, though, there are no fixed release dates.</p><h3 id=release-responsible-plan>Release Responsible Plan</h3><table><thead><tr><th>Version</th><th>Week No</th><th>Begin Validation Phase</th><th>Due Date</th><th>Release Responsible</th></tr></thead><tbody><tr><td>v1.71</td><td>Week 19-20</td><td>May 8, 2023</td><td>May 21, 2023</td><td><a href=https://github.com/shafeeqes>@shafeeqes</a></td></tr><tr><td>v1.72</td><td>Week 21-22</td><td>May 22, 2023</td><td>June 4, 2023</td><td><a href=https://github.com/ary1992>@ary1992</a></td></tr><tr><td>v1.73</td><td>Week 23-24</td><td>June 5, 2023</td><td>June 18, 2023</td><td><a href=https://github.com/timuthy>@timuthy</a></td></tr><tr><td>v1.74</td><td>Week 25-26</td><td>June 19, 2023</td><td>July 2, 2023</td><td><a href=https://github.com/oliver-goetz>@oliver-goetz</a></td></tr><tr><td>v1.75</td><td>Week 27-28</td><td>July 3, 2023</td><td>July 16, 2023</td><td><a href=https://github.com/rfranzke>@rfranzke</a></td></tr><tr><td>v1.76</td><td>Week 29-30</td><td>July 17, 2023</td><td>July 30, 2023</td><td><a href=https://github.com/plkokanov>@plkokanov</a></td></tr><tr><td>v1.77</td><td>Week 31-32</td><td>July 31, 2023</td><td>August 13, 2023</td><td><a href=https://github.com/ialidzhikov>@ialidzhikov</a></td></tr><tr><td>v1.78</td><td>Week 33-34</td><td>August 14, 2023</td><td>August 27, 2023</td><td><a href=https://github.com/acumino>@acumino</a></td></tr></tbody></table><p>Apart from the release of the next version, the release responsible is also taking care of potential hotfix releases of the last three minor versions.
The release responsible is the main contact person for coordinating new feature PRs for the next minor versions or cherry-pick PRs for the last three minor versions.</p><details><summary>Click to expand the archived release responsible associations!</summary><table><thead><tr><th>Version</th><th>Week No</th><th>Begin Validation Phase</th><th>Due Date</th><th>Release Responsible</th></tr></thead><tbody><tr><td>v1.17</td><td>Week 07-08</td><td>February 15, 2021</td><td>February 28, 2021</td><td><a href=https://github.com/rfranzke>@rfranzke</a></td></tr><tr><td>v1.18</td><td>Week 09-10</td><td>March 1, 2021</td><td>March 14, 2021</td><td><a href=https://github.com/danielfoehrKn>@danielfoehrKn</a></td></tr><tr><td>v1.19</td><td>Week 11-12</td><td>March 15, 2021</td><td>March 28, 2021</td><td><a href=https://github.com/timebertt>@timebertt</a></td></tr><tr><td>v1.20</td><td>Week 13-14</td><td>March 29, 2021</td><td>April 11, 2021</td><td><a href=https://github.com/vpnachev>@vpnachev</a></td></tr><tr><td>v1.21</td><td>Week 15-16</td><td>April 12, 2021</td><td>April 25, 2021</td><td><a href=https://github.com/timuthy>@timuthy</a></td></tr><tr><td>v1.22</td><td>Week 17-18</td><td>April 26, 2021</td><td>May 9, 2021</td><td><a href=https://github.com/BeckerMax>@BeckerMax</a></td></tr><tr><td>v1.23</td><td>Week 19-20</td><td>May 10, 2021</td><td>May 23, 2021</td><td><a href=https://github.com/ialidzhikov>@ialidzhikov</a></td></tr><tr><td>v1.24</td><td>Week 21-22</td><td>May 24, 2021</td><td>June 5, 2021</td><td><a href=https://github.com/stoyanr>@stoyanr</a></td></tr><tr><td>v1.25</td><td>Week 23-24</td><td>June 7, 2021</td><td>June 20, 2021</td><td><a href=https://github.com/rfranzke>@rfranzke</a></td></tr><tr><td>v1.26</td><td>Week 25-26</td><td>June 21, 2021</td><td>July 4, 2021</td><td><a href=https://github.com/danielfoehrKn>@danielfoehrKn</a></td></tr><tr><td>v1.27</td><td>Week 27-28</td><td>July 5, 2021</td><td>July 18, 2021</td><td><a href=https://github.com/timebertt>@timebertt</a></td></tr><tr><td>v1.28</td><td>Week 29-30</td><td>July 19, 2021</td><td>August 1, 2021</td><td><a href=https://github.com/ialidzhikov>@ialidzhikov</a></td></tr><tr><td>v1.29</td><td>Week 31-32</td><td>August 2, 2021</td><td>August 15, 2021</td><td><a href=https://github.com/timuthy>@timuthy</a></td></tr><tr><td>v1.30</td><td>Week 33-34</td><td>August 16, 2021</td><td>August 29, 2021</td><td><a href=https://github.com/BeckerMax>@BeckerMax</a></td></tr><tr><td>v1.31</td><td>Week 35-36</td><td>August 30, 2021</td><td>September 12, 2021</td><td><a href=https://github.com/stoyanr>@stoyanr</a></td></tr><tr><td>v1.32</td><td>Week 37-38</td><td>September 13, 2021</td><td>September 26, 2021</td><td><a href=https://github.com/vpnachev>@vpnachev</a></td></tr><tr><td>v1.33</td><td>Week 39-40</td><td>September 27, 2021</td><td>October 10, 2021</td><td><a href=https://github.com/voelzmo>@voelzmo</a></td></tr><tr><td>v1.34</td><td>Week 41-42</td><td>October 11, 2021</td><td>October 24, 2021</td><td><a href=https://github.com/plkokanov>@plkokanov</a></td></tr><tr><td>v1.35</td><td>Week 43-44</td><td>October 25, 2021</td><td>November 7, 2021</td><td><a href=https://github.com/kris94>@kris94</a></td></tr><tr><td>v1.36</td><td>Week 45-46</td><td>November 8, 2021</td><td>November 21, 2021</td><td><a href=https://github.com/timebertt>@timebertt</a></td></tr><tr><td>v1.37</td><td>Week 47-48</td><td>November 22, 2021</td><td>December 5, 2021</td><td><a href=https://github.com/danielfoehrKn>@danielfoehrKn</a></td></tr><tr><td>v1.38</td><td>Week 49-50</td><td>December 6, 2021</td><td>December 19, 2021</td><td><a href=https://github.com/rfranzke>@rfranzke</a></td></tr><tr><td>v1.39</td><td>Week 01-04</td><td>January 3, 2022</td><td>January 30, 2022</td><td><a href=https://github.com/ialidzhikov>@ialidzhikov</a>, <a href=https://github.com/timuthy>@timuthy</a></td></tr><tr><td>v1.40</td><td>Week 05-06</td><td>January 31, 2022</td><td>February 13, 2022</td><td><a href=https://github.com/BeckerMax>@BeckerMax</a></td></tr><tr><td>v1.41</td><td>Week 07-08</td><td>February 14, 2022</td><td>February 27, 2022</td><td><a href=https://github.com/plkokanov>@plkokanov</a></td></tr><tr><td>v1.42</td><td>Week 09-10</td><td>February 28, 2022</td><td>March 13, 2022</td><td><a href=https://github.com/kris94>@kris94</a></td></tr><tr><td>v1.43</td><td>Week 11-12</td><td>March 14, 2022</td><td>March 27, 2022</td><td><a href=https://github.com/rfranzke>@rfranzke</a></td></tr><tr><td>v1.44</td><td>Week 13-14</td><td>March 28, 2022</td><td>April 10, 2022</td><td><a href=https://github.com/timebertt>@timebertt</a></td></tr><tr><td>v1.45</td><td>Week 15-16</td><td>April 11, 2022</td><td>April 24, 2022</td><td><a href=https://github.com/acumino>@acumino</a></td></tr><tr><td>v1.46</td><td>Week 17-18</td><td>April 25, 2022</td><td>May 8, 2022</td><td><a href=https://github.com/ialidzhikov>@ialidzhikov</a></td></tr><tr><td>v1.47</td><td>Week 19-20</td><td>May 9, 2022</td><td>May 22, 2022</td><td><a href=https://github.com/shafeeqes>@shafeeqes</a></td></tr><tr><td>v1.48</td><td>Week 21-22</td><td>May 23, 2022</td><td>June 5, 2022</td><td><a href=https://github.com/ary1992>@ary1992</a></td></tr><tr><td>v1.49</td><td>Week 23-24</td><td>June 6, 2022</td><td>June 19, 2022</td><td><a href=https://github.com/plkokanov>@plkokanov</a></td></tr><tr><td>v1.50</td><td>Week 25-26</td><td>June 20, 2022</td><td>July 3, 2022</td><td><a href=https://github.com/rfranzke>@rfranzke</a></td></tr><tr><td>v1.51</td><td>Week 27-28</td><td>July 4, 2022</td><td>July 17, 2022</td><td><a href=https://github.com/timebertt>@timebertt</a></td></tr><tr><td>v1.52</td><td>Week 29-30</td><td>July 18, 2022</td><td>July 31, 2022</td><td><a href=https://github.com/acumino>@acumino</a></td></tr><tr><td>v1.53</td><td>Week 31-32</td><td>August 1, 2022</td><td>August 14, 2022</td><td><a href=https://github.com/kris94>@kris94</a></td></tr><tr><td>v1.54</td><td>Week 33-34</td><td>August 15, 2022</td><td>August 28, 2022</td><td><a href=https://github.com/ialidzhikov>@ialidzhikov</a></td></tr><tr><td>v1.55</td><td>Week 35-36</td><td>August 29, 2022</td><td>September 11, 2022</td><td><a href=https://github.com/oliver-goetz>@oliver-goetz</a></td></tr><tr><td>v1.56</td><td>Week 37-38</td><td>September 12, 2022</td><td>September 25, 2022</td><td><a href=https://github.com/shafeeqes>@shafeeqes</a></td></tr><tr><td>v1.57</td><td>Week 39-40</td><td>September 26, 2022</td><td>October 9, 2022</td><td><a href=https://github.com/ary1992>@ary1992</a></td></tr><tr><td>v1.58</td><td>Week 41-42</td><td>October 10, 2022</td><td>October 23, 2022</td><td><a href=https://github.com/plkokanov>@plkokanov</a></td></tr><tr><td>v1.59</td><td>Week 43-44</td><td>October 24, 2022</td><td>November 6, 2022</td><td><a href=https://github.com/rfranzke>@rfranzke</a></td></tr><tr><td>v1.60</td><td>Week 45-46</td><td>November 7, 2022</td><td>November 20, 2022</td><td><a href=https://github.com/acumino>@acumino</a></td></tr><tr><td>v1.61</td><td>Week 47-48</td><td>November 21, 2022</td><td>December 4, 2022</td><td><a href=https://github.com/ialidzhikov>@ialidzhikov</a></td></tr><tr><td>v1.62</td><td>Week 49-50</td><td>December 5, 2022</td><td>December 18, 2022</td><td><a href=https://github.com/oliver-goetz>@oliver-goetz</a></td></tr><tr><td>v1.63</td><td>Week 01-04</td><td>January 2, 2023</td><td>January 29, 2023</td><td><a href=https://github.com/shafeeqes>@shafeeqes</a></td></tr><tr><td>v1.64</td><td>Week 05-06</td><td>January 30, 2023</td><td>February 12, 2023</td><td><a href=https://github.com/ary1992>@ary1992</a></td></tr><tr><td>v1.65</td><td>Week 07-08</td><td>February 13, 2023</td><td>February 26, 2023</td><td><a href=https://github.com/timuthy>@timuthy</a></td></tr><tr><td>v1.66</td><td>Week 09-10</td><td>February 27, 2023</td><td>March 12, 2023</td><td><a href=https://github.com/plkokanov>@plkokanov</a></td></tr><tr><td>v1.67</td><td>Week 11-12</td><td>March 13, 2023</td><td>March 26, 2023</td><td><a href=https://github.com/rfranzke>@rfranzke</a></td></tr><tr><td>v1.68</td><td>Week 13-14</td><td>March 27, 2023</td><td>April 9, 2023</td><td><a href=https://github.com/acumino>@acumino</a></td></tr><tr><td>v1.69</td><td>Week 15-16</td><td>April 10, 2023</td><td>April 23, 2023</td><td><a href=https://github.com/oliver-goetz>@oliver-goetz</a></td></tr><tr><td>v1.70</td><td>Week 17-18</td><td>April 24, 2023</td><td>May 7, 2023</td><td><a href=https://github.com/ialidzhikov>@ialidzhikov</a></td></tr></tbody></table></details><h3 id=release-validation>Release Validation</h3><p>The release phase for a new minor version lasts two weeks.
Typically, the first week is used for the validation of the release.
This phase includes the following steps:</p><ol><li><code>master</code> (or latest <code>release-*</code> branch) is deployed to a development landscape that already hosts some existing seed and shoot clusters.</li><li>An extended test suite is triggered by the &ldquo;release responsible&rdquo; which:<ol><li>executes the Gardener integration tests for different Kubernetes versions, infrastructures, and <code>Shoot</code> settings.</li><li>executes the Kubernetes conformance tests.</li><li>executes further tests like Kubernetes/OS patch/minor version upgrades.</li></ol></li><li>Additionally, every four hours (or on demand) more tests (e.g., including the Kubernetes e2e test suite) are executed for different infrastructures.</li><li>The &ldquo;release responsible&rdquo; is verifying new features or other notable changes (derived of the draft release notes) in this development system.</li></ol><p>Usually, the new release is triggered in the beginning of the second week if all tests are green, all checks were successful, and if all of the planned verifications were performed by the release responsible.</p><h2 id=contributing-new-features-or-fixes>Contributing New Features or Fixes</h2><p>Please refer to the <a href=https://gardener.cloud/docs/contribute/>Gardener contributor guide</a>.
Besides a lot of a general information, it also provides a checklist for newly created pull requests that may help you to prepare your changes for an efficient review process.
If you are contributing a fix or major improvement, please take care to open cherry-pick PRs to all affected and still supported versions once the change is approved and merged in the <code>master</code> branch.</p><p>⚠️ Please ensure that your modifications pass the verification checks (linting, formatting, static code checks, tests, etc.) by executing</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make verify
</span></span></code></pre></div><p>before filing your pull request.</p><p>The guide applies for both changes to the <code>master</code> and to any <code>release-*</code> branch.
All changes must be submitted via a pull request and be reviewed and approved by at least one code owner.</p><h3 id=todo-statements>TODO Statements</h3><p>Sometimes, TODO statements are being introduced when one cannot follow up immediately with certain tasks or when temporary migration code is required.
In order to properly follow-up with such TODOs and to prevent them from piling up without getting attention, the following rules should be followed:</p><ul><li>Each TODO statement should have an associated person and state when it can be removed.
Example:<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:green>// TODO(&lt;github-username&gt;): Remove this code after v1.75 has been released.
</span></span></span></code></pre></div></li><li>When the task depends on a certain implementation, a GitHub issue should be opened and referenced in the statement.
Example:<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:green>// TODO(&lt;github-username&gt;): Remove this code after https://github.com/gardener/gardener/issues/&lt;issue-number&gt; has been implemented.
</span></span></span></code></pre></div>The associated person should actively drive the implementation of the referenced issue (unless it cannot be done because of third-party dependencies or conditions) so that the TODO statement does not get stale.</li><li>TODO statements without actionable tasks or those that are unlikely to ever be implemented (maybe because of very low priorities) should not be specified in the first place. If a TODO is specified, the associated person should make sure to actively follow-up.</li></ul><h2 id=cherry-picks>Cherry Picks</h2><p>This section explains how to initiate cherry picks on release branches within the <code>gardener/gardener</code> repository.</p><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#initiate-a-cherry-pick>Initiate a Cherry Pick</a></li></ul><h3 id=prerequisites>Prerequisites</h3><p>Before you initiate a cherry pick, make sure that the following prerequisites are accomplished.</p><ul><li>A pull request merged against the <code>master</code> branch.</li><li>The release branch exists (check in the <a href=https://github.com/gardener/gardener/branches>branches section</a>).</li><li>Have the <code>gardener/gardener</code> repository cloned as follows:<ul><li>the <code>origin</code> remote should point to your fork (alternatively this can be overwritten by passing <code>FORK_REMOTE=&lt;fork-remote></code>).</li><li>the <code>upstream</code> remote should point to the Gardener GitHub org (alternatively this can be overwritten by passing <code>UPSTREAM_REMOTE=&lt;upstream-remote></code>).</li></ul></li><li>Have <code>hub</code> installed, which is most easily installed via
<code>go get github.com/github/hub</code> assuming you have a standard golang
development environment.</li><li>A GitHub token which has permissions to create a PR in an upstream branch.</li></ul><h3 id=initiate-a-cherry-pick>Initiate a Cherry Pick</h3><ul><li><p>Run the [cherry pick script][cherry-pick-script].</p><p>This example applies a master branch PR #3632 to the remote branch
<code>upstream/release-v3.14</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>GITHUB_USER=&lt;your-user&gt; hack/cherry-pick-pull.sh upstream/release-v3.14 3632
</span></span></code></pre></div><ul><li><p>Be aware the cherry pick script assumes you have a git remote called
<code>upstream</code> that points at the Gardener GitHub org.</p></li><li><p>You will need to run the cherry pick script separately for each patch
release you want to cherry pick to. Cherry picks should be applied to all
active release branches where the fix is applicable.</p></li><li><p>When asked for your GitHub password, provide the created GitHub token
rather than your actual GitHub password.
Refer <a href=https://github.com/github/hub/issues/2655#issuecomment-735836048>https://github.com/github/hub/issues/2655#issuecomment-735836048</a></p></li></ul></li><li><p><a href=https://github.com/gardener/gardener/blob/master/hack/cherry-pick-pull.sh>cherry-pick-script</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-165b95fb0235157f8762cac8f525c5ab>15 - Secrets Management</h1><h1 id=secrets-management-for-seed-and-shoot-cluster>Secrets Management for Seed and Shoot Cluster</h1><p>The gardenlet needs to create quite some amount of credentials (certificates, private keys, passwords) for seed and shoot clusters in order to ensure secure deployments.
Such credentials typically should be renewed automatically when their validity expires, rotated regularly, and they potentially need to be persisted such that they don&rsquo;t get lost in case of a control plane migration or a lost seed cluster.</p><h2 id=secretsmanager-introduction>SecretsManager Introduction</h2><p>These requirements can be covered by using the <code>SecretsManager</code> package maintained in <a href=https://github.com/gardener/gardener/tree/master/pkg/utils/secrets/manager><code>pkg/utils/secrets/manager</code></a>.
It is built on top of the <code>ConfigInterface</code> and <code>DataInterface</code> interfaces part of <a href=https://github.com/gardener/gardener/tree/master/pkg/utils/secrets><code>pkg/utils/secrets</code></a> and provides the following functions:</p><ul><li><p><code>Generate(context.Context, secrets.ConfigInterface, ...GenerateOption) (*corev1.Secret, error)</code></p><p>This method either retrieves the current secret for the given configuration or it (re)generates it in case the configuration changed, the signing CA changed (for certificate secrets), or when proactive rotation was triggered.
If the configuration describes a certificate authority secret then this method automatically generates a bundle secret containing the current and potentially the old certificate.
Available <code>GenerateOption</code>s:</p><ul><li><code>SignedByCA(string, ...SignedByCAOption)</code>: This is only valid for certificate secrets and automatically retrieves the correct certificate authority in order to sign the provided server or client certificate.<ul><li>There are two <code>SignedByCAOption</code>s:<ul><li><code>UseCurrentCA</code>. This option will sign server certificates with the new/current CA in case of a CA rotation. For more information, please refer to the <a href=#certificate-signing>&ldquo;Certificate Signing&rdquo;</a> section below.</li><li><code>UseOldCA</code>. This option will sign client certificates with the old CA in case of a CA rotation. For more information, please refer to the <a href=#certificate-signing>&ldquo;Certificate Signing&rdquo;</a> section below.</li></ul></li></ul></li><li><code>Persist()</code>: This marks the secret such that it gets persisted in the <code>ShootState</code> resource in the garden cluster. Consequently, it should only be used for secrets related to a shoot cluster.</li><li><code>Rotate(rotationStrategy)</code>: This specifies the strategy in case this secret is to be rotated or regenerated (either <code>InPlace</code> which immediately forgets about the old secret, or <code>KeepOld</code> which keeps the old secret in the system).</li><li><code>IgnoreOldSecrets()</code>: This specifies that old secrets should not be considered and loaded (contrary to the default behavior). It should be used when old secrets are no longer important and can be &ldquo;forgotten&rdquo; (e.g. in <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/18-shoot-CA-rotation.md#rotation-sequence-for-cluster-and-client-ca>&ldquo;phase 2&rdquo; (<code>t2</code>) of the CA certificate rotation</a>). Such old secrets will be deleted on <code>Cleanup()</code>.</li><li><code>IgnoreOldSecretsAfter(time.Duration)</code>: This specifies that old secrets should not be considered and loaded once a given duration after rotation has passed. It can be used to clean up old secrets after automatic rotation (e.g. the Seed cluster CA is automatically rotated when its validity will soon end and the old CA will be cleaned up 24 hours after triggering the rotation).</li><li><code>Validity(time.Duration)</code>: This specifies how long the secret should be valid. For certificate secret configurations, the manager will automatically deduce this information from the generated certificate.</li></ul></li><li><p><code>Get(string, ...GetOption) (*corev1.Secret, bool)</code></p><p>This method retrieves the current secret for the given name.
In case the secret in question is a certificate authority secret then it retrieves the bundle secret by default.
It is important that this method only knows about secrets for which there were prior <code>Generate</code> calls.
Available <code>GetOption</code>s:</p><ul><li><code>Bundle</code> (default): This retrieves the bundle secret.</li><li><code>Current</code>: This retrieves the current secret.</li><li><code>Old</code>: This retrieves the old secret.</li></ul></li><li><p><code>Cleanup(context.Context) error</code></p><p>This method deletes secrets which are no longer required.
No longer required secrets are those still existing in the system which weren&rsquo;t detected by prior <code>Generate</code> calls.
Consequently, only call <code>Cleanup</code> after you have executed <code>Generate</code> calls for all desired secrets.</p></li></ul><p>Some exemplary usages would look as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>secret, err := k.secretsManager.Generate(
</span></span><span style=display:flex><span>    ctx,
</span></span><span style=display:flex><span>    &amp;secrets.CertificateSecretConfig{
</span></span><span style=display:flex><span>        Name:                        <span style=color:#a31515>&#34;my-server-secret&#34;</span>,
</span></span><span style=display:flex><span>        CommonName:                  <span style=color:#a31515>&#34;server-abc&#34;</span>,
</span></span><span style=display:flex><span>        DNSNames:                    []<span style=color:#2b91af>string</span>{<span style=color:#a31515>&#34;first-name&#34;</span>, <span style=color:#a31515>&#34;second-name&#34;</span>},
</span></span><span style=display:flex><span>        CertType:                    secrets.ServerCert,
</span></span><span style=display:flex><span>        SkipPublishingCACertificate: <span style=color:#00f>true</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    secretsmanager.SignedByCA(<span style=color:#a31515>&#34;my-ca&#34;</span>),
</span></span><span style=display:flex><span>    secretsmanager.Persist(),
</span></span><span style=display:flex><span>    secretsmanager.Rotate(secretsmanager.InPlace),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#00f>if</span> err != <span style=color:#00f>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#00f>return</span> err
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As explained above, the caller does not need to care about the renewal, rotation or the persistence of this secret - all of these concerns are handled by the secrets manager.
Automatic renewal of secrets happens when their validity approaches 80% or less than <code>10d</code> are left until expiration.</p><p>In case a CA certificate is needed by some component, then it can be retrieved as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>caSecret, found := k.secretsManager.Get(<span style=color:#a31515>&#34;my-ca&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#00f>if</span> !found {
</span></span><span style=display:flex><span>    <span style=color:#00f>return</span> fmt.Errorf(<span style=color:#a31515>&#34;secret my-ca not found&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As explained above, this returns the bundle secret for the CA <code>my-ca</code> which might potentially contain both the current and the old CA (in case of rotation/regeneration).</p><h3 id=certificate-signing>Certificate Signing</h3><p>By default, client certificates are always signed by the current CA while server certificate are signed by the old CA (if it exists).
This is to ensure a smooth exchange of certificate during a CA rotation (typically has two phases, ref <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/18-shoot-CA-rotation.md#rotation-sequence-for-cluster-and-client-ca>GEP-18</a>):</p><ul><li>Client certificates:<ul><li>In phase 1, clients get new certificates as soon as possible to ensure that all clients have been adapted before phase 2.</li><li>In phase 2, the respective server drops accepting certificates signed by the old CA.</li></ul></li><li>Server certificates:<ul><li>In phase 1, servers still use their old/existing certificates to allow clients to update their CA bundle used for verification of the servers&rsquo; certificates.</li><li>In phase 2, the old CA is dropped, hence servers need to get a certificate signed by the new/current CA. At this point in time, clients have already adapted their CA bundles.</li></ul></li></ul><h4 id=always-sign-server-certificates-with-current-ca>Always Sign Server Certificates with Current CA</h4><p>In case you control all clients and update them at the same time as the server, it is possible to make the secrets manager generate even server certificates with the new/current CA.
This can help to prevent certificate mismatches when the CA bundle is already exchanged while the server still serves with a certificate signed by a CA no longer part of the bundle.</p><p>Let&rsquo;s consider the two following examples:</p><ol><li><code>gardenlet</code> deploys a webhook server (<code>gardener-resource-manager</code>) and a corresponding <code>MutatingWebhookConfiguration</code> at the same time. In this case, the server certificate should be generated with the new/current CA to avoid above mentioned certificate mismatches during a CA rotation.</li><li><code>gardenlet</code> deploys a server (<code>etcd</code>) in one step, and a client (<code>kube-apiserver</code>) in a subsequent step. In this case, the default behaviour should apply (server certificate should be signed by old/existing CA).</li></ol><h4 id=always-sign-client-certificate-with-old-ca>Always Sign Client Certificate with Old CA</h4><p>In the unusual case where the client is deployed before the server, it might be useful to always use the old CA for signing the client&rsquo;s certificate.
This can help to prevent certificate mismatches when the client already gets a new certificate while the server still only accepts certificates signed by the old CA.</p><p>Let&rsquo;s consider the following example:</p><ol><li><code>gardenlet</code> deploys the <code>kube-apiserver</code> before the <code>kubelet</code>. However, the <code>kube-apiserver</code> has a client certificate signed by the <code>ca-kubelet</code> in order to communicate with it (e.g., when retrieving logs or forwarding ports). In this case, the client certificate should be generated with the old CA to avoid above mentioned certificate mismatches during a CA rotation.</li></ol><h2 id=reusing-the-secretsmanager-in-other-components>Reusing the SecretsManager in Other Components</h2><p>While the <code>SecretsManager</code> is primarily used by gardenlet, it can be reused by other components (e.g. extensions) as well for managing secrets that are specific to the component or extension. For example, provider extensions might use their own <code>SecretsManager</code> instance for managing the serving certificate of <code>cloud-controller-manager</code>.</p><p>External components that want to reuse the <code>SecretsManager</code> should consider the following aspects:</p><ul><li>On initialization of a <code>SecretsManager</code>, pass an <code>identity</code> specific to the component, controller and purpose. For example, gardenlet&rsquo;s shoot controller uses <code>gardenlet</code> as the <code>SecretsManager</code>&rsquo;s identity, the <code>Worker</code> controller in <code>provider-foo</code> should use <code>provider-foo-worker</code>, and the <code>ControlPlane</code> controller should use <code>provider-foo-controlplane-exposure</code> for <code>ControlPlane</code> objects of purpose <code>exposure</code>.
The given identity is added as a value for the <code>manager-identity</code> label on managed <code>Secret</code>s.
This label is used by the <code>Cleanup</code> function to select only those <code>Secret</code>s that are actually managed by the particular <code>SecretManager</code> instance. This is done to prevent removing still needed <code>Secret</code>s that are managed by other instances.</li><li>Generate dedicated CAs for signing certificates instead of depending on CAs managed by gardenlet.</li><li>Names of <code>Secret</code>s managed by external <code>SecretsManager</code> instances must not conflict with <code>Secret</code> names from other instances (e.g. gardenlet).</li><li>For CAs that should be rotated in lock-step with the Shoot CAs managed by gardenlet, components need to pass information about the last rotation initiation time and the current rotation phase to the <code>SecretsManager</code> upon initialization.
The relevant information can be retrieved from the <code>Cluster</code> resource under <code>.spec.shoot.status.credentials.rotation.certificateAuthorities</code>.</li><li>Independent of the specific identity, secrets marked with the <code>Persist</code> option are automatically saved in the <code>ShootState</code> resource by the gardenlet and are also restored by the gardenlet on Control Plane Migration to the new Seed.</li></ul><h2 id=migrating-existing-secrets-to-secretsmanager>Migrating Existing Secrets To SecretsManager</h2><p>If you already have existing secrets which were not created with <code>SecretsManager</code>, then you can (optionally) migrate them by labeling them with <code>secrets-manager-use-data-for-name=&lt;config-name></code>.
For example, if your <code>SecretsManager</code> generates a <code>CertificateConfigSecret</code> with name <code>foo</code> like this</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>secret, err := k.secretsManager.Generate(
</span></span><span style=display:flex><span>    ctx,
</span></span><span style=display:flex><span>    &amp;secrets.CertificateSecretConfig{
</span></span><span style=display:flex><span>        Name:                        <span style=color:#a31515>&#34;foo&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green>// ...
</span></span></span><span style=display:flex><span><span style=color:green></span>    },
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>and you already have an existing secret in your system whose data should be kept instead of regenerated, then labeling it with <code>secrets-manager-use-data-for-name=foo</code> will instruct <code>SecretsManager</code> accordingly.</p><p><strong>⚠️ Caveat: You have to make sure that the existing <code>data</code> keys match with what <code>SecretsManager</code> uses:</strong></p><table><thead><tr><th>Secret Type</th><th>Data Keys</th></tr></thead><tbody><tr><td>Basic Auth</td><td><code>username</code>, <code>password</code>, <code>auth</code></td></tr><tr><td>CA Certificate</td><td><code>ca.crt</code>, <code>ca.key</code></td></tr><tr><td>Non-CA Certificate</td><td><code>tls.crt</code>, <code>tls.key</code></td></tr><tr><td>Control Plane Secret</td><td><code>ca.crt</code>, <code>username</code>, <code>password</code>, <code>token</code>, <code>kubeconfig</code></td></tr><tr><td>ETCD Encryption Key</td><td><code>key</code>, <code>secret</code></td></tr><tr><td>Kubeconfig</td><td><code>kubeconfig</code></td></tr><tr><td>RSA Private Key</td><td><code>id_rsa</code>, <code>id_rsa.pub</code></td></tr><tr><td>Static Token</td><td><code>static_tokens.csv</code></td></tr><tr><td>VPN TLS Auth</td><td><code>vpn.tlsauth</code></td></tr></tbody></table><h2 id=implementation-details>Implementation Details</h2><p>The source of truth for the secrets manager is the list of <code>Secret</code>s in the Kubernetes cluster it acts upon (typically, the seed cluster).
The persisted secrets in the <code>ShootState</code> are only used if and only if the shoot is in the <code>Restore</code> phase - in this case all secrets are just synced to the seed cluster so that they can be picked up by the secrets manager.</p><p>In order to prevent kubelets from unneeded watches (thus, causing some significant traffic against the <code>kube-apiserver</code>), the <code>Secret</code>s are marked as immutable.
Consequently, they have a unique, deterministic name which is computed as follows:</p><ul><li>For CA secrets, the name is just exactly the name specified in the configuration (e.g., <code>ca</code>). This is for backwards-compatibility and will be dropped in a future release once all components depending on the static name have been adapted.</li><li>For all other secrets, the name specified in the configuration is used as prefix followed by an 8-digit hash. This hash is computed out of the checksum of the secret configuration and the checksum of the certificate of the signing CA (only for certificate configurations).</li></ul><p>In all cases, the name of the secrets is suffixed with a 5-digit hash computed out of the time when the rotation for this secret was last started.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b3aa3f61ef7670f29a90ef82a24cb955>16 - Testing</h1><h1 id=testing-strategy-and-developer-guideline>Testing Strategy and Developer Guideline</h1><p>This document walks you through:</p><ul><li>What kind of tests we have in Gardener</li><li>How to run each of them</li><li>What purpose each kind of test serves</li><li>How to best write tests that are correct, stable, fast and maintainable</li><li>How to debug tests that are not working as expected</li></ul><p>The document is aimed towards developers that want to contribute code and need to write tests, as well as maintainers and reviewers that review test code.
It serves as a common guide that we commit to follow in our project to ensure consistency in our tests, good coverage for high confidence, and good maintainability.</p><p>The guidelines are not meant to be absolute rules.
Always apply common sense and adapt the guideline if it doesn&rsquo;t make much sense for some cases.
If in doubt, don&rsquo;t hesitate to ask questions during a PR review (as an author, but also as a reviewer).
Add new learnings as soon as we make them!</p><p>Generally speaking, <strong>tests are a strict requirement for contributing new code</strong>.
If you touch code that is currently untested, you need to add tests for the new cases that you introduce as a minimum.
Ideally though, you would add the missing test cases for the current code as well (<strong>boy scout rule</strong> &ndash; &ldquo;always leave the campground cleaner than you found it&rdquo;).</p><h2 id=writing-tests-relevant-for-all-kinds>Writing Tests (Relevant for All Kinds)</h2><ul><li>We follow BDD (behavior-driven development) testing principles and use <a href=https://onsi.github.io/ginkgo/>Ginkgo</a>, along with <a href=http://onsi.github.io/gomega/>Gomega</a>.<ul><li>Make sure to check out their extensive guides for more information and how to best leverage all of their features</li></ul></li><li>Use <code>By</code> to structure test cases with multiple steps, so that steps are easy to follow in the logs: <a href=https://github.com/gardener/gardener/blob/2eb54485231408cbdbabaa49812572a07124364f/pkg/client/kubernetes/clientmap/internal/generic_clientmap_test.go#L122-L138>example test</a></li><li>Call <code>defer GinkgoRecover()</code> if making assertions in goroutines: <a href=https://pkg.go.dev/github.com/onsi/ginkgo#GinkgoRecover>doc</a>, <a href=https://github.com/gardener/gardener/blob/2eb54485231408cbdbabaa49812572a07124364f/test/integration/scheduler/scheduler_test.go#L65-L68>example test</a></li><li>Use <code>DeferCleanup</code> instead of cleaning up manually (or use custom coding from the test framework): <a href=https://github.com/gardener/gardener/blob/2eb54485231408cbdbabaa49812572a07124364f/test/integration/resourcemanager/health/health_suite_test.go#L102-L105>example test</a>, <a href=https://github.com/gardener/gardener/blob/2eb54485231408cbdbabaa49812572a07124364f/test/integration/resourcemanager/health/health_test.go#L385-L390>example test</a><ul><li><code>DeferCleanup</code> makes sure to run the cleanup code in the right point in time, e.g., a <code>DeferCleanup</code> added in <code>BeforeEach</code> is executed with <code>AfterEach</code>.</li></ul></li><li>Test results should point to locations that cause the failures, so that the CI output isn&rsquo;t too difficult to debug/fix.<ul><li>Consider using <code>ExpectWithOffset</code> if the test uses assertions made in a helper function, among other assertions defined directly in the test (e.g. <code>expectSomethingWasCreated</code>): <a href=https://github.com/gardener/gardener/blob/2eb54485231408cbdbabaa49812572a07124364f/extensions/pkg/controller/controlplane/genericactuator/actuator_test.go#L732-L736>example test</a></li><li>Make sure to add additional descriptions to Gomega matchers if necessary (e.g. in a loop): <a href=https://github.com/gardener/gardener/blob/2eb54485231408cbdbabaa49812572a07124364f/test/e2e/shoot/internal/rotation/certificate_authorities.go#L89-L93>example test</a></li></ul></li><li>Introduce helper functions for assertions to make test more readable where applicable: <a href=https://github.com/gardener/gardener/blob/2eb54485231408cbdbabaa49812572a07124364f/test/integration/gardenlet/shootsecret/controller_test.go#L323-L331>example test</a></li><li>Introduce custom matchers to make tests more readable where applicable: <a href=https://github.com/gardener/gardener/blob/2eb54485231408cbdbabaa49812572a07124364f/pkg/utils/test/matchers/matchers.go#L51-L57>example matcher</a></li><li>Don&rsquo;t rely on accurate timing of <code>time.Sleep</code> and friends.<ul><li>If doing so, CPU throttling in CI will make tests flaky, <a href=https://github.com/gardener/gardener/issues/5410>example flake</a></li><li>Use fake clocks instead, <a href=https://github.com/gardener/gardener/pull/4569>example PR</a></li></ul></li><li>Use the same client schemes that are also used by production code to avoid subtle bugs/regressions: <a href=https://github.com/gardener/gardener/pull/5469>example PR</a>, <a href=https://github.com/gardener/gardener/blob/2de823d0a457beb9d680260243032c95fa47dc72/pkg/resourcemanager/cmd/source.go#L34-L43>production schemes</a>, <a href=https://github.com/gardener/gardener/blob/2de823d0a457beb9d680260243032c95fa47dc72/test/integration/resourcemanager/health/health_suite_test.go#L108-L109>usage in test</a></li><li>Make sure that your test is actually asserting the right thing and it doesn&rsquo;t pass if the exact bug is introduced that you want to prevent.<ul><li>Use specific error matchers instead of asserting any error has happened, make sure that the corresponding branch in the code is tested, e.g., prefer<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>Expect(err).To(MatchError(<span style=color:#a31515>&#34;foo&#34;</span>))
</span></span></code></pre></div>over<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>Expect(err).To(HaveOccurred())
</span></span></code></pre></div></li><li>If you&rsquo;re unsure about your test&rsquo;s behavior, attaching the debugger can sometimes be helpful to make sure your test is correct.</li></ul></li><li>About overwriting global variables:<ul><li>This is a common pattern (or hack?) in go for faking calls to external functions.</li><li>However, this can lead to races, when the global variable is used from a goroutine (e.g., the function is called).</li><li>Alternatively, set fields on structs (passed via parameter or set directly): this is not racy, as struct values are typically (and should be) only used for a single test case.</li><li>An alternative to dealing with function variables and fields:<ul><li>Add an interface which your code depends on</li><li>Write a fake and a real implementation (similar to <code>clock.Clock.Sleep</code>)</li><li>The real implementation calls the actual function (<code>clock.RealClock.Sleep</code> calls <code>time.Sleep</code>)</li><li>The fake implementation does whatever you want it to do for your test (<code>clock.FakeClock.Sleep</code> waits until the test code advanced the time)</li></ul></li></ul></li><li>Use constants in test code with care.<ul><li>Typically, you should not use constants from the same package as the tested code, instead use literals.</li><li>If the constant value is changed, tests using the constant will still pass, although the &ldquo;specification&rdquo; is not fulfilled anymore.</li><li>There are cases where it&rsquo;s fine to use constants, but keep this caveat in mind when doing so.</li></ul></li><li>Creating sample data for tests can be a high effort.<ul><li>If valuable, add a package for generating common sample data, e.g. Shoot/Cluster objects.</li></ul></li><li>Make use of the <code>testdata</code> directory for storing arbitrary sample data needed by tests (helm charts, YAML manifests, etc.), <a href=https://github.com/gardener/gardener/pull/2140>example PR</a><ul><li>From <a href=https://pkg.go.dev/cmd/go/internal/test>https://pkg.go.dev/cmd/go/internal/test</a>:<blockquote><p>The go tool will ignore a directory named &ldquo;testdata&rdquo;, making it available to hold ancillary data needed by the tests.</p></blockquote></li></ul></li></ul><h2 id=unit-tests>Unit Tests</h2><h3 id=running-unit-tests>Running Unit Tests</h3><p>Run all unit tests:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make test
</span></span></code></pre></div><p>Run all unit tests with test coverage:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make test-cov
</span></span><span style=display:flex><span>open test.coverage.html
</span></span><span style=display:flex><span>make test-cov-clean
</span></span></code></pre></div><p>Run unit tests of specific packages:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:green># run with same settings like in CI (race dector, timeout, ...)</span>
</span></span><span style=display:flex><span>./hack/test.sh ./pkg/resourcemanager/controller/... ./pkg/utils/secrets/...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># freestyle</span>
</span></span><span style=display:flex><span>go test ./pkg/resourcemanager/controller/... ./pkg/utils/secrets/...
</span></span><span style=display:flex><span>ginkgo run ./pkg/resourcemanager/controller/... ./pkg/utils/secrets/...
</span></span></code></pre></div><h3 id=debugging-unit-tests>Debugging Unit Tests</h3><p>Use ginkgo to focus on (a set of) test specs via <a href=https://onsi.github.io/ginkgo/#focused-specs>code</a> or via <a href=https://onsi.github.io/ginkgo/#description-based-filtering>CLI flags</a>.
Remember to unfocus specs before contributing code, otherwise your PR tests will fail.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ginkgo run --focus <span style=color:#a31515>&#34;should delete the unused resources&#34;</span> ./pkg/resourcemanager/controller/garbagecollector
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Will run 1 of 3 specs
</span></span><span style=display:flex><span>SS•
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Ran 1 of 3 Specs in 0.003 seconds
</span></span><span style=display:flex><span>SUCCESS! -- 1 Passed | 0 Failed | 0 Pending | 2 Skipped
</span></span><span style=display:flex><span>PASS
</span></span></code></pre></div><p>Use ginkgo to run tests until they fail:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ginkgo run --until-it-fails ./pkg/resourcemanager/controller/garbagecollector
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Ran 3 of 3 Specs in 0.004 seconds
</span></span><span style=display:flex><span>SUCCESS! -- 3 Passed | 0 Failed | 0 Pending | 0 Skipped
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>All tests passed...
</span></span><span style=display:flex><span>Will keep running them <span style=color:#00f>until</span> they fail.
</span></span><span style=display:flex><span>This was attempt <span style=color:green>#58</span>
</span></span><span style=display:flex><span>No, seriously... you can probably stop now.
</span></span></code></pre></div><p>Use the <a href=https://pkg.go.dev/golang.org/x/tools/cmd/stress><code>stress</code> tool</a> for deflaking tests that fail sporadically in CI, e.g., due resource contention (CPU throttling):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:green># get the stress tool</span>
</span></span><span style=display:flex><span>go install golang.org/x/tools/cmd/stress@latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># build a test binary</span>
</span></span><span style=display:flex><span>ginkgo build ./pkg/resourcemanager/controller/garbagecollector
</span></span><span style=display:flex><span><span style=color:green># alternatively</span>
</span></span><span style=display:flex><span>go test -c ./pkg/resourcemanager/controller/garbagecollector
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># run the test in parallel and report any failures</span>
</span></span><span style=display:flex><span>stress -p 16 ./pkg/resourcemanager/controller/garbagecollector/garbagecollector.test -ginkgo.focus <span style=color:#a31515>&#34;should delete the unused resources&#34;</span>
</span></span><span style=display:flex><span>5s: 1077 runs so far, 0 failures
</span></span><span style=display:flex><span>10s: 2160 runs so far, 0 failures
</span></span></code></pre></div><p><code>stress</code> will output a path to a file containing the full failure message when a test run fails.</p><h3 id=purpose-of-unit-tests>Purpose of Unit Tests</h3><ul><li>Unit tests prove the correctness of a single unit according to the specification of its interface.<ul><li>Think: Is the unit that I introduced doing what it is supposed to do for all cases?</li></ul></li><li>Unit tests protect against regressions caused by adding new functionality to or refactoring of a single unit.<ul><li>Think: Is the unit that was introduced earlier (by someone else) and that I changed still doing what it was supposed to do for all cases?</li></ul></li><li>Example units: functions (conversion, defaulting, validation, helpers), structs (helpers, basic building blocks like the Secrets Manager), predicates, event handlers.</li><li>For these purposes, unit tests need to cover all important cases of input for a single unit and cover edge cases / negative paths as well (e.g., errors).<ul><li>Because of the possible high dimensionality of test input, unit tests need to be fast to execute: individual test cases should not take more than a few seconds, test suites not more than 2 minutes.</li><li>Fuzzing can be used as a technique in addition to usual test cases for covering edge cases.</li></ul></li><li>Test coverage can be used as a tool during test development for covering all cases of a unit.</li><li>However, test coverage data can be a false safety net.<ul><li>Full line coverage doesn&rsquo;t mean you have covered all cases of valid input.</li><li>We don&rsquo;t have strict requirements for test coverage, as it doesn&rsquo;t necessarily yield the desired outcome.</li></ul></li><li>Unit tests should not test too large components, e.g. entire controller <code>Reconcile</code> functions.<ul><li>If a function/component does many steps, it&rsquo;s probably better to split it up into multiple functions/components that can be unit tested individually</li><li>There might be special cases for very small <code>Reconcile</code> functions.</li><li>If there are a lot of edge cases, extract dedicated functions that cover them and use unit tests to test them.</li><li>Usual-sized controllers should rather be tested in integration tests.</li><li>Individual parts (e.g. helper functions) should still be tested in unit test for covering all cases, though.</li></ul></li><li>Unit tests are especially easy to run with a debugger and can help in understanding concrete behavior of components.</li></ul><h3 id=writing-unit-tests>Writing Unit Tests</h3><ul><li>For the sake of execution speed, fake expensive calls/operations, e.g. secret generation: <a href=https://github.com/gardener/gardener/blob/b0de7db96ad436fe32c25daae5e8cb552dac351f/pkg/component/kubescheduler/kube_scheduler_suite_test.go#L32-L34>example test</a></li><li>Generally, prefer fakes over mocks, e.g., use controller-runtime fake client over mock clients.<ul><li>Mocks decrease maintainability because they expect the tested component to follow a certain way to reach the desired goal (e.g., call specific functions with particular arguments), <a href=https://github.com/gardener/gardener/pull/4027/commits/111aba2c8e306421f2fa6b27e5d8ed8b2fc52be9#diff-8e61507edf985df2625840a690115c43bca6c032f2ff818389633bd4365c3efdR293-R298>example consequence</a></li><li>Generally, fakes should be used in &ldquo;result-oriented&rdquo; test code (e.g., that a certain object was labelled, but the test doesn&rsquo;t care if it was via patch or update as both a valid ways to reach the desired goal).</li><li>Although rare, there are valid use cases for mocks, e.g. if the following aspects are important for correctness:<ul><li>Asserting that an exact function is called</li><li>Asserting that functions are called in a specific order</li><li>Asserting that exact parameters/values/&mldr; are passed</li><li>Asserting that a certain function was not called</li><li>Many of these can also be verified with fakes, although mocks might be simpler</li></ul></li><li>Only use mocks if the tested code directly calls the mock; never if the tested code only calls the mock indirectly (e.g., through a helper package/function).</li><li>Keep in mind the maintenance implications of using mocks:<ul><li>Can you make a valid non-behavioral change in the code without breaking the test or dependent tests?</li></ul></li><li>It&rsquo;s valid to mix fakes and mocks in the same test or between test cases.</li></ul></li><li>Generally, use the go test package, i.e., declare <code>package &lt;production_package>_test</code>:<ul><li>Helps in avoiding cyclic dependencies between production, test and helper packages</li><li>Also forces you to distinguish between the public (exported) API surface of your code and internal state that might not be of interest to tests</li><li>It might be valid to use the same package as the tested code if you want to test unexported functions.<ul><li>Alternatively, an <a href=https://go.dev/doc/go1.4#internalpackages><code>internal</code> package</a> can be used to host &ldquo;internal&rdquo; helpers: <a href=https://github.com/gardener/gardener/tree/2eb54485231408cbdbabaa49812572a07124364f/pkg/client/kubernetes/clientmap>example package</a></li></ul></li><li>Helpers can also be exported if no one is supposed to import the containing package (e.g. controller package).</li></ul></li></ul><h2 id=integration-tests-envtests>Integration Tests (envtests)</h2><p>Integration tests in Gardener use the <code>sigs.k8s.io/controller-runtime/pkg/envtest</code> package.
It sets up a temporary control plane (etcd + kube-apiserver) and runs the test against it.
The test suites start their individual <code>envtest</code> environment before running the tested controller/webhook and executing test cases.
Before exiting, the test suites tear down the temporary test environment.</p><p>Package <code>github.com/gardener/gardener/pkg/envtest</code> augments the controller-runtime&rsquo;s <code>envtest</code> package by starting and registering <code>gardener-apiserver</code>.
This is used to test controllers that act on resources in the Gardener APIs (aggregated APIs).</p><p>Historically, <a href=#test-machinery-tests>test machinery tests</a> have also been called &ldquo;integration tests&rdquo;.
However, test machinery does not perform integration testing but rather executes a form of end-to-end tests against a real landscape.
Hence, we tried to sharpen the terminology that we use to distinguish between &ldquo;real&rdquo; integration tests and test machinery tests but you might still find &ldquo;integration tests&rdquo; referring to test machinery tests in old issues or outdated documents.</p><h3 id=running-integration-tests>Running Integration Tests</h3><p>The <code>test-integration</code> make rule prepares the environment automatically by downloading the respective binaries (if not yet present) and setting the necessary environment variables.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make test-integration
</span></span></code></pre></div><p>If you want to run a specific set of integration tests, you can also execute them using <code>./hack/test-integration.sh</code> directly instead of using the <code>test-integration</code> rule. Prior to execution, the <code>PATH</code> environment variable needs to be set to also included the tools binary directory. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export PATH=<span style=color:#a31515>&#34;</span>$PWD<span style=color:#a31515>/hack/tools/bin:</span>$PATH<span style=color:#a31515>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>source ./hack/test-integration.env
</span></span><span style=display:flex><span>./hack/test-integration.sh ./test/integration/resourcemanager/tokenrequestor
</span></span></code></pre></div><p>The script takes care of preparing the environment for you.
If you want to execute the test suites directly via <code>go test</code> or <code>ginkgo</code>, you have to point the <code>KUBEBUILDER_ASSETS</code> environment variable to the path that contains the etcd and kube-apiserver binaries. Alternatively, you can install the binaries to <code>/usr/local/kubebuilder/bin</code>. Additionally, the environment variables from <code>hack/test-integration.env</code> should be sourced.</p><h3 id=debugging-integration-tests>Debugging Integration Tests</h3><p>You can configure <code>envtest</code> to use an existing cluster or control plane instead of starting a temporary control plane that is torn down immediately after executing the test.
This can be helpful for debugging integration tests because you can easily inspect what is going on in your test environment with <code>kubectl</code>.</p><p>While you can use an existing cluster (e.g., <code>kind</code>), some test suites expect that no controllers and no nodes are running in the test environment (as it is the case in <code>envtest</code> test environments).
Hence, using a full-blown cluster with controllers and nodes might sometimes be impractical, as you would need to stop cluster components for the tests to work.</p><p>You can use <code>make start-envtest</code> to start an <code>envtest</code> test environment that is managed separately from individual test suites.
This allows you to keep the test environment running for as long as you want, and to debug integration tests by executing multiple test runs in parallel or inspecting test runs using <code>kubectl</code>.
When you are finished, just hit <code>CTRL-C</code> for tearing down the test environment.
The kubeconfig for the test environment is placed in <code>dev/envtest-kubeconfig.yaml</code>.</p><p><code>make start-envtest</code> brings up an <code>envtest</code> environment using the default configuration.
If your test suite requires a different control plane configuration (e.g., disabled admission plugins or enabled feature gates), feel free to locally modify the configuration in <a href=https://github.com/gardener/gardener/tree/master/test/start-envtest><code>test/start-envtest</code></a> while debugging.</p><p>Run an <code>envtest</code> suite (not using <code>gardener-apiserver</code>) against an existing test environment:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make start-envtest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># in another terminal session:</span>
</span></span><span style=display:flex><span>export KUBECONFIG=$PWD/dev/envtest-kubeconfig.yaml
</span></span><span style=display:flex><span>export USE_EXISTING_CLUSTER=true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># run test with verbose output</span>
</span></span><span style=display:flex><span>./hack/test-integration.sh -v ./test/integration/resourcemanager/health -ginkgo.v
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># in another terminal session:</span>
</span></span><span style=display:flex><span>export KUBECONFIG=$PWD/dev/envtest-kubeconfig.yaml
</span></span><span style=display:flex><span><span style=color:green># watch test objects</span>
</span></span><span style=display:flex><span>k get managedresource -A -w
</span></span></code></pre></div><p>Run a <code>gardenerenvtest</code> suite (using <code>gardener-apiserver</code>) against an existing test environment:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:green># modify test/start-envtest to disable admission plugins and enable feature gates like in test suite...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>make start-envtest ENVTEST_TYPE=gardener
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># in another terminal session:</span>
</span></span><span style=display:flex><span>export KUBECONFIG=$PWD/dev/envtest-kubeconfig.yaml
</span></span><span style=display:flex><span>export USE_EXISTING_GARDENER=true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># run test with verbose output</span>
</span></span><span style=display:flex><span>./hack/test-integration.sh -v ./test/integration/controllermanager/bastion -ginkgo.v
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># in another terminal session:</span>
</span></span><span style=display:flex><span>export KUBECONFIG=$PWD/dev/envtest-kubeconfig.yaml
</span></span><span style=display:flex><span><span style=color:green># watch test objects</span>
</span></span><span style=display:flex><span>k get bastion -A -w
</span></span></code></pre></div><p>Similar to <a href=#debugging-unit-tests>debugging unit tests</a>, the <code>stress</code> tool can help hunting flakes in integration tests.
Though, you might need to run less tests in parallel though (specified via <code>-p</code>) and have a bit more patience.
Generally, reproducing flakes in integration tests is easier when stress-testing against an existing test environment instead of starting temporary individual control planes per test run.</p><p>Stress-test an <code>envtest</code> suite (not using <code>gardener-apiserver</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:green># build a test binary</span>
</span></span><span style=display:flex><span>ginkgo build ./test/integration/resourcemanager/health
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># prepare a test environment to run the test against</span>
</span></span><span style=display:flex><span>make start-envtest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># in another terminal session:</span>
</span></span><span style=display:flex><span>export KUBECONFIG=$PWD/dev/envtest-kubeconfig.yaml
</span></span><span style=display:flex><span>export USE_EXISTING_CLUSTER=true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># use same timeout settings like in CI</span>
</span></span><span style=display:flex><span>source ./hack/test-integration.env
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># switch to test package directory like `go test`</span>
</span></span><span style=display:flex><span>cd ./test/integration/resourcemanager/health
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># run the test in parallel and report any failures</span>
</span></span><span style=display:flex><span>stress -ignore <span style=color:#a31515>&#34;unable to grab random port&#34;</span> -p 16 ./health.test
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Stress-test a <code>gardenerenvtest</code> suite (using <code>gardener-apiserver</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:green># modify test/start-envtest to disable admission plugins and enable feature gates like in test suite...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># build a test binary</span>
</span></span><span style=display:flex><span>ginkgo build ./test/integration/controllermanager/bastion
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># prepare a test environment including gardener-apiserver to run the test against</span>
</span></span><span style=display:flex><span>make start-envtest ENVTEST_TYPE=gardener
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># in another terminal session:</span>
</span></span><span style=display:flex><span>export KUBECONFIG=$PWD/dev/envtest-kubeconfig.yaml
</span></span><span style=display:flex><span>export USE_EXISTING_GARDENER=true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># use same timeout settings like in CI</span>
</span></span><span style=display:flex><span>source ./hack/test-integration.env
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># switch to test package directory like `go test`</span>
</span></span><span style=display:flex><span>cd ./test/integration/controllermanager/bastion
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green># run the test in parallel and report any failures</span>
</span></span><span style=display:flex><span>stress -ignore <span style=color:#a31515>&#34;unable to grab random port&#34;</span> -p 16 ./bastion.test
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h3 id=purpose-of-integration-tests>Purpose of Integration Tests</h3><ul><li>Integration tests prove that multiple units are correctly integrated into a fully-functional component of the system.</li><li>Example components with multiple units:<ul><li>A controller with its reconciler, watches, predicates, event handlers, queues, etc.</li><li>A webhook with its server, handler, decoder, and webhook configuration.</li></ul></li><li>Integration tests set up a full component (including used libraries) and run it against a test environment close to the actual setup.<ul><li>e.g., start controllers against a real Kubernetes control plane to catch bugs that can only happen when talking to a real API server.</li><li>Integration tests are generally more expensive to run (e.g., in terms of execution time).</li></ul></li><li>Integration tests should not cover each and every detailed case.<ul><li>Rather than that, cover a good portion of the &ldquo;usual&rdquo; cases that components will face during normal operation (positive and negative test cases).</li><li>Also, there is no need to cover all failure cases or all cases of predicates -> they should be covered in unit tests already.</li><li>Generally, not supposed to &ldquo;generate test coverage&rdquo; but to provide confidence that components work well.</li></ul></li><li>As integration tests typically test only one component (or a cohesive set of components) isolated from others, they cannot catch bugs that occur when multiple controllers interact (could be discovered by e2e tests, though).</li><li>Rule of thumb: a new integration tests should be added for each new controller (an integration test doesn&rsquo;t replace unit tests though).</li></ul><h3 id=writing-integration-tests>Writing Integration Tests</h3><ul><li>Make sure to have a clean test environment on both test suite and test case level:<ul><li>Set up dedicated test environments (envtest instances) per test suite.</li><li>Use dedicated namespaces per test suite:<ul><li>Use <code>GenerateName</code> with a test-specific prefix: <a href=https://github.com/gardener/gardener/blob/ee3e50387fc7e6298908242f59894a7ea6f91fa7/test/integration/resourcemanager/secret/secret_suite_test.go#L94-L105>example test</a></li><li>Restrict the controller-runtime manager to the test namespace by setting <code>manager.Options.Namespace</code>: <a href=https://github.com/gardener/gardener/blob/d9b00b574182094c5d03ab16dfc2d20515e9b6ed/test/integration/controllermanager/cloudprofile/cloudprofile_suite_test.go#L104>example test</a></li><li>Alternatively, use a test-specific prefix with a random suffix determined upfront: <a href=https://github.com/gardener/gardener/blob/ce3973a605886ab6a496cf7f9fb6a5de54a5e7c2/test/integration/resourcemanager/tokeninvalidator/tokeninvalidator_suite_test.go#L68>example test</a><ul><li>This can be used to restrict webhooks to a dedicated test namespace: <a href=https://github.com/gardener/gardener/blob/ce3973a605886ab6a496cf7f9fb6a5de54a5e7c2/test/integration/resourcemanager/tokeninvalidator/tokeninvalidator_suite_test.go#L73>example test</a></li></ul></li><li>This allows running a test in parallel against the same existing cluster for deflaking and stress testing: <a href=https://github.com/gardener/gardener/pull/5953>example PR</a></li></ul></li><li>If the controller works on cluster-scoped resources:<ul><li>Label the resources with a label specific to the test run, e.g. the test namespace&rsquo;s name: <a href=https://github.com/gardener/gardener/blob/b01239edfd594b09ecd44dd77fba7a05a74820e8/test/integration/controllermanager/cloudprofile/cloudprofile_test.go#L38>example test</a></li><li>Restrict the manager&rsquo;s cache for these objects with a corresponding label selector: <a href=https://github.com/gardener/gardener/blob/b01239edfd594b09ecd44dd77fba7a05a74820e8/test/integration/controllermanager/cloudprofile/cloudprofile_suite_test.go#L110-L116>example test</a></li><li>Alternatively, use a checksum of a random UUID using <code>uuid.NewUUID()</code> function: <a href=https://github.com/gardener/gardener/blob/3840acaaf57955fd65330c83b2b2d5bdaad56179/test/integration/resourcemanager/tokeninvalidator/tokeninvalidator_suite_test.go#L71-L72>example test</a></li><li>This allows running a test in parallel against the same existing cluster for deflaking and stress testing, even if it works with cluster-scoped resources that are visible to all parallel test runs: <a href=https://github.com/gardener/gardener/pull/6527>example PR</a></li></ul></li><li>Use dedicated test resources for each test case:<ul><li>Use <code>GenerateName</code>: <a href=https://github.com/gardener/gardener/blob/ee3e50387fc7e6298908242f59894a7ea6f91fa7/test/integration/resourcemanager/health/health_test.go#L38-L48>example test</a></li><li>Alternatively, use a checksum of a random UUID using <code>uuid.NewUUID()</code> function: <a href=https://github.com/gardener/gardener/blob/3840acaaf57955fd65330c83b2b2d5bdaad56179/test/integration/resourcemanager/tokeninvalidator/tokeninvalidator_suite_test.go#L71-L72>example test</a></li><li>Logging the created object names is generally a good idea to support debugging failing or flaky tests: <a href=https://github.com/gardener/gardener/blob/50f92c5dc35160fe05da9002a79e7ce4a9cf3509/test/integration/controllermanager/cloudprofile/cloudprofile_test.go#L94-L96>example test</a></li><li>Always delete all resources after the test case (e.g., via <code>DeferCleanup</code>) that were created for the test case</li><li>This avoids conflicts between test cases and cascading failures which distract from the actual root failures</li></ul></li><li>Don&rsquo;t tolerate already existing resources (~dirty test environment), code smell: ignoring already exist errors</li></ul></li><li>Don&rsquo;t use a cached client in test code (e.g., the one from a controller-runtime manager), always construct a dedicated test client (uncached): <a href=https://github.com/gardener/gardener/blob/ee3e50387fc7e6298908242f59894a7ea6f91fa7/test/integration/resourcemanager/managedresource/resource_suite_test.go#L96-L97>example test</a></li><li>Use <a href=https://onsi.github.io/gomega/#making-asynchronous-assertions>asynchronous assertions</a>: <code>Eventually</code> and <code>Consistently</code>.<ul><li>Never <code>Expect</code> anything to happen synchronously (immediately).</li><li>Don&rsquo;t use retry or wait until functions -> use <code>Eventually</code>, <code>Consistently</code> instead: <a href=https://github.com/gardener/gardener/blob/ee3e50387fc7e6298908242f59894a7ea6f91fa7/test/integration/controllermanager/shootmaintenance/utils_test.go#L36-L48>example test</a></li><li>This allows to override the interval/timeout values from outside instead of hard-coding this in the test (see <code>hack/test-integration.sh</code>): <a href=https://github.com/gardener/gardener/pull/5938#discussion_r869155906>example PR</a></li><li>Beware of the default <code>Eventually</code> / <code>Consistently</code> timeouts / poll intervals: <a href=https://onsi.github.io/gomega/#eventually>docs</a></li><li>Don&rsquo;t set custom (high) timeouts and intervals in test code: <a href=https://github.com/gardener/gardener/pull/4983>example PR</a><ul><li>iInstead, shorten sync period of controllers, overwrite intervals of the tested code, or use fake clocks: <a href=https://github.com/gardener/gardener/blob/7c4031a57836de20758f32e1015c8a0f6c754d0f/test/integration/resourcemanager/managedresource/resource_suite_test.go#L137-L139>example test</a></li></ul></li><li>Pass <code>g Gomega</code> to <code>Eventually</code>/<code>Consistently</code> and use <code>g.Expect</code> in it: <a href=https://onsi.github.io/gomega/#category-3-making-assertions-eminem-the-function-passed-into-codeeventuallycode>docs</a>, <a href=https://github.com/gardener/gardener/blob/708f65c279276abd3a770c2f84a89e02876b3c38/test/e2e/shoot/internal/rotation/certificate_authorities.go#L111-L122>example test</a>, <a href=https://github.com/gardener/gardener/pull/4936>example PR</a></li><li>Don&rsquo;t forget to call <code>{Eventually,Consistently}.Should()</code>, otherwise the assertions always silently succeeds without errors: <a href=https://github.com/onsi/gomega/issues/561>onsi/gomega#561</a></li></ul></li><li>When using Gardener&rsquo;s envtest (<code>envtest.GardenerTestEnvironment</code>):<ul><li>Disable gardener-apiserver&rsquo;s admission plugins that are not relevant to the integration test itself by passing <code>--disable-admission-plugins</code>: <a href=https://github.com/gardener/gardener/blob/50f92c5dc35160fe05da9002a79e7ce4a9cf3509/test/integration/controllermanager/shoot/maintenance/maintenance_suite_test.go#L61-L67>example test</a></li><li>This makes setup / teardown code simpler and ensures to only test code relevant to the tested component itself (but not the entire set of admission plugins)</li><li>e.g., you can disable the <code>ShootValidator</code> plugin to create <code>Shoots</code> that reference non-existing <code>SecretBindings</code> or disable the <code>DeletionConfirmation</code> plugin to delete Gardener resources without adding a deletion confirmation first.</li></ul></li><li>Use a custom rate limiter for controllers in integration tests: <a href=https://github.com/gardener/gardener/blob/3dd6b111d677eb4bceadaa8fc469877097660577/test/integration/controllermanager/exposureclass/exposureclass_suite_test.go#L130-L131>example test</a><ul><li>This can be used for limiting exponential backoff to shorten wait times.</li><li>Otherwise, if using the default rate limiter, exponential backoff might exceed the timeout of <code>Eventually</code> calls and cause flakes.</li></ul></li></ul><h2 id=end-to-end-e2e-tests-using-provider-local>End-to-End (e2e) Tests (Using provider-local)</h2><p>We run a suite of e2e tests on every pull request and periodically on the <code>master</code> branch.
It uses a <a href=https://kind.sigs.k8s.io/>KinD cluster</a> and <a href=https://skaffold.dev/>skaffold</a> to boostrap a full installation of Gardener based on the current revision, including <a href=/docs/gardener/extensions/provider-local/>provider-local</a>.
This allows us to run e2e tests in an isolated test environment and fully locally without any infrastructure interaction.
The tests perform a set of operations on Shoot clusters, e.g. creating, deleting, hibernating and waking up.</p><p>These tests are executed in our prow instance at <a href=https://prow.gardener.cloud/>prow.gardener.cloud</a>, see <a href=https://github.com/gardener/ci-infra/blob/e324cb79c39c013d7f253c33690b7fcc92c001d8/config/jobs/gardener/gardener-e2e-kind.yaml>job definition</a> and <a href="https://prow.gardener.cloud/?repo=gardener%2Fgardener&job=*gardener-e2e-kind">job history</a>.</p><h3 id=running-e2e-tests>Running e2e Tests</h3><p>You can also run these tests on your development machine, using the following commands:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make kind-up
</span></span><span style=display:flex><span>export KUBECONFIG=$PWD/example/gardener-local/kind/local/kubeconfig
</span></span><span style=display:flex><span>make gardener-up
</span></span><span style=display:flex><span>make test-e2e-local  <span style=color:green># alternatively: make test-e2e-local-simple</span>
</span></span></code></pre></div><p>If you want to run a specific set of e2e test cases, you can also execute them using <code>./hack/test-e2e-local.sh</code> directly in combination with <a href=https://onsi.github.io/ginkgo/#spec-labels>ginkgo label filters</a>. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./hack/test-e2e-local.sh --label-filter <span style=color:#a31515>&#34;Shoot &amp;&amp; credentials-rotation&#34;</span> ./test/e2e/gardener/...
</span></span></code></pre></div><p>If you want to use an existing shoot instead of creating a new one for the test case and deleting it afterwards, you can specify the existing shoot via the following flags.
This can be useful to speed up the development of e2e tests.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./hack/test-e2e-local.sh --label-filter <span style=color:#a31515>&#34;Shoot &amp;&amp; credentials-rotation&#34;</span> ./test/e2e/gardener/... -- --project-namespace=garden-local --existing-shoot-name=local
</span></span></code></pre></div><p>For more information, see <a href=/docs/gardener/development/getting_started_locally/>Developing Gardener Locally</a> and <a href=/docs/gardener/deployment/getting_started_locally/>Deploying Gardener Locally</a>.</p><h3 id=debugging-e2e-tests>Debugging e2e Tests</h3><p>When debugging e2e test failures in CI, logs of the cluster components can be very helpful.
Our e2e test jobs export logs of all containers running in the kind cluster to prow&rsquo;s artifacts storage.
You can find them by clicking the <code>Artifacts</code> link in the top bar in prow&rsquo;s job view and navigating to <code>artifacts</code>.
This directory will contain all cluster component logs grouped by node.</p><p>Pull all artifacts using <a href=https://cloud.google.com/storage/docs/gsutil><code>gsutil</code></a> for searching and filtering the logs locally (use the path displayed in the artifacts view):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gsutil cp -r gs://gardener-prow/pr-logs/pull/gardener_gardener/6136/pull-gardener-e2e-kind/1542030416616099840/artifacts/gardener-local-control-plane /tmp
</span></span></code></pre></div><h3 id=purpose-of-e2e-tests>Purpose of e2e Tests</h3><ul><li>e2e tests provide a high level of confidence that our code runs as expected by users when deployed to production.</li><li>They are supposed to catch bugs resulting from interaction between multiple components.</li><li>Test cases should be as close as possible to real usage by end users:<ul><li>You should test &ldquo;from the perspective of the user&rdquo; (or operator).</li><li>Example: I create a Shoot and expect to be able to connect to it via the provided kubeconfig.</li><li>Accordingly, don&rsquo;t assert details of the system.<ul><li>e.g., the user also wouldn&rsquo;t expect that there is a kube-apiserver deployment in the seed, they rather expect that they can talk to it no matter how it is deployed</li><li>Only assert details of the system if the tested feature is not fully visible to the end-user and there is no other way of ensuring that the feature works reliably</li><li>e.g., the Shoot CA rotation is not fully visible to the user but is assertable by looking at the secrets in the Seed.</li></ul></li></ul></li><li>Pro: can be executed by developers and users without any real infrastructure (provider-local).</li><li>Con: they currently cannot be executed with real infrastructure (e.g., provider-aws), we will work on this as part of <a href=https://github.com/gardener/gardener/issues/6016>#6016</a>.</li><li>Keep in mind that the tested scenario is still artificial in a sense of using default configuration, only a few objects, only a few config/settings combinations are covered.<ul><li>We will never be able to cover the full &ldquo;test matrix&rdquo; and this should not be our goal.</li><li>Bugs will still be released and will still happen in production; we can&rsquo;t avoid it.</li><li>Instead, we should add test cases for preventing bugs in features or settings that were frequently regressed: <a href=https://github.com/gardener/gardener/pull/5725>example PR</a></li></ul></li><li>Usually e2e tests cover the &ldquo;straight-forward cases&rdquo;.<ul><li>However, negative test cases can also be included, especially if they are important from the user&rsquo;s perspective.</li></ul></li></ul><h3 id=writing-e2e-tests>Writing e2e Tests</h3><ul><li>Always wrap API calls and similar things in <code>Eventually</code> blocks: <a href=https://github.com/gardener/gardener/blob/a66b8ec47995561393bf1ad9a817463089a0255e/test/e2e/shoot/internal/rotation/observability.go#L46-L55>example test</a><ul><li>At this point, we are pretty much working with a distributed system and failures can happen anytime.</li><li>Wrapping calls in <code>Eventually</code> makes tests more stable and more realistic (usually, you wouldn&rsquo;t call the system broken if a single API call fails because of a short connectivity issue).</li></ul></li><li>Most of the points from <a href=#writing-integration-tests>writing integration tests</a> are relevant for e2e tests as well (especially the points about asynchronous assertions).</li><li>In contrast to integration tests, in e2e tests, it might make sense to specify higher timeouts for <code>Eventually</code> calls, e.g., when waiting for a <code>Shoot</code> to be reconciled.<ul><li>Generally, try to use the default settings for <code>Eventually</code> specified via the environment variables.</li><li>Only set higher timeouts if waiting for long-running reconciliations to be finished.</li></ul></li></ul><h2 id=gardener-upgrade-tests-using-provider-local>Gardener Upgrade Tests (Using provider-local)</h2><p>Gardener upgrade tests setup a kind cluster and deploy Gardener version <code>vX.X.X</code> before upgrading it to a given version <code>vY.Y.Y</code>.</p><p>This allows verifying whether the current (unreleased) revision/branch (or a specific release) is compatible with the latest (or a specific other) release. The <code>GARDENER_PREVIOUS_RELEASE</code> and <code>GARDENER_NEXT_RELEASE</code> environment variables are used to specify the respective versions.</p><p>This helps understanding what happens or how the system reacts when Gardener upgrades from versions <code>vX.X.X</code> to <code>vY.Y.Y</code> for existing shoots in different states (<code>creation</code>/<code>hibernation</code>/<code>wakeup</code>/<code>deletion</code>). Gardener upgrade tests also help qualifying releases for all flavors (<strong>non-HA</strong> or <strong>HA</strong> with failure tolerance <code>node</code>/<code>zone</code>).</p><p>Just like E2E tests, upgrade tests also use a <a href=https://kind.sigs.k8s.io/>KinD cluster</a> and <a href=https://skaffold.dev/>skaffold</a> for bootstrapping a full Gardener installation based on the current revision/branch, including <a href=/docs/gardener/extensions/provider-local/>provider-local</a>.
This allows running e2e tests in an isolated test environment, fully locally without any infrastructure interaction.
The tests perform a set of operations on Shoot clusters, e.g. create, delete, hibernate and wake up.</p><p>Below is a sequence describing how the tests are performed.</p><ul><li>Create a <code>kind</code> cluster.</li><li>Install Gardener version <code>vX.X.X</code>.</li><li>Run gardener pre-upgrade tests which are labeled with <code>pre-upgrade</code>.</li><li>Upgrade Gardener version from <code>vX.X.X</code> to <code>vY.Y.Y</code>.</li><li>Run gardener post-upgrade tests which are labeled with <code>post-upgrade</code></li><li>Tear down seed and kind cluster.</li></ul><h3 id=how-to-run-upgrade-tests-between-two-gardener-releases>How to Run Upgrade Tests Between Two Gardener Releases</h3><p>Sometimes, we need to verify/qualify two Gardener releases when we upgrade from one version to another.<br>This can performed by fetching the two Gardener versions from the <strong><a href=https://github.com/gardener/gardener/releases/latest>GitHub Gardener release page</a></strong> and setting appropriate env variables <code>GARDENER_PREVIOUS_RELEASE</code>, <code>GARDENER_NEXT_RELEASE</code>.</p><blockquote><p><strong><code>GARDENER_PREVIOUS_RELEASE</code></strong> &ndash; This env variable refers to a source revision/branch (or a specific release) which has to be installed first and then upgraded to version <strong><code>GARDENER_NEXT_RELEASE</code></strong>. By default, it fetches the latest release version from <strong><a href=https://github.com/gardener/gardener/releases/latest>GitHub Gardener release page</a></strong>.</p></blockquote><blockquote><p><strong><code>GARDENER_NEXT_RELEASE</code></strong> &ndash; This env variable refers to the target revision/branch (or a specific release) to be upgraded to after successful installation of <strong><code>GARDENER_PREVIOUS_RELEASE</code></strong>. By default, it considers the local HEAD revision, builds code, and installs Gardener from the current revision where the Gardener upgrade tests triggered.</p></blockquote><ul><li><code>make ci-e2e-kind-upgrade GARDENER_PREVIOUS_RELEASE=v1.60.0 GARDENER_NEXT_RELEASE=v1.61.0</code></li><li><code>make ci-e2e-kind-ha-single-zone-upgrade GARDENER_PREVIOUS_RELEASE=v1.60.0 GARDENER_NEXT_RELEASE=v1.61.0</code></li><li><code>make ci-e2e-kind-ha-multi-zone-upgrade GARDENER_PREVIOUS_RELEASE=v1.60.0 GARDENER_NEXT_RELEASE=v1.61.0</code></li></ul><h3 id=purpose-of-upgrade-tests>Purpose of Upgrade Tests</h3><ul><li>Tests will ensure that shoot clusters reconciled with the previous version of Gardener work as expected even with the next Gardener version.</li><li>This will reproduce or catch actual issues faced by end users.</li><li>One of the test cases ensures no downtime is faced by the end-users for shoots while upgrading Gardener if the shoot&rsquo;s control-plane is configured as HA.</li></ul><h3 id=writing-upgrade-tests>Writing Upgrade Tests</h3><ul><li>Tests are divided into two parts and labeled with <code>pre-upgrade</code> and <code>post-upgrade</code> labels.</li><li>An example test case which ensures a shoot which was <code>hibernated</code> in a previous Gardener release should <code>wakeup</code> as expected in next release:<ul><li>Creating a shoot and hibernating a shoot is pre-upgrade test case which should be labeled <code>pre-upgrade</code> label.</li><li>Then wakeup a shoot and delete a shoot is post-upgrade test case which should be labeled <code>post-upgrade</code> label.</li></ul></li></ul><h2 id=test-machinery-tests>Test Machinery Tests</h2><p>Please see <a href=/docs/gardener/development/testmachinery_tests/>Test Machinery Tests</a>.</p><h3 id=purpose-of-test-machinery-tests>Purpose of Test Machinery Tests</h3><ul><li>Test machinery tests have to be executed against full-blown Gardener installations.</li><li>They can provide a very high level of confidence that an installation is functional in its current state, this includes: all Gardener components, Extensions, the used Cloud Infrastructure, all relevant settings/configuration.</li><li>This brings the following benefits:<ul><li>They test more realistic scenarios than e2e tests (real configuration, real infrastructure, etc.).</li><li>Tests run &ldquo;where the users are&rdquo;.</li></ul></li><li>However, this also brings significant drawbacks:<ul><li>Tests are difficult to develop and maintain.</li><li>Tests require a full Gardener installation and cannot be executed in CI (on PR-level or against master).</li><li>Tests require real infrastructure (think cloud provider credentials, cost).</li><li>Using <code>TestDefinitions</code> under <code>.test-defs</code> requires a full test machinery installation.</li><li>Accordingly, tests are heavyweight and expensive to run.</li><li>Testing against real infrastructure can cause flakes sometimes (e.g., in outage situations).</li><li>Failures are hard to debug, because clusters are deleted after the test (for obvious cost reasons).</li><li>Bugs can only be caught, once it&rsquo;s &ldquo;too late&rdquo;, i.e., when code is merged and deployed.</li></ul></li><li>Today, test machinery tests cover a bigger &ldquo;test matrix&rdquo; (e.g., Shoot creation across infrastructures, kubernetes versions, machine image versions).</li><li>Test machinery also runs Kubernetes conformance tests.</li><li>However, because of the listed drawbacks, we should rather focus on augmenting our e2e tests, as we can run them locally and in CI in order to catch bugs before they get merged.</li><li>It&rsquo;s still a good idea to add test machinery tests if a feature that is depending on some installation-specific configuration needs to be tested.</li></ul><h3 id=writing-test-machinery-tests>Writing Test Machinery Tests</h3><ul><li>Generally speaking, most points from <a href=#writing-integration-tests>writing integration tests</a> and <a href=#writing-e2e-tests>writing e2e tests</a> apply here as well.</li><li>However, test machinery tests contain a lot of technical debt and existing code doesn&rsquo;t follow these best practices.</li><li>As test machinery tests are out of our general focus, we don&rsquo;t intend on reworking the tests soon or providing more guidance on how to write new ones.</li></ul><h2 id=manual-tests>Manual Tests</h2><ul><li>Manual tests can be useful when the cost of trying to automatically test certain functionality are too high.</li><li>Useful for PR verification, if a reviewer wants to verify that all cases are properly tested by automated tests.</li><li>Currently, it&rsquo;s the simplest option for testing upgrade scenarios.<ul><li>e.g. migration coding is probably best tested manually, as it&rsquo;s a high effort to write an automated test for little benefit</li></ul></li><li>Obviously, the need for manual tests should be kept at a bare minimum.<ul><li>Instead, we should add e2e tests wherever sensible/valuable.</li><li>We want to implement some form of general upgrade tests as part of <a href=https://github.com/gardener/gardener/issues/6016>#6016</a>.</li></ul></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e4015db9c3c500c41833f0a4177f9f0e>17 - Testmachinery Tests</h1><h1 id=test-machinery-tests>Test Machinery Tests</h1><p>In order to automatically qualify Gardener releases, we execute a set of end-to-end tests using <a href=https://github.com/gardener/test-infra>Test Machinery</a>.
This requires a full Gardener installation including infrastructure extensions, as well as a setup of Test Machinery itself.
These tests operate on Shoot clusters across different Cloud Providers, using different supported Kubernetes versions and various configuration options (huge test matrix).</p><p>This manual gives an overview about test machinery tests in Gardener.</p><ul><li><a href=#structure>Structure</a></li><li><a href=#add-a-new-test>Add a new test</a></li><li><a href=#test-labels>Test Labels</a></li><li><a href=#framework>Framework</a></li></ul><h2 id=structure>Structure</h2><p>Gardener test machinery tests are split into two test suites that can be found under <a href=https://github.com/gardener/gardener/tree/master/test/testmachinery/suites><code>test/testmachinery/suites</code></a>:</p><ul><li>The <strong>Gardener Test Suite</strong> contains all tests that only require a running gardener instance.</li><li>The <strong>Shoot Test Suite</strong> contains all tests that require a predefined running shoot cluster.</li></ul><p>The corresponding tests of a test suite are defined in the import statement of the suite definition (see <a href=https://github.com/gardener/gardener/blob/master/test/testmachinery/suites/shoot/run_suite_test.go><code>shoot/run_suite_test.go</code></a>)
and their source code can be found under <a href=https://github.com/gardener/gardener/tree/master/test/testmachinery><code>test/testmachinery</code></a>.</p><p>The <code>test</code> directory is structured as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>test
</span></span><span style=display:flex><span>├── e2e           # end-to-end tests (using provider-local)
</span></span><span style=display:flex><span>│  └── shoot
</span></span><span style=display:flex><span>├── framework     # helper code shared across integration, e2e and testmachinery tests
</span></span><span style=display:flex><span>├── integration   # integration tests (envtests)
</span></span><span style=display:flex><span>│  ├── controllermanager
</span></span><span style=display:flex><span>│  ├── envtest
</span></span><span style=display:flex><span>│  ├── resourcemanager
</span></span><span style=display:flex><span>│  ├── scheduler
</span></span><span style=display:flex><span>│  ├── shootmaintenance
</span></span><span style=display:flex><span>│  └── ...
</span></span><span style=display:flex><span>└── testmachinery # test machinery tests
</span></span><span style=display:flex><span>   ├── gardener   # actual test cases imported by suites/gardener
</span></span><span style=display:flex><span>   │  └── security
</span></span><span style=display:flex><span>   ├── shoots     # actual test cases imported by suites/shoot
</span></span><span style=display:flex><span>   │  ├── applications
</span></span><span style=display:flex><span>   │  ├── care
</span></span><span style=display:flex><span>   │  ├── logging
</span></span><span style=display:flex><span>   │  ├── operatingsystem
</span></span><span style=display:flex><span>   │  ├── operations
</span></span><span style=display:flex><span>   │  └── vpntunnel
</span></span><span style=display:flex><span>   ├── suites     # suites that run agains a running garden or shoot cluster
</span></span><span style=display:flex><span>   │  ├── gardener
</span></span><span style=display:flex><span>   │  └── shoot
</span></span><span style=display:flex><span>   └── system     # suites that are used for building a full test flow
</span></span><span style=display:flex><span>      ├── complete_reconcile
</span></span><span style=display:flex><span>      ├── managed_seed_creation
</span></span><span style=display:flex><span>      ├── managed_seed_deletion
</span></span><span style=display:flex><span>      ├── shoot_cp_migration
</span></span><span style=display:flex><span>      ├── shoot_creation
</span></span><span style=display:flex><span>      ├── shoot_deletion
</span></span><span style=display:flex><span>      ├── shoot_hibernation
</span></span><span style=display:flex><span>      ├── shoot_hibernation_wakeup
</span></span><span style=display:flex><span>      └── shoot_update
</span></span></code></pre></div><p>A suite can be executed by running the suite definition with ginkgo&rsquo;s <code>focus</code> and <code>skip</code> flags
to control the execution of specific labeled test. See the example below:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>go test -timeout=0 -mod=vendor ./test/testmachinery/suites/shoot \
</span></span><span style=display:flex><span>      --v -ginkgo.v -ginkgo.show-node-events -ginkgo.no-color \
</span></span><span style=display:flex><span>      --report-file=/tmp/report.json \                     # write elasticsearch formatted output to a file
</span></span><span style=display:flex><span>      --disable-dump=false \                               # disables dumping of teh current state if a test fails
</span></span><span style=display:flex><span>      -kubecfg=/path/to/gardener/kubeconfig \
</span></span><span style=display:flex><span>      -shoot-name=&lt;shoot-name&gt; \                           # Name of the shoot to test
</span></span><span style=display:flex><span>      -project-namespace=&lt;gardener project namespace&gt; \    # Name of the gardener project the test shoot resides
</span></span><span style=display:flex><span>      -ginkgo.focus=&#34;\[RELEASE\]&#34; \                        # Run all tests that are tagged as release
</span></span><span style=display:flex><span>      -ginkgo.skip=&#34;\[SERIAL\]|\[DISRUPTIVE\]&#34;             # Exclude all tests that are tagged SERIAL or DISRUPTIVE
</span></span></code></pre></div><h2 id=add-a-new-test>Add a New Test</h2><p>To add a new test the framework requires the following steps (step 1. and 2. can be skipped if the test is added to an existing package):</p><ol><li>Create a new test file e.g. <code>test/testmachinery/shoot/security/my-sec-test.go</code></li><li>Import the test into the appropriate test suite (gardener or shoot): <code>import _ "github.com/gardener/gardener/test/testmachinery/shoot/security"</code></li><li>Define your test with the testframework. The framework will automatically add its initialization, cleanup and dump functions.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#00f>var</span> _ = ginkgo.Describe(<span style=color:#a31515>&#34;my suite&#34;</span>, <span style=color:#00f>func</span>(){
</span></span><span style=display:flex><span>  f := framework.NewShootFramework(<span style=color:#00f>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  f.Beta().CIt(<span style=color:#a31515>&#34;my first test&#34;</span>, <span style=color:#00f>func</span>(ctx context.Context) {
</span></span><span style=display:flex><span>    f.ShootClient.Get(xx)
</span></span><span style=display:flex><span>    <span style=color:green>// testing ...
</span></span></span><span style=display:flex><span><span style=color:green></span>  })
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>The newly created test can be tested by focusing the test with the default ginkgo focus <code>f.Beta().FCIt("my first test", func(ctx context.Context)</code>
and running the shoot test suite with:</p><pre tabindex=0><code>go test -timeout=0 -mod=vendor ./test/testmachinery/suites/shoot \
      --v -ginkgo.v -ginkgo.show-node-events -ginkgo.no-color \
      --report-file=/tmp/report.json \                     # write elasticsearch formatted output to a file
      --disable-dump=false \                               # disables dumping of the current state if a test fails
      -kubecfg=/path/to/gardener/kubeconfig \
      -shoot-name=&lt;shoot-name&gt; \                           # Name of the shoot to test
      -project-namespace=&lt;gardener project namespace&gt; \
      -fenced=&lt;true|false&gt;                                 # Tested shoot is running in a fenced environment and cannot be reached by gardener
</code></pre><p>or for the gardener suite with:</p><pre tabindex=0><code>go test -timeout=0 -mod=vendor ./test/testmachinery/suites/gardener \
      --v -ginkgo.v -ginkgo.show-node-events -ginkgo.no-color \
      --report-file=/tmp/report.json \                     # write elasticsearch formatted output to a file
      --disable-dump=false \                               # disables dumping of the current state if a test fails
      -kubecfg=/path/to/gardener/kubeconfig \
      -project-namespace=&lt;gardener project namespace&gt;
</code></pre><p>⚠️ Make sure that you do not commit any focused specs as this feature is only intended for local development! Ginkgo will fail the test suite if there are any focused specs.</p><p>Alternatively, a test can be triggered by specifying a ginkgo focus regex with the name of the test e.g.</p><pre tabindex=0><code>go test -timeout=0 -mod=vendor ./test/testmachinery/suites/gardener \
      --v -ginkgo.v -ginkgo.show-node-events -ginkgo.no-color \
      --report-file=/tmp/report.json \                     # write elasticsearch formatted output to a file
      -kubecfg=/path/to/gardener/kubeconfig \
      -project-namespace=&lt;gardener project namespace&gt; \
      -ginkgo.focus=&#34;my first test&#34;                        # regex to match test cases
</code></pre><h2 id=test-labels>Test Labels</h2><p>Every test should be labeled by using the predefined labels available with every framework to have consistent labeling across
all test machinery tests.</p><p>The labels are applied to every new <code>It()/CIt()</code> definition by:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span>f := framework.NewCommonFramework()
</span></span><span style=display:flex><span>f.Default().Serial().It(<span style=color:#a31515>&#34;my test&#34;</span>) =&gt; <span style=color:#a31515>&#34;[DEFAULT] [SERIAL] my test&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>f := framework.NewShootFramework()
</span></span><span style=display:flex><span>f.Default().Serial().It(<span style=color:#a31515>&#34;my test&#34;</span>) =&gt; <span style=color:#a31515>&#34;[DEFAULT] [SERIAL] [SHOOT] my test&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>f := framework.NewGardenerFramework()
</span></span><span style=display:flex><span>f.Default().Serial().It(<span style=color:#a31515>&#34;my test&#34;</span>) =&gt; <span style=color:#a31515>&#34;[DEFAULT] [GARDENER] [SERIAL] my test&#34;</span>
</span></span></code></pre></div><p>Labels:</p><ul><li><em>Beta</em>: Newly created tests with no experience on stableness should be first labeled as beta tests.
They should be watched (and probably improved) until stable enough to be promoted to <em>Default</em>.</li><li><em>Default</em>: Tests that were <em>Beta</em> before and proved to be stable are promoted to <em>Default</em> eventually.
<em>Default</em> tests run more often, produce alerts and are <em>considered</em> during the release decision although they don&rsquo;t necessarily block a release.</li><li><em>Release</em>: Test are release relevant. A failing <em>Release</em> test blocks the release pipeline.
Therefore, these tests need to be stable. Only tests proven to be stable will eventually be promoted to <em>Release</em>.</li></ul><p>Behavior Labels:</p><ul><li><em>Serial</em>: The test should always be executed in serial with no other tests running, as it may impact other tests.</li><li><em>Destructive</em>: The test is destructive. Which means that is runs with no other tests and may break Gardener or the shoot.
Only create such tests if really necessary, as the execution will be expensive (neither Gardener nor the shoot can be reused in this case for other tests).</li></ul><h2 id=framework>Framework</h2><p>The framework directory contains all the necessary functions / utilities for running test machinery tests.
For example, there are methods for creation/deletion of shoots, waiting for shoot deletion/creation, downloading/installing/deploying helm charts, logging, etc.</p><p>The framework itself consists of 3 different frameworks that expect different prerequisites and offer context specific functionality.</p><ul><li><strong>CommonFramework</strong>: The common framework is the base framework that handles logging and setup of commonly needed resources like helm.
It also contains common functions for interacting with Kubernetes clusters like <code>Waiting for resources to be ready</code> or <code>Exec into a running pod</code>.</li><li><strong>GardenerFramework</strong> contains all functions of the common framework and expects a running Gardener instance with the provided Gardener kubeconfig and a project namespace.
It also contains functions to interact with gardener like <code>Waiting for a shoot to be reconciled</code> or <code>Patch a shoot</code> or <code>Get a seed</code>.</li><li><strong>ShootFramework</strong>: contains all functions of the common and the gardener framework.
It expects a running shoot cluster defined by the shoot&rsquo;s name and namespace (project namespace).
This framework contains functions to directly interact with the specific shoot.</li></ul><p>The whole framework also includes commonly used checks, ginkgo wrapper, etc., as well as commonly used tests.
Theses common application tests (like the guestbook test) can be used within multiple tests to have a default application (with ingress, deployment, stateful backend) to test external factors.</p><p><strong>Config</strong></p><p>Every framework commandline flag can also be defined by a configuration file (the value of the configuration file is only used if a flag is not specified by commandline).
The test suite searches for a configuration file (yaml is preferred) if the command line flag <code>--config=/path/to/config/file</code> is provided.
A framework can be defined in the configuration file by just using the flag name as root key e.g.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>verbose: debug
</span></span><span style=display:flex><span>kubecfg: /kubeconfig/path
</span></span><span style=display:flex><span>project-namespace: garden-it
</span></span></code></pre></div><p><strong>Report</strong></p><p>The framework automatically writes the ginkgo default report to stdout and a specifically structured elastichsearch bulk report file to a specified location.
The elastichsearch bulk report will write one json document per testcase and injects the metadata of the whole testsuite.
An example document for one test case would look like the following document:</p><pre tabindex=0><code>{
    &#34;suite&#34;: {
        &#34;name&#34;: &#34;Shoot Test Suite&#34;,
        &#34;phase&#34;: &#34;Succeeded&#34;,
        &#34;tests&#34;: 3,
        &#34;failures&#34;: 1,
        &#34;errors&#34;: 0,
        &#34;time&#34;: 87.427
    },
    &#34;name&#34;: &#34;Shoot application testing  [DEFAULT] [RELEASE] [SHOOT] should download shoot kubeconfig successfully&#34;,
    &#34;shortName&#34;: &#34;should download shoot kubeconfig successfully&#34;,
    &#34;labels&#34;: [
        &#34;DEFAULT&#34;,
        &#34;RELEASE&#34;,
        &#34;SHOOT&#34;
    ],
    &#34;phase&#34;: &#34;Succeeded&#34;,
    &#34;time&#34;: 0.724512057
}
</code></pre><p><strong>Resources</strong></p><p>The resources directory contains all the templates, helm config files (e.g., repositories.yaml, charts, and cache index which are downloaded upon the start of the test), shoot configs, etc.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>resources
</span></span><span style=display:flex><span>├── charts
</span></span><span style=display:flex><span>├── repository
</span></span><span style=display:flex><span>│   └── repositories.yaml
</span></span><span style=display:flex><span>└── templates
</span></span><span style=display:flex><span>    ├── guestbook-app.yaml.tpl
</span></span><span style=display:flex><span>    └── logger-app.yaml.tpl
</span></span></code></pre></div><p>There are two special directories that are dynamically filled with the correct test files:</p><ul><li><strong>charts</strong> - the charts will be downloaded and saved in this directory</li><li><strong>repository</strong> - contains the <code>repository.yaml</code> file that the target helm repos will be read from and the cache where the <code>stable-index.yaml</code> file will be created</li></ul><h3 id=system-tests>System Tests</h3><p>This directory contains the system tests that have a special meaning for the testmachinery with their own Test Definition.
Currently, these system tests consist of:</p><ul><li>Shoot creation</li><li>Shoot deletion</li><li>Shoot Kubernetes update</li><li>Gardener Full reconcile check</li></ul><h4 id=shoot-creation-test>Shoot Creation Test</h4><p>Create Shoot test is meant to test shoot creation.</p><p><strong>Example Run</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>go test -mod=vendor -timeout=0 ./test/testmachinery/system/shoot_creation \
</span></span><span style=display:flex><span>  --v -ginkgo.v -ginkgo.show-node-events \
</span></span><span style=display:flex><span>  -kubecfg=$HOME/.kube/config \
</span></span><span style=display:flex><span>  -shoot-name=$SHOOT_NAME \
</span></span><span style=display:flex><span>  -cloud-profile=$CLOUDPROFILE \
</span></span><span style=display:flex><span>  -seed=$SEED \
</span></span><span style=display:flex><span>  -secret-binding=$SECRET_BINDING \
</span></span><span style=display:flex><span>  -provider-type=$PROVIDER_TYPE \
</span></span><span style=display:flex><span>  -region=$REGION \
</span></span><span style=display:flex><span>  -k8s-version=$K8S_VERSION \
</span></span><span style=display:flex><span>  -project-namespace=$PROJECT_NAMESPACE \
</span></span><span style=display:flex><span>  -annotations=$SHOOT_ANNOTATIONS \
</span></span><span style=display:flex><span>  -infrastructure-provider-config-filepath=$INFRASTRUCTURE_PROVIDER_CONFIG_FILEPATH \
</span></span><span style=display:flex><span>  -controlplane-provider-config-filepath=$CONTROLPLANE_PROVIDER_CONFIG_FILEPATH \
</span></span><span style=display:flex><span>  -workers-config-filepath=$$WORKERS_CONFIG_FILEPATH \
</span></span><span style=display:flex><span>  -worker-zone=$ZONE \
</span></span><span style=display:flex><span>  -networking-pods=$NETWORKING_PODS \
</span></span><span style=display:flex><span>  -networking-services=$NETWORKING_SERVICES \
</span></span><span style=display:flex><span>  -networking-nodes=$NETWORKING_NODES \
</span></span><span style=display:flex><span>  -start-hibernated=$START_HIBERNATED
</span></span></code></pre></div><h4 id=shoot-deletion-test>Shoot Deletion Test</h4><p>Delete Shoot test is meant to test the deletion of a shoot.</p><p><strong>Example Run</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>go test -mod=vendor -timeout=0 -ginkgo.v -ginkgo.show-node-events \
</span></span><span style=display:flex><span>  ./test/testmachinery/system/shoot_deletion \
</span></span><span style=display:flex><span>  -kubecfg=$HOME/.kube/config \
</span></span><span style=display:flex><span>  -shoot-name=$SHOOT_NAME \
</span></span><span style=display:flex><span>  -project-namespace=$PROJECT_NAMESPACE
</span></span></code></pre></div><h4 id=shoot-update-test>Shoot Update Test</h4><p>The Update Shoot test is meant to test the Kubernetes version update of a existing shoot.
If no specific version is provided, the next patch version is automatically selected.
If there is no available newer version, this test is a noop.</p><p><strong>Example Run</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>go test -mod=vendor -timeout=0 ./test/testmachinery/system/shoot_update \
</span></span><span style=display:flex><span>  --v -ginkgo.v -ginkgo.show-node-events \
</span></span><span style=display:flex><span>  -kubecfg=$HOME/.kube/config \
</span></span><span style=display:flex><span>  -shoot-name=$SHOOT_NAME \
</span></span><span style=display:flex><span>  -project-namespace=$PROJECT_NAMESPACE \
</span></span><span style=display:flex><span>  -version=$K8S_VERSION
</span></span></code></pre></div><h4 id=gardener-full-reconcile-test>Gardener Full Reconcile Test</h4><p>The Gardener Full Reconcile test is meant to test if all shoots of a Gardener instance are successfully reconciled.</p><p><strong>Example Run</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>go test -mod=vendor -timeout=0 ./test/testmachinery/system/complete_reconcile \
</span></span><span style=display:flex><span>  --v -ginkgo.v -ginkgo.show-node-events \
</span></span><span style=display:flex><span>  -kubecfg=$HOME/.kube/config \
</span></span><span style=display:flex><span>  -project-namespace=$PROJECT_NAMESPACE \
</span></span><span style=display:flex><span>  -gardenerVersion=$GARDENER_VERSION # needed to validate the last acted gardener version of a shoot
</span></span></code></pre></div></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2023 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid@8.13.4/dist/mermaid.min.js integrity="sha512-JERecFUBbsm75UpkVheAuDOE8NdHjQBrPACfEQYPwvPG+fjgCpHAz1Jw2ci9EXmd3DdfiWth3O3CQvcfEg8gsA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.7b24c0fb082ffb2de6cb14d6c95e9f8053053709ffcf8c761ef8e9ad2f8021e4.js integrity="sha256-eyTA+wgv+y3myxTWyV6fgFMFNwn/z4x2HvjprS+AIeQ=" crossorigin=anonymous></script></body></html>