<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.95.0"><link rel=canonical type=text/html href=https://gardener.cloud/docs/extensions/network-extensions/gardener-extension-networking-calico/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/extensions/network-extensions/gardener-extension-networking-calico/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Calico CNI | Gardener</title><meta name=description content="Gardener extension controller for the Calico CNI network plugin"><meta property="og:title" content="Calico CNI"><meta property="og:description" content="Gardener extension controller for the Calico CNI network plugin"><meta property="og:type" content="website"><meta property="og:url" content="https://gardener.cloud/docs/extensions/network-extensions/gardener-extension-networking-calico/"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Calico CNI"><meta itemprop=description content="Gardener extension controller for the Calico CNI network plugin"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Calico CNI"><meta name=twitter:description content="Gardener extension controller for the Calico CNI network plugin"><link rel=preload href=/scss/main.min.b5b806bb2cd9fe9ed809539377398aa9df0eb8ca0c983a6eae0b413d528d8f0e.css as=style><link href=/scss/main.min.b5b806bb2cd9fe9ed809539377398aa9df0eb8ca0c983a6eae0b413d528d8f0e.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7N3XF5XLGV"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7N3XF5XLGV",{anonymize_ip:!1})}</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=text-capitalize>Gardener</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>Blogs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.1d6cd7f491344cef96aa76da161233cd.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/extensions/network-extensions/gardener-extension-networking-calico/>Return to the regular view of this page</a>.</p></div><h1 class=title>Calico CNI</h1><div class=lead>Gardener extension controller for the Calico CNI network plugin</div><div class=content><h1 id=gardener-extension-for-calico-networkinghttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for Calico Networking</a></h1><p><a href=https://concourse.ci.gardener.cloud/teams/gardener/pipelines/gardener-extension-networking-calico-master/jobs/master-head-update-job><img src=https://concourse.ci.gardener.cloud/api/v1/teams/gardener/pipelines/gardener-extension-networking-calico-master/jobs/master-head-update-job/badge alt="CI Build status"></a>
<a href=https://goreportcard.com/report/github.com/gardener/gardener-extension-networking-calico><img src=https://goreportcard.com/badge/github.com/gardener/gardener-extension-networking-calico alt="Go Report Card"></a></p><p>This controller operates on the <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/03-networking-extensibility.md#gardener-network-extension><code>Network</code></a> resource in the <code>extensions.gardener.cloud/v1alpha1</code> API group. It manages those objects that are requesting <a href=https://www.projectcalico.org/>Calico Networking</a> configuration (<code>.spec.type=calico</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Network
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: calico-network
</span></span><span style=display:flex><span>  namespace: shoot--core--test-01
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: calico
</span></span><span style=display:flex><span>  clusterCIDR: 192.168.0.0/24
</span></span><span style=display:flex><span>  serviceCIDR:  10.96.0.0/24
</span></span><span style=display:flex><span>  providerConfig:
</span></span><span style=display:flex><span>    apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>    kind: NetworkConfig
</span></span><span style=display:flex><span>    overlay:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>false</span>
</span></span></code></pre></div><p>Please find <a href=https://github.com/gardener/gardener-extension-networking-calico/blob/master/example/20-network.yaml>a concrete example</a> in the <code>example</code> folder. All the <code>Calico</code> specific configuration
should be configured in the <code>providerConfig</code> section. If additional configuration is required, it should be added to
the <code>networking-calico</code> chart in <code>controllers/networking-calico/charts/internal/calico/values.yaml</code> and corresponding code
parts should be adapted (for example in <code>controllers/networking-calico/pkg/charts/utils.go</code>).</p><p>Once the network resource is applied, the <code>networking-calico</code> controller would then create all the necessary <code>managed-resources</code> which should be picked
up by the <a href=https://github.com/gardener/gardener-resource-manager>gardener-resource-manager</a> which will then apply all the
network extensions resources to the shoot cluster.</p><p>Finally after successful reconciliation an output similar to the one below should be expected.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  status:
</span></span><span style=display:flex><span>    lastOperation:
</span></span><span style=display:flex><span>      description: Successfully reconciled network
</span></span><span style=display:flex><span>      lastUpdateTime: <span style=color:#a31515>&#34;...&#34;</span>
</span></span><span style=display:flex><span>      progress: 100
</span></span><span style=display:flex><span>      state: Succeeded
</span></span><span style=display:flex><span>      type: Reconcile
</span></span><span style=display:flex><span>    observedGeneration: 1
</span></span><span style=display:flex><span>    providerStatus:
</span></span><span style=display:flex><span>      apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: NetworkStatus
</span></span></code></pre></div><h2 id=compatibility>Compatibility</h2><p>The following table lists known compatibility issues of this extension controller with other Gardener components.</p><table><thead><tr><th>Calico Extension</th><th>Gardener</th><th>Action</th><th>Notes</th></tr></thead><tbody><tr><td><code>>= v1.30.0</code></td><td><code>&lt; v1.63.0</code></td><td>Please first update Gardener components to <code>>= v1.63.0</code>.</td><td>Without the mentioned minimum Gardener version, Calico <code>Pod</code>s are not only scheduled to dedicated system component nodes in the shoot cluster.</td></tr></tbody></table><hr><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally</h2><p>You can run the controller locally on your machine by executing <code>make start</code>. Please make sure to have the <code>kubeconfig</code> pointed to the cluster you want to connect to.
Static code checks and tests can be executed by running <code>make verify</code>. We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support</h2><p>Feedback and contributions are always welcome. Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-networking-calico/issues>GitHub issues</a> or join our <a href=https://kubernetes.slack.com/messages/gardener>Slack channel #gardener</a> (please invite yourself to the Kubernetes workspace <a href=http://slack.k8s.io>here</a>).</p><h2 id=learn-more>Learn more!</h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c32ab1bd33af4faaa7f9d085a262d09d>1 - Operations</h1></div><div class=td-content><h1 id=pg-ac9d19895c1c1460917497fe914c3dac>1.1 - Deployment</h1><h1 id=deployment-of-the-networking-calico-extension>Deployment of the networking Calico extension</h1><p><strong>Disclaimer:</strong> This document is NOT a step by step deployment guide for the networking Calico extension and only contains some configuration specifics regarding the deployment of different components via the helm charts residing in the networking Calico extension <a href=https://github.com/gardener/gardener-extension-networking-calico>repository</a>.</p><h2 id=gardener-extension-admission-calico>gardener-extension-admission-calico</h2><h3 id=authentication-against-the-garden-cluster>Authentication against the Garden cluster</h3><p>There are several authentication possibilities depending on whether or not <a href=https://github.com/gardener/garden-setup#concept-the-virtual-cluster>the concept of Virtual Garden</a> is used.</p><h4 id=virtual-garden-is-not-used-ie-the-runtime-garden-cluster-is-also-the-target-garden-cluster>Virtual Garden is not used, i.e., the <code>runtime</code> Garden cluster is also the <code>target</code> Garden cluster.</h4><h5 id=automounted-service-account-token>Automounted Service Account Token</h5><p>The easiest way to deploy the <code>gardener-extension-admission-calico</code> component will be to not provide <code>kubeconfig</code> at all. This way in-cluster configuration and an automounted service account token will be used. The drawback of this approach is that the automounted token will not be automatically rotated.</p><h5 id=service-account-token-volume-projection>Service Account Token Volume Projection</h5><p>Another solution will be to use <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>Service Account Token Volume Projection</a> combined with a <code>kubeconfig</code> referencing a token file (see example below).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://default.kubernetes.svc.cluster.local
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: garden
</span></span><span style=display:flex><span>    user: garden
</span></span><span style=display:flex><span>  name: garden
</span></span><span style=display:flex><span>current-context: garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div><p>This will allow for automatic rotation of the service account token by the <code>kubelet</code>. The configuration can be achieved by setting both <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.kubeconfig</code> in the respective chart&rsquo;s <code>values.yaml</code> file.</p><h4 id=virtual-garden-is-used-ie-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster>Virtual Garden is used, i.e., the <code>runtime</code> Garden cluster is different from the <code>target</code> Garden cluster.</h4><h5 id=service-account>Service Account</h5><p>The easiest way to setup the authentication will be to create a service account and the respective roles will be bound to this service account in the <code>target</code> cluster. Then use the generated service account token and craft a <code>kubeconfig</code> which will be used by the workload in the <code>runtime</code> cluster. This approach does not provide a solution for the rotation of the service account token. However, this setup can be achieved by setting <code>.Values.global.virtualGarden.enabled: true</code> and following these steps:</p><ol><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Get the service account token and craft the <code>kubeconfig</code>.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><h5 id=client-certificate>Client Certificate</h5><p>Another solution will be to bind the roles in the <code>target</code> cluster to a <code>User</code> subject instead of a service account and use a client certificate for authentication. This approach does not provide a solution for the client certificate rotation. However, this setup can be achieved by setting both <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>, then following these steps:</p><ol><li>Generate a client certificate for the <code>target</code> cluster for the respective user.</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Craft a <code>kubeconfig</code> using the already generated client certificate.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><h5 id=projected-service-account-token>Projected Service Account Token</h5><p>This approach requires an already deployed and configured <a href=https://github.com/gardener/oidc-webhook-authenticator>oidc-webhook-authenticator</a> for the <code>target</code> cluster. Also the <code>runtime</code> cluster should be registered as a trusted identity provider in the <code>target</code> cluster. Then projected service accounts tokens from the <code>runtime</code> cluster can be used to authenticate against the <code>target</code> cluster. The needed steps are as follows:</p><ol><li>Deploy <a href=https://github.com/gardener/oidc-webhook-authenticator>OWA</a> and establish the needed trust.</li><li>Set <code>.Values.global.virtualGarden.enabled: true</code> and <code>.Values.global.virtualGarden.user.name</code>. <strong>Note:</strong> username value will depend on the trust configuration, e.g., <code>&lt;prefix>:system:serviceaccount:&lt;namespace>:&lt;serviceaccount></code></li><li>Set <code>.Values.global.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.serviceAccountTokenVolumeProjection.audience</code>. <strong>Note:</strong> audience value will depend on the trust configuration, e.g., <code>&lt;cliend-id-from-trust-config></code>.</li><li>Craft a kubeconfig (see example below).</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Config
</span></span><span style=display:flex><span>clusters:
</span></span><span style=display:flex><span>- cluster:
</span></span><span style=display:flex><span>    certificate-authority-data: &lt;CA-DATA&gt;
</span></span><span style=display:flex><span>    server: https://virtual-garden.api
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>contexts:
</span></span><span style=display:flex><span>- context:
</span></span><span style=display:flex><span>    cluster: virtual-garden
</span></span><span style=display:flex><span>    user: virtual-garden
</span></span><span style=display:flex><span>  name: virtual-garden
</span></span><span style=display:flex><span>current-context: virtual-garden
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>- name: virtual-garden
</span></span><span style=display:flex><span>  user:
</span></span><span style=display:flex><span>    tokenFile: /var/run/secrets/projected/serviceaccount/token
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ca78384f9c8c587c9531d1090dbefb7d>1.2 - Operations</h1><h1 id=using-the-calico-networking-extension-with-gardener-as-operator>Using the Calico networking extension with Gardener as operator</h1><p>This document explains configuration options supported by the networking-calico extension.</p><h3 id=run-calico-node-in-non-privileged-and-non-root-mode>Run calico-node in non-privileged and non-root mode</h3><p><strong>Feature State</strong>: <code>Alpha</code></p><h5 id=motivation>Motivation</h5><p>Running containers in privileged mode is not recommended as privileged containers run with all <a href=https://man7.org/linux/man-pages/man7/capabilities.7.html>linux capabilities</a> enabled and can access the host&rsquo;s resources. Running containers in privileged mode opens number of security threats such as breakout to underlying host OS.</p><h5 id=support-for-non-privileged-and-non-root-mode>Support for non-privileged and non-root mode</h5><p>The Calico project has a preliminary support for running the calico-node component in non-privileged mode (see <a href=https://projectcalico.docs.tigera.io/security/non-privileged>this guide</a>). Similar to <a href=https://github.com/tigera/operator>Tigera Calico operator</a> the networking-calico extension can also run calico-node in non-privileged and non-root mode. This feature is controller via feature gate named <code>NonPrivilegedCalicoNode</code>. The feature gates are configured in the <a href=https://github.com/gardener/gardener-extension-networking-calico/blob/master/example/00-componentconfig.yaml>ControllerConfiguration</a> of networking-calico. The corresponding ControllerDeployment configuration that enables the <code>NonPrivilegedCalicoNode</code> would look like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: ControllerDeployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: networking-calico
</span></span><span style=display:flex><span>type: helm
</span></span><span style=display:flex><span>providerConfig:
</span></span><span style=display:flex><span>  values:
</span></span><span style=display:flex><span>    chart: &lt;omitted&gt;
</span></span><span style=display:flex><span>    config:
</span></span><span style=display:flex><span>      featureGates:
</span></span><span style=display:flex><span>        NonPrivilegedCalicoNode: <span style=color:#00f>false</span>
</span></span></code></pre></div><h5 id=limitations>Limitations</h5><ul><li>The support for the non-privileged mode in the Calico project is not ready for productive usage. The <a href=https://projectcalico.docs.tigera.io/security/non-privileged>upstream documentation</a> states that in non-privileged mode the support for features added after Calico v3.21 is not guaranteed.</li><li>Calico in non-privileged mode does not support eBPF dataplane. That&rsquo;s why when eBPF dataplane is enabled, calico-node has to run in privileged mode (even when the <code>NonPrivilegedCalicoNode</code> feature gate is enabled).</li><li>(At the time of writing this guide) there is the following issue <a href=https://github.com/projectcalico/calico/issues/5348>projectcalico/calico#5348</a> that is not addressed.</li><li>(At the time of writing this guide) the upstream adoptions seems to be low. The Calico charts and manifest in <a href=https://github.com/projectcalico/calico>projectcalico/calico</a> run calico-node in privileged mode.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b710f3bc97c1919987ce5eed7365aa38>2 - Usage</h1></div><div class=td-content><h1 id=pg-47032f4f90d79f3f45985d1037f55192>2.1 - Shoot Overlay Network</h1><h1 id=enable--disable-overlay-network-for-shoots-with-calico>Enable / disable overlay network for shoots with Calico</h1><p>Gardener can be used with or without the overlay network.</p><p>Starting versions:</p><ul><li><a href=https://github.com/gardener/gardener-extension-provider-gcp/releases/tag/v1.25.0>provider-gcp@v1.25.0</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-alicloud/releases/tag/v1.43.0>provider-alicloud@v1.43.0</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-aws/releases/tag/v1.38.2>provider-aws@v1.38.2</a></li><li><a href=https://github.com/gardener/gardener-extension-provider-openstack/releases/tag/v1.30.0>provider-openstack@v1.30.0</a></li></ul><p>The default configuration of shoot clusters is without overlay network.</p><h2 id=understanding-overlay-network>Understanding overlay network</h2><p>The Overlay networking permits the routing of packets between multiples pods located on multiple nodes, even if the pod and the node network are not the same.</p><p>This is done through the encapsulation of pod packets in the node network so that the routing can be done as usual. We use <code>ipip</code> encapsulation with calico in case the overlay network is enabled. This (simply put) sends an IP packet as workload in another IP packet.</p><p><img src=/__resources/Overlay-Network.drawio_ebaafc.png alt></p><p>In order to simplify the troubleshooting of problems and reduce the latency of packets traveling between nodes, the overlay network is disabled by default as stated above for all new clusters.</p><p><img src=/__resources/No-Overlay-Network.drawio_db83e3.png alt></p><p>This means that the routing is done directly through the VPC routing table. Basically, when a new node is created, it is assigned a slice (usually a /24) of the pod network. All future pods in that node are going to be in this slice. Then, the cloud-controller-manager updates the cloud provider router to add the new route (all packets within the network slice as destination should go to that node).</p><p>This has the advantage of:</p><ul><li>Doing less work for the node as encapsulation takes some CPU cycles.</li><li>The maximum transmission unit (MTU) is slightly bigger resulting in slightly better performance, i.e. potentially more workload bytes per packet.</li><li>More direct and simpler setup, which makes the problems much easier to troubleshoot.</li></ul><p><strong>In the case where multiple shoots are in the same VPC and the overlay network is disabled, if the pod&rsquo;s network is not configured properly, there is a very strong chance that some pod IP address might overlap, which is going to cause all sorts of funny problems.</strong> So, if someone asks you how to avoid that, they need to make sure that the podCIDRs for each shoot <strong>do not overlap with each other</strong>.</p><h2 id=enabling-the-overlay-network>Enabling the overlay network</h2><p>In certain cases, the overlay network might be preferable if, for example, the customer wants to create multiple clusters in the same VPC without ensuring there&rsquo;s no overlap between the pod networks.</p><p>To enable the overlay network, add the following to the shoot&rsquo;s YAML:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: NetworkConfig
</span></span><span style=display:flex><span>      overlay:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><h2 id=disabling-the-overlay-network>Disabling the overlay network</h2><p>Inversely, here is how to disable the overlay network:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: NetworkConfig
</span></span><span style=display:flex><span>      overlay:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><h2 id=how-to-know-if-a-cluster-is-using-overlay-or-not>How to know if a cluster is using overlay or not?</h2><p>You can look at any of the old nodes. If there are <code>tunl0</code> devices at least at some point in time the overlay network was used.
Another way is to look into the Network object in the shoot&rsquo;s control plane namespace on the seed (see example above).</p><h2 id=do-we-have-some-documentation-somewhere-on-how-to-do-the-migration>Do we have some documentation somewhere on how to do the migration?</h2><p>No, not yet. The migration from no overlay to overlay is fairly simply by just setting the configuration as specified above. The other way is more complicated as the Network configuration needs to be changed AND the local routes need to be cleaned.
Unfortunately, the change will be rolled out slowly (one calico-node at a time). Hence, it implies some network outages during the migration.</p><h2 id=aws-implementation>AWS implementation</h2><p>On AWS, it is not possible to use the cloud-controller-manager for managing the routes as it does not support multiple route tables, which Gardener creates. Therefore, a custom controller is created to manage the routes.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-353f73e79f81de23ff6fba2eea8b2c50>2.2 - Usage</h1><h1 id=using-the-networking-calico-extension-with-gardener-as-end-user>Using the Networking Calico extension with Gardener as end-user</h1><p>The <a href=https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a <code>networking</code> field that is meant to contain network-specific configuration.</p><p>In this document we are describing how this configuration looks like for Calico and provide an example <code>Shoot</code> manifest with minimal configuration that you can use to create a cluster.</p><h2 id=calico-typha>Calico Typha</h2><p>Calico Typha is an optional component of Project Calico designed to offload the Kubernetes API server. The Typha daemon sits between the datastore (such as the Kubernetes API server which is the one used by Gardener managed Kubernetes) and many instances of Felix. Typha’s main purpose is to increase scale by reducing each node’s impact on the datastore. You can opt-out Typha via <code>.spec.networking.providerConfig.typha.enabled=false</code> of your Shoot manifest. By default the Typha is enabled.</p><h2 id=ebpf-dataplane>EBPF Dataplane</h2><p>Calico can be run in ebpf dataplane mode. This has several benefits, calico scales to higher troughput, uses less cpu per GBit and has native support for kubernetes services (without needing kube-proxy).
To switch to a pure ebpf dataplane it is recommended to run without an overlay network. The following configuration can be used to run without an overlay and without kube-proxy.</p><p>An example ebpf dataplane <code>NetworkingConfig</code> manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: NetworkConfig
</span></span><span style=display:flex><span>ebpfDataplane:
</span></span><span style=display:flex><span>  enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>overlay:
</span></span><span style=display:flex><span>  enabled: <span style=color:#00f>false</span>
</span></span></code></pre></div><p>To disable kube-proxy set the enabled field to false in the shoot manifest.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: ebpf-shoot
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    kubeProxy:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>false</span>
</span></span></code></pre></div><h3 id=know-limitations-of-the-ebpf-dataplane>Know limitations of the EBPF Dataplane</h3><p>Please note that the default settings for calico&rsquo;s ebpf dataplane may interfere with
<a href=https://learn.microsoft.com/en-us/azure/virtual-network/accelerated-networking-overview>accelerated networking in azure</a>
rendering nodes with accelerated networking unusable in the network. The reason for this is that calico does not ignore
the accelerated networking interface <code>enP...</code> as it should, but applies its ebpf programs to it. A simple mitigation for
this is to adapt the <code>FelixConfiguration</code> <code>default</code> and ensure that the <code>bpfDataIfacePattern</code> does not include <code>enP...</code>.
Per default <code>bpfDataIfacePattern</code> is not set. The default value for this option can be found
<a href=https://github.com/projectcalico/calico/blob/3f7fe4d290541bbdd73c97bdc89a29a29855a48a/felix/config/config_params.go#L180>here</a>.
For example, you could apply the following change:</p><pre tabindex=0><code>$ kubectl edit felixconfiguration default
...
apiVersion: crd.projectcalico.org/v1
kind: FelixConfiguration
metadata:
  ...
  name: default
  ...
spec:
  bpfDataIfacePattern: ^((en|wl|ww|sl|ib)[opsx].*|(eth|wlan|wwan).*|tunl0$|vxlan.calico$|wireguard.cali$|wg-v6.cali$)
  ...
</code></pre><h2 id=example-networkingconfig-manifest>Example <code>NetworkingConfig</code> manifest</h2><p>An example <code>NetworkingConfig</code> for the Calico extension looks as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: NetworkConfig
</span></span><span style=display:flex><span>ipam:
</span></span><span style=display:flex><span>  type: host-local
</span></span><span style=display:flex><span>  cidr: usePodCIDR
</span></span><span style=display:flex><span>vethMTU: 1440
</span></span><span style=display:flex><span>typha:
</span></span><span style=display:flex><span>  enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>overlay:
</span></span><span style=display:flex><span>  enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h2 id=example-shoot-manifest>Example <code>Shoot</code> manifest</h2><p>Please find below an example <code>Shoot</code> manifest with calico networking configratations:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: core.gardener.cloud/v1beta1
</span></span><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: johndoe-azure
</span></span><span style=display:flex><span>  namespace: garden-dev
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  cloudProfileName: azure
</span></span><span style=display:flex><span>  region: westeurope
</span></span><span style=display:flex><span>  secretBindingName: core-azure
</span></span><span style=display:flex><span>  provider:
</span></span><span style=display:flex><span>    type: azure
</span></span><span style=display:flex><span>    infrastructureConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: InfrastructureConfig
</span></span><span style=display:flex><span>      networks:
</span></span><span style=display:flex><span>        vnet:
</span></span><span style=display:flex><span>          cidr: 10.250.0.0/16
</span></span><span style=display:flex><span>        workers: 10.250.0.0/19
</span></span><span style=display:flex><span>      zoned: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    controlPlaneConfig:
</span></span><span style=display:flex><span>      apiVersion: azure.provider.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: ControlPlaneConfig
</span></span><span style=display:flex><span>    workers:
</span></span><span style=display:flex><span>    - name: worker-xoluy
</span></span><span style=display:flex><span>      machine:
</span></span><span style=display:flex><span>        type: Standard_D4_v3
</span></span><span style=display:flex><span>      minimum: 2
</span></span><span style=display:flex><span>      maximum: 2
</span></span><span style=display:flex><span>      volume:
</span></span><span style=display:flex><span>        size: 50Gi
</span></span><span style=display:flex><span>        type: Standard_LRS
</span></span><span style=display:flex><span>      zones:
</span></span><span style=display:flex><span>      - <span style=color:#a31515>&#34;1&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#a31515>&#34;2&#34;</span>
</span></span><span style=display:flex><span>  networking:
</span></span><span style=display:flex><span>    type: calico
</span></span><span style=display:flex><span>    nodes: 10.250.0.0/16
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: calico.networking.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: NetworkConfig
</span></span><span style=display:flex><span>      ipam:
</span></span><span style=display:flex><span>        type: host-local
</span></span><span style=display:flex><span>      vethMTU: 1440
</span></span><span style=display:flex><span>      overlay:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      typha:
</span></span><span style=display:flex><span>        enabled: <span style=color:#00f>false</span>
</span></span><span style=display:flex><span>  kubernetes:
</span></span><span style=display:flex><span>    version: 1.24.3
</span></span><span style=display:flex><span>  maintenance:
</span></span><span style=display:flex><span>    autoUpdate:
</span></span><span style=display:flex><span>      kubernetesVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>      machineImageVersion: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>  addons:
</span></span><span style=display:flex><span>    kubernetesDashboard:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    nginxIngress:
</span></span><span style=display:flex><span>      enabled: <span style=color:#00f>true</span>
</span></span></code></pre></div></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2019-2023 Gardener project authors. <a href=https://www.sap.com/corporate/en/legal/privacy.html>Privacy policy
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid@8.13.4/dist/mermaid.min.js integrity="sha512-JERecFUBbsm75UpkVheAuDOE8NdHjQBrPACfEQYPwvPG+fjgCpHAz1Jw2ci9EXmd3DdfiWth3O3CQvcfEg8gsA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.7b24c0fb082ffb2de6cb14d6c95e9f8053053709ffcf8c761ef8e9ad2f8021e4.js integrity="sha256-eyTA+wgv+y3myxTWyV6fgFMFNwn/z4x2HvjprS+AIeQ=" crossorigin=anonymous></script></body></html>