<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://gardener.cloud/docs/extensions/others/gardener-extension-shoot-lakom-service/><link rel=alternate type=application/rss+xml href=https://gardener.cloud/docs/extensions/others/gardener-extension-shoot-lakom-service/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Lakom Service | Gardener</title>
<meta name=description content="A k8s admission controller verifying pods are using signed images (cosign signatures) and a gardener extension to install it for shoots and seeds."><meta property="og:url" content="https://gardener.cloud/docs/extensions/others/gardener-extension-shoot-lakom-service/"><meta property="og:site_name" content="Gardener"><meta property="og:title" content="Lakom Service"><meta property="og:description" content="A k8s admission controller verifying pods are using signed images (cosign signatures) and a gardener extension to install it for shoots and seeds."><meta property="og:locale" content="en_US"><meta property="og:type" content="website"><meta property="og:image" content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta itemprop=name content="Lakom Service"><meta itemprop=description content="A k8s admission controller verifying pods are using signed images (cosign signatures) and a gardener extension to install it for shoots and seeds."><meta itemprop=wordCount content="444"><meta itemprop=image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gardener.cloud/images/lp/gardener-logo.svg"><meta name=twitter:title content="Lakom Service"><meta name=twitter:description content="A k8s admission controller verifying pods are using signed images (cosign signatures) and a gardener extension to install it for shoots and seeds."><link rel=preload href=/scss/main.min.26acfdfb147ebf2e823b350f7e183142a26f105f5e474d2e37605e9c55009e66.css as=style integrity="sha256-Jqz9+xR+vy6COzUPfhgxQqJvEF9eR00uN2BenFUAnmY=" crossorigin=anonymous><link href=/scss/main.min.26acfdfb147ebf2e823b350f7e183142a26f105f5e474d2e37605e9c55009e66.css rel=stylesheet integrity="sha256-Jqz9+xR+vy6COzUPfhgxQqJvEF9eR00uN2BenFUAnmY=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg width="90" height="90" viewBox="0 0 90 90" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><desc>Created with Sketch.</desc><defs><path d="M41.8864954.994901575c.996545099999999-.479910833 2.6164002-.477918931 3.6088091.0L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926l7.7355517 33.8916663C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731c-1.1060816.0-2.5646564-.704623400000003-3.2514246-1.5658035L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="logo"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694l-8.0738997 5.2861089c-1.3854671.907087099999998-3.6247515.9116711-5.0172201.0L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304c0-.725313.2131118-1.5301454.569268099999999-2.2825772L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034c0 1.6598979-1.1161415 3.73626640000001-2.50861 4.6479374l-8.0738997 5.286109c-1.3854671.907087000000004-3.6247516.911671000000005-5.0172201.0L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947c-1.4306165.825966800000003-3.75236779999999.8246599-5.1807206.0L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></g></svg></span><span class=navbar-brand__name>Gardener</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://demo.gardener.cloud target=_blank rel=noopener><span>Demo</span></a></li><li class=nav-item><a class=nav-link href=/adopter><span>Adopters</span></a></li><li class=nav-item><a class=nav-link href=/docs><span>Documentation</span></a></li><li class=nav-item><a class=nav-link href=/blog><span>Blogs</span></a></li><li class=nav-item><a class=nav-link href=/community><span>Community</span></a></li><li class=nav-item><a class=nav-link href=https://join.slack.com/t/gardener-cloud/shared_invite/zt-33c9daems-3oOorhnqOSnldZPWqGmIBw target=_blank rel=noopener><span>Join us on</span></a></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.5989df2202b65b79559385d3c7cb2dc8.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/extensions/others/gardener-extension-shoot-lakom-service/>Return to the regular view of this page</a>.</p></div><h1 class=title>Lakom Service</h1><div class=lead>A k8s admission controller verifying pods are using signed images (cosign signatures) and a gardener extension to install it for shoots and seeds.</div><div class=content><h1 id=gardener-extension-for-lakom-serviceshttpsgardenercloud><a href=https://gardener.cloud>Gardener Extension for lakom services</a><a class=td-heading-self-link href=#gardener-extension-for-lakom-serviceshttpsgardenercloud aria-label="Heading self-link"></a></h1><p><a href=https://api.reuse.software/info/github.com/gardener/gardener-extension-shoot-lakom-service><img src=https://api.reuse.software/badge/github.com/gardener/gardener-extension-shoot-lakom-service alt="REUSE status"></a></p><p>Project Gardener implements the automated management and operation of <a href=https://kubernetes.io/>Kubernetes</a> clusters as a service.
Its main principle is to leverage Kubernetes concepts for all of its tasks.</p><p>Recently, most of the vendor specific logic has been developed <a href=https://github.com/gardener/gardener>in-tree</a>.
However, the project has grown to a size where it is very hard to extend, maintain, and test.
With <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1</a> we have proposed how the architecture can be changed in a way to support external controllers that contain their very own vendor specifics.
This way, we can keep Gardener core clean and independent.</p><p>This controller implements Gardener&rsquo;s extension contract for the <code>shoot-lakom-service</code> extension.</p><p>An example for a <code>ControllerRegistration</code> resource that can be used to register this controller to Gardener can be found <a href=https://github.com/gardener/gardener-extension-shoot-lakom-service/blob/main/example/controller-registration.yaml>here</a>.</p><p>Please find more information regarding the extensibility concepts and a detailed proposal <a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>here</a>.</p><h2 id=lakom-admission-controller>Lakom Admission Controller<a class=td-heading-self-link href=#lakom-admission-controller aria-label="Heading self-link"></a></h2><p>Lakom is kubernetes admission controller which purpose is to implement <a href=https://github.com/sigstore/cosign>cosign</a> image signature verification against public cosign key. It also takes care to resolve image tags to sha256 digests. It also caches all OCI artifacts to reduce the load toward the OCI registry.</p><h2 id=extension-resources>Extension Resources<a class=td-heading-self-link href=#extension-resources aria-label="Heading self-link"></a></h2><p>Example extension resource:</p><blockquote></blockquote><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>kind: Extension
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: extension-shoot-lakom-service
</span></span><span style=display:flex><span>  namespace: shoot--project--abc
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: shoot-lakom-service
</span></span></code></pre></div><p>When an extension resource is reconciled, the extension controller will create an instance of <code>lakom</code> admission controller. These resources are placed inside the shoot namespace on the seed. Also, the controller takes care about generating necessary <code>RBAC</code> resources for the seed as well as for the shoot.</p><p>Please note, this extension controller relies on the <a href=/docs/gardener/concepts/resource-manager/>Gardener-Resource-Manager</a> to deploy k8s resources to seed and shoot clusters.</p><h2 id=how-to-start-using-or-developing-this-extension-controller-locally>How to start using or developing this extension controller locally<a class=td-heading-self-link href=#how-to-start-using-or-developing-this-extension-controller-locally aria-label="Heading self-link"></a></h2><p>The <code>Lakom</code> admission controller can be configured with <code>make dev-setup</code> and started with <code>make start-lakom</code>.
You can run the lakom extension controller locally on your machine by executing <code>make start</code>.</p><p>If you&rsquo;d like to develop Lakom using a local cluster such as KinD, make sure your KUBECONFIG environment variable is targeting the local Garden cluster.
Add <code>127.0.0.1 garden.local.gardener.cloud</code> to your <code>/etc/hosts</code>. You can then run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make extension-up
</span></span></code></pre></div><p>This will trigger a skaffold deployment that builds the images, pushes them to the registry and installs the helm charts from <code>/charts</code>.</p><p>We are using Go modules for Golang package dependency management and <a href=https://github.com/onsi/ginkgo>Ginkgo</a>/<a href=https://github.com/onsi/gomega>Gomega</a> for testing.</p><h2 id=feedback-and-support>Feedback and Support<a class=td-heading-self-link href=#feedback-and-support aria-label="Heading self-link"></a></h2><p>Feedback and contributions are always welcome!</p><p>Please report bugs or suggestions as <a href=https://github.com/gardener/gardener-extension-shoot-lakom-service/issues>GitHub issues</a> or reach out on <a href=https://gardener-cloud.slack.com/>Slack</a> (join the workspace <a href=https://gardener.cloud/community/community-bio/>here</a>).</p><h2 id=learn-more>Learn more<a class=td-heading-self-link href=#learn-more aria-label="Heading self-link"></a></h2><p>Please find further resources about out project here:</p><ul><li><a href=https://gardener.cloud/>Our landing page gardener.cloud</a></li><li><a href=https://kubernetes.io/blog/2018/05/17/gardener/>&ldquo;Gardener, the Kubernetes Botanist&rdquo; blog on kubernetes.io</a></li><li><a href=https://kubernetes.io/blog/2019/12/02/gardener-project-update/>&ldquo;Gardener Project Update&rdquo; blog on kubernetes.io</a></li><li><a href=https://github.com/gardener/gardener/blob/master/docs/proposals/01-extensibility.md>GEP-1 (Gardener Enhancement Proposal) on extensibility</a></li><li><a href=https://github.com/gardener/gardener/tree/master/docs/extensions>Extensibility API documentation</a></li><li><a href=https://godoc.org/github.com/gardener/gardener/extensions/pkg>Gardener Extensions Golang library</a></li><li><a href=https://gardener.cloud/api-reference/>Gardener API Reference</a></li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c0e9837a0c6f3e6821df938a89b541e1>1 - Deployment</h1><h1 id=gardener-lakom-service-for-shoots>Gardener Lakom Service for Shoots<a class=td-heading-self-link href=#gardener-lakom-service-for-shoots aria-label="Heading self-link"></a></h1><h2 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h2><p>Gardener allows Shoot clusters to use <code>Lakom</code> admission controller for cosign image signing verification. To support this the Gardener must be installed with the <code>shoot-lakom-service</code> extension.</p><h2 id=configuration>Configuration<a class=td-heading-self-link href=#configuration aria-label="Heading self-link"></a></h2><p>To generally enable the Lakom service for shoot objects the <code>shoot-lakom-service</code> extension must be registered by providing an appropriate <a href=https://github.com/gardener/gardener-extension-shoot-lakom-service/blob/main/example/controller-registration.yaml>extension registration</a> in the garden cluster.</p><p>Here it is possible to decide whether the extension should be always available for all shoots or whether the extension must be separately enabled per shoot.</p><p>If the extension should be used for all shoots the <code>globallyEnabled</code> flag should be set to <code>true</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    - kind: Extension
</span></span><span style=display:flex><span>      type: shoot-lakom-service
</span></span><span style=display:flex><span>      globallyEnabled: <span style=color:#00f>true</span>
</span></span></code></pre></div><h3 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h3><p>If the shoot Lakom service is not globally enabled by default (depends on the extension registration on the garden cluster), it can be enabled per shoot. To enable the service for a shoot, the shoot manifest must explicitly add the <code>shoot-lakom-service</code> extension.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-lakom-service
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>If the shoot Lakom service is globally enabled by default, it can be disabled per shoot. To disable the service for a shoot, the shoot manifest must explicitly state it.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>    - type: shoot-lakom-service
</span></span><span style=display:flex><span>      disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-baad6af6b7a83fa2c3b395ecc1578177>2 - Lakom</h1><h1 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h1><p>Lakom is kubernetes admission controller which purpose is to implement
<a href=https://github.com/sigstore/cosign>cosign</a> image signature verification with
public cosign key. It also takes care to resolve image tags to sha256 digests. A
built-in cache mechanism can be enabled to reduce the load toward the OCI
registry.</p><h2 id=flags>Flags<a class=td-heading-self-link href=#flags aria-label="Heading self-link"></a></h2><p>Lakom admission controller is configurable via command line flags. The trusted
cosign public keys and the associated algorithms associated with them are set
viq configuration file provided with the flag <code>--lakom-config-path</code>.</p><table><thead><tr><th>Flag Name</th><th>Description</th><th>Default Value</th></tr></thead><tbody><tr><td><code>--bind-address</code></td><td>Address to bind to</td><td>&ldquo;0.0.0.0&rdquo;</td></tr><tr><td><code>--cache-refresh-interval</code></td><td>Refresh interval for the cached objects</td><td>30s</td></tr><tr><td><code>--cache-ttl</code></td><td>TTL for the cached objects. Set to 0, if cache has to be disabled</td><td>10m0s</td></tr><tr><td><code>--contention-profiling</code></td><td>Enable lock contention profiling, if profiling is enabled</td><td>false</td></tr><tr><td><code>--health-bind-address</code></td><td>Bind address for the health server</td><td>&ldquo;:8081&rdquo;</td></tr><tr><td><code>-h</code>, <code>--help</code></td><td>help for lakom</td><td></td></tr><tr><td><code>--insecure-allow-insecure-registries</code></td><td>If set, communication via HTTP with registries will be allowed.</td><td>false</td></tr><tr><td><code>--insecure-allow-untrusted-images</code></td><td>If set, the webhook will just return warning for the images without trusted signatures.</td><td>false</td></tr><tr><td><code>--kubeconfig</code></td><td>Paths to a kubeconfig. Only required if out-of-cluster.</td><td></td></tr><tr><td><code>--lakom-config-path</code></td><td>Path to file with lakom configuration containing cosign public keys used to verify the image signatures</td><td></td></tr><tr><td><code>--metrics-bind-address</code></td><td>Bind address for the metrics server</td><td>&ldquo;:8080&rdquo;</td></tr><tr><td><code>--port</code></td><td>Webhook server port</td><td>9443</td></tr><tr><td><code>--profiling</code></td><td>Enable profiling via web interface host:port/debug/pprof/</td><td>false</td></tr><tr><td><code>--tls-cert-dir</code></td><td>Directory with server TLS certificate and key (must contain a tls.crt and tls.key file</td><td></td></tr><tr><td><code>--use-only-image-pull-secrets</code></td><td>If set, only the credentials from the image pull secrets of the pod are used to access the OCI registry. Otherwise, the node identity and docker config are also used.</td><td>false</td></tr><tr><td><code>--version</code></td><td>prints version information and quits; &ndash;version=vX.Y.Z&mldr; sets the reported version</td><td></td></tr></tbody></table><h2 id=lakom-cosign-public-keys-configuration-file>Lakom Cosign Public Keys Configuration File<a class=td-heading-self-link href=#lakom-cosign-public-keys-configuration-file aria-label="Heading self-link"></a></h2><p>Lakom cosign public keys configuration file should be YAML or JSON formatted. It
can set multiple trusted keys, as each key must be given a name. The supported
types of public keys are <code>RSA</code>, <code>ECDSA</code> and <code>Ed25519</code>. The <code>RSA</code> keys can be
additionally configured with a signature verification algorithm specifying the
scheme and hash function used during signature verification. As of now <code>ECDSA</code>
and <code>Ed25519</code> keys cannot be configured with specific algorithm.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>publicKeys:
</span></span><span style=display:flex><span>- name: example-public-key
</span></span><span style=display:flex><span>  algorithm: RSASSA-PSS-SHA256
</span></span><span style=display:flex><span>  key: |-<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----BEGIN PUBLIC KEY-----
</span></span></span><span style=display:flex><span><span style=color:#a31515>    MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAPeQXbIWMMXYV+9+j9b4jXTflnpfwn4E
</span></span></span><span style=display:flex><span><span style=color:#a31515>    GMrmqYVhm0sclXb2FPP5aV/NFH6SZdHDZcT8LCNsNgxzxV4N+UE/JIsCAwEAAQ==
</span></span></span><span style=display:flex><span><span style=color:#a31515>    -----END PUBLIC KEY-----</span>    
</span></span></code></pre></div><p>Here:</p><ul><li><code>name</code> is logical human friendly name of the key.</li><li><code>algorithm</code> is the algorithm that has to be used to verify the signature, see <a href=/docs/extensions/others/gardener-extension-shoot-lakom-service/lakom/#supported-rsa-signature-verification-algorithms>Supported RSA Signature Verification Algorithms</a> for the list of supported algorithms.</li><li><code>key</code> is the cryptographic public key that will be used for image signature validation.</li></ul><h3 id=supported-rsa-signature-verification-algorithms>Supported RSA Signature Verification Algorithms<a class=td-heading-self-link href=#supported-rsa-signature-verification-algorithms aria-label="Heading self-link"></a></h3><ul><li><code>RSASSA-PKCS1-v1_5-SHA256</code>: uses <code>RSASSA-PKCS1-v1_5</code> scheme with <code>SHA256</code> hash func</li><li><code>RSASSA-PKCS1-v1_5-SHA384</code>: uses <code>RSASSA-PKCS1-v1_5</code> scheme with <code>SHA384</code> hash func</li><li><code>RSASSA-PKCS1-v1_5-SHA512</code>: uses <code>RSASSA-PKCS1-v1_5</code> scheme with <code>SHA512</code> hash func</li><li><code>RSASSA-PSS-SHA256</code>: uses <code>RSASSA-PSS</code> scheme with <code>SHA256</code> hash func</li><li><code>RSASSA-PSS-SHA384</code>: uses <code>RSASSA-PSS</code> scheme with <code>SHA384</code> hash func</li><li><code>RSASSA-PSS-SHA512</code>: uses <code>RSASSA-PSS</code> scheme with <code>SHA512</code> hash func</li></ul><h3 id=supported-resources-for-verification>Supported Resources for Verification<a class=td-heading-self-link href=#supported-resources-for-verification aria-label="Heading self-link"></a></h3><p>By default, Lakom validates only <code>Pod</code> resources in the clusters that it covers.
However, it also has the capabilities to validate the following Gardener specific resources:</p><ul><li><code>controllerdeployments.core.gardener.cloud/v1</code></li><li><code>gardenlets.seedmanagement.gardener.cloud/v1alpha1</code></li><li><code>extensions.operator.gardener.cloud/v1alpha1</code></li></ul><blockquote class="alert alert-important"><div class=alert-title><svg viewBox="0 0 24 24" width="24" height="24"><title>message-outline</title><path d="M20 2H4C2.9 2 2 2.9 2 4V22l4-4H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2m0 14H5.2L4 17.2V4H20V16z"/></svg><p>Important</p></div><p>When deploying Lakom via the helm chart in <code>/charts/lakom</code>, the <code>admissionConfig.rules</code> key
can be fully customized to include any of the listed resources above.
Make sure that they are registered with the same group & versions as the ones listed above.
Any difference will cause Lakom to skip validation and approve the request,
making it a security risk.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-8acb7c19c8c9dff4f5cb1f6e453dc1dd>3 - Oci Registries</h1><h1 id=oci-registries>OCI Registries<a class=td-heading-self-link href=#oci-registries aria-label="Heading self-link"></a></h1><p>This document aims to introduce the reader to the general architecture of OCI
Registries, their history and jargon that might be encountered.</p><h2 id=history-of-container-registries>History of Container Registries<a class=td-heading-self-link href=#history-of-container-registries aria-label="Heading self-link"></a></h2><p>Most readers might be familiar with the container registry that was introduced
by Docker. It aims to provide a way for developers to store and distribute
container images that can be used for running applications in containers.</p><p>In the beginning, the registry was meant to only host images in a way that the
different layers of the image could be downloaded in parallel, while being
assembled on the client side.</p><p>In June 2015, multiple companies agreed to standardize the container image format,
including its distribution and runtime. This was the birth of the Open Container
Initiative (OCI).</p><h2 id=understanding-oci-registries>Understanding OCI Registries<a class=td-heading-self-link href=#understanding-oci-registries aria-label="Heading self-link"></a></h2><p>The most important document that pertains to OCI Registries in the case of Lakom is the <a href=https://github.com/opencontainers/distribution-spec/blob/main/spec.md>OCI
distribution spec</a>.
It outlines the way that artifacts shall be stored and fetched from a registry
that adheres to the OCI standard.</p><p>OCI Registries are meant to store <em>content</em>. While in the beginning the main
problem that they were trying to solve was image storage, during the evolution
of the image registry concept, a decision was made to make it more general
for storage of any form of objects, sometimes called <em>artifacts</em>.</p><p>An artifact is an abstract idea of multiple components that together describe
how an object is built along with storing metadata about the object.</p><p>To implement this, every OCI registry has to expose an API for creating
3 types of objects:</p><ul><li>Blobs</li><li>Manifests</li><li>Tags</li></ul><h3 id=blobs>Blobs<a class=td-heading-self-link href=#blobs aria-label="Heading self-link"></a></h3><p>A blob is just a set of bytes. Nothing more. The important part about blobs
is that they are <em>content addressable</em>. <a href=https://en.wikipedia.org/wiki/Content-addressable_storage>Content Addressable Storage (CAS)</a>
is a method of storing data in such a way that the address of the data is derived
from the data itself. This means that if you store the same blob twice, it will
be stored only once, and the address of the blob will be the same. This is achieved
by using the <a href=https://en.wikipedia.org/wiki/Cryptographic_hash_function>digest</a> of the blob as the address.</p><p>This is the actual mechanism for allowing images to be optimal in terms of storage.
Since most images begin by depending on the same base image, this means that
it can be stored only once and referenced by multiple images.</p><h3 id=manifests>Manifests<a class=td-heading-self-link href=#manifests aria-label="Heading self-link"></a></h3><p>A manifest is just a JSON document. It is stored separately from the blobs.
But similarly to the blobs, it is also content addressable. The manifest gets
formatted to a canonical form and then hashed. The hash becomes the address of
the manifest.</p><p>Where manifests become powerful is when they are used to reference to other
manifests or blobs. These references are called <a href=https://github.com/opencontainers/image-spec/blob/v1.0.1/descriptor.md>OCI Content Descriptors</a>.
For example, the Image Manifest that most readers would be familiar with contains
a list of layers that are used to build the image. Each layer is a reference to
a blob.</p><p>An additional reference outside the layer references is used for storing
additional configuration. More info can be found in the official <a href=https://github.com/opencontainers/image-spec/blob/v1.0.1/manifest.md>OCI Image Manifest spec</a>.</p><p>The term <em>artifact</em> is just a generalization over the Image Manifest idea.
The Image Manifest has a specific format that can be found in the aforementioned <a href=https://github.com/opencontainers/image-spec/blob/v1.0.1/manifest.md>OCI Image Manifest spec</a>.
The important field is the <code>.config.mediaType</code> field. Based on the official guidelines,
it can be used for defining types other than an image. More info can be found <a href=https://github.com/opencontainers/image-spec/blob/main/manifest.md#guidelines-for-artifact-usage>here</a>.</p><p>Combining all of these ideas, we can see that artifacts can be represented by 1
specific object - a manifest. That manifest, based on the media type in the config, can be
interpreted by different programs for their specific use case. Eg. a Helm chart.
Helm charts specifically have a mediaType of <code>application/vnd.cncf.helm.config.v1+json</code>.
Layers, too, have a media type. The media type of a layer when the artifact
is a helm chart is one of:</p><ul><li>application/vnd.cncf.helm.config.v1+json</li><li>application/vnd.cncf.helm.chart.content.v1.tar+gzip</li><li>application/vnd.cncf.helm.chart.provenance.v1.prov</li></ul><p>More info specifically on Helm charts as OCI Artifacts can be found here: <a href=https://helm.sh/blog/helm-oci-mediatypes/>Helm OCI MediaTypes</a>.</p><h3 id=tags>Tags<a class=td-heading-self-link href=#tags aria-label="Heading self-link"></a></h3><p>While manifests and blobs being content addressable is nice, it becomes hard
to address them in a human-readable format. Tags allow us to add a reference
to a given manifest that differs from the digest of the object.</p><p>Normally, whenever we push an image to a registry, if we don&rsquo;t give it an
explicit tag, the registry would most likely give it the tag <code>latest</code>. This,
actually is not mandatory based on the distribution spec. Manifests don&rsquo;t
require that they have a tag.</p><p>Multiple tags can point to the same manifest.</p><h3 id=cosign>Cosign<a class=td-heading-self-link href=#cosign aria-label="Heading self-link"></a></h3><p>Cosign is generally a part of the bigger project called <a href=https://sigstore.dev/>sigstore</a>.
Sigstore is an &ldquo;open-source project for improving software supply chain security&rdquo;.
It aims for developers to have a hassle-free way to sign their artifacts while
leveraging other components that add additional layers of security to the
signature process. Eg. Rekor and Fulcio.</p><p>Cosign is a CLI tool aiming to tie all the components of sigstore together.
In our specific case, we use it only as a format for creating signatures and
then verifying them. In theory, we wouldn&rsquo;t need to use Cosign for this, but
it uses a popular format for the signatures and the libraries help us
save work.</p><p>In the context of Lakom, what interests us is how Cosign signs OCI artifacts
and how it stores them.
The signing process in a nutshell is the following &ndash; <code>Sign(sha256(SimpleSigningPayload(sha256(Image Manifest))))</code>, where:</p><ul><li>Image Manifest is what it says. Just the manifest of the image (artifact).</li><li>sha256 is the hashing algorithm used.</li><li>SimpleSigningPayload is the interesting part here. Instead of just signing the
hash of the manifest itself, the hash itself is packed into a JSON doc that
is called the <code>SimpleSigningPayload</code>. Example payload:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    &#34;critical&#34;: {
</span></span><span style=display:flex><span>           &#34;identity&#34;: {
</span></span><span style=display:flex><span>               &#34;docker-reference&#34;: <span style=color:#a31515>&#34;testing/manifest&#34;</span>
</span></span><span style=display:flex><span>           },
</span></span><span style=display:flex><span>           &#34;image&#34;: {
</span></span><span style=display:flex><span>               &#34;Docker-manifest-digest&#34;: <span style=color:#a31515>&#34;sha256:20be...fe55&#34;</span>
</span></span><span style=display:flex><span>           },
</span></span><span style=display:flex><span>           &#34;type&#34;: <span style=color:#a31515>&#34;cosign container image signature&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    &#34;optional&#34;: {
</span></span><span style=display:flex><span>           &#34;creator&#34;: <span style=color:#a31515>&#34;atomic&#34;</span>,
</span></span><span style=display:flex><span>           &#34;timestamp&#34;: 1458239713
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can see that the hash of the manifest is stored in the <code>Docker-manifest-digest</code>.
Now this object is the one that gets signed using our private key. The signed
version of this objest is the one that gets stored and gets used for
verification.</p><p>Storage of the signature is done via an image manifest that gets uploaded
in the same repo as the image, but tagged with <code>sha256-&lt;container-image-digest>.sig</code>.
Thus, the signature discovery mechanism is to just fetch the image digest
that is tagged with the aforementioned tag.</p><p>More info on this whole process can be found <a href=https://github.com/sigstore/cosign/blob/main/specs/SIGNATURE_SPEC.md>here</a>.</p><p>Lakom relies on the cosign libraries to automate this whole process. When
validating an artifact, if we know its digest, we can fetch the signature and
verify it. If the signature is valid, we can be sure that the artifact has not
been tampered with.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f2dfab902de56f28952cebcd9108225f>4 - Shoot Extension</h1><h1 id=introduction>Introduction<a class=td-heading-self-link href=#introduction aria-label="Heading self-link"></a></h1><p>This extension implements <a href=https://github.com/sigstore/cosign>cosign</a> image verification. It is strictly limited only to the kubernetes system components deployed by Gardener and other Gardener Extensions in the <code>kube-system</code> namespace of a shoot cluster.</p><h2 id=shoot-feature-gate>Shoot Feature Gate<a class=td-heading-self-link href=#shoot-feature-gate aria-label="Heading self-link"></a></h2><p>In most of the Gardener setups the <code>shoot-lakom-service</code> extension is enabled globally and thus can be configured per shoot cluster. Please adapt the shoot specification by the configuration shown below to disable the extension individually.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kind: Shoot
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>  - name: lakom-ref
</span></span><span style=display:flex><span>    resourceRef:
</span></span><span style=display:flex><span>      apiVersion: v1
</span></span><span style=display:flex><span>      kind: Secret
</span></span><span style=display:flex><span>      name: lakom-secret
</span></span><span style=display:flex><span>  extensions:
</span></span><span style=display:flex><span>  - type: shoot-lakom-service
</span></span><span style=display:flex><span>    disabled: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>    providerConfig:
</span></span><span style=display:flex><span>      apiVersion: lakom.extensions.gardener.cloud/v1alpha1
</span></span><span style=display:flex><span>      kind: LakomConfig
</span></span><span style=display:flex><span>      scope: KubeSystem
</span></span><span style=display:flex><span>      trustedKeysResourceName: lakom-ref
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h3 id=scope>Scope<a class=td-heading-self-link href=#scope aria-label="Heading self-link"></a></h3><p>The <code>scope</code> field instruct lakom which pods to validate. The possible values are:</p><ul><li><code>KubeSystem</code>
Lakom will validate all pods in the <code>kube-system</code> namespace.</li><li><code>KubeSystemManagedByGardener</code>
Lakom will validate all pods in the <code>kube-system</code> namespace that are annotated with &ldquo;managed-by/gardener&rdquo;. This is the default value.</li><li><code>Cluster</code>
Lakom will validate all pods in all namespaces.</li></ul><h3 id=trustedkeysresourcename>TrustedKeysResourceName<a class=td-heading-self-link href=#trustedkeysresourcename aria-label="Heading self-link"></a></h3><p>Lakom, by default, tries to verify only workloads that belong to Gardener. Because of this, the only public keys that it uses to do its job are the ones for the Gardener workload.</p><p>If you&rsquo;d like to use Lakom as a tool for verifying your own workload, you&rsquo;ll need to add your own public keys to the ones that Lakom is already using. This can be achieved using Gardener <a href=/docs/gardener/extensions/referenced-resources/>referenced resources</a>. More information about the keys and their format can be found <a href=/docs/extensions/others/gardener-extension-shoot-lakom-service/lakom/#lakom-cosign-public-keys-configuration-file>here</a>.</p><p>Simply:</p><ol><li>Create a secret in your project namespace that contains a field <code>keys</code> with your keys as a value. Example keys:</li></ol><pre tabindex=0><code>- name: example-client-key1
  algorithm: RSASSA-PSS-SHA256
  key: |-
    -----BEGIN PUBLIC KEY-----
    MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAPeQXbIWMMXYV+9+j9b4jXTflnpfwn4E
    GMrmqYVhm0sclXb2FPP5aV/NFH6SZdHDZcT8LCNsNgxzxV4N+UE/JIsCAwEAAQ==
    -----END PUBLIC KEY-----
- name: example-client-key2
  algorithm: RSASSA-PSS-SHA256
  key: |-
    -----BEGIN PUBLIC KEY-----
    MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAPeQXbIWMMXYV+9+j9b4jXTflnpfwn4E
    GMrmqYVhm0sclXb2FPP5aV/NFH6SZdHDZcT8LCNsNgxzxV4N+UE/JIsCAwEAAQ==
    -----END PUBLIC KEY-----
</code></pre><ol start=2><li>Add a reference to your secret via the <code>resources</code> field in the shoot spec as shown above.</li><li>Add the name of your referenece in <code>trustedKeysResourceName </code>in the provider config as shown above.</li></ol><p>Now, whenever Lakom tries to verify a Pod, it will make sure to use your public keys as well.</p></div></main></div></div><footer class="footer row d-print-none"><div class="container-fluid footer-wrapper"><ul class=nav><li><a href=https://gardener.cloud/blog/>Blogs</a></li><li><a href=https://gardener.cloud/community/>Community</a></li><li><a href=https://gardener.cloud/adopter/>Adopters</a></li><li><a href=/docs/>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://gardener-cloud.slack.com/><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://x.com/GardenerProject><img src=/images/branding/x-logo-white.svg class=media-icon><div class=media-text>X</div></a></li></ul><span class=copyright>Copyright 2019-2025 Gardener project authors.
<a href=https://www.sap.com/about/legal/terms-of-use.html>Terms of Use
<i class="fa fa-external-link" aria-hidden=true></i>
</a>|
<a href=https://www.sap.com/about/legal/terms-of-use.html>Privacy Statement
<i class="fa fa-external-link" aria-hidden=true></i>
</a>|
<a href=https://www.sap.com/about/legal/terms-of-use.html>Legal Disclosure
<i class="fa fa-external-link" aria-hidden=true></i></a></span></div></footer></div><script src=/js/main.min.69e2c1ae9320465ab10236d9ef752c6a4442c54b48b883b17c497b7c7d96a796.js integrity="sha256-aeLBrpMgRlqxAjbZ73UsakRCxUtIuIOxfEl7fH2Wp5Y=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script><script src=/js/navbar.js></script><script src=/js/filtering.js></script><script src=/js/page-content.js></script></body></html>